<div class="app-container" *ngIf="!isLoginPage() && authService.isAuthenticated()">
  <!-- Toggle Button (fuera del sidebar para evitar overflow) -->
  <button type="button" class="sidebar-toggle" [class.collapsed]="isSidebarCollapsed" (click)="toggleSidebar()" [title]="isSidebarCollapsed ? 'Expandir' : 'Colapsar'">
    <lucide-angular [name]="isSidebarCollapsed ? 'chevron-right' : 'chevron-left'" [size]="16"></lucide-angular>
  </button>

  <!-- CASHI Sidebar -->
  <aside class="cashi-sidebar" [class.collapsed]="isSidebarCollapsed">
    <!-- Logo -->
    <div class="sidebar-logo">
      <div class="logo-icon">
        <lucide-angular name="wallet" [size]="20"></lucide-angular>
      </div>
      <span class="logo-text" *ngIf="!isSidebarCollapsed">CASHI</span>
    </div>

    <!-- Navigation Menu - Dynamic from Backend -->
    <nav class="sidebar-nav">
      <!-- Dynamic Menu Items -->
      <ng-container *ngFor="let item of menuItems">
        <!-- LINK type - Simple navigation item -->
        <ng-container *ngIf="item.tipo === 'LINK'">
          <a [routerLink]="item.ruta"
             routerLinkActive="active"
             class="sidebar-item"
             [title]="isSidebarCollapsed ? item.etiqueta : ''">
            <lucide-angular [name]="item.icono" [size]="20"></lucide-angular>
            <span class="item-text" *ngIf="!isSidebarCollapsed">{{ item.etiqueta }}</span>
          </a>
        </ng-container>

        <!-- DROPDOWN type - Expandable group -->
        <ng-container *ngIf="item.tipo === 'DROPDOWN'">
          <div class="sidebar-group">
            <button type="button"
                    class="sidebar-item"
                    [class.active]="isMenuItemActive(item)"
                    (click)="toggleDynamicDropdown(item.codigo)"
                    [title]="isSidebarCollapsed ? item.etiqueta : ''">
              <lucide-angular [name]="item.icono" [size]="20"></lucide-angular>
              <span class="item-text" *ngIf="!isSidebarCollapsed">{{ item.etiqueta }}</span>
              <lucide-angular class="dropdown-arrow"
                              *ngIf="!isSidebarCollapsed"
                              [class.rotated]="isDropdownOpen(item.codigo)"
                              name="chevron-down"
                              [size]="18"></lucide-angular>
            </button>

            <div class="sidebar-submenu" [class.show]="isDropdownOpen(item.codigo) && !isSidebarCollapsed">
              <ng-container *ngFor="let child of item.children">
                <a [routerLink]="child.ruta"
                   routerLinkActive="active"
                   class="sidebar-subitem"
                   (click)="closeAllDynamicDropdowns()">
                  <lucide-angular [name]="child.icono" [size]="18"></lucide-angular>
                  <span class="item-text" [title]="child.etiqueta">{{ child.etiqueta }}</span>
                </a>
              </ng-container>
            </div>
          </div>
        </ng-container>
      </ng-container>

      <!-- Fallback: Show loading indicator if no menu items -->
      <div *ngIf="menuItems.length === 0 && authService.isAuthenticated()" class="sidebar-item opacity-50">
        <lucide-angular name="loader-2" [size]="20" class="animate-spin"></lucide-angular>
        <span class="item-text" *ngIf="!isSidebarCollapsed">Cargando menú...</span>
      </div>
    </nav>

    <!-- Bottom Actions -->
    <div class="sidebar-footer">
      <!-- User Profile -->
      <div class="sidebar-item user-profile" [title]="isSidebarCollapsed ? (authService.currentUser$ | async)?.username : ''">
        <lucide-angular name="user" [size]="20"></lucide-angular>
        <span class="item-text" *ngIf="!isSidebarCollapsed">{{ (authService.currentUser$ | async)?.username }}</span>
      </div>

      <!-- Notificaciones (solo ADMIN) -->
      <div class="sidebar-group" *ngIf="(authService.currentUser$ | async)?.role === 'ADMIN'">
        <button type="button" class="sidebar-item" (click)="toggleNotificacionesDropdown()" [title]="isSidebarCollapsed ? 'Notificaciones' : ''">
          <div class="relative">
            <lucide-angular name="bell" [size]="20"></lucide-angular>
            <span *ngIf="notificacionesCount > 0"
                  class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-bold">
              {{ notificacionesCount > 9 ? '9+' : notificacionesCount }}
            </span>
          </div>
          <span class="item-text" *ngIf="!isSidebarCollapsed">Notificaciones</span>
        </button>
      </div>

      <!-- Settings -->
      <a routerLink="/settings" routerLinkActive="active" class="sidebar-item" [title]="isSidebarCollapsed ? 'Configuración' : ''">
        <lucide-angular name="sliders" [size]="20"></lucide-angular>
        <span class="item-text" *ngIf="!isSidebarCollapsed">Configuración</span>
      </a>

      <!-- Theme Toggle -->
      <button type="button" class="sidebar-item" (click)="toggleTheme()" [title]="isSidebarCollapsed ? (isDarkMode() ? 'Modo Claro' : 'Modo Oscuro') : ''">
        <lucide-angular *ngIf="isDarkMode(); else lightMode" name="sun" [size]="20"></lucide-angular>
        <ng-template #lightMode>
          <lucide-angular name="moon" [size]="20"></lucide-angular>
        </ng-template>
        <span class="item-text" *ngIf="!isSidebarCollapsed">{{ isDarkMode() ? 'Modo Claro' : 'Modo Oscuro' }}</span>
      </button>

      <!-- Logout -->
      <button type="button" class="sidebar-item logout-btn" (click)="logout()" [title]="isSidebarCollapsed ? 'Cerrar Sesión' : ''">
        <lucide-angular name="log-out" [size]="20"></lucide-angular>
        <span class="item-text" *ngIf="!isSidebarCollapsed">Cerrar Sesión</span>
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <app-peripheral-status-banner></app-peripheral-status-banner>
    <router-outlet></router-outlet>
  </main>

  <!-- Notificaciones globales de autorización (para supervisores) -->
  <app-authorization-notification></app-authorization-notification>

  <!-- Overlay de alerta de tiempo para agentes -->
  <app-agent-time-alert-overlay></app-agent-time-alert-overlay>

  <!-- Panel flotante de supervisión de llamadas -->
  <app-supervision-panel></app-supervision-panel>

  <!-- Panel flotante de notificaciones del sistema -->
  <div *ngIf="isNotificacionesDropdownOpen && (authService.currentUser$ | async)?.role === 'ADMIN'"
       class="notif-panel fixed z-[9999]"
       [style.bottom.px]="16"
       [style.left.px]="isSidebarCollapsed ? 72 : 248">

    <!-- Backdrop para cerrar -->
    <div class="fixed inset-0 z-[-1]" (click)="isNotificacionesDropdownOpen = false"></div>

    <!-- Header -->
    <div class="notif-header">
      <div class="notif-header-left">
        <div class="notif-icon-wrapper">
          <lucide-angular name="bell" [size]="18"></lucide-angular>
        </div>
        <span class="notif-title">Notificaciones</span>
        <span *ngIf="notificacionesCount > 0" class="notif-badge">{{ notificacionesCount }}</span>
      </div>
      <div class="notif-header-right">
        <button *ngIf="notificacionesCount > 0"
                (click)="marcarTodasLeidas()"
                class="notif-mark-read-btn">
          <lucide-angular name="check-check" [size]="14"></lucide-angular>
          <span>Marcar leídas</span>
        </button>
        <button (click)="isNotificacionesDropdownOpen = false"
                class="notif-close-btn">
          <lucide-angular name="x" [size]="18"></lucide-angular>
        </button>
      </div>
    </div>

    <!-- Lista de notificaciones -->
    <div class="notif-list">
      <!-- Empty state -->
      <div *ngIf="notificaciones.length === 0" class="notif-empty">
        <div class="notif-empty-icon">
          <lucide-angular name="bell-off" [size]="40"></lucide-angular>
        </div>
        <p class="notif-empty-title">Sin notificaciones</p>
        <p class="notif-empty-subtitle">Las notificaciones nuevas aparecerán aquí</p>
      </div>

      <!-- Notification items -->
      <div *ngFor="let notif of notificaciones"
           (click)="marcarNotificacionLeida(notif)"
           class="notif-item"
           [class.unread]="!notif.leida">

        <div class="notif-item-icon" [class]="getNotificacionColor(notif.tipo)">
          <lucide-angular [name]="getNotificacionIcon(notif.tipo)" [size]="16"></lucide-angular>
        </div>

        <div class="notif-item-content">
          <div class="notif-item-header">
            <span class="notif-item-title">{{ notif.titulo }}</span>
            <span *ngIf="!notif.leida" class="notif-unread-dot"></span>
          </div>
          <p class="notif-item-message">{{ notif.mensaje }}</p>
          <span class="notif-item-time">
            <lucide-angular name="clock" [size]="12"></lucide-angular>
            {{ notif.fechaCreacion | date:'dd/MM/yyyy HH:mm' }}
          </span>
        </div>
      </div>
    </div>
  </div>
</div>

<div *ngIf="isLoginPage() || !authService.isAuthenticated()">
  <router-outlet></router-outlet>
</div>

<app-toast-notification></app-toast-notification>

