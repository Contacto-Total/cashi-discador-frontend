<div class="h-[calc(100dvh-56px)] bg-slate-950 overflow-hidden flex flex-col">
  <div class="flex-1 overflow-y-auto">
    <div class="p-4 max-w-[1400px] mx-auto">
      <!-- Header -->
      <div class="mb-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-gradient-to-br from-indigo-600 to-indigo-700 rounded-lg flex items-center justify-center">
            <lucide-angular name="menu" [size]="20" class="text-white"></lucide-angular>
          </div>
          <div>
            <h1 class="text-xl font-bold text-white">Configuracion de Menu</h1>
            <p class="text-sm text-gray-400">Configura la visibilidad del menu por rol</p>
          </div>
        </div>
      </div>

      <!-- Role Tabs -->
      <div class="flex gap-2 mb-4">
        @for (role of roles; track role) {
          <button
            (click)="selectRole(role)"
            [class]="selectedRole() === role
              ? 'bg-indigo-600 text-white'
              : 'bg-slate-800 text-gray-300 hover:bg-slate-700'"
            class="px-4 py-2 rounded-lg text-sm font-semibold transition-colors">
            {{ roleLabels[role] }}
          </button>
        }
      </div>

      <!-- Loading -->
      @if (loading()) {
        <div class="flex items-center justify-center py-12">
          <lucide-angular name="loader-2" [size]="32" class="text-indigo-400 animate-spin"></lucide-angular>
        </div>
      } @else {
        <!-- Drag Drop Columns -->
        <div class="grid grid-cols-2 gap-4">
          <!-- Visible Items -->
          <div class="bg-slate-900 rounded-lg border border-slate-800 p-4">
            <div class="flex items-center gap-2 mb-3">
              <lucide-angular name="eye" [size]="18" class="text-green-400"></lucide-angular>
              <h2 class="text-sm font-bold text-white">Elementos Visibles</h2>
              <span class="text-xs text-gray-400">({{ visibleItems().length }})</span>
            </div>

            <div class="min-h-[400px] space-y-2 p-2 bg-slate-800/50 rounded-lg border-2 border-dashed border-slate-700">
              @for (group of visibleHierarchy(); track group.item.codigo) {
                <!-- Parent/Root Item -->
                <div class="space-y-1">
                  <div class="flex items-center justify-between p-2 bg-slate-800 rounded border border-slate-700 hover:border-indigo-500/50 group">
                    <div class="flex items-center gap-2">
                      <lucide-angular [name]="group.item.icono" [size]="16" class="text-indigo-400"></lucide-angular>
                      <span class="text-sm text-white font-medium">{{ group.item.etiqueta }}</span>
                      @if (group.item.tipo === 'DROPDOWN') {
                        <span class="text-xs bg-indigo-500/20 text-indigo-300 px-1.5 py-0.5 rounded">dropdown</span>
                      }
                      <span class="text-xs text-gray-500">#{{ group.item.orden }}</span>
                    </div>
                    <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                      @if (group.item.tipo !== 'DROPDOWN') {
                        <button
                          (click)="openParentModal(group.item)"
                          class="p-1 text-gray-400 hover:text-indigo-400"
                          title="Asignar padre">
                          <lucide-angular name="folder-tree" [size]="14"></lucide-angular>
                        </button>
                      }
                      <button
                        (click)="moveToHidden(group.item)"
                        class="p-1 text-gray-400 hover:text-red-400"
                        title="Ocultar">
                        <lucide-angular name="eye-off" [size]="14"></lucide-angular>
                      </button>
                    </div>
                  </div>

                  <!-- Children -->
                  @for (child of group.children; track child.codigo) {
                    <div class="flex items-center justify-between p-2 ml-6 bg-slate-800/70 rounded border border-slate-700/50 hover:border-indigo-500/50 group">
                      <div class="flex items-center gap-2">
                        <lucide-angular name="corner-down-right" [size]="12" class="text-gray-500"></lucide-angular>
                        <lucide-angular [name]="child.icono" [size]="14" class="text-indigo-300"></lucide-angular>
                        <span class="text-sm text-gray-200">{{ child.etiqueta }}</span>
                        <span class="text-xs text-gray-500">#{{ child.orden }}</span>
                      </div>
                      <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button
                          (click)="removeParent(child)"
                          class="p-1 text-gray-400 hover:text-yellow-400"
                          title="Quitar de {{ group.item.etiqueta }}">
                          <lucide-angular name="unlink" [size]="14"></lucide-angular>
                        </button>
                        <button
                          (click)="openParentModal(child)"
                          class="p-1 text-gray-400 hover:text-indigo-400"
                          title="Cambiar padre">
                          <lucide-angular name="folder-tree" [size]="14"></lucide-angular>
                        </button>
                        <button
                          (click)="moveToHidden(child)"
                          class="p-1 text-gray-400 hover:text-red-400"
                          title="Ocultar">
                          <lucide-angular name="eye-off" [size]="14"></lucide-angular>
                        </button>
                      </div>
                    </div>
                  }
                </div>
              }

              @if (visibleItems().length === 0) {
                <div class="flex flex-col items-center justify-center py-8 text-gray-500">
                  <lucide-angular name="eye-off" [size]="32"></lucide-angular>
                  <p class="text-sm mt-2">No hay elementos visibles</p>
                </div>
              }
            </div>
          </div>

          <!-- Hidden Items -->
          <div class="bg-slate-900 rounded-lg border border-slate-800 p-4">
            <div class="flex items-center gap-2 mb-3">
              <lucide-angular name="eye-off" [size]="18" class="text-red-400"></lucide-angular>
              <h2 class="text-sm font-bold text-white">Elementos Ocultos</h2>
              <span class="text-xs text-gray-400">({{ hiddenItems().length }})</span>
            </div>

            <div class="min-h-[400px] space-y-2 p-2 bg-slate-800/50 rounded-lg border-2 border-dashed border-slate-700">
              @for (group of hiddenHierarchy(); track group.item.codigo) {
                <!-- Parent/Root Item -->
                <div class="space-y-1">
                  <div class="flex items-center justify-between p-2 bg-slate-800 rounded border border-slate-700 hover:border-indigo-500/50 group opacity-60 hover:opacity-100">
                    <div class="flex items-center gap-2">
                      <lucide-angular [name]="group.item.icono" [size]="16" class="text-gray-400"></lucide-angular>
                      <span class="text-sm text-gray-300">{{ group.item.etiqueta }}</span>
                      @if (group.item.tipo === 'DROPDOWN') {
                        <span class="text-xs bg-gray-500/20 text-gray-400 px-1.5 py-0.5 rounded">dropdown</span>
                      }
                      <span class="text-xs text-gray-600">#{{ group.item.orden }}</span>
                    </div>
                    <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                      @if (group.item.tipo !== 'DROPDOWN') {
                        <button
                          (click)="openParentModal(group.item)"
                          class="p-1 text-gray-400 hover:text-indigo-400"
                          title="Asignar padre">
                          <lucide-angular name="folder-tree" [size]="14"></lucide-angular>
                        </button>
                      }
                      <button
                        (click)="moveToVisible(group.item)"
                        class="p-1 text-gray-400 hover:text-green-400"
                        title="Mostrar">
                        <lucide-angular name="eye" [size]="14"></lucide-angular>
                      </button>
                    </div>
                  </div>

                  <!-- Children -->
                  @for (child of group.children; track child.codigo) {
                    <div class="flex items-center justify-between p-2 ml-6 bg-slate-800/50 rounded border border-slate-700/30 hover:border-indigo-500/50 group opacity-60 hover:opacity-100">
                      <div class="flex items-center gap-2">
                        <lucide-angular name="corner-down-right" [size]="12" class="text-gray-600"></lucide-angular>
                        <lucide-angular [name]="child.icono" [size]="14" class="text-gray-500"></lucide-angular>
                        <span class="text-sm text-gray-400">{{ child.etiqueta }}</span>
                        <span class="text-xs text-gray-600">#{{ child.orden }}</span>
                      </div>
                      <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button
                          (click)="removeParent(child)"
                          class="p-1 text-gray-400 hover:text-yellow-400"
                          title="Quitar de {{ group.item.etiqueta }}">
                          <lucide-angular name="unlink" [size]="14"></lucide-angular>
                        </button>
                        <button
                          (click)="openParentModal(child)"
                          class="p-1 text-gray-400 hover:text-indigo-400"
                          title="Cambiar padre">
                          <lucide-angular name="folder-tree" [size]="14"></lucide-angular>
                        </button>
                        <button
                          (click)="moveToVisible(child)"
                          class="p-1 text-gray-400 hover:text-green-400"
                          title="Mostrar">
                          <lucide-angular name="eye" [size]="14"></lucide-angular>
                        </button>
                      </div>
                    </div>
                  }
                </div>
              }

              @if (hiddenItems().length === 0) {
                <div class="flex flex-col items-center justify-center py-8 text-gray-500">
                  <lucide-angular name="check-circle" [size]="32"></lucide-angular>
                  <p class="text-sm mt-2">Todos los elementos son visibles</p>
                </div>
              }
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="mt-4 flex justify-end gap-2">
          <button
            (click)="cancel()"
            [disabled]="!hasChanges()"
            class="px-4 py-2 bg-slate-700 hover:bg-slate-600 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-lg text-sm font-semibold transition-colors">
            Cancelar
          </button>
          <button
            (click)="save()"
            [disabled]="!hasChanges() || saving()"
            class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-lg text-sm font-semibold transition-colors flex items-center gap-2">
            @if (saving()) {
              <lucide-angular name="loader-2" [size]="16" class="animate-spin"></lucide-angular>
            } @else {
              <lucide-angular name="save" [size]="16"></lucide-angular>
            }
            Guardar Cambios
          </button>
        </div>
      }
    </div>
  </div>
</div>

<!-- Modal para asignar padre -->
@if (showParentModal()) {
  <div class="fixed inset-0 bg-black/60 flex items-center justify-center z-50" (click)="closeParentModal()">
    <div class="bg-slate-900 rounded-lg border border-slate-700 p-4 w-96 max-w-[90vw]" (click)="$event.stopPropagation()">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold text-white">Asignar Padre</h3>
        <button (click)="closeParentModal()" class="text-gray-400 hover:text-white">
          <lucide-angular name="x" [size]="20"></lucide-angular>
        </button>
      </div>

      @if (itemToAssignParent(); as item) {
        <p class="text-sm text-gray-400 mb-4">
          Selecciona el dropdown padre para: <span class="text-white font-medium">{{ item.etiqueta }}</span>
        </p>

        @if (item.codigoPadre) {
          <div class="mb-3 p-2 bg-slate-800 rounded border border-slate-700">
            <span class="text-xs text-gray-400">Padre actual:</span>
            <span class="text-sm text-indigo-400 ml-2">{{ getParentLabel(item.codigoPadre) }}</span>
          </div>
        }

        <div class="space-y-2 max-h-60 overflow-y-auto">
          <!-- Opcion: Sin padre -->
          <button
            (click)="assignParent(null)"
            class="w-full flex items-center gap-2 p-2 bg-slate-800 hover:bg-slate-700 rounded border border-slate-700 text-left transition-colors">
            <lucide-angular name="minus-circle" [size]="16" class="text-gray-400"></lucide-angular>
            <span class="text-sm text-gray-300">Sin padre (elemento raiz)</span>
          </button>

          <!-- Dropdowns disponibles -->
          @for (parent of availableParents(); track parent.codigo) {
            @if (parent.codigo !== item.codigo) {
              <button
                (click)="assignParent(parent.codigo)"
                [class]="item.codigoPadre === parent.codigo ? 'border-indigo-500 bg-indigo-500/10' : 'border-slate-700'"
                class="w-full flex items-center gap-2 p-2 bg-slate-800 hover:bg-slate-700 rounded border text-left transition-colors">
                <lucide-angular [name]="parent.icono" [size]="16" class="text-indigo-400"></lucide-angular>
                <span class="text-sm text-white">{{ parent.etiqueta }}</span>
                @if (item.codigoPadre === parent.codigo) {
                  <lucide-angular name="check" [size]="14" class="text-indigo-400 ml-auto"></lucide-angular>
                }
              </button>
            }
          }
        </div>
      }
    </div>
  </div>
}
