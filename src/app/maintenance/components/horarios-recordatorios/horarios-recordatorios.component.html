<div class="horarios-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-icon">
        <lucide-angular name="clock" [size]="24"></lucide-angular>
      </div>
      <div>
        <h1>Horarios de Recordatorios</h1>
        <p>Configura las franjas horarias en que se muestra el modal de recordatorios por subcartera</p>
      </div>
    </div>
  </div>

  <!-- Filtros de seleccion -->
  <div class="filters-card">
    <div class="filters-row">
      <div class="filter-group">
        <label>Inquilino</label>
        <select [(ngModel)]="selectedTenant" (change)="onTenantChange()">
          <option [ngValue]="null">Seleccione inquilino</option>
          <option *ngFor="let t of tenants" [ngValue]="t.id">{{ t.tenantName }}</option>
        </select>
      </div>

      <div class="filter-group">
        <label>Cartera</label>
        <select [(ngModel)]="selectedPortfolio" (change)="onPortfolioChange()" [disabled]="!selectedTenant">
          <option [ngValue]="null">Seleccione cartera</option>
          <option *ngFor="let p of filteredPortfolios" [ngValue]="p.id">{{ p.portfolioName }}</option>
        </select>
      </div>

      <div class="filter-group">
        <label>Subcartera</label>
        <select [(ngModel)]="selectedSubcartera" (change)="onSubcarteraChange()" [disabled]="!selectedPortfolio">
          <option [ngValue]="null">Seleccione subcartera</option>
          <option *ngFor="let s of filteredSubPortfolios" [ngValue]="s.id">{{ s.subPortfolioName }}</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Acciones -->
  <div class="actions-bar" *ngIf="selectedSubcartera">
    <button class="btn-secondary" (click)="crearHorariosDefecto()" [disabled]="saving">
      <lucide-angular name="wand-2" [size]="18"></lucide-angular>
      <span>Crear Horarios Por Defecto</span>
    </button>
    <button class="btn-primary" (click)="openNewModal()">
      <lucide-angular name="plus" [size]="18"></lucide-angular>
      <span>Nuevo Horario</span>
    </button>
  </div>

  <!-- Loading -->
  <div class="loading-overlay" *ngIf="loading">
    <div class="loading-spinner">
      <lucide-angular name="loader" [size]="32" class="spin"></lucide-angular>
      <span>Cargando...</span>
    </div>
  </div>

  <!-- Info de horarios por defecto -->
  <div class="info-card" *ngIf="selectedSubcartera && horarios.length === 0 && !loading">
    <lucide-angular name="info" [size]="20"></lucide-angular>
    <div>
      <p><strong>Sin horarios configurados</strong></p>
      <p>Esta subcartera no tiene horarios de recordatorios configurados. El modal se mostrara siempre.</p>
      <p>Horarios sugeridos: <strong>8-9am, 2-3pm, 5-6pm</strong></p>
    </div>
  </div>

  <!-- Tabla de Horarios -->
  <div class="table-card" *ngIf="selectedSubcartera && !loading && horarios.length > 0">
    <div class="table-wrapper">
      <table class="horarios-table">
        <thead>
          <tr>
            <th>Descripcion</th>
            <th>Hora Inicio</th>
            <th>Hora Fin</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let horario of horarios" [class.inactive]="!horario.activo">
            <td>
              <span class="descripcion">{{ horario.descripcion || 'Sin descripcion' }}</span>
            </td>
            <td class="time-cell">
              <lucide-angular name="clock" [size]="14"></lucide-angular>
              {{ formatTimeForDisplay(horario.horaInicio) }}
            </td>
            <td class="time-cell">
              <lucide-angular name="clock" [size]="14"></lucide-angular>
              {{ formatTimeForDisplay(horario.horaFin) }}
            </td>
            <td>
              <span class="status-badge" [class.active]="horario.activo" [class.inactive]="!horario.activo">
                {{ horario.activo ? 'Activo' : 'Inactivo' }}
              </span>
            </td>
            <td class="actions-cell">
              <button class="btn-icon" (click)="toggleActivo(horario)" [title]="horario.activo ? 'Desactivar' : 'Activar'">
                <lucide-angular [name]="horario.activo ? 'eye-off' : 'eye'" [size]="16"></lucide-angular>
              </button>
              <button class="btn-icon" (click)="openEditModal(horario)" title="Editar">
                <lucide-angular name="pencil" [size]="16"></lucide-angular>
              </button>
              <button class="btn-icon danger" (click)="deleteHorario(horario)" title="Eliminar">
                <lucide-angular name="trash-2" [size]="16"></lucide-angular>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ==================== CONFIGURACIÓN DE PROMESAS ==================== -->
  <div class="config-promesas-section" *ngIf="selectedSubcartera && configPromesas">
    <div class="section-header">
      <div class="header-icon">
        <lucide-angular name="calendar-check" [size]="24"></lucide-angular>
      </div>
      <div>
        <h2>Configuracion de Promesas para Recordatorios</h2>
        <p>Define que promesas se incluiran en el discado automatico</p>
      </div>
    </div>

    <div class="config-cards-row">
      <!-- Promesas Próximas -->
      <div class="config-card proximas">
        <div class="config-card-header">
          <lucide-angular name="calendar-plus" [size]="20"></lucide-angular>
          <h3>Promesas Vigentes (Proximas)</h3>
        </div>
        <div class="config-card-body">
          <div class="config-input-row">
            <span>Incluir promesas de hoy +</span>
            <select [(ngModel)]="configPromesas.diasProximosPromesas">
              <option [ngValue]="0">0</option>
              <option [ngValue]="1">1</option>
              <option [ngValue]="2">2</option>
              <option [ngValue]="3">3</option>
              <option [ngValue]="4">4</option>
              <option [ngValue]="5">5</option>
              <option [ngValue]="6">6</option>
              <option [ngValue]="7">7</option>
            </select>
            <span>dia(s) adelante</span>
          </div>
          <div class="config-description" *ngIf="resumenPromesas">
            <lucide-angular name="info" [size]="14"></lucide-angular>
            <span>{{ resumenPromesas.proximas.descripcion }}</span>
          </div>
        </div>
      </div>

      <!-- Promesas Vencidas -->
      <div class="config-card vencidas">
        <div class="config-card-header">
          <lucide-angular name="calendar-x" [size]="20"></lucide-angular>
          <h3>Promesas Vencidas (Caidas)</h3>
        </div>
        <div class="config-card-body">
          <div class="config-input-row">
            <span>Incluir promesas vencidas de</span>
            <select [(ngModel)]="configPromesas.diasVencidasPromesas">
              <option [ngValue]="0">No incluir</option>
              <option [ngValue]="1">1</option>
              <option [ngValue]="2">2</option>
              <option [ngValue]="3">3</option>
              <option [ngValue]="4">4</option>
              <option [ngValue]="5">5</option>
              <option [ngValue]="6">6</option>
              <option [ngValue]="7">7</option>
            </select>
            <span>dia(s) atras</span>
          </div>
          <div class="config-description vencidas-note">
            <lucide-angular name="alert-circle" [size]="14"></lucide-angular>
            <span>Sin contar el dia anterior (ayer se omite)</span>
          </div>
          <div class="config-description" *ngIf="resumenPromesas && resumenPromesas.vencidas.descripcion">
            <lucide-angular name="info" [size]="14"></lucide-angular>
            <span>{{ resumenPromesas.vencidas.descripcion }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Resumen de fechas -->
    <div class="resumen-fechas" *ngIf="resumenPromesas">
      <h4>Resumen de Rangos de Fecha</h4>
      <div class="resumen-row">
        <div class="resumen-item proximas">
          <span class="label">Proximas:</span>
          <span class="fechas">{{ resumenPromesas.proximas.desde }} al {{ resumenPromesas.proximas.hasta }}</span>
        </div>
        <div class="resumen-item vencidas" *ngIf="resumenPromesas.vencidas.desde">
          <span class="label">Vencidas:</span>
          <span class="fechas">{{ resumenPromesas.vencidas.desde }} al {{ resumenPromesas.vencidas.hasta }}</span>
        </div>
        <div class="resumen-item vencidas no-vencidas" *ngIf="!resumenPromesas.vencidas.desde">
          <span class="label">Vencidas:</span>
          <span class="fechas">No se incluyen</span>
        </div>
      </div>
    </div>

    <!-- Botón guardar -->
    <div class="config-actions">
      <button class="btn-primary" (click)="saveConfigPromesas()" [disabled]="savingPromesas">
        <lucide-angular *ngIf="savingPromesas" name="loader" [size]="16" class="spin"></lucide-angular>
        <lucide-angular *ngIf="!savingPromesas" name="save" [size]="16"></lucide-angular>
        <span>{{ savingPromesas ? 'Guardando...' : 'Guardar Configuracion de Promesas' }}</span>
      </button>
    </div>
  </div>

  <!-- Empty State (sin subcartera seleccionada) -->
  <div class="empty-state" *ngIf="!selectedSubcartera && !loading">
    <lucide-angular name="clock" [size]="48"></lucide-angular>
    <p>Seleccione una subcartera para ver y configurar sus horarios de recordatorios</p>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ editMode ? 'Editar Horario' : 'Nuevo Horario' }}</h2>
        <button class="btn-close" (click)="closeModal()">
          <lucide-angular name="x" [size]="20"></lucide-angular>
        </button>
      </div>

      <div class="modal-body">
        <div class="form-group">
          <label>Descripcion</label>
          <input type="text" [(ngModel)]="currentHorario.descripcion" placeholder="Ej: Manana, Tarde 1, Tarde 2">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Hora Inicio</label>
            <input type="time" [(ngModel)]="currentHorario.horaInicio">
          </div>
          <div class="form-group">
            <label>Hora Fin</label>
            <input type="time" [(ngModel)]="currentHorario.horaFin">
          </div>
        </div>

        <div class="form-group checkbox-group">
          <label>
            <input type="checkbox" [(ngModel)]="currentHorario.activo">
            <span>Activo</span>
          </label>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeModal()">Cancelar</button>
        <button class="btn-primary" (click)="saveHorario()" [disabled]="saving">
          <lucide-angular *ngIf="saving" name="loader" [size]="16" class="spin"></lucide-angular>
          <span>{{ saving ? 'Guardando...' : 'Guardar' }}</span>
        </button>
      </div>
    </div>
  </div>
</div>
