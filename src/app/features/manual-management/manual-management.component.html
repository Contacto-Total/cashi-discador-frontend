<div class="manual-management-container">
  <!-- Header -->
  <div class="page-header">
    <h1>Gestión Manual</h1>
    <p class="subtitle">Busca un cliente por documento para tipificar sin necesidad de una llamada</p>
  </div>

  <!-- Buscador -->
  <mat-card class="search-card">
    <mat-card-header>
      <mat-card-title>Buscar Cliente</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="search-container">
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Documento (DNI/Cédula)</mat-label>
          <input matInput
                 [value]="searchDocument()"
                 (input)="onSearchInput($event)"
                 (keyup.enter)="searchByDocument()"
                 placeholder="Ingresa el documento del cliente">
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>

        <button mat-raised-button color="primary"
                (click)="searchByDocument()"
                [disabled]="searching()">
          @if (searching()) {
            <mat-spinner diameter="20"></mat-spinner>
          } @else {
            Buscar
          }
        </button>
      </div>

      <!-- Resultados de autocompletado -->
      @if (searchResults().length > 0) {
        <div class="autocomplete-results">
          @for (client of searchResults(); track client.documento) {
            <div class="autocomplete-item" (click)="selectClient(client)">
              <span class="doc">{{ client.documento }}</span>
              <span class="name">{{ getClientName(client) }}</span>
              <span class="phone">{{ getClientPhone(client) }}</span>
            </div>
          }
        </div>
      }

      <!-- Error de búsqueda -->
      @if (searchError()) {
        <div class="search-error">
          <mat-icon>error</mat-icon>
          {{ searchError() }}
        </div>
      }
    </mat-card-content>
  </mat-card>

  <!-- Cliente seleccionado + Tipificación -->
  @if (selectedClient()) {
    <div class="client-typification-grid">
      <!-- Datos del cliente -->
      <mat-card class="client-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>person</mat-icon>
            Datos del Cliente
          </mat-card-title>
          <button mat-icon-button (click)="clearSelection()" class="clear-btn">
            <mat-icon>close</mat-icon>
          </button>
        </mat-card-header>
        <mat-card-content>
          <div class="client-info">
            <div class="info-row highlight">
              <span class="label">Documento:</span>
              <span class="value">{{ selectedClient()!.documento }}</span>
            </div>
            <div class="info-row highlight">
              <span class="label">Nombre:</span>
              <span class="value">{{ getClientName(selectedClient()!) }}</span>
            </div>
            <div class="info-row">
              <span class="label">Teléfono:</span>
              <span class="value">{{ getClientPhone(selectedClient()!) }}</span>
            </div>
            @if (selectedClient()!.deuda_capital) {
              <div class="info-row">
                <span class="label">Deuda Capital:</span>
                <span class="value money">{{ formatCurrency(selectedClient()!.deuda_capital) }}</span>
              </div>
            }
            @if (selectedClient()!.deuda_mora) {
              <div class="info-row">
                <span class="label">Deuda Mora:</span>
                <span class="value money">{{ formatCurrency(selectedClient()!.deuda_mora) }}</span>
              </div>
            }
            @if (selectedClient()!.dias_mora) {
              <div class="info-row">
                <span class="label">Días Mora:</span>
                <span class="value">{{ selectedClient()!.dias_mora }} días</span>
              </div>
            }
          </div>

          <!-- Campos dinámicos adicionales -->
          <details class="extra-fields">
            <summary>Ver todos los campos</summary>
            <div class="fields-grid">
              @for (field of getClientFields(selectedClient()!); track field.key) {
                <div class="field-item">
                  <span class="field-label">{{ field.key }}:</span>
                  <span class="field-value">{{ field.value }}</span>
                </div>
              }
            </div>
          </details>
        </mat-card-content>
      </mat-card>

      <!-- Formulario de tipificación -->
      <mat-card class="typification-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>assignment</mat-icon>
            Tipificación
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          @if (loadingTypifications()) {
            <div class="loading-center">
              <mat-spinner diameter="40"></mat-spinner>
              <span>Cargando tipificaciones...</span>
            </div>
          } @else {
            <form [formGroup]="typificationForm" class="typification-form">
              <!-- Nivel 1 -->
              <div class="nivel-section">
                <label class="nivel-label">Resultado del Contacto</label>
                <app-chip-select
                  [options]="getChipOptions(nivel1Options)"
                  [value]="typificationForm.get('nivel1')?.value"
                  [allowCustomValue]="false"
                  (valueChange)="onNivelChipSelect('nivel1', $event)">
                </app-chip-select>
              </div>

              <!-- Nivel 2 -->
              @if (nivel2Options.length > 0) {
                <div class="nivel-section">
                  <label class="nivel-label">Tipo de Gestión</label>
                  <app-chip-select
                    [options]="getChipOptions(nivel2Options)"
                    [value]="typificationForm.get('nivel2')?.value"
                    [allowCustomValue]="false"
                    (valueChange)="onNivelChipSelect('nivel2', $event)">
                  </app-chip-select>
                </div>
              }

              <!-- Nivel 3 -->
              @if (nivel3Options.length > 0) {
                <div class="nivel-section">
                  <label class="nivel-label">Modalidad de Pago</label>
                  <app-chip-select
                    [options]="getChipOptions(nivel3Options)"
                    [value]="typificationForm.get('nivel3')?.value"
                    [allowCustomValue]="false"
                    (valueChange)="onNivelChipSelect('nivel3', $event)">
                  </app-chip-select>
                </div>
              }

              <!-- Nivel 4 -->
              @if (nivel4Options.length > 0) {
                <div class="nivel-section">
                  <label class="nivel-label">Tipo de Fraccionamiento</label>
                  <app-chip-select
                    [options]="getChipOptions(nivel4Options)"
                    [value]="typificationForm.get('nivel4')?.value"
                    [allowCustomValue]="false"
                    (valueChange)="onNivelChipSelect('nivel4', $event)">
                  </app-chip-select>
                </div>
              }

              <!-- Campos adicionales dinámicos -->
              @if (loadingAdditionalFields()) {
                <div class="loading-fields">
                  <mat-spinner diameter="24"></mat-spinner>
                  <span>Cargando campos...</span>
                </div>
              }

              @if (additionalFieldsV2.length > 0) {
                <div class="additional-fields-section">
                  <label class="section-label">Campos Adicionales</label>
                  @for (field of additionalFieldsV2; track field.id) {
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>{{ field.labelCampo || field.nombreCampo }}</mat-label>

                      @switch (field.tipoCampo) {
                        @case (FieldTypeV2.TEXT) {
                          <input matInput [formControlName]="field.nombreCampo">
                        }
                        @case (FieldTypeV2.TEXTAREA) {
                          <textarea matInput [formControlName]="field.nombreCampo" rows="2"></textarea>
                        }
                        @case (FieldTypeV2.NUMBER) {
                          <input matInput type="number" [formControlName]="field.nombreCampo">
                        }
                        @case (FieldTypeV2.DATE) {
                          <input matInput [matDatepicker]="picker" [formControlName]="field.nombreCampo">
                          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                          <mat-datepicker #picker></mat-datepicker>
                        }
                        @case (FieldTypeV2.CHIP_SELECT) {
                          <mat-select [formControlName]="field.nombreCampo">
                            @for (opt of field.options || []; track opt.value) {
                              <mat-option [value]="opt.value">{{ opt.label }}</mat-option>
                            }
                          </mat-select>
                        }
                        @default {
                          <input matInput [formControlName]="field.nombreCampo">
                        }
                      }

                      @if (field.esRequerido) {
                        <mat-hint>Campo obligatorio</mat-hint>
                      }
                    </mat-form-field>
                  }
                </div>
              }

              <!-- Notas / Observaciones -->
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Observaciones</mat-label>
                <textarea matInput formControlName="notes" rows="3"
                          placeholder="Ingresa las observaciones de la gestión"></textarea>
              </mat-form-field>

              <!-- Fecha de seguimiento -->
              <mat-form-field appearance="outline">
                <mat-label>Fecha de Seguimiento</mat-label>
                <input matInput [matDatepicker]="schedulePicke" formControlName="scheduleCallback">
                <mat-datepicker-toggle matSuffix [for]="schedulePicke"></mat-datepicker-toggle>
                <mat-datepicker #schedulePicke></mat-datepicker>
              </mat-form-field>

              <!-- Botón guardar -->
              <div class="form-actions">
                @if (saveError()) {
                  <div class="save-error">
                    <mat-icon>error</mat-icon>
                    {{ saveError() }}
                  </div>
                }

                @if (saveSuccess()) {
                  <div class="save-success">
                    <mat-icon>check_circle</mat-icon>
                    Tipificación guardada exitosamente
                  </div>
                }

                <button mat-raised-button color="primary"
                        type="button"
                        (click)="saveTypification()"
                        [disabled]="saving() || !typificationForm.valid">
                  @if (saving()) {
                    <mat-spinner diameter="20"></mat-spinner>
                    Guardando...
                  } @else {
                    <mat-icon>save</mat-icon>
                    Guardar Tipificación
                  }
                </button>
              </div>
            </form>
          }
        </mat-card-content>
      </mat-card>
    </div>
  }
</div>
