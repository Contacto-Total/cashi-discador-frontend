<div class="recordings-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-icon">
        <lucide-angular name="disc" [size]="24"></lucide-angular>
      </div>
      <div>
        <h1>Grabaciones del Discador</h1>
        <p>Busca y descarga las grabaciones de llamadas por proveedor, cartera y subcartera</p>
      </div>
    </div>
    <div class="header-stats" *ngIf="hasSearched">
      <div class="stat-badge">
        <span class="stat-value">{{ filteredRecordings.length }}</span>
        <span class="stat-label">grabaciones</span>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="filters-section">
    <div class="filters-row">
      <!-- Proveedor -->
      <div class="filter-group">
        <label>Proveedor</label>
        <select [(ngModel)]="selectedTenantId" (change)="onTenantChange()">
          <option [value]="0">Seleccionar...</option>
          <option *ngFor="let tenant of tenants" [value]="tenant.id">{{ tenant.tenantName }}</option>
        </select>
      </div>

      <!-- Cartera -->
      <div class="filter-group">
        <label>Cartera</label>
        <select [(ngModel)]="selectedPortfolioId" (change)="onPortfolioChange()" [disabled]="portfolios.length === 0">
          <option [value]="0">Seleccionar...</option>
          <option *ngFor="let portfolio of portfolios" [value]="portfolio.id">{{ portfolio.portfolioName }}</option>
        </select>
      </div>

      <!-- Subcartera -->
      <div class="filter-group">
        <label>Subcartera</label>
        <select [(ngModel)]="selectedSubPortfolioId" [disabled]="subPortfolios.length === 0">
          <option [value]="0">Seleccionar...</option>
          <option *ngFor="let sub of subPortfolios" [value]="sub.id">{{ sub.subPortfolioName }}</option>
        </select>
      </div>

      <div class="filter-divider"></div>

      <!-- Tipo de busqueda -->
      <div class="filter-group">
        <label>Buscar por</label>
        <select [(ngModel)]="selectedTipoBusqueda" (change)="changeTypeSearch()">
          <option value="fechas">Fechas</option>
          <option value="documento">Documento</option>
          <option value="telefono">Teléfono</option>
        </select>
      </div>

      <!-- Search by Dates -->
      <ng-container *ngIf="selectedTipoBusqueda === 'fechas'">
        <div class="filter-group">
          <label>Desde</label>
          <input type="date" [(ngModel)]="startDate" (change)="validateDates()">
        </div>
        <div class="filter-group">
          <label>Hasta</label>
          <input type="date" [(ngModel)]="endDate" (change)="validateDates()">
        </div>
      </ng-container>

      <!-- Search by Document -->
      <div class="filter-group" *ngIf="selectedTipoBusqueda === 'documento'">
        <label>Documento</label>
        <input type="text" [(ngModel)]="documento" placeholder="Ingrese documento"
               (keyup.enter)="searchByDocumento()">
      </div>

      <!-- Search by Phone -->
      <div class="filter-group" *ngIf="selectedTipoBusqueda === 'telefono'">
        <label>Teléfono</label>
        <input type="text" [(ngModel)]="telefono" placeholder="Ingrese teléfono"
               (keyup.enter)="searchByTelefono()">
      </div>

      <!-- Search Button -->
      <div class="filter-group filter-action">
        <button class="btn-primary" [disabled]="isLoading"
                (click)="selectedTipoBusqueda === 'fechas' ? searchByDates() : selectedTipoBusqueda === 'documento' ? searchByDocumento() : searchByTelefono()">
          <lucide-angular [img]="isLoading ? Loader : Search" [size]="16" [class.spin]="isLoading"></lucide-angular>
          <span>{{ isLoading ? 'Buscando...' : 'Buscar' }}</span>
        </button>
      </div>

      <div class="filter-divider" *ngIf="recordings.length > 0"></div>

      <!-- Massive Download -->
      <div class="filter-group filter-action" *ngIf="recordings.length > 0">
        <button class="btn-download" (click)="massiveDownloadAudios()"
                [disabled]="isDownloadingMassive">
          <lucide-angular [img]="isDownloadingMassive ? Loader : Download" [size]="16"
                          [class.spin]="isDownloadingMassive"></lucide-angular>
          <span>{{ isDownloadingMassive ? 'Descargando...' : 'Descargar todo' }}</span>
        </button>
      </div>
    </div>

    <!-- Error Message -->
    <div *ngIf="errorMessage" class="error-message">
      <lucide-angular [img]="X" [size]="16"></lucide-angular>
      {{ errorMessage }}
    </div>
  </div>

  <!-- Loading -->
  <div class="loading-overlay" *ngIf="isLoading">
    <div class="loading-spinner">
      <lucide-angular name="loader" [size]="32" class="spin"></lucide-angular>
      <span>Buscando grabaciones...</span>
    </div>
  </div>

  <!-- Results Table -->
  <div class="table-card animate-in" *ngIf="recordings.length > 0 && !isLoading">
    <div class="table-header">
      <h3>Resultados</h3>
      <span class="record-count">{{ filteredRecordings.length }} de {{ recordings.length }} registros</span>
    </div>

    <div class="table-wrapper">
      <table class="recordings-table">
        <thead>
          <!-- Filter Row -->
          <tr class="filter-row">
            <th>
              <input type="text" [(ngModel)]="filterDocumento" (input)="applyFilters()" placeholder="Filtrar DNI...">
            </th>
            <th>
              <input type="text" [(ngModel)]="filterTelefono" (input)="applyFilters()" placeholder="Filtrar tel...">
            </th>
            <th></th>
            <th>
              <input type="text" [(ngModel)]="filterCampana" (input)="applyFilters()" placeholder="Filtrar campaña...">
            </th>
            <th>
              <input type="text" [(ngModel)]="filterAgente" (input)="applyFilters()" placeholder="Filtrar agente...">
            </th>
            <th></th>
            <th></th>
            <th></th>
            <th>
              <select [(ngModel)]="filterEstado" (change)="applyFilters()">
                <option *ngFor="let estado of getUniqueEstados()" [value]="estado.value">{{ estado.label }}</option>
              </select>
            </th>
            <th></th>
            <th class="col-action">
              <button class="btn-clear-filters" (click)="clearFilters()" title="Limpiar filtros">
                <lucide-angular [img]="X" [size]="14"></lucide-angular>
              </button>
            </th>
          </tr>

          <!-- Header Row -->
          <tr>
            <th (click)="sort('documento')" class="sortable">
              Documento
              <span class="sort-icon" *ngIf="sortField === 'documento'">{{ sortOrder === 1 ? '\u25B2' : '\u25BC' }}</span>
            </th>
            <th (click)="sort('telefono')" class="sortable">
              Teléfono
              <span class="sort-icon" *ngIf="sortField === 'telefono'">{{ sortOrder === 1 ? '\u25B2' : '\u25BC' }}</span>
            </th>
            <th (click)="sort('cliente')" class="sortable">
              Cliente
              <span class="sort-icon" *ngIf="sortField === 'cliente'">{{ sortOrder === 1 ? '\u25B2' : '\u25BC' }}</span>
            </th>
            <th (click)="sort('campana')" class="sortable">
              Campaña
              <span class="sort-icon" *ngIf="sortField === 'campana'">{{ sortOrder === 1 ? '\u25B2' : '\u25BC' }}</span>
            </th>
            <th (click)="sort('agente')" class="sortable">
              Agente
              <span class="sort-icon" *ngIf="sortField === 'agente'">{{ sortOrder === 1 ? '\u25B2' : '\u25BC' }}</span>
            </th>
            <th (click)="sort('fechaInicio')" class="sortable">
              Fecha
              <span class="sort-icon" *ngIf="sortField === 'fechaInicio'">{{ sortOrder === 1 ? '\u25B2' : '\u25BC' }}</span>
            </th>
            <th>Hora</th>
            <th (click)="sort('duracionSegundos')" class="sortable">
              Duración
              <span class="sort-icon" *ngIf="sortField === 'duracionSegundos'">{{ sortOrder === 1 ? '\u25B2' : '\u25BC' }}</span>
            </th>
            <th (click)="sort('estadoLlamada')" class="sortable">
              Estado
              <span class="sort-icon" *ngIf="sortField === 'estadoLlamada'">{{ sortOrder === 1 ? '\u25B2' : '\u25BC' }}</span>
            </th>
            <th (click)="sort('resultado')" class="sortable">
              Resultado
              <span class="sort-icon" *ngIf="sortField === 'resultado'">{{ sortOrder === 1 ? '\u25B2' : '\u25BC' }}</span>
            </th>
            <th class="col-action">Audio</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let recording of paginatedRecordings; let i = index"
              class="animate-row" [style.animation-delay]="(i * 30) + 'ms'">
            <td class="cell-mono">{{ recording.documento }}</td>
            <td class="cell-mono">{{ recording.telefono }}</td>
            <td class="cell-truncate" [title]="recording.cliente">{{ recording.cliente }}</td>
            <td class="cell-truncate" [title]="recording.campana">{{ recording.campana }}</td>
            <td>{{ recording.agente || '-' }}</td>
            <td class="cell-mono">{{ formatDate(recording.fechaInicio) }}</td>
            <td class="cell-mono">{{ formatTime(recording.fechaInicio) }}</td>
            <td class="cell-mono">{{ formatDuration(recording.duracionSegundos) }}</td>
            <td>
              <span class="status-badge" [ngClass]="getEstadoClass(recording.estadoLlamada)">
                {{ recording.estadoLlamada }}
              </span>
            </td>
            <td class="cell-truncate" [title]="recording.resultado">{{ recording.resultado || '-' }}</td>
            <td class="col-action">
              <button class="btn-audio" (click)="downloadAudio(recording)"
                      [disabled]="downloadingUuid === recording.uuidLlamada"
                      title="Descargar audio">
                <lucide-angular [img]="downloadingUuid === recording.uuidLlamada ? Loader : Volume2"
                                [size]="15"
                                [class.spin]="downloadingUuid === recording.uuidLlamada"></lucide-angular>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="pagination">
      <div class="pagination-info">
        Mostrando {{ (currentPage - 1) * pageSize + 1 }} a
        {{ Math.min(currentPage * pageSize, filteredRecordings.length) }} de
        {{ filteredRecordings.length }}
      </div>

      <div class="pagination-controls">
        <button (click)="goToPage(1)" [disabled]="currentPage === 1">&laquo;</button>
        <button (click)="goToPage(currentPage - 1)" [disabled]="currentPage === 1">&lsaquo;</button>
        <button *ngFor="let page of getPageNumbers()"
                (click)="goToPage(page)"
                [class.active]="page === currentPage">
          {{ page }}
        </button>
        <button (click)="goToPage(currentPage + 1)" [disabled]="currentPage === totalPages">&rsaquo;</button>
        <button (click)="goToPage(totalPages)" [disabled]="currentPage === totalPages">&raquo;</button>
      </div>

      <div class="pagination-size">
        <label>Filas:</label>
        <select [(ngModel)]="pageSize" (change)="onPageSizeChange(pageSize)">
          <option [ngValue]="5">5</option>
          <option [ngValue]="10">10</option>
          <option [ngValue]="20">20</option>
          <option [ngValue]="50">50</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Empty State: No search yet -->
  <div class="empty-state animate-in" *ngIf="!hasSearched && !isLoading">
    <div class="empty-icon">
      <lucide-angular name="disc" [size]="48"></lucide-angular>
    </div>
    <h3>Buscar grabaciones</h3>
    <p>Selecciona un proveedor, cartera y subcartera, luego realiza una búsqueda para ver las grabaciones disponibles.</p>
  </div>

  <!-- Empty State: No results -->
  <div class="empty-state animate-in" *ngIf="hasSearched && recordings.length === 0 && !isLoading">
    <div class="empty-icon warning">
      <lucide-angular name="search" [size]="48"></lucide-angular>
    </div>
    <h3>Sin resultados</h3>
    <p>No se encontraron grabaciones con los criterios seleccionados. Intenta con otros filtros.</p>
  </div>
</div>
