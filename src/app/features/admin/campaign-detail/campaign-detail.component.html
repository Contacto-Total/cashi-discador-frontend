<div class="campaign-detail-container">
  <!-- Header estilo monitoring -->
  <div class="page-header">
    <div class="header-left">
      <div class="header-icon-box">
        <lucide-angular name="bar-chart-3" [size]="22"></lucide-angular>
      </div>
      <div class="header-text">
        <h1>Detalle de Campaña</h1>
        <p>Información detallada y métricas de la campaña</p>
      </div>
    </div>
    <button class="btn-back" (click)="goBack()">
      <lucide-angular name="arrow-left" [size]="16"></lucide-angular>
      <span>Volver</span>
    </button>
  </div>

  <!-- Error Message -->
  <div *ngIf="error" class="error-message"><lucide-angular name="x-circle" [size]="18"></lucide-angular> {{ error }}</div>

  <!-- Loading State -->
  <div *ngIf="loading && !statistics" class="loading-state">
    <div class="spinner"></div>
    <p>Cargando...</p>
  </div>

  <!-- Campaign Statistics -->
  <div *ngIf="statistics" class="statistics-section">
    <!-- Campaign Header -->
    <div class="campaign-header-card">
      <div class="campaign-title-section">
        <h2>{{ statistics.nombre }}</h2>
        <span
          class="status-badge"
          [style.background-color]="getEstadoCampanaColor(statistics.estadoActual)">
          {{ getEstadoCampanaTexto(statistics.estadoActual) }}
        </span>
        <!-- Toggle Button -->
        <button class="btn-toggle-chart" (click)="toggleChart()" title="Ver gráfico de distribución">
          <lucide-angular *ngIf="showChart" name="bar-chart-2" [size]="18"></lucide-angular>
          <lucide-angular *ngIf="!showChart" name="trending-up" [size]="18"></lucide-angular>
          {{ showChart ? 'Ver Métricas' : 'Ver Gráfico' }}
        </button>
      </div>
      <p *ngIf="statistics.descripcion" class="campaign-description">
        {{ statistics.descripcion }}
      </p>
    </div>

    <!-- Flip Container -->
    <div class="flip-container" [class.flipped]="showChart">
      <!-- Front: Metrics Grid -->
      <div class="flip-card-front">
        <div class="metrics-grid">
      <!-- Estado Actual -->
      <div class="metric-card">
        <span class="metric-icon"><lucide-angular name="bar-chart-2" [size]="24"></lucide-angular></span>
        <div class="metric-content">
          <span class="metric-label">Estado Actual</span>
          <span class="metric-value">{{ getEstadoCampanaTexto(statistics.estadoActual) }}</span>
        </div>
      </div>

      <!-- Fecha Inicio -->
      <div class="metric-card">
        <span class="metric-icon"><lucide-angular name="calendar" [size]="24"></lucide-angular></span>
        <div class="metric-content">
          <span class="metric-label">Fecha Inicio</span>
          <span class="metric-value">
            {{ statistics.fechaInicio ? (statistics.fechaInicio | date: 'dd-MM-yyyy') : '-' }}
          </span>
        </div>
      </div>

      <!-- Fecha Final -->
      <div class="metric-card">
        <span class="metric-icon"><lucide-angular name="flag" [size]="24"></lucide-angular></span>
        <div class="metric-content">
          <span class="metric-label">Fecha Final</span>
          <span class="metric-value">
            {{ statistics.fechaFinal ? (statistics.fechaFinal | date: 'dd-MM-yyyy') : '-' }}
          </span>
        </div>
      </div>

      <!-- Total de Registros -->
      <div class="metric-card">
        <span class="metric-icon"><lucide-angular name="file-text" [size]="24"></lucide-angular></span>
        <div class="metric-content">
          <span class="metric-label">Total de Registros</span>
          <span class="metric-value">{{ statistics.totalRegistros | number }}</span>
        </div>
      </div>

      <!-- Falta Reintentar -->
      <div class="metric-card">
        <span class="metric-icon"><lucide-angular name="refresh-cw" [size]="24"></lucide-angular></span>
        <div class="metric-content">
          <span class="metric-label">Falta Reintentar</span>
          <span class="metric-value">{{ statistics.faltaReintentar | number }}</span>
        </div>
      </div>

      <!-- Reintentos Completados -->
      <div class="metric-card">
        <span class="metric-icon"><lucide-angular name="check-circle" [size]="24"></lucide-angular></span>
        <div class="metric-content">
          <span class="metric-label">Reintentos Completados</span>
          <span class="metric-value">{{ statistics.reintentosCompletados | number }}</span>
        </div>
      </div>

      <!-- Falta Llamar -->
      <div class="metric-card">
        <span class="metric-icon"><lucide-angular name="phone-call" [size]="24"></lucide-angular></span>
        <div class="metric-content">
          <span class="metric-label">Falta Llamar</span>
          <span class="metric-value">{{ statistics.faltaLlamar | number }}</span>
        </div>
      </div>

      <!-- Duración Promedio Llamada -->
      <div class="metric-card">
        <span class="metric-icon"><lucide-angular name="clock" [size]="24"></lucide-angular></span>
        <div class="metric-content">
          <span class="metric-label">Duración Promedio Llamada</span>
          <span class="metric-value">{{ statistics.duracionPromedioLlamada }}</span>
        </div>
      </div>

      <!-- Duración Máxima Llamada -->
      <div class="metric-card">
        <span class="metric-icon"><lucide-angular name="timer" [size]="24"></lucide-angular></span>
        <div class="metric-content">
          <span class="metric-label">Duración Máxima Llamada</span>
          <span class="metric-value">{{ statistics.duracionMaximaLlamada }}</span>
        </div>
      </div>
        </div>
      </div>

      <!-- Back: Chart and Stats Table -->
      <div class="flip-card-back">
        <div class="chart-stats-container">
          <!-- Donut Chart -->
          <div class="chart-section">
            <h3>Distribución de Llamadas</h3>
            <div class="chart-wrapper">
              <canvas baseChart
                [data]="doughnutChartData"
                [type]="doughnutChartType"
                [options]="doughnutChartOptions">
              </canvas>
              <div class="chart-center-text">
                <div class="center-value">{{ statistics.totalLlamadas }}</div>
                <div class="center-label">Total</div>
              </div>
            </div>
          </div>

          <!-- Stats Table -->
          <div class="stats-table-section">
            <h3>Estado Llamadas</h3>
            <table class="stats-table">
              <thead>
                <tr>
                  <th>Estado</th>
                  <th>Cantidad</th>
                  <th>Porcentaje</th>
                </tr>
              </thead>
              <tbody>
                <tr [ngClass]="getRowClass(getPercentage(statistics.llamadasContestadas, statistics.totalLlamadas))">
                  <td><span class="color-dot" style="background-color: #10B981"></span> Contestadas</td>
                  <td>{{ statistics.llamadasContestadas | number }}</td>
                  <td>{{ getPercentage(statistics.llamadasContestadas, statistics.totalLlamadas) }}</td>
                </tr>
                <tr [ngClass]="getRowClass(getPercentage(statistics.llamadasCortas, statistics.totalLlamadas))">
                  <td><span class="color-dot" style="background-color: #F59E0B"></span> Cortas</td>
                  <td>{{ statistics.llamadasCortas | number }}</td>
                  <td>{{ getPercentage(statistics.llamadasCortas, statistics.totalLlamadas) }}</td>
                </tr>
                <tr [ngClass]="getRowClass(getPercentage(statistics.llamadasAbandonadas, statistics.totalLlamadas))">
                  <td><span class="color-dot" style="background-color: #EF4444"></span> Abandonadas</td>
                  <td>{{ statistics.llamadasAbandonadas | number }}</td>
                  <td>{{ getPercentage(statistics.llamadasAbandonadas, statistics.totalLlamadas) }}</td>
                </tr>
                <tr [ngClass]="getRowClass(getPercentage(statistics.llamadasNoContestadas, statistics.totalLlamadas))">
                  <td><span class="color-dot" style="background-color: #F97316"></span> No Responden</td>
                  <td>{{ statistics.llamadasNoContestadas | number }}</td>
                  <td>{{ getPercentage(statistics.llamadasNoContestadas, statistics.totalLlamadas) }}</td>
                </tr>
                <tr [ngClass]="getRowClass(getPercentage(statistics.llamadasBuzonVoz, statistics.totalLlamadas))">
                  <td><span class="color-dot" style="background-color: #3B82F6"></span> Buzón de Voz</td>
                  <td>{{ statistics.llamadasBuzonVoz | number }}</td>
                  <td>{{ getPercentage(statistics.llamadasBuzonVoz, statistics.totalLlamadas) }}</td>
                </tr>
                <tr [ngClass]="getRowClass(getPercentage(statistics.llamadasFallidas, statistics.totalLlamadas))">
                  <td><span class="color-dot" style="background-color: #6B7280"></span> Fallidas</td>
                  <td>{{ statistics.llamadasFallidas | number }}</td>
                  <td>{{ getPercentage(statistics.llamadasFallidas, statistics.totalLlamadas) }}</td>
                </tr>
                <tr [ngClass]="getRowClass(getPercentage(statistics.llamadasPausadas, statistics.totalLlamadas))">
                  <td><span class="color-dot" style="background-color: #94A3B8"></span> Pausadas</td>
                  <td>{{ statistics.llamadasPausadas | number }}</td>
                  <td>{{ getPercentage(statistics.llamadasPausadas, statistics.totalLlamadas) }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Calls History Table -->
  <div *ngIf="statistics" class="calls-section">
    <div class="table-header">
      <h3><lucide-angular name="phone-call" [size]="20"></lucide-angular> Registro de Llamadas</h3>

      <div class="table-controls">
        <!-- Page Size Selector -->
        <div class="page-size-control">
          <label>Mostrar</label>
          <select (change)="onPageSizeChange($event)" [value]="pageSize">
            <option *ngFor="let option of pageSizeOptions" [value]="option">{{ option }}</option>
          </select>
          <label>registros</label>
        </div>

        <!-- Search Box -->
        <div class="search-control">
          <label>Búsqueda:</label>
          <input
            type="text"
            [(ngModel)]="searchTerm"
            (keyup.enter)="onSearch()"
            placeholder="Buscar..."
            class="search-input">
          <button (click)="onSearch()" class="btn-search"><lucide-angular name="search" [size]="16"></lucide-angular></button>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="table-container">
      <table class="calls-table">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Teléfono</th>
            <th>Dato</th>
            <th>Estado</th>
            <th>Causa</th>
            <th>Duración</th>
            <th>Int.</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let call of calls">
            <td>{{ call.fecha | date: 'dd/MM/yyyy HH:mm' }}</td>
            <td>{{ call.telefono }}</td>
            <td>{{ call.dato }}</td>
            <td>
              <span class="estado-badge" [ngClass]="getEstadoClass(call.estado)">
                {{ getEstadoTexto(call.estado) }}
              </span>
            </td>
            <td>{{ call.causa || '-' }}</td>
            <td>{{ call.duracion }}</td>
            <td class="text-center">{{ call.intentos }}</td>
          </tr>
          <tr *ngIf="calls.length === 0">
            <td colspan="7" class="empty-row">
              <lucide-angular name="inbox" [size]="20"></lucide-angular> No hay llamadas registradas para esta campaña
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="pagination" *ngIf="totalPages > 0">
      <div class="pagination-info">
        Mostrando {{ (currentPage * pageSize) + 1 }} a
        {{ Math.min((currentPage + 1) * pageSize, totalElements) }} de
        {{ totalElements }} registros
      </div>

      <div class="pagination-controls">
        <button
          class="btn-page"
          [disabled]="currentPage === 0"
          (click)="onPageChange(currentPage - 1)">
          <lucide-angular name="arrow-left" [size]="16"></lucide-angular> Anterior
        </button>

        <button
          *ngFor="let page of getPageNumbers()"
          class="btn-page-number"
          [class.active]="page === currentPage"
          (click)="onPageChange(page)">
          {{ page + 1 }}
        </button>

        <button
          class="btn-page"
          [disabled]="currentPage === totalPages - 1"
          (click)="onPageChange(currentPage + 1)">
          Siguiente <lucide-angular name="arrow-right" [size]="16"></lucide-angular>
        </button>
      </div>
    </div>
  </div>
</div>
