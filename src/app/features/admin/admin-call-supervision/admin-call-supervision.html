<div class="supervision-page">
  <!-- Header con navegación -->
  <div class="page-header">
    <button class="back-btn" (click)="goBack()">
      <lucide-angular name="arrow-left" [size]="20"></lucide-angular>
      <span>Volver</span>
    </button>
    <div class="header-title">
      <lucide-angular name="radio" [size]="24"></lucide-angular>
      <h1>Supervisión en Vivo</h1>
    </div>
  </div>

  <!-- Loading -->
  @if (!call) {
    <div class="loading-state">
      <div class="loader">
        <div class="loader-ring"></div>
        <lucide-angular name="phone-call" [size]="28"></lucide-angular>
      </div>
      <p>Conectando con la llamada...</p>
    </div>
  }

  @if (call) {
    <div class="supervision-content">
      <!-- Panel principal de supervisión -->
      <div class="main-panel">
        <!-- Estado de conexión -->
        <div class="connection-status" [class]="'mode-' + currentMode">
          <div class="status-indicator">
            <div class="status-ring"></div>
            <lucide-angular [name]="getModeIcon()" [size]="32"></lucide-angular>
          </div>
          <div class="status-text">
            <span class="status-label">{{ getModeLabel() }}</span>
            <span class="status-description">{{ getModeDescription() }}</span>
          </div>
          <div class="call-timer">
            <lucide-angular name="timer" [size]="18"></lucide-angular>
            <span>{{ formatDuration(callDuration) }}</span>
          </div>
        </div>

        <!-- Información de la llamada -->
        <div class="call-participants">
          <div class="participant agent">
            <div class="participant-avatar">
              <lucide-angular name="headphones" [size]="24"></lucide-angular>
            </div>
            <div class="participant-info">
              <span class="participant-role">Agente</span>
              <span class="participant-name">{{ call.agentName }}</span>
              <span class="participant-detail">Ext. {{ call.agentExtension }}</span>
            </div>
            <div class="audio-indicator">
              <span class="audio-bar"></span>
              <span class="audio-bar"></span>
              <span class="audio-bar"></span>
            </div>
          </div>

          <div class="connection-line">
            <lucide-angular name="arrow-left-right" [size]="20"></lucide-angular>
          </div>

          <div class="participant client">
            <div class="participant-avatar">
              <lucide-angular name="user" [size]="24"></lucide-angular>
            </div>
            <div class="participant-info">
              <span class="participant-role">Cliente</span>
              <span class="participant-name">{{ call.clientNumber }}</span>
              <span class="participant-detail">{{ call.callState }}</span>
            </div>
            <div class="audio-indicator">
              <span class="audio-bar"></span>
              <span class="audio-bar"></span>
              <span class="audio-bar"></span>
            </div>
          </div>
        </div>

        <!-- Botones de modo -->
        <div class="mode-selector">
          <h3>Selecciona un modo de supervisión</h3>
          <div class="mode-buttons">
            <button
              class="mode-btn spy"
              [class.active]="currentMode === 'spy'"
              [class.disabled]="currentMode !== 'none' && currentMode !== 'spy'"
              [disabled]="isConnecting || (currentMode !== 'none' && currentMode !== 'spy')"
              (click)="startSpyMode()">
              <div class="mode-icon">
                <lucide-angular name="eye" [size]="28"></lucide-angular>
              </div>
              <div class="mode-info">
                <span class="mode-name">Vigía</span>
                <span class="mode-desc">Solo escuchar</span>
              </div>
              @if (currentMode === 'spy') {
                <div class="active-badge">
                  <lucide-angular name="check" [size]="14"></lucide-angular>
                  Activo
                </div>
              }
            </button>

            <button
              class="mode-btn whisper"
              [class.active]="currentMode === 'whisper'"
              [class.disabled]="currentMode !== 'none' && currentMode !== 'whisper'"
              [disabled]="isConnecting || (currentMode !== 'none' && currentMode !== 'whisper')"
              (click)="startWhisperMode()">
              <div class="mode-icon">
                <lucide-angular name="ear" [size]="28"></lucide-angular>
              </div>
              <div class="mode-info">
                <span class="mode-name">Susurro</span>
                <span class="mode-desc">Hablar al agente</span>
              </div>
              @if (currentMode === 'whisper') {
                <div class="active-badge">
                  <lucide-angular name="check" [size]="14"></lucide-angular>
                  Activo
                </div>
              }
            </button>

            <button
              class="mode-btn barge"
              [class.active]="currentMode === 'barge'"
              [class.disabled]="currentMode !== 'none' && currentMode !== 'barge'"
              [disabled]="isConnecting || (currentMode !== 'none' && currentMode !== 'barge')"
              (click)="startBargeMode()">
              <div class="mode-icon">
                <lucide-angular name="users" [size]="28"></lucide-angular>
              </div>
              <div class="mode-info">
                <span class="mode-name">Tripartita</span>
                <span class="mode-desc">Todos escuchan</span>
              </div>
              @if (currentMode === 'barge') {
                <div class="active-badge">
                  <lucide-angular name="check" [size]="14"></lucide-angular>
                  Activo
                </div>
              }
            </button>
          </div>
        </div>

        <!-- Estado de conexión -->
        @if (isConnecting) {
          <div class="connecting-overlay">
            <div class="connecting-content">
              <div class="connecting-spinner"></div>
              <span>Conectando al modo de supervisión...</span>
            </div>
          </div>
        }

        <!-- Controles activos -->
        @if (currentMode !== 'none') {
          <div class="active-controls">
            <button
              class="control-btn mute"
              [class.muted]="isMuted"
              (click)="toggleMute()">
              <lucide-angular [name]="isMuted ? 'mic-off' : 'mic'" [size]="22"></lucide-angular>
              <span>{{ isMuted ? 'Activar Mic' : 'Silenciar' }}</span>
            </button>

            <button
              class="control-btn disconnect"
              (click)="disconnectSupervision()">
              <lucide-angular name="phone-off" [size]="22"></lucide-angular>
              <span>Desconectar</span>
            </button>
          </div>
        }
      </div>

      <!-- Panel lateral de información -->
      <div class="info-panel">
        <div class="info-card">
          <h4>
            <lucide-angular name="info" [size]="18"></lucide-angular>
            Guía de Modos
          </h4>
          <div class="info-list">
            <div class="info-item">
              <div class="info-icon spy">
                <lucide-angular name="eye" [size]="16"></lucide-angular>
              </div>
              <div class="info-text">
                <strong>Vigía</strong>
                <p>Escuchas la conversación completa. Ni el agente ni el cliente pueden oírte.</p>
              </div>
            </div>
            <div class="info-item">
              <div class="info-icon whisper">
                <lucide-angular name="ear" [size]="16"></lucide-angular>
              </div>
              <div class="info-text">
                <strong>Susurro</strong>
                <p>Puedes hablar con el agente. El cliente no te escucha.</p>
              </div>
            </div>
            <div class="info-item">
              <div class="info-icon barge">
                <lucide-angular name="users" [size]="16"></lucide-angular>
              </div>
              <div class="info-text">
                <strong>Tripartita</strong>
                <p>Te unes a la llamada. Todos los participantes pueden escucharte.</p>
              </div>
            </div>
          </div>
        </div>

        @if (call.campaignName) {
          <div class="info-card campaign">
            <h4>
              <lucide-angular name="folder" [size]="18"></lucide-angular>
              Campaña
            </h4>
            <span class="campaign-name">{{ call.campaignName }}</span>
          </div>
        }
      </div>
    </div>
  }
</div>
