<div class="campaign-container">
  <!-- Header -->
  <div class="header">
    <h1>ğŸ“‹ GestiÃ³n de CampaÃ±as</h1>
    <div class="header-actions">
      <!-- Auto-Dialer Toggle Button -->
      <button
        [class]="'btn-action ' + getAutoDialerButtonClass()"
        (click)="toggleAutoDialer()"
        [disabled]="autoDialerLoading"
        [title]="isAutoDialerActive ? 'Pausar el sistema de discado automÃ¡tico' : 'Iniciar el sistema de discado automÃ¡tico'">
        <span>{{ getAutoDialerButtonIcon() }}</span>
        <span>{{ getAutoDialerButtonText() }}</span>
      </button>

      <!-- New Campaign Button -->
      <button class="btn-create" (click)="openCreateModal()">
        <span>â•</span>
        <span>Nueva CampaÃ±a</span>
      </button>
    </div>
  </div>

  <!-- Error / Success Messages -->
  <div *ngIf="error" class="error-message">âŒ {{ error }}</div>
  <div *ngIf="successMessage" class="success-message">âœ… {{ successMessage }}</div>

  <!-- Campaigns List Section -->
  <div class="campaigns-section">
    <h2 class="section-title">ğŸ“‹ CampaÃ±as</h2>

    <!-- Campaigns List -->
    <div class="campaigns-scrollable" *ngIf="!loading">
      <div *ngIf="campaigns.length === 0" class="empty-state">
        <p>ğŸ“­ No hay campaÃ±as creadas todavÃ­a</p>
        <button class="btn-create" (click)="openCreateModal()">Crear Primera CampaÃ±a</button>
      </div>

      <div *ngFor="let campaign of campaigns" class="campaign-card-compact">
        <div class="campaign-header-compact">
          <div class="campaign-title-compact" (click)="viewCampaignDetail(campaign)" style="cursor: pointer;">
            <h3>{{ campaign.name }}</h3>
            <span class="status-badge" [style.background-color]="getStatusColor(campaign.status)">
              {{ getStatusText(campaign.status) }}
            </span>
          </div>
          <div class="campaign-actions">
            <button
              class="btn-action-small btn-view"
              (click)="viewCampaignDetail(campaign)"
              title="Ver detalle">
              ğŸ‘ï¸
            </button>
            <button
              *ngIf="canActivate(campaign)"
              class="btn-action-small btn-activate"
              (click)="activarCampaign(campaign)"
              title="Activar campaÃ±a">
              â–¶ï¸
            </button>
            <button
              *ngIf="canPause(campaign)"
              class="btn-action-small btn-pause"
              (click)="pausarCampaign(campaign)"
              title="Pausar campaÃ±a">
              â¸ï¸
            </button>
            <button
              class="btn-action-small btn-import"
              (click)="openImportModal(campaign)"
              title="Importar contactos">
              ğŸ“¥
            </button>
            <button
              *ngIf="campaign.status === 'DRAFT' || campaign.status === 'COMPLETED'"
              class="btn-action-small btn-delete"
              (click)="deleteCampaign(campaign)"
              title="Eliminar campaÃ±a">
              ğŸ—‘ï¸
            </button>
          </div>
        </div>

        <div class="campaign-body-compact">
          <p *ngIf="campaign.description" class="campaign-description-compact">
            {{ campaign.description }}
          </p>

          <div class="campaign-stats-compact" *ngIf="campaign.totalContacts !== undefined">
            <div class="stat-compact">
              <span class="stat-label-compact">Total:</span>
              <span class="stat-value-compact">{{ campaign.totalContacts || 0 }}</span>
            </div>
            <div class="stat-compact">
              <span class="stat-label-compact">Pendientes:</span>
              <span class="stat-value-compact">{{ campaign.pendingContacts || 0 }}</span>
            </div>
            <div class="stat-compact">
              <span class="stat-label-compact">Contactados:</span>
              <span class="stat-value-compact">{{ campaign.contactedContacts || 0 }}</span>
            </div>
          </div>

          <div class="campaign-meta-compact">
            <span>{{ campaign.dialMode }}</span>
            <span>Max: {{ campaign.maxAttempts }}</span>
            <span *ngIf="campaign.createdAt">{{ campaign.createdAt | date: 'short' }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="loading-state">
      <div class="spinner"></div>
      <p>Cargando...</p>
    </div>
  </div>
</div>

<!-- Create Campaign Modal -->
<div *ngIf="showCreateModal" class="modal-overlay" (click)="closeCreateModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>â• Nueva CampaÃ±a</h2>
      <button class="btn-close" (click)="closeCreateModal()">âœ–</button>
    </div>

    <div class="modal-body">
      <div class="form-group">
        <label>Nombre de la CampaÃ±a *</label>
        <input
          type="text"
          [(ngModel)]="newCampaign.name"
          placeholder="Ej: CampaÃ±a Cobranza Enero 2025"
          class="form-input"
          required>
      </div>

      <div class="form-group">
        <label>DescripciÃ³n</label>
        <textarea
          [(ngModel)]="newCampaign.description"
          placeholder="DescripciÃ³n de la campaÃ±a..."
          class="form-textarea"
          rows="3"></textarea>
      </div>

      <!-- Selectores en cascada: Inquilino â†’ Cartera â†’ Subcartera -->
      <div class="form-row">
        <div class="form-group">
          <label>Proveedor (Inquilino) *</label>
          <select [(ngModel)]="selectedTenantId" (ngModelChange)="onTenantChange()" class="form-select" required>
            <option [ngValue]="0">Seleccione un proveedor...</option>
            <option *ngFor="let tenant of tenants" [ngValue]="tenant.id">
              {{ tenant.tenantCode }} - {{ tenant.tenantName }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label>Cartera *</label>
          <select [(ngModel)]="selectedPortfolioId" (ngModelChange)="onPortfolioChange()"
                  [disabled]="selectedTenantId === 0" class="form-select" required>
            <option [ngValue]="0">Seleccione una cartera...</option>
            <option *ngFor="let portfolio of portfolios" [ngValue]="portfolio.id">
              {{ portfolio.portfolioCode }} - {{ portfolio.portfolioName }}
            </option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label>Subcartera *</label>
        <select [(ngModel)]="selectedSubPortfolioId"
                [disabled]="selectedPortfolioId === 0" class="form-select" required>
          <option [ngValue]="0">Seleccione una subcartera...</option>
          <option *ngFor="let sp of subPortfolios" [ngValue]="sp.id">
            {{ sp.subPortfolioCode }} - {{ sp.subPortfolioName }}
          </option>
        </select>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Modo de Discado</label>
          <select [(ngModel)]="newCampaign.dialMode" class="form-select">
            <option value="MANUAL">Manual</option>
            <option value="PROGRESSIVE">Progresivo</option>
            <option value="PREDICTIVE">Predictivo</option>
          </select>
        </div>

        <div class="form-group">
          <label>Intentos MÃ¡ximos</label>
          <input
            type="number"
            [(ngModel)]="newCampaign.maxAttempts"
            class="form-input"
            min="1"
            max="10">
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeCreateModal()">Cancelar</button>
      <button class="btn-submit" (click)="createCampaign()">Crear CampaÃ±a</button>
    </div>
  </div>
</div>

<!-- Import Contacts Modal -->
<div *ngIf="showImportModal" class="modal-overlay" (click)="closeImportModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>ğŸ“¥ Importar Contactos</h2>
      <button class="btn-close" (click)="closeImportModal()">âœ–</button>
    </div>

    <div class="modal-body">
      <p><strong>CampaÃ±a:</strong> {{ selectedCampaign?.name }}</p>

      <div class="info-box">
        <p>â„¹ï¸ Los contactos se importarÃ¡n desde: <strong>{{ importStats?.fuenteDatos || 'cashi_db.clientes' }}</strong></p>
        <p>ğŸ“Š Clientes disponibles: <strong>{{ importStats?.totalClientes || 0 }}</strong></p>
        <p>ğŸ“ Inquilino: <strong>{{ importStats?.inquilino }}</strong></p>
        <p>ğŸ“‚ Cartera: <strong>{{ importStats?.cartera }}</strong></p>
        <p>ğŸ“ Subcartera: <strong>{{ importStats?.subcartera }}</strong></p>
      </div>

      <div class="alert alert-info">
        âš ï¸ Se importarÃ¡n <strong>TODOS</strong> los clientes de esta cartera/subcartera automÃ¡ticamente.
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeImportModal()">Cancelar</button>
      <button class="btn-submit" (click)="importarContactos()">Importar</button>
    </div>
  </div>
</div>
