<div class="campaign-container">
  <!-- Header -->
  <div class="header">
    <h1>üìã Gesti√≥n de Campa√±as</h1>
    <div class="header-actions">
      <!-- Auto-Dialer Toggle Button -->
      <button
        [class]="'btn-action ' + getAutoDialerButtonClass()"
        (click)="toggleAutoDialer()"
        [disabled]="autoDialerLoading"
        [title]="isAutoDialerActive ? 'Pausar el sistema de discado autom√°tico' : 'Iniciar el sistema de discado autom√°tico'">
        <span>{{ getAutoDialerButtonIcon() }}</span>
        <span>{{ getAutoDialerButtonText() }}</span>
      </button>

      <!-- New Campaign Button -->
      <button class="btn-create" (click)="openCreateModal()">
        <span>‚ûï</span>
        <span>Nueva Campa√±a</span>
      </button>
    </div>
  </div>

  <!-- Error / Success Messages -->
  <div *ngIf="error" class="error-message">‚ùå {{ error }}</div>
  <div *ngIf="successMessage" class="success-message">‚úÖ {{ successMessage }}</div>

  <!-- Main Content: Two Columns Layout -->
  <div class="two-column-layout">
    <!-- LEFT COLUMN: Campaigns List -->
    <div class="left-column">
      <h2 class="section-title">üìã Campa√±as</h2>

      <!-- Campaigns List -->
      <div class="campaigns-scrollable" *ngIf="!loading">
        <div *ngIf="campaigns.length === 0" class="empty-state">
          <p>üì≠ No hay campa√±as creadas todav√≠a</p>
          <button class="btn-create" (click)="openCreateModal()">Crear Primera Campa√±a</button>
        </div>

        <div *ngFor="let campaign of campaigns" class="campaign-card-compact">
          <div class="campaign-header-compact">
            <div class="campaign-title-compact">
              <h3>{{ campaign.name }}</h3>
              <span class="status-badge" [style.background-color]="getStatusColor(campaign.status)">
                {{ getStatusText(campaign.status) }}
              </span>
            </div>
            <div class="campaign-actions">
              <button
                *ngIf="canActivate(campaign)"
                class="btn-action-small btn-activate"
                (click)="activarCampaign(campaign)"
                title="Activar campa√±a">
                ‚ñ∂Ô∏è
              </button>
              <button
                *ngIf="canPause(campaign)"
                class="btn-action-small btn-pause"
                (click)="pausarCampaign(campaign)"
                title="Pausar campa√±a">
                ‚è∏Ô∏è
              </button>
              <button
                class="btn-action-small btn-import"
                (click)="openImportModal(campaign)"
                title="Importar contactos">
                üì•
              </button>
              <button
                *ngIf="campaign.status === 'DRAFT' || campaign.status === 'COMPLETED'"
                class="btn-action-small btn-delete"
                (click)="deleteCampaign(campaign)"
                title="Eliminar campa√±a">
                üóëÔ∏è
              </button>
            </div>
          </div>

          <div class="campaign-body-compact">
            <p *ngIf="campaign.description" class="campaign-description-compact">
              {{ campaign.description }}
            </p>

            <div class="campaign-stats-compact" *ngIf="campaign.totalContacts !== undefined">
              <div class="stat-compact">
                <span class="stat-label-compact">Total:</span>
                <span class="stat-value-compact">{{ campaign.totalContacts || 0 }}</span>
              </div>
              <div class="stat-compact">
                <span class="stat-label-compact">Pendientes:</span>
                <span class="stat-value-compact">{{ campaign.pendingContacts || 0 }}</span>
              </div>
              <div class="stat-compact">
                <span class="stat-label-compact">Contactados:</span>
                <span class="stat-value-compact">{{ campaign.contactedContacts || 0 }}</span>
              </div>
            </div>

            <div class="campaign-meta-compact">
              <span>{{ campaign.dialMode }}</span>
              <span>Max: {{ campaign.maxAttempts }}</span>
              <span *ngIf="campaign.createdAt">{{ campaign.createdAt | date: 'short' }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div *ngIf="loading" class="loading-state">
        <div class="spinner"></div>
        <p>Cargando...</p>
      </div>
    </div>

    <!-- RIGHT COLUMN: Metrics and Future Content -->
    <div class="right-column">
      <!-- Auto-Dialer Metrics -->
  <div class="metrics-panel" *ngIf="autoDialerStats">
    <h3>üìä M√©tricas del Auto-Dialer en Tiempo Real</h3>
    <div class="metrics-grid">
      <!-- Total llamadas -->
      <div class="metric-item">
        <span class="metric-icon">üìä</span>
        <div class="metric-info">
          <span class="metric-value">{{ autoDialerStats.totalLlamadas }}</span>
          <span class="metric-label">Total llamadas</span>
        </div>
      </div>

      <!-- Llamadas en cola -->
      <div class="metric-item">
        <span class="metric-icon">‚è≥</span>
        <div class="metric-info">
          <span class="metric-value">{{ autoDialerStats.llamadasEnCola }}</span>
          <span class="metric-label">Llamadas en cola</span>
        </div>
      </div>

      <!-- Llamadas conectadas -->
      <div class="metric-item">
        <span class="metric-icon">‚úÖ</span>
        <div class="metric-info">
          <span class="metric-value">{{ autoDialerStats.llamadasConectadas }}</span>
          <span class="metric-label">Llamadas conectadas</span>
        </div>
      </div>

      <!-- Llamadas por realizar (contactos pendientes) -->
      <div class="metric-item">
        <span class="metric-icon">üìã</span>
        <div class="metric-info">
          <span class="metric-value">{{ autoDialerStats.contactosPendientes }}</span>
          <span class="metric-label">Llamadas por realizar</span>
        </div>
      </div>

      <!-- Llamadas siendo marcadas -->
      <div class="metric-item">
        <span class="metric-icon">üìû</span>
        <div class="metric-info">
          <span class="metric-value">{{ autoDialerStats.llamadasMarcando }}</span>
          <span class="metric-label">Llamadas siendo marcadas</span>
        </div>
      </div>

      <!-- Llamadas activas (en curso) -->
      <div class="metric-item">
        <span class="metric-icon">üîµ</span>
        <div class="metric-info">
          <span class="metric-value">{{ autoDialerStats.llamadasActivas }}</span>
          <span class="metric-label">Llamadas siendo procesadas</span>
        </div>
      </div>

      <!-- Llamadas fallidas -->
      <div class="metric-item">
        <span class="metric-icon">‚ùå</span>
        <div class="metric-info">
          <span class="metric-value">{{ autoDialerStats.contactosFallidos }}</span>
          <span class="metric-label">Llamadas fallidas</span>
        </div>
      </div>

      <!-- Llamadas no contestadas -->
      <div class="metric-item">
        <span class="metric-icon">üìµ</span>
        <div class="metric-info">
          <span class="metric-value">{{ autoDialerStats.llamadasNoContestadas }}</span>
          <span class="metric-label">Llamadas no contestadas</span>
        </div>
      </div>

      <!-- Llamadas abandonadas -->
      <div class="metric-item">
        <span class="metric-icon">üö´</span>
        <div class="metric-info">
          <span class="metric-value">{{ autoDialerStats.llamadasAbandonadas }}</span>
          <span class="metric-label">Llamadas abandonadas</span>
        </div>
      </div>

      <!-- Duraci√≥n promedio -->
      <div class="metric-item">
        <span class="metric-icon">‚è±Ô∏è</span>
        <div class="metric-info">
          <span class="metric-value">{{ autoDialerStats.duracionPromedioFormato }}</span>
          <span class="metric-label">Duraci√≥n promedio de llamada</span>
        </div>
      </div>

      <!-- Duraci√≥n m√°xima -->
      <div class="metric-item">
        <span class="metric-icon">‚è∞</span>
        <div class="metric-info">
          <span class="metric-value">{{ autoDialerStats.duracionMaximaFormato }}</span>
          <span class="metric-label">Duraci√≥n m√°xima de llamada</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Agentes en Tiempo Real -->
  <div class="agentes-panel">
    <h3>üë• Agentes en Tiempo Real</h3>
    <div class="agentes-table-container">
      <table class="agentes-table">
        <thead>
          <tr>
            <th>Agente</th>
            <th>Estado</th>
            <th>Tel√©fono</th>
            <th>Desde</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let agente of agentesMonitoreo" class="agente-row">
            <td class="agente-info">
              <div class="agente-extension">SIP/{{ agente.sipExtension }}</div>
              <div class="agente-nombre">{{ agente.nombreCompleto }}</div>
            </td>
            <td class="agente-estado">
              <span class="estado-badge" [style.background-color]="getEstadoColor(agente.estadoActual)">
                {{ getEstadoIcon(agente.estadoActual) }} {{ getEstadoTexto(agente.estadoActual) }}
              </span>
            </td>
            <td class="agente-telefono">
              {{ agente.telefonoDestino || '-' }}
            </td>
            <td class="agente-tiempo">
              {{ formatTiempo(agente.segundosEnEstado) }}
            </td>
          </tr>
          <tr *ngIf="agentesMonitoreo.length === 0" class="empty-row">
            <td colspan="4" style="text-align: center; color: #94a3b8;">
              No hay agentes registrados
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
    </div>
  </div>
</div>

<!-- Create Campaign Modal -->
<div *ngIf="showCreateModal" class="modal-overlay" (click)="closeCreateModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>‚ûï Nueva Campa√±a</h2>
      <button class="btn-close" (click)="closeCreateModal()">‚úñ</button>
    </div>

    <div class="modal-body">
      <div class="form-group">
        <label>Nombre de la Campa√±a *</label>
        <input
          type="text"
          [(ngModel)]="newCampaign.name"
          placeholder="Ej: Campa√±a Cobranza Enero 2025"
          class="form-input"
          required>
      </div>

      <div class="form-group">
        <label>Descripci√≥n</label>
        <textarea
          [(ngModel)]="newCampaign.description"
          placeholder="Descripci√≥n de la campa√±a..."
          class="form-textarea"
          rows="3"></textarea>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Modo de Discado</label>
          <select [(ngModel)]="newCampaign.dialMode" class="form-select">
            <option value="MANUAL">Manual</option>
            <option value="PROGRESSIVE">Progresivo</option>
            <option value="PREDICTIVE">Predictivo</option>
          </select>
        </div>

        <div class="form-group">
          <label>Intentos M√°ximos</label>
          <input
            type="number"
            [(ngModel)]="newCampaign.maxAttempts"
            class="form-input"
            min="1"
            max="10">
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeCreateModal()">Cancelar</button>
      <button class="btn-submit" (click)="createCampaign()">Crear Campa√±a</button>
    </div>
  </div>
</div>

<!-- Import Contacts Modal -->
<div *ngIf="showImportModal" class="modal-overlay" (click)="closeImportModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>üì• Importar Contactos</h2>
      <button class="btn-close" (click)="closeImportModal()">‚úñ</button>
    </div>

    <div class="modal-body">
      <p><strong>Campa√±a:</strong> {{ selectedCampaign?.name }}</p>

      <div class="form-group">
        <label>L√≠mite de Contactos a Importar</label>
        <input
          type="number"
          [(ngModel)]="importLimit"
          class="form-input"
          min="1"
          max="10000"
          placeholder="100">
        <small>Se importar√°n hasta {{ importLimit }} contactos desde la tabla externa</small>
      </div>

      <div class="info-box">
        <p>‚ÑπÔ∏è Los contactos se importar√°n desde: <strong>{{ importStats?.fuenteDatos }}</strong></p>
        <p>üìä Disponibles: <strong>{{ importStats?.totalTelefonosActivos }}</strong> tel√©fonos activos</p>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeImportModal()">Cancelar</button>
      <button class="btn-submit" (click)="importarContactos()">Importar</button>
    </div>
  </div>
</div>
