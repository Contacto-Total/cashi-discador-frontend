<div class="campaign-container">
  <!-- Header estilo monitoring -->
  <div class="page-header">
    <div class="header-left">
      <div class="header-icon-box">
        <lucide-angular name="megaphone" [size]="22"></lucide-angular>
      </div>
      <div class="header-text">
        <h1>Gestión de Campañas</h1>
        <p>Administración y configuración de campañas de marcación</p>
      </div>
    </div>
    <div class="header-right">
      <div class="stat-badge" [class.active]="campaigns.length > 0">
        <span class="stat-number">{{ campaigns.length }}</span>
        <span class="stat-label">Campañas</span>
      </div>
      <button class="btn-create" routerLink="/admin/campaigns/new">
        <lucide-angular name="plus-circle" [size]="18"></lucide-angular>
        <span>Nueva Campaña</span>
      </button>
    </div>
  </div>

  <!-- Error / Success Messages -->
  <div *ngIf="error" class="error-message"><lucide-angular name="x-circle" [size]="18"></lucide-angular> {{ error }}</div>
  <div *ngIf="successMessage" class="success-message"><lucide-angular name="check-circle" [size]="18"></lucide-angular> {{ successMessage }}</div>

  <!-- Campaigns List Section -->
  <div class="campaigns-section">
    <!-- Campaigns List -->
    <div class="campaigns-scrollable" *ngIf="!loading">
      <div *ngIf="campaigns.length === 0" class="empty-state">
        <p><lucide-angular name="inbox" [size]="20"></lucide-angular> No hay campañas creadas todavía</p>
        <button class="btn-create" (click)="openCreateModal()">Crear Primera Campaña</button>
      </div>

      <div *ngFor="let campaign of campaigns; let i = index"
           class="campaign-card"
           [class.is-active]="campaign.status === 'ACTIVE'"
           [class.is-dialing]="campaign.estaDiscando"
           [style.animation-delay]="(i * 60) + 'ms'">

        <!-- Left accent bar -->
        <div class="card-accent" [style.background]="getStatusColor(campaign.status)"></div>

        <div class="card-content">
          <!-- Row 1: Title + Status + Actions -->
          <div class="card-top">
            <div class="card-title-row" (click)="viewCampaignDetail(campaign)" style="cursor: pointer;">
              <h3>{{ campaign.name }}</h3>
              <span class="status-badge" [style.background-color]="getStatusColor(campaign.status)">
                {{ getStatusText(campaign.status) }}
              </span>
              <span *ngIf="campaign.estaDiscando" class="dialing-indicator">
                <span class="pulse-dot"></span> Discando
              </span>
            </div>
            <div class="card-actions">
              <button class="btn-action-small btn-view" (click)="viewCampaignDetail(campaign)" title="Ver detalle">
                <lucide-angular name="eye" [size]="15"></lucide-angular>
              </button>
              <button class="btn-action-small btn-edit" [routerLink]="['/admin/campaigns', campaign.id, 'edit']" title="Editar">
                <lucide-angular name="pencil" [size]="15"></lucide-angular>
              </button>
              <button *ngIf="canActivate(campaign)" class="btn-action-small btn-activate" (click)="activarCampaign(campaign)" title="Activar">
                <lucide-angular name="play" [size]="15"></lucide-angular>
              </button>
              <button *ngIf="canPause(campaign)" class="btn-action-small btn-pause" (click)="pausarCampaign(campaign)" title="Pausar">
                <lucide-angular name="pause" [size]="15"></lucide-angular>
              </button>
              <button class="btn-action-small btn-import" (click)="openImportModal(campaign)" title="Importar contactos">
                <lucide-angular name="download" [size]="15"></lucide-angular>
              </button>
              <button *ngIf="campaign.status === 'ACTIVE'"
                [class]="campaign.estaDiscando ? 'btn-action-small btn-pause' : 'btn-action-small btn-activate'"
                (click)="toggleDialing(campaign)"
                [title]="campaign.estaDiscando ? 'Detener Discado' : 'Iniciar Discado'">
                <lucide-angular *ngIf="campaign.estaDiscando" name="square" [size]="15"></lucide-angular>
                <lucide-angular *ngIf="!campaign.estaDiscando" name="phone-call" [size]="15"></lucide-angular>
              </button>
              <button *ngIf="campaign.status !== 'ACTIVE'" class="btn-action-small btn-delete" (click)="deleteCampaign(campaign)" title="Eliminar">
                <lucide-angular name="trash-2" [size]="15"></lucide-angular>
              </button>
            </div>
          </div>

          <!-- Row 2: Description (optional) -->
          <p *ngIf="campaign.description" class="card-description">{{ campaign.description }}</p>

          <!-- Row 3: Stats + Meta -->
          <div class="card-bottom">
            <div class="card-stats" *ngIf="campaign.totalContacts !== undefined">
              <div class="stat-pill">
                <span class="stat-pill-value">{{ campaign.totalContacts || 0 }}</span>
                <span class="stat-pill-label">Total</span>
              </div>
              <div class="stat-pill stat-pending">
                <span class="stat-pill-value">{{ campaign.pendingContacts || 0 }}</span>
                <span class="stat-pill-label">Pend.</span>
              </div>
              <div class="stat-pill stat-contacted">
                <span class="stat-pill-value">{{ campaign.contactedContacts || 0 }}</span>
                <span class="stat-pill-label">Contact.</span>
              </div>
            </div>
            <div class="card-meta">
              <span class="meta-tag">{{ campaign.dialMode }}</span>
              <span class="meta-tag">Max: {{ campaign.maxAttempts }}</span>
              <span class="meta-tag">Int: {{ campaign.intensidad || 50 }}</span>
              <span class="meta-tag meta-date" *ngIf="campaign.createdAt">{{ campaign.createdAt | date: 'short' }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="loading-state">
      <div class="spinner"></div>
      <p>Cargando...</p>
    </div>
  </div>
</div>

<!-- Create Campaign Modal -->
<div *ngIf="showCreateModal" class="modal-overlay" (click)="closeCreateModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2><lucide-angular name="plus-circle" [size]="20"></lucide-angular> Nueva Campaña</h2>
      <button class="btn-close" (click)="closeCreateModal()"><lucide-angular name="x" [size]="18"></lucide-angular></button>
    </div>

    <div class="modal-body">
      <div class="form-group">
        <label>Nombre de la Campaña *</label>
        <input
          type="text"
          [(ngModel)]="newCampaign.name"
          placeholder="Ej: Campaña Cobranza Enero 2025"
          class="form-input"
          required>
      </div>

      <div class="form-group">
        <label>Descripción</label>
        <textarea
          [(ngModel)]="newCampaign.description"
          placeholder="Descripción de la campaña..."
          class="form-textarea"
          rows="3"></textarea>
      </div>

      <!-- Selectores en cascada: Inquilino → Cartera → Subcartera -->
      <div class="form-row">
        <div class="form-group">
          <label>Proveedor (Inquilino) *</label>
          <select [(ngModel)]="selectedTenantId" (ngModelChange)="onTenantChange()" class="form-select" required>
            <option [ngValue]="0">Seleccione un proveedor...</option>
            <option *ngFor="let tenant of tenants" [ngValue]="tenant.id">
              {{ tenant.tenantCode }} - {{ tenant.tenantName }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label>Cartera *</label>
          <select [(ngModel)]="selectedPortfolioId" (ngModelChange)="onPortfolioChange()"
                  [disabled]="selectedTenantId === 0" class="form-select" required>
            <option [ngValue]="0">Seleccione una cartera...</option>
            <option *ngFor="let portfolio of portfolios" [ngValue]="portfolio.id">
              {{ portfolio.portfolioCode }} - {{ portfolio.portfolioName }}
            </option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label>Subcartera *</label>
        <select [(ngModel)]="selectedSubPortfolioId"
                [disabled]="selectedPortfolioId === 0" class="form-select" required>
          <option [ngValue]="0">Seleccione una subcartera...</option>
          <option *ngFor="let sp of subPortfolios" [ngValue]="sp.id">
            {{ sp.subPortfolioCode }} - {{ sp.subPortfolioName }}
          </option>
        </select>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Modo de Discado</label>
          <select [(ngModel)]="newCampaign.dialMode" class="form-select">
            <option value="MANUAL">Manual</option>
            <option value="PROGRESSIVE">Progresivo</option>
            <option value="PREDICTIVE">Predictivo</option>
          </select>
        </div>

        <div class="form-group">
          <label>Intentos Máximos</label>
          <input
            type="number"
            [(ngModel)]="newCampaign.maxAttempts"
            class="form-input"
            min="1"
            max="10">
        </div>
      </div>

      <div class="form-group">
        <label>Intensidad de Discado (1-100)</label>
        <input
          type="number"
          [(ngModel)]="newCampaign.intensidad"
          class="form-input"
          min="1"
          max="100"
          placeholder="50">
        <small style="color: #666;">Número de llamadas simultáneas por agente. Ejemplo: 50 con 10 agentes = 5 llamadas por agente.</small>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeCreateModal()">Cancelar</button>
      <button class="btn-submit" (click)="createCampaign()">Crear Campaña</button>
    </div>
  </div>
</div>

<!-- Import Contacts Modal -->
<div *ngIf="showImportModal" class="modal-overlay" (click)="closeImportModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2><lucide-angular name="download" [size]="20"></lucide-angular> Importar Contactos</h2>
      <button class="btn-close" (click)="closeImportModal()"><lucide-angular name="x" [size]="18"></lucide-angular></button>
    </div>

    <div class="modal-body">
      <p><strong>Campaña:</strong> {{ selectedCampaign?.name }}</p>

      <div class="info-box">
        <p><lucide-angular name="info" [size]="16"></lucide-angular> Los contactos se importarán desde: <strong>{{ importStats?.fuenteDatos || 'cashi_db.clientes' }}</strong></p>
        <p><lucide-angular name="bar-chart-2" [size]="16"></lucide-angular> Clientes disponibles: <strong>{{ importStats?.totalClientes || 0 }}</strong></p>
        <p><lucide-angular name="building-2" [size]="16"></lucide-angular> Inquilino: <strong>{{ importStats?.inquilino }}</strong></p>
        <p><lucide-angular name="folder" [size]="16"></lucide-angular> Cartera: <strong>{{ importStats?.cartera }}</strong></p>
        <p><lucide-angular name="folder-open" [size]="16"></lucide-angular> Subcartera: <strong>{{ importStats?.subcartera }}</strong></p>
      </div>

      <div class="alert alert-info">
        <lucide-angular name="alert-triangle" [size]="16"></lucide-angular> Se importarán <strong>TODOS</strong> los clientes de esta cartera/subcartera automáticamente.
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeImportModal()">Cancelar</button>
      <button class="btn-submit" (click)="importarContactos()">Importar</button>
    </div>
  </div>
</div>
