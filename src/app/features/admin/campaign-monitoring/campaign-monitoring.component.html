<div class="monitoring-container">
  <!-- Header estilo monitoring -->
  <div class="page-header">
    <div class="header-left">
      <div class="header-icon-box">
        <lucide-angular name="activity" [size]="22"></lucide-angular>
      </div>
      <div class="header-text">
        <h1>Monitoreo por Campaña</h1>
        <p>Métricas del auto-dialer en tiempo real</p>
      </div>
    </div>
    <div class="header-right">
      <button
        class="btn-sound"
        [class.active]="soundEnabled"
        (click)="toggleSound()"
        [title]="soundEnabled ? 'Desactivar sonido de alertas' : 'Activar sonido de alertas'">
        <lucide-angular [name]="soundEnabled ? 'volume-2' : 'volume-x'" [size]="18"></lucide-angular>
        <span>{{ soundEnabled ? 'ON' : 'OFF' }}</span>
      </button>
      <button class="btn-back" (click)="goBack()">
        <lucide-angular name="arrow-left" [size]="16"></lucide-angular>
        <span>Volver</span>
      </button>
    </div>
  </div>

  <!-- Campaign Selector -->
  <div class="campaign-selector">
    <label for="campaignSelect">Seleccionar Campaña:</label>
    <select
      id="campaignSelect"
      [(ngModel)]="selectedCampaignId"
      (change)="onCampaignChange()"
      class="campaign-select">
      <option [value]="null" disabled>-- Seleccione una campaña --</option>
      <option
        *ngFor="let campaign of campaigns"
        [value]="campaign.id">
        {{ campaign.name }} ({{ campaign.status }})
      </option>
    </select>
  </div>

  <!-- Metrics: Tiempo Real -->
  <div class="metrics-panel" *ngIf="autoDialerStats">
    <h3><lucide-angular name="activity" [size]="20"></lucide-angular> Actividad en Tiempo Real</h3>
    <div class="metrics-grid metrics-grid-realtime">
      <div class="metric-item metric-realtime">
        <span class="metric-icon icon-cola"><lucide-angular name="clock" [size]="24"></lucide-angular></span>
        <div class="metric-info">
          <span class="metric-value">{{ autoDialerStats.llamadasEnCola }}</span>
          <span class="metric-label">En cola</span>
        </div>
      </div>
      <div class="metric-item metric-realtime">
        <span class="metric-icon icon-marcando"><lucide-angular name="phone-call" [size]="24"></lucide-angular></span>
        <div class="metric-info">
          <span class="metric-value">{{ autoDialerStats.llamadasMarcando }}</span>
          <span class="metric-label">Marcando</span>
        </div>
      </div>
      <div class="metric-item metric-realtime">
        <span class="metric-icon icon-conectadas"><lucide-angular name="check-circle" [size]="24"></lucide-angular></span>
        <div class="metric-info">
          <span class="metric-value">{{ autoDialerStats.llamadasConectadas }}</span>
          <span class="metric-label">Conectadas</span>
        </div>
      </div>
      <div class="metric-item metric-realtime">
        <span class="metric-icon icon-activas"><lucide-angular name="activity" [size]="24"></lucide-angular></span>
        <div class="metric-info">
          <span class="metric-value">{{ autoDialerStats.llamadasActivas }}</span>
          <span class="metric-label">En curso</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Metrics: Resumen de Campaña -->
  <div class="metrics-panel" *ngIf="autoDialerStats">
    <h3><lucide-angular name="bar-chart-2" [size]="20"></lucide-angular> Resumen de Campaña</h3>
    <div class="metrics-grid">
      <div class="metric-item">
        <span class="metric-icon"><lucide-angular name="bar-chart-2" [size]="24"></lucide-angular></span>
        <div class="metric-info">
          <span class="metric-value">{{ autoDialerStats.totalLlamadas }}</span>
          <span class="metric-label">Total llamadas</span>
        </div>
      </div>
      <div class="metric-item">
        <span class="metric-icon icon-conectadas-asesor"><lucide-angular name="user-check" [size]="24"></lucide-angular></span>
        <div class="metric-info">
          <span class="metric-value">{{ autoDialerStats.llamadasConectadasConAsesor }}</span>
          <span class="metric-label">Conectadas con asesor</span>
        </div>
      </div>
      <div class="metric-item">
        <span class="metric-icon icon-sin-asesor"><lucide-angular name="user-x" [size]="24"></lucide-angular></span>
        <div class="metric-info">
          <span class="metric-value">{{ autoDialerStats.llamadasFinalizadasSinAsesor }}</span>
          <span class="metric-label">Finalizadas sin asesor</span>
        </div>
      </div>
      <div class="metric-item">
        <span class="metric-icon icon-no-contestadas"><lucide-angular name="phone-missed" [size]="24"></lucide-angular></span>
        <div class="metric-info">
          <span class="metric-value">{{ autoDialerStats.llamadasNoContestadas }}</span>
          <span class="metric-label">No contestadas</span>
        </div>
      </div>
      <div class="metric-item">
        <span class="metric-icon icon-abandonadas"><lucide-angular name="phone-off" [size]="24"></lucide-angular></span>
        <div class="metric-info">
          <span class="metric-value">{{ autoDialerStats.llamadasAbandonadas }}</span>
          <span class="metric-label">Abandonadas</span>
        </div>
      </div>
      <div class="metric-item">
        <span class="metric-icon icon-pendientes"><lucide-angular name="clipboard-list" [size]="24"></lucide-angular></span>
        <div class="metric-info">
          <span class="metric-value">{{ autoDialerStats.contactosPendientes }}</span>
          <span class="metric-label">Contactos pendientes</span>
        </div>
      </div>
      <div class="metric-item">
        <span class="metric-icon icon-invalidos"><lucide-angular name="x-circle" [size]="24"></lucide-angular></span>
        <div class="metric-info">
          <span class="metric-value">{{ autoDialerStats.contactosFallidos }}</span>
          <span class="metric-label">Contactos inválidos</span>
        </div>
      </div>
      <div class="metric-item">
        <span class="metric-icon"><lucide-angular name="clock" [size]="24"></lucide-angular></span>
        <div class="metric-info">
          <span class="metric-value">{{ autoDialerStats.duracionPromedioFormato }}</span>
          <span class="metric-label">Duración promedio</span>
        </div>
      </div>
      <div class="metric-item">
        <span class="metric-icon"><lucide-angular name="timer" [size]="24"></lucide-angular></span>
        <div class="metric-info">
          <span class="metric-value">{{ autoDialerStats.duracionMaximaFormato }}</span>
          <span class="metric-label">Duración máxima</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Two Column Layout: Discado en Tiempo Real + Agentes -->
  <div class="two-column-layout">
    <!-- LEFT COLUMN: Discado en Tiempo Real -->
    <div class="left-column">
      <div class="discado-panel">
        <h3><lucide-angular name="phone-call" [size]="20"></lucide-angular> Discado en Tiempo Real</h3>
        <div class="discado-table-container">
          <table class="discado-table">
            <thead>
              <tr>
                <th>Hora</th>
                <th>Teléfono</th>
                <th>Asesor</th>
                <th>Estado</th>
                <th>Duración</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let llamada of llamadasEnTiempoReal; trackBy: trackByLlamada" class="llamada-row">
                <td class="llamada-hora">{{ llamada.fechaInicio | date: 'HH:mm:ss' }}</td>
                <td class="llamada-telefono">{{ llamada.anexoDestino }}</td>
                <td class="llamada-agente">{{ llamada.nombreAgente }}</td>
                <td class="llamada-estado">
                  <span class="estado-badge-mini">{{ llamada.estadoLlamada }}</span>
                </td>
                <td class="llamada-duracion">{{ formatTiempo(llamada.duracionSegundos) }}</td>
              </tr>
              <tr *ngIf="llamadasEnTiempoReal.length === 0" class="empty-row">
                <td colspan="5" style="text-align: center; color: #94a3b8;">
                  No hay llamadas en curso
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- RIGHT COLUMN: Asesores en Tiempo Real -->
    <div class="right-column">
      <div class="agentes-panel">
        <div class="agentes-header">
          <h3><lucide-angular name="users" [size]="20"></lucide-angular> Asesores en Tiempo Real</h3>
          <button class="btn-view-all" (click)="navigateToExtensions()">
            <lucide-angular name="phone" [size]="16"></lucide-angular> Ver Extensiones
          </button>
        </div>
        <div class="agentes-table-container">
          <table class="agentes-table">
            <thead>
              <tr>
                <th>Asesor</th>
                <th>Estado</th>
                <th>Teléfono</th>
                <th>Tiempo</th>
                <th style="width: 50px; text-align: center;">Alerta</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let agente of agentesMonitoreo; trackBy: trackByAgente" class="agente-row clickable-row"
                  [class.alert-row]="agente.excedeTiempoMaximo"
                  (click)="openChangeStatusModal(agente)"
                  title="Click para cambiar estado">
                <td class="agente-info">
                  <div class="agente-extension">SIP/{{ agente.sipExtension }}</div>
                  <div class="agente-nombre">{{ agente.nombreCompleto }}</div>
                </td>
                <td class="agente-estado">
                  <span class="estado-badge" [style.background-color]="getEstadoColor(agente.estadoActual)">
                    <lucide-angular [name]="getEstadoIcon(agente.estadoActual)" [size]="14"></lucide-angular> {{ getEstadoTexto(agente.estadoActual) }}
                  </span>
                </td>
                <td class="agente-telefono">
                  {{ agente.telefonoDestino || '-' }}
                </td>
                <td class="agente-tiempo">
                  {{ formatTiempo(agente.segundosEnEstado) }}
                </td>
                <td class="agente-alerta" style="text-align: center;">
                  <app-status-alarm-clock
                    [color]="agente.colorIndicador"
                    [excedido]="agente.excedeTiempoMaximo"
                    [size]="20"
                    [tooltip]="agente.mensajeAlerta || ''">
                  </app-status-alarm-clock>
                </td>
              </tr>
              <tr *ngIf="agentesMonitoreo.length === 0" class="empty-row">
                <td colspan="5" style="text-align: center; color: #94a3b8;">
                  No hay agentes registrados
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Alerta de Agente -->
<div class="alert-overlay" *ngIf="alertaActiva" (click)="onOverlayClick($event)">
  <div class="alert-modal">
    <button class="alert-close" (click)="dismissAlert()">
      <lucide-angular name="x" [size]="20"></lucide-angular>
    </button>

    <div class="alert-header">
      <div class="alert-icon-container">
        <lucide-angular name="alert-triangle" [size]="32" class="alert-icon"></lucide-angular>
      </div>
      <h3>Alerta de Agente</h3>
    </div>

    <div class="alert-body">
      <div class="alert-agent-info">
        <div class="agent-avatar">
          <lucide-angular name="user" [size]="24"></lucide-angular>
        </div>
        <div class="agent-details">
          <span class="agent-name">{{ alertaActiva.agente.nombreCompleto }}</span>
          <span class="agent-extension">SIP/{{ alertaActiva.agente.sipExtension }}</span>
        </div>
      </div>

      <div class="alert-status">
        <span class="status-label">Estado:</span>
        <span class="status-badge" [style.background-color]="getEstadoColor(alertaActiva.agente.estadoActual)">
          {{ getEstadoTexto(alertaActiva.agente.estadoActual) }}
        </span>
      </div>

      <div class="alert-time">
        <lucide-angular name="clock" [size]="18"></lucide-angular>
        <span>Tiempo en estado: <strong>{{ formatTiempo(alertaActiva.agente.segundosEnEstado) }}</strong></span>
      </div>

      <div class="alert-message">
        <lucide-angular name="alert-circle" [size]="18"></lucide-angular>
        <span>{{ alertaActiva.agente.mensajeAlerta }}</span>
      </div>
    </div>

    <div class="alert-footer">
      <button class="btn-dismiss" (click)="dismissAlert()">
        <span class="btn-dismiss-progress" [style.width.%]="alertProgress"></span>
        <span class="btn-dismiss-content">
          <lucide-angular name="check" [size]="18" class="btn-dismiss-icon"></lucide-angular>
          <span class="btn-dismiss-label">Entendido</span>
          <span class="btn-dismiss-timer">{{ alertRemainingTime | number:'1.0-0' }}s</span>
        </span>
      </button>
    </div>
  </div>
</div>

<!-- Modal de Cambio de Estado de Agente -->
<div class="status-modal-overlay" *ngIf="showChangeStatusModal" (click)="onStatusModalOverlayClick($event)">
  <div class="status-modal">
    <button class="status-modal-close" (click)="closeChangeStatusModal()">
      <lucide-angular name="x" [size]="20"></lucide-angular>
    </button>

    <div class="status-modal-header">
      <lucide-angular name="user-cog" [size]="24" class="status-modal-icon"></lucide-angular>
      <h3>Cambiar Estado</h3>
    </div>

    <div class="status-modal-agent" *ngIf="selectedAgentForStatusChange">
      <div class="agent-avatar-large">
        <lucide-angular name="user" [size]="28"></lucide-angular>
      </div>
      <div class="agent-details-large">
        <span class="agent-name-large">{{ selectedAgentForStatusChange.nombreCompleto }}</span>
        <span class="agent-extension-large">SIP/{{ selectedAgentForStatusChange.sipExtension }}</span>
      </div>
    </div>

    <div class="status-current" *ngIf="selectedAgentForStatusChange">
      <span class="status-current-label">Estado actual:</span>
      <span class="status-current-badge" [style.background-color]="getEstadoColor(selectedAgentForStatusChange.estadoActual)">
        <lucide-angular [name]="getEstadoIcon(selectedAgentForStatusChange.estadoActual)" [size]="14"></lucide-angular>
        {{ getEstadoTexto(selectedAgentForStatusChange.estadoActual) }}
      </span>
    </div>

    <div class="status-options">
      <button
        *ngFor="let estado of estadosDisponibles"
        class="status-option-btn"
        [class.current]="isCurrentStatus(estado.value)"
        [class.disabled]="changingStatus"
        [style.--estado-color]="estado.color"
        (click)="changeAgentStatus(estado.value)"
        [disabled]="changingStatus">
        <lucide-angular [name]="estado.icon" [size]="18"></lucide-angular>
        <span>{{ estado.label }}</span>
        <lucide-angular name="check" [size]="16" class="check-icon" *ngIf="isCurrentStatus(estado.value)"></lucide-angular>
      </button>
    </div>

    <div class="status-modal-loading" *ngIf="changingStatus">
      <lucide-angular name="loader" [size]="20" class="spin"></lucide-angular>
      <span>Cambiando estado...</span>
    </div>
  </div>
</div>
