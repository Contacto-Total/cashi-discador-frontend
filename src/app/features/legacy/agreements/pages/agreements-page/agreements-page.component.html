<div class="payment-agreement-container">
  <!-- Header -->
  <div class="flex items-center gap-2 mb-3">
    <div class="w-8 h-8 bg-gradient-to-br from-blue-600 to-purple-700 rounded-lg flex items-center justify-center">
      <lucide-angular name="file-text" [size]="16" class="text-white"></lucide-angular>
    </div>
    <div>
      <h1 class="text-lg font-bold text-slate-900 dark:text-white">Generador de Acuerdo de Pago</h1>
      <p class="text-xs text-slate-600 dark:text-slate-400">Creaci√≥n de acuerdos de pago para clientes</p>
    </div>
  </div>

  <!-- Barra de opciones -->
  <div class="document-header">
    <!-- B√∫squeda DNI -->
    <form [formGroup]="searchForm" class="flex gap-2 items-center">
      <input
        formControlName="dniBusqueda"
        type="text"
        placeholder="DNI"
        class="h-10 w-[120px] px-3 text-sm border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-white placeholder:text-slate-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors"
        maxlength="8" />
      <button
        type="button"
        class="h-10 px-4 text-sm font-medium text-white bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 rounded-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
        (click)="buscarPorDni()"
        [disabled]="searchForm.invalid">
        Buscar
      </button>
      <div *ngIf="tramoDetectado" class="ml-2 px-3 py-1 bg-green-50 border border-green-500 rounded text-sm font-bold text-green-700">
        Tramo: {{ tramoDetectado }}
      </div>
      <div *ngIf="tramoDetectado" class="ml-2 px-3 py-1 rounded text-sm font-bold"
           [class.bg-blue-50]="selectedEntidad === 'financiera_oh'"
           [class.border-blue-500]="selectedEntidad === 'financiera_oh'"
           [class.text-blue-700]="selectedEntidad === 'financiera_oh'"
           [class.bg-purple-50]="selectedEntidad === 'nsoluciones'"
           [class.border-purple-500]="selectedEntidad === 'nsoluciones'"
           [class.text-purple-700]="selectedEntidad === 'nsoluciones'"
           [class.border]="true">
        Plantilla: {{ selectedEntidad === 'financiera_oh' ? 'Financiera Oh' : 'NSoluciones' }}
      </div>
      <span *ngIf="isLoading" class="spinner"></span>
    </form>

    <!-- Botones de acci√≥n -->
    <div class="document-actions">
      <button
        type="button"
        class="h-10 px-4 text-sm font-medium text-white bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 rounded-lg transition-all duration-200"
        (click)="resetForm()">
        Limpiar
      </button>
      <button
        type="button"
        class="h-10 px-4 text-sm font-medium text-white bg-gradient-to-r from-blue-600 to-purple-700 hover:from-blue-700 hover:to-purple-800 rounded-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
        (click)="onSubmit()"
        [disabled]="agreementForm.invalid || isLoading">
        {{ isLoading ? 'Generando...' : 'Generar PDF' }}
      </button>
    </div>
  </div>

  <!-- Placeholder cuando no hay DNI buscado -->
  <div *ngIf="!mostrarDocumento" class="document-container">
    <div class="flex flex-col items-center justify-center py-20 px-8 rounded-lg shadow-sm"
         [class.bg-white]="!isDarkMode"
         [class.bg-slate-800]="isDarkMode">
      <div class="w-24 h-24 bg-gradient-to-br from-blue-600 to-purple-700 rounded-full flex items-center justify-center mb-6 shadow-lg">
        <lucide-angular name="search" [size]="48" style="color: white;"></lucide-angular>
      </div>
      <h3 class="text-xl font-bold mb-2"
          [class.text-slate-900]="!isDarkMode"
          [class.text-white]="isDarkMode">
        Busca un cliente para comenzar
      </h3>
      <p class="text-sm text-center max-w-md"
         [class.text-slate-600]="!isDarkMode"
         [class.text-slate-400]="isDarkMode">
        Ingresa el DNI del cliente en el buscador para cargar autom√°ticamente los datos y generar el acuerdo de pago.
      </p>
    </div>
  </div>

  <!-- Documento con inputs incrustados -->
  <div *ngIf="mostrarDocumento" class="document-container">
    <form [formGroup]="agreementForm" class="document bg-white text-black">
        <!-- Header con logos -->
        <div class="header">
          <div class="logo-section">
            <div class="logo-left">
              <div class="logo-placeholder">LOGO 1</div>
            </div>
            <div class="logo-right">
              <div class="logo-placeholder">LOGO 2</div>
            </div>
          </div>
        </div>

        <!-- L√≠nea debajo de los logos -->
        <div class="line"></div>

        <!-- Fecha -->
        <div class="date-location">
          <div class="date-input-container">
            <input 
              type="date" 
              formControlName="fechaActual"
              class="editable-input date-input"
              [class.is-invalid]="isFieldInvalid('fechaActual')">

            <div class="formatted-date" *ngIf="agreementForm.get('fechaActual')?.value">
              {{ formatDisplayDate(agreementForm.get('fechaActual')?.value) }}
            </div>
          </div>
          <div class="error-message" *ngIf="isFieldInvalid('fechaActual')">
            {{ getFieldError('fechaActual') }}
          </div>
        </div>

        <div class="red-header text-white"
             [class.bg-[#d32f2f]]="selectedEntidad === 'financiera_oh'"
             [class.bg-black]="selectedEntidad === 'nsoluciones'">
          <ng-container *ngIf="selectedEntidad === 'financiera_oh'">
            ACUERDO DE PAGO - CAMPA√ëA LIMPIA TU DEUDA
          </ng-container>
          <ng-container *ngIf="selectedEntidad === 'nsoluciones'">
            ACUERDO DE PAGO - CANCELACI√ìN TOTAL
          </ng-container>
        </div>

        <table class="client-table bg-white text-black">
          <tr>
            <td class="label-cell bg-[#f8f9fa] text-black">NOMBRE DEL TITULAR</td>
            <td class="highlight input-cell bg-white text-black">
              <input
                type="text"
                formControlName="nombreTitular"
                class="editable-input large-input readonly-input"
                readonly
                placeholder="JUAN CARLOS PEREZ GARCIA">
            </td>
          </tr>
          <tr>
            <td class="label-cell bg-[#f8f9fa] text-black">NUMERO DNI</td>
            <td class="highlight input-cell bg-white text-black">
              <input
                type="text"
                formControlName="dni"
                class="editable-input readonly-input"
                readonly
                placeholder="12345678">
            </td>
          </tr>
          <tr>
            <td class="label-cell bg-[#f8f9fa] text-black">Nro. CUENTA TARJETA Oh!</td>
            <td class="highlight input-cell bg-white text-black">
              <input
                type="text"
                formControlName="cuentaTarjeta"
                class="editable-input large-input readonly-input"
                readonly
                placeholder="1234567890123456">
            </td>
          </tr>
        </table>

        <div class="congratulations text-black">
          ¬°Felicitaciones!, ya se encuentra <strong>APROBADO</strong> su <strong>CAMPA√ëA ESPECIAL</strong> con el cual estar√≠a cancelando <strong>TODA SU DEUDA</strong>, lo puede pagar desde el d√≠a de hoy, se encontrar√° habilitado hasta este:
        </div>

        <div class="date-highlight text-black">
          <div class="date-input-container">
            <input
              type="date"
              formControlName="fechaCompromiso"
              class="editable-input date-input"
              [class.is-invalid]="isFieldInvalid('fechaCompromiso')"
              [readonly]="isFechaCompromisoReadonly">

            <div class="formatted-date" *ngIf="agreementForm.get('fechaCompromiso')?.value">
              {{ formatDisplayDate(agreementForm.get('fechaCompromiso')?.value) }}
              <span *ngIf="formasDePagoArray.length > 0" style="font-size: 0.8em; color: #666; margin-left: 5px;">
                (Fecha del 1er pago)
              </span>
            </div>
          </div>
          <div class="error-message" *ngIf="isFieldInvalid('fechaCompromiso')">
            {{ getFieldError('fechaCompromiso') }}
          </div>
        </div>

        <div class="debt-header text-white"
             [class.bg-[#d32f2f]]="selectedEntidad === 'financiera_oh'"
             [class.bg-black]="selectedEntidad === 'nsoluciones'">
          DETALLE DE DEUDA Y PROMOCI√ìN APROBADA
        </div>

        <table class="debt-table bg-white text-black">
          <tr>
            <th class="bg-white text-black">DEUDA TOTAL</th>
            <th class="bg-white text-black">DESCUENTO</th>
            <th class="bg-white text-black">MONTO APROBADO</th>
          </tr>
          <tr>
            <td class="amount bg-white text-black">
              <div class="amount-input-container">
                S/ <input
                    type="number"
                    formControlName="deudaTotal"
                    class="editable-input number-input readonly-input"
                    [class.blackout]="isBlackoutMode"
                    readonly
                    step="0.01"
                    min="0">
              </div>
            </td>

            <td class="amount bg-white text-black">
              <div class="amount-input-container">
                S/ <input
                    type="number"
                    formControlName="descuento"
                    class="editable-input number-input"
                    [class.blackout]="isBlackoutMode"
                    readonly>
              </div>
            </td>

            <td class="highlight-amount bg-yellow-300 text-black">
              <div class="amount-input-container">
                S/ <input 
                      type="number" 
                      formControlName="montoAprobado"
                      class="editable-input number-input"
                      step="1"
                      min="0"
                      (input)="calculateDiscount()"
                      [class.is-invalid]="isFieldInvalid('montoAprobado')">
                <button 
                  type="button" 
                  class="btn-toggle-debt"
                  [class.active]="isBlackoutMode"
                  (click)="toggleBlackoutMode()"
                  [title]="getToggleTitle()">
                  {{ getToggleIcon() }}
                </button>
              </div>
            </td>
          </tr>
          
          <!-- Secci√≥n de formas de pago -->
          <tr>
            <td colspan="3" class="payment-header-clean">
              <div class="payment-header-container">
                <span class="payment-title">Formas de pago</span>
                <button type="button" class="btn btn-success btn-sm" (click)="addFormaPago()">+ Agregar</button>
              </div>
            </td>
          </tr>
          
          <!-- Opciones de pago din√°micas -->
          <ng-container formArrayName="formasDePago">
            <tr *ngFor="let forma of formasDePagoArray.controls; let i = index" [formGroupName]="i">
              <!-- Columna con botones y detalles del pago -->
              <td class="payment-row" colspan="3">
                <div class="payment-row-content">
                  <!-- Primero la informaci√≥n del pago -->
                  <div class="payment-info">
                    <strong>{{ i + 1 }}{{ getOrdinalSuffix(i + 1) }} PAGO</strong> ‚Äî 
                    {{ forma.get('fechaPago')?.value }} ‚Äî 
                    S/ {{ forma.get('montoPago')?.value }} SOLES
                  </div>
                  
                  <!-- Despu√©s los botones -->
                  <div class="payment-actions">
                    <button type="button" class="btn btn-outline-primary btn-sm" (click)="abrirEditorFormaPago(i)">Editar</button>
                    <button type="button" class="btn btn-outline-danger btn-sm" [disabled]="formasDePagoArray.length <= 1" (click)="removeFormaPago(i)">Eliminar</button>
                  </div>
                </div>
              </td>
            </tr>
          </ng-container>

          <!-- Observaci√≥n √∫nica (solo se muestra si existe) -->
          <tr *ngIf="mostrarObservacion">
            <td colspan="3" class="payment-observation-unique">
              <div class="observation-header">Observaci√≥n:</div>
              <div class="observation-content">{{ observacionTexto }}</div>
            </td>
          </tr>
          
          <!-- Mensaje cuando no hay formas de pago -->
          <tr *ngIf="formasDePagoArray.length === 0">
            <td colspan="3" class="payment-section">
              <em>No hay formas de pago definidas.</em>
            </td>
          </tr>
        </table>

        <div class="instructions text-black">
          <ng-container *ngIf="selectedEntidad === 'financiera_oh'">
            Acercarse con su DNI, tarjeta Oh! y este documento; Indicar en los cajeros que va a realizar un <strong>pago o abono</strong> a su Tarjeta Oh por el monto <strong>APROBADO</strong>, en caso de no tener la tarjeta puede pagar con el n√∫mero de cuenta de su tarjeta consignada en la parte superior de este documento.
          </ng-container>
          <ng-container *ngIf="selectedEntidad === 'nsoluciones'">
            Acercarse a cualquier agencia o Agente BCP, realice el pago al N√∫mero de cuenta corriente BCP Soles: 1931851985017 <br>
            El N√∫mero de cuenta interbancaria es 00219300185198501718. Una vez realizado el dep√≥sito enviar el voucher de pago n√∫mero telefonico 915326798 para iniciar el tramite de la Carta de no adeudo.
          </ng-container>
        </div>

        <div class="section-header bg-[#e0e0e0] text-black">CENTROS DE PAGO VIRTUAL:</div>
        <div class="section-content text-black">
          <div class="centers-content">
            <div class="bcp-logo">BCP</div>
            <div class="center">APP/WEB</div>
            <div class="dni text-black">
              <ng-container *ngIf="selectedEntidad === 'financiera_oh'">
                Con su n√∫mero de DNI
              </ng-container>
              <ng-container *ngIf="selectedEntidad === 'nsoluciones'">
                NUMERO DE CUENTA CORRIENTE - 1931851985017
              </ng-container>
            </div>
          </div>
        </div>

        <div class="section-header bg-[#e0e0e0] text-black">CENTROS DE PAGO PRESENCIAL :</div>
        <div class="section-content text-black">
          <div class="centers-content">
            <div class="bcp-logo">BCP</div>
            <div class="center">AGENTE/VENTANILLA</div>
            <div class="dni text-black">
              <ng-container *ngIf="selectedEntidad === 'financiera_oh'">
                Presentando su DNI
              </ng-container>
              <ng-container *ngIf="selectedEntidad === 'nsoluciones'">
                NUMERO DE CUENTA CORRIENTE - 1931851985017
              </ng-container>
            </div>
          </div>
        </div>

        <div class="section-header bg-[#e0e0e0] text-black">CONFIRMACI√ìN DE PAGO:</div>
        <div class="section-content text-black">
          <ng-container *ngIf="selectedEntidad === 'financiera_oh'">
            Enviar foto del voucher de transacci√≥n al WhatsApp corporativo de Financiera Oh para su validaci√≥n, registro, cancelaci√≥n de deuda y retiro de cobranza.
          </ng-container>
          <ng-container *ngIf="selectedEntidad === 'nsoluciones'">
            Enviar foto del v√≥ucher de transacci√≥n al WhatsApp corporativo de NSOLUCIONES para su validaci√≥n, registro, cancelaci√≥n de deuda y retiro de cobranza.
          </ng-container>
        </div>

        <div class="section-header bg-[#e0e0e0] text-black">TRAMITE DE CARTA DE NO ADEUDO:</div>
        <div class="section-content text-black">
          <ng-container *ngIf="selectedEntidad === 'financiera_oh'">
            A partir de 15 d√≠as h√°biles de la cancelaci√≥n ya puede solicitar el tr√°mite su carta de no adeudo escribiendo al <strong>WhatsApp: 980732405 - OPCION 2</strong> o llamando al (01) 619-4800; (01) 631-5400; para que lo pueda recoger en plataforma o solicitar el env√≠o a su correo.
          </ng-container>
          <ng-container *ngIf="selectedEntidad === 'nsoluciones'">
            A partir de 24 HORAS posterior al pago ya podr√° solicitar el tr√°mite su carta de no adeudo escribiendo al WhatsApp: 915326798 para coordinar el env√≠o  a su correo.
          </ng-container>
        </div>

        <div class="contact-info text-black">
          <ng-container *ngIf="selectedEntidad === 'financiera_oh'">
            Si desea mayor informaci√≥n, comun√≠quese a los siguientes n√∫meros de contacto directo: V√≠a Telf.: o v√≠a WhatsApp: <strong>968437436</strong>
          </ng-container>
          <ng-container *ngIf="selectedEntidad === 'nsoluciones'">
            Si desea mayor informaci√≥n, comun√≠quese a los siguientes n√∫meros de contacto directo: V√≠a Telf.: o v√≠a WhatsApp: <strong>915257493</strong>
          </ng-container>
        </div>

        <!-- Secci√≥n de firma -->
        <div class="signature-section text-black">
          <div class="signature-left text-black">
            <span>Atentamente,</span>
          </div>
          <div class="signature-center text-black">
            <ng-container *ngIf="selectedEntidad === 'financiera_oh'">
              <div class="logo-placeholder small">LOGO BCP</div>
              <div style="text-align: center; padding: 10px;">
                <strong>Romina Tapia Albinagorta &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dpto.</strong><br />
                <strong>COBRANZAS Oh!</strong>
              </div>
            </ng-container>
            <ng-container *ngIf="selectedEntidad === 'nsoluciones'">
              <div class="logo-placeholder small">FIRMA</div>
              <div style="text-align: center; padding: 10px;">
                <strong>Emily Dayana Saenz Martinez</strong><br />
                <strong>NSOLUCIONES CONSULTING S.A.C</strong>
              </div>
            </ng-container>
          </div>
          <div class="signature-right">
            <div class="logo-placeholder small">COMPROMISO</div>
          </div>
        </div>

        <div class="footer-notes">
          <p>(*) Si al recibir esta comunicaci√≥n Ud. Ha cancelado o regularizado su deuda, por favor desestimar su contenido.</p>
          <p>(*) Para acceder a las facilidades deber√° estar incluida en la relaci√≥n de cuentas pre -aprobado.</p>
          <p>(*) Sujeto a variaci√≥n, por negativa a facilidad.</p>
        </div>
      </form>

    <!--Modal-->
    <div class="modal-backdrop" *ngIf="formaPagoSeleccionadaIndex !== null">
      <div class="modal-dialog enhanced" cdkDrag>
        <div class="modal-header" cdkDragHandle>
          <h3>Editar forma de pago</h3>
          <button (click)="cerrarEditor()" class="close-btn">√ó</button>
        </div>

        <div class="modal-body" [formGroup]="formaPagoTemporal">
          <div class="modal-field">
            <label for="fechaPago">üìÖ Fecha del pago</label>
            <input 
              type="date" 
              formControlName="fechaPago" 
              id="fechaPago"
              class="editable-input date-input" />
          </div>

          <div class="modal-field">
            <label for="montoPago">üí∞ Monto (S/)</label>
            <input 
              type="number" 
              formControlName="montoPago" 
              step="0.01" 
              min="0"
              id="montoPago"
              class="editable-input number-input" />
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="cerrarEditor()">Cancelar</button>
          <button class="btn btn-primary" (click)="guardarEdicionFormaPago()">Guardar</button>
        </div>
      </div>
    </div>

  </div>

  </div>

  <!-- Toast Container -->
  <div class="toast-container">
    <div *ngFor="let toast of toasts"
         class="toast"
         [ngClass]="toast.type">
      <span class="toast-icon">{{ toast.icon }}</span>
      <div class="toast-content">{{ toast.message }}</div>
      <button class="toast-close" (click)="removeToast(toast.id)">√ó</button>
    </div>
  </div>