<!-- Modal Overlay -->
<div class="fixed inset-0 bg-black/60 dark:bg-black/70 backdrop-blur-sm z-[999] animate-fade-in" (click)="close()"></div>

<!-- Modal Container - Más compacto -->
<div class="fixed inset-0 z-[1000] flex items-center justify-center p-4 pointer-events-none">
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 w-full max-w-5xl max-h-[90vh] flex flex-col overflow-hidden animate-scale-in pointer-events-auto">

    <!-- Modal Header - Compacto -->
    <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200 dark:border-gray-700 bg-gradient-to-r from-blue-600 to-violet-600">
      <div class="flex items-center gap-3 flex-1 min-w-0">
        <h2 class="text-lg font-bold text-white truncate">{{ combo.name }}</h2>
        <select [formControl]="form.controls.tramo" class="px-2 py-1 border-0 rounded-md bg-white/20 text-white text-sm font-medium cursor-pointer focus:outline-none focus:ring-2 focus:ring-white/50 backdrop-blur-sm">
          <option value="3" class="text-gray-900">Tramo 3</option>
          <option value="5" class="text-gray-900">Tramo 5</option>
          <option value="CONTACTO_TOTAL" class="text-gray-900">Cartera Propia</option>
        </select>
      </div>
      <button (click)="close()" class="p-1.5 hover:bg-white/20 rounded-lg text-white transition-colors cursor-pointer flex-shrink-0">
        <lucide-angular [img]="X" [size]="20"></lucide-angular>
      </button>
    </div>

    <!-- Modal Body - Layout optimizado -->
    <form [formGroup]="form" class="flex-1 overflow-y-auto">
      <div class="grid grid-cols-[1fr_340px] divide-x divide-gray-200 dark:divide-gray-700 h-full">

        <!-- Columna izquierda: Nombre + Tabs -->
        <div class="flex flex-col">
          <!-- Nombre del tenor -->
          <div class="p-3 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50">
            <input type="text" formControlName="nombre" class="w-full px-3 py-1.5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-blue-500 dark:focus:border-blue-400 transition-all shadow-sm" placeholder="Nombre del tenor">
          </div>

          <!-- Tabs Navigation - Compacto -->
          <div class="flex border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50">
            <button type="button" class="flex-1 flex items-center justify-center gap-1 px-3 py-2 text-xs font-medium transition-all cursor-pointer border-b-2"
              [class]="activeTab() === 'variables'
                ? 'border-blue-600 dark:border-blue-400 text-blue-600 dark:text-blue-400 bg-white dark:bg-gray-800'
                : 'border-transparent text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700'"
              (click)="activeTab.set('variables')">
              <lucide-angular [img]="Settings" [size]="14"></lucide-angular>
              Variables
            </button>
            <button type="button" class="flex-1 flex items-center justify-center gap-1 px-3 py-2 text-xs font-medium transition-all cursor-pointer border-b-2"
              [class]="activeTab() === 'rangos'
                ? 'border-blue-600 dark:border-blue-400 text-blue-600 dark:text-blue-400 bg-white dark:bg-gray-800'
                : 'border-transparent text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700'"
              (click)="activeTab.set('rangos')">
              <lucide-angular [img]="Filter" [size]="14"></lucide-angular>
              Rangos
            </button>
            <button type="button" class="flex-1 flex items-center justify-center gap-1 px-3 py-2 text-xs font-medium transition-all cursor-pointer border-b-2"
              [class]="activeTab() === 'condiciones'
                ? 'border-blue-600 dark:border-blue-400 text-blue-600 dark:text-blue-400 bg-white dark:bg-gray-800'
                : 'border-transparent text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700'"
              (click)="activeTab.set('condiciones')">
              <lucide-angular [img]="ListChecks" [size]="14"></lucide-angular>
              Condiciones
            </button>
            <button type="button" class="flex-1 flex items-center justify-center gap-1 px-3 py-2 text-xs font-medium transition-all cursor-pointer border-b-2"
              [class]="activeTab() === 'restricciones'
                ? 'border-blue-600 dark:border-blue-400 text-blue-600 dark:text-blue-400 bg-white dark:bg-gray-800'
                : 'border-transparent text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700'"
              (click)="activeTab.set('restricciones')">
              <lucide-angular [img]="Ban" [size]="14"></lucide-angular>
              Restricciones
            </button>
          </div>

          <!-- Tab Content - Scrollable -->
          <div class="flex-1 overflow-y-auto p-3 bg-white dark:bg-gray-900">

              <!-- Tab Content: Variables -->
              <div *ngIf="activeTab() === 'variables'" class="animate-fade-in">
                <div class="space-y-2">
                  <ng-container *ngFor="let g of chipGroups">
                    <div class="border-b border-gray-200 dark:border-gray-700 pb-2 last:border-0 last:pb-0">
                      <div class="text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1.5">{{ g.title }}</div>
                      <div class="flex flex-wrap gap-1.5">
                        <button
                          *ngFor="let c of g.items"
                          type="button"
                          [class]="isActive(c.key)
                            ? 'px-2.5 py-1 rounded-md text-white text-[11px] font-bold bg-gradient-to-r from-blue-600 to-violet-600 hover:from-blue-700 hover:to-violet-700 shadow-sm transition-all cursor-pointer'
                            : 'px-2.5 py-1 rounded-md text-gray-700 dark:text-gray-300 text-[11px] font-semibold bg-white dark:bg-gray-700 hover:bg-blue-50 dark:hover:bg-gray-600 hover:text-blue-700 dark:hover:text-blue-300 border border-gray-300 dark:border-gray-600 hover:border-blue-400 dark:hover:border-blue-500 transition-all cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed'"
                          (click)="toggleChip(c.key, c.affectsSelects !== false)"
                          [disabled]="isChipDisabled(c.key)">
                          {{ c.label }}
                        </button>
                      </div>
                    </div>
                  </ng-container>
                </div>

                <!-- Importe Extra - Inline compacto -->
                <div *ngIf="selectedChips.has('LTD') || selectedChips.has('LTDE') || selectedChips.has('LTD_LTDE')" class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700">
                  <div class="flex items-center gap-2">
                    <label class="text-xs font-semibold text-gray-700 dark:text-gray-300">Sumar:</label>
                    <input type="number" min="0" step="1" formControlName="importeExtra" class="w-20 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 dark:focus:ring-blue-400 transition-all" placeholder="0">
                  </div>
                </div>
              </div>

              <!-- Tab Content: Rangos -->
              <div *ngIf="activeTab() === 'rangos'" class="animate-fade-in">
                <button type="button" class="w-full flex items-center justify-center gap-1.5 px-3 py-1.5 bg-gradient-to-r from-blue-600 to-violet-600 hover:from-blue-700 hover:to-violet-700 text-white rounded-lg text-xs font-medium transition-all shadow-sm cursor-pointer mb-2" (click)="addRange()">
                  <lucide-angular [img]="Plus" [size]="14"></lucide-angular>
                  Añadir rango
                </button>

                <div class="space-y-2">
                  <div class="bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-lg p-2" *ngFor="let rg of rangosFA.controls; let i = index" [formGroup]="$any(rg)">
                    <div class="flex items-center gap-2 mb-2">
                      <select class="flex-1 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-xs cursor-pointer focus:outline-none focus:ring-1 focus:ring-blue-500" formControlName="field">
                        <option *ngFor="let f of rangeFields" [value]="f.key">{{ f.label }}</option>
                      </select>
                      <button type="button" class="p-1 bg-red-50 dark:bg-red-900/30 border border-red-300 dark:border-red-700 rounded-md text-red-700 dark:text-red-300 hover:bg-red-100 dark:hover:bg-red-900/50 transition-all cursor-pointer" (click)="removeRange(i)">
                        <lucide-angular [img]="Trash2" [size]="12"></lucide-angular>
                      </button>
                    </div>

                    <!-- Modo intervalo -->
                    <div *ngIf="$any(rg).get('useMin')?.value && $any(rg).get('useMax')?.value" class="flex items-center gap-1.5 flex-wrap text-xs">
                      <input type="number" class="w-16 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-xs" formControlName="min" placeholder="mín">
                      <label class="flex items-center gap-0.5 cursor-pointer">
                        <input type="checkbox" class="w-3 h-3" formControlName="inclusiveMin">
                        <span class="font-bold text-gray-700 dark:text-gray-300">{{ $any(rg).get('inclusiveMin')?.value ? '≤' : '<' }}</span>
                      </label>
                      <span class="px-2 py-0.5 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded text-[10px] font-bold">{{ fieldLabel($any(rg).get('field')?.value) }}</span>
                      <label class="flex items-center gap-0.5 cursor-pointer">
                        <input type="checkbox" class="w-3 h-3" formControlName="inclusiveMax">
                        <span class="font-bold text-gray-700 dark:text-gray-300">{{ $any(rg).get('inclusiveMax')?.value ? '≤' : '<' }}</span>
                      </label>
                      <input type="number" class="w-16 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-xs" formControlName="max" placeholder="máx">
                    </div>

                    <!-- Modo simple -->
                    <div *ngIf="!($any(rg).get('useMin')?.value && $any(rg).get('useMax')?.value)">
                      <div class="flex gap-1.5 mb-2">
                        <button type="button"
                                [class]="$any(rg).get('mode')?.value === 'gt'
                                  ? 'flex-1 px-2 py-1 rounded-md text-white text-[11px] font-bold bg-gradient-to-r from-blue-600 to-violet-600 transition-all cursor-pointer'
                                  : 'flex-1 px-2 py-1 rounded-md text-gray-700 dark:text-gray-300 text-[11px] font-semibold bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 transition-all cursor-pointer'"
                                (click)="changeOperator(i, 'gt')">
                          Mayor
                        </button>
                        <button type="button"
                                [class]="$any(rg).get('mode')?.value === 'lt'
                                  ? 'flex-1 px-2 py-1 rounded-md text-white text-[11px] font-bold bg-gradient-to-r from-blue-600 to-violet-600 transition-all cursor-pointer'
                                  : 'flex-1 px-2 py-1 rounded-md text-gray-700 dark:text-gray-300 text-[11px] font-semibold bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 transition-all cursor-pointer'"
                                (click)="changeOperator(i, 'lt')">
                          Menor
                        </button>
                      </div>

                      <div class="space-y-1.5 text-xs">
                        <div class="flex items-center gap-1.5" *ngIf="$any(rg).get('useMin')?.value">
                          <span class="px-2 py-0.5 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded text-[10px] font-bold">{{ fieldLabel($any(rg).get('field')?.value) }}</span>
                          <label class="flex items-center gap-0.5 cursor-pointer">
                            <input type="checkbox" class="w-3 h-3" formControlName="inclusiveMin">
                            <span class="font-bold">{{ $any(rg).get('inclusiveMin')?.value ? '≥' : '>' }}</span>
                          </label>
                          <input type="number" class="w-20 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-xs" formControlName="min" placeholder="valor">
                        </div>

                        <div class="flex items-center gap-1.5" *ngIf="$any(rg).get('useMax')?.value">
                          <span class="px-2 py-0.5 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded text-[10px] font-bold">{{ fieldLabel($any(rg).get('field')?.value) }}</span>
                          <label class="flex items-center gap-0.5 cursor-pointer">
                            <input type="checkbox" class="w-3 h-3" formControlName="inclusiveMax">
                            <span class="font-bold">{{ $any(rg).get('inclusiveMax')?.value ? '≤' : '<' }}</span>
                          </label>
                          <input type="number" class="w-20 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-xs" formControlName="max" placeholder="valor">
                        </div>
                      </div>

                      <label class="flex items-center gap-1.5 mt-2 cursor-pointer text-xs text-gray-700 dark:text-gray-300">
                        <input type="checkbox" class="w-3 h-3"
                               [checked]="$any(rg).get('useMin')?.value && $any(rg).get('useMax')?.value"
                               (change)="toggleInterval(i, $any($event.target).checked)">
                        <span>Usar intervalo</span>
                      </label>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Tab Content: Condiciones -->
              <div *ngIf="activeTab() === 'condiciones'" class="animate-fade-in">
                <div class="grid grid-cols-1 gap-2">
                  <label class="flex items-center gap-2 p-2 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-blue-50 dark:hover:bg-gray-600 transition-all">
                    <input type="checkbox" class="w-3.5 h-3.5" [checked]="isConditionChecked('PROMESAS_HOY')" (change)="toggleCond($event, 'PROMESAS_HOY')">
                    <span class="text-xs font-medium text-gray-700 dark:text-gray-300">Promesas para hoy</span>
                  </label>
                  <label class="flex items-center gap-2 p-2 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-blue-50 dark:hover:bg-gray-600 transition-all">
                    <input type="checkbox" class="w-3.5 h-3.5" [checked]="isConditionChecked('PROMESAS_MANANA')" (change)="toggleCond($event, 'PROMESAS_MANANA')">
                    <span class="text-xs font-medium text-gray-700 dark:text-gray-300">Promesas para mañana</span>
                  </label>
                  <label class="flex items-center gap-2 p-2 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-blue-50 dark:hover:bg-gray-600 transition-all">
                    <input type="checkbox" class="w-3.5 h-3.5" [checked]="isConditionChecked('PROMESAS_MANANA2')" (change)="toggleCond($event, 'PROMESAS_MANANA2')">
                    <span class="text-xs font-medium text-gray-700 dark:text-gray-300">Promesas pasado mañana</span>
                  </label>
                  <label class="flex items-center gap-2 p-2 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-blue-50 dark:hover:bg-gray-600 transition-all">
                    <input type="checkbox" class="w-3.5 h-3.5" [checked]="isConditionChecked('PROMESAS_ROTAS')" (change)="toggleCond($event, 'PROMESAS_ROTAS')">
                    <span class="text-xs font-medium text-gray-700 dark:text-gray-300">Promesas rotas</span>
                  </label>
                </div>
              </div>

              <!-- Tab Content: Restricciones -->
              <div *ngIf="activeTab() === 'restricciones'" class="animate-fade-in">
                <div class="grid grid-cols-1 gap-2">
                  <label class="flex items-center gap-2 p-2 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-blue-50 dark:hover:bg-gray-600 transition-all">
                    <input type="checkbox" class="w-3.5 h-3.5" formControlName="noContenido">
                    <span class="text-xs font-medium text-gray-700 dark:text-gray-300">Sin contenido</span>
                  </label>
                  <label class="flex items-center gap-2 p-2 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-blue-50 dark:hover:bg-gray-600 transition-all">
                    <input type="checkbox" class="w-3.5 h-3.5" formControlName="excluirPromesasPeriodoActual">
                    <span class="text-xs font-medium text-gray-700 dark:text-gray-300">Excluir promesas periodo actual</span>
                  </label>
                  <label class="flex items-center gap-2 p-2 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-blue-50 dark:hover:bg-gray-600 transition-all">
                    <input type="checkbox" class="w-3.5 h-3.5" formControlName="excluirCompromisos">
                    <span class="text-xs font-medium text-gray-700 dark:text-gray-300">Excluir compromisos</span>
                  </label>
                  <label class="flex items-center gap-2 p-2 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-blue-50 dark:hover:bg-gray-600 transition-all">
                    <input type="checkbox" class="w-3.5 h-3.5" formControlName="excluirBlacklist">
                    <span class="text-xs font-medium text-gray-700 dark:text-gray-300">Excluir blacklist</span>
                  </label>
                </div>
              </div>

          </div>
        </div>

        <!-- Columna derecha: Plantilla + Preview -->
        <div class="flex flex-col bg-gray-50 dark:bg-gray-900/50">
          <!-- Plantilla SMS -->
          <div class="p-3 border-b border-gray-200 dark:border-gray-700">
            <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1.5">Plantilla SMS</label>
            <textarea formControlName="plantillaTexto" rows="5" class="w-full px-2 py-1.5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 dark:focus:ring-blue-400 transition-all resize-none" placeholder="Escribe tu mensaje SMS..."></textarea>
            <div class="flex items-center justify-between mt-1.5">
              <span class="text-[10px] font-semibold text-gray-500 dark:text-gray-400">Caracteres:</span>
              <span class="text-[10px] font-bold" [class]="(form.get('plantillaTexto')?.value?.length || 0) > 160 ? 'text-red-600 dark:text-red-400' : 'text-blue-700 dark:text-blue-400'">
                {{ form.get('plantillaTexto')?.value?.length || 0 }}/160
              </span>
            </div>
          </div>

          <!-- Vista Previa - Sticky -->
          <div class="flex-1 p-3 overflow-y-auto">
            <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1.5">Vista Previa</label>
            <div *ngIf="previewText(); else noPreview" class="p-2.5 bg-gradient-to-r from-blue-600 to-violet-600 text-white rounded-lg text-xs leading-relaxed shadow-lg min-h-[80px]">
              {{ previewText() }}
            </div>
            <ng-template #noPreview>
              <div class="p-4 text-center text-xs text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 border-dashed min-h-[80px] flex items-center justify-center">
                Sin preview
              </div>
            </ng-template>
          </div>
        </div>

      </div>
    </form>

    <!-- Modal Footer - Compacto -->
    <div class="flex gap-2 px-4 py-2.5 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50">
      <button type="button" (click)="close()" class="flex-1 px-3 py-1.5 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 text-xs font-medium hover:bg-gray-100 dark:hover:bg-gray-600 transition-all cursor-pointer">
        Cancelar
      </button>
      <button type="button" (click)="save()" [disabled]="form.invalid || saving()" class="flex-1 px-3 py-1.5 bg-gradient-to-r from-blue-600 to-violet-600 hover:from-blue-700 hover:to-violet-700 text-white rounded-lg text-xs font-medium transition-all shadow-sm cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed">
        {{ saving() ? 'Guardando...' : 'Guardar' }}
      </button>
    </div>
  </div>
</div>
