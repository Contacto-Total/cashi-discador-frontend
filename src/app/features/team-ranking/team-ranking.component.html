<div class="team-ranking-container">
  <!-- Header -->
  <div class="ranking-header">
    <div class="header-title">
      <lucide-angular [name]="activeTab === 'ranking' ? 'trophy' : 'file-text'" [size]="28" [color]="activeTab === 'ranking' ? '#FFD700' : '#10B981'"></lucide-angular>
      <h1>{{ activeTab === 'ranking' ? 'Ranking del Equipo' : 'Promesas del Mes' }}</h1>
    </div>
    <div class="header-actions">
      <span class="last-update" *ngIf="activeTab === 'ranking'">Actualiza cada 1 min</span>
      <button class="btn-export" *ngIf="activeTab === 'promesas'"
              (click)="exportarExcel()" [disabled]="exportingExcel || !promesasMes?.promesas?.length">
        <lucide-angular name="download" [size]="18" [class.spinning]="exportingExcel"></lucide-angular>
        <span>Exportar Excel</span>
      </button>
      <button class="btn-refresh" (click)="refresh()" [disabled]="loading || loadingPromesas">
        <lucide-angular name="refresh-cw" [size]="18" [class.spinning]="loading || loadingPromesas"></lucide-angular>
      </button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs-container">
    <button class="tab-btn" [class.active]="activeTab === 'ranking'" (click)="setActiveTab('ranking')">
      <lucide-angular name="trophy" [size]="16"></lucide-angular>
      <span>Ranking</span>
    </button>
    <button class="tab-btn" [class.active]="activeTab === 'promesas'" (click)="setActiveTab('promesas')">
      <lucide-angular name="file-text" [size]="16"></lucide-angular>
      <span>Promesas del Mes</span>
    </button>
  </div>

  <!-- ==================== TAB RANKING ==================== -->
  <div *ngIf="activeTab === 'ranking'">

  <!-- Loading -->
  <div *ngIf="loading && !ranking" class="loading-container">
    <div class="spinner"></div>
    <p>Cargando ranking...</p>
  </div>

  <!-- Error -->
  <div *ngIf="error" class="error-container">
    <lucide-angular name="alert-circle" [size]="48" color="#EF4444"></lucide-angular>
    <p>{{ error }}</p>
    <button class="btn-retry" (click)="refresh()">Reintentar</button>
  </div>

  <!-- Contenido principal -->
  <div *ngIf="ranking && !loading" class="ranking-content">
    <!-- Resumen del equipo -->
    <div class="team-summary">
      <div class="summary-card">
        <div class="summary-icon">
          <lucide-angular name="users" [size]="24" color="#3B82F6"></lucide-angular>
        </div>
        <div class="summary-info">
          <span class="summary-value">{{ ranking.totalesEquipo.totalAgentes }}</span>
          <span class="summary-label">Asesores</span>
        </div>
      </div>
      <div class="summary-card">
        <div class="summary-icon">
          <lucide-angular name="phone-call" [size]="24" color="#10B981"></lucide-angular>
        </div>
        <div class="summary-info">
          <span class="summary-value">{{ ranking.totalesEquipo.totalGestiones }}</span>
          <span class="summary-label">Gestiones</span>
        </div>
      </div>
      <div class="summary-card">
        <div class="summary-icon">
          <lucide-angular name="target" [size]="24" color="#8B5CF6"></lucide-angular>
        </div>
        <div class="summary-info">
          <span class="summary-value">S/. {{ formatMonto(ranking.totalesEquipo.proyeccionTotal) }}</span>
          <span class="summary-label">Proyección Equipo</span>
        </div>
      </div>
      <div class="summary-card">
        <div class="summary-icon">
          <lucide-angular name="wallet" [size]="24" color="#F59E0B"></lucide-angular>
        </div>
        <div class="summary-info">
          <span class="summary-value">S/. {{ formatMonto(ranking.totalesEquipo.recaudoTotal) }}</span>
          <span class="summary-label">Recaudo Equipo</span>
        </div>
      </div>
      <div class="summary-card highlight">
        <div class="summary-icon">
          <lucide-angular name="percent" [size]="24" color="#10B981"></lucide-angular>
        </div>
        <div class="summary-info">
          <span class="summary-value" [style.color]="getEfectividadColor(ranking.totalesEquipo.efectividadProyeccionEquipo)">
            {{ ranking.totalesEquipo.efectividadProyeccionEquipo | number:'1.0-1' }}%
          </span>
          <span class="summary-label">Efectividad Proyección</span>
        </div>
      </div>
    </div>

    <!-- Mi posición destacada -->
    <div *ngIf="ranking.miRanking" class="my-position-card">
      <div class="my-position-header">
        <lucide-angular name="user-check" [size]="20" color="#3B82F6"></lucide-angular>
        <span>Tu Posición</span>
      </div>
      <div class="my-position-content">
        <div class="position-number">
          <span class="position">#{{ ranking.miRanking.posicion }}</span>
          <span class="total">de {{ ranking.ranking.length }}</span>
        </div>
        <div class="my-metrics">
          <div class="metric">
            <span class="metric-value">{{ ranking.miRanking.totalGestiones }}</span>
            <span class="metric-label">Gestiones</span>
          </div>
          <div class="metric">
            <span class="metric-value">{{ ranking.miRanking.totalPromesas }}</span>
            <span class="metric-label">Promesas</span>
          </div>
          <div class="metric">
            <span class="metric-value">S/. {{ formatMonto(ranking.miRanking.proyeccionDia) }}</span>
            <span class="metric-label">Proyección</span>
          </div>
          <div class="metric">
            <span class="metric-value">S/. {{ formatMonto(ranking.miRanking.recaudoDia) }}</span>
            <span class="metric-label">Recaudo</span>
          </div>
          <div class="metric highlight">
            <span class="metric-value" [style.color]="getEfectividadColor(ranking.miRanking.efectividadProyeccion)">
              {{ ranking.miRanking.efectividadProyeccion | number:'1.0-1' }}%
            </span>
            <span class="metric-label">% Efectividad Proyección</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Mis Metas del Día -->
    <div *ngIf="ranking.metasProgreso?.tieneMeta" class="metas-card">
      <div class="metas-header">
        <lucide-angular name="target" [size]="20" color="#8B5CF6"></lucide-angular>
        <span>Mis Metas del Día</span>
      </div>
      <div class="metas-content">
        <!-- Meta Gestiones -->
        <div class="meta-item" *ngIf="ranking.metasProgreso!.metaGestionesDiarias">
          <div class="meta-info">
            <span class="meta-label">Gestiones</span>
            <span class="meta-values">
              {{ ranking.metasProgreso!.gestionesActuales || 0 }} / {{ ranking.metasProgreso!.metaGestionesDiarias }}
            </span>
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar"
                 [style.width.%]="ranking.metasProgreso!.porcentajeGestiones || 0"
                 [style.background-color]="getMetaColor(ranking.metasProgreso!.porcentajeGestiones)">
            </div>
          </div>
          <span class="meta-percent" [style.color]="getMetaColor(ranking.metasProgreso!.porcentajeGestiones)">
            {{ ranking.metasProgreso!.porcentajeGestiones || 0 }}%
          </span>
        </div>

        <!-- Meta Promesas -->
        <div class="meta-item" *ngIf="ranking.metasProgreso!.metaPromesasDiarias">
          <div class="meta-info">
            <span class="meta-label">Promesas</span>
            <span class="meta-values">
              {{ ranking.metasProgreso!.promesasActuales || 0 }} / {{ ranking.metasProgreso!.metaPromesasDiarias }}
            </span>
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar"
                 [style.width.%]="ranking.metasProgreso!.porcentajePromesas || 0"
                 [style.background-color]="getMetaColor(ranking.metasProgreso!.porcentajePromesas)">
            </div>
          </div>
          <span class="meta-percent" [style.color]="getMetaColor(ranking.metasProgreso!.porcentajePromesas)">
            {{ ranking.metasProgreso!.porcentajePromesas || 0 }}%
          </span>
        </div>

        <!-- Meta Monto -->
        <div class="meta-item" *ngIf="ranking.metasProgreso!.metaMontoDiario">
          <div class="meta-info">
            <span class="meta-label">Monto Promesas</span>
            <span class="meta-values">
              S/. {{ formatMonto(ranking.metasProgreso!.montoActual || 0) }} / S/. {{ formatMonto(ranking.metasProgreso!.metaMontoDiario) }}
            </span>
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar"
                 [style.width.%]="ranking.metasProgreso!.porcentajeMonto || 0"
                 [style.background-color]="getMetaColor(ranking.metasProgreso!.porcentajeMonto)">
            </div>
          </div>
          <span class="meta-percent" [style.color]="getMetaColor(ranking.metasProgreso!.porcentajeMonto)">
            {{ ranking.metasProgreso!.porcentajeMonto || 0 }}%
          </span>
        </div>
      </div>
    </div>

    <!-- Tabla de ranking -->
    <div class="ranking-table-container">
      <table class="ranking-table">
        <thead>
          <tr>
            <th class="col-pos">#</th>
            <th class="col-name">Asesor</th>
            <th class="col-num">Gestiones</th>
            <th class="col-num">Promesas</th>
            <th class="col-money">Proyección</th>
            <th class="col-money">Recaudo</th>
            <th class="col-percent" title="(Recaudo / Proyección) × 100">% Efectividad Proyección</th>
            <th class="col-percent" title="(Promesas / Gestiones) × 100">% Efectividad General</th>
            <th class="col-trend">Tendencia</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let agente of ranking.ranking"
              [class.es-yo]="agente.esYo"
              [class.top-3]="agente.posicion <= 3">
            <!-- Posición -->
            <td class="col-pos">
              <div class="position-badge" [style.background-color]="getMedalColor(agente.posicion) + '20'">
                <lucide-angular
                  [name]="getMedalIcon(agente.posicion)"
                  [size]="agente.posicion <= 3 ? 18 : 14"
                  [color]="getMedalColor(agente.posicion)">
                </lucide-angular>
                <span [style.color]="getMedalColor(agente.posicion)">{{ agente.posicion }}</span>
              </div>
            </td>
            <!-- Nombre -->
            <td class="col-name">
              <div class="agent-name">
                <span>{{ agente.nombreAgente }}</span>
                <span *ngIf="agente.esYo" class="badge-yo">TU</span>
              </div>
            </td>
            <!-- Gestiones -->
            <td class="col-num">{{ agente.totalGestiones }}</td>
            <!-- Promesas -->
            <td class="col-num">{{ agente.totalPromesas }}</td>
            <!-- Proyección -->
            <td class="col-money">S/. {{ formatMonto(agente.proyeccionDia) }}</td>
            <!-- Recaudo -->
            <td class="col-money">S/. {{ formatMonto(agente.recaudoDia) }}</td>
            <!-- % Proyección -->
            <td class="col-percent">
              <span class="efectividad-badge" [style.background-color]="getEfectividadColor(agente.efectividadProyeccion) + '20'"
                    [style.color]="getEfectividadColor(agente.efectividadProyeccion)">
                {{ agente.efectividadProyeccion | number:'1.0-0' }}%
              </span>
            </td>
            <!-- Efectividad general -->
            <td class="col-percent">
              <span class="efectividad-badge" [style.background-color]="getEfectividadColor(agente.efectividadGeneral) + '20'"
                    [style.color]="getEfectividadColor(agente.efectividadGeneral)">
                {{ agente.efectividadGeneral | number:'1.0-0' }}%
              </span>
            </td>
            <!-- Tendencia -->
            <td class="col-trend">
              <lucide-angular
                [name]="getTrendIcon(agente.trend)"
                [size]="18"
                [color]="getTrendColor(agente.trend)">
              </lucide-angular>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Sin datos -->
    <div *ngIf="ranking.ranking.length === 0" class="no-data">
      <lucide-angular name="inbox" [size]="48" color="#64748b"></lucide-angular>
      <p>No hay datos de ranking disponibles</p>
      <span>Comienza a gestionar para aparecer en el ranking</span>
    </div>
  </div>

  </div><!-- Fin TAB RANKING -->

  <!-- ==================== TAB PROMESAS ==================== -->
  <div *ngIf="activeTab === 'promesas'">

    <!-- Loading -->
    <div *ngIf="loadingPromesas && !promesasMes" class="loading-container">
      <div class="spinner"></div>
      <p>Cargando promesas...</p>
    </div>

    <!-- Error -->
    <div *ngIf="errorPromesas" class="error-container">
      <lucide-angular name="alert-circle" [size]="48" color="#EF4444"></lucide-angular>
      <p>{{ errorPromesas }}</p>
      <button class="btn-retry" (click)="loadPromesas()">Reintentar</button>
    </div>

    <!-- Contenido Promesas -->
    <div *ngIf="promesasMes && !loadingPromesas" class="promesas-content">

      <!-- Resumen -->
      <div class="promesas-summary">
        <div class="summary-card">
          <div class="summary-icon">
            <lucide-angular name="file-text" [size]="24" color="#3B82F6"></lucide-angular>
          </div>
          <div class="summary-info">
            <span class="summary-value">{{ promesasMes.resumen.totalPromesas }}</span>
            <span class="summary-label">Total Promesas</span>
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-icon">
            <lucide-angular name="wallet" [size]="24" color="#8B5CF6"></lucide-angular>
          </div>
          <div class="summary-info">
            <span class="summary-value">S/. {{ formatMonto(promesasMes.resumen.montoTotal) }}</span>
            <span class="summary-label">Monto Total</span>
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-icon">
            <lucide-angular name="check-circle" [size]="24" color="#10B981"></lucide-angular>
          </div>
          <div class="summary-info">
            <span class="summary-value" style="color: #10B981">{{ promesasMes.resumen.promesasPagadas }}</span>
            <span class="summary-label">Pagadas</span>
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-icon">
            <lucide-angular name="clock" [size]="24" color="#F59E0B"></lucide-angular>
          </div>
          <div class="summary-info">
            <span class="summary-value" style="color: #F59E0B">{{ promesasMes.resumen.promesasPendientes }}</span>
            <span class="summary-label">Pendientes</span>
          </div>
        </div>
        <div class="summary-card">
          <div class="summary-icon">
            <lucide-angular name="alert-triangle" [size]="24" color="#EF4444"></lucide-angular>
          </div>
          <div class="summary-info">
            <span class="summary-value" style="color: #EF4444">{{ promesasMes.resumen.promesasVencidas }}</span>
            <span class="summary-label">Vencidas</span>
          </div>
        </div>
      </div>

      <!-- Tabla de promesas -->
      <div class="ranking-table-container">
        <table class="ranking-table promesas-table">
          <thead>
            <tr>
              <th class="col-date">Fecha</th>
              <th class="col-doc">Documento</th>
              <th class="col-name">Cliente</th>
              <th class="col-phone">Teléfono</th>
              <th class="col-agent">Agente</th>
              <th class="col-money">Monto</th>
              <th class="col-num">Cuotas</th>
              <th class="col-status">Estado</th>
              <th class="col-date">Fecha Pago</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let promesa of promesasMes.promesas">
              <td class="col-date">{{ promesa.fechaGestion | date:'dd/MM/yyyy' }}</td>
              <td class="col-doc">{{ promesa.documentoCliente }}</td>
              <td class="col-name">{{ promesa.nombreCliente }}</td>
              <td class="col-phone">{{ promesa.telefonoContacto }}</td>
              <td class="col-agent">{{ promesa.nombreAgente }}</td>
              <td class="col-money">S/. {{ formatMonto(promesa.montoPromesa) }}</td>
              <td class="col-num">{{ promesa.totalCuotas || '-' }}</td>
              <td class="col-status">
                <span class="status-badge"
                      [style.background-color]="getEstadoBgColor(promesa.estadoPago)"
                      [style.color]="getEstadoColor(promesa.estadoPago)">
                  {{ promesa.estadoPago }}
                </span>
              </td>
              <td class="col-date">{{ promesa.fechaPagoCompromiso ? (promesa.fechaPagoCompromiso | date:'dd/MM/yyyy') : '-' }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Sin datos -->
      <div *ngIf="promesasMes.promesas.length === 0" class="no-data">
        <lucide-angular name="inbox" [size]="48" color="#64748b"></lucide-angular>
        <p>No hay promesas registradas este mes</p>
      </div>
    </div>

  </div><!-- Fin TAB PROMESAS -->

</div>
