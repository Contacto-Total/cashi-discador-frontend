<div class="chat-window-container">
  <!-- Chat header -->
  <div *ngIf="currentChat" class="chat-header">
    <div class="header-left">
      <img *ngIf="currentChat.profilePictureUrl" [src]="currentChat.profilePictureUrl" class="avatar-icon profile-pic" alt="Profile">
      <lucide-angular *ngIf="!currentChat.profilePictureUrl" name="user" [size]="40" class="avatar-icon"></lucide-angular>
      <div class="chat-info">
        <span class="chat-name">{{ getChatDisplayName() }}</span>
      </div>
    </div>
    <div class="header-right">
      <button mat-icon-button class="header-icon" (click)="toggleSearchBar()">
        <lucide-angular name="search" [size]="20"></lucide-angular>
      </button>
      <button mat-icon-button class="header-icon">
        <lucide-angular name="more-vertical" [size]="20"></lucide-angular>
      </button>
    </div>
  </div>

  <!-- Search Bar -->
  <div *ngIf="currentChat && showSearchBar" class="search-bar">
    <button mat-icon-button class="search-back-button" (click)="toggleSearchBar()">
      <lucide-angular name="arrow-left" [size]="20"></lucide-angular>
    </button>
    <input
      type="text"
      class="search-input"
      placeholder="Buscar mensajes..."
      [(ngModel)]="searchQuery"
      (ngModelChange)="searchMessages()"
      autocomplete="off">
    <div class="search-results-info" *ngIf="searchResults.length > 0">
      {{ currentSearchIndex + 1 }} de {{ searchResults.length }}
    </div>
    <button mat-icon-button class="search-nav-button" (click)="previousSearchResult()" [disabled]="searchResults.length === 0">
      <lucide-angular name="chevron-up" [size]="20"></lucide-angular>
    </button>
    <button mat-icon-button class="search-nav-button" (click)="nextSearchResult()" [disabled]="searchResults.length === 0">
      <lucide-angular name="chevron-down" [size]="20"></lucide-angular>
    </button>
  </div>

  <!-- Empty state -->
  <div class="empty-state" *ngIf="!currentChat">
    <div class="empty-content">
      <div class="empty-icon">
        <svg viewBox="0 0 303 172" width="360" height="210">
          <path fill="#525252" d="M151.5,0A75.5,75.5,0,1,1,76,75.5,75.5,75.5,0,0,1,151.5,0m0,140A64.5,64.5,0,1,0,87,75.5,64.5,64.5,0,0,0,151.5,140Z"/>
        </svg>
      </div>
      <h1>Chat Contacto Total</h1>
      <p>Selecciona un chat para comenzar a conversar</p>
    </div>
  </div>

  <!-- Messages container -->
  <div class="messages-container" #messagesContainer *ngIf="currentChat">
    <!-- Loading overlay - oculta TODO mientras carga -->
    <div *ngIf="messagesLoading" class="loading-overlay">
      <div class="loading-spinner"></div>
      <p>Cargando mensajes...</p>
    </div>

    <!-- Messages - ocultos completamente mientras cargan -->
    <ng-container *ngIf="!messagesLoading">
      <div
        *ngFor="let message of reversedMessages; trackBy: trackByMessageId"
        [id]="'msg-' + message.msgId"
        class="message-wrapper"
        [class.from-me]="message.fromMe"
        [class.from-them]="!message.fromMe"
        [class.search-highlighted]="isMessageHighlighted(message.msgId)">

      <div class="message-bubble">
        <!-- Bot√≥n de reply (aparece al hover) -->
        <button mat-icon-button class="reply-button" (click)="replyToMessage(message)" title="Responder">
          <lucide-angular name="corner-up-left" [size]="20"></lucide-angular>
        </button>

        <!-- Mensaje citado -->
        <div *ngIf="message.quotedMessageId" class="quoted-message">
          <div class="quoted-line"></div>
          <div class="quoted-content">
            <div class="quoted-sender" [class.quoted-me]="message.quotedFromMe">
              {{ message.quotedFromMe ? 'T√∫' : message.quotedSender }}
            </div>
            <div class="quoted-text">{{ message.quotedText || 'Archivo adjunto' }}</div>
          </div>
        </div>

        <div *ngIf="message.hasMedia && message.media" class="message-media">
          <img *ngIf="isImageMedia(message.media.mime)"
               [src]="getMediaSrc(message.media)"
               alt="Imagen"
               class="media-image">
          <video *ngIf="isVideoMedia(message.media.mime)"
                 [src]="getMediaSrc(message.media)"
                 controls
                 class="media-video">
          </video>
          <div *ngIf="isAudioMedia(message.media.mime)" class="media-audio-whatsapp">
            <button mat-icon-button class="audio-play-btn" (click)="toggleAudio($event, message.msgId)">
              <lucide-angular [name]="isAudioPlaying(message.msgId) ? 'pause' : 'play'" [size]="18"></lucide-angular>
            </button>

            <div class="audio-content">
              <div class="audio-waveform-container">
                <div class="audio-waveform-bars">
                  <div class="waveform-bar" *ngFor="let bar of [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30]; let i = index"
                       [style.height.%]="getWaveformBarHeight(i)"
                       [class.played]="getAudioProgress(message.msgId) > (i * 100 / 30)"></div>
                </div>
                <input
                  type="range"
                  class="audio-progress-slider"
                  min="0"
                  max="100"
                  [value]="getAudioProgress(message.msgId)"
                  (input)="seekAudio($event, message.msgId)">
              </div>

              <div class="audio-info">
                <span class="audio-duration-text">{{ getAudioDuration(message.msgId) }}</span>
              </div>
            </div>

            <button mat-icon-button class="audio-speed-btn" (click)="changeSpeed($event, message.msgId)">
              <span class="speed-value">{{ getAudioSpeed(message.msgId) }}x</span>
            </button>

            <audio
              #audioElement
              [src]="getMediaSrc(message.media)"
              [id]="'audio-' + message.msgId"
              (timeupdate)="onAudioTimeUpdate(message.msgId)"
              (loadedmetadata)="onAudioLoaded(message.msgId)"
              (loadeddata)="onAudioLoaded(message.msgId)"
              (canplay)="onAudioLoaded(message.msgId)"
              (durationchange)="onAudioLoaded(message.msgId)"
              (ended)="onAudioEnded(message.msgId)"
              preload="metadata"
              style="display: none">
            </audio>
          </div>
        </div>
        <div class="message-text" *ngIf="message.text">{{ message.text }}</div>
        <div class="message-footer">
          <span class="message-time">{{ formatTime(message.timestamp) }}</span>
          <lucide-angular
            *ngIf="message.fromMe && (message.status === 'delivered' || message.status === 'read')"
            name="check-check"
            [size]="16"
            class="message-status"
            [class.status-read]="message.status === 'read'">
          </lucide-angular>
          <lucide-angular
            *ngIf="message.fromMe && (message.status === 'sent' || !message.status)"
            name="check"
            [size]="16"
            class="message-status">
          </lucide-angular>
        </div>
      </div>
    </div>
    </ng-container>
  </div>

  <!-- Input container -->
  <div class="input-container" *ngIf="currentChat">
    <!-- Reply preview -->
    <div *ngIf="replyingTo" class="reply-preview">
      <div class="reply-preview-content">
        <div class="reply-preview-header">
          <lucide-angular name="corner-up-left" [size]="20" class="reply-icon"></lucide-angular>
          <span class="reply-preview-title">Respondiendo a {{ replyingTo.fromMe ? 'ti mismo' : (replyingTo.chatTitle || 'Usuario') }}</span>
        </div>
        <div class="reply-preview-text">{{ replyingTo.text || 'Archivo adjunto' }}</div>
      </div>
      <button mat-icon-button class="reply-close-button" (click)="cancelReply()">
        <lucide-angular name="x" [size]="20"></lucide-angular>
      </button>
    </div>

    <!-- Banners de estado de ventana -->
    <div *ngIf="isNewChat && !isChatBlocked" class="new-chat-banner">
      üí¨ El cliente debe iniciar esta conversaci√≥n para poder enviar mensajes
    </div>

    <div *ngIf="windowStatus?.hasActiveWindow && !isChatBlocked && !isNewChat"
         class="window-warning-banner">
      ‚ö†Ô∏è Tienes {{ getTimeRemaining() }} para responder o el chat se bloquear√°
    </div>

    <div *ngIf="isChatBlocked && !isNewChat" class="chat-blocked-banner">
      üö´ Chat bloqueado. Espera a que {{ getChatDisplayName() }} te escriba de nuevo.
    </div>

    <!-- Normal input row -->
    <div class="input-row" *ngIf="!isRecording">
      <input
        type="file"
        #fileInput
        (change)="onFileSelected($event)"
        accept="image/*,video/*,audio/*"
        style="display: none">

      <button mat-icon-button class="input-icon" (click)="openFileSelector()" [disabled]="isChatBlocked || isNewChat">
        <lucide-angular name="plus" [size]="20"></lucide-angular>
      </button>

      <input
        type="text"
        class="message-input"
        [placeholder]="getInputPlaceholder()"
        [(ngModel)]="messageText"
        (keypress)="onKeyPress($event)"
        (click)="closeEmojiPicker()"
        [disabled]="isChatBlocked || isNewChat"
        autocomplete="off">

      <div class="emoji-picker-container">
        <button mat-icon-button class="input-icon" (click)="toggleEmojiPicker($event)" [disabled]="isChatBlocked || isNewChat">
          <lucide-angular name="smile" [size]="20"></lucide-angular>
        </button>

        <!-- Emoji Picker -->
        <div *ngIf="showEmojiPicker" class="emoji-picker-wrapper" (click)="$event.stopPropagation()">
          <emoji-mart
            [darkMode]="true"
            [showPreview]="false"
            [perLine]="9"
            [emojiSize]="28"
            [sheetSize]="32"
            [showSingleCategory]="false"
            [enableSearch]="true"
            [i18n]="emojiPickerI18n"
            [hideRecent]="false"
            [autoFocus]="false"
            [enableFrequentEmojiSort]="true"
            (emojiClick)="addEmoji($event)"
            title="Selecciona un emoji">
          </emoji-mart>
        </div>
      </div>

      <button
        *ngIf="messageText.trim()"
        mat-icon-button
        class="send-button"
        (click)="sendMessage()"
        [disabled]="isChatBlocked || isNewChat">
        <lucide-angular name="send" [size]="20"></lucide-angular>
      </button>

      <button
        *ngIf="!messageText.trim() && !isRecording"
        mat-icon-button
        class="input-icon mic-button"
        (mousedown)="startRecording()"
        (touchstart)="startRecording()"
        [disabled]="isChatBlocked || isNewChat"
        title="Mant√©n presionado para grabar audio">
        <lucide-angular name="mic" [size]="20"></lucide-angular>
      </button>
    </div>

    <!-- Recording UI -->
    <div class="recording-row" *ngIf="isRecording">
      <button mat-icon-button class="recording-delete-button" (click)="cancelRecording()">
        <lucide-angular name="trash-2" [size]="20"></lucide-angular>
      </button>

      <div class="recording-info">
        <div class="recording-indicator">
          <span class="recording-dot"></span>
          <span class="recording-text">Grabando</span>
        </div>
        <span class="recording-time">{{ getRecordingTime() }}</span>
      </div>

      <button mat-icon-button class="recording-send-button" (click)="stopRecording()">
        <lucide-angular name="send" [size]="20"></lucide-angular>
      </button>
    </div>
  </div>
</div>
