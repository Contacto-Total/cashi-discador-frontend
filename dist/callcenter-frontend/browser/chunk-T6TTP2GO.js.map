{
  "version": 3,
  "sources": ["src/app/core/services/agent-status.service.ts"],
  "sourcesContent": ["import { Injectable } from '@angular/core';\nimport { HttpClient } from '@angular/common/http';\nimport { Observable, BehaviorSubject, interval } from 'rxjs';\nimport { tap, switchMap, startWith } from 'rxjs/operators';\nimport { environment } from '../../../environments/environment';\nimport {\n  AgentStatus,\n  AgentStatusResponse,\n  ChangeStatusRequest,\n  EstadosDisponibles,\n  AgentState\n} from '../models/agent-status.model';\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class AgentStatusService {\n  // Usar gatewayUrl porque agent-status está en el backend de discador (puerto 8080)\n  private apiUrl = `${environment.gatewayUrl}/agent-status`;\n  private currentStatusSubject = new BehaviorSubject<AgentStatus | null>(null);\n  public currentStatus$ = this.currentStatusSubject.asObservable();\n\n  constructor(private http: HttpClient) {}\n\n  /**\n   * Obtiene el estado actual de un agente\n   */\n  getAgentStatus(idUsuario: number): Observable<AgentStatusResponse> {\n    return this.http.get<AgentStatusResponse>(`${this.apiUrl}/${idUsuario}`).pipe(\n      tap(response => {\n        const status: AgentStatus = {\n          idUsuario: response.idUsuario,\n          estadoActual: response.estadoActual as AgentState,\n          estadoAnterior: response.estadoAnterior as AgentState | undefined,\n          timestampCambio: response.timestampCambio,\n          tiempoEnEstadoMinutos: response.tiempoEnEstadoMinutos,\n          notas: response.notas,\n          sessionId: response.sessionId,\n          // Campos de umbral de tiempo\n          segundosEnEstado: response.segundosEnEstado,\n          colorIndicador: response.colorIndicador,\n          porcentajeTiempo: response.porcentajeTiempo,\n          excedeTiempoMaximo: response.excedeTiempoMaximo,\n          tiempoMaximoSegundos: response.tiempoMaximoSegundos\n        };\n        this.currentStatusSubject.next(status);\n      })\n    );\n  }\n\n  /**\n   * Cambia el estado de un agente manualmente\n   */\n  changeStatus(idUsuario: number, request: ChangeStatusRequest): Observable<any> {\n    return this.http.post(`${this.apiUrl}/${idUsuario}/cambiar-estado`, request).pipe(\n      tap(() => {\n        // Actualizar el estado después del cambio\n        this.getAgentStatus(idUsuario).subscribe();\n      })\n    );\n  }\n\n  /**\n   * Entra en modo manual\n   */\n  enterManualMode(idUsuario: number): Observable<any> {\n    return this.http.post(`${this.apiUrl}/${idUsuario}/modo-manual/entrar`, {}).pipe(\n      tap(() => {\n        this.getAgentStatus(idUsuario).subscribe();\n      })\n    );\n  }\n\n  /**\n   * Sale de modo manual\n   */\n  exitManualMode(idUsuario: number): Observable<any> {\n    return this.http.post(`${this.apiUrl}/${idUsuario}/modo-manual/salir`, {}).pipe(\n      tap(() => {\n        this.getAgentStatus(idUsuario).subscribe();\n      })\n    );\n  }\n\n  /**\n   * Obtiene los estados disponibles\n   */\n  getAvailableStates(): Observable<EstadosDisponibles> {\n    return this.http.get<EstadosDisponibles>(`${this.apiUrl}/estados-disponibles`);\n  }\n\n  /**\n   * Verifica si un agente está disponible para llamadas\n   */\n  isAvailableForCalls(idUsuario: number): Observable<{ idUsuario: number; disponible: boolean }> {\n    return this.http.get<{ idUsuario: number; disponible: boolean }>(\n      `${this.apiUrl}/${idUsuario}/disponible-para-llamadas`\n    );\n  }\n\n  /**\n   * Inicia el polling automático del estado del agente cada 10 segundos\n   * para mantener actualizado el indicador de umbral de tiempo\n   */\n  startStatusPolling(idUsuario: number): Observable<AgentStatusResponse> {\n    return interval(10000).pipe(\n      startWith(0),\n      switchMap(() => this.getAgentStatus(idUsuario))\n    );\n  }\n\n  /**\n   * Limpia el estado actual\n   */\n  clearCurrentStatus(): void {\n    this.currentStatusSubject.next(null);\n  }\n\n  /**\n   * Desconecta al agente (elimina su estado en el backend)\n   * Llamar al hacer logout para que el monitoreo muestre al agente como desconectado\n   */\n  disconnectAgent(idUsuario: number): Observable<any> {\n    return this.http.delete(`${this.apiUrl}/${idUsuario}`).pipe(\n      tap(() => {\n        console.log(`[AgentStatusService] Agente ${idUsuario} marcado como desconectado`);\n        this.currentStatusSubject.next(null);\n      })\n    );\n  }\n\n  /**\n   * Obtiene el estado actual sin hacer una nueva petición\n   */\n  getCurrentStatus(): AgentStatus | null {\n    return this.currentStatusSubject.value;\n  }\n\n  /**\n   * Finaliza la tipificación y cambia a DISPONIBLE\n   * Se llama después de guardar la gestión\n   */\n  finalizarTipificacion(idUsuario: number): Observable<any> {\n    return this.http.post(`${this.apiUrl}/${idUsuario}/sistema/finalizar-tipificacion`, {}).pipe(\n      tap(() => {\n        console.log(`[AgentStatusService] Tipificación finalizada para agente ${idUsuario}`);\n        this.getAgentStatus(idUsuario).subscribe();\n      })\n    );\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;AAgBM,IAAO,sBAAP,MAAO,oBAAkB;EAM7B,YAAoB,MAAgB;AAAhB,SAAA,OAAA;AAJZ,SAAA,SAAS,GAAG,YAAY,UAAU;AAClC,SAAA,uBAAuB,IAAI,gBAAoC,IAAI;AACpE,SAAA,iBAAiB,KAAK,qBAAqB,aAAY;EAEvB;;;;EAKvC,eAAe,WAAiB;AAC9B,WAAO,KAAK,KAAK,IAAyB,GAAG,KAAK,MAAM,IAAI,SAAS,EAAE,EAAE,KACvE,IAAI,cAAW;AACb,YAAM,SAAsB;QAC1B,WAAW,SAAS;QACpB,cAAc,SAAS;QACvB,gBAAgB,SAAS;QACzB,iBAAiB,SAAS;QAC1B,uBAAuB,SAAS;QAChC,OAAO,SAAS;QAChB,WAAW,SAAS;;QAEpB,kBAAkB,SAAS;QAC3B,gBAAgB,SAAS;QACzB,kBAAkB,SAAS;QAC3B,oBAAoB,SAAS;QAC7B,sBAAsB,SAAS;;AAEjC,WAAK,qBAAqB,KAAK,MAAM;IACvC,CAAC,CAAC;EAEN;;;;EAKA,aAAa,WAAmB,SAA4B;AAC1D,WAAO,KAAK,KAAK,KAAK,GAAG,KAAK,MAAM,IAAI,SAAS,mBAAmB,OAAO,EAAE,KAC3E,IAAI,MAAK;AAEP,WAAK,eAAe,SAAS,EAAE,UAAS;IAC1C,CAAC,CAAC;EAEN;;;;EAKA,gBAAgB,WAAiB;AAC/B,WAAO,KAAK,KAAK,KAAK,GAAG,KAAK,MAAM,IAAI,SAAS,uBAAuB,CAAA,CAAE,EAAE,KAC1E,IAAI,MAAK;AACP,WAAK,eAAe,SAAS,EAAE,UAAS;IAC1C,CAAC,CAAC;EAEN;;;;EAKA,eAAe,WAAiB;AAC9B,WAAO,KAAK,KAAK,KAAK,GAAG,KAAK,MAAM,IAAI,SAAS,sBAAsB,CAAA,CAAE,EAAE,KACzE,IAAI,MAAK;AACP,WAAK,eAAe,SAAS,EAAE,UAAS;IAC1C,CAAC,CAAC;EAEN;;;;EAKA,qBAAkB;AAChB,WAAO,KAAK,KAAK,IAAwB,GAAG,KAAK,MAAM,sBAAsB;EAC/E;;;;EAKA,oBAAoB,WAAiB;AACnC,WAAO,KAAK,KAAK,IACf,GAAG,KAAK,MAAM,IAAI,SAAS,2BAA2B;EAE1D;;;;;EAMA,mBAAmB,WAAiB;AAClC,WAAO,SAAS,GAAK,EAAE,KACrB,UAAU,CAAC,GACX,UAAU,MAAM,KAAK,eAAe,SAAS,CAAC,CAAC;EAEnD;;;;EAKA,qBAAkB;AAChB,SAAK,qBAAqB,KAAK,IAAI;EACrC;;;;;EAMA,gBAAgB,WAAiB;AAC/B,WAAO,KAAK,KAAK,OAAO,GAAG,KAAK,MAAM,IAAI,SAAS,EAAE,EAAE,KACrD,IAAI,MAAK;AACP,cAAQ,IAAI,+BAA+B,SAAS,4BAA4B;AAChF,WAAK,qBAAqB,KAAK,IAAI;IACrC,CAAC,CAAC;EAEN;;;;EAKA,mBAAgB;AACd,WAAO,KAAK,qBAAqB;EACnC;;;;;EAMA,sBAAsB,WAAiB;AACrC,WAAO,KAAK,KAAK,KAAK,GAAG,KAAK,MAAM,IAAI,SAAS,mCAAmC,CAAA,CAAE,EAAE,KACtF,IAAI,MAAK;AACP,cAAQ,IAAI,+DAA4D,SAAS,EAAE;AACnF,WAAK,eAAe,SAAS,EAAE,UAAS;IAC1C,CAAC,CAAC;EAEN;;;mCArIW,qBAAkB,mBAAA,UAAA,CAAA;AAAA;uFAAlB,qBAAkB,SAAlB,oBAAkB,WAAA,YAFjB,OAAM,CAAA;AAEd,IAAO,qBAAP;;sEAAO,oBAAkB,CAAA;UAH9B;WAAW;MACV,YAAY;KACb;;;",
  "names": []
}
