import{a as d}from"./chunk-YQKVMPSG.js";import{ca as h,ga as g,ud as p,v as s}from"./chunk-SN4XSKG7.js";var N=(()=>{let l=class l{constructor(t){this.http=t,this.baseUrl=`${d.gatewayUrl}/v2/management-records`,this.scheduleUrl=`${d.tipificacionUrl}/payment-schedules`,this.cabecerasUrl=`${d.gatewayUrl}/configuracion-cabeceras`}createManagement(t){let e=this.transformToBackendFormat(t);return console.log("[MANAGEMENT] Creating management record:",e),this.http.post(this.baseUrl,e).pipe(s(a=>this.transformToFrontendFormat(a,t)))}getManagementById(t){return this.http.get(`${this.baseUrl}/${t}`).pipe(s(e=>this.transformToFrontendFormat(e)))}getManagementsByCustomer(t){return this.http.get(`${this.baseUrl}/client/${t}`).pipe(s(e=>e.map(a=>this.transformToFrontendFormat(a))))}getManagementsByDocumento(t){return console.log("[MANAGEMENT] Fetching managements by documento:",t),this.http.get(`${this.baseUrl}/documento/${t}`).pipe(s(e=>e.map(a=>this.transformToFrontendFormat(a))))}getManagementsByAdvisor(t){return this.http.get(`${this.baseUrl}/agent/${t}`).pipe(s(e=>e.map(a=>this.transformToFrontendFormat(a))))}getActiveSchedulesByCustomer(t){return console.log("[SCHEDULE] Fetching active schedules for customer:",t),this.http.get(`${this.baseUrl}/payment-schedule/client/${t}/active`).pipe(s(e=>this.transformToPaymentSchedules(e)))}getActiveSchedulesByDocumento(t){return console.log("[SCHEDULE] Fetching active schedules for documento:",t),this.http.get(`${this.baseUrl}/payment-schedule/documento/${t}/active`).pipe(s(e=>this.transformToPaymentSchedules(e)))}transformToPaymentSchedules(t){return t.map(e=>{let a=e.cuotasPromesa||[],o=a.reduce((n,r)=>n+(r.montoPromesa||r.monto||0),0),i=a.filter(n=>n.estado==="PAGADA"||n.estado==="CUMPLIDO").reduce((n,r)=>n+(r.montoPagadoReal||r.montoPromesa||r.monto||0),0),m=o-i,f=a.filter(n=>n.estado==="PAGADA"||n.estado==="CUMPLIDO").length,u=a.filter(n=>n.estado==="PENDIENTE").length;return{id:e.id,scheduleId:{scheduleId:e.grupoPromesaUuid||e.uuid},customerId:String(e.idCliente),managementId:String(e.id),totalAmount:o,numberOfInstallments:a.length,startDate:e.fechaGestion?.split("T")[0]||new Date().toISOString().split("T")[0],isActive:u>0,scheduleType:e.tipoCronograma||"CONFIANZA",negotiatedAmount:e.montoPromesaPago||o,installments:a.map(n=>({id:n.id,installmentNumber:n.numeroCuota,numeroCuota:n.numeroCuota,amount:n.montoPromesa||n.monto,monto:n.montoPromesa||n.monto,montoPromesa:n.montoPromesa||n.monto,dueDate:n.fechaPromesa||n.fechaPago,fechaPago:n.fechaPromesa||n.fechaPago,fechaPromesa:n.fechaPromesa||n.fechaPago,paidDate:n.fechaPagoReal||null,status:n.estado||"PENDIENTE",montoPagadoReal:n.montoPagadoReal||0})),paidAmount:i,pendingAmount:m,paidInstallments:f,pendingInstallments:u,fullyPaid:u===0}})}startCall(t,e){return console.log("[CALL] Start call for management:",t,e),this.getManagementById(t.toString())}endCall(t,e){return console.log("[CALL] End call for management:",t,e),this.getManagementById(t.toString())}registerPayment(t,e){return console.log("[PAYMENT] Register payment for management:",t,e),this.getManagementById(t)}createPaymentSchedule(t){return console.log("[SCHEDULE] Creating payment schedule:",t),this.http.post(`${this.baseUrl}/payment-schedule`,t)}updatePaymentStatus(t,e,a,o){console.log("[PAYMENT-STATUS] Updating payment status:",{recordId:t,estadoPago:e,montoPagadoReal:a,fechaPagoReal:o});let i=`estadoPago=${e}`;return a!==void 0&&(i+=`&montoPagadoReal=${a}`),o&&(i+=`&fechaPagoReal=${o}`),this.http.put(`${this.baseUrl}/${t}/payment-status?${i}`,{})}puedeCancelarCuota(t){return console.log("[CUOTA] Checking if cuota can be canceled:",t),this.http.get(`${this.baseUrl}/cuota/${t}/puede-cancelar`)}cancelarCuota(t,e,a,o){console.log("[CUOTA] Canceling cuota:",{cuotaId:t,montoPagadoReal:e,fechaPagoReal:a,observaciones:o});let i="",m=[];return e!==void 0&&m.push(`montoPagadoReal=${e}`),a&&m.push(`fechaPagoReal=${a}`),o&&m.push(`observaciones=${encodeURIComponent(o)}`),m.length>0&&(i="?"+m.join("&")),this.http.put(`${this.baseUrl}/cuota/${t}/cancelar${i}`,{})}getMontoCabeceras(t){return console.log("[CABECERAS] Fetching monto cabeceras for subcartera:",t),this.http.get(`${this.cabecerasUrl}/subcartera/${t}/montos`)}updateAmountVisibility(t,e){return console.log("[CABECERAS] Updating visibility for subcartera:",t,e),this.http.put(`${this.cabecerasUrl}/subcartera/${t}/visibility`,e)}transformToBackendFormat(t){let e=t.level3Id||t.level2Id||t.level1Id,a=[];t.level1Name&&a.push(t.level1Name),t.level2Name&&a.push(t.level2Name),t.level3Name&&a.push(t.level3Name);let o=a.join(" > ");return{idTenant:t.tenantId,idCartera:t.portfolioId,idSubcartera:t.subPortfolioId||void 0,idCliente:Number(t.customerId),nombreCliente:t.customerName||void 0,documentoCliente:t.customerDocument||void 0,idAgente:this.extractAgentId(t.advisorId),tipificacion:{id:e},observaciones:t.observations||"",canalContacto:t.canalContacto||void 0,metodoContacto:t.metodoContacto||"GESTION_MANUAL",estadoGestion:"COMPLETADA",idCampana:t.idCampana||void 0,idLlamada:t.idLlamada||void 0,duracionSegundos:t.duracionSegundos||void 0,nombreAgente:t.nombreAgente||void 0,userAgent:t.userAgent||void 0}}transformToFrontendFormat(t,e){return{id:t.id||0,customerId:String(t.idCliente),advisorId:String(t.idAgente),tenantId:t.idTenant,tenantName:"",portfolioId:t.idCartera||0,portfolioName:"",subPortfolioId:t.idSubcartera,subPortfolioName:"",phone:t.canalContacto||"",level1Id:t.tipificacion?.id||0,level1Name:e?.level1Name||t.rutaNivel1||"",level2Id:void 0,level2Name:e?.level2Name||t.rutaNivel2||"",level3Id:void 0,level3Name:e?.level3Name||t.rutaNivel3||"",level4Name:t.rutaNivel4||"",observations:t.observaciones,managementDate:t.fechaGestion?.split("T")[0],managementTime:t.fechaGestion?.split("T")[1]?.substring(0,8),canalContacto:t.canalContacto||"N/A",metodoContacto:t.metodoContacto||"N/A",nombreAgente:t.nombreAgente||t.userAgent||`Agente ${t.idAgente}`,duracionSegundos:t.duracionSegundos||0}}extractAgentId(t){return t.startsWith("ADV-")?1:Number(t)||1}};l.\u0275fac=function(e){return new(e||l)(g(p))},l.\u0275prov=h({token:l,factory:l.\u0275fac,providedIn:"root"});let c=l;return c})();export{N as a};
