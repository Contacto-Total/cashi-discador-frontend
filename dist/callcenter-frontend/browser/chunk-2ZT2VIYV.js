import{a as It,b as Xe,c as Ft}from"./chunk-MZHUUCLA.js";import{a as Ke,b as Je}from"./chunk-5JIAMO6J.js";import{a as At}from"./chunk-LL26DHMR.js";import{a as ze,b as je}from"./chunk-YQDJEWD4.js";import{h as Qe,i as Tt,j as lt,l as Ze}from"./chunk-T23QHG5U.js";import{a as Mt}from"./chunk-A7E3NI5E.js";import{c as Ge,d as He,e as Pt,g as qe,h as We,i as Ye}from"./chunk-VHHFB6JP.js";import{a as wt}from"./chunk-Z7CLVSOR.js";import{a as Et}from"./chunk-VANAMEII.js";import{a as ke}from"./chunk-F4ESQKJH.js";import"./chunk-DAJRNOBM.js";import"./chunk-SVPL2WML.js";import"./chunk-C4CJRQQ2.js";import{a as ae,b as Dt}from"./chunk-63CYOJD2.js";import"./chunk-KFRMTB2X.js";import{B as Be,C as $e,z as Ue}from"./chunk-JRQDYGIX.js";import"./chunk-3HY3XBSW.js";import{a as xt}from"./chunk-KNHDRGXI.js";import{a as pt,c as gt}from"./chunk-T2ZQ5EGI.js";import"./chunk-NTU7HPDP.js";import{a as kt}from"./chunk-ZL45YB4K.js";import{E as De,c as bt,f as Oe,k as Le,m as _t,s as Ct,t as vt,u as St,x as yt}from"./chunk-7GV7UZOL.js";import{Rb as ht,Sb as ft}from"./chunk-FO4EYWPG.js";import{a as K}from"./chunk-YQKVMPSG.js";import{Aa as Ie,Bc as H,Fb as g,Gb as h,Gc as U,Hb as it,Hc as ut,I as ye,Jb as q,Kb as W,Lb as O,Mb as l,Nb as a,Ob as B,Pb as Y,Qb as Q,Rb as mt,Vb as N,Wb as ot,Xa as Ee,Xb as E,Yb as he,Zb as u,a as Z,ab as s,b as pe,bc as Ae,ca as te,cc as Fe,dc as Ne,ga as ge,gb as V,ha as Me,hc as Re,ic as Ve,jc as at,kc as D,lc as r,ld as se,mc as S,md as ie,na as _,nb as ne,nc as f,oa as C,oc as fe,qc as xe,r as ve,rc as be,sc as _e,ud as oe,v as Se,vb as Te,xa as b,zc as G}from"./chunk-SN4XSKG7.js";var we=(()=>{let c=class c{constructor(e){this.http=e,this.baseUrl=`${K.tipificacionUrl}/payment-schedules`}createPaymentSchedule(e){return this.http.post(`${K.tipificacionUrl}/payments/schedules`,e)}getPaymentScheduleByManagementId(e){return this.http.get(`${this.baseUrl}/management/${e}`)}updateInstallmentStatus(e,t){return this.http.post(`${this.baseUrl}/installments/${e}/status`,t)}getInstallmentHistory(e){return this.http.get(`${this.baseUrl}/installments/${e}/history`)}getLatestStatusByManagement(e){return this.http.get(`${this.baseUrl}/management/${e}/latest-status`)}getActiveSchedulesByCustomer(e){return this.http.get(`${K.gatewayUrl}/v2/management-records/payment-schedule/client/${e}`)}};c.\u0275fac=function(t){return new(t||c)(ge(oe))},c.\u0275prov=te({token:c,factory:c.\u0275fac,providedIn:"root"});let o=c;return o})();function qt(o,c){if(o&1){let i=N();l(0,"div",17)(1,"div")(2,"label",13),r(3," Fecha de Pago * "),a(),l(4,"input",23),_e("ngModelChange",function(t){_(i);let n=u(2);return be(n.paymentDate,t)||(n.paymentDate=t),C(t)}),a()(),l(5,"div")(6,"label",13),r(7," Monto Pagado * "),a(),l(8,"div",24)(9,"span",25),r(10,"S/"),a(),l(11,"input",26),_e("ngModelChange",function(t){_(i);let n=u(2);return be(n.amountPaid,t)||(n.amountPaid=t),C(t)}),a()()()()}if(o&2){let i=u(2);s(4),xe("ngModel",i.paymentDate),s(7),xe("ngModel",i.amountPaid)}}function Wt(o,c){if(o&1&&(l(0,"div",19)(1,"span",27),r(2),a()()),o&2){let i=u(2);s(2),S(i.errorMessage())}}function Yt(o,c){o&1&&(l(0,"span"),r(1,"Guardando..."),a())}function Qt(o,c){o&1&&(l(0,"span"),r(1,"Guardar"),a())}function Kt(o,c){if(o&1){let i=N();l(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"div")(5,"h2",4),r(6,"Actualizar Estado de Cuota"),a(),l(7,"p",5),r(8),a()()(),l(9,"button",6),E("click",function(){_(i);let t=u();return C(t.close())}),a()(),l(10,"div",7)(11,"div",8)(12,"div",9)(13,"div")(14,"span",10),r(15,"Monto:"),a(),l(16,"span",11),r(17),G(18,"number"),a()(),l(19,"div")(20,"span",10),r(21,"Fecha Vencimiento:"),a(),l(22,"span",11),r(23),a()(),l(24,"div")(25,"span",10),r(26,"Estado Actual:"),a(),l(27,"span",12),r(28),a()()()(),l(29,"div")(30,"label",13),r(31," Nuevo Estado "),a(),l(32,"div",14)(33,"button",15),E("click",function(){_(i);let t=u();return C(t.selectedStatus.set("COMPLETADO"))}),l(34,"span",16),r(35,"Completado"),a()(),l(36,"button",15),E("click",function(){_(i);let t=u();return C(t.selectedStatus.set("VENCIDO"))}),l(37,"span",16),r(38,"Vencido"),a()(),l(39,"button",15),E("click",function(){_(i);let t=u();return C(t.selectedStatus.set("CANCELADO"))}),l(40,"span",16),r(41,"Cancelado"),a()()()(),g(42,qt,12,2,"div",17),l(43,"div")(44,"label",13),r(45," Observaciones "),a(),l(46,"textarea",18),_e("ngModelChange",function(t){_(i);let n=u();return be(n.observations,t)||(n.observations=t),C(t)}),a()(),g(47,Wt,3,1,"div",19),a(),l(48,"div",20)(49,"button",21),E("click",function(){_(i);let t=u();return C(t.close())}),r(50," Cancelar "),a(),l(51,"button",22),E("click",function(){_(i);let t=u();return C(t.save())}),g(52,Yt,2,0,"span")(53,Qt,2,0,"span"),a()()()()}if(o&2){let i,e,t,n,d,m=u();s(8),f("Cuota #",(i=m.installment())==null?null:i.installmentNumber),s(9),f(" S/ ",H(18,17,(e=m.installment())==null?null:e.amount,"1.2-2")," "),s(6),f(" ",m.formatDate((t=m.installment())==null?null:t.dueDate)," "),s(4),D(m.getStatusBadgeClass(((n=m.installment())==null?null:n.status)||"PENDIENTE")),s(),f(" ",((d=m.installment())==null?null:d.statusDescription)||"Pendiente"," "),s(5),D(m.selectedStatus()==="COMPLETADO"?"bg-green-100 dark:bg-green-900/30 border-green-500 dark:border-green-600 text-green-900 dark:text-green-300":"bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 hover:border-green-400"),s(3),D(m.selectedStatus()==="VENCIDO"?"bg-red-100 dark:bg-red-900/30 border-red-500 dark:border-red-600 text-red-900 dark:text-red-300":"bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 hover:border-red-400"),s(3),D(m.selectedStatus()==="CANCELADO"?"bg-gray-100 dark:bg-gray-700/30 border-gray-500 dark:border-gray-600 text-gray-900 dark:text-gray-300":"bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 hover:border-gray-400"),s(3),h(m.selectedStatus()==="COMPLETADO"?42:-1),s(4),xe("ngModel",m.observations),s(),h(m.errorMessage()?47:-1),s(4),O("disabled",!m.canSave()||m.isSaving()),s(),h(m.isSaving()?52:53)}}var Nt=(()=>{let c=class c{constructor(e){this.paymentScheduleService=e,this.isOpen=b(!1),this.installment=b(null),this.managementId=b(0),this.selectedStatus=b(null),this.paymentDate="",this.amountPaid=null,this.observations="",this.isSaving=b(!1),this.errorMessage=b(null),this.canSave=U(()=>this.selectedStatus()?this.selectedStatus()==="COMPLETADO"?!!this.paymentDate&&this.amountPaid!==null&&this.amountPaid>0:!0:!1),ut(()=>{this.isOpen()||this.resetForm()})}open(e,t){this.installment.set(e),this.managementId.set(t),this.isOpen.set(!0),this.amountPaid=e.amount;let n=new Date,d=n.getFullYear(),m=String(n.getMonth()+1).padStart(2,"0"),p=String(n.getDate()).padStart(2,"0"),x=String(n.getHours()).padStart(2,"0"),v=String(n.getMinutes()).padStart(2,"0");this.paymentDate=`${d}-${m}-${p}T${x}:${v}`}close(){this.isOpen.set(!1)}resetForm(){this.selectedStatus.set(null),this.paymentDate="",this.amountPaid=null,this.observations="",this.errorMessage.set(null),this.installment.set(null),this.managementId.set(0)}save(){let e=this.installment();if(!e||!this.canSave())return;this.isSaving.set(!0),this.errorMessage.set(null);let t={status:this.selectedStatus(),observations:this.observations||void 0,registeredBy:"USUARIO"};this.selectedStatus()==="COMPLETADO"&&(t.paymentDate=this.paymentDate,t.amountPaid=this.amountPaid),this.paymentScheduleService.updateInstallmentStatus(e.id,t).subscribe({next:()=>{console.log("\u2705 Estado de cuota actualizado exitosamente"),this.isSaving.set(!1),this.close(),this.onSave&&this.onSave(!0)},error:n=>{console.error("\u274C Error actualizando estado de cuota:",n),this.errorMessage.set("Error al actualizar el estado. Intente nuevamente."),this.isSaving.set(!1),this.onSave&&this.onSave(!1)}})}formatDate(e){return e?new Date(e).toLocaleDateString("es-PE",{day:"2-digit",month:"2-digit",year:"numeric"}):"-"}getStatusBadgeClass(e){switch(e.toUpperCase()){case"COMPLETED":case"COMPLETADO":return"bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300 border border-green-300 dark:border-green-700";case"PENDING":case"PENDIENTE":return"bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300 border border-yellow-300 dark:border-yellow-700";case"OVERDUE":case"VENCIDO":return"bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300 border border-red-300 dark:border-red-700";case"CANCELLED":case"CANCELADO":return"bg-gray-100 dark:bg-gray-700/30 text-gray-800 dark:text-gray-300 border border-gray-300 dark:border-gray-600";default:return"bg-slate-100 dark:bg-slate-700 text-slate-800 dark:text-slate-300"}}};c.\u0275fac=function(t){return new(t||c)(V(we))},c.\u0275cmp=ne({type:c,selectors:[["app-installment-status-dialog"]],decls:1,vars:1,consts:[[1,"fixed","inset-0","z-50","flex","items-center","justify-center","p-4","bg-black/50","backdrop-blur-sm","animate-fadeIn"],[1,"bg-white","dark:bg-slate-900","rounded-xl","shadow-2xl","max-w-2xl","w-full","max-h-[90vh]","overflow-hidden","flex","flex-col","animate-slideInUp","border","border-slate-200","dark:border-slate-700"],[1,"bg-gradient-to-r","from-purple-600","to-purple-700","dark:from-purple-700","dark:to-purple-800","text-white","px-6","py-4","flex","items-center","justify-between"],[1,"flex","items-center","gap-3"],[1,"text-lg","font-bold"],[1,"text-sm","opacity-90"],["type","button",1,"p-2","hover:bg-white/20","rounded-lg","transition-colors",3,"click"],[1,"flex-1","overflow-y-auto","p-6","space-y-6"],[1,"bg-purple-50","dark:bg-purple-950/30","border","border-purple-200","dark:border-purple-800","rounded-lg","p-4"],[1,"grid","grid-cols-2","gap-4","text-sm"],[1,"text-slate-600","dark:text-slate-400"],[1,"font-bold","text-purple-900","dark:text-purple-200","ml-2"],[1,"ml-2","px-2","py-0.5","rounded","text-xs","font-bold"],[1,"block","text-sm","font-semibold","text-slate-700","dark:text-slate-300","mb-2"],[1,"grid","grid-cols-3","gap-3"],["type","button",1,"border-2","rounded-lg","p-4","flex","flex-col","items-center","gap-2","transition-all",3,"click"],[1,"text-sm","font-bold"],[1,"space-y-4","p-4","bg-green-50","dark:bg-green-950/20","border","border-green-200","dark:border-green-800","rounded-lg"],["rows","3","placeholder","Ingrese notas o comentarios adicionales...",1,"w-full","px-3","py-2","text-sm","border","border-slate-300","dark:border-slate-600","rounded-lg","bg-white","dark:bg-slate-800","text-slate-900","dark:text-slate-100","focus:ring-2","focus:ring-purple-500","dark:focus:ring-purple-600","focus:border-transparent","placeholder:text-slate-400","dark:placeholder:text-slate-500",3,"ngModelChange","ngModel"],[1,"bg-red-50","dark:bg-red-950/30","border","border-red-200","dark:border-red-800","text-red-900","dark:text-red-300","px-4","py-3","rounded-lg","flex","items-start","gap-2"],[1,"px-6","py-4","bg-slate-50","dark:bg-slate-800/50","border-t","border-slate-200","dark:border-slate-700","flex","justify-end","gap-3"],["type","button",1,"px-4","py-2","text-sm","font-semibold","text-slate-700","dark:text-slate-300","hover:bg-slate-200","dark:hover:bg-slate-700","rounded-lg","transition-colors",3,"click"],["type","button",1,"px-4","py-2","text-sm","font-semibold","text-white","bg-gradient-to-r","from-purple-600","to-purple-700","hover:from-purple-700","hover:to-purple-800","rounded-lg","transition-all","disabled:opacity-50","disabled:cursor-not-allowed","disabled:hover:from-purple-600","flex","items-center","gap-2",3,"click","disabled"],["type","datetime-local","required","",1,"w-full","px-3","py-2","text-sm","border","border-slate-300","dark:border-slate-600","rounded-lg","bg-white","dark:bg-slate-800","text-slate-900","dark:text-slate-100","focus:ring-2","focus:ring-green-500","dark:focus:ring-green-600","focus:border-transparent",3,"ngModelChange","ngModel"],[1,"relative"],[1,"absolute","left-3","top-2","text-slate-500","dark:text-slate-400"],["type","number","step","0.01","required","",1,"w-full","pl-10","pr-3","py-2","text-sm","border","border-slate-300","dark:border-slate-600","rounded-lg","bg-white","dark:bg-slate-800","text-slate-900","dark:text-slate-100","focus:ring-2","focus:ring-green-500","dark:focus:ring-green-600","focus:border-transparent",3,"ngModelChange","ngModel"],[1,"text-sm"]],template:function(t,n){t&1&&g(0,Kt,54,20,"div",0),t&2&&h(n.isOpen()?0:-1)},dependencies:[ie,De,bt,_t,Oe,yt,Le,se],styles:["@keyframes _ngcontent-%COMP%_fadeIn{0%{opacity:0}to{opacity:1}}@keyframes _ngcontent-%COMP%_slideInUp{0%{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.animate-fadeIn[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_fadeIn .2s ease-out}.animate-slideInUp[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_slideInUp .3s ease-out}"]});let o=c;return o})();var Jt=["statusDialog"],Rt=(o,c)=>c.id;function Zt(o,c){o&1&&(l(0,"div",9)(1,"div",10)(2,"span"),r(3,"Cargando estados..."),a()()())}function Xt(o,c){if(o&1&&(l(0,"div",31),r(1),a()),o&2){let i=u().$implicit,e=u(2);s(),f(" ",e.formatDateTime(i.latestStatus.actualPaymentDate)," ")}}function en(o,c){o&1&&(l(0,"div",36),r(1,"-"),a())}function tn(o,c){o&1&&(l(0,"div",43)(1,"span"),r(2,"Cargando historial..."),a()())}function nn(o,c){if(o&1&&(l(0,"span",48),r(1),G(2,"number"),a()),o&2){let i=u().$implicit;s(),f(" S/ ",H(2,1,i.amountPaid,"1.2-2")," ")}}function on(o,c){if(o&1&&(l(0,"div",49),r(1),a()),o&2){let i=u().$implicit;s(),f(" ",i.observations," ")}}function an(o,c){if(o&1&&(l(0,"div",44)(1,"div",45),r(2),a(),l(3,"div",46)(4,"span",47),r(5),a(),g(6,nn,3,4,"span",48),g(7,on,2,1,"div",49),a(),l(8,"div",50),r(9),a()()),o&2){let i=c.$implicit,e=u(5);s(2),f(" ",e.formatDateTime(i.changeDate)," "),s(2),D(e.getStatusBadgeClass(i.status)),s(),f(" ",i.statusDescription," "),s(),h(i.amountPaid?6:-1),s(),h(i.observations?7:-1),s(2),f(" ",i.registeredBy," ")}}function ln(o,c){if(o&1&&(l(0,"div",41),q(1,an,10,7,"div",44,Rt),a()),o&2){let i=u(4);s(),W(i.installmentHistory())}}function rn(o,c){if(o&1&&(l(0,"tr")(1,"td",40)(2,"div",41)(3,"div",42)(4,"span"),r(5,"Historial de Estados"),a()(),g(6,tn,3,0,"div",43)(7,ln,3,0,"div",41),a()()()),o&2){let i=u(3);s(6),h(i.isLoadingHistory()?6:i.installmentHistory()&&i.installmentHistory().length>0?7:-1)}}function sn(o,c){if(o&1){let i=N();l(0,"tr",26)(1,"td",27)(2,"div",28)(3,"div",29)(4,"span",30),r(5),a()()()(),l(6,"td",27)(7,"div",31),r(8),a()(),l(9,"td",32)(10,"div",33),r(11),G(12,"number"),a()(),l(13,"td",27)(14,"div",34)(15,"span",35),r(16),a()()(),l(17,"td",27),g(18,Xt,2,1,"div",31)(19,en,2,0,"div",36),a(),l(20,"td",27)(21,"div",37)(22,"button",38),E("click",function(){let t=_(i).$implicit,n=u(2);return C(n.openStatusDialog(t))}),a(),l(23,"button",39),E("click",function(){let t=_(i).$implicit,n=u(2);return C(n.toggleHistory(t.id))}),a()()()(),g(24,rn,8,1,"tr")}if(o&2){let i=c.$implicit,e=u(2);s(5),f(" ",i.installmentNumber," "),s(3),f(" ",e.formatDate(i.dueDate)," "),s(3),f(" S/ ",H(12,10,i.amount,"1.2-2")," "),s(4),D(e.getStatusBadgeClass((i.latestStatus==null?null:i.latestStatus.status)||"PENDIENTE")),s(),f(" ",(i.latestStatus==null?null:i.latestStatus.statusDescription)||"Pendiente"," "),s(2),h(i.latestStatus!=null&&i.latestStatus.actualPaymentDate?18:19),s(5),D(e.expandedHistory()===i.id?"bg-slate-200 dark:bg-slate-700":"hover:bg-slate-100 dark:hover:bg-slate-800"),s(),h(e.expandedHistory()===i.id&&e.installmentHistory()?24:-1)}}function dn(o,c){if(o&1&&(l(0,"div",11)(1,"table",12)(2,"thead",13)(3,"tr")(4,"th",14),r(5,"#"),a(),l(6,"th",14),r(7,"Fecha Vencimiento"),a(),l(8,"th",15),r(9,"Monto"),a(),l(10,"th",16),r(11,"Estado"),a(),l(12,"th",14),r(13,"Fecha Pago"),a(),l(14,"th",16),r(15,"Acciones"),a()()(),l(16,"tbody",17),q(17,sn,25,13,null,null,Rt),a()()(),l(19,"div",18)(20,"div",19)(21,"div",20)(22,"div",21),r(23,"Completadas"),a(),l(24,"div",22),r(25),a()(),l(26,"div",20)(27,"div",21),r(28,"Pendientes"),a(),l(29,"div",23),r(30),a()(),l(31,"div",20)(32,"div",21),r(33,"Vencidas"),a(),l(34,"div",24),r(35),a()(),l(36,"div",20)(37,"div",21),r(38,"Canceladas"),a(),l(39,"div",25),r(40),a()()()()),o&2){let i=u();s(17),W(i.installmentsWithStatus()),s(8),f(" ",i.summaryStats().completed," "),s(5),f(" ",i.summaryStats().pending," "),s(5),f(" ",i.summaryStats().overdue," "),s(5),f(" ",i.summaryStats().cancelled," ")}}var Vt=(()=>{let c=class c{constructor(e){this.paymentScheduleService=e,this.managementId=0,this.schedule=b(null),this.latestStatuses=b([]),this.isLoading=b(!1),this.expandedHistory=b(null),this.installmentHistory=b(null),this.isLoadingHistory=b(!1),this.installmentsWithStatus=U(()=>{let t=this.schedule(),n=this.latestStatuses();return t?t.installments.map(d=>{let m=n.find(p=>p.installmentId===d.id);return pe(Z({},d),{latestStatus:m})}):[]}),this.summaryStats=U(()=>{let t=this.installmentsWithStatus();return{completed:t.filter(n=>["COMPLETED","COMPLETADO"].includes(n.latestStatus?.status||"")).length,pending:t.filter(n=>["PENDING","PENDIENTE"].includes(n.latestStatus?.status||"")).length,overdue:t.filter(n=>["OVERDUE","VENCIDO"].includes(n.latestStatus?.status||"")).length,cancelled:t.filter(n=>["CANCELLED","CANCELADO"].includes(n.latestStatus?.status||"")).length}})}ngOnChanges(e){e.managementId&&this.managementId&&this.loadSchedule()}loadSchedule(){this.isLoading.set(!0),this.paymentScheduleService.getPaymentScheduleByManagementId(this.managementId).subscribe({next:e=>{console.log("\u{1F4CA} Cronograma cargado:",e),this.schedule.set(e),this.loadLatestStatuses()},error:e=>{console.error("\u274C Error cargando cronograma:",e),this.isLoading.set(!1)}})}loadLatestStatuses(){this.paymentScheduleService.getLatestStatusByManagement(this.managementId).subscribe({next:e=>{console.log("\u{1F4CB} Estados m\xE1s recientes cargados:",e),this.latestStatuses.set(e),this.isLoading.set(!1)},error:e=>{console.error("\u274C Error cargando estados:",e),this.isLoading.set(!1)}})}openStatusDialog(e){this.statusDialog.open(e,this.managementId),this.statusDialog.onSave=t=>{t&&(this.loadLatestStatuses(),this.expandedHistory()===e.id&&this.loadInstallmentHistory(e.id))}}toggleHistory(e){this.expandedHistory()===e?(this.expandedHistory.set(null),this.installmentHistory.set(null)):(this.expandedHistory.set(e),this.loadInstallmentHistory(e))}loadInstallmentHistory(e){this.isLoadingHistory.set(!0),this.paymentScheduleService.getInstallmentHistory(e).subscribe({next:t=>{console.log("\u{1F4DC} Historial de cuota cargado:",t),this.installmentHistory.set(t),this.isLoadingHistory.set(!1)},error:t=>{console.error("\u274C Error cargando historial:",t),this.isLoadingHistory.set(!1)}})}formatDate(e){return new Date(e).toLocaleDateString("es-PE",{day:"2-digit",month:"2-digit",year:"numeric"})}formatDateTime(e){return new Date(e).toLocaleString("es-PE",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}getStatusBadgeClass(e){switch(e.toUpperCase()){case"COMPLETED":case"COMPLETADO":return"bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300 border border-green-300 dark:border-green-700";case"PENDING":case"PENDIENTE":return"bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300 border border-yellow-300 dark:border-yellow-700";case"OVERDUE":case"VENCIDO":return"bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300 border border-red-300 dark:border-red-700";case"CANCELLED":case"CANCELADO":return"bg-gray-100 dark:bg-gray-700/30 text-gray-800 dark:text-gray-300 border border-gray-300 dark:border-gray-600";default:return"bg-slate-100 dark:bg-slate-700 text-slate-800 dark:text-slate-300"}}};c.\u0275fac=function(t){return new(t||c)(V(we))},c.\u0275cmp=ne({type:c,selectors:[["app-payment-schedule-view"]],viewQuery:function(t,n){if(t&1&&Ae(Jt,5),t&2){let d;Fe(d=Ne())&&(n.statusDialog=d.first)}},inputs:{managementId:"managementId"},features:[Ie],decls:19,vars:7,consts:[["statusDialog",""],[1,"bg-white","dark:bg-slate-900","rounded-xl","shadow-lg","border","border-slate-200","dark:border-slate-700","overflow-hidden"],[1,"bg-gradient-to-r","from-purple-600","to-purple-700","dark:from-purple-700","dark:to-purple-800","text-white","px-6","py-4"],[1,"flex","items-center","justify-between"],[1,"flex","items-center","gap-3"],[1,"text-lg","font-bold"],[1,"text-sm","opacity-90"],[1,"text-right"],[1,"text-2xl","font-bold"],[1,"p-8","flex","items-center","justify-center"],[1,"flex","items-center","gap-3","text-slate-600","dark:text-slate-400"],[1,"overflow-x-auto"],[1,"w-full"],[1,"bg-slate-50","dark:bg-slate-800/50","border-b","border-slate-200","dark:border-slate-700"],[1,"px-4","py-3","text-left","text-xs","font-bold","text-slate-700","dark:text-slate-300","uppercase","tracking-wider"],[1,"px-4","py-3","text-right","text-xs","font-bold","text-slate-700","dark:text-slate-300","uppercase","tracking-wider"],[1,"px-4","py-3","text-center","text-xs","font-bold","text-slate-700","dark:text-slate-300","uppercase","tracking-wider"],[1,"divide-y","divide-slate-200","dark:divide-slate-700"],[1,"px-6","py-4","bg-slate-50","dark:bg-slate-800/50","border-t","border-slate-200","dark:border-slate-700"],[1,"grid","grid-cols-4","gap-4","text-sm"],[1,"text-center"],[1,"text-slate-600","dark:text-slate-400","mb-1"],[1,"text-2xl","font-bold","text-green-600","dark:text-green-400"],[1,"text-2xl","font-bold","text-yellow-600","dark:text-yellow-400"],[1,"text-2xl","font-bold","text-red-600","dark:text-red-400"],[1,"text-2xl","font-bold","text-gray-600","dark:text-gray-400"],[1,"hover:bg-slate-50","dark:hover:bg-slate-800/50","transition-colors"],[1,"px-4","py-3"],[1,"flex","items-center","gap-2"],[1,"w-8","h-8","rounded-full","bg-purple-100","dark:bg-purple-900/30","flex","items-center","justify-center"],[1,"text-xs","font-bold","text-purple-700","dark:text-purple-300"],[1,"text-sm","text-slate-900","dark:text-slate-100"],[1,"px-4","py-3","text-right"],[1,"text-sm","font-bold","text-slate-900","dark:text-slate-100"],[1,"flex","justify-center"],[1,"px-2","py-1","rounded","text-xs","font-bold"],[1,"text-sm","text-slate-400","dark:text-slate-500"],[1,"flex","items-center","justify-center","gap-2"],["type","button","title","Actualizar estado",1,"p-1.5","hover:bg-purple-100","dark:hover:bg-purple-900/30","rounded","transition-colors",3,"click"],["type","button","title","Ver historial",1,"p-1.5","rounded","transition-colors",3,"click"],["colspan","6",1,"px-4","py-3","bg-slate-50","dark:bg-slate-800/50"],[1,"space-y-2"],[1,"flex","items-center","gap-2","text-sm","font-bold","text-slate-700","dark:text-slate-300","mb-2"],[1,"flex","items-center","gap-2","text-sm","text-slate-600","dark:text-slate-400","py-2"],[1,"flex","items-start","gap-3","text-xs","p-2","bg-white","dark:bg-slate-900","rounded","border","border-slate-200","dark:border-slate-700"],[1,"flex-shrink-0","w-24","text-slate-600","dark:text-slate-400"],[1,"flex-1"],[1,"px-2","py-0.5","rounded","font-bold"],[1,"ml-2","text-slate-700","dark:text-slate-300"],[1,"mt-1","text-slate-600","dark:text-slate-400"],[1,"flex-shrink-0","text-slate-500","dark:text-slate-500"]],template:function(t,n){if(t&1&&(l(0,"div",1)(1,"div",2)(2,"div",3)(3,"div",4)(4,"div")(5,"h3",5),r(6,"Cronograma de Pagos"),a(),l(7,"p",6),r(8),a()()(),l(9,"div",7)(10,"div",6),r(11,"Monto Total"),a(),l(12,"div",8),r(13),G(14,"number"),a()()()(),g(15,Zt,4,0,"div",9),g(16,dn,41,4),a(),B(17,"app-installment-status-dialog",null,0)),t&2){let d;s(8),f("",n.installmentsWithStatus().length," cuotas programadas"),s(5),f("S/ ",H(14,4,(d=n.schedule())==null?null:d.totalAmount,"1.2-2")),s(2),h(n.isLoading()?15:-1),s(),h(!n.isLoading()&&n.installmentsWithStatus().length>0?16:-1)}},dependencies:[ie,Nt,se],encapsulation:2});let o=c;return o})();var mn=(o,c)=>c.idUsuario;function un(o,c){o&1&&(Y(0,"div",6),mt(1,"div",11),Y(2,"p"),r(3,"Buscando supervisores en l\xEDnea..."),Q()())}function pn(o,c){if(o&1){let i=N();Y(0,"div",7)(1,"span",12),r(2,"\u26A0\uFE0F"),Q(),Y(3,"p",13),r(4,"No hay supervisores en l\xEDnea"),Q(),Y(5,"p",14),r(6,"Intenta de nuevo m\xE1s tarde o contacta a un administrador"),Q(),Y(7,"button",15),he("click",function(){_(i);let t=u(2);return C(t.cargarSupervisores())}),r(8," \u{1F504} Reintentar "),Q()()}}function gn(o,c){if(o&1&&(Y(0,"span",28),r(1),Q()),o&2){let i=u().$implicit;s(),f(" ",i.solicitudesPendientes," pendiente(s) ")}}function hn(o,c){if(o&1){let i=N();Y(0,"div",19),he("click",function(){let t=_(i).$implicit,n=u(3);return C(n.selectSupervisor(t))}),Y(1,"div",20)(2,"input",21),he("change",function(){let t=_(i).$implicit,n=u(3);return C(n.selectSupervisor(t))}),Q()(),Y(3,"div",22)(4,"div",23)(5,"span",24),r(6,"\u{1F464}"),Q(),r(7),Q(),Y(8,"div",25)(9,"span",26),r(10),Q(),Y(11,"span",27),r(12),Q(),g(13,gn,2,1,"span",28),Q()()()}if(o&2){let i=c.$implicit,e=u(3);at("selected",(e.supervisorSeleccionado==null?null:e.supervisorSeleccionado.idUsuario)===i.idUsuario),s(2),ot("name","supervisor")("value",i.idUsuario)("checked",(e.supervisorSeleccionado==null?null:e.supervisorSeleccionado.idUsuario)===i.idUsuario),s(5),f(" ",i.nombreCompleto," "),s(2),at("admin",i.rol==="ADMIN"),s(),f(" ",i.rol," "),s(),D(e.getEstadoClass(i.estado)),s(),f(" ",i.estado," "),s(),h(i.solicitudesPendientes&&i.solicitudesPendientes>0?13:-1)}}function fn(o,c){if(o&1&&(Y(0,"p",16),r(1,"Selecciona a qui\xE9n enviar la solicitud de autorizaci\xF3n:"),Q(),Y(2,"div",17),q(3,hn,14,13,"div",18,mn),Q()),o&2){let i=u(2);s(3),W(i.supervisores())}}function xn(o,c){if(o&1){let i=N();Y(0,"div",1),he("click",function(t){_(i);let n=u();return C(n.onOverlayClick(t))}),Y(1,"div",2)(2,"div",3)(3,"h2"),r(4,"\u{1F510} Seleccionar Supervisor para Autorizaci\xF3n"),Q(),Y(5,"button",4),he("click",function(){_(i);let t=u();return C(t.onCancel())}),r(6,"\xD7"),Q()(),Y(7,"div",5),g(8,un,4,0,"div",6)(9,pn,9,0,"div",7)(10,fn,5,0),Q(),Y(11,"div",8)(12,"button",9),he("click",function(){_(i);let t=u();return C(t.onCancel())}),r(13," Cancelar "),Q(),Y(14,"button",10),he("click",function(){_(i);let t=u();return C(t.onConfirm())}),r(15," \u{1F4E4} Enviar Solicitud "),Q()()()()}if(o&2){let i=u();s(8),h(i.cargando()?8:i.supervisores().length===0?9:10),s(6),ot("disabled",!i.supervisorSeleccionado||i.cargando())}}var Ot=(()=>{let c=class c{constructor(e){this.autorizacionService=e,this.visible=!1,this.visibleChange=new Te,this.supervisorSelected=new Te,this.cancelled=new Te,this.supervisores=b([]),this.cargando=b(!1),this.supervisorSeleccionado=null}ngOnInit(){}ngOnChanges(e){e.visible&&e.visible.currentValue===!0&&this.cargarSupervisores()}cargarSupervisores(){this.cargando.set(!0),this.autorizacionService.obtenerSupervisoresEnLinea().subscribe({next:e=>{this.supervisores.set(e),this.cargando.set(!1)},error:e=>{console.error("[SELECT-SUPERVISOR] Error al cargar supervisores:",e),this.cargando.set(!1)}})}selectSupervisor(e){this.supervisorSeleccionado=e}getEstadoClass(e){switch(e){case"DISPONIBLE":case"CONECTADO":return"disponible";case"EN_LLAMADA":return"en-llamada";case"DESCONECTADO":return"desconectado";default:return""}}onOverlayClick(e){e.target.classList.contains("modal-overlay")&&this.onCancel()}onConfirm(){this.supervisorSeleccionado&&(this.supervisorSelected.emit(this.supervisorSeleccionado),this.closeModal())}onCancel(){this.cancelled.emit(),this.closeModal()}closeModal(){this.visible=!1,this.visibleChange.emit(!1),this.supervisorSeleccionado=null}};c.\u0275fac=function(t){return new(t||c)(V(Qe))},c.\u0275cmp=ne({type:c,selectors:[["app-select-supervisor-modal"]],inputs:{visible:"visible"},outputs:{visibleChange:"visibleChange",supervisorSelected:"supervisorSelected",cancelled:"cancelled"},features:[Ie],decls:1,vars:1,consts:[[1,"modal-overlay"],[1,"modal-overlay",3,"click"],[1,"modal-container"],[1,"modal-header"],[1,"close-btn",3,"click"],[1,"modal-content"],[1,"loading-container"],[1,"no-supervisors"],[1,"modal-footer"],[1,"btn","btn-cancel",3,"click"],[1,"btn","btn-primary",3,"click","disabled"],[1,"spinner"],[1,"warning-icon"],[1,"title"],[1,"subtitle"],[1,"retry-btn",3,"click"],[1,"instruction"],[1,"supervisors-list"],[1,"supervisor-card",3,"selected"],[1,"supervisor-card",3,"click"],[1,"radio-container"],["type","radio",3,"change","name","value","checked"],[1,"supervisor-info"],[1,"name"],[1,"user-icon"],[1,"details"],[1,"rol-badge"],[1,"estado-badge"],[1,"pendientes-badge"]],template:function(t,n){t&1&&g(0,xn,16,2,"div",0),t&2&&h(n.visible?0:-1)},dependencies:[ie,De],styles:[".modal-overlay[_ngcontent-%COMP%]{position:fixed;inset:0;background:#00000080;display:flex;align-items:center;justify-content:center;z-index:10000;animation:_ngcontent-%COMP%_fadeIn .2s ease-out}@keyframes _ngcontent-%COMP%_fadeIn{0%{opacity:0}to{opacity:1}}.modal-container[_ngcontent-%COMP%]{background:#fff;border-radius:12px;box-shadow:0 20px 60px #0000004d;width:90%;max-width:550px;max-height:90vh;display:flex;flex-direction:column;animation:_ngcontent-%COMP%_slideUp .3s ease-out}@keyframes _ngcontent-%COMP%_slideUp{0%{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.modal-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.5rem;border-bottom:1px solid #e5e7eb;background:linear-gradient(135deg,#3b82f6,#1d4ed8);border-radius:12px 12px 0 0;color:#fff}.modal-header[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0;font-size:1.1rem;font-weight:600}.close-btn[_ngcontent-%COMP%]{background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;padding:0;line-height:1;opacity:.8;transition:opacity .2s}.close-btn[_ngcontent-%COMP%]:hover{opacity:1}.modal-content[_ngcontent-%COMP%]{padding:1.5rem;overflow-y:auto;flex:1;min-height:200px}.loading-container[_ngcontent-%COMP%], .no-supervisors[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:200px;text-align:center}.spinner[_ngcontent-%COMP%]{width:40px;height:40px;border:3px solid #e5e7eb;border-top-color:#3b82f6;border-radius:50%;animation:_ngcontent-%COMP%_spin 1s linear infinite;margin-bottom:1rem}@keyframes _ngcontent-%COMP%_spin{to{transform:rotate(360deg)}}.warning-icon[_ngcontent-%COMP%]{font-size:3rem;margin-bottom:1rem}.no-supervisors[_ngcontent-%COMP%]   .title[_ngcontent-%COMP%]{font-size:1.1rem;font-weight:600;color:#374151;margin:0 0 .5rem}.no-supervisors[_ngcontent-%COMP%]   .subtitle[_ngcontent-%COMP%]{color:#6b7280;margin:0 0 1rem}.retry-btn[_ngcontent-%COMP%]{padding:.5rem 1rem;border:1px solid #3b82f6;background:#fff;color:#3b82f6;border-radius:6px;cursor:pointer;transition:all .2s}.retry-btn[_ngcontent-%COMP%]:hover{background:#eff6ff}.instruction[_ngcontent-%COMP%]{color:#6b7280;margin:0 0 1rem;font-size:.875rem}.supervisors-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.75rem}.supervisor-card[_ngcontent-%COMP%]{display:flex;align-items:center;gap:1rem;padding:1rem;border:2px solid #e5e7eb;border-radius:10px;cursor:pointer;transition:all .2s}.supervisor-card[_ngcontent-%COMP%]:hover{border-color:#93c5fd;background:#f0f9ff}.supervisor-card.selected[_ngcontent-%COMP%]{border-color:#3b82f6;background:#eff6ff}.radio-container[_ngcontent-%COMP%]{flex-shrink:0}.radio-container[_ngcontent-%COMP%]   input[type=radio][_ngcontent-%COMP%]{width:18px;height:18px;accent-color:#3b82f6;cursor:pointer}.supervisor-info[_ngcontent-%COMP%]{flex:1}.name[_ngcontent-%COMP%]{font-weight:600;color:#1f2937;display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem}.user-icon[_ngcontent-%COMP%]{font-size:1rem}.details[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:.5rem}.rol-badge[_ngcontent-%COMP%]{padding:.2rem .5rem;border-radius:4px;font-size:.7rem;font-weight:600;text-transform:uppercase;background:#dbeafe;color:#1d4ed8}.rol-badge.admin[_ngcontent-%COMP%]{background:#fee2e2;color:#dc2626}.estado-badge[_ngcontent-%COMP%]{padding:.2rem .5rem;border-radius:4px;font-size:.7rem;font-weight:600}.estado-badge.disponible[_ngcontent-%COMP%]{background:#dcfce7;color:#166534}.estado-badge.en-llamada[_ngcontent-%COMP%]{background:#fef3c7;color:#92400e}.estado-badge.desconectado[_ngcontent-%COMP%]{background:#fee2e2;color:#dc2626}.pendientes-badge[_ngcontent-%COMP%]{padding:.2rem .5rem;border-radius:4px;font-size:.7rem;font-weight:600;background:#fef3c7;color:#92400e}.modal-footer[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:.75rem;padding:1rem 1.5rem;border-top:1px solid #e5e7eb;background:#f9fafb;border-radius:0 0 12px 12px}.btn[_ngcontent-%COMP%]{padding:.625rem 1.25rem;border-radius:8px;font-weight:500;cursor:pointer;transition:all .2s}.btn-cancel[_ngcontent-%COMP%]{background:#fff;border:1px solid #d1d5db;color:#374151}.btn-cancel[_ngcontent-%COMP%]:hover{background:#f3f4f6}.btn-primary[_ngcontent-%COMP%]{background:#3b82f6;border:none;color:#fff}.btn-primary[_ngcontent-%COMP%]:hover:not(:disabled){background:#2563eb}.btn-primary[_ngcontent-%COMP%]:disabled{background:#93c5fd;cursor:not-allowed}"]});let o=c;return o})();var Pe=(()=>{let c=class c{constructor(){this.http=Me(oe),this.baseUrl=`${K.apiUrl}/v2/comprobantes`}uploadComprobante(e,t){let n=new FormData;return n.append("file",e),n.append("idCuota",t.idCuota.toString()),n.append("idAgente",t.idAgente.toString()),t.montoEsperado!==void 0&&n.append("montoEsperado",t.montoEsperado.toString()),t.documentoEsperado&&n.append("documentoEsperado",t.documentoEsperado),t.nombreEsperado&&n.append("nombreEsperado",t.nombreEsperado),t.idGestion!==void 0&&n.append("idGestion",t.idGestion.toString()),t.descripcion&&n.append("descripcion",t.descripcion),t.validarConOcr!==void 0&&n.append("validarConOcr",t.validarConOcr.toString()),this.http.post(`${this.baseUrl}/upload`,n)}getComprobantesByCuota(e){return this.http.get(`${this.baseUrl}/cuota/${e}`)}asociarAGestion(e,t){return this.http.post(`${this.baseUrl}/${e}/asociar-gestion/${t}`,{})}};c.\u0275fac=function(t){return new(t||c)},c.\u0275prov=te({token:c,factory:c.\u0275fac,providedIn:"root"});let o=c;return o})();function vn(o,c){if(o&1){let i=N();l(0,"div",23),E("click",function(){_(i);let t=Re(13);return C(t.click())})("dragover",function(t){_(i);let n=u();return C(n.onDragOver(t))})("drop",function(t){_(i);let n=u();return C(n.onDrop(t))}),l(1,"div",24)(2,"mat-icon",25),r(3,"cloud_upload"),a()(),l(4,"p",26),r(5,"Arrastra una imagen aqu\xED"),a(),l(6,"p",27),r(7," o "),l(8,"span",28),r(9,"haz clic para seleccionar"),a()(),l(10,"p",29),r(11,"JPG, PNG, WebP - M\xE1ximo 5MB"),a()(),l(12,"input",30,0),E("change",function(t){_(i);let n=u();return C(n.onFileSelected(t))}),a()}}function Sn(o,c){if(o&1){let i=N();l(0,"div",15),B(1,"img",31),l(2,"button",32),E("click",function(){_(i);let t=u();return C(t.removeFile())}),l(3,"mat-icon",33),r(4,"close"),a()(),l(5,"div",34)(6,"p",35)(7,"mat-icon",36),r(8,"insert_drive_file"),a(),l(9,"span",37),r(10),a(),l(11,"span",38),r(12,"-"),a(),l(13,"span",39),r(14),a()()()()}if(o&2){let i,e,t=u();s(),O("src",t.previewUrl(),Ee),s(9),S((i=t.selectedFile())==null?null:i.name),s(4),S(t.formatFileSize(((e=t.selectedFile())==null?null:e.size)||0))}}function yn(o,c){o&1&&(l(0,"div",16)(1,"div",40),B(2,"div",41)(3,"mat-spinner",42),l(4,"div",43)(5,"mat-icon",44),r(6,"document_scanner"),a()()(),l(7,"p",45),r(8,"Analizando con IA..."),a(),l(9,"div",46),B(10,"span",47)(11,"span",48)(12,"span",49),a()())}function En(o,c){if(o&1&&(l(0,"mat-icon",79),r(1),a()),o&2){let i,e,t=u(3);D(!((i=t.uploadResponse())==null||i.validacionMonto==null)&&i.validacionMonto.coincide?"text-green-500":"text-amber-500"),s(),f(" ",!((e=t.uploadResponse())==null||e.validacionMonto==null)&&e.validacionMonto.coincide?"check_circle":"warning"," ")}}function Dn(o,c){if(o&1&&(l(0,"p",80)(1,"mat-icon",81),r(2),a(),r(3),a()),o&2){let i,e,t,n=u(3);D(!((i=n.uploadResponse())==null||i.validacionMonto==null)&&i.validacionMonto.coincide?"text-green-600 dark:text-green-400":"text-amber-600 dark:text-amber-400"),s(2),S(!((e=n.uploadResponse())==null||e.validacionMonto==null)&&e.validacionMonto.coincide?"check":"priority_high"),s(),f(" ",!((t=n.uploadResponse())==null||t.validacionMonto==null)&&t.validacionMonto.coincide?"OK":"No coincide"," ")}}function kn(o,c){if(o&1&&(l(0,"mat-icon",79),r(1),a()),o&2){let i,e,t=u(3);D(!((i=t.uploadResponse())==null||i.validacionDocumento==null)&&i.validacionDocumento.coincide?"text-green-500":"text-amber-500"),s(),f(" ",!((e=t.uploadResponse())==null||e.validacionDocumento==null)&&e.validacionDocumento.coincide?"check_circle":"warning"," ")}}function wn(o,c){if(o&1&&(l(0,"p",80)(1,"mat-icon",81),r(2),a(),r(3),a()),o&2){let i,e,t,n=u(3);D(!((i=n.uploadResponse())==null||i.validacionDocumento==null)&&i.validacionDocumento.coincide?"text-green-600 dark:text-green-400":"text-amber-600 dark:text-amber-400"),s(2),S(!((e=n.uploadResponse())==null||e.validacionDocumento==null)&&e.validacionDocumento.coincide?"check":"priority_high"),s(),f(" ",!((t=n.uploadResponse())==null||t.validacionDocumento==null)&&t.validacionDocumento.coincide?"OK":"No coincide"," ")}}function Pn(o,c){if(o&1&&(l(0,"mat-icon",79),r(1),a()),o&2){let i,e,t=u(3);D(!((i=t.uploadResponse())==null||i.validacionNombre==null)&&i.validacionNombre.coincide?"text-green-500":"text-amber-500"),s(),f(" ",!((e=t.uploadResponse())==null||e.validacionNombre==null)&&e.validacionNombre.coincide?"check_circle":"warning"," ")}}function Mn(o,c){if(o&1&&(l(0,"p",80)(1,"mat-icon",81),r(2),a(),r(3),a()),o&2){let i,e,t,n=u(3);D(!((i=n.uploadResponse())==null||i.validacionNombre==null)&&i.validacionNombre.coincide?"text-green-600 dark:text-green-400":"text-amber-600 dark:text-amber-400"),s(2),S(!((e=n.uploadResponse())==null||e.validacionNombre==null)&&e.validacionNombre.coincide?"check":"priority_high"),s(),f(" ",!((t=n.uploadResponse())==null||t.validacionNombre==null)&&t.validacionNombre.coincide?"OK":"No coincide"," ")}}function In(o,c){if(o&1&&(l(0,"div",83)(1,"mat-icon",84),r(2,"account_balance"),a(),l(3,"span",85),r(4),a()()),o&2){let i,e=u(4);s(4),S((i=e.uploadResponse())==null||i.ocrResult==null?null:i.ocrResult.banco)}}function Tn(o,c){if(o&1&&(l(0,"div",83)(1,"mat-icon",84),r(2,"tag"),a(),l(3,"span",85),r(4),a()()),o&2){let i,e=u(4);s(4),S((i=e.uploadResponse())==null||i.ocrResult==null?null:i.ocrResult.numeroOperacion)}}function An(o,c){if(o&1&&(l(0,"div",83)(1,"mat-icon",84),r(2,"event"),a(),l(3,"span",85),r(4),a()()),o&2){let i,e=u(4);s(4),S((i=e.uploadResponse())==null||i.ocrResult==null?null:i.ocrResult.fecha)}}function Fn(o,c){if(o&1&&(l(0,"div",78)(1,"div",82),g(2,In,5,1,"div",83),g(3,Tn,5,1,"div",83),g(4,An,5,1,"div",83),a()()),o&2){let i,e,t,n=u(3);s(2),h(!((i=n.uploadResponse())==null||i.ocrResult==null)&&i.ocrResult.banco?2:-1),s(),h(!((e=n.uploadResponse())==null||e.ocrResult==null)&&e.ocrResult.numeroOperacion?3:-1),s(),h(!((t=n.uploadResponse())==null||t.ocrResult==null)&&t.ocrResult.fecha?4:-1)}}function Nn(o,c){if(o&1&&(l(0,"div",70)(1,"div",71)(2,"div",72)(3,"span",73),r(4,"Monto"),a(),g(5,En,2,3,"mat-icon",74),a(),l(6,"p",75),r(7),G(8,"number"),a(),g(9,Dn,4,4,"p",76),a(),l(10,"div",71)(11,"div",72)(12,"span",73),r(13,"Documento"),a(),g(14,kn,2,3,"mat-icon",74),a(),l(15,"p",77),r(16),a(),g(17,wn,4,4,"p",76),a(),l(18,"div",71)(19,"div",72)(20,"span",73),r(21,"Nombre"),a(),g(22,Pn,2,3,"mat-icon",74),a(),l(23,"p",77),r(24),a(),g(25,Mn,4,4,"p",76),a()(),g(26,Fn,5,3,"div",78)),o&2){let i,e,t,n,d,m,p,x,v,y,M,j,$,F=u(2);s(),D(F.getValidationCardClass((i=F.uploadResponse())==null?null:i.validacionMonto)),s(4),h((e=F.uploadResponse())!=null&&e.validacionMonto?5:-1),s(2),f("S/ ",H(8,16,(t=F.uploadResponse())==null||t.ocrResult==null?null:t.ocrResult.monto,"1.2-2")),s(2),h((n=F.uploadResponse())!=null&&n.validacionMonto?9:-1),s(),D(F.getValidationCardClass((d=F.uploadResponse())==null?null:d.validacionDocumento)),s(4),h((m=F.uploadResponse())!=null&&m.validacionDocumento?14:-1),s(2),S(((p=F.uploadResponse())==null||p.ocrResult==null?null:p.ocrResult.documento)||"-"),s(),h((x=F.uploadResponse())!=null&&x.validacionDocumento?17:-1),s(),D(F.getValidationCardClass((v=F.uploadResponse())==null?null:v.validacionNombre)),s(4),h((y=F.uploadResponse())!=null&&y.validacionNombre?22:-1),s(2),S(((M=F.uploadResponse())==null||M.ocrResult==null?null:M.ocrResult.nombre)||"-"),s(),h((j=F.uploadResponse())!=null&&j.validacionNombre?25:-1),s(),h(!(($=F.uploadResponse())==null||$.ocrResult==null)&&$.ocrResult.banco||!(($=F.uploadResponse())==null||$.ocrResult==null)&&$.ocrResult.numeroOperacion||!(($=F.uploadResponse())==null||$.ocrResult==null)&&$.ocrResult.fecha?26:-1)}}function Rn(o,c){o&1&&(l(0,"div",57)(1,"mat-icon",86),r(2,"info"),a(),l(3,"p",87),r(4,"Comprobante guardado sin validaci\xF3n OCR"),a()())}function Vn(o,c){o&1&&(l(0,"div",58)(1,"mat-icon",88),r(2,"warning"),a(),l(3,"div")(4,"p",89),r(5,"Hay diferencias en la validaci\xF3n"),a(),l(6,"p",90),r(7,"Verifica visualmente el comprobante."),a()()())}function On(o,c){if(o&1){let i=N();l(0,"div",17)(1,"div",50)(2,"div",51)(3,"div",52)(4,"mat-icon",53),r(5),a()(),l(6,"div",54)(7,"p",55),r(8),a(),l(9,"p",56),r(10),a()()(),g(11,Nn,27,19)(12,Rn,5,0,"div",57),g(13,Vn,8,0,"div",58),a(),l(14,"div",59)(15,"div",60)(16,"div",61)(17,"span",62),r(18,"Comprobante"),a(),l(19,"div",63)(20,"button",64),E("click",function(){_(i);let t=u();return C(t.zoomOut())}),l(21,"mat-icon",65),r(22,"remove"),a()(),l(23,"span",66),r(24),G(25,"number"),a(),l(26,"button",64),E("click",function(){_(i);let t=u();return C(t.zoomIn())}),l(27,"mat-icon",65),r(28,"add"),a()(),l(29,"button",67),E("click",function(){_(i);let t=u();return C(t.resetZoom())}),l(30,"mat-icon",65),r(31,"fit_screen"),a()()()(),l(32,"div",68),E("wheel",function(t){_(i);let n=u();return C(n.onWheel(t))}),B(33,"img",69),a()()()()}if(o&2){let i,e,t=u();s(2),D(t.getResultBgClass()),s(),D(t.getResultIconBgClass()),s(2),S(t.getResultIcon()),s(3),S(t.getResultTitle()),s(2),S((i=t.uploadResponse())==null?null:i.mensaje),s(),h(!((e=t.uploadResponse())==null||e.ocrResult==null)&&e.ocrResult.success?11:(e=t.uploadResponse())!=null&&e.ocrResult&&!(!((e=t.uploadResponse())==null||e.ocrResult==null)&&e.ocrResult.success)?12:-1),s(2),h(t.showWarning()?13:-1),s(7),O("disabled",t.zoomLevel()<=.5),s(4),f("",H(25,17,t.zoomLevel()*100,"1.0-0"),"%"),s(2),O("disabled",t.zoomLevel()>=3),s(7),Ve("transform","scale("+t.zoomLevel()+")")("transform-origin","top left"),O("src",t.previewUrl(),Ee)}}function Ln(o,c){if(o&1&&(l(0,"div",18)(1,"mat-icon",91),r(2,"error"),a(),l(3,"p",92),r(4),a()()),o&2){let i=u();s(4),S(i.errorMessage())}}function Un(o,c){o&1&&B(0,"mat-spinner",94)}function Bn(o,c){o&1&&(l(0,"mat-icon",95),r(1,"upload"),a())}function $n(o,c){if(o&1){let i=N();l(0,"button",93),E("click",function(){_(i);let t=u();return C(t.upload())}),g(1,Un,1,0,"mat-spinner",94)(2,Bn,2,0,"mat-icon",95),r(3," Subir y Validar "),a()}if(o&2){let i=u();O("disabled",!i.selectedFile()||i.isUploading()),s(),h(i.isUploading()?1:2)}}function zn(o,c){if(o&1){let i=N();l(0,"button",96),E("click",function(){_(i);let t=u();return C(t.confirm())}),l(1,"mat-icon",95),r(2),a(),r(3),a()}if(o&2){let i=u();D(i.showWarning()?"!bg-amber-500 hover:!bg-amber-600":"!bg-green-600 hover:!bg-green-700"),O("color",i.showWarning()?"warn":"primary"),s(2),S(i.showWarning()?"check":"done_all"),s(),f(" ",i.showWarning()?"Continuar":"Confirmar"," ")}}var Ut=(()=>{let c=class c{constructor(e,t,n){this.dialogRef=e,this.data=t,this.comprobanteService=n,this.selectedFile=b(null),this.previewUrl=b(""),this.isUploading=b(!1),this.uploadResponse=b(null),this.errorMessage=b(""),this.zoomLevel=b(1),this.showWarning=U(()=>{let d=this.uploadResponse();return d?d.validacionMonto&&!d.validacionMonto.coincide||d.validacionDocumento&&!d.validacionDocumento.coincide||d.validacionNombre&&!d.validacionNombre.coincide:!1})}onDragOver(e){e.preventDefault(),e.stopPropagation()}onDrop(e){e.preventDefault(),e.stopPropagation();let t=e.dataTransfer?.files;t&&t.length>0&&this.handleFile(t[0])}onFileSelected(e){let t=e.target;t.files&&t.files.length>0&&this.handleFile(t.files[0])}handleFile(e){if(!["image/jpeg","image/png","image/webp"].includes(e.type)){this.errorMessage.set("Tipo de archivo no permitido. Solo JPG, PNG o WebP.");return}if(e.size>5*1024*1024){this.errorMessage.set("El archivo es muy grande. M\xE1ximo 5MB.");return}this.errorMessage.set(""),this.selectedFile.set(e);let t=new FileReader;t.onload=()=>{this.previewUrl.set(t.result)},t.readAsDataURL(e)}removeFile(){this.selectedFile.set(null),this.previewUrl.set(""),this.uploadResponse.set(null),this.errorMessage.set("")}upload(){let e=this.selectedFile();e&&(this.isUploading.set(!0),this.errorMessage.set(""),this.comprobanteService.uploadComprobante(e,{idCuota:this.data.idCuota,montoEsperado:this.data.montoEsperado,documentoEsperado:this.data.documentoEsperado,nombreEsperado:this.data.nombreCliente,idAgente:this.data.idAgente}).subscribe({next:t=>{this.isUploading.set(!1),this.uploadResponse.set(t),t.success||this.errorMessage.set(t.error||"Error al procesar el comprobante")},error:t=>{this.isUploading.set(!1),this.errorMessage.set(t.error?.error||"Error de conexi\xF3n")}}))}confirm(){let t={uploaded:!0,response:this.uploadResponse()||void 0,validacionesOk:!this.showWarning()};this.dialogRef.close(t)}cancel(){this.dialogRef.close({uploaded:!1,validacionesOk:!1})}formatFileSize(e){return e<1024?e+" B":e<1024*1024?(e/1024).toFixed(1)+" KB":(e/(1024*1024)).toFixed(1)+" MB"}getResultBgClass(){return this.uploadResponse()?.success?this.showWarning()?"bg-amber-50 dark:bg-amber-950/30 text-amber-700 dark:text-amber-300":"bg-green-50 dark:bg-green-950/30 text-green-700 dark:text-green-300":"bg-red-50 dark:bg-red-950/30 text-red-700 dark:text-red-300"}getResultIconBgClass(){return this.uploadResponse()?.success?this.showWarning()?"bg-amber-100 dark:bg-amber-900/50 text-amber-600 dark:text-amber-400":"bg-green-100 dark:bg-green-900/50 text-green-600 dark:text-green-400":"bg-red-100 dark:bg-red-900/50 text-red-600 dark:text-red-400"}getResultIcon(){return this.uploadResponse()?.success?this.showWarning()?"warning":"check_circle":"error"}getResultTitle(){return this.uploadResponse()?.success?this.showWarning()?"Comprobante con advertencias":"Comprobante validado":"Error al procesar"}getValidationClass(e){return e?e.coincide?"border-green-300 bg-green-50 dark:bg-green-950/20":"border-amber-300 bg-amber-50 dark:bg-amber-950/20":"border-slate-200 dark:border-slate-700"}getValidationCardClass(e){return e?e.coincide?"border-green-400 dark:border-green-600 bg-green-50 dark:bg-green-950/30":"border-amber-400 dark:border-amber-600 bg-amber-50 dark:bg-amber-950/30":"border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800/50"}zoomIn(){this.zoomLevel()<3&&this.zoomLevel.update(e=>Math.min(3,e+.25))}zoomOut(){this.zoomLevel()>.5&&this.zoomLevel.update(e=>Math.max(.5,e-.25))}resetZoom(){this.zoomLevel.set(1)}onWheel(e){e.preventDefault(),e.deltaY<0?this.zoomIn():this.zoomOut()}};c.\u0275fac=function(t){return new(t||c)(V(Ge),V(He),V(Pe))},c.\u0275cmp=ne({type:c,selectors:[["app-comprobante-upload-dialog"]],decls:39,vars:12,consts:[["fileInput",""],[1,"dialog-header","bg-gradient-to-r","from-indigo-600","to-blue-600","dark:from-indigo-700","dark:to-blue-700","text-white","px-5","py-3","-mx-6","-mt-6","mb-4","rounded-t-2xl"],[1,"flex","items-center","gap-3"],[1,"p-2","bg-white/20","rounded-lg"],[1,"!text-2xl"],[1,"text-lg","font-bold","m-0"],[1,"text-xs","text-white/80","m-0"],[1,"!overflow-x-hidden","!overflow-y-auto","!w-full"],[1,"mb-4","p-3","bg-white","dark:bg-slate-800","rounded-xl","border","border-slate-200","dark:border-slate-700","shadow-sm"],[1,"grid","grid-cols-3","gap-3"],[1,"min-w-0"],[1,"text-[10px]","text-slate-500","dark:text-slate-400","uppercase","tracking-wide","font-semibold","mb-0.5"],[1,"font-semibold","text-sm","text-slate-800","dark:text-slate-100","truncate"],[1,"font-semibold","text-sm","text-slate-800","dark:text-slate-100"],[1,"font-bold","text-lg","text-indigo-600","dark:text-indigo-400"],[1,"relative","rounded-xl","overflow-hidden","border","border-slate-200","dark:border-slate-700","bg-white","dark:bg-slate-800/50","shadow-sm"],[1,"py-8","text-center","bg-slate-50","dark:bg-slate-800/30","rounded-xl"],[1,"flex","gap-4"],[1,"p-3","bg-red-50","dark:bg-red-950/30","rounded-xl","border","border-red-200","dark:border-red-800","flex","items-center","gap-3"],["align","end",1,"!px-5","!py-3","border-t","border-slate-200","dark:border-slate-700","gap-2","bg-slate-50","dark:bg-slate-800/50","-mx-6","-mb-6","rounded-b-2xl"],["mat-button","",1,"!text-slate-600","dark:!text-slate-300","!rounded-lg","!px-4","hover:!bg-slate-200","dark:hover:!bg-slate-700",3,"click"],["mat-raised-button","","color","primary",1,"!px-5","!rounded-lg","!bg-indigo-600","hover:!bg-indigo-700","!shadow-md",3,"disabled"],["mat-raised-button","",1,"!px-5","!rounded-lg","!shadow-md",3,"color","class"],[1,"border-2","border-dashed","border-slate-300","dark:border-slate-600","rounded-xl","p-6","text-center","cursor-pointer","hover:border-indigo-500","hover:bg-indigo-50","dark:hover:bg-indigo-950/20","transition-all","duration-300","group","bg-white","dark:bg-slate-800/30",3,"click","dragover","drop"],[1,"w-14","h-14","mx-auto","mb-3","bg-slate-100","dark:bg-slate-700","rounded-xl","flex","items-center","justify-center","group-hover:bg-indigo-100","dark:group-hover:bg-indigo-900/30","transition-colors"],[1,"!text-4xl","text-slate-400","dark:text-slate-500","group-hover:text-indigo-500","transition-colors"],[1,"text-slate-700","dark:text-slate-200","font-semibold","mb-1"],[1,"text-slate-500","dark:text-slate-400","text-sm"],[1,"text-indigo-600","dark:text-indigo-400","font-semibold","hover:underline"],[1,"text-xs","text-slate-400","dark:text-slate-500","mt-2"],["type","file","accept","image/jpeg,image/png,image/webp",1,"hidden",3,"change"],["alt","Preview",1,"w-full","max-h-48","object-contain","p-2",3,"src"],["mat-icon-button","",1,"!absolute","top-2","right-2","!bg-red-500","!text-white","hover:!bg-red-600","shadow-lg","!rounded-lg","!w-8","!h-8",3,"click"],[1,"!text-lg"],[1,"px-3","py-2","bg-slate-100","dark:bg-slate-800","border-t","border-slate-200","dark:border-slate-700"],[1,"text-xs","text-slate-700","dark:text-slate-300","flex","items-center","gap-1.5"],[1,"!text-sm","text-slate-500","dark:text-slate-400"],[1,"truncate"],[1,"text-slate-400","dark:text-slate-500","flex-shrink-0"],[1,"text-slate-500","dark:text-slate-400","flex-shrink-0"],[1,"relative","inline-block"],[1,"w-16","h-16","border-4","border-indigo-200","dark:border-indigo-900/50","rounded-full","animate-pulse"],["diameter","56","strokeWidth","3",1,"!absolute","top-1","left-1"],[1,"absolute","inset-0","flex","items-center","justify-center"],[1,"text-indigo-500","dark:text-indigo-400","animate-pulse","!text-xl"],[1,"text-slate-800","dark:text-slate-100","font-semibold","mt-4"],[1,"flex","justify-center","gap-1","mt-3"],[1,"w-2","h-2","bg-indigo-500","rounded-full","animate-bounce",2,"animation-delay","0ms"],[1,"w-2","h-2","bg-indigo-500","rounded-full","animate-bounce",2,"animation-delay","150ms"],[1,"w-2","h-2","bg-indigo-500","rounded-full","animate-bounce",2,"animation-delay","300ms"],[1,"flex-1","min-w-0","space-y-3"],[1,"p-3","rounded-xl","flex","items-center","gap-3"],[1,"p-2","rounded-lg","flex-shrink-0"],[1,"!text-xl"],[1,"flex-1","min-w-0"],[1,"font-bold","text-sm"],[1,"text-xs","opacity-80","truncate"],[1,"p-3","bg-amber-50","dark:bg-amber-950/30","rounded-xl","border","border-amber-200","dark:border-amber-800","flex","items-center","gap-3"],[1,"p-3","bg-amber-50","dark:bg-amber-950/30","border-2","border-amber-300","dark:border-amber-700","rounded-xl","flex","items-center","gap-3"],[1,"w-96","flex-shrink-0"],[1,"sticky","top-0","rounded-xl","border","border-slate-200","dark:border-slate-700","bg-slate-50","dark:bg-slate-800/50","overflow-hidden"],[1,"p-2","border-b","border-slate-200","dark:border-slate-700","flex","items-center","justify-between"],[1,"text-xs","font-semibold","text-slate-500","dark:text-slate-400","uppercase"],[1,"flex","items-center","gap-1"],["mat-icon-button","",1,"!w-7","!h-7",3,"click","disabled"],[1,"!text-base","text-slate-500","dark:text-slate-400"],[1,"text-xs","text-slate-500","dark:text-slate-400","w-10","text-center"],["mat-icon-button","",1,"!w-7","!h-7",3,"click"],[1,"overflow-auto","max-h-80","bg-white","dark:bg-slate-900",2,"cursor","grab",3,"wheel"],["alt","Comprobante",1,"transition-transform","duration-150",3,"src"],[1,"grid","grid-cols-3","gap-2"],[1,"p-3","rounded-xl","border-2","transition-all"],[1,"flex","items-center","justify-between","mb-1"],[1,"text-[10px]","font-semibold","uppercase","tracking-wide","text-slate-500","dark:text-slate-400"],[1,"!text-base",3,"class"],[1,"text-lg","font-bold","text-slate-800","dark:text-slate-100"],[1,"text-[10px]","mt-1","font-medium","flex","items-center","gap-0.5",3,"class"],[1,"text-sm","font-bold","text-slate-800","dark:text-slate-100","truncate"],[1,"p-3","bg-slate-50","dark:bg-slate-800/50","rounded-xl","border","border-slate-200","dark:border-slate-700"],[1,"!text-base"],[1,"text-[10px]","mt-1","font-medium","flex","items-center","gap-0.5"],[1,"!text-xs"],[1,"flex","items-center","gap-4","text-sm"],[1,"flex","items-center","gap-1.5"],[1,"!text-base","text-slate-400"],[1,"font-semibold","text-slate-800","dark:text-slate-100"],[1,"text-amber-500"],[1,"text-sm","text-amber-800","dark:text-amber-200"],[1,"text-amber-600","dark:text-amber-400"],[1,"text-amber-800","dark:text-amber-200","font-semibold","text-sm"],[1,"text-amber-700","dark:text-amber-300","text-xs"],[1,"text-red-500"],[1,"text-sm","text-red-700","dark:text-red-300"],["mat-raised-button","","color","primary",1,"!px-5","!rounded-lg","!bg-indigo-600","hover:!bg-indigo-700","!shadow-md",3,"click","disabled"],["diameter","16",1,"mr-2"],[1,"mr-1","!text-lg"],["mat-raised-button","",1,"!px-5","!rounded-lg","!shadow-md",3,"click","color"]],template:function(t,n){t&1&&(l(0,"div",1)(1,"div",2)(2,"div",3)(3,"mat-icon",4),r(4,"receipt_long"),a()(),l(5,"div")(6,"h2",5),r(7,"Subir Comprobante de Pago"),a(),l(8,"p",6),r(9,"Validaci\xF3n autom\xE1tica con IA"),a()()()(),l(10,"mat-dialog-content",7)(11,"div",8)(12,"div",9)(13,"div",10)(14,"p",11),r(15,"Cliente"),a(),l(16,"p",12),r(17),a()(),l(18,"div")(19,"p",11),r(20,"Documento"),a(),l(21,"p",13),r(22),a()(),l(23,"div")(24,"p",11),r(25,"Monto esperado"),a(),l(26,"p",14),r(27),G(28,"number"),a()()()(),g(29,vn,14,0),g(30,Sn,15,3,"div",15),g(31,yn,13,0,"div",16),g(32,On,34,20,"div",17),g(33,Ln,5,1,"div",18),a(),l(34,"mat-dialog-actions",19)(35,"button",20),E("click",function(){return n.cancel()}),r(36," Cancelar "),a(),g(37,$n,4,2,"button",21)(38,zn,4,5,"button",22),a()),t&2&&(s(17),S(n.data.nombreCliente),s(5),S(n.data.documentoEsperado),s(5),f("S/ ",H(28,9,n.data.montoEsperado,"1.2-2")),s(2),h(n.selectedFile()?-1:29),s(),h(n.selectedFile()&&!n.isUploading()&&!n.uploadResponse()?30:-1),s(),h(n.isUploading()?31:-1),s(),h(n.uploadResponse()?32:-1),s(),h(n.errorMessage()?33:-1),s(4),h(n.uploadResponse()?38:37))},dependencies:[ie,Ye,We,qe,$e,Be,Ue,je,ze,Je,Ke,Ze,se],styles:["[_nghost-%COMP%]{display:block}"]});let o=c;return o})();var jn=(o,c)=>c.numeroCuota;function Gn(o,c){if(o&1&&(l(0,"div",28),r(1),G(2,"number"),a()),o&2){let i,e=c.$implicit,t=u(2);D(e.numeroCuota===((i=t.cuotaMasProxima())==null?null:i.numeroCuota)?"bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 font-semibold":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-400"),s(),fe(" C",e.numeroCuota,": S/ ",H(2,4,e.monto,"1.2-2")," ")}}function Hn(o,c){if(o&1&&(l(0,"div",16)(1,"p",25),r(2,"Cuotas pendientes:"),a(),l(3,"div",26),q(4,Gn,3,7,"div",27,jn),a()()),o&2){let i=u();s(4),W(i.cuotasPendientes())}}function qn(o,c){if(o&1){let i=N();l(0,"div",29),E("click",function(){_(i);let t=Re(13);return C(t.click())})("dragover",function(t){_(i);let n=u();return C(n.onDragOver(t))})("drop",function(t){_(i);let n=u();return C(n.onDrop(t))}),l(1,"div",30)(2,"mat-icon",31),r(3,"cloud_upload"),a()(),l(4,"p",32),r(5,"Arrastra el voucher aqu\xED"),a(),l(6,"p",33),r(7," o "),l(8,"span",34),r(9,"haz clic para seleccionar"),a()(),l(10,"p",35),r(11,"JPG, PNG, WebP - M\xE1ximo 5MB"),a()(),l(12,"input",36,0),E("change",function(t){_(i);let n=u();return C(n.onFileSelected(t))}),a()}}function Wn(o,c){if(o&1){let i=N();l(0,"div",17),B(1,"img",37),l(2,"button",38),E("click",function(){_(i);let t=u();return C(t.removeFile())}),l(3,"mat-icon",39),r(4,"close"),a()(),l(5,"div",40)(6,"p",41)(7,"mat-icon",42),r(8,"insert_drive_file"),a(),l(9,"span",43),r(10),a(),l(11,"span",44),r(12,"-"),a(),l(13,"span",45),r(14),a()()()()}if(o&2){let i,e,t=u();s(),O("src",t.previewUrl(),Ee),s(9),S((i=t.selectedFile())==null?null:i.name),s(4),S(t.formatFileSize(((e=t.selectedFile())==null?null:e.size)||0))}}function Yn(o,c){o&1&&(l(0,"div",18)(1,"div",46),B(2,"div",47)(3,"mat-spinner",48),l(4,"div",49)(5,"mat-icon",50),r(6,"document_scanner"),a()()(),l(7,"p",51),r(8,"Analizando voucher..."),a(),l(9,"div",52),B(10,"span",53)(11,"span",54)(12,"span",55),a()())}function Qn(o,c){if(o&1&&(l(0,"mat-icon",88),r(1),a()),o&2){let i,e,t=u(3);D(!((i=t.uploadResponse())==null||i.validacionMonto==null)&&i.validacionMonto.coincide?"text-green-500":"text-amber-500"),s(),f(" ",!((e=t.uploadResponse())==null||e.validacionMonto==null)&&e.validacionMonto.coincide?"check_circle":"warning"," ")}}function Kn(o,c){if(o&1&&(l(0,"p",89)(1,"mat-icon",90),r(2),a(),r(3),a()),o&2){let i,e,t,n=u(3);D(!((i=n.uploadResponse())==null||i.validacionMonto==null)&&i.validacionMonto.coincide?"text-green-600 dark:text-green-400":"text-amber-600 dark:text-amber-400"),s(2),S(!((e=n.uploadResponse())==null||e.validacionMonto==null)&&e.validacionMonto.coincide?"check":"priority_high"),s(),f(" ",!((t=n.uploadResponse())==null||t.validacionMonto==null)&&t.validacionMonto.coincide?"OK":"No coincide"," ")}}function Jn(o,c){if(o&1&&(l(0,"mat-icon",88),r(1),a()),o&2){let i,e,t=u(3);D(!((i=t.uploadResponse())==null||i.validacionDocumento==null)&&i.validacionDocumento.coincide?"text-green-500":"text-amber-500"),s(),f(" ",!((e=t.uploadResponse())==null||e.validacionDocumento==null)&&e.validacionDocumento.coincide?"check_circle":"warning"," ")}}function Zn(o,c){if(o&1&&(l(0,"p",89)(1,"mat-icon",90),r(2),a(),r(3),a()),o&2){let i,e,t,n=u(3);D(!((i=n.uploadResponse())==null||i.validacionDocumento==null)&&i.validacionDocumento.coincide?"text-green-600 dark:text-green-400":"text-amber-600 dark:text-amber-400"),s(2),S(!((e=n.uploadResponse())==null||e.validacionDocumento==null)&&e.validacionDocumento.coincide?"check":"priority_high"),s(),f(" ",!((t=n.uploadResponse())==null||t.validacionDocumento==null)&&t.validacionDocumento.coincide?"OK":"No coincide"," ")}}function Xn(o,c){if(o&1&&(l(0,"mat-icon",88),r(1),a()),o&2){let i,e,t=u(3);D(!((i=t.uploadResponse())==null||i.validacionNombre==null)&&i.validacionNombre.coincide?"text-green-500":"text-amber-500"),s(),f(" ",!((e=t.uploadResponse())==null||e.validacionNombre==null)&&e.validacionNombre.coincide?"check_circle":"warning"," ")}}function ei(o,c){if(o&1&&(l(0,"p",89)(1,"mat-icon",90),r(2),a(),r(3),a()),o&2){let i,e,t,n=u(3);D(!((i=n.uploadResponse())==null||i.validacionNombre==null)&&i.validacionNombre.coincide?"text-green-600 dark:text-green-400":"text-amber-600 dark:text-amber-400"),s(2),S(!((e=n.uploadResponse())==null||e.validacionNombre==null)&&e.validacionNombre.coincide?"check":"priority_high"),s(),f(" ",!((t=n.uploadResponse())==null||t.validacionNombre==null)&&t.validacionNombre.coincide?"OK":"No coincide"," ")}}function ti(o,c){if(o&1&&(l(0,"div",92)(1,"mat-icon",93),r(2,"account_balance"),a(),l(3,"span",94),r(4),a()()),o&2){let i,e=u(4);s(4),S((i=e.uploadResponse())==null||i.ocrResult==null?null:i.ocrResult.banco)}}function ni(o,c){if(o&1&&(l(0,"div",92)(1,"mat-icon",93),r(2,"tag"),a(),l(3,"span",94),r(4),a()()),o&2){let i,e=u(4);s(4),S((i=e.uploadResponse())==null||i.ocrResult==null?null:i.ocrResult.numeroOperacion)}}function ii(o,c){if(o&1&&(l(0,"div",92)(1,"mat-icon",93),r(2,"event"),a(),l(3,"span",94),r(4),a()()),o&2){let i,e=u(4);s(4),S((i=e.uploadResponse())==null||i.ocrResult==null?null:i.ocrResult.fecha)}}function oi(o,c){if(o&1&&(l(0,"div",85)(1,"div",91),g(2,ti,5,1,"div",92),g(3,ni,5,1,"div",92),g(4,ii,5,1,"div",92),a()()),o&2){let i,e,t,n=u(3);s(2),h(!((i=n.uploadResponse())==null||i.ocrResult==null)&&i.ocrResult.banco?2:-1),s(),h(!((e=n.uploadResponse())==null||e.ocrResult==null)&&e.ocrResult.numeroOperacion?3:-1),s(),h(!((t=n.uploadResponse())==null||t.ocrResult==null)&&t.ocrResult.fecha?4:-1)}}function ai(o,c){if(o&1&&(l(0,"div",86)(1,"div",95)(2,"mat-icon",96),r(3,"check_circle"),a(),l(4,"div")(5,"p",97),r(6),a(),l(7,"p",98),r(8),G(9,"number"),a()()()()),o&2){let i,e,t=u(3);s(6),f("Se registrar\xE1 pago de Cuota ",(i=t.cuotaCoincidente())==null?null:i.numeroCuota),s(2),fe("Monto: S/ ",H(9,3,(e=t.cuotaCoincidente())==null?null:e.monto,"1.2-2")," - Vence: ",t.formatDate((e=t.cuotaCoincidente())==null?null:e.dueDate))}}function li(o,c){if(o&1&&(l(0,"div",87)(1,"div",95)(2,"mat-icon",99),r(3,"warning"),a(),l(4,"div")(5,"p",100),r(6,"El monto no coincide con ninguna cuota pendiente"),a(),l(7,"p",101),r(8),G(9,"number"),a()()()()),o&2){let i,e=u(3);s(8),fe("Se seleccionar\xE1 la cuota m\xE1s pr\xF3xima: C",(i=e.cuotaMasProxima())==null?null:i.numeroCuota," (S/ ",H(9,2,(i=e.cuotaMasProxima())==null?null:i.monto,"1.2-2"),")")}}function ri(o,c){if(o&1&&(l(0,"div",77)(1,"div",78)(2,"div",79)(3,"span",80),r(4,"Monto"),a(),g(5,Qn,2,3,"mat-icon",81),a(),l(6,"p",82),r(7),G(8,"number"),a(),g(9,Kn,4,4,"p",83),a(),l(10,"div",78)(11,"div",79)(12,"span",80),r(13,"Documento"),a(),g(14,Jn,2,3,"mat-icon",81),a(),l(15,"p",84),r(16),a(),g(17,Zn,4,4,"p",83),a(),l(18,"div",78)(19,"div",79)(20,"span",80),r(21,"Nombre"),a(),g(22,Xn,2,3,"mat-icon",81),a(),l(23,"p",84),r(24),a(),g(25,ei,4,4,"p",83),a()(),g(26,oi,5,3,"div",85),g(27,ai,10,6,"div",86)(28,li,10,5,"div",87)),o&2){let i,e,t,n,d,m,p,x,v,y,M,j,$,F,k=u(2);s(),D(k.getValidationCardClass((i=k.uploadResponse())==null?null:i.validacionMonto)),s(4),h((e=k.uploadResponse())!=null&&e.validacionMonto?5:-1),s(2),f("S/ ",H(8,17,(t=k.uploadResponse())==null||t.ocrResult==null?null:t.ocrResult.monto,"1.2-2")),s(2),h((n=k.uploadResponse())!=null&&n.validacionMonto?9:-1),s(),D(k.getValidationCardClass((d=k.uploadResponse())==null?null:d.validacionDocumento)),s(4),h((m=k.uploadResponse())!=null&&m.validacionDocumento?14:-1),s(2),S(((p=k.uploadResponse())==null||p.ocrResult==null?null:p.ocrResult.documento)||"-"),s(),h((x=k.uploadResponse())!=null&&x.validacionDocumento?17:-1),s(),D(k.getValidationCardClass((v=k.uploadResponse())==null?null:v.validacionNombre)),s(4),h((y=k.uploadResponse())!=null&&y.validacionNombre?22:-1),s(2),S(((M=k.uploadResponse())==null||M.ocrResult==null?null:M.ocrResult.nombre)||"-"),s(),h((j=k.uploadResponse())!=null&&j.validacionNombre?25:-1),s(),h(!(($=k.uploadResponse())==null||$.ocrResult==null)&&$.ocrResult.banco||!(($=k.uploadResponse())==null||$.ocrResult==null)&&$.ocrResult.numeroOperacion||!(($=k.uploadResponse())==null||$.ocrResult==null)&&$.ocrResult.fecha?26:-1),s(),h(k.cuotaCoincidente()?27:!((F=k.uploadResponse())==null||F.ocrResult==null)&&F.ocrResult.monto?28:-1)}}function si(o,c){o&1&&(l(0,"div",63)(1,"mat-icon",102),r(2,"info"),a(),l(3,"p",103),r(4,"No se pudo analizar el voucher. Puedes continuar manualmente."),a()())}function di(o,c){o&1&&(l(0,"div",64)(1,"mat-icon",99),r(2,"warning"),a(),l(3,"div")(4,"p",104),r(5,"Hay diferencias en la validaci\xF3n"),a(),l(6,"p",105),r(7,"Puedes continuar, pero verifica los datos."),a()()())}function ci(o,c){if(o&1&&(l(0,"div",65)(1,"p",106)(2,"mat-icon",107),r(3,"auto_awesome"),a(),r(4," Se auto-completar\xE1: "),a(),l(5,"div",108)(6,"span",109),r(7,"Contacto Directo"),a(),l(8,"span",109),r(9,"Cancelaci\xF3n"),a(),l(10,"span",109),r(11),a()()()),o&2){let i,e=u(2);s(11),f("Cuota ",(i=e.cuotaCoincidente()||e.cuotaMasProxima())==null?null:i.numeroCuota)}}function mi(o,c){if(o&1){let i=N();l(0,"div",19)(1,"div",56)(2,"div",57)(3,"div",58)(4,"mat-icon",59),r(5),a()(),l(6,"div",60)(7,"p",61),r(8),a(),l(9,"p",62),r(10),a()()(),g(11,ri,29,20)(12,si,5,0,"div",63),g(13,di,8,0,"div",64),g(14,ci,12,1,"div",65),a(),l(15,"div",66)(16,"div",67)(17,"div",68)(18,"span",69),r(19,"Voucher"),a(),l(20,"div",70)(21,"button",71),E("click",function(){_(i);let t=u();return C(t.zoomOut())}),l(22,"mat-icon",72),r(23,"remove"),a()(),l(24,"span",73),r(25),G(26,"number"),a(),l(27,"button",71),E("click",function(){_(i);let t=u();return C(t.zoomIn())}),l(28,"mat-icon",72),r(29,"add"),a()(),l(30,"button",74),E("click",function(){_(i);let t=u();return C(t.resetZoom())}),l(31,"mat-icon",72),r(32,"fit_screen"),a()()()(),l(33,"div",75),E("wheel",function(t){_(i);let n=u();return C(n.onWheel(t))}),B(34,"img",76),a()()()()}if(o&2){let i,e,t=u();s(2),D(t.getResultBgClass()),s(),D(t.getResultIconBgClass()),s(2),S(t.getResultIcon()),s(3),S(t.getResultTitle()),s(2),S((i=t.uploadResponse())==null?null:i.mensaje),s(),h(!((e=t.uploadResponse())==null||e.ocrResult==null)&&e.ocrResult.success?11:(e=t.uploadResponse())!=null&&e.ocrResult&&!(!((e=t.uploadResponse())==null||e.ocrResult==null)&&e.ocrResult.success)?12:-1),s(2),h(t.showWarning()?13:-1),s(),h(t.allValidationsOk()?14:-1),s(7),O("disabled",t.zoomLevel()<=.5),s(4),f("",H(26,18,t.zoomLevel()*100,"1.0-0"),"%"),s(2),O("disabled",t.zoomLevel()>=3),s(7),Ve("transform","scale("+t.zoomLevel()+")")("transform-origin","top left"),O("src",t.previewUrl(),Ee)}}function ui(o,c){if(o&1&&(l(0,"div",20)(1,"mat-icon",110),r(2,"error"),a(),l(3,"p",111),r(4),a()()),o&2){let i=u();s(4),S(i.errorMessage())}}function pi(o,c){o&1&&B(0,"mat-spinner",113)}function gi(o,c){o&1&&(l(0,"mat-icon",114),r(1,"upload"),a())}function hi(o,c){if(o&1){let i=N();l(0,"button",112),E("click",function(){_(i);let t=u();return C(t.upload())}),g(1,pi,1,0,"mat-spinner",113)(2,gi,2,0,"mat-icon",114),r(3," Analizar Voucher "),a()}if(o&2){let i=u();O("disabled",!i.selectedFile()||i.isUploading()),s(),h(i.isUploading()?1:2)}}function fi(o,c){if(o&1){let i=N();l(0,"button",115),E("click",function(){_(i);let t=u();return C(t.confirm())}),l(1,"mat-icon",114),r(2),a(),r(3),a()}if(o&2){let i=u();D(i.showWarning()?"!bg-amber-500 hover:!bg-amber-600":"!bg-green-600 hover:!bg-green-700"),O("color",i.showWarning()?"warn":"primary"),s(2),S(i.showWarning()?"check":"done_all"),s(),f(" ",i.showWarning()?"Continuar con Pago":"Confirmar Pago"," ")}}var Bt=(()=>{let c=class c{constructor(e,t,n){this.dialogRef=e,this.data=t,this.comprobanteService=n,this.selectedFile=b(null),this.previewUrl=b(""),this.isUploading=b(!1),this.uploadResponse=b(null),this.errorMessage=b(""),this.zoomLevel=b(1),this.cuotasPendientes=U(()=>this.data.cuotas.filter(d=>d.status!=="PAGADA"&&d.status!=="PAGADO"&&d.status!=="CUMPLIDO"&&d.status!=="CANCELADA").sort((d,m)=>new Date(d.dueDate).getTime()-new Date(m.dueDate).getTime())),this.cuotaMasProxima=U(()=>{let d=this.cuotasPendientes();return d.length>0?d[0]:null}),this.cuotaCoincidente=U(()=>{let d=this.uploadResponse();if(!d?.ocrResult?.monto)return null;let m=d.ocrResult.monto,x=this.cuotasPendientes().find(y=>Math.abs(y.monto-m)<.01);if(x)return x;let v=this.cuotaMasProxima();return v&&Math.abs(v.monto-m)<.01?v:null}),this.showWarning=U(()=>{let d=this.uploadResponse();return d?d.validacionMonto&&!d.validacionMonto.coincide||d.validacionDocumento&&!d.validacionDocumento.coincide||d.validacionNombre&&!d.validacionNombre.coincide:!1}),this.allValidationsOk=U(()=>{let d=this.uploadResponse();return d?.ocrResult?.success?d.validacionMonto?.coincide&&d.validacionDocumento?.coincide&&d.validacionNombre?.coincide:!1})}onDragOver(e){e.preventDefault(),e.stopPropagation()}onDrop(e){e.preventDefault(),e.stopPropagation();let t=e.dataTransfer?.files;t&&t.length>0&&this.handleFile(t[0])}onFileSelected(e){let t=e.target;t.files&&t.files.length>0&&this.handleFile(t.files[0])}handleFile(e){if(!["image/jpeg","image/png","image/webp"].includes(e.type)){this.errorMessage.set("Tipo de archivo no permitido. Solo JPG, PNG o WebP.");return}if(e.size>5*1024*1024){this.errorMessage.set("El archivo es muy grande. M\xE1ximo 5MB.");return}this.errorMessage.set(""),this.selectedFile.set(e);let t=new FileReader;t.onload=()=>{this.previewUrl.set(t.result)},t.readAsDataURL(e)}removeFile(){this.selectedFile.set(null),this.previewUrl.set(""),this.uploadResponse.set(null),this.errorMessage.set("")}upload(){let e=this.selectedFile();if(!e)return;let t=this.cuotaMasProxima();if(!t){this.errorMessage.set("No hay cuotas pendientes");return}this.isUploading.set(!0),this.errorMessage.set(""),this.comprobanteService.uploadComprobante(e,{idCuota:t.id,montoEsperado:t.monto,documentoEsperado:this.data.documentoCliente,nombreEsperado:this.data.nombreCliente,idAgente:this.data.idAgente}).subscribe({next:n=>{this.isUploading.set(!1),this.uploadResponse.set(n),n.success||this.errorMessage.set(n.error||"Error al procesar el voucher")},error:n=>{this.isUploading.set(!1),this.errorMessage.set(n.error?.error||"Error de conexi\xF3n")}})}confirm(){let e=this.uploadResponse(),t=this.cuotaCoincidente()||this.cuotaMasProxima();if(!t){this.errorMessage.set("No hay cuota para seleccionar");return}let n=e?.ocrResult,d="Pago validado por OCR";n?.banco&&(d+=` - ${n.banco}`),n?.numeroOperacion&&(d+=` - Op. #${n.numeroOperacion}`),n?.fecha&&(d+=` - Fecha: ${n.fecha}`),n?.monto&&(d+=` - Monto: S/ ${n.monto.toFixed(2)}`);let m={confirmed:!0,autoSelect:{categoriaId:"CD",detalleId:"CA",cuotaSeleccionada:t,observaciones:d},ocrResponse:e||void 0};this.dialogRef.close(m)}cancel(){this.dialogRef.close({confirmed:!1})}formatFileSize(e){return e<1024?e+" B":e<1024*1024?(e/1024).toFixed(1)+" KB":(e/(1024*1024)).toFixed(1)+" MB"}formatDate(e){if(!e)return"-";try{if(/^\d{4}-\d{2}-\d{2}$/.test(e)){let[t,n,d]=e.split("-").map(Number);return new Date(t,n-1,d).toLocaleDateString("es-PE",{day:"2-digit",month:"2-digit",year:"numeric"})}return new Date(e).toLocaleDateString("es-PE",{day:"2-digit",month:"2-digit",year:"numeric"})}catch{return e}}getResultBgClass(){return this.uploadResponse()?.success?this.showWarning()?"bg-amber-50 dark:bg-amber-950/30 text-amber-700 dark:text-amber-300":"bg-green-50 dark:bg-green-950/30 text-green-700 dark:text-green-300":"bg-red-50 dark:bg-red-950/30 text-red-700 dark:text-red-300"}getResultIconBgClass(){return this.uploadResponse()?.success?this.showWarning()?"bg-amber-100 dark:bg-amber-900/50 text-amber-600 dark:text-amber-400":"bg-green-100 dark:bg-green-900/50 text-green-600 dark:text-green-400":"bg-red-100 dark:bg-red-900/50 text-red-600 dark:text-red-400"}getResultIcon(){return this.uploadResponse()?.success?this.showWarning()?"warning":"check_circle":"error"}getResultTitle(){return this.uploadResponse()?.success?this.showWarning()?"Voucher con advertencias":"Voucher validado correctamente":"Error al procesar"}getValidationCardClass(e){return e?e.coincide?"border-green-400 dark:border-green-600 bg-green-50 dark:bg-green-950/30":"border-amber-400 dark:border-amber-600 bg-amber-50 dark:bg-amber-950/30":"border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800/50"}zoomIn(){this.zoomLevel()<3&&this.zoomLevel.update(e=>Math.min(3,e+.25))}zoomOut(){this.zoomLevel()>.5&&this.zoomLevel.update(e=>Math.max(.5,e-.25))}resetZoom(){this.zoomLevel.set(1)}onWheel(e){e.preventDefault(),e.deltaY<0?this.zoomIn():this.zoomOut()}};c.\u0275fac=function(t){return new(t||c)(V(Ge),V(He),V(Pe))},c.\u0275cmp=ne({type:c,selectors:[["app-voucher-payment-dialog"]],decls:42,vars:14,consts:[["fileInput",""],[1,"dialog-header","bg-gradient-to-r","from-green-600","to-emerald-600","dark:from-green-700","dark:to-emerald-700","text-white","px-5","py-3","-mx-6","-mt-6","mb-4","rounded-t-2xl"],[1,"flex","items-center","gap-3"],[1,"p-2","bg-white/20","rounded-lg"],[1,"!text-2xl"],[1,"text-lg","font-bold","m-0"],[1,"text-xs","text-white/80","m-0"],[1,"!overflow-x-hidden","!overflow-y-auto","!w-full"],[1,"mb-4","p-3","bg-white","dark:bg-slate-800","rounded-xl","border","border-slate-200","dark:border-slate-700","shadow-sm"],[1,"grid","grid-cols-3","gap-3"],[1,"min-w-0"],[1,"text-[10px]","text-slate-500","dark:text-slate-400","uppercase","tracking-wide","font-semibold","mb-0.5"],[1,"font-semibold","text-sm","text-slate-800","dark:text-slate-100","truncate"],[1,"font-semibold","text-sm","text-slate-800","dark:text-slate-100"],[1,"font-bold","text-lg","text-green-600","dark:text-green-400"],[1,"text-[10px]","text-slate-500","dark:text-slate-400"],[1,"mb-4","p-3","bg-slate-50","dark:bg-slate-800/50","rounded-xl","border","border-slate-200","dark:border-slate-700"],[1,"relative","rounded-xl","overflow-hidden","border","border-slate-200","dark:border-slate-700","bg-white","dark:bg-slate-800/50","shadow-sm"],[1,"py-8","text-center","bg-slate-50","dark:bg-slate-800/30","rounded-xl"],[1,"flex","gap-4"],[1,"p-3","bg-red-50","dark:bg-red-950/30","rounded-xl","border","border-red-200","dark:border-red-800","flex","items-center","gap-3"],["align","end",1,"!px-5","!py-3","border-t","border-slate-200","dark:border-slate-700","gap-2","bg-slate-50","dark:bg-slate-800/50","-mx-6","-mb-6","rounded-b-2xl"],["mat-button","",1,"!text-slate-600","dark:!text-slate-300","!rounded-lg","!px-4","hover:!bg-slate-200","dark:hover:!bg-slate-700",3,"click"],["mat-raised-button","","color","primary",1,"!px-5","!rounded-lg","!bg-green-600","hover:!bg-green-700","!shadow-md",3,"disabled"],["mat-raised-button","",1,"!px-5","!rounded-lg","!shadow-md",3,"color","class"],[1,"text-xs","font-semibold","text-slate-600","dark:text-slate-300","mb-2"],[1,"flex","flex-wrap","gap-2"],[1,"text-xs","px-2","py-1","rounded-lg",3,"class"],[1,"text-xs","px-2","py-1","rounded-lg"],[1,"border-2","border-dashed","border-slate-300","dark:border-slate-600","rounded-xl","p-6","text-center","cursor-pointer","hover:border-green-500","hover:bg-green-50","dark:hover:bg-green-950/20","transition-all","duration-300","group","bg-white","dark:bg-slate-800/30",3,"click","dragover","drop"],[1,"w-14","h-14","mx-auto","mb-3","bg-slate-100","dark:bg-slate-700","rounded-xl","flex","items-center","justify-center","group-hover:bg-green-100","dark:group-hover:bg-green-900/30","transition-colors"],[1,"!text-4xl","text-slate-400","dark:text-slate-500","group-hover:text-green-500","transition-colors"],[1,"text-slate-700","dark:text-slate-200","font-semibold","mb-1"],[1,"text-slate-500","dark:text-slate-400","text-sm"],[1,"text-green-600","dark:text-green-400","font-semibold","hover:underline"],[1,"text-xs","text-slate-400","dark:text-slate-500","mt-2"],["type","file","accept","image/jpeg,image/png,image/webp",1,"hidden",3,"change"],["alt","Preview",1,"w-full","max-h-48","object-contain","p-2",3,"src"],["mat-icon-button","",1,"!absolute","top-2","right-2","!bg-red-500","!text-white","hover:!bg-red-600","shadow-lg","!rounded-lg","!w-8","!h-8",3,"click"],[1,"!text-lg"],[1,"px-3","py-2","bg-slate-100","dark:bg-slate-800","border-t","border-slate-200","dark:border-slate-700"],[1,"text-xs","text-slate-700","dark:text-slate-300","flex","items-center","gap-1.5"],[1,"!text-sm","text-slate-500","dark:text-slate-400"],[1,"truncate"],[1,"text-slate-400","dark:text-slate-500","flex-shrink-0"],[1,"text-slate-500","dark:text-slate-400","flex-shrink-0"],[1,"relative","inline-block"],[1,"w-16","h-16","border-4","border-green-200","dark:border-green-900/50","rounded-full","animate-pulse"],["diameter","56","strokeWidth","3",1,"!absolute","top-1","left-1"],[1,"absolute","inset-0","flex","items-center","justify-center"],[1,"text-green-500","dark:text-green-400","animate-pulse","!text-xl"],[1,"text-slate-800","dark:text-slate-100","font-semibold","mt-4"],[1,"flex","justify-center","gap-1","mt-3"],[1,"w-2","h-2","bg-green-500","rounded-full","animate-bounce",2,"animation-delay","0ms"],[1,"w-2","h-2","bg-green-500","rounded-full","animate-bounce",2,"animation-delay","150ms"],[1,"w-2","h-2","bg-green-500","rounded-full","animate-bounce",2,"animation-delay","300ms"],[1,"flex-1","min-w-0","space-y-3"],[1,"p-3","rounded-xl","flex","items-center","gap-3"],[1,"p-2","rounded-lg","flex-shrink-0"],[1,"!text-xl"],[1,"flex-1","min-w-0"],[1,"font-bold","text-sm"],[1,"text-xs","opacity-80","truncate"],[1,"p-3","bg-amber-50","dark:bg-amber-950/30","rounded-xl","border","border-amber-200","dark:border-amber-800","flex","items-center","gap-3"],[1,"p-3","bg-amber-50","dark:bg-amber-950/30","border-2","border-amber-300","dark:border-amber-700","rounded-xl","flex","items-center","gap-3"],[1,"p-3","bg-green-50","dark:bg-green-950/20","rounded-xl","border","border-green-200","dark:border-green-800"],[1,"w-96","flex-shrink-0"],[1,"sticky","top-0","rounded-xl","border","border-slate-200","dark:border-slate-700","bg-slate-50","dark:bg-slate-800/50","overflow-hidden"],[1,"p-2","border-b","border-slate-200","dark:border-slate-700","flex","items-center","justify-between"],[1,"text-xs","font-semibold","text-slate-500","dark:text-slate-400","uppercase"],[1,"flex","items-center","gap-1"],["mat-icon-button","",1,"!w-7","!h-7",3,"click","disabled"],[1,"!text-base","text-slate-500","dark:text-slate-400"],[1,"text-xs","text-slate-500","dark:text-slate-400","w-10","text-center"],["mat-icon-button","",1,"!w-7","!h-7",3,"click"],[1,"overflow-auto","max-h-80","bg-white","dark:bg-slate-900",2,"cursor","grab",3,"wheel"],["alt","Voucher",1,"transition-transform","duration-150",3,"src"],[1,"grid","grid-cols-3","gap-2"],[1,"p-3","rounded-xl","border-2","transition-all"],[1,"flex","items-center","justify-between","mb-1"],[1,"text-[10px]","font-semibold","uppercase","tracking-wide","text-slate-500","dark:text-slate-400"],[1,"!text-base",3,"class"],[1,"text-lg","font-bold","text-slate-800","dark:text-slate-100"],[1,"text-[10px]","mt-1","font-medium","flex","items-center","gap-0.5",3,"class"],[1,"text-sm","font-bold","text-slate-800","dark:text-slate-100","truncate"],[1,"p-3","bg-slate-50","dark:bg-slate-800/50","rounded-xl","border","border-slate-200","dark:border-slate-700"],[1,"p-3","bg-green-50","dark:bg-green-950/30","rounded-xl","border-2","border-green-400","dark:border-green-600"],[1,"p-3","bg-amber-50","dark:bg-amber-950/30","rounded-xl","border-2","border-amber-400","dark:border-amber-600"],[1,"!text-base"],[1,"text-[10px]","mt-1","font-medium","flex","items-center","gap-0.5"],[1,"!text-xs"],[1,"flex","items-center","gap-4","text-sm"],[1,"flex","items-center","gap-1.5"],[1,"!text-base","text-slate-400"],[1,"font-semibold","text-slate-800","dark:text-slate-100"],[1,"flex","items-center","gap-2"],[1,"text-green-600","dark:text-green-400"],[1,"text-sm","font-bold","text-green-800","dark:text-green-200"],[1,"text-xs","text-green-700","dark:text-green-300"],[1,"text-amber-600","dark:text-amber-400"],[1,"text-sm","font-bold","text-amber-800","dark:text-amber-200"],[1,"text-xs","text-amber-700","dark:text-amber-300"],[1,"text-amber-500"],[1,"text-sm","text-amber-800","dark:text-amber-200"],[1,"text-amber-800","dark:text-amber-200","font-semibold","text-sm"],[1,"text-amber-700","dark:text-amber-300","text-xs"],[1,"text-xs","font-semibold","text-green-700","dark:text-green-300","mb-2","flex","items-center","gap-1"],[1,"!text-sm"],[1,"flex","flex-wrap","gap-2","text-xs"],[1,"px-2","py-1","bg-green-100","dark:bg-green-900/40","text-green-800","dark:text-green-200","rounded"],[1,"text-red-500"],[1,"text-sm","text-red-700","dark:text-red-300"],["mat-raised-button","","color","primary",1,"!px-5","!rounded-lg","!bg-green-600","hover:!bg-green-700","!shadow-md",3,"click","disabled"],["diameter","16",1,"mr-2"],[1,"mr-1","!text-lg"],["mat-raised-button","",1,"!px-5","!rounded-lg","!shadow-md",3,"click","color"]],template:function(t,n){if(t&1&&(l(0,"div",1)(1,"div",2)(2,"div",3)(3,"mat-icon",4),r(4,"payments"),a()(),l(5,"div")(6,"h2",5),r(7,"Registrar Pago con Voucher"),a(),l(8,"p",6),r(9,"Sube el comprobante para validar y registrar el pago"),a()()()(),l(10,"mat-dialog-content",7)(11,"div",8)(12,"div",9)(13,"div",10)(14,"p",11),r(15,"Cliente"),a(),l(16,"p",12),r(17),a()(),l(18,"div")(19,"p",11),r(20,"Documento"),a(),l(21,"p",13),r(22),a()(),l(23,"div")(24,"p",11),r(25,"Cuota pr\xF3xima"),a(),l(26,"p",14),r(27),G(28,"number"),a(),l(29,"p",15),r(30),a()()()(),g(31,Hn,6,0,"div",16),g(32,qn,14,0),g(33,Wn,15,3,"div",17),g(34,Yn,13,0,"div",18),g(35,mi,35,21,"div",19),g(36,ui,5,1,"div",20),a(),l(37,"mat-dialog-actions",21)(38,"button",22),E("click",function(){return n.cancel()}),r(39," Cancelar "),a(),g(40,hi,4,2,"button",23)(41,fi,4,5,"button",24),a()),t&2){let d,m;s(17),S(n.data.nombreCliente),s(5),S(n.data.documentoCliente),s(5),f("S/ ",H(28,11,(d=n.cuotaMasProxima())==null?null:d.monto,"1.2-2")),s(3),f("Vence: ",n.formatDate((m=n.cuotaMasProxima())==null?null:m.dueDate)),s(),h(n.cuotasPendientes().length>1?31:-1),s(),h(n.selectedFile()?-1:32),s(),h(n.selectedFile()&&!n.isUploading()&&!n.uploadResponse()?33:-1),s(),h(n.isUploading()?34:-1),s(),h(n.uploadResponse()?35:-1),s(),h(n.errorMessage()?36:-1),s(4),h(n.uploadResponse()?41:40)}},dependencies:[ie,Ye,We,qe,$e,Be,Ue,je,ze,Je,Ke,Ze,se],styles:["[_nghost-%COMP%]{display:block}"]});let o=c;return o})();var $t=(()=>{let c=class c{constructor(e){this.apiService=e,this.systemConfig={campana:{id:"CAMP-001",nombre:"Cartera Vencida Q3 2025",tipo:"Cobranza Temprana"},tipificaciones:{contacto:[{id:"CPC",codigo:"CPC",label:"Contacto con Cliente"},{id:"CTT",codigo:"CTT",label:"Contacto con Tercero"},{id:"NCL",codigo:"NCL",label:"No Contesta"},{id:"BZN",codigo:"BZN",label:"Buz\xF3n de Voz"},{id:"OCP",codigo:"OCP",label:"Ocupado"},{id:"FTN",codigo:"FTN",label:"Fuera de Tono"},{id:"NEQ",codigo:"NEQ",label:"N\xFAmero Equivocado"},{id:"TEL",codigo:"TEL",label:"Tel\xE9fono Inv\xE1lido"},{id:"CLG",codigo:"CLG",label:"Cliente Colg\xF3"},{id:"RCH",codigo:"RCH",label:"Rechaz\xF3 Llamada"}],gestion:[{id:"ACP",codigo:"ACP",label:"Acepta Compromiso de Pago",requiere_pago:!0,requiere_fecha:!0},{id:"PGR",codigo:"PGR",label:"Pago Realizado - Completo",requiere_pago:!0},{id:"PGP",codigo:"PGP",label:"Pago Parcial Realizado",requiere_pago:!0},{id:"PGT",codigo:"PGT",label:"Pago Total de Deuda",requiere_pago:!0},{id:"PPR",codigo:"PPR",label:"Pago Programado",requiere_pago:!0,requiere_fecha:!0},{id:"SRP",codigo:"SRP",label:"Solicita Refinanciamiento",requiere_seguimiento:!0},{id:"SQA",codigo:"SQA",label:"Solicita Quita o Descuento",requiere_seguimiento:!0},{id:"SCN",codigo:"SCN",label:"Solicita Congelamiento",requiere_seguimiento:!0},{id:"SPL",codigo:"SPL",label:"Solicita Ampliaci\xF3n de Plazo",requiere_seguimiento:!0},{id:"DPD",codigo:"DPD",label:"Disputa de Deuda",requiere_seguimiento:!0},{id:"NRD",codigo:"NRD",label:"No Reconoce Deuda",requiere_seguimiento:!0},{id:"DIF",codigo:"DIF",label:"Dificultad Financiera Temporal",requiere_seguimiento:!0},{id:"DSE",codigo:"DSE",label:"Desempleo",requiere_seguimiento:!0},{id:"ENF",codigo:"ENF",label:"Enfermedad/Incapacidad",requiere_seguimiento:!0},{id:"FLC",codigo:"FLC",label:"Fallecimiento del Titular",requiere_seguimiento:!0},{id:"RCL",codigo:"RCL",label:"Reclamo Registrado",requiere_seguimiento:!0},{id:"FRD",codigo:"FRD",label:"Reporte de Fraude",requiere_seguimiento:!0},{id:"NCB",codigo:"NCB",label:"Sin Capacidad de Pago",requiere_seguimiento:!0},{id:"VJE",codigo:"VJE",label:"Viaje/Fuera del Pa\xEDs",requiere_fecha:!0},{id:"SLL",codigo:"SLL",label:"Solicita Llamar Despu\xE9s",requiere_fecha:!0},{id:"NIN",codigo:"NIN",label:"No est\xE1 Interesado"},{id:"AGR",codigo:"AGR",label:"Cliente Agresivo/Hostil"},{id:"NBL",codigo:"NBL",label:"No Desea Ser Contactado"},{id:"LGL",codigo:"LGL",label:"Amenaza Legal"},{id:"CNV",codigo:"CNV",label:"Acepta Convenio de Pago",requiere_cronograma:!0,requiere_fecha:!0},{id:"CRO",codigo:"CRO",label:"Solicita Cronograma de Pagos",requiere_cronograma:!0,requiere_cuotas:!0},{id:"CPP",codigo:"CPP",label:"Convenio con Pago Parcial Inicial",requiere_cronograma:!0,requiere_monto_inicial:!0},{id:"CTT",codigo:"CTT",label:"Convenio a Plazo Total",requiere_cronograma:!0,requiere_periodicidad:!0},{id:"CCG",codigo:"CCG",label:"Convenio con Congelamiento",requiere_cronograma:!0,requiere_fecha:!0},{id:"CRF",codigo:"CRF",label:"Convenio con Refinanciamiento",requiere_cronograma:!0,requiere_seguimiento:!0},{id:"CQT",codigo:"CQT",label:"Convenio con Quita/Descuento",requiere_cronograma:!0,requiere_pago:!0},{id:"CAP",codigo:"CAP",label:"Convenio Aprobado por Supervisor",requiere_cronograma:!0,requiere_autorizacion:!0},{id:"CRC",codigo:"CRC",label:"Cliente Rechaza Convenio Propuesto",requiere_seguimiento:!0},{id:"CEV",codigo:"CEV",label:"Convenio en Evaluaci\xF3n",requiere_seguimiento:!0,requiere_fecha:!0}],motivo_no_pago:[{id:"FRE",label:"Falta de Recursos Econ\xF3micos"},{id:"DSP",label:"Desempleo Reciente"},{id:"RDS",label:"Reducci\xF3n de Salario"},{id:"EMR",label:"Emergencia M\xE9dica"},{id:"GSF",label:"Gastos Familiares Imprevistos"},{id:"OGS",label:"Otros Gastos Prioritarios"},{id:"NGC",label:"Negocio/Comercio en Crisis"},{id:"DCP",label:"Desconoce el Cargo/Producto"},{id:"IFC",label:"Inconformidad con Servicio"},{id:"FCC",label:"Fraude o Cargo no Reconocido"},{id:"OLV",label:"Olvido de Fecha de Pago"},{id:"PRG",label:"Problemas con M\xE9todo de Pago"},{id:"BNK",label:"Problemas Bancarios"},{id:"OTR",label:"Otro Motivo"}]},metodos_pago:[{id:"TDC",codigo:"TDC",label:"Tarjeta de Cr\xE9dito",icono:"\u{1F4B3}",requiere_ultimos4:!0},{id:"TDD",codigo:"TDD",label:"Tarjeta de D\xE9bito",icono:"\u{1F4B3}",requiere_ultimos4:!0},{id:"TRF",codigo:"TRF",label:"Transferencia Bancaria",icono:"\u{1F3E6}",requiere_banco:!0},{id:"DEP",codigo:"DEP",label:"Dep\xF3sito en Cuenta",icono:"\u{1F3E6}",requiere_banco:!0},{id:"EFE",codigo:"EFE",label:"Efectivo en Agencia",icono:"\u{1F4B5}",requiere_agencia:!0},{id:"CAU",codigo:"CAU",label:"Cargo Autom\xE1tico",icono:"\u{1F504}",requiere_autorizacion:!0},{id:"YPE",codigo:"YPE",label:"Yape",icono:"\u{1F4F1}",requiere_telefono:!0},{id:"PLN",codigo:"PLN",label:"Plin",icono:"\u{1F4F1}",requiere_telefono:!0},{id:"TNK",codigo:"TNK",label:"Tunki",icono:"\u{1F4F1}",requiere_telefono:!0},{id:"PGW",codigo:"PGW",label:"Pasarela Web/Link de Pago",icono:"\u{1F310}",requiere_email:!0}],bancos:["BCP - Banco de Cr\xE9dito del Per\xFA","BBVA","Interbank","Scotiabank","BanBif","Banco Pichincha","Banco Falabella","Banco Ripley","Banco Azteca","Otros"],cronograma_config:{periodicidades:[{id:"SEM",label:"Semanal",dias:7},{id:"QUI",label:"Quincenal",dias:15},{id:"MEN",label:"Mensual",dias:30},{id:"BIM",label:"Bimestral",dias:60},{id:"TRI",label:"Trimestral",dias:90}],tipos_cronograma:[{id:"FIJ",label:"Cuotas Fijas",descripcion:"Mismo monto cada cuota"},{id:"DEC",label:"Decreciente",descripcion:"Cuotas van disminuyendo"},{id:"ESC",label:"Escalonado",descripcion:"Cuotas aumentan gradualmente"},{id:"PER",label:"Personalizado",descripcion:"Montos espec\xEDficos por cuota"}],campos_requeridos:{requiere_cronograma:["numero_cuotas","periodicidad","fecha_primera_cuota"],requiere_cuotas:["numero_cuotas","monto_cuota"],requiere_monto_inicial:["monto_inicial","fecha_pago_inicial"],requiere_periodicidad:["periodicidad","dia_pago"],requiere_autorizacion:["supervisor_id","codigo_autorizacion"]},validaciones:{numero_cuotas_max:48,numero_cuotas_min:2,monto_minimo_cuota:50,porcentaje_quita_max:30,dias_gracia_max:90}}}}getSystemConfig(){return this.systemConfig}getCampaign(){return this.apiService.getActiveCampaign()||this.systemConfig.campana}getContactClassifications(){let e=this.apiService.tenantClassifications();if(e.length>0){let n=e.filter(d=>d.typification.tipoClasificacion==="CONTACT_RESULT"&&d.isEnabled).map(d=>({id:d.typification.id,codigo:d.typification.codigo,label:d.customName||d.typification.nombre}));if(n.length>0)return n}let t=this.apiService.getContactClassificationsForUI();return t.length>0?t:this.systemConfig.tipificaciones.contacto}getManagementClassifications(){let e=this.apiService.tenantClassifications();if(e.length>0){let n=e.filter(d=>d.isEnabled).map(d=>{let m=d.typification.metadataSchema?JSON.parse(d.typification.metadataSchema):{};return{id:String(d.typification.id),codigo:d.typification.codigo,label:d.customName||d.typification.nombre,requiere_pago:m.requiresPayment||!1,requiere_cronograma:m.requiresSchedule||!1,requiere_seguimiento:m.requiresFollowUp||!1,parentId:d.typification.parentTypificationId,hierarchyLevel:d.typification.nivelJerarquia,suggestsFullAmount:d.typification.suggestsFullAmount,allowsInstallmentSelection:d.typification.allowsInstallmentSelection,requiresManualAmount:d.typification.requiresManualAmount}});if(n.length>0)return n}let t=this.apiService.getManagementClassificationsForUI();return t.length>0?t:this.systemConfig.tipificaciones.gestion}getPaymentNoReasons(){return this.systemConfig.tipificaciones.motivo_no_pago}getPaymentMethods(){return this.systemConfig.metodos_pago}getBanks(){return this.systemConfig.bancos}getScheduleConfig(){return this.systemConfig.cronograma_config}getManagementClassificationById(e){return this.getManagementClassifications().find(d=>d.id==e)}};c.\u0275fac=function(t){return new(t||c)(ge(Xe))},c.\u0275prov=te({token:c,factory:c.\u0275fac,providedIn:"root"});let o=c;return o})();var zt=(()=>{let c=class c{constructor(e){this.http=e,this.baseUrl=`${K.gatewayUrl}/v2/management-records`,this.scheduleUrl=`${K.tipificacionUrl}/payment-schedules`,this.cabecerasUrl=`${K.gatewayUrl}/configuracion-cabeceras`}createManagement(e){let t=this.transformToBackendFormat(e);return console.log("[MANAGEMENT] Creating management record:",t),this.http.post(this.baseUrl,t).pipe(Se(n=>this.transformToFrontendFormat(n,e)))}getManagementById(e){return this.http.get(`${this.baseUrl}/${e}`).pipe(Se(t=>this.transformToFrontendFormat(t)))}getManagementsByCustomer(e){return this.http.get(`${this.baseUrl}/client/${e}`).pipe(Se(t=>t.map(n=>this.transformToFrontendFormat(n))))}getManagementsByAdvisor(e){return this.http.get(`${this.baseUrl}/agent/${e}`).pipe(Se(t=>t.map(n=>this.transformToFrontendFormat(n))))}getActiveSchedulesByCustomer(e){return console.log("[SCHEDULE] Fetching active schedules for customer:",e),this.http.get(`${this.baseUrl}/payment-schedule/client/${e}/active`).pipe(Se(t=>this.transformToPaymentSchedules(t)))}transformToPaymentSchedules(e){return e.map(t=>{let n=t.cuotasPromesa||[],d=n.reduce((y,M)=>y+(M.monto||0),0),m=n.filter(y=>y.estado==="PAGADA"||y.estado==="CUMPLIDO").reduce((y,M)=>y+(M.montoPagadoReal||M.monto||0),0),p=d-m,x=n.filter(y=>y.estado==="PAGADA"||y.estado==="CUMPLIDO").length,v=n.filter(y=>y.estado==="PENDIENTE").length;return{id:t.id,scheduleId:{scheduleId:t.grupoPromesaUuid||t.uuid},customerId:String(t.idCliente),managementId:String(t.id),totalAmount:d,numberOfInstallments:n.length,startDate:t.fechaGestion?.split("T")[0]||new Date().toISOString().split("T")[0],isActive:v>0,scheduleType:t.tipoCronograma||"CONFIANZA",negotiatedAmount:t.montoPromesaPago||d,installments:n.map(y=>({id:y.id,installmentNumber:y.numeroCuota,numeroCuota:y.numeroCuota,amount:y.monto,monto:y.monto,dueDate:y.fechaPago,fechaPago:y.fechaPago,paidDate:y.fechaPagoReal||null,status:y.estado||"PENDIENTE"})),paidAmount:m,pendingAmount:p,paidInstallments:x,pendingInstallments:v,fullyPaid:v===0}})}startCall(e,t){return console.log("[CALL] Start call for management:",e,t),this.getManagementById(e.toString())}endCall(e,t){return console.log("[CALL] End call for management:",e,t),this.getManagementById(e.toString())}registerPayment(e,t){return console.log("[PAYMENT] Register payment for management:",e,t),this.getManagementById(e)}createPaymentSchedule(e){return console.log("[SCHEDULE] Creating payment schedule:",e),this.http.post(`${this.baseUrl}/payment-schedule`,e)}updatePaymentStatus(e,t,n,d){console.log("[PAYMENT-STATUS] Updating payment status:",{recordId:e,estadoPago:t,montoPagadoReal:n,fechaPagoReal:d});let m=`estadoPago=${t}`;return n!==void 0&&(m+=`&montoPagadoReal=${n}`),d&&(m+=`&fechaPagoReal=${d}`),this.http.put(`${this.baseUrl}/${e}/payment-status?${m}`,{})}puedeCancelarCuota(e){return console.log("[CUOTA] Checking if cuota can be canceled:",e),this.http.get(`${this.baseUrl}/cuota/${e}/puede-cancelar`)}cancelarCuota(e,t,n,d){console.log("[CUOTA] Canceling cuota:",{cuotaId:e,montoPagadoReal:t,fechaPagoReal:n,observaciones:d});let m="",p=[];return t!==void 0&&p.push(`montoPagadoReal=${t}`),n&&p.push(`fechaPagoReal=${n}`),d&&p.push(`observaciones=${encodeURIComponent(d)}`),p.length>0&&(m="?"+p.join("&")),this.http.put(`${this.baseUrl}/cuota/${e}/cancelar${m}`,{})}getMontoCabeceras(e){return console.log("[CABECERAS] Fetching monto cabeceras for subcartera:",e),this.http.get(`${this.cabecerasUrl}/subcartera/${e}/montos`)}transformToBackendFormat(e){let t=e.level3Id||e.level2Id||e.level1Id,n=[];e.level1Name&&n.push(e.level1Name),e.level2Name&&n.push(e.level2Name),e.level3Name&&n.push(e.level3Name);let d=n.join(" > "),m={idTenant:e.tenantId,idCartera:e.portfolioId,idSubcartera:e.subPortfolioId||void 0,idCliente:Number(e.customerId),nombreCliente:e.customerName||void 0,documentoCliente:e.customerDocument||void 0,idAgente:this.extractAgentId(e.advisorId),tipificacion:{id:t},observaciones:e.observations||"",canalContacto:e.canalContacto||"SISTEMA",metodoContacto:e.metodoContacto||"GESTION_MANUAL",estadoGestion:"COMPLETADA",rutaJerarquia:d||void 0,idCampana:e.idCampana||void 0,idLlamada:e.idLlamada||void 0,duracionSegundos:e.duracionSegundos||void 0,nombreAgente:e.nombreAgente||void 0,userAgent:e.userAgent||void 0};return e.level1Id&&(m.tipificacionNivel1={id:e.level1Id}),e.level2Id&&(m.tipificacionNivel2={id:e.level2Id}),e.level3Id&&(m.tipificacionNivel3={id:e.level3Id}),m}transformToFrontendFormat(e,t){return{id:e.id||0,customerId:String(e.idCliente),advisorId:String(e.idAgente),tenantId:e.idTenant,tenantName:"",portfolioId:e.idCartera||0,portfolioName:"",subPortfolioId:e.idSubcartera,subPortfolioName:"",phone:e.canalContacto||"",level1Id:e.tipificacionNivel1?.id||e.tipificacion?.id||0,level1Name:t?.level1Name||e.tipificacionNivel1?.nombre||"",level2Id:e.tipificacionNivel2?.id,level2Name:t?.level2Name||e.tipificacionNivel2?.nombre||"",level3Id:e.tipificacionNivel3?.id,level3Name:t?.level3Name||e.tipificacionNivel3?.nombre||"",observations:e.observaciones,managementDate:e.fechaGestion?.split("T")[0],managementTime:e.fechaGestion?.split("T")[1]?.substring(0,8)}}extractAgentId(e){return e.startsWith("ADV-")?1:Number(e)||1}};c.\u0275fac=function(t){return new(t||c)(ge(oe))},c.\u0275prov=te({token:c,factory:c.\u0275fac,providedIn:"root"});let o=c;return o})();var jt=(()=>{let c=class c{constructor(){this.http=Me(oe),this.apiUrl=`${K.tipificacionUrl}/customer-outputs`}saveConfiguration(e){return this.http.post(`${this.apiUrl}/config`,e)}getConfiguration(e,t){let n={tenantId:e};return t!=null&&(n.portfolioId=t),this.http.get(`${this.apiUrl}/config`,{params:n})}};c.\u0275fac=function(t){return new(t||c)},c.\u0275prov=te({token:c,factory:c.\u0275fac,providedIn:"root"});let o=c;return o})();var Gt=(()=>{let c=class c{constructor(e){this.http=e,this.apiUrl=`${K.apiUrl}/customers`}getAllCustomers(){return this.http.get(this.apiUrl)}getCustomerById(e){return this.http.get(`${this.apiUrl}/${e}`)}getCustomerByDocument(e){return this.http.get(`${this.apiUrl}/document/${e}`)}searchCustomers(e){return this.http.get(`${this.apiUrl}/search`,{params:{q:e}})}filterCustomers(e){return this.http.get(`${this.apiUrl}/filter`,{params:Z({},e)})}createCustomer(e){return this.http.post(this.apiUrl,e)}updateCustomer(e,t){return this.http.put(`${this.apiUrl}/${e}`,t)}deleteCustomer(e){return this.http.delete(`${this.apiUrl}/${e}`)}getCustomerDetail(e,t){return this.http.get(`${this.apiUrl}/detail/${e}`,{params:{subPortfolioId:t.toString()}})}searchCustomerByCriteria(e,t,n){return this.http.get(`${this.apiUrl}/search-by`,{params:{tenantId:e.toString(),searchBy:t,value:n}})}searchCustomersByCriteria(e,t,n){return this.http.get(`${this.apiUrl}/search-by-multi`,{params:{tenantId:e.toString(),searchBy:t,value:n}})}searchCustomersAcrossAllTenants(e,t){return this.http.get(`${this.apiUrl}/search-all-tenants`,{params:{searchBy:e,value:t}})}getRecentCustomers(){return this.http.get(`${this.apiUrl}/recent`)}registerCustomerAccess(e){return this.http.post(`${this.apiUrl}/${e}/access`,{})}findClientByDocumento(e,t,n,d){return this.http.get(`${K.apiUrl}/client-search/find`,{params:{tenantId:e.toString(),portfolioId:t.toString(),subPortfolioId:n.toString(),documento:d}})}};c.\u0275fac=function(t){return new(t||c)(ge(oe))},c.\u0275prov=te({token:c,factory:c.\u0275fac,providedIn:"root"});let o=c;return o})();var Si=["dynamicFieldRendererComponent"],Ce=(o,c)=>c.id,ct=(o,c)=>c.numeroCuota,yi=(o,c)=>c.field;function Ei(o,c){o&1&&(l(0,"div",2)(1,"div",62)(2,"div")(3,"div",63),r(4,"\xA1Gesti\xF3n Guardada!"),a(),l(5,"div",64),r(6,"Los datos se registraron correctamente"),a()()()())}function Di(o,c){o&1&&B(0,"div",66)}function ki(o,c){if(o&1){let i=N();l(0,"button",65),E("click",function(){let t=_(i).$implicit,n=u();return C(n.activeTab.set(t.id))}),r(1),g(2,Di,1,0,"div",66),a()}if(o&2){let i=c.$implicit,e=u();D("flex-1 px-2 py-1.5 text-[11px] font-semibold transition-all relative "+(e.activeTab()===i.id?"text-blue-700 dark:text-blue-200 bg-blue-50 dark:bg-blue-950/50":"text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800")),s(),f(" ",i.label," "),s(),h(e.activeTab()===i.id?2:-1)}}function wi(o,c){if(o&1&&(l(0,"div",67)(1,"div",69),r(2),a(),l(3,"div",70),r(4),a()()),o&2){let i=c.$implicit,e=u(2);s(2),S(i.label),s(2),f(" ",e.formatFieldValue(e.getFieldValue(i.field),i.format)," ")}}function Pi(o,c){o&1&&(l(0,"div",68),r(1," Sin campos configurados "),a())}function Mi(o,c){if(o&1&&(l(0,"div",21),q(1,wi,5,2,"div",67,Ce),g(3,Pi,2,0,"div",68),a()),o&2){let i=u();s(),W(i.customerOutputFields()),s(2),h(i.customerOutputFields().length===0?3:-1)}}function Ii(o,c){if(o&1){let i=N();l(0,"div",71)(1,"p",72),r(2,"Sin gestiones previas"),a(),l(3,"button",73),E("click",function(){_(i);let t=u(2);return C(t.loadManagementHistory())}),r(4,"Recargar"),a()()}}function Ti(o,c){if(o&1){let i=N();l(0,"button",81),E("click",function(){_(i);let t=u().$implicit,n=u(3);return C(n.openScheduleDetail(t.id))}),r(1," Ver cronograma \u2192 "),a()}}function Ai(o,c){if(o&1&&(l(0,"div",74)(1,"div",75)(2,"span",76),r(3),a(),l(4,"span",77),r(5),a()(),l(6,"div",78),r(7),a(),l(8,"div",79),r(9),a(),g(10,Ti,2,0,"button",80),a()),o&2){let i=c.$implicit;s(3),S(i.fecha),s(2),S(i.asesor),s(2),S(i.gestion),s(2),S(i.observacion),s(),h(i.schedule?10:-1)}}function Fi(o,c){if(o&1&&q(0,Ai,11,5,"div",74,it),o&2){let i=u(2);W(i.historialGestiones())}}function Ni(o,c){if(o&1&&(l(0,"div",22),g(1,Ii,5,0,"div",71)(2,Fi,2,0),a()),o&2){let i=u();s(),h(i.historialGestiones().length===0?1:2)}}function Ri(o,c){if(o&1&&(l(0,"option",87),r(1),a()),o&2){let i=c.$implicit;O("value",i.id),s(),fe("[",i.codigo,"] ",i.label)}}function Vi(o,c){o&1&&(l(0,"div",88),r(1," Requerido "),a())}function Oi(o,c){if(o&1){let i=N();l(0,"div",29)(1,"label",82),B(2,"div",83),r(3," Resultado de Contacto * "),a(),l(4,"div",84)(5,"select",85),_e("ngModelChange",function(t){_(i);let n=u();return be(n.managementForm.resultadoContacto,t)||(n.managementForm.resultadoContacto=t),C(t)}),E("ngModelChange",function(){_(i);let t=u();return C(t.onContactResultChange())}),l(6,"option",86),r(7,"-- Seleccionar resultado --"),a(),q(8,Ri,2,3,"option",87,Ce),a()(),g(10,Vi,2,0,"div",88),a()}if(o&2){let i=u();s(5),D("w-full p-2 pr-8 border rounded-lg font-semibold text-gray-700 dark:text-white appearance-none cursor-pointer transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-200 dark:focus:ring-blue-800 hover:border-blue-400 dark:hover:border-blue-600 text-xs "+(i.errors().resultadoContacto?"border-red-500 bg-red-50 dark:bg-red-950/30 dark:border-red-600":"border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-900")+" "+(i.managementForm.resultadoContacto?"bg-blue-50 dark:bg-blue-950/30 border-blue-400 dark:border-blue-600":"")),xe("ngModel",i.managementForm.resultadoContacto),s(3),W(i.contactClassifications()),s(2),h(i.errors().resultadoContacto?10:-1)}}function Li(o,c){o&1&&(l(0,"span",108),B(1,"lucide-angular",112),a()),o&2&&(s(),O("size",10))}function Ui(o,c){o&1&&(l(0,"span",109),B(1,"lucide-angular",113),a()),o&2&&(s(),O("size",10))}function Bi(o,c){o&1&&(l(0,"span",110),B(1,"lucide-angular",114),a()),o&2&&(s(),O("size",10))}function $i(o,c){o&1&&(l(0,"span",111),B(1,"lucide-angular",115),a()),o&2&&(s(),O("size",10))}function zi(o,c){if(o&1&&(l(0,"div",102)(1,"span",63),r(2),a(),l(3,"span",104),r(4,"|"),a(),l(5,"span",105),r(6),a(),l(7,"span",104),r(8,"|"),a(),l(9,"span",106),B(10,"lucide-angular",107),r(11),a(),g(12,Li,2,1,"span",108)(13,Ui,2,1,"span",109)(14,Bi,2,1,"span",110)(15,$i,2,1,"span",111),a()),o&2){let i=c.$implicit,e=u(3);s(2),f("C",i.numeroCuota),s(4),f("S/ ",(i.monto==null?null:i.monto.toFixed(2))||"0.00"),s(4),O("size",12),s(),f(" ",e.formatDate(i.dueDate)," "),s(),h(i.status==="PAGADA"||i.status==="PAGADO"||i.status==="CUMPLIDO"?12:i.status==="VENCIDA"||i.status==="VENCIDO"?13:i.status==="CANCELADA"||i.status==="CANCELADO"?14:15)}}function ji(o,c){if(o&1&&(l(0,"div",103)(1,"span",105),r(2),a(),r(3," pendiente(s) \xB7 Pr\xF3x: "),l(4,"span",105),r(5),a()()),o&2){let i=u().$implicit,e=u(2);s(2),S(i.cuotasPendientes),s(3),S(e.formatDate(i.nextDueDate))}}function Gi(o,c){if(o&1){let i=N();l(0,"div",89)(1,"div",90)(2,"div",91)(3,"div",92)(4,"span",93),r(5,"\u26A0"),a()(),l(6,"div")(7,"div",94),r(8,"PROMESA DE PAGO ACTIVA"),a(),l(9,"div",95),r(10,"No puede registrar otra promesa"),a()()(),l(11,"div",91)(12,"button",96),E("click",function(){let t=_(i).$implicit,n=u(2);return C(n.openVoucherPaymentDialog(t))}),B(13,"lucide-angular",97),r(14," Registrar Pago "),a(),l(15,"div",14)(16,"div",98),r(17),a(),l(18,"div",95),r(19,"Total"),a()()()(),l(20,"div",99)(21,"div",100),r(22,"DETALLE DE CUOTAS:"),a(),l(23,"div",101),q(24,zi,16,5,"div",102,ct),a(),g(26,ji,6,2,"div",103),a()()}if(o&2){let i=c.$implicit;s(13),O("size",14),s(4),f("S/ ",(i.totalAmount==null?null:i.totalAmount.toFixed(2))||"0.00"),s(7),W(i.installments),s(2),h(i.cuotasPendientes>0&&i.nextDueDate?26:-1)}}function Hi(o,c){if(o&1&&(l(0,"div",30),q(1,Gi,27,3,"div",89,Ce),a()),o&2){let i=u();s(),W(i.activePaymentSchedules())}}function qi(o,c){if(o&1&&(l(0,"option",87),r(1),a()),o&2){let i=c.$implicit;O("value",i.id),s(),fe("[",i.codigo,"] ",i.label)}}function Wi(o,c){if(o&1){let i=N();l(0,"div",118)(1,"label",119),r(2),a(),l(3,"select",85),E("ngModelChange",function(t){_(i);let n=u().$index,d=u(2);return C(d.onClassificationLevelChange(n,t))}),l(4,"option",86),r(5,"Seleccionar..."),a(),q(6,qi,2,3,"option",87,Ce),a()()}if(o&2){let i=u(),e=i.$implicit,t=i.$index,n=u(2);s(2),fe(" ",n.getDynamicLevelLabel(t),"",t===0?" *":""," "),s(),D("w-full p-1.5 border rounded text-[11px] font-medium transition-all focus:outline-none focus:ring-1 focus:ring-blue-400 "+(n.errors().tipoGestion&&t===0?"border-red-400 bg-red-50 dark:bg-red-950/30":"border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-700 dark:text-white")+" "+(n.selectedClassifications()[t]?"border-green-400 bg-green-50 dark:bg-green-950/30":"")),O("ngModel",n.selectedClassifications()[t]),s(3),W(e)}}function Yi(o,c){if(o&1&&g(0,Wi,8,5,"div",118),o&2){let i=c.$index,e=u(2);h(e.shouldShowLevel(i)?0:-1)}}function Qi(o,c){o&1&&(l(0,"div",117),r(1,"Seleccione una clasificaci\xF3n"),a())}function Ki(o,c){if(o&1&&(l(0,"div",31)(1,"div",116),r(2,"Clasificaci\xF3n"),a(),l(3,"div",101),q(4,Yi,1,1,null,null,it),a(),g(6,Qi,2,0,"div",117),a()),o&2){let i=u();s(4),W(i.hierarchyLevels()),s(2),h(i.errors().tipoGestion?6:-1)}}function Ji(o,c){o&1&&(l(0,"div",32)(1,"div",120)(2,"span",121),r(3,"Cargando campos adicionales..."),a()()())}function Zi(o,c){o&1&&(l(0,"div",33)(1,"div",122)(2,"span",121),r(3,"Esta clasificaci\xF3n no tiene campos adicionales configurados"),a()()())}function Xi(o,c){if(o&1){let i=N();l(0,"app-dynamic-field-renderer",123,0),E("dataChange",function(t){_(i);let n=u();return C(n.onDynamicFieldsChange(t))})("customAmountDetected",function(t){_(i);let n=u();return C(n.onCustomAmountDetected(t))}),a()}if(o&2){let i=u();O("schema",i.dynamicFieldsSchema())("externalUpdates",i.externalFieldUpdates())("selectedClassification",i.selectedClassification())("customerAmounts",i.customerPaymentAmounts())}}function eo(o,c){o&1&&(l(0,"div",35)(1,"div",124)(2,"span",125),r(3,"Cargando cronogramas pendientes..."),a()()())}function to(o,c){if(o&1&&(l(0,"div",137)(1,"div",7)(2,"span",138),r(3),a(),l(4,"span",139),r(5),a()(),l(6,"span",140),r(7),G(8,"number"),a()()),o&2){let i=u().$implicit,e=u(3);s(3),f("Cuota #",i.installmentNumber),s(2),f("Vence: ",e.formatDate(i.dueDate)),s(2),f("S/ ",H(8,3,i.amount,"1.2-2"))}}function no(o,c){if(o&1&&g(0,to,9,6,"div",137),o&2){let i=c.$index;h(i<3?0:-1)}}function io(o,c){if(o&1&&(l(0,"div",132),r(1),a()),o&2){let i=u().$implicit,e=u(2);s(),f(" + ",e.getPendingInstallments(i).length-3," cuotas m\xE1s ")}}function oo(o,c){if(o&1){let i=N();l(0,"button",141),E("click",function(){_(i);let t=u(3);return C(t.applyNextInstallmentPayment())}),r(1," Usar Pr\xF3xima Cuota "),a()}}function ao(o,c){if(o&1){let i=N();l(0,"button",142),E("click",function(){_(i);let t=u(3);return C(t.applyFullSchedulePayment())}),r(1),G(2,"number"),a()}if(o&2){let i=u().$implicit,e=u(2);s(),f(" Pagar Todo (S/ ",H(2,1,e.calculatePendingAmount(i),"1.2-2"),") ")}}function lo(o,c){if(o&1&&(l(0,"div",129)(1,"div",5)(2,"div",7)(3,"div",127),r(4),a(),l(5,"div",130),r(6," ACTIVO "),a()(),l(7,"div",127),r(8),G(9,"number"),a()(),l(10,"div",22)(11,"div",131),r(12,"Cuotas Pendientes"),a(),q(13,no,1,1,null,null,Ce),g(15,io,2,1,"div",132),a(),l(16,"div",133),g(17,oo,2,0,"button",134),g(18,ao,3,4,"button",135),a(),l(19,"div",136)(20,"span"),r(21,"El pago se aplicar\xE1 autom\xE1ticamente a las cuotas pendientes en orden de vencimiento"),a()()()),o&2){let i,e,t=c.$implicit,n=u(2);s(4),f(" ",t.scheduleType||"CRONOGRAMA"," "),s(4),f(" S/ ",H(9,5,t.totalAmount,"1.2-2")," "),s(5),W(n.getPendingInstallments(t)),s(2),h(n.getPendingInstallments(t).length>3?15:-1),s(2),h(((i=n.selectedClassification())==null?null:i.allowsInstallmentSelection)===!0?17:-1),s(),h(((e=n.selectedClassification())==null?null:e.suggestsFullAmount)===!0?18:-1)}}function ro(o,c){if(o&1&&(l(0,"div",36)(1,"div",5)(2,"div",7),B(3,"div",126),l(4,"div")(5,"h4",127),r(6,"Cronograma Activo Detectado"),a(),l(7,"p",128),r(8),a()()()(),q(9,lo,22,8,"div",129,Ce),a()),o&2){let i=u();s(8),f("Cliente tiene ",i.activeSchedules().length," cronograma(s) pendiente(s)"),s(),W(i.activeSchedules())}}function so(o,c){if(o&1){let i=N();l(0,"label",149)(1,"div",91)(2,"input",150),E("change",function(){let t=_(i).$implicit,n=u(3);return C(n.selectedInstallmentForCancellation.set(t))}),a(),l(3,"div")(4,"span",151),r(5),a(),l(6,"span",152),r(7),a()()(),l(8,"span",94),r(9),a()()}if(o&2){let i,e,t,n=c.$implicit,d=u(3);D(((i=d.selectedInstallmentForCancellation())==null?null:i.numeroCuota)===n.numeroCuota?"bg-green-500 text-white shadow-md":"bg-white dark:bg-gray-800 hover:bg-green-100 dark:hover:bg-green-900/30 border border-green-200 dark:border-green-700"),s(2),O("value",n)("checked",((e=d.selectedInstallmentForCancellation())==null?null:e.numeroCuota)===n.numeroCuota),s(3),f("Cuota ",n.numeroCuota),s(),D(((t=d.selectedInstallmentForCancellation())==null?null:t.numeroCuota)===n.numeroCuota?"text-green-100":"text-gray-500 dark:text-gray-400"),s(),f(" Vence: ",d.formatDate(n.dueDate)," "),s(2),f("S/ ",(n.monto==null?null:n.monto.toFixed(2))||"0.00")}}function co(o,c){if(o&1&&(l(0,"div",59),q(1,so,10,9,"label",148,ct),a()),o&2){let i=u(2);s(),W(i.pendingInstallmentsForCancellation())}}function mo(o,c){if(o&1&&(l(0,"div",156)(1,"div",91)(2,"span",158),r(3,"\u2717"),a(),l(4,"div")(5,"span",159),r(6),a(),l(7,"span",160),r(8),a()()(),l(9,"span",161),r(10),a()()),o&2){let i=c.$implicit,e=u(3);s(6),f("Cuota ",i.numeroCuota),s(2),f(" Venci\xF3: ",e.formatDate(i.dueDate)," "),s(2),f("S/ ",(i.monto==null?null:i.monto.toFixed(2))||"0.00")}}function uo(o,c){if(o&1&&(l(0,"div",145)(1,"div",153)(2,"span",154),r(3,"\u26D4"),a(),l(4,"span",155),r(5,"CUOTAS VENCIDAS (No se pueden cancelar)"),a()(),l(6,"div",22),q(7,mo,11,3,"div",156,ct),a(),l(9,"div",157),r(10," La fecha de pago ya pas\xF3. Estas cuotas ser\xE1n marcadas como promesa rota. "),a()()),o&2){let i=u(2);s(7),W(i.overdueInstallments())}}function po(o,c){o&1&&(l(0,"div",146)(1,"span"),r(2,"\u{1F6AB}"),a(),l(3,"span"),r(4,"No hay cuotas disponibles para cancelar. Todas las cuotas est\xE1n vencidas."),a()())}function go(o,c){o&1&&(l(0,"div",147)(1,"span"),r(2,"\u26A0\uFE0F"),a(),l(3,"span"),r(4,"Debe seleccionar una cuota para registrar la cancelaci\xF3n"),a()())}function ho(o,c){if(o&1&&(l(0,"div",37)(1,"div",7)(2,"span",93),r(3,"\u{1F4B0}"),a(),l(4,"div")(5,"h4",143),r(6,"Seleccionar Cuota a Cancelar"),a(),l(7,"p",144),r(8,"Elija qu\xE9 cuota de la promesa de pago est\xE1 cancelando"),a()()(),g(9,co,3,0,"div",59),g(10,uo,11,0,"div",145),g(11,po,5,0,"div",146)(12,go,5,0,"div",147),a()),o&2){let i=u();s(9),h(i.pendingInstallmentsForCancellation().length>0?9:-1),s(),h(i.overdueInstallments().length>0?10:-1),s(),h(i.pendingInstallmentsForCancellation().length===0&&i.overdueInstallments().length>0?11:!i.selectedInstallmentForCancellation()&&i.pendingInstallmentsForCancellation().length>0?12:-1)}}function fo(o,c){o&1&&r(0," \u2705 Comprobante Subido ")}function xo(o,c){o&1&&r(0," \u{1F4E4} Subir Comprobante ")}function bo(o,c){if(o&1&&(l(0,"p")(1,"strong"),r(2,"Monto detectado:"),a(),r(3),G(4,"number"),a()),o&2){let i,e=u(3);s(3),f(" S/ ",H(4,1,(i=e.uploadedComprobante())==null||i.ocrResult==null?null:i.ocrResult.monto,"1.2-2"))}}function _o(o,c){if(o&1&&(l(0,"p")(1,"strong"),r(2,"Banco:"),a(),r(3),a()),o&2){let i,e=u(3);s(3),f(" ",(i=e.uploadedComprobante())==null||i.ocrResult==null?null:i.ocrResult.banco)}}function Co(o,c){if(o&1){let i=N();l(0,"div",163)(1,"p",164),r(2),a(),g(3,bo,5,4,"p"),g(4,_o,4,1,"p"),l(5,"button",165),E("click",function(){_(i);let t=u(2);return C(t.uploadedComprobante.set(null))}),r(6," Quitar comprobante "),a()()}if(o&2){let i,e,t,n=u(2);s(2),S((i=n.uploadedComprobante())==null?null:i.mensaje),s(),h(!((e=n.uploadedComprobante())==null||e.ocrResult==null)&&e.ocrResult.monto?3:-1),s(),h(!((t=n.uploadedComprobante())==null||t.ocrResult==null)&&t.ocrResult.banco?4:-1)}}function vo(o,c){if(o&1){let i=N();l(0,"div",38)(1,"div",5)(2,"div",7)(3,"span",93),r(4,"\u{1F4CE}"),a(),l(5,"div")(6,"h4",127),r(7,"Comprobante de Pago"),a(),l(8,"p",128),r(9,"Opcional: Sube una imagen del voucher para validaci\xF3n OCR"),a()()(),l(10,"button",162),E("click",function(){_(i);let t=u();return C(t.openComprobanteUploadDialog())}),g(11,fo,1,0)(12,xo,1,0),a()(),g(13,Co,7,3,"div",163),a()}if(o&2){let i=u();s(10),D(i.uploadedComprobante()?"bg-green-500 hover:bg-green-600 text-white":"bg-purple-600 hover:bg-purple-700 text-white"),s(),h(i.uploadedComprobante()?11:12),s(2),h(i.uploadedComprobante()?13:-1)}}function So(o,c){o&1&&(l(0,"span",167),r(1,"\u23F3 Esperando Autorizaci\xF3n..."),a())}function yo(o,c){o&1&&r(0," \u{1F510} Solicitar Autorizaci\xF3n ")}function Eo(o,c){if(o&1){let i=N();l(0,"button",166),E("click",function(){_(i);let t=u();return C(t.openSupervisorSelectionModal())}),g(1,So,2,0,"span",167)(2,yo,1,0),a()}if(o&2){let i=u();O("disabled",i.saving()||!i.isFormValid()||i.waitingForAuthorization()),s(),h(i.waitingForAuthorization()?1:2)}}function Do(o,c){o&1&&r(0," Guardando... ")}function ko(o,c){o&1&&r(0," Guardar Gesti\xF3n ")}function wo(o,c){if(o&1){let i=N();l(0,"button",168),E("click",function(){_(i);let t=u();return C(t.saveManagement())}),g(1,Do,1,0)(2,ko,1,0),a()}if(o&2){let i=u();O("disabled",i.saving()||!i.isFormValid()||i.isCancellationTypification()&&(i.pendingInstallmentsForCancellation().length>0||i.overdueInstallments().length>0)&&!i.selectedInstallmentForCancellation()||i.isCancellationTypification()&&i.pendingInstallmentsForCancellation().length===0&&i.overdueInstallments().length>0)("title","Guardando: "+i.saving()+" | V\xE1lido: "+i.isFormValid()),s(),h(i.saving()?1:2)}}function Po(o,c){if(o&1&&(l(0,"div",51)(1,"span",169),r(2,"\u{1F4DE}"),a(),l(3,"div",48)(4,"div",170),r(5,"Alternativo"),a(),l(6,"div",171),r(7),a()()()),o&2){let i=u();s(7),S(i.customerData().contacto.telefono_alternativo)}}function Mo(o,c){if(o&1&&(l(0,"div",51)(1,"span",169),r(2,"\u{1F3E2}"),a(),l(3,"div",48)(4,"div",170),r(5,"Trabajo"),a(),l(6,"div",171),r(7),a()()()),o&2){let i=u();s(7),S(i.customerData().contacto.telefono_trabajo)}}function Io(o,c){if(o&1&&(l(0,"div",52)(1,"span",172),r(2,"\u2709\uFE0F"),a(),l(3,"div",173),r(4),a()()),o&2){let i=u();s(4),S(i.customerData().contacto.email)}}function To(o,c){if(o&1&&(l(0,"div",52)(1,"span",174),r(2,"\u{1F4CD}"),a(),l(3,"div",175),r(4),a()()),o&2){let i=u();s(4),S(i.customerData().contacto.direccion)}}function Ao(o,c){if(o&1&&(l(0,"div",177)(1,"span",178),r(2),a(),l(3,"span",179),r(4),a()()),o&2){let i=c.$implicit,e=c.$index,t=u(2);D(t.getAmountRowClass(e)),s(2),S(i.label),s(2),f(" ",t.formatCurrency(i.value)," ")}}function Fo(o,c){if(o&1&&(l(0,"div",59),q(1,Ao,5,4,"div",176,yi),a()),o&2){let i=u();s(),W(i.clientAmountFields())}}function No(o,c){if(o&1){let i=N();l(0,"div",60)(1,"div",180)(2,"div",181)(3,"div",91)(4,"div")(5,"h2",182),r(6,"Cronograma de Pagos"),a(),l(7,"p",64),r(8),a()()(),l(9,"button",183),E("click",function(){_(i);let t=u();return C(t.closeScheduleDetail())}),a()(),l(10,"div",184),B(11,"app-payment-schedule-view",185),a(),l(12,"div",186)(13,"button",187),E("click",function(){_(i);let t=u();return C(t.closeScheduleDetail())}),r(14," Cerrar "),a()()()()}if(o&2){let i=u();s(8),f("Gesti\xF3n ",i.scheduleManagementId()),s(3),O("managementId",i.scheduleManagementId())}}var rl=(()=>{let c=class c{constructor(e,t,n,d,m,p,x,v,y,M,j,$,F,k,X,de,ee,J,tt,me){this.systemConfigService=e,this.managementService=t,this.paymentScheduleService=n,this.themeService=d,this.classificationService=m,this.typificationV2Service=p,this.apiSystemConfigService=x,this.customerOutputConfigService=v,this.customerService=y,this.router=M,this.route=j,this.http=$,this.sipService=F,this.agentService=k,this.agentStatusService=X,this.authService=de,this.autorizacionService=ee,this.recordatoriosService=J,this.dialog=tt,this.comprobanteService=me,this.callActive=b(!1),this.callDuration=b(0),this.saving=b(!1),this.showScheduleDetail=b(!1),this.scheduleManagementId=b(null),this.showOutputSelector=!1,this.errors=b({}),this.showSuccess=b(!1),this.animateEntry=b(!0),this.activeTab=b("cliente"),this.isTipifying=b(!1),this.colorIndicador=b("verde"),this.excedeTiempoMaximo=b(!1),this.requiresAuthorization=b(!1),this.waitingForAuthorization=b(!1),this.showSupervisorModal=!1,this.currentAuthorizationData=null,this.historialGestiones=b([]),this.tenants=[],this.portfolios=[],this.testDocument="",this.testPhone="",this.customerOutputFields=b([]),this.campaign=U(()=>this.systemConfigService.getCampaign()),this.contactClassifications=U(()=>this.systemConfigService.getContactClassifications()),this.managementClassifications=U(()=>this.apiSystemConfigService.getManagementClassificationsForUI()),this.managementClassificationsHierarchical=U(()=>{let T=this.managementClassifications(),z=new Map,R=new Map;T.forEach(P=>{let I=String(P.id);z.set(I,P),R.set(I,[])}),T.forEach(P=>{if(P.parentId){let I=String(P.parentId),L=R.get(I);L&&L.push(P)}});let w=(P,I=0)=>{let L=[];return P.forEach(le=>{L.push(pe(Z({},le),{indentLevel:I,displayLabel:"  ".repeat(I)+(I>0?"\u2514\u2500 ":"")+`[${le.codigo}] ${le.label}`}));let ce=String(le.id),ue=R.get(ce)||[];ue.length>0&&L.push(...w(ue,I+1))}),L},A=T.filter(P=>!P.parentId);return w(A,0)}),this.paymentMethods=U(()=>this.systemConfigService.getPaymentMethods()),this.scheduleTypes=U(()=>this.systemConfigService.getScheduleConfig().tipos_cronograma),this.periodicities=U(()=>this.systemConfigService.getScheduleConfig().periodicidades),this.customerPaymentAmounts=U(()=>{let T=this.rawClientData(),z=this.enabledPaymentOptions(),R=this.hasPaymentOptionsConfig(),w=this.montoCabeceras();if(!T||Object.keys(T).length===0)return console.log("[PAYMENT] No raw client data available"),[];let A=new Map;for(let I of w)A.set(I.codigo.toLowerCase(),I.nombre);let P=[];if(R){for(let I of z){if(I.codigoOpcion==="personalizado"){P.push({label:"Otro monto",value:-1,field:"personalizado"});continue}let L=I.campoTablaDinamica;if(!L)continue;let le=Object.keys(T).find(nt=>nt.toLowerCase()===L.toLowerCase());if(!le)continue;let ce=T[le],ue=typeof ce=="number"?ce:parseFloat(String(ce));if(!isNaN(ue)&&ue>=0){let nt=A.get(L.toLowerCase())||I.labelOpcion||this.formatFieldLabel(L);P.push({label:nt,value:ue,field:L,restriccionFecha:I.restriccionFecha||"SIN_RESTRICCION"})}}console.log("[PAYMENT] Amounts from CONFIG (enabled only):",P.length)}else{let I=["id","tenant_id","portfolio_id","sub_portfolio_id","created_at","updated_at"];for(let[L,le]of Object.entries(T)){if(I.includes(L.toLowerCase()))continue;let ce=typeof le=="number"?le:parseFloat(String(le));if(!isNaN(ce)&&ce>0){let ue=A.get(L.toLowerCase())||this.formatFieldLabel(L);P.push({label:ue,value:ce,field:L})}}console.log("[PAYMENT] Amounts FALLBACK (no config, all numeric):",P.length),P.push({label:"Otro monto",value:-1,field:"personalizado"})}return P.sort((I,L)=>I.field==="personalizado"?1:L.field==="personalizado"?-1:L.value-I.value),P}),this.tabs=[{id:"cliente",label:"Cliente",icon:"user"},{id:"historial",label:"Historial",icon:"history"}],this.managementForm={resultadoContacto:"",tipoGestion:"",clasificacionNivel1:"",clasificacionNivel2:"",clasificacionNivel3:"",motivoNoPago:"",metodoPago:"",montoPago:"",fechaCompromiso:"",horaCompromiso:"",ultimos4Tarjeta:"",bancoSeleccionado:"",observaciones:"",notasPrivadas:""},this.selectedClassifications=b([]),this.dynamicFields=b([]),this.dynamicFieldValues=b({}),this.isLoadingDynamicFields=b(!1),this.isLeafClassification=b(!1),this.dynamicFieldsSchema=b(null),this.externalFieldUpdates=b({}),this.activeSchedules=b([]),this.isLoadingSchedules=b(!1),this.showScheduleHelper=b(!1),this.selectedClassification=U(()=>{let T=this.selectedClassifications();if(T.length===0)return null;let z=T[T.length-1];if(!z)return null;let w=this.managementClassifications().find(A=>String(A.id)===String(z));return w&&(console.log("[DEBUG] Selected typification:",w),console.log("[DEBUG] suggestsFullAmount:",w.suggestsFullAmount),console.log("[DEBUG] allowsInstallmentSelection:",w.allowsInstallmentSelection),console.log("[DEBUG] requiresManualAmount:",w.requiresManualAmount)),w||null}),this.isFormValid=U(()=>{if(this.usesHierarchicalClassifications()){let R=this.selectedClassifications();if(R.length===0||!R[R.length-1])return console.log("[isFormValid] \u274C No hay clasificaci\xF3n seleccionada"),!1;let w=R[R.length-1];if(this.managementClassifications().some(I=>I.parentId&&Number(I.parentId)===Number(w)))return console.log("[isFormValid] \u274C A\xFAn hay niveles por seleccionar, lastSelectedId:",w),!1;console.log("[isFormValid] \u2705 Clasificaci\xF3n completa:",R)}else if(!this.managementForm.resultadoContacto)return!1;let T=this.dynamicFieldsSchema(),z=this.dynamicFieldValues();if(console.log("[isFormValid] Schema:",T),console.log("[isFormValid] Dynamic Values:",z),T&&T.fields&&T.fields.length>0){for(let R of T.fields)if(R.required){let w=z[R.id];if(console.log(`[isFormValid] Campo '${R.id}' (required=${R.required}): valor='${w}'`),w==null||w==="")return console.log(`[isFormValid] \u274C Campo requerido '${R.id}' est\xE1 vac\xEDo`),!1;if(R.type==="table"&&(!Array.isArray(w)||w.length===0))return console.log(`[isFormValid] \u274C Tabla '${R.id}' sin filas`),!1}}return console.log("[isFormValid] \u2705 Formulario v\xE1lido!"),!0}),this.hierarchyLevels=U(()=>{let T=this.managementClassifications(),z=this.selectedClassifications(),R=[];console.log("[hierarchyLevels] Total classifications:",T.length),console.log("[hierarchyLevels] Selected:",z);let w=T.filter(A=>A.hierarchyLevel===1||!A.parentId);console.log("[hierarchyLevels] Nivel 1 (roots):",w.length,w.map(A=>`${A.codigo} (ID:${A.id})`)),w.length>0&&R.push(w);for(let A=0;A<z.length;A++){let P=z[A];if(console.log(`[hierarchyLevels] Buscando hijos del nivel ${A+1}, parentId:`,P),P){let I=T.filter(L=>L.parentId&&Number(L.parentId)===Number(P));if(console.log(`[hierarchyLevels] Encontrados ${I.length} hijos:`,I.map(L=>`${L.codigo} (ID:${L.id}, parent:${L.parentId})`)),I.length>0)R.push(I);else{console.log("[hierarchyLevels] No se encontraron hijos, deteniendo b\xFAsqueda");break}}}return console.log("[hierarchyLevels] Total niveles construidos:",R.length),R}),this.scheduleForm={numeroCuotas:"",montoCuota:"",periodicidad:"",fechaPrimeraCuota:"",tipoCronograma:"",montoInicial:"",montoNegociado:"",cuotas:[]},this.customerData=b({id_cliente:"CLI-2025-0087453",nombre_completo:"GARC\xCDA RODRIGUEZ, CARMEN ROSA",tipo_documento:"DNI",numero_documento:"45621378",fecha_nacimiento:"15/03/1985",edad:40,contacto:{telefono_principal:"+51 987 654 321",telefono_alternativo:"+51 945 123 456",telefono_trabajo:"+51 01 4567890",email:"carmen.garcia@email.com",direccion:"Av. Los \xC1lamos 458, Dpto 302, San Borja, Lima"},cuenta:{numero_cuenta:"****5678",tipo_producto:"Pr\xE9stamo Personal",fecha_desembolso:"15/01/2024",monto_original:15e3,plazo_meses:24,tasa_interes:18.5},deuda:{saldo_capital:8750.5,intereses_vencidos:456.78,mora_acumulada:234.5,gastos_cobranza:120,saldo_total:9561.78,dias_mora:45,fecha_ultimo_pago:"15/10/2024",monto_ultimo_pago:458.33}}),this.activePaymentSchedules=b([]),this.selectedInstallmentForCancellation=b(null),this.uploadedComprobante=b(null),this.isCancellationTypification=U(()=>{let T=this.selectedClassification();return T?T.codigo==="CA"||T.label?.toUpperCase().includes("CANCELACION")||T.label?.toUpperCase().includes("CANCELACI\xD3N"):!1}),this.pendingInstallmentsForCancellation=U(()=>{let T=this.activePaymentSchedules(),z=[],R=new Date;R.setHours(0,0,0,0);for(let w of T)if(w.installments)for(let A of w.installments){let P=A.status?.toUpperCase();if(P!=="PAGADA"&&P!=="PAGADO"&&P!=="CUMPLIDO"&&P!=="CANCELADA"&&P!=="CANCELADO"&&P!=="VENCIDA"&&P!=="VENCIDO"){let I=A.dueDate||A.fechaPago;I&&this.parseDateLocal(I)>=R&&z.push(pe(Z({},A),{scheduleId:w.id,grupoPromesaUuid:w.grupoPromesaUuid}))}}return z}),this.overdueInstallments=U(()=>{let T=this.activePaymentSchedules(),z=[],R=new Date;R.setHours(0,0,0,0);for(let w of T)if(w.installments)for(let A of w.installments){let P=A.status?.toUpperCase();if(P==="VENCIDA"||P==="VENCIDO")z.push(pe(Z({},A),{scheduleId:w.id,grupoPromesaUuid:w.grupoPromesaUuid}));else if(P==="PENDIENTE"){let I=A.dueDate||A.fechaPago;I&&this.parseDateLocal(I)<R&&z.push(pe(Z({},A),{scheduleId:w.id,grupoPromesaUuid:w.grupoPromesaUuid}))}}return z}),this.rawClientData=b({}),this.clientAmountFields=U(()=>{let T=this.rawClientData(),z=this.montoCabeceras(),R=[];if(z.length>0)for(let w of z){let A=w.codigo.toLowerCase(),P=T[A]??T[w.codigo];if(P!=null){let I=typeof P=="number"?P:parseFloat(P);isNaN(I)||R.push({label:w.nombre,value:I,field:A})}}else{let w=["id","id_campana","id_cartera","id_subcartera","prioridad","estado","documento","num_cuenta","num_cuenta_pmcp","numero_cuenta","periodo","edad","dias_mora","dias_mora_asig","telefono_celular","telefono_domicilio","telefono_laboral","telf_referencia_1","telf_referencia_2"];for(let[A,P]of Object.entries(T)){let I=A.toLowerCase();if(I.startsWith("fec_")||I.startsWith("fecha_")||I.startsWith("telefono_")||I.startsWith("telf_")||w.includes(I))continue;let L=typeof P=="number"?P:parseFloat(P);!isNaN(L)&&L>=0&&R.push({label:this.formatFieldLabel(A),value:L,field:A})}}return R.sort((w,A)=>A.value-w.value)}),this.clientDiasMora=U(()=>{let T=this.rawClientData(),z=T.dias_mora||T.dias_mora_asig||0;return typeof z=="number"?z:parseInt(z)||0}),this.montoCabeceras=b([]),this.enabledPaymentOptions=b([]),this.paymentScheduleFieldId=b(null),this.hasPaymentOptionsConfig=b(!1),this.callState=ae.IDLE,this.isMuted=b(!1),this.incomingPhoneNumber=null,this.outgoingPhoneNumber=null}ngOnInit(){this.loadTenants(),this.loadManagementHistory();let e=this.sipService.getCallState();console.log("\u{1F4DE} [CollectionManagement] Estado inicial de llamada:",e),e===ae.ACTIVE&&!this.callActive()&&(console.log("\u23F1\uFE0F Llamada ya est\xE1 activa, iniciando timer autom\xE1ticamente..."),this.callActive.set(!0),this.startCall()),this.callStateSubscription=this.sipService.onCallStatus.subscribe(d=>{if(console.log("\u{1F4DE} [CollectionManagement] Estado de llamada:",d),this.callState=d,d===ae.ACTIVE&&!this.callActive()){this.callActive.set(!0),this.startCall();let m=this.authService.getCurrentUser();m?.id&&this.agentService.changeAgentStatus(m.id,{estado:ke.EN_LLAMADA}).subscribe({next:()=>console.log("\u2705 Estado cambiado a EN_LLAMADA"),error:p=>console.error("\u274C Error cambiando estado:",p)})}if((d===ae.ENDED||d===ae.IDLE)&&this.callActive()){this.callActive.set(!1),this.isTipifying.set(!0),this.sipService.blockIncomingCallsMode(!0),console.log("\u{1F6AB} Bloqueando llamadas entrantes - agente en tipificaci\xF3n");let m=this.callDuration();this.callTimer&&(clearInterval(this.callTimer),this.callTimer=void 0),console.log(`\u{1F4DD} Llamada terminada (${m}s), cambiando a TIPIFICANDO`);let p=this.authService.getCurrentUser();p?.id&&this.agentService.changeAgentStatus(p.id,{estado:ke.TIPIFICANDO}).subscribe({next:()=>console.log("\u2705 Estado cambiado a TIPIFICANDO - agente debe completar formulario"),error:x=>console.error("\u274C Error cambiando estado:",x)})}}),this.incomingCallSubscription=this.sipService.onIncomingCall.subscribe(d=>{console.log("\u{1F4F2} [CollectionManagement] Llamada entrante de:",d.from),this.incomingPhoneNumber=d.from,d.from&&this.autoLoadCustomerByPhone(d.from)}),this.outgoingCallSubscription=this.sipService.onOutgoingCall.subscribe(d=>{console.log("\u{1F4E4} [CollectionManagement] Llamada saliente a:",d.to),this.outgoingPhoneNumber=d.to,d.to&&this.autoLoadCustomerByPhone(d.to)});let t=this.sipService.getCurrentOutgoingNumber();t&&!this.customerData()?.id&&(console.log("\u{1F4E4} [CollectionManagement] Llamada saliente pendiente detectada:",t),this.outgoingPhoneNumber=t,this.autoLoadCustomerByPhone(t),this.sipService.clearCurrentOutgoingNumber()),this.route.queryParams.subscribe(d=>{d.source==="manual"&&d.documento&&(console.log("\u{1F4CB} [MANUAL] Cargando cliente desde gesti\xF3n manual:",d),this.loadCustomerByDocumentoFromManual(d.documento,Number(d.tenantId),Number(d.portfolioId),Number(d.subPortfolioId)))}),this.autorizacionService.respuesta$.subscribe(d=>{d&&this.waitingForAuthorization()&&this.handleAuthorizationResponse(d)});let n=this.authService.getCurrentUser();n?.id&&(this.agentStatusSubscription=this.agentStatusService.startStatusPolling(n.id).subscribe({next:d=>{d.colorIndicador&&this.colorIndicador.set(d.colorIndicador),this.excedeTiempoMaximo.set(d.excedeTiempoMaximo||!1)},error:d=>console.error("\u274C Error polling estado del agente:",d)}))}autoLoadCustomerByPhone(e){console.log("\u{1F50D} [AUTO-LOAD] Buscando cliente por tel\xE9fono:",e),this.customerService.searchCustomersAcrossAllTenants("telefono",e).subscribe({next:t=>{t&&t.length>0?(console.log("\u2705 [AUTO-LOAD] Cliente encontrado:",t[0]),this.loadCustomerFromResource(t[0])):console.warn("\u26A0\uFE0F [AUTO-LOAD] No se encontr\xF3 cliente con tel\xE9fono:",e)},error:t=>{console.error("\u274C [AUTO-LOAD] Error buscando cliente:",t)}})}loadCustomerByDocumentoFromManual(e,t,n,d){console.log("\u{1F50D} [MANUAL] Buscando cliente por documento:",e),this.selectedTenantId=t,this.selectedPortfolioId=n,this.selectedSubPortfolioId=d,this.reloadTypifications(),this.loadCustomerOutputConfig(),this.http.get(`${K.apiUrl}/client-search/find`,{params:{tenantId:t.toString(),portfolioId:n.toString(),subPortfolioId:d.toString(),documento:e}}).pipe(ye(m=>(console.error("\u274C [MANUAL] Error buscando cliente:",m),ve(null)))).subscribe({next:m=>{m?(console.log("\u2705 [MANUAL] Cliente encontrado:",m),this.loadCustomerFromDynamicTable(m)):console.warn("\u26A0\uFE0F [MANUAL] Cliente no encontrado")}})}loadCustomerFromDynamicTable(e){this.rawClientData.set(e),console.log("[PAYMENT] Raw client data from ini_* table:",e),this.loadMontoCabeceras(),this.customerData.set({id:e.id||0,id_cliente:e.documento,nombre_completo:e.nombre||e.nombres+" "+(e.apellidos||""),tipo_documento:"DNI",numero_documento:e.documento,fecha_nacimiento:"",edad:0,contacto:{telefono_principal:e.telefono_celular||e.telefono_principal||e.telefono||e.telefono_1||"",telefono_alternativo:e.telefono_domicilio||e.telefono_secundario||e.telefono_2||"",telefono_trabajo:e.telefono_laboral||e.telefono_trabajo||e.telefono_3||"",email:e.email||"",direccion:e.direccion||""},cuenta:{numero_cuenta:e.cuenta||"",tipo_producto:e.producto||"PR\xC9STAMO",fecha_desembolso:"",monto_original:e.monto_original||0,plazo_meses:0,tasa_interes:0},deuda:{saldo_capital:e.deuda_capital||0,intereses_vencidos:0,mora_acumulada:e.deuda_mora||0,gastos_cobranza:0,saldo_total:(e.deuda_capital||0)+(e.deuda_mora||0),dias_mora:e.dias_mora||0,fecha_ultimo_pago:"",monto_ultimo_pago:0}}),this.loadManagementHistory(),e.id&&this.loadActivePaymentSchedules(e.id),console.log("\u2705 [MANUAL] Cliente cargado exitosamente")}loadMontoCabeceras(){if(!this.selectedSubPortfolioId){console.warn("[CABECERAS] No hay subcartera seleccionada");return}console.log("[CABECERAS] Cargando cabeceras de montos para subcartera:",this.selectedSubPortfolioId),this.managementService.getMontoCabeceras(this.selectedSubPortfolioId).pipe(ye(e=>(console.error("[CABECERAS] Error cargando cabeceras:",e),ve([])))).subscribe(e=>{console.log("[CABECERAS] Cabeceras cargadas:",e),this.montoCabeceras.set(e.map(t=>({codigo:t.codigo,nombre:t.nombre,tipoDato:t.tipoDato,tipoSql:t.tipoSql})))})}loadTenants(){let e=this.authService.getCurrentUser();console.log("[V2] Usuario actual:",e),e?.tenantId&&e?.portfolioId&&e?.subPortfolioId?(this.selectedTenantId=e.tenantId,this.selectedPortfolioId=e.portfolioId,this.selectedSubPortfolioId=e.subPortfolioId,console.log(`[V2] Usando asignaci\xF3n del usuario: tenant=${this.selectedTenantId}, portfolio=${this.selectedPortfolioId}, subPortfolio=${this.selectedSubPortfolioId}`),this.reloadTypifications(),this.loadCustomerOutputConfig(),this.loadFirstCustomer()):(console.error("[V2] Usuario no tiene asignaci\xF3n completa de tenant/portfolio/subportfolio"),console.error("[V2] Valores recibidos:",{tenantId:e?.tenantId,portfolioId:e?.portfolioId,subPortfolioId:e?.subPortfolioId}))}onTenantChange(){this.selectedPortfolioId=void 0,this.portfolios=[],this.selectedTenantId&&(this.loadPortfolios(),this.reloadTypifications(),this.loadCustomerOutputConfig(),this.loadFirstCustomer())}loadPortfolios(){this.selectedTenantId&&this.classificationService.getPortfoliosByTenant(this.selectedTenantId).subscribe({next:e=>{this.portfolios=e},error:e=>{console.error("Error loading portfolios:",e)}})}onPortfolioChange(){this.reloadTypifications(),this.loadCustomerOutputConfig()}reloadTypifications(){this.selectedTenantId&&this.apiSystemConfigService.setTenantAndPortfolio(this.selectedTenantId,this.selectedPortfolioId,this.selectedSubPortfolioId)}loadCustomerOutputConfig(){this.selectedTenantId&&(console.log("[TEMPORAL] loadCustomerOutputConfig - endpoint no existe, usando campos por defecto"),this.setDefaultOutputFields())}loadFirstCustomer(){let e=this.authService.getCurrentUser();if(!e||!e.sipExtension){console.error("\u274C No se pudo obtener la extensi\xF3n SIP del agente logueado"),this.loadClienteDetalle(475);return}console.log(`\u{1F4CB} Buscando llamada activa del agente con extensi\xF3n SIP ${e.sipExtension}...`),this.http.get(`${K.gatewayUrl}/autodialer/active-call/extension/${e.sipExtension}`).pipe(ye(t=>(console.warn("\u26A0\uFE0F No hay llamada activa o error consultando:",t),console.log("\u{1F4CB} Usando contacto de prueba 475"),ve({contactId:475})))).subscribe({next:t=>{let n=t?.contactId;if(!n){console.warn("\u26A0\uFE0F No se obtuvo contactId de la llamada activa");return}console.log(`\u2705 Llamada activa encontrada, contactId: ${n}`),this.loadClienteDetalle(n)}})}loadClienteDetalle(e){console.log(`\u{1F4CB} Cargando datos del cliente para contacto ${e}...`),this.http.get(`${K.gatewayUrl}/contacts/${e}/cliente-detalle`).pipe(ye(t=>(console.error("\u274C Error cargando datos del cliente:",t),ve(null)))).subscribe({next:t=>{if(t&&t.documento){console.log("\u2705 Cliente b\xE1sico cargado, documento:",t.documento);let n=this.authService.getCurrentUser(),d=n?.tenantId,m=n?.portfolioId,p=n?.subPortfolioId;if(!d||!m||!p){console.error("\u274C No se pudo obtener asignaci\xF3n completa del usuario:",{tenantId:d,portfolioId:m,subPortfolioId:p}),this.loadClienteDetalleFallback(t);return}console.log(`\u{1F50D} Buscando datos completos del cliente con documento ${t.documento} en tenant ${d}, portfolio ${m}, subportfolio ${p}...`),this.customerService.findClientByDocumento(d,m,p,t.documento).subscribe({next:x=>{x?(console.log("\u2705 Datos completos del cliente obtenidos:",x),this.loadCustomerFromDynamicTable(x)):(console.warn("\u26A0\uFE0F No se encontr\xF3 cliente con documento:",t.documento),this.loadClienteDetalleFallback(t))},error:x=>{console.error("\u274C Error buscando datos completos del cliente:",x),this.loadClienteDetalleFallback(t)}})}else console.log("\u26A0\uFE0F No se pudieron cargar los datos del cliente")}})}loadClienteDetalleFallback(e){console.warn("\u26A0\uFE0F Usando fallback con datos limitados del cliente"),this.rawClientData.set(e),console.log("[PAYMENT] Raw client data from detalle (fallback):",e),this.loadMontoCabeceras(),this.customerData.set({id:e.idCliente,id_cliente:`CLI-${e.idCliente}`,nombre_completo:e.nombreCompleto||"",tipo_documento:e.tipoDocumento||"DNI",numero_documento:e.documento||"",fecha_nacimiento:e.fechaNacimiento||"",edad:e.edad||0,contacto:{telefono_principal:e.telefonoPrincipal||"",telefono_alternativo:e.telefonoSecundario||"",telefono_trabajo:e.telefonoTrabajo||"",email:e.email||"",direccion:e.direccion||""},cuenta:{numero_cuenta:e.cuenta||"",tipo_producto:e.producto||"",fecha_desembolso:"",monto_original:0,plazo_meses:0,tasa_interes:0},deuda:{saldo_capital:e.deudaCapital||0,intereses_vencidos:0,mora_acumulada:0,gastos_cobranza:0,saldo_total:e.deudaTotal||0,dias_mora:e.diasMora||0,fecha_ultimo_pago:"",monto_ultimo_pago:0}}),console.log("\u2705 Datos del cliente actualizados en la UI (fallback)"),this.loadActivePaymentSchedules(e.idCliente)}loadActivePaymentSchedules(e){console.log(`\u{1F4C5} Cargando cronogramas activos para cliente ${e}...`),this.paymentScheduleService.getActiveSchedulesByCustomer(e).pipe(ye(t=>(console.warn("\u26A0\uFE0F Error cargando cronogramas activos:",t),ve([])))).subscribe({next:t=>{if(console.log("\u2705 Registros de promesas cargados:",t),!t||t.length===0){this.activePaymentSchedules.set([]);return}let n=t.map(m=>{let p=m.cuotasPromesa||[];p.sort((M,j)=>(M.numeroCuota||1)-(j.numeroCuota||1));let x=p.reduce((M,j)=>M+(j.monto||0),0),v=p.filter(M=>M.estado!=="PAGADA"&&M.estado!=="PAGADO"&&M.estado!=="CUMPLIDO"&&M.estado!=="CANCELADA"),y=v[0]||p[0];return{id:m.grupoPromesaUuid||m.id,grupoPromesaUuid:m.grupoPromesaUuid,totalAmount:x||m.montoPromesa,numberOfInstallments:m.totalCuotas||p.length,fechaGestion:m.fechaGestion,installments:p.map(M=>({id:M.id,numeroCuota:M.numeroCuota,monto:M.monto,dueDate:M.fechaPago||null,status:M.estado||"PENDIENTE"})),nextDueDate:y?.fechaPago,cuotasPendientes:v.length}}),d=n.filter(m=>m.cuotasPendientes>0);console.log("\u{1F4C5} Cronogramas transformados:",n),console.log("\u{1F4C5} Cronogramas activos (con cuotas pendientes):",d),this.activePaymentSchedules.set(d),d.length>0&&console.log(`\u{1F4C5} \xA1Cliente tiene ${d.length} promesa(s) de pago activa(s)!`)}})}setDefaultOutputFields(){this.customerOutputFields.set([{id:"numero_documento",label:"DNI/Documento",field:"numero_documento",category:"personal",format:"text",highlight:!0,size:"medium"},{id:"nombre_completo",label:"Nombre Completo",field:"nombre_completo",category:"personal",format:"text",highlight:!1,size:"full"},{id:"telefono_principal",label:"Celular",field:"contacto.telefono_principal",category:"contact",format:"text",highlight:!1,size:"medium"},{id:"email",label:"Email",field:"contacto.email",category:"contact",format:"text",highlight:!1,size:"medium"},{id:"direccion",label:"Direcci\xF3n",field:"contacto.direccion",category:"contact",format:"text",highlight:!1,size:"full"}])}loadManagementHistory(){let e=this.customerData()?.id;if(!e){console.log("[HISTORIAL] No hay cliente cargado, omitiendo carga de historial");return}let t=String(e);console.log("[HISTORIAL] Cargando historial para cliente ID:",t),this.managementService.getManagementsByCustomer(t).subscribe({next:n=>{console.log("[HISTORIAL] Gestiones recibidas del backend:",n),console.log("[HISTORIAL] Total de gestiones:",n.length);let d=n.map(m=>{let p=m.managementDate&&m.managementTime?`${m.managementDate} ${m.managementTime}`:new Date().toLocaleString("es-PE"),x={id:m.id,fecha:p,asesor:m.advisorId,resultado:"Gesti\xF3n realizada",gestion:m.level3Name||m.level2Name||m.level1Name||"-",observacion:m.observations||"Sin observaciones",duracion:"00:00:00",hasSchedule:m.typificationRequiresSchedule||!1,schedule:null};return x.hasSchedule&&this.paymentScheduleService.getPaymentScheduleByManagementId(m.id).subscribe({next:v=>{v&&(x.schedule=v)},error:()=>{}}),x});this.historialGestiones.set(d),console.log("[HISTORIAL] Historial establecido en signal:",this.historialGestiones())},error:n=>{console.error("[HISTORIAL] Error al cargar historial de gestiones:",n),console.error("[HISTORIAL] Detalles del error:",{status:n.status,statusText:n.statusText,message:n.message,url:n.url})}})}formatDateTime(e){let t=new Date(e),n=t.getDate().toString().padStart(2,"0"),d=(t.getMonth()+1).toString().padStart(2,"0"),m=t.getFullYear(),p=t.getHours().toString().padStart(2,"0"),x=t.getMinutes().toString().padStart(2,"0");return`${n}/${d}/${m} ${p}:${x}`}calculateCallDuration(e){return e.durationSeconds?this.formatTime(e.durationSeconds):"00:00:00"}calculateCallDurationSeconds(){if(!this.callStartTime)return 0;let e=new Date(this.callStartTime).getTime(),t=new Date().getTime();return Math.floor((t-e)/1e3)}ngOnDestroy(){this.callTimer&&clearInterval(this.callTimer),this.isTipifying()&&(this.isTipifying.set(!1),this.sipService.blockIncomingCallsMode(!1),console.log("\u{1F513} [ngOnDestroy] Desbloqueando llamadas entrantes al salir del componente")),this.callStateSubscription&&this.callStateSubscription.unsubscribe(),this.incomingCallSubscription&&this.incomingCallSubscription.unsubscribe(),this.outgoingCallSubscription&&this.outgoingCallSubscription.unsubscribe(),this.agentStatusSubscription&&this.agentStatusSubscription.unsubscribe()}cancelarTipificacion(){console.log("\u274C Cancelando tipificaci\xF3n..."),this.isTipifying.set(!1),this.sipService.blockIncomingCallsMode(!1),console.log("\u{1F513} Desbloqueando llamadas entrantes - tipificaci\xF3n cancelada");let t=this.authService.getCurrentUser()?.id||1;this.agentService.changeAgentStatus(t,{estado:ke.DISPONIBLE}).subscribe({next:()=>{console.log("\u2705 Estado cambiado a DISPONIBLE, navegando al dashboard..."),this.router.navigate(["/dashboard"])},error:n=>{console.error("\u274C Error al cambiar estado:",n),this.router.navigate(["/dashboard"])}})}openScheduleDetail(e){this.scheduleManagementId.set(e),this.showScheduleDetail.set(!0)}closeScheduleDetail(){this.showScheduleDetail.set(!1),this.scheduleManagementId.set(null)}onCustomAmountDetected(e){console.log("\u{1F510} [Authorization] Custom amount detected:",e),this.requiresAuthorization.set(e),e||(this.waitingForAuthorization.set(!1),this.currentAuthorizationData=null)}openSupervisorSelectionModal(){console.log("\u{1F4CB} [Authorization] Opening supervisor selection modal");let e=this.dynamicFieldValues(),t=this.dynamicFieldsSchema(),n=null;if(t&&t.fields){let M=t.fields.find(j=>j.type==="payment_schedule");M&&e[M.id]&&(n=e[M.id])}if(!n){alert("\u26A0\uFE0F No hay datos de cronograma de pago para autorizar");return}let d=this.authService.getCurrentUser(),m=this.selectedClassifications(),p=this.managementClassifications(),x=m[m.length-1],v=p.find(M=>M.id.toString()===x),y=d?`${d.firstName||""} ${d.lastName||""}`.trim()||d.username:"Agente";this.currentAuthorizationData={idTenant:this.selectedTenantId,idCartera:this.selectedPortfolioId,idSubcartera:this.selectedSubPortfolioId,idAgenteSolicitante:d?.id||0,nombreAgente:y,idSupervisor:0,idCliente:this.customerData().id||0,nombreCliente:this.customerData().nombre_completo||"",documentoCliente:this.customerData().numero_documento||"",idTipificacion:v?.id?Number(v.id):0,nombreTipificacion:v?.label||"",montoTotal:n.montoTotal,numeroCuotas:n.numeroCuotas,campoMontoOrigen:n.campoMontoOrigen,cuotas:n.cuotas.map(M=>({numeroCuota:M.numeroCuota,monto:M.monto,fechaPago:M.fechaPago})),observacionesAgente:this.managementForm.observaciones||"Solicitud de monto personalizado"},this.showSupervisorModal=!0}onSupervisorSelected(e){if(console.log("\u{1F464} [Authorization] Supervisor selected:",e),this.showSupervisorModal=!1,!this.currentAuthorizationData){console.error("\u274C No authorization data prepared");return}let t=pe(Z({},this.currentAuthorizationData),{idSupervisor:e.idUsuario});this.autorizacionService.crearSolicitud(t).subscribe({next:n=>{console.log("\u2705 [Authorization] Request created:",n),this.waitingForAuthorization.set(!0),alert(`\u{1F4E4} Solicitud enviada a ${e.nombreCompleto}

Esperando autorizaci\xF3n...`)},error:n=>{console.error("\u274C [Authorization] Error creating request:",n),alert("\u274C Error al enviar la solicitud de autorizaci\xF3n")}})}onSupervisorSelectionCancelled(){console.log("\u274C [Authorization] Supervisor selection cancelled"),this.showSupervisorModal=!1}handleAuthorizationResponse(e){if(console.log("\u{1F4EC} [Authorization] Response received:",e),this.waitingForAuthorization.set(!1),e.estado==="APROBADA")alert(`\u2705 \xA1Autorizaci\xF3n APROBADA!

Guardando gesti\xF3n autom\xE1ticamente...`),this.requiresAuthorization.set(!1),this.saveManagement();else if(e.estado==="RECHAZADA"){let t=e.comentariosSupervisor||"Sin motivo especificado";alert(`\u274C Autorizaci\xF3n RECHAZADA

Motivo: ${t}

Puede modificar los datos y volver a solicitar autorizaci\xF3n.`)}else e.estado==="EXPIRADA"&&alert(`\u23F0 La solicitud de autorizaci\xF3n ha expirado.

Puede volver a solicitarla seleccionando otro supervisor.`)}toggleCall(){this.callActive()?this.endCall():this.startCall()}startCall(){this.callActive.set(!0),this.callDuration.set(0),this.callStartTime=new Date().toISOString(),this.callTimer=window.setInterval(()=>{this.callDuration.update(e=>e+1)},1e3)}endCall(e=!1){console.log("\u{1F4F5} Finalizando llamada..."),this.sipService.hangup(),this.callActive.set(!1),this.callTimer&&(clearInterval(this.callTimer),this.callTimer=void 0),e&&this.router.navigate(["/agent-dashboard"])}formatTime(e){let t=Math.floor(e/3600),n=Math.floor(e%3600/60),d=e%60;return`${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}:${d.toString().padStart(2,"0")}`}onContactResultChange(){this.managementForm.tipoGestion="",this.managementForm.motivoNoPago=""}onManagementTypeChange(){}showManagementType(){return this.managementForm.resultadoContacto==="CPC"||this.managementForm.resultadoContacto==="CTT"}usesHierarchicalClassifications(){let e=this.hierarchyLevels();return e.length>0&&e[0].length>0}getTypificationsForLevel(e){return this.hierarchyLevels()[e]||[]}onClassificationLevelChange(e,t){let n=[...this.selectedClassifications()];if(n[e]=t,this.selectedClassifications.set(n.slice(0,e+1)),e===0?(this.managementForm.clasificacionNivel1=t,this.managementForm.clasificacionNivel2="",this.managementForm.clasificacionNivel3=""):e===1?(this.managementForm.clasificacionNivel2=t,this.managementForm.clasificacionNivel3=""):e===2&&(this.managementForm.clasificacionNivel3=t),t){this.managementForm.tipoGestion=t;let d=Number(t);!isNaN(d)&&d>0?this.loadDynamicFields(d):(this.dynamicFields.set([]),this.dynamicFieldValues.set({}),this.isLeafClassification.set(!1))}else{let d=this.selectedClassifications().filter(m=>m).pop();this.managementForm.tipoGestion=d||"",this.dynamicFields.set([]),this.dynamicFieldValues.set({}),this.isLeafClassification.set(!1)}}loadDynamicFields(e){this.isLoadingDynamicFields.set(!0),this.apiSystemConfigService.getClassificationFields(e).subscribe({next:t=>{this.isLeafClassification.set(t.isLeaf),this.dynamicFields.set(t.fields||[]);let d={fields:(t.fields||[]).map((p,x)=>Z({id:p.fieldCode,label:p.fieldName,type:p.fieldType.toLowerCase(),required:p.isRequired||!1,placeholder:p.description||"",helpText:p.description,displayOrder:p.displayOrder||0,options:p.options?p.options.map(v=>typeof v=="string"?{value:v,label:v}:{value:v.value||v,label:v.label||v}):void 0,min:p.validationRules?.min,max:p.validationRules?.max,minLength:p.validationRules?.minLength,maxLength:p.validationRules?.maxLength,columns:p.fieldType.toLowerCase()==="table"&&p.columns?p.columns.map(v=>({id:v.id||v.fieldCode,label:v.label||v.fieldName,type:(v.type||v.fieldType).toLowerCase(),required:v.required||v.isRequired||!1,options:v.options?v.options.map(y=>typeof y=="string"?{value:y,label:y}:{value:y.value||y,label:y.label||y}):void 0})):void 0,allowAddRow:p.fieldType.toLowerCase()==="table",allowDeleteRow:p.fieldType.toLowerCase()==="table",minRows:p.minRows||0,maxRows:p.maxRows},p.linkedToField&&{linkedToField:p.linkedToField}))};this.dynamicFieldsSchema.set(d),this.isLoadingDynamicFields.set(!1);let m=(t.fields||[]).find(p=>p.fieldType.toLowerCase()==="payment_schedule");m&&m.id?(this.paymentScheduleFieldId.set(m.id),this.loadEnabledPaymentOptions(m.id)):(this.paymentScheduleFieldId.set(null),this.enabledPaymentOptions.set([]),this.hasPaymentOptionsConfig.set(!1)),this.checkAndLoadPaymentSchedules()},error:t=>{console.error("Error cargando campos din\xE1micos:",t),this.isLoadingDynamicFields.set(!1),this.isLeafClassification.set(!1),this.dynamicFields.set([]),this.dynamicFieldsSchema.set(null)}})}loadEnabledPaymentOptions(e){console.log("[PAYMENT] Loading options for field ID:",e),this.typificationV2Service.getOpcionesCampo(e).subscribe({next:t=>{let n=t&&t.length>0;this.hasPaymentOptionsConfig.set(n);let d=n?t.filter(m=>m.estaHabilitada):[];console.log("[PAYMENT] Options config exists:",n,"| Total:",t?.length||0,"| Enabled:",d.length),this.enabledPaymentOptions.set(d)},error:t=>{console.warn("[PAYMENT] Error loading options, showing all amounts:",t),this.hasPaymentOptionsConfig.set(!1),this.enabledPaymentOptions.set([])}})}checkAndLoadPaymentSchedules(){let e=this.selectedClassifications();if(e.length===0){this.showScheduleHelper.set(!1);return}let t=e[e.length-1],d=this.managementClassifications().find(m=>m.id.toString()===t);d&&d.requiere_pago?(console.log("[SCHEDULE] Payment typification detected:",d.codigo),console.log("[DEBUG-SCHEDULE] Full typification object:",d),console.log("[DEBUG-SCHEDULE] suggestsFullAmount:",d.suggestsFullAmount),console.log("[DEBUG-SCHEDULE] allowsInstallmentSelection:",d.allowsInstallmentSelection),console.log("[DEBUG-SCHEDULE] requiresManualAmount:",d.requiresManualAmount),this.loadActiveSchedules()):(this.showScheduleHelper.set(!1),this.activeSchedules.set([]))}loadActiveSchedules(){let e=String(this.customerData().id);console.log("[SCHEDULE] Loading active schedules for customer ID:",e),this.isLoadingSchedules.set(!0),this.managementService.getActiveSchedulesByCustomer(e).subscribe({next:t=>{console.log("[SCHEDULE] Active schedules loaded:",t),this.activeSchedules.set(t),this.showScheduleHelper.set(t.length>0),this.isLoadingSchedules.set(!1),t.length>0&&this.suggestPaymentAmount(t[0])},error:t=>{console.error("[SCHEDULE] Error loading schedules:",t),this.isLoadingSchedules.set(!1),this.showScheduleHelper.set(!1)}})}suggestPaymentAmount(e){if(!e.installments||e.installments.length===0)return;let t=e.installments.filter(n=>n.status.status==="PENDING").sort((n,d)=>new Date(n.dueDate).getTime()-new Date(d.dueDate).getTime())[0];if(t){console.log("[SCHEDULE] Suggested payment amount:",t.amount),this.managementForm.montoPago||(this.managementForm.montoPago=t.amount.toFixed(2));let n=Z({},this.dynamicFieldValues());n.monto_pagado||(n.monto_pagado=t.amount,this.dynamicFieldValues.set(n))}}applyFullSchedulePayment(){let e=this.activeSchedules();if(e.length===0)return;let t=e[0],n=this.calculatePendingAmount(t);console.log("[BUTTON] Pagar Todo clicked. Amount:",n);let d=this.dynamicFieldsSchema(),m=d?.fields.find(p=>p.type==="currency"||p.id.toLowerCase().includes("monto"));if(m){console.log("[BUTTON] Found monto field:",m.id);let p={};if(p[m.id]=n,d?.fields.some(v=>v.id==="saldo_pendiente")){p.saldo_pendiente=0,console.log("[BUTTON] Saldo pendiente ser\xE1 0 (pago total)");let v=Z({},this.dynamicFieldValues());v[m.id]=n,v.saldo_pendiente=0,this.dynamicFieldValues.set(v)}this.externalFieldUpdates.set(p),console.log("[BUTTON] Updated externalFieldUpdates:",p),setTimeout(()=>this.externalFieldUpdates.set({}),100)}else console.warn("[BUTTON] No se encontr\xF3 campo de monto en el schema")}applyNextInstallmentPayment(){console.log("[BUTTON-PP] Usar Pr\xF3xima Cuota clicked!");let e=this.activeSchedules();if(console.log("[BUTTON-PP] Active schedules:",e),e.length===0){console.warn("[BUTTON-PP] No schedules found");return}let t=e[0];console.log("[BUTTON-PP] Using schedule:",t),console.log("[BUTTON-PP] Schedule installments:",t.installments);let n=t.installments.filter(m=>(console.log("[BUTTON-PP] Checking installment:",m,"Status:",m.status?.status),m.status.status==="PENDING"));console.log("[BUTTON-PP] Pending installments:",n);let d=n.sort((m,p)=>new Date(m.dueDate).getTime()-new Date(p.dueDate).getTime())[0];if(console.log("[BUTTON-PP] Next pending installment:",d),d){console.log("[BUTTON-PP] Usar Pr\xF3xima Cuota - Amount:",d.amount);let m=this.dynamicFieldsSchema(),p=m?.fields.find(x=>x.type==="currency"||x.id.toLowerCase().includes("monto"));if(p){console.log("[BUTTON-PP] Found monto field:",p.id);let x={};if(x[p.id]=d.amount,m?.fields.some(y=>y.id==="saldo_pendiente")){let y=this.calculatePendingAmount(t),M=Math.max(0,y-d.amount);x.saldo_pendiente=M,console.log("[BUTTON-PP] Saldo pendiente calculado:",M,"= Total",y,"- Monto",d.amount);let j=Z({},this.dynamicFieldValues());j[p.id]=d.amount,j.saldo_pendiente=M,this.dynamicFieldValues.set(j)}this.externalFieldUpdates.set(x),console.log("[BUTTON-PP] Updated externalFieldUpdates:",x),setTimeout(()=>this.externalFieldUpdates.set({}),100)}else console.warn("[BUTTON-PP] No se encontr\xF3 campo de monto en el schema")}else console.warn("[BUTTON-PP] No pending installment found")}calculatePendingAmount(e){console.log("[CALC] Schedule:",e),console.log("[CALC] Installments:",e.installments);let t=e.installments.filter(d=>(console.log("[CALC] Installment status:",d.status,"Status value:",d.status?.status),d.status.status==="PENDING"));console.log("[CALC] Pending installments:",t);let n=t.reduce((d,m)=>d+m.amount,0);return console.log("[CALC] Total pending amount:",n),n}getPendingInstallments(e){return e.installments?e.installments.filter(t=>t.status.status==="PENDING").sort((t,n)=>new Date(t.dueDate).getTime()-new Date(n.dueDate).getTime()):[]}onDynamicFieldsChange(e){this.dynamicFieldValues.set(e),e.monto_pagado!==void 0&&e.monto_pagado!==null&&this.calculateAndUpdatePendingBalance(e.monto_pagado)}calculateAndUpdatePendingBalance(e){let t=this.activeSchedules();if(t.length===0){console.log("[SALDO] No hay cronogramas activos");return}let n=t[0],d=this.calculatePendingAmount(n),m=Math.max(0,d-(e||0));if(console.log("[SALDO] Total pendiente:",d),console.log("[SALDO] Monto pagado:",e),console.log("[SALDO] Saldo pendiente calculado:",m),this.dynamicFieldsSchema()?.fields.some(v=>v.id==="saldo_pendiente")){console.log("[SALDO] Actualizando campo saldo_pendiente con:",m);let v={saldo_pendiente:m};this.externalFieldUpdates.set(v);let y=Z({},this.dynamicFieldValues());y.saldo_pendiente=m,this.dynamicFieldValues.set(y),setTimeout(()=>this.externalFieldUpdates.set({}),100)}}getDynamicLevelLabel(e){if(e===0){let m=this.hierarchyLevels()[0]||[];if(m.length===0)return"Nivel 1";let p=m.map(x=>x.codigo);return p.includes("RP")||p.includes("CSA")?"Tipo de Resultado":"Categor\xEDa Principal"}let t=e-1,n=this.selectedClassifications()[t];if(!n)return`Nivel ${e+1}`;let d=this.managementClassifications().find(m=>m.id==n);return d?e===1?{RP:"Intenci\xF3n de Pago",CSA:"Motivo de No Atenci\xF3n",SC:"Raz\xF3n de No Contacto",GA:"Tipo de Gesti\xF3n"}[d.codigo]||`Detalle de ${d.label}`:`Detalle de ${d.label}`:`Nivel ${e+1}`}shouldShowLevel(e){if(e===0)return this.usesHierarchicalClassifications();let t=e-1;return this.selectedClassifications()[t]?this.getTypificationsForLevel(e).length>0:!1}formatFieldLabel(e){let t={deuda_total:"Deuda Total",saldo_total:"Saldo Total",saldo_capital:"Saldo Capital",capital:"Capital",deuda_capital:"Deuda Capital",intereses:"Intereses",intereses_vencidos:"Intereses Vencidos",mora:"Mora",mora_acumulada:"Mora Acumulada",deuda_mora:"Deuda Mora",gastos:"Gastos",gastos_cobranza:"Gastos Cobranza",monto_original:"Monto Original",monto_desembolso:"Monto Desembolso",saldo_vencido:"Saldo Vencido",cuota_vencida:"Cuota Vencida",cuotas_vencidas:"Cuotas Vencidas",monto_cuota:"Monto Cuota",dias_mora:"D\xEDas Mora",monto_minimo:"Monto M\xEDnimo",monto_total:"Monto Total",deuda:"Deuda",saldo:"Saldo"},n=e.toLowerCase();return t[n]?t[n]:e.split("_").map(d=>d.charAt(0).toUpperCase()+d.slice(1).toLowerCase()).join(" ")}formatCurrency(e){return new Intl.NumberFormat("es-PE",{style:"currency",currency:"PEN"}).format(e)}parseDateLocal(e){if(!e)return new Date;let[t,n,d]=e.split("-").map(Number);return new Date(t,n-1,d)}getPrimaryAmountLabel(){let e=this.clientAmountFields();return e.length>0?e.find(n=>n.label.toLowerCase().includes("total")||n.field.toLowerCase().includes("total"))?.label||e[0].label:"Deuda Total"}getPrimaryAmountValue(){let e=this.clientAmountFields();return e.length>0?e.find(n=>n.label.toLowerCase().includes("total")||n.field.toLowerCase().includes("total"))?.value||e[0].value:this.customerData().deuda?.saldo_total||0}getAmountRowClass(e){let t=["bg-red-50 dark:bg-red-950/30 text-red-700 dark:text-red-300","bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200"];return t[e%t.length]}showPaymentSection(){return this.managementClassifications().find(t=>t.id===this.managementForm.tipoGestion)?.requiere_pago||!1}showScheduleSection(){return this.managementClassifications().find(t=>t.id===this.managementForm.tipoGestion)?.requiere_cronograma||!1}onInstallmentCountChange(){let e=parseInt(this.scheduleForm.numeroCuotas);if(isNaN(e)||e<1){this.scheduleForm.cuotas=[];return}let t=this.scheduleForm.cuotas.length;if(e>t)for(let n=t+1;n<=e;n++)this.scheduleForm.cuotas.push({numero:n,monto:"",fechaVencimiento:""});else e<t&&(this.scheduleForm.cuotas=this.scheduleForm.cuotas.slice(0,e),this.scheduleForm.cuotas.forEach((n,d)=>{n.numero=d+1}))}generateSchedule(){let e=parseInt(this.scheduleForm.numeroCuotas);if(isNaN(e)||e<1){alert("Por favor ingrese un n\xFAmero v\xE1lido de cuotas");return}this.scheduleForm.cuotas=[];for(let t=1;t<=e;t++)this.scheduleForm.cuotas.push({numero:t,monto:"",fechaVencimiento:""})}addInstallmentRow(){let e=this.scheduleForm.cuotas.length+1;this.scheduleForm.cuotas.push({numero:e,monto:"",fechaVencimiento:""}),this.scheduleForm.numeroCuotas=e.toString()}removeInstallmentRow(e){this.scheduleForm.cuotas.length>1&&(this.scheduleForm.cuotas.splice(e,1),this.scheduleForm.cuotas.forEach((t,n)=>{t.numero=n+1}),this.scheduleForm.numeroCuotas=this.scheduleForm.cuotas.length.toString())}getTodayDate(){let e=new Date,t=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),d=String(e.getDate()).padStart(2,"0");return`${t}-${n}-${d}`}loadMontoNegociadoFromOutput(e){let t=this.customerOutputFields().find(m=>m.id===e);if(!t)return;let n=t.field.split("."),d=this.customerData();for(let m of n)if(d&&typeof d=="object")d=d[m];else{d=null;break}d&&(this.scheduleForm.montoNegociado=d.toString())}toggleScheduleDetail(){this.showScheduleDetail.update(e=>!e)}saveManagement(){if(!this.validateForm())return;this.saving.set(!0);let e,t;if(this.usesHierarchicalClassifications()){let k=this.selectedClassifications(),X=this.managementClassifications(),de=k[k.length-1];if(t=X.find(ee=>ee.id.toString()===de),t?.parentId){let ee=t.parentId;e=X.find(J=>J.id.toString()===ee.toString())}else e=t}else e=this.contactClassifications().find(k=>k.id===this.managementForm.resultadoContacto),t=this.managementClassifications().find(k=>k.id===this.managementForm.tipoGestion);let n=this.selectedClassifications(),d=Number(n[0]),m=n[1]?Number(n[1]):null,p=n[2]?Number(n[2]):null,x=this.managementClassifications(),v=x.find(k=>k.id.toString()===n[0]),y=n[1]?x.find(k=>k.id.toString()===n[1]):null,M=n[2]?x.find(k=>k.id.toString()===n[2]):null,j=this.dynamicFieldValues(),$=this.dynamicFieldsSchema(),F=null;if(console.log("[SAVE] === DEBUG PAYMENT SCHEDULE ==="),console.log("[SAVE] dynamicValues:",j),console.log("[SAVE] schema:",$),console.log("[SAVE] schema.fields:",$?.fields),$&&$.fields){let k=$.fields.find(X=>X.type==="payment_schedule");console.log("[SAVE] paymentScheduleField found:",k),k&&(console.log("[SAVE] Looking for field id:",k.id),console.log("[SAVE] Value in dynamicValues:",j[k.id])),k&&j[k.id]&&(F=j[k.id],console.log("[SAVE] Payment schedule detected:",F))}if(console.log("[SAVE] Final paymentScheduleData:",F),F&&F.cuotas&&F.cuotas.length>0&&this.activePaymentSchedules().some(de=>de.cuotasPendientes>0)){this.saving.set(!1),alert(`\u26A0\uFE0F No puede registrar una nueva Promesa de Pago.

El cliente ya tiene una promesa de pago activa con cuotas pendientes.

Debe esperar a que se completen o cancelen las cuotas pendientes antes de registrar una nueva promesa.`);return}if(F&&F.cuotas&&F.cuotas.length>0){let k=p||m||d,X=this.callActive()||!!this.callStartTime,de=this.authService.getCurrentUser(),ee={idCliente:this.customerData().id||0,nombreCliente:this.customerData().nombre_completo,documentoCliente:this.customerData().numero_documento,idAgente:de?.id||1,idTenant:this.selectedTenantId,idCartera:this.selectedPortfolioId||1,idSubcartera:1,idTipificacion:k,observaciones:this.managementForm.observaciones,metodoContacto:X?"LLAMADA_SALIENTE":"GESTION_MANUAL",campoMontoOrigen:F.campoMontoOrigen,schedule:{montoTotal:F.montoTotal,numeroCuotas:F.numeroCuotas,cuotas:F.cuotas.map(J=>({numeroCuota:J.numeroCuota,monto:J.monto,fechaPago:J.fechaPago}))}};console.log("[SAVE] Creating payment schedule with request:",ee),this.managementService.createPaymentSchedule(ee).subscribe({next:J=>{console.log("[SAVE] Payment schedule created successfully:",J),this.onSaveSuccess(e?.label||"",t?.label||"-")},error:J=>{console.error("Error al guardar cronograma de pago:",J),this.saving.set(!1),alert("\u26A0\uFE0F Error al guardar el cronograma de pago. Por favor intente nuevamente.")}})}else{let k=this.callActive()||!!this.callStartTime,X=this.authService.getCurrentUser(),de={customerId:String(this.customerData().id),customerName:this.customerData().nombre_completo||"",customerDocument:this.customerData().numero_documento||"",advisorId:"ADV-001",tenantId:this.selectedTenantId,portfolioId:this.selectedPortfolioId||1,subPortfolioId:1,phone:this.customerData().contacto?.telefono_principal||"",level1Id:d,level1Name:v?.label||"",level2Id:m,level2Name:y?.label||null,level3Id:p,level3Name:M?.label||null,observations:this.managementForm.observaciones,metodoContacto:k?"LLAMADA_SALIENTE":"GESTION_MANUAL",canalContacto:k?"TELEFONO":"SISTEMA",idCampana:null,idLlamada:null,duracionSegundos:k&&this.callStartTime?this.calculateCallDurationSeconds():null,nombreAgente:X?.username||X?.firstName||"Sistema",userAgent:navigator.userAgent};this.managementService.createManagement(de).subscribe({next:ee=>{this.callStartTime&&this.callActive()&&this.registerCallToBackend(ee.id);let J=this.selectedInstallmentForCancellation();if(this.isCancellationTypification()&&J&&J.id){console.log("\u{1F4B0} Cancelando cuota (marcando como PAGADA):",J);let tt=new Date().toISOString().split("T")[0];this.managementService.cancelarCuota(J.id,J.monto,tt,this.managementForm.observaciones||void 0).subscribe({next:me=>{console.log("\u2705 Cuota cancelada exitosamente:",me),this.selectedInstallmentForCancellation.set(null);let T=this.customerData().id;T&&this.loadActivePaymentSchedules(T),this.onSaveSuccess(e?.label||"",t?.label||"-")},error:me=>{console.error("\u26A0\uFE0F Error cancelando cuota:",me),(me.error?.error||me.error?.mensaje)&&alert(`\u26A0\uFE0F ${me.error.mensaje||"No se puede cancelar esta cuota. La fecha de pago ya pas\xF3."}`),this.selectedInstallmentForCancellation.set(null),this.onSaveSuccess(e?.label||"",t?.label||"-")}})}else this.onSaveSuccess(e?.label||"",t?.label||"-")},error:ee=>{console.error("Error al guardar gesti\xF3n:",ee),this.saving.set(!1),alert("\u26A0\uFE0F Error al guardar la gesti\xF3n. Por favor intente nuevamente.")}})}}registerCallToBackend(e){if(!this.callStartTime)return;let t={phoneNumber:this.customerData().contacto.telefono_principal,startTime:this.callStartTime};this.managementService.startCall(e,t).subscribe({next:n=>{if(!this.callActive()){let d={endTime:new Date().toISOString()};this.managementService.endCall(e,d).subscribe({next:()=>{},error:m=>console.error("Error al finalizar llamada:",m)})}},error:n=>{console.error("Error al registrar llamada:",n)}})}registerPaymentToBackend(e){if(!this.managementForm.montoPago||!this.managementForm.metodoPago)return;let t={amount:parseFloat(this.managementForm.montoPago),scheduledDate:new Date().toISOString().split("T")[0],paymentMethodType:this.managementForm.metodoPago,paymentMethodDetails:this.managementForm.ultimos4Tarjeta||void 0,voucherNumber:void 0,bankName:this.managementForm.bancoSeleccionado||void 0};this.managementService.registerPayment(e,t).subscribe({next:n=>{},error:n=>{console.error("Error al registrar pago:",n)}})}createScheduleToBackend(e){if(this.scheduleForm.cuotas.length===0)return;if(this.scheduleForm.cuotas.some(d=>!d.monto||!d.fechaVencimiento)){alert("\u26A0\uFE0F Por favor complete todos los montos y fechas de las cuotas");return}let n={customerId:String(this.customerData().id),managementId:e,scheduleType:this.scheduleForm.tipoCronograma,negotiatedAmount:this.scheduleForm.montoNegociado?parseFloat(this.scheduleForm.montoNegociado):null,installments:this.scheduleForm.cuotas.map(d=>({installmentNumber:d.numero,amount:parseFloat(d.monto),dueDate:d.fechaVencimiento}))};this.paymentScheduleService.createPaymentSchedule(n).subscribe({next:d=>{},error:d=>{console.error("Error al crear cronograma:",d),alert("\u26A0\uFE0F Error al crear el cronograma de pagos")}})}onSaveSuccess(e,t){this.saving.set(!1),this.showSuccess.set(!0),this.endCall(!1),this.loadManagementHistory(),this.managementForm={resultadoContacto:"",tipoGestion:"",clasificacionNivel1:"",clasificacionNivel2:"",clasificacionNivel3:"",motivoNoPago:"",metodoPago:"",montoPago:"",fechaCompromiso:"",horaCompromiso:"",ultimos4Tarjeta:"",bancoSeleccionado:"",observaciones:"",notasPrivadas:""},this.callDuration.set(0),this.callStartTime=void 0,this.activeTab.set("historial"),this.isTipifying.set(!1),this.sipService.blockIncomingCallsMode(!1),console.log("\u2705 Desbloqueando llamadas entrantes - tipificaci\xF3n completada");let n=sessionStorage.getItem("recordatorioEnCurso");if(n){console.log("\u{1F514} Modo recordatorio dialer activo, procesando siguiente..."),this.procesarSiguienteRecordatorio(JSON.parse(n));return}console.log("\u2705 Gesti\xF3n guardada, cambiando estado a DISPONIBLE...");let m=this.authService.getCurrentUser()?.id||1;this.agentService.changeAgentStatus(m,{estado:ke.DISPONIBLE}).subscribe({next:()=>{console.log("\u2705 Estado cambiado a DISPONIBLE"),setTimeout(()=>{this.showSuccess.set(!1),console.log("\u{1F504} Navegando a /agent-dashboard..."),this.router.navigate(["/agent-dashboard"])},2e3)},error:p=>{console.error("\u274C Error cambiando estado:",p),setTimeout(()=>{this.showSuccess.set(!1),this.router.navigate(["/agent-dashboard"])},2e3)}})}procesarSiguienteRecordatorio(e){let n=this.authService.getCurrentUser()?.id||e.idAgente;this.recordatoriosService.completarActual(n,"CONTESTADO").subscribe({next:d=>{console.log("\u{1F514} Recordatorio completado:",d),d.terminado?(console.log("\u{1F514} Todos los recordatorios completados"),sessionStorage.removeItem("recordatorioEnCurso"),setTimeout(()=>{this.showSuccess.set(!1),this.mostrarModalRecordatoriosFinalizado(n)},1e3)):this.recordatoriosService.obtenerSiguiente(n).subscribe({next:m=>{m.hayMas&&m.recordatorio?(console.log("\u{1F514} Siguiente recordatorio:",m.recordatorio),sessionStorage.setItem("recordatorioEnCurso",JSON.stringify({idCuota:m.recordatorio.idCuota,idAgente:n,idCliente:m.recordatorio.idCliente,nombreCliente:m.recordatorio.nombreCliente,telefono:m.recordatorio.telefono,monto:m.recordatorio.monto,numeroCuota:m.recordatorio.numeroCuota,totalCuotas:m.recordatorio.totalCuotas})),this.showSuccess.set(!1),this.mostrarCountdownYLlamar(m.recordatorio)):(sessionStorage.removeItem("recordatorioEnCurso"),this.showSuccess.set(!1),this.mostrarModalRecordatoriosFinalizado(n))},error:m=>{console.error("Error obteniendo siguiente recordatorio:",m),sessionStorage.removeItem("recordatorioEnCurso"),this.showSuccess.set(!1),this.router.navigate(["/agent-dashboard"])}})},error:d=>{console.error("Error completando recordatorio:",d),sessionStorage.removeItem("recordatorioEnCurso"),this.showSuccess.set(!1),this.router.navigate(["/agent-dashboard"])}})}mostrarCountdownYLlamar(e){this.dialog.open(lt,{width:"450px",disableClose:!0,data:{cantidad:0,pendientes:1,idAgente:this.authService.getCurrentUser()?.id||0,modoSiguiente:!0,recordatorio:e}}).afterClosed().subscribe(n=>{n?.action==="call"&&n.recordatorio?this.sipService.call(n.recordatorio.telefono):n?.action==="cancelled"&&(sessionStorage.removeItem("recordatorioEnCurso"),this.router.navigate(["/agent-dashboard"]))})}mostrarModalRecordatoriosFinalizado(e){this.dialog.open(lt,{width:"450px",disableClose:!0,data:{cantidad:0,pendientes:0,idAgente:e,modoFinalizado:!0}}).afterClosed().subscribe(()=>{this.agentService.changeAgentStatus(e,{estado:ke.DISPONIBLE}).subscribe({next:()=>this.router.navigate(["/agent-dashboard"]),error:()=>this.router.navigate(["/agent-dashboard"])})})}validateForm(){let e={};if(this.usesHierarchicalClassifications()){let n=this.selectedClassifications();if(n.length===0||!n[n.length-1])e.typification="Debe seleccionar una clasificaci\xF3n";else{let d=n[n.length-1];this.managementClassifications().some(x=>x.parentId&&Number(x.parentId)===Number(d))&&(e.typification="Debe completar todos los niveles de clasificaci\xF3n")}}else this.managementForm.resultadoContacto||(e.resultadoContacto="Requerido"),this.showManagementType()&&!this.managementForm.tipoGestion&&(e.tipoGestion="Requerido");let t=this.dynamicFieldsSchema();if(t&&t.fields&&t.fields.length>0){let n=this.dynamicFieldValues();for(let d of t.fields)if(d.required){let m=n[d.id];(m==null||m==="")&&(e[`dynamic_${d.id}`]=`${d.label} es requerido`),d.type==="table"&&(!Array.isArray(m)||m.length===0)&&(e[`dynamic_${d.id}`]=`${d.label} debe tener al menos una fila`)}}return this.errors.set(e),Object.keys(e).length>0?(alert("Por favor complete todos los campos requeridos"),!1):!0}calculateRemaining(){if(!this.managementForm.montoPago)return"0.00";let e=parseFloat(this.managementForm.montoPago);return(this.customerData().deuda.saldo_total-e).toFixed(2)}toggleDarkMode(){this.themeService.toggleTheme()}getFieldValue(e){let t=this.customerData();return t?e.split(".").reduce((n,d)=>n?.[d],t):null}formatFieldValue(e,t){if(e==null||e==="")return"-";switch(t){case"currency":return"S/ "+Number(e).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",");case"number":return String(e);case"date":return typeof e=="string"?new Date(e).toLocaleDateString("es-PE"):String(e);default:return String(e)}}formatDate(e){if(!e)return"-";try{let t;return typeof e=="string"?/^\d{4}-\d{2}-\d{2}$/.test(e)?t=this.parseDateLocal(e):t=new Date(e):t=e,t.toLocaleDateString("es-PE",{day:"2-digit",month:"2-digit",year:"numeric"})}catch{return String(e)}}showPaymentScheduleDetail(e){console.log("\u{1F4C5} Detalle de promesa de pago:",e);let t=`PROMESA DE PAGO

`;if(t+=`Monto Total: S/ ${e.totalAmount?.toFixed(2)||"0.00"}
`,t+=`N\xFAmero de Cuotas: ${e.numberOfInstallments}

`,t+=`DETALLE DE CUOTAS:
`,e.installments&&e.installments.length>0)for(let n of e.installments){let d=n.dueDate?this.formatDate(n.dueDate):"-",m="\u23F3 Pendiente";n.status==="PAGADA"||n.status==="PAGADO"||n.status==="CUMPLIDO"?m="\u2705 PAGADA":n.status==="VENCIDA"||n.status==="VENCIDO"?m="\u26A0\uFE0F VENCIDA":(n.status==="CANCELADA"||n.status==="CANCELADO")&&(m="\u2717 CANCELADA"),t+=`  Cuota ${n.numeroCuota}: S/ ${n.monto?.toFixed(2)||"0.00"} - ${d} - ${m}
`}alert(t)}getContactClassificationLabel(e){let t=this.contactClassifications().find(d=>d.id===e);if(!t)return e;let n=t.label||t.codigo;return`[${t.codigo}] ${n}`}getManagementClassificationLabel(e){let t=this.managementClassifications().find(d=>d.id===e);if(!t)return e;let n=t.label||t.codigo;return`[${t.codigo}] ${n}`}getTableRows(e){let t=this.dynamicFieldValues()[e];return Array.isArray(t)?t:[]}addTableRow(e,t){if(!Array.isArray(t)){console.error("addTableRow: columns no es un array v\xE1lido",t);return}let n=Z({},this.dynamicFieldValues());Array.isArray(n[e])||(n[e]=[]);let d=this.createEmptyTableRow(t);n[e].push(d),this.dynamicFieldValues.set(n)}removeTableRow(e,t){let n=Z({},this.dynamicFieldValues());Array.isArray(n[e])&&(n[e].splice(t,1),this.dynamicFieldValues.set(n))}createEmptyTableRow(e){let t={};return e.forEach(n=>{n.type==="auto-number"?t[n.id]=null:n.type==="number"||n.type==="currency"?t[n.id]=n.defaultValue||0:(n.type,t[n.id]=n.defaultValue||"")}),t}searchByTestDocument(){if(!this.testDocument.trim()||!this.selectedTenantId){console.warn("[TEST] Documento vac\xEDo o tenant no seleccionado");return}console.log("[TEST] Buscando cliente por documento:",this.testDocument),this.customerService.searchCustomersByCriteria(this.selectedTenantId,"documento",this.testDocument).subscribe({next:e=>{e&&e.length>0?(console.log("[TEST] Cliente encontrado:",e[0]),this.loadCustomerFromResource(e[0])):(console.warn("[TEST] No se encontr\xF3 cliente con documento:",this.testDocument),alert("No se encontr\xF3 cliente con el documento: "+this.testDocument))},error:e=>{console.error("[TEST] Error buscando cliente:",e),alert("Error buscando cliente")}})}searchByTestPhone(){if(!this.testPhone.trim()||!this.selectedTenantId){console.warn("[TEST] Tel\xE9fono vac\xEDo o tenant no seleccionado");return}console.log("[TEST] Buscando cliente por tel\xE9fono:",this.testPhone),this.customerService.searchCustomersByCriteria(this.selectedTenantId,"telefono",this.testPhone).subscribe({next:e=>{e&&e.length>0?(console.log("[TEST] Cliente encontrado:",e[0]),this.loadCustomerFromResource(e[0])):(console.warn("[TEST] No se encontr\xF3 cliente con tel\xE9fono:",this.testPhone),alert("No se encontr\xF3 cliente con el tel\xE9fono: "+this.testPhone))},error:e=>{console.error("[TEST] Error buscando cliente:",e),alert("Error buscando cliente")}})}loadCustomerFromResource(e){console.log("[TEST] Cargando cliente:",e),this.rawClientData.set(e),console.log("[PAYMENT] Raw client data from resource:",e),this.loadMontoCabeceras(),this.customerData.set({id:e.id,id_cliente:e.documentNumber||e.identificationCode,nombre_completo:e.fullName||"",tipo_documento:e.documentType||"DNI",numero_documento:e.documentNumber||"",fecha_nacimiento:e.birthDate||"",edad:e.age||null,contacto:{telefono_principal:e.contactMethods?.find(t=>t.subtype==="telefono_principal")?.value||"",telefono_alternativo:e.contactMethods?.find(t=>t.subtype==="telefono_secundario")?.value||"",telefono_trabajo:e.contactMethods?.find(t=>t.subtype==="telefono_trabajo")?.value||"",email:e.contactMethods?.find(t=>t.contactType==="email")?.value||"",direccion:e.address||""},cuenta:{numero_cuenta:e.accountNumber||"",tipo_producto:"PR\xC9STAMO",fecha_desembolso:"2024-01-15",monto_original:e.principalAmount||0,plazo_meses:12,tasa_interes:2.5},deuda:{saldo_capital:e.principalAmount||0,intereses_vencidos:0,mora_acumulada:e.overdueAmount||0,gastos_cobranza:0,saldo_total:(e.principalAmount||0)+(e.overdueAmount||0),dias_mora:e.overdueDays||0,fecha_ultimo_pago:"",monto_ultimo_pago:0}}),this.loadManagementHistory(),e.id&&this.loadActivePaymentSchedules(e.id),console.log("[TEST] Cliente cargado exitosamente")}hangupCall(){console.log("\u{1F4F5} Colgando llamada..."),this.sipService.hangup()}toggleMute(){this.isMuted()?(console.log("\u{1F50A} Desmuteando..."),this.sipService.unmute(),this.isMuted.set(!1)):(console.log("\u{1F507} Muteando..."),this.sipService.mute(),this.isMuted.set(!0))}isInActiveCall(){return this.callState===ae.ACTIVE}getCallStateText(){switch(this.callState){case ae.IDLE:return"LISTO";case ae.CONNECTING:return"CONECTANDO...";case ae.RINGING:return"TIMBRANDO...";case ae.ACTIVE:return"EN LLAMADA";case ae.ENDED:return"FINALIZADA";default:return"DESCONOCIDO"}}openComprobanteUploadDialog(){let e=this.selectedInstallmentForCancellation(),t=this.customerData(),n=this.authService.getCurrentUser();if(!e||!t){console.warn("[COMPROBANTE] No hay cuota o cliente seleccionado");return}let d={idCuota:e.id,montoEsperado:e.monto||0,documentoEsperado:t.numero_documento||"",nombreCliente:t.nombre_completo||"",idAgente:n?.id||1};this.dialog.open(Ut,{width:"1100px",maxWidth:"95vw",data:d,disableClose:!1,backdropClass:"comprobante-modal-backdrop",panelClass:"comprobante-modal-panel"}).afterClosed().subscribe(p=>{p?.uploaded&&p.response&&(console.log("[COMPROBANTE] Comprobante subido:",p.response),this.uploadedComprobante.set(p.response),p.validacionesOk||console.warn("[COMPROBANTE] El comprobante tiene diferencias con los datos esperados"))})}openVoucherPaymentDialog(e){let t=this.customerData(),n=this.authService.getCurrentUser();if(!t){console.warn("[VOUCHER] No hay cliente seleccionado");return}if(!e.installments||e.installments.length===0){console.warn("[VOUCHER] No hay cuotas en el cronograma");return}let d=e.installments.map(x=>({id:x.id,numeroCuota:x.numeroCuota,monto:x.monto,dueDate:x.dueDate,status:x.status})),m={nombreCliente:t.nombre_completo||"",documentoCliente:t.numero_documento||"",idCliente:t.id||0,idAgente:n?.id||1,cuotas:d,grupoPromesaUuid:e.grupoPromesaUuid||e.id};this.dialog.open(Bt,{width:"1100px",maxWidth:"95vw",data:m,disableClose:!1,backdropClass:"voucher-modal-backdrop",panelClass:"voucher-modal-panel"}).afterClosed().subscribe(x=>{x?.confirmed&&x.autoSelect&&(console.log("[VOUCHER] Pago confirmado, auto-seleccionando:",x.autoSelect),this.autoSelectClassification(x.autoSelect.categoriaId,x.autoSelect.detalleId),this.selectedInstallmentForCancellation.set(x.autoSelect.cuotaSeleccionada),this.managementForm.observaciones=x.autoSelect.observaciones,x.ocrResponse&&this.uploadedComprobante.set(x.ocrResponse),console.log("[VOUCHER] Formulario auto-completado. Listo para guardar."))})}autoSelectClassification(e,t){let n=this.hierarchyLevels();if(!n||n.length<2){console.warn("[VOUCHER] No hay niveles de clasificaci\xF3n disponibles");return}let d=n[0]?.find(m=>m.codigo===e);d?(this.onClassificationLevelChange(0,d.id),console.log("[VOUCHER] Categor\xEDa seleccionada:",d.label),setTimeout(()=>{let m=this.hierarchyLevels();if(m&&m.length>1){let p=m[1]?.find(x=>x.codigo===t);p?(this.onClassificationLevelChange(1,p.id),console.log("[VOUCHER] Detalle seleccionado:",p.label)):console.warn("[VOUCHER] No se encontr\xF3 detalle con c\xF3digo:",t)}},100)):console.warn("[VOUCHER] No se encontr\xF3 categor\xEDa con c\xF3digo:",e)}};c.\u0275fac=function(t){return new(t||c)(V($t),V(zt),V(we),V(kt),V(At),V(Ft),V(Xe),V(jt),V(Gt),V(gt),V(pt),V(oe),V(Dt),V(Et),V(Mt),V(xt),V(Qe),V(Tt),V(Pt),V(Pe))},c.\u0275cmp=ne({type:c,selectors:[["app-collection-management"]],viewQuery:function(t,n){if(t&1&&Ae(Si,5),t&2){let d;Fe(d=Ne())&&(n.dynamicFieldRenderer=d.first)}},decls:93,vars:44,consts:[["dynamicFieldRendererComponent",""],[1,"collection-management-container","h-[100dvh]","flex","flex-col","overflow-hidden"],[1,"fixed","top-4","right-4","z-50","animate-[slideInRight_0.5s_ease-out]"],[1,"bg-gradient-to-r","from-blue-600","via-blue-700","to-blue-600","dark:from-slate-950","dark:via-blue-950","dark:to-slate-950","text-white","shadow-md","relative","overflow-hidden"],[1,"relative","px-4","py-2"],[1,"flex","items-center","justify-between"],[1,"flex","items-center","gap-4"],[1,"flex","items-center","gap-2"],[1,"w-8","h-8","bg-blue-500/30","dark:bg-blue-600/30","rounded-lg","flex","items-center","justify-center"],["name","clipboard-list",1,"text-white",3,"size"],[1,"text-base","font-bold"],[1,"h-6","w-px","bg-white/20"],[1,"text-blue-200","dark:text-blue-300","text-[10px]"],[1,"font-semibold","text-white","text-sm"],[1,"text-right"],[3,"color","excedido","size"],[1,"flex-1","flex","overflow-hidden"],[1,"w-72","bg-white","dark:bg-slate-900","border-r","border-slate-200","dark:border-slate-800","shadow-lg","overflow-hidden","flex","flex-col","transition-colors","duration-300"],[1,"flex","border-b","border-slate-200","dark:border-slate-800","bg-slate-50","dark:bg-slate-950"],[3,"class"],[1,"flex-1","overflow-y-auto","p-2"],[1,"space-y-2"],[1,"space-y-1"],[1,"flex-1","overflow-y-auto","bg-gradient-to-br","from-gray-50","via-slate-50","to-blue-50","dark:from-slate-900","dark:via-gray-900","dark:to-slate-900","transition-colors","duration-300"],[1,"p-3","space-y-2"],[1,"font-bold","text-gray-800","dark:text-white","flex","items-center","gap-2","text-xs"],[1,"flex","gap-2"],[3,"click","disabled"],[1,"px-4","py-1.5","bg-gradient-to-r","from-red-600","to-red-700","hover:from-red-700","hover:to-red-800","disabled:from-gray-400","disabled:to-gray-500","text-white","dark:text-white","disabled:text-gray-200","rounded-lg","font-bold","flex","items-center","gap-2","transition-all","duration-300","text-xs","shadow-md","hover:shadow-lg",3,"click","disabled"],[1,"bg-white","dark:bg-gray-800","rounded-lg","shadow-md","border","border-gray-200","dark:border-gray-700","p-2","hover:border-blue-300","dark:hover:border-blue-600","transition-colors","duration-300"],[1,"animate-[slideInDown_0.3s_ease-out]"],[1,"bg-white","dark:bg-gray-800","rounded-lg","shadow-md","border","border-gray-200","dark:border-gray-700","p-3"],[1,"bg-indigo-50","dark:bg-indigo-950/20","border","border-indigo-200","dark:border-indigo-900/50","rounded-lg","shadow-md","p-3"],[1,"bg-gray-50","dark:bg-gray-900/20","border","border-gray-200","dark:border-gray-700","rounded-lg","shadow-md","p-3"],[3,"schema","externalUpdates","selectedClassification","customerAmounts"],[1,"bg-purple-50","dark:bg-purple-950/20","border","border-purple-200","dark:border-purple-900/50","rounded-lg","shadow-md","p-3","animate-pulse"],[1,"bg-gradient-to-r","from-purple-50","to-indigo-50","dark:from-purple-950/30","dark:to-indigo-950/30","border-2","border-purple-300","dark:border-purple-700","rounded-lg","shadow-lg","p-3","space-y-2"],[1,"bg-gradient-to-br","from-green-50","to-emerald-50","dark:from-green-950/30","dark:to-emerald-950/30","border","border-green-200","dark:border-green-800","rounded-lg","p-3","space-y-2"],[1,"bg-gradient-to-br","from-purple-50","to-indigo-50","dark:from-purple-950/30","dark:to-indigo-950/30","border","border-purple-200","dark:border-purple-800","rounded-lg","p-3"],[1,"flex","gap-2","pt-2"],[1,"flex-1","bg-gradient-to-r","from-amber-500","to-orange-600","hover:from-amber-600","hover:to-orange-700","disabled:from-gray-400","disabled:to-gray-500","text-white","dark:text-white","disabled:text-gray-200","py-2","px-4","rounded-lg","font-bold","text-xs","flex","items-center","justify-center","gap-2","transition-all","duration-300","shadow-lg","hover:shadow-xl","disabled:cursor-not-allowed",3,"disabled"],[1,"flex-1","bg-gradient-to-r","from-blue-600","to-blue-700","hover:from-blue-700","hover:to-blue-800","disabled:from-gray-400","disabled:to-gray-500","text-white","dark:text-white","disabled:text-gray-200","py-2","px-4","rounded-lg","font-bold","text-xs","flex","items-center","justify-center","gap-2","transition-all","duration-300","shadow-lg","hover:shadow-xl","disabled:cursor-not-allowed",3,"disabled","title"],[1,"px-6","bg-gradient-to-r","from-gray-400","to-gray-500","hover:from-gray-500","hover:to-gray-600","text-white","dark:text-white","py-2","rounded-lg","font-bold","text-xs","flex","items-center","justify-center","gap-2","transition-all","duration-300","shadow-md","hover:shadow-lg",3,"click"],[1,"w-72","bg-white","dark:bg-slate-900","border-l","border-slate-200","dark:border-slate-800","shadow-lg","overflow-hidden","flex","flex-col","transition-colors","duration-300"],[1,"p-2","border-b","border-slate-200","dark:border-slate-800"],[1,"text-[9px]","font-bold","text-gray-500","dark:text-gray-400","uppercase","mb-1.5"],[1,"flex","items-center","gap-2","p-1.5","bg-green-50","dark:bg-green-950/30","rounded","border","border-green-200","dark:border-green-800","cursor-pointer","hover:bg-green-100","dark:hover:bg-green-900/40","transition-colors"],[1,"text-green-600","dark:text-green-400","text-sm"],[1,"flex-1","min-w-0"],[1,"text-[9px]","text-green-600","dark:text-green-400"],[1,"text-[11px]","font-bold","text-green-700","dark:text-green-300","truncate"],[1,"flex","items-center","gap-2","p-1.5","bg-slate-50","dark:bg-slate-800","rounded","border","border-slate-200","dark:border-slate-700","cursor-pointer","hover:bg-slate-100","dark:hover:bg-slate-700","transition-colors"],[1,"flex","items-start","gap-2"],[1,"p-2","bg-red-50","dark:bg-red-950/20"],[1,"text-center"],[1,"text-[9px]","text-red-500","uppercase","font-bold"],[1,"text-xl","font-black","text-red-600","dark:text-red-400"],[1,"text-[11px]","text-orange-600","dark:text-orange-400","font-semibold"],[1,"p-2","flex-1","overflow-y-auto"],[1,"space-y-1.5"],[1,"fixed","inset-0","z-50","flex","items-center","justify-center","p-4","bg-black/50","backdrop-blur-sm","animate-fadeIn"],[3,"visibleChange","supervisorSelected","cancelled","visible"],[1,"bg-gradient-to-r","from-green-500","to-emerald-600","text-white","px-6","py-4","rounded-lg","shadow-2xl","flex","items-center","gap-3"],[1,"font-bold"],[1,"text-sm","opacity-90"],[3,"click"],[1,"absolute","bottom-0","left-0","right-0","h-0.5","bg-blue-500"],[1,"pb-1.5","border-b","border-slate-100","dark:border-slate-800"],[1,"text-center","py-2","text-slate-400","text-[10px]"],[1,"text-[10px]","text-slate-500","dark:text-slate-400","uppercase","font-medium"],[1,"text-[12px]","font-semibold","text-slate-800","dark:text-white","break-words"],[1,"text-center","py-4"],[1,"text-[10px]","text-gray-400"],[1,"mt-2","px-2","py-1","bg-blue-500","text-white","text-[9px]","rounded",3,"click"],[1,"bg-gray-50","dark:bg-gray-800","border","border-gray-200","dark:border-gray-700","rounded","p-1.5"],[1,"flex","justify-between","items-center","text-[9px]"],[1,"font-bold","text-gray-600","dark:text-gray-300"],[1,"text-gray-400"],[1,"text-[10px]","font-semibold","text-blue-600","dark:text-blue-300","mt-0.5"],[1,"text-[9px]","text-gray-500","dark:text-gray-400","truncate"],[1,"text-[8px]","text-purple-600","dark:text-purple-400","mt-0.5","hover:underline"],[1,"text-[8px]","text-purple-600","dark:text-purple-400","mt-0.5","hover:underline",3,"click"],[1,"block","font-bold","text-gray-800","dark:text-white","mb-1","text-[11px]","flex","items-center","gap-1"],[1,"w-1.5","h-1.5","bg-red-500","rounded-full"],[1,"relative"],[3,"ngModelChange","ngModel"],["value",""],[3,"value"],[1,"text-red-600","text-[10px]","mt-1","flex","items-center","gap-1"],[1,"bg-gradient-to-r","from-amber-500","via-yellow-500","to-orange-500","dark:from-amber-600","dark:via-yellow-600","dark:to-orange-600","text-white","rounded-lg","shadow-lg","mb-2","overflow-hidden","border-2","border-amber-400","dark:border-amber-500"],[1,"px-4","py-3","bg-black/10","flex","items-center","justify-between"],[1,"flex","items-center","gap-3"],[1,"w-8","h-8","bg-white/20","rounded-lg","flex","items-center","justify-center"],[1,"text-lg"],[1,"font-bold","text-sm"],[1,"text-xs","opacity-80"],[1,"px-3","py-2","bg-white/20","hover:bg-white/30","rounded-lg","text-xs","font-semibold","transition-all","flex","items-center","gap-1.5","border","border-white/30",3,"click"],["name","receipt",3,"size"],[1,"text-xl","font-bold"],[1,"px-4","py-3","bg-black/5"],[1,"text-xs","font-semibold","mb-2","opacity-90"],[1,"flex","flex-wrap","gap-2"],[1,"flex","items-center","gap-2","text-xs","bg-white/20","rounded-lg","px-3","py-2"],[1,"mt-2","text-xs","opacity-80"],[1,"opacity-70"],[1,"font-semibold"],[1,"font-medium","flex","items-center","gap-1"],["name","calendar",3,"size"],[1,"bg-green-600","text-[10px]","px-1.5","py-0.5","rounded","font-semibold","flex","items-center"],[1,"bg-red-600","text-[10px]","px-1.5","py-0.5","rounded","font-semibold","flex","items-center"],[1,"bg-gray-600","text-[10px]","px-1.5","py-0.5","rounded","font-semibold","flex","items-center"],[1,"bg-blue-600","text-[10px]","px-1.5","py-0.5","rounded","font-semibold","flex","items-center"],["name","check",3,"size"],["name","alert-triangle",3,"size"],["name","x",3,"size"],["name","clock",3,"size"],[1,"text-[10px]","font-bold","text-gray-600","dark:text-gray-300","uppercase","mb-2"],[1,"text-red-500","text-[9px]","mt-1"],[1,"flex-1","min-w-[140px]"],[1,"block","text-[9px]","text-gray-500","dark:text-gray-400","mb-0.5"],[1,"flex","items-center","justify-center","gap-2","text-indigo-600","dark:text-indigo-400"],[1,"text-xs"],[1,"flex","items-center","justify-center","gap-2","text-gray-500","dark:text-gray-400"],[3,"dataChange","customAmountDetected","schema","externalUpdates","selectedClassification","customerAmounts"],[1,"flex","items-center","justify-center","gap-2","text-purple-600","dark:text-purple-400"],[1,"text-xs","font-semibold"],[1,"p-1.5","bg-purple-500","dark:bg-purple-600","rounded"],[1,"text-xs","font-bold","text-purple-900","dark:text-purple-100"],[1,"text-[9px]","text-purple-600","dark:text-purple-300"],[1,"bg-white","dark:bg-gray-800","rounded-lg","border","border-purple-200","dark:border-purple-700","p-2","space-y-2"],[1,"text-[9px]","px-1.5","py-0.5","bg-green-100","dark:bg-green-900/30","text-green-700","dark:text-green-300","rounded","font-semibold"],[1,"text-[9px]","font-bold","text-gray-600","dark:text-gray-300","uppercase"],[1,"text-[9px]","text-center","text-gray-500","dark:text-gray-400","italic"],[1,"flex","gap-2","pt-1"],["type","button",1,"flex-1","px-3","py-1.5","bg-purple-600","hover:bg-purple-700","dark:bg-purple-700","dark:hover:bg-purple-600","text-white","text-[10px]","font-bold","rounded","transition-colors","flex","items-center","justify-center","gap-1"],["type","button",1,"flex-1","px-3","py-1.5","bg-indigo-600","hover:bg-indigo-700","dark:bg-indigo-700","dark:hover:bg-indigo-600","text-white","text-[10px]","font-bold","rounded","transition-colors","flex","items-center","justify-center","gap-1"],[1,"text-[9px]","text-purple-600","dark:text-purple-400","bg-purple-100","dark:bg-purple-900/20","p-1.5","rounded","flex","items-start","gap-1"],[1,"flex","items-center","justify-between","text-[10px]","bg-gray-50","dark:bg-gray-900","p-1.5","rounded"],[1,"font-semibold","text-gray-700","dark:text-gray-300"],[1,"text-gray-500","dark:text-gray-400"],[1,"font-bold","text-purple-700","dark:text-purple-300"],["type","button",1,"flex-1","px-3","py-1.5","bg-purple-600","hover:bg-purple-700","dark:bg-purple-700","dark:hover:bg-purple-600","text-white","text-[10px]","font-bold","rounded","transition-colors","flex","items-center","justify-center","gap-1",3,"click"],["type","button",1,"flex-1","px-3","py-1.5","bg-indigo-600","hover:bg-indigo-700","dark:bg-indigo-700","dark:hover:bg-indigo-600","text-white","text-[10px]","font-bold","rounded","transition-colors","flex","items-center","justify-center","gap-1",3,"click"],[1,"text-xs","font-bold","text-green-900","dark:text-green-100"],[1,"text-[9px]","text-green-600","dark:text-green-300"],[1,"mt-3","pt-3","border-t","border-red-200","dark:border-red-800"],[1,"text-[10px]","text-red-600","dark:text-red-400","bg-red-50","dark:bg-red-900/20","p-2","rounded","flex","items-center","gap-1"],[1,"text-[10px]","text-amber-600","dark:text-amber-400","bg-amber-50","dark:bg-amber-900/20","p-2","rounded","flex","items-center","gap-1"],[1,"flex","items-center","justify-between","p-2","rounded-lg","cursor-pointer","transition-all",3,"class"],[1,"flex","items-center","justify-between","p-2","rounded-lg","cursor-pointer","transition-all"],["type","radio","name","cuotaCancelacion",1,"w-4","h-4","text-green-600",3,"change","value","checked"],[1,"font-bold","text-xs"],[1,"text-[10px]","ml-2"],[1,"flex","items-center","gap-2","mb-2"],[1,"text-sm"],[1,"text-[10px]","font-bold","text-red-700","dark:text-red-400"],[1,"flex","items-center","justify-between","p-2","rounded-lg","bg-red-100","dark:bg-red-900/30","border","border-red-300","dark:border-red-700","opacity-75"],[1,"text-[9px]","text-red-600","dark:text-red-400","mt-2"],[1,"text-red-500","dark:text-red-400","text-xs"],[1,"font-bold","text-xs","text-red-800","dark:text-red-300"],[1,"text-[10px]","ml-2","text-red-600","dark:text-red-400"],[1,"font-bold","text-sm","text-red-700","dark:text-red-400"],["type","button",1,"px-3","py-1.5","text-xs","font-medium","rounded-lg","transition-all",3,"click"],[1,"mt-2","p-2","bg-white","dark:bg-gray-800","rounded","text-[10px]","space-y-1"],[1,"text-gray-600","dark:text-gray-400"],["type","button",1,"text-red-500","hover:text-red-700","text-[9px]","underline",3,"click"],[1,"flex-1","bg-gradient-to-r","from-amber-500","to-orange-600","hover:from-amber-600","hover:to-orange-700","disabled:from-gray-400","disabled:to-gray-500","text-white","dark:text-white","disabled:text-gray-200","py-2","px-4","rounded-lg","font-bold","text-xs","flex","items-center","justify-center","gap-2","transition-all","duration-300","shadow-lg","hover:shadow-xl","disabled:cursor-not-allowed",3,"click","disabled"],[1,"animate-pulse"],[1,"flex-1","bg-gradient-to-r","from-blue-600","to-blue-700","hover:from-blue-700","hover:to-blue-800","disabled:from-gray-400","disabled:to-gray-500","text-white","dark:text-white","disabled:text-gray-200","py-2","px-4","rounded-lg","font-bold","text-xs","flex","items-center","justify-center","gap-2","transition-all","duration-300","shadow-lg","hover:shadow-xl","disabled:cursor-not-allowed",3,"click","disabled","title"],[1,"text-slate-500","text-sm"],[1,"text-[9px]","text-slate-500","dark:text-slate-400"],[1,"text-[11px]","font-semibold","text-slate-700","dark:text-slate-300","truncate"],[1,"text-blue-500","text-sm"],[1,"text-[10px]","text-gray-600","dark:text-gray-300","break-all"],[1,"text-orange-500","text-sm"],[1,"text-[10px]","text-gray-600","dark:text-gray-300","line-clamp-2"],[1,"flex","justify-between","items-center","py-1","px-2","rounded","text-xs",3,"class"],[1,"flex","justify-between","items-center","py-1","px-2","rounded","text-xs"],[1,"truncate","mr-2","font-medium"],[1,"font-bold","whitespace-nowrap","text-sm"],[1,"bg-white","dark:bg-slate-900","rounded-xl","shadow-2xl","max-w-6xl","w-full","max-h-[90vh]","overflow-hidden","flex","flex-col","animate-slideInUp"],[1,"bg-gradient-to-r","from-purple-600","to-purple-700","dark:from-purple-700","dark:to-purple-800","text-white","px-6","py-4","flex","items-center","justify-between"],[1,"text-lg","font-bold"],["type","button",1,"p-2","hover:bg-white/20","rounded-lg","transition-colors",3,"click"],[1,"flex-1","overflow-y-auto","p-6"],[3,"managementId"],[1,"px-6","py-4","bg-slate-50","dark:bg-slate-800/50","border-t","border-slate-200","dark:border-slate-700","flex","justify-end"],["type","button",1,"px-4","py-2","text-sm","font-semibold","text-slate-700","dark:text-slate-300","hover:bg-slate-200","dark:hover:bg-slate-700","rounded-lg","transition-colors",3,"click"]],template:function(t,n){t&1&&(l(0,"div",1),g(1,Ei,7,0,"div",2),l(2,"div",3)(3,"div",4)(4,"div",5)(5,"div",6)(6,"div",7)(7,"div",8),B(8,"lucide-angular",9),a(),l(9,"h1",10),r(10,"Gesti\xF3n de Cobranza"),a()(),B(11,"div",11),l(12,"div")(13,"div",12),r(14,"Asesor"),a(),l(15,"div",13),r(16,"Mar\xEDa Gonz\xE1lez Castro"),a()()(),l(17,"div",6)(18,"div",14)(19,"div",12),r(20,"Estado"),a(),l(21,"div"),r(22),a()(),B(23,"app-status-alarm-clock",15),l(24,"div"),r(25),a()()()()(),l(26,"div",16)(27,"div",17)(28,"div",18),q(29,ki,3,4,"button",19,Ce),a(),l(31,"div",20)(32,"div"),g(33,Mi,4,1,"div",21),g(34,Ni,3,1,"div",22),a()()(),l(35,"div",23)(36,"div",24)(37,"div")(38,"div",5)(39,"h3",25),B(40,"div"),r(41," Control de Llamada "),a(),l(42,"div",26)(43,"button",27),E("click",function(){return n.toggleMute()}),r(44),a(),l(45,"button",28),E("click",function(){return n.endCall()}),r(46," Finalizar "),a()()()(),g(47,Oi,11,4,"div",29),g(48,Hi,3,0,"div",30),g(49,Ki,7,1,"div",31),g(50,Ji,4,0,"div",32),g(51,Zi,4,0,"div",33),g(52,Xi,2,4,"app-dynamic-field-renderer",34),g(53,eo,4,0,"div",35),g(54,ro,11,1,"div",36),g(55,ho,13,3,"div",37),g(56,vo,14,4,"div",38),l(57,"div",39),g(58,Eo,3,2,"button",40)(59,wo,3,3,"button",41),l(60,"button",42),E("click",function(){return n.cancelarTipificacion()}),r(61," Cancelar "),a()()()(),l(62,"div",43)(63,"div",44)(64,"div",45),r(65,"Contacto"),a(),l(66,"div",22)(67,"div",46)(68,"span",47),r(69,"\u{1F4F1}"),a(),l(70,"div",48)(71,"div",49),r(72,"Principal"),a(),l(73,"div",50),r(74),a()()(),g(75,Po,8,1,"div",51),g(76,Mo,8,1,"div",51),a()(),l(77,"div",44)(78,"div",22),g(79,Io,5,1,"div",52),g(80,To,5,1,"div",52),a()(),l(81,"div",53)(82,"div",54)(83,"div",55),r(84),a(),l(85,"div",56),r(86),a(),l(87,"div",57),r(88),a()()(),l(89,"div",58),g(90,Fo,3,0,"div",59),a()()(),g(91,No,15,2,"div",60),l(92,"app-select-supervisor-modal",61),_e("visibleChange",function(m){return be(n.showSupervisorModal,m)||(n.showSupervisorModal=m),m}),E("supervisorSelected",function(m){return n.onSupervisorSelected(m)})("cancelled",function(){return n.onSupervisorSelectionCancelled()}),a()()),t&2&&(s(),h(n.showSuccess()?1:-1),s(7),O("size",18),s(13),D("font-semibold text-sm transition-all duration-300 "+(n.callActive()?"text-green-400 animate-pulse":n.isTipifying()?"text-yellow-400":"text-white/80")),s(),f(" ",n.callActive()?"\u25CF EN LLAMADA":n.isTipifying()?"\u270E TIPIFICANDO":"\u25CB DISPONIBLE"," "),s(),O("color",n.colorIndicador())("excedido",n.excedeTiempoMaximo())("size",22),s(),D("px-4 py-1.5 rounded-lg font-mono text-lg font-bold transition-all duration-300 "+(n.callActive()?"bg-gradient-to-r from-red-600 to-red-700 animate-pulse shadow-lg shadow-red-500/30":"bg-blue-800/50 dark:bg-gray-900/80")),s(),f(" ",n.formatTime(n.callDuration())," "),s(4),W(n.tabs),s(4),h(n.activeTab()==="cliente"?33:-1),s(),h(n.activeTab()==="historial"?34:-1),s(3),D("bg-white dark:bg-gray-800 rounded-lg shadow-md border p-2 transition-colors duration-300 "+(n.callActive()?"border-green-400 dark:border-green-500":"border-gray-200 dark:border-gray-700")),s(3),D("p-1 rounded transition-all duration-300 "+(n.callActive()?"bg-green-100 dark:bg-green-900/30 animate-pulse":"bg-blue-100 dark:bg-blue-900/30")),s(3),D("px-4 py-1.5 rounded-lg font-bold flex items-center gap-2 transition-all duration-300 text-xs shadow-md hover:shadow-lg "+(n.callActive()?n.isMuted()?"bg-gradient-to-r from-yellow-600 to-yellow-700 hover:from-yellow-700 hover:to-yellow-800 text-white":"bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white":"bg-gray-400 text-gray-200 cursor-not-allowed")),O("disabled",!n.callActive()),s(),f(" ",n.isMuted()?"\u{1F507} Activar":"\u{1F50A} Silenciar"," "),s(),O("disabled",!n.callActive()),s(2),h(n.usesHierarchicalClassifications()?-1:47),s(),h(n.activePaymentSchedules()&&n.activePaymentSchedules().length>0?48:-1),s(),h(n.usesHierarchicalClassifications()?49:-1),s(),h(n.isLoadingDynamicFields()?50:-1),s(),h(!n.isLoadingDynamicFields()&&n.isLeafClassification()&&n.dynamicFields().length===0?51:-1),s(),h(!n.isLoadingDynamicFields()&&n.isLeafClassification()&&n.dynamicFieldsSchema()?52:-1),s(),h(n.isLoadingSchedules()?53:-1),s(),h(!n.isLoadingSchedules()&&n.showScheduleHelper()&&n.activeSchedules().length>0?54:-1),s(),h(n.isCancellationTypification()&&(n.pendingInstallmentsForCancellation().length>0||n.overdueInstallments().length>0)?55:-1),s(),h(n.isCancellationTypification()&&n.selectedInstallmentForCancellation()?56:-1),s(2),h(n.requiresAuthorization()?58:59),s(16),S(n.customerData().contacto.telefono_principal),s(),h(n.customerData().contacto.telefono_alternativo?75:-1),s(),h(n.customerData().contacto.telefono_trabajo?76:-1),s(3),h(n.customerData().contacto.email?79:-1),s(),h(n.customerData().contacto.direccion?80:-1),s(4),S(n.getPrimaryAmountLabel()),s(2),S(n.formatCurrency(n.getPrimaryAmountValue())),s(2),f("",n.clientDiasMora()," d\xEDas mora"),s(2),h(n.clientAmountFields().length>0?90:-1),s(),h(n.showScheduleDetail()&&n.scheduleManagementId()?91:-1),s(),xe("visible",n.showSupervisorModal))},dependencies:[ie,De,vt,St,Ct,Oe,Le,ft,ht,It,Vt,Ot,wt,se],styles:["@keyframes _ngcontent-%COMP%_slideInRight{0%{transform:translate(100%);opacity:0}to{transform:translate(0);opacity:1}}@keyframes _ngcontent-%COMP%_fadeIn{0%{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}@keyframes _ngcontent-%COMP%_slideInUp{0%{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}"]});let o=c;return o})();export{rl as CollectionManagementPage};
