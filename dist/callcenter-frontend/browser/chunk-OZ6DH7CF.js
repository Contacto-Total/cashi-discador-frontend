import{a as A}from"./chunk-JVX4WA6K.js";import{a as p}from"./chunk-YQKVMPSG.js";import{aa as o,da as u,ha as l,m as a,rd as d,td as h,ya as n}from"./chunk-QOPKCBWK.js";var T=(()=>{let i=class i{constructor(e,t){this.http=e,this.webSocketService=t,this.baseUrl=`${p.gatewayUrl}/autorizaciones`,this.supervisoresEnLinea=n([]),this.solicitudesPendientes=n([]),this.solicitudActual=n(null),this.cargando=n(!1),this.nuevaSolicitudSubject=new a,this.respuestaSubject=new a,this.nuevaSolicitud$=this.nuevaSolicitudSubject.asObservable(),this.respuesta$=this.respuestaSubject.asObservable(),this.wsSubscribed=!1,this.subscribeToWebSocket()}getHeaders(){let e=localStorage.getItem("callcenter_token");return new d({"Content-Type":"application/json",Authorization:e?`Bearer ${e}`:""})}getCurrentUserId(){try{let e=localStorage.getItem("callcenter_user");if(e)return JSON.parse(e).id||null}catch(e){console.error("[AUTORIZACION] Error obteniendo usuario actual:",e)}return null}obtenerSupervisoresEnLinea(){return console.log("[AUTORIZACION] Obteniendo supervisores en l\xEDnea..."),this.cargando.set(!0),this.http.get(`${this.baseUrl}/supervisores-en-linea`,{headers:this.getHeaders()}).pipe(o(e=>{this.supervisoresEnLinea.set(e),this.cargando.set(!1),console.log("[AUTORIZACION] Supervisores encontrados:",e.length)}))}crearSolicitud(e){return console.log("[AUTORIZACION] Creando solicitud:",e),this.cargando.set(!0),this.http.post(this.baseUrl,e,{headers:this.getHeaders()}).pipe(o(t=>{this.solicitudActual.set(t),this.cargando.set(!1),console.log("[AUTORIZACION] Solicitud creada:",t.uuid)}))}responderSolicitud(e){return console.log("[AUTORIZACION] Respondiendo solicitud:",e),this.http.post(`${this.baseUrl}/responder`,e,{headers:this.getHeaders()}).pipe(o(t=>{console.log("[AUTORIZACION] Solicitud respondida:",t.estado),this.solicitudesPendientes.update(s=>s.filter(r=>r.uuid!==t.uuid))}))}obtenerSolicitudesPendientes(e){return console.log("[AUTORIZACION] Obteniendo pendientes para supervisor:",e),this.http.get(`${this.baseUrl}/pendientes/${e}`,{headers:this.getHeaders()}).pipe(o(t=>{this.solicitudesPendientes.set(t),console.log("[AUTORIZACION] Solicitudes pendientes:",t.length)}))}obtenerPorUuid(e){return this.http.get(`${this.baseUrl}/${e}`,{headers:this.getHeaders()})}cancelarSolicitud(e,t){return console.log("[AUTORIZACION] Cancelando solicitud:",e),this.http.post(`${this.baseUrl}/${e}/cancelar`,{idAgente:t},{headers:this.getHeaders()}).pipe(o(s=>{this.solicitudActual.set(null),console.log("[AUTORIZACION] Solicitud cancelada")}))}subscribeToWebSocket(){this.wsSubscribed||(this.webSocketService.isConnected()||this.webSocketService.connect(),this.webSocketService.subscribe("/user/queue/messages").subscribe(e=>{this.handleWebSocketMessage(e)}),this.webSocketService.subscribe("/topic/autorizaciones/supervisores").subscribe(e=>{this.handleWebSocketMessage(e)}),this.wsSubscribed=!0,console.log("[AUTORIZACION] Subscrito a WebSocket para autorizaciones"))}handleWebSocketMessage(e){if(console.log("[AUTORIZACION] Mensaje WebSocket recibido (raw):",e),!e)return;let t;if(e.payload&&e.payload.tipo)t=e.payload,console.log("[AUTORIZACION] Mensaje normalizado desde payload:",t);else if(e.tipo)t=e;else if(e.type&&e.payload)t=e.payload;else{console.log("[AUTORIZACION] Formato de mensaje no reconocido:",e);return}if(!t.tipo||!t.solicitud){console.log("[AUTORIZACION] Evento incompleto, ignorando:",t);return}let s=this.getCurrentUserId();switch(console.log("[AUTORIZACION] Procesando evento:",t.tipo,"| Usuario actual:",s),t.tipo){case"NUEVA_SOLICITUD_AUTORIZACION":if(t.solicitud.idSupervisor!==s){console.log("[AUTORIZACION] Ignorando solicitud - no es para este supervisor. Destinatario:",t.solicitud.idSupervisor,"Yo:",s);return}console.log("[AUTORIZACION] Nueva solicitud recibida para M\xCD!"),this.solicitudesPendientes.update(r=>[t.solicitud,...r]),this.nuevaSolicitudSubject.next(t.solicitud);break;case"SOLICITUD_APROBADA":console.log("[AUTORIZACION] \u2705 Solicitud APROBADA recibida!"),this.solicitudActual.set(t.solicitud),this.respuestaSubject.next(t.solicitud);break;case"SOLICITUD_RECHAZADA":console.log("[AUTORIZACION] \u274C Solicitud RECHAZADA recibida!"),this.solicitudActual.set(t.solicitud),this.respuestaSubject.next(t.solicitud);break;case"SOLICITUD_CANCELADA":console.log("[AUTORIZACION] Solicitud cancelada por agente"),this.solicitudesPendientes.update(r=>r.filter(b=>b.uuid!==t.solicitud.uuid));break;case"SOLICITUD_EXPIRADA":console.log("[AUTORIZACION] Solicitud expirada!"),this.solicitudActual.set(t.solicitud),this.respuestaSubject.next(t.solicitud);break}}limpiarEstado(){this.solicitudActual.set(null),this.supervisoresEnLinea.set([])}};i.\u0275fac=function(t){return new(t||i)(l(h),l(A))},i.\u0275prov=u({token:i,factory:i.\u0275fac,providedIn:"root"});let c=i;return c})();export{T as a};
