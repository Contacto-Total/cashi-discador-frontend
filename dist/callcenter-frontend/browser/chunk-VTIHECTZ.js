import{a as d}from"./chunk-YQKVMPSG.js";import{ca as h,ga as g,ud as p,v as s}from"./chunk-SN4XSKG7.js";var v=(()=>{let l=class l{constructor(e){this.http=e,this.baseUrl=`${d.gatewayUrl}/v2/management-records`,this.scheduleUrl=`${d.tipificacionUrl}/payment-schedules`,this.cabecerasUrl=`${d.gatewayUrl}/configuracion-cabeceras`}createManagement(e){let t=this.transformToBackendFormat(e);return console.log("[MANAGEMENT] Creating management record:",t),this.http.post(this.baseUrl,t).pipe(s(n=>this.transformToFrontendFormat(n,e)))}getManagementById(e){return this.http.get(`${this.baseUrl}/${e}`).pipe(s(t=>this.transformToFrontendFormat(t)))}getManagementsByCustomer(e){return this.http.get(`${this.baseUrl}/client/${e}`).pipe(s(t=>t.map(n=>this.transformToFrontendFormat(n))))}getManagementsByDocumento(e){return console.log("[MANAGEMENT] Fetching managements by documento:",e),this.http.get(`${this.baseUrl}/documento/${e}`).pipe(s(t=>t.map(n=>this.transformToFrontendFormat(n))))}getManagementsByAdvisor(e){return this.http.get(`${this.baseUrl}/agent/${e}`).pipe(s(t=>t.map(n=>this.transformToFrontendFormat(n))))}getActiveSchedulesByCustomer(e){return console.log("[SCHEDULE] Fetching active schedules for customer:",e),this.http.get(`${this.baseUrl}/payment-schedule/client/${e}/active`).pipe(s(t=>this.transformToPaymentSchedules(t)))}getActiveSchedulesByDocumento(e){return console.log("[SCHEDULE] Fetching active schedules for documento:",e),this.http.get(`${this.baseUrl}/payment-schedule/documento/${e}/active`).pipe(s(t=>this.transformToPaymentSchedules(t)))}transformToPaymentSchedules(e){return e.map(t=>{let n=t.cuotasPromesa||[],o=n.reduce((a,r)=>a+(r.montoPromesa||r.monto||0),0),i=n.filter(a=>a.estado==="PAGADA"||a.estado==="CUMPLIDO").reduce((a,r)=>a+(r.montoPagadoReal||r.montoPromesa||r.monto||0),0),m=o-i,f=n.filter(a=>a.estado==="PAGADA"||a.estado==="CUMPLIDO").length,u=n.filter(a=>a.estado==="PENDIENTE").length;return{id:t.id,scheduleId:{scheduleId:t.grupoPromesaUuid||t.uuid},customerId:String(t.idCliente),managementId:String(t.id),totalAmount:o,numberOfInstallments:n.length,startDate:t.fechaGestion?.split("T")[0]||new Date().toISOString().split("T")[0],isActive:u>0,scheduleType:t.tipoCronograma||"CONFIANZA",negotiatedAmount:t.montoPromesaPago||o,installments:n.map(a=>({id:a.id,installmentNumber:a.numeroCuota,numeroCuota:a.numeroCuota,amount:a.montoPromesa||a.monto,monto:a.montoPromesa||a.monto,montoPromesa:a.montoPromesa||a.monto,dueDate:a.fechaPromesa||a.fechaPago,fechaPago:a.fechaPromesa||a.fechaPago,fechaPromesa:a.fechaPromesa||a.fechaPago,paidDate:a.fechaPagoReal||null,status:a.estado||"PENDIENTE",montoPagadoReal:a.montoPagadoReal||0})),paidAmount:i,pendingAmount:m,paidInstallments:f,pendingInstallments:u,fullyPaid:u===0}})}startCall(e,t){return console.log("[CALL] Start call for management:",e,t),this.getManagementById(e.toString())}endCall(e,t){return console.log("[CALL] End call for management:",e,t),this.getManagementById(e.toString())}registerPayment(e,t){return console.log("[PAYMENT] Register payment for management:",e,t),this.getManagementById(e)}createPaymentSchedule(e){return console.log("[SCHEDULE] Creating payment schedule:",e),this.http.post(`${this.baseUrl}/payment-schedule`,e)}updatePaymentStatus(e,t,n,o){console.log("[PAYMENT-STATUS] Updating payment status:",{recordId:e,estadoPago:t,montoPagadoReal:n,fechaPagoReal:o});let i=`estadoPago=${t}`;return n!==void 0&&(i+=`&montoPagadoReal=${n}`),o&&(i+=`&fechaPagoReal=${o}`),this.http.put(`${this.baseUrl}/${e}/payment-status?${i}`,{})}puedeCancelarCuota(e){return console.log("[CUOTA] Checking if cuota can be canceled:",e),this.http.get(`${this.baseUrl}/cuota/${e}/puede-cancelar`)}cancelarCuota(e,t,n,o){console.log("[CUOTA] Canceling cuota:",{cuotaId:e,montoPagadoReal:t,fechaPagoReal:n,observaciones:o});let i="",m=[];return t!==void 0&&m.push(`montoPagadoReal=${t}`),n&&m.push(`fechaPagoReal=${n}`),o&&m.push(`observaciones=${encodeURIComponent(o)}`),m.length>0&&(i="?"+m.join("&")),this.http.put(`${this.baseUrl}/cuota/${e}/cancelar${i}`,{})}getMontoCabeceras(e){return console.log("[CABECERAS] Fetching monto cabeceras for subcartera:",e),this.http.get(`${this.cabecerasUrl}/subcartera/${e}/montos`)}updateAmountVisibility(e,t){return console.log("[CABECERAS] Updating visibility for subcartera:",e,t),this.http.put(`${this.cabecerasUrl}/subcartera/${e}/visibility`,t)}transformToBackendFormat(e){let t=e.level3Id||e.level2Id||e.level1Id,n=[];e.level1Name&&n.push(e.level1Name),e.level2Name&&n.push(e.level2Name),e.level3Name&&n.push(e.level3Name);let o=n.join(" > ");return{idTenant:e.tenantId,idCartera:e.portfolioId,idSubcartera:e.subPortfolioId||void 0,idCliente:Number(e.customerId),nombreCliente:e.customerName||void 0,documentoCliente:e.customerDocument||void 0,idAgente:this.extractAgentId(e.advisorId),tipificacion:{id:t},observaciones:e.observations||"",telefonoContacto:e.phone||void 0,canalContacto:e.canalContacto||void 0,metodoContacto:e.metodoContacto||"GESTION_MANUAL",estadoGestion:"COMPLETADA",idCampana:e.idCampana||void 0,idLlamada:e.idLlamada||void 0,duracionSegundos:e.duracionSegundos||void 0,nombreAgente:e.nombreAgente||void 0,userAgent:e.userAgent||void 0}}transformToFrontendFormat(e,t){let n=e.fechaGestion;return n&&n.includes("T")&&(n=n.split("T")[0]),{id:e.id||0,customerId:String(e.idCliente),advisorId:String(e.idAgente),tenantId:e.idTenant,tenantName:"",portfolioId:e.idCartera||0,portfolioName:"",subPortfolioId:e.idSubcartera,subPortfolioName:"",phone:e.telefonoContacto||"",telefonoContacto:e.telefonoContacto||"",level1Id:e.tipificacion?.id||0,level1Name:t?.level1Name||e.rutaNivel1||"",level2Id:void 0,level2Name:t?.level2Name||e.rutaNivel2||"",level3Id:void 0,level3Name:t?.level3Name||e.rutaNivel3||"",level4Name:e.rutaNivel4||"",observations:e.observaciones,managementDate:n,managementTime:void 0,canalContacto:e.canalContacto||"",metodoContacto:e.metodoContacto||"",nombreAgente:e.nombreAgente||e.userAgent||`Agente ${e.idAgente}`,duracionSegundos:e.duracionSegundos||0,montoPromesa:e.montoPromesa||void 0,estadoPago:e.estadoPago||void 0}}extractAgentId(e){return e.startsWith("ADV-")?1:Number(e)||1}};l.\u0275fac=function(t){return new(t||l)(g(p))},l.\u0275prov=h({token:l,factory:l.\u0275fac,providedIn:"root"});let c=l;return c})();export{v as a};
