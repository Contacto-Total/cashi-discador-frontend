{
  "version": 3,
  "sources": ["src/app/core/services/auth.service.ts"],
  "sourcesContent": ["import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { BehaviorSubject, Observable, tap } from 'rxjs';\r\nimport { Router } from '@angular/router';\r\nimport { environment } from '../../../environments/environment';\r\nimport {User, LoginRequest, LoginResponse, UserRole} from '../models/user.model';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class AuthService {\r\n  private readonly TOKEN_KEY = 'callcenter_token';\r\n  private readonly USER_KEY = 'callcenter_user';\r\n  private currentUserSubject: BehaviorSubject<User | null>;\r\n  public currentUser$: Observable<User | null>;\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private router: Router\r\n  ) {\r\n    let user: User | null = null;\r\n    try {\r\n      const storedUser = localStorage.getItem(this.USER_KEY);\r\n      if (storedUser && storedUser !== 'undefined') {\r\n        user = JSON.parse(storedUser);\r\n      }\r\n    } catch (e) {\r\n      console.error('Error parsing stored user', e);\r\n      localStorage.removeItem(this.USER_KEY);\r\n    }\r\n    this.currentUserSubject = new BehaviorSubject<User | null>(user);\r\n    this.currentUser$ = this.currentUserSubject.asObservable();\r\n  }\r\n\r\n  login(username: string, password: string): Observable<LoginResponse> {\r\n    // Mapear parámetros (inglés) a request del backend (español)\r\n    const request: LoginRequest = {\r\n      nombreUsuario: username,\r\n      contrasena: password\r\n    };\r\n    return this.http.post<LoginResponse>(`${environment.apiUrl}/auth/login`, request).pipe(\r\n      tap(response => {\r\n        // Guardar access token y refresh token\r\n        localStorage.setItem(this.TOKEN_KEY, response.accessToken);\r\n        localStorage.setItem('refresh_token', response.refreshToken);\r\n\r\n        // Dividir nombreCompleto en firstName y lastName\r\n        const nameParts = response.nombreCompleto?.split(' ') || ['', ''];\r\n        const firstName = nameParts[0] || '';\r\n        const lastName = nameParts.slice(1).join(' ') || '';\r\n\r\n        // Mapear respuesta del backend (español) al modelo User (inglés)\r\n        const user: User = {\r\n          id: response.idUsuario,\r\n          username: response.nombreUsuario,\r\n          email: response.email,\r\n          firstName: firstName,\r\n          lastName: lastName,\r\n          role: (response.roles?.[0] || 'AGENT') as UserRole,\r\n          sipExtension: response.extensionSip,\r\n          active: true,\r\n          tenantId: response.tenantId,\r\n          portfolioId: response.portfolioId,\r\n          subPortfolioId: response.subPortfolioId\r\n        };\r\n\r\n        localStorage.setItem(this.USER_KEY, JSON.stringify(user));\r\n        this.currentUserSubject.next(user);\r\n      })\r\n    );\r\n  }\r\n\r\n  logout(): void {\r\n    localStorage.removeItem(this.TOKEN_KEY);\r\n    localStorage.removeItem('refresh_token');\r\n    localStorage.removeItem(this.USER_KEY);\r\n    this.currentUserSubject.next(null);\r\n    this.router.navigate(['/login']);\r\n  }\r\n\r\n  isAuthenticated(): boolean {\r\n    const token = this.getToken();\r\n    if (!token) {\r\n      return false;\r\n    }\r\n\r\n    // Check if token is expired\r\n    try {\r\n      const payload = JSON.parse(atob(token.split('.')[1]));\r\n      const expiry = payload.exp * 1000;\r\n      return Date.now() < expiry;\r\n    } catch (e) {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  getToken(): string | null {\r\n    return localStorage.getItem(this.TOKEN_KEY);\r\n  }\r\n\r\n  getCurrentUser(): User | null {\r\n    return this.currentUserSubject.value;\r\n  }\r\n\r\n  getCurrentUserId(): number | null {\r\n    const user = this.getCurrentUser();\r\n    return user ? user.id : null;\r\n  }\r\n\r\n  getRefreshToken(): string | null {\r\n    return localStorage.getItem('refresh_token');\r\n  }\r\n\r\n  refreshToken(): Observable<LoginResponse> {\r\n    const refreshToken = this.getRefreshToken();\r\n    if (!refreshToken) {\r\n      throw new Error('No refresh token available');\r\n    }\r\n\r\n    return this.http.post<LoginResponse>(`${environment.apiUrl}/auth/refresh-token`, {\r\n      refreshToken: refreshToken\r\n    }).pipe(\r\n      tap(response => {\r\n        // Actualizar access token\r\n        localStorage.setItem(this.TOKEN_KEY, response.accessToken);\r\n        // El refresh token no cambia, pero si viene uno nuevo, actualizarlo\r\n        if (response.refreshToken) {\r\n          localStorage.setItem('refresh_token', response.refreshToken);\r\n        }\r\n      })\r\n    );\r\n  }\r\n\r\n  isTokenExpiringSoon(): boolean {\r\n    const token = this.getToken();\r\n    if (!token) {\r\n      return false;\r\n    }\r\n\r\n    try {\r\n      const payload = JSON.parse(atob(token.split('.')[1]));\r\n      const expiry = payload.exp * 1000;\r\n      const now = Date.now();\r\n      // Renovar si falta menos de 5 minutos para expirar\r\n      const fiveMinutes = 5 * 60 * 1000;\r\n      return (expiry - now) < fiveMinutes && expiry > now;\r\n    } catch (e) {\r\n      return false;\r\n    }\r\n  }\r\n}\r\n"],
  "mappings": "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",
  "names": []
}
