import{a as p}from"./chunk-QOSDLDQ4.js";import{a as b}from"./chunk-DF6EJM3T.js";import{aa as o,da as u,ha as l,m as n,rd as d,td as h,ya as c}from"./chunk-QOPKCBWK.js";var T=(()=>{let s=class s{constructor(e,t){this.http=e,this.webSocketService=t,this.baseUrl=`${b.gatewayUrl}/autorizaciones`,this.supervisoresEnLinea=c([]),this.solicitudesPendientes=c([]),this.solicitudActual=c(null),this.cargando=c(!1),this.nuevaSolicitudSubject=new n,this.respuestaSubject=new n,this.nuevaSolicitud$=this.nuevaSolicitudSubject.asObservable(),this.respuesta$=this.respuestaSubject.asObservable(),this.wsSubscribed=!1,this.subscribeToWebSocket()}getHeaders(){let e=localStorage.getItem("callcenter_token");return new d({"Content-Type":"application/json",Authorization:e?`Bearer ${e}`:""})}obtenerSupervisoresEnLinea(){return console.log("[AUTORIZACION] Obteniendo supervisores en l\xEDnea..."),this.cargando.set(!0),this.http.get(`${this.baseUrl}/supervisores-en-linea`,{headers:this.getHeaders()}).pipe(o(e=>{this.supervisoresEnLinea.set(e),this.cargando.set(!1),console.log("[AUTORIZACION] Supervisores encontrados:",e.length)}))}crearSolicitud(e){return console.log("[AUTORIZACION] Creando solicitud:",e),this.cargando.set(!0),this.http.post(this.baseUrl,e,{headers:this.getHeaders()}).pipe(o(t=>{this.solicitudActual.set(t),this.cargando.set(!1),console.log("[AUTORIZACION] Solicitud creada:",t.uuid)}))}responderSolicitud(e){return console.log("[AUTORIZACION] Respondiendo solicitud:",e),this.http.post(`${this.baseUrl}/responder`,e,{headers:this.getHeaders()}).pipe(o(t=>{console.log("[AUTORIZACION] Solicitud respondida:",t.estado),this.solicitudesPendientes.update(i=>i.filter(r=>r.uuid!==t.uuid))}))}obtenerSolicitudesPendientes(e){return console.log("[AUTORIZACION] Obteniendo pendientes para supervisor:",e),this.http.get(`${this.baseUrl}/pendientes/${e}`,{headers:this.getHeaders()}).pipe(o(t=>{this.solicitudesPendientes.set(t),console.log("[AUTORIZACION] Solicitudes pendientes:",t.length)}))}obtenerPorUuid(e){return this.http.get(`${this.baseUrl}/${e}`,{headers:this.getHeaders()})}cancelarSolicitud(e,t){return console.log("[AUTORIZACION] Cancelando solicitud:",e),this.http.post(`${this.baseUrl}/${e}/cancelar`,{idAgente:t},{headers:this.getHeaders()}).pipe(o(i=>{this.solicitudActual.set(null),console.log("[AUTORIZACION] Solicitud cancelada")}))}subscribeToWebSocket(){this.wsSubscribed||(this.webSocketService.isConnected()||this.webSocketService.connect(),this.webSocketService.subscribe("/user/queue/messages").subscribe(e=>{this.handleWebSocketMessage(e)}),this.webSocketService.subscribe("/topic/autorizaciones/supervisores").subscribe(e=>{this.handleWebSocketMessage(e)}),this.wsSubscribed=!0,console.log("[AUTORIZACION] Subscrito a WebSocket para autorizaciones"))}handleWebSocketMessage(e){if(console.log("[AUTORIZACION] Mensaje WebSocket recibido:",e),!e||!e.tipo)return;let t=e;switch(t.tipo){case"NUEVA_SOLICITUD_AUTORIZACION":console.log("[AUTORIZACION] Nueva solicitud recibida!"),this.solicitudesPendientes.update(i=>[t.solicitud,...i]),this.nuevaSolicitudSubject.next(t.solicitud);break;case"SOLICITUD_APROBADA":console.log("[AUTORIZACION] Solicitud aprobada!"),this.solicitudActual.set(t.solicitud),this.respuestaSubject.next(t.solicitud);break;case"SOLICITUD_RECHAZADA":console.log("[AUTORIZACION] Solicitud rechazada!"),this.solicitudActual.set(t.solicitud),this.respuestaSubject.next(t.solicitud);break;case"SOLICITUD_CANCELADA":console.log("[AUTORIZACION] Solicitud cancelada por agente"),this.solicitudesPendientes.update(i=>i.filter(r=>r.uuid!==t.solicitud.uuid));break;case"SOLICITUD_EXPIRADA":console.log("[AUTORIZACION] Solicitud expirada!"),this.solicitudActual.set(t.solicitud),this.respuestaSubject.next(t.solicitud);break}}limpiarEstado(){this.solicitudActual.set(null),this.supervisoresEnLinea.set([])}};s.\u0275fac=function(t){return new(t||s)(l(h),l(p))},s.\u0275prov=u({token:s,factory:s.\u0275fac,providedIn:"root"});let a=s;return a})();export{T as a};
