import{N as a,Q as m,T as c,gc as f,k as h,mc as p,rc as l}from"./chunk-OVXRDAV3.js";var d=(()=>{let s=class s{constructor(t,r){this.http=t,this.router=r,this.TOKEN_KEY="callcenter_token",this.USER_KEY="callcenter_user";let o=null;try{let e=localStorage.getItem(this.USER_KEY);e&&e!=="undefined"&&(o=JSON.parse(e))}catch(e){console.error("Error parsing stored user",e),localStorage.removeItem(this.USER_KEY)}this.currentUserSubject=new h(o),this.currentUser$=this.currentUserSubject.asObservable()}login(t,r){let o={nombreUsuario:t,contrasena:r};return this.http.post(`${l.apiUrl}/auth/login`,o).pipe(a(e=>{localStorage.setItem(this.TOKEN_KEY,e.accessToken),localStorage.setItem("refresh_token",e.refreshToken);let n=e.nombreCompleto?.split(" ")||["",""],g=n[0]||"",S=n.slice(1).join(" ")||"",u={id:e.idUsuario,username:e.nombreUsuario,email:e.email,firstName:g,lastName:S,role:e.roles?.[0]||"AGENT",sipExtension:e.extensionSip,active:!0};localStorage.setItem(this.USER_KEY,JSON.stringify(u)),this.currentUserSubject.next(u)}))}logout(){localStorage.removeItem(this.TOKEN_KEY),localStorage.removeItem("refresh_token"),localStorage.removeItem(this.USER_KEY),this.currentUserSubject.next(null),this.router.navigate(["/login"])}isAuthenticated(){let t=this.getToken();if(!t)return!1;try{let o=JSON.parse(atob(t.split(".")[1])).exp*1e3;return Date.now()<o}catch{return!1}}getToken(){return localStorage.getItem(this.TOKEN_KEY)}getCurrentUser(){return this.currentUserSubject.value}getCurrentUserId(){let t=this.getCurrentUser();return t?t.id:null}getRefreshToken(){return localStorage.getItem("refresh_token")}refreshToken(){let t=this.getRefreshToken();if(!t)throw new Error("No refresh token available");return this.http.post(`${l.apiUrl}/auth/refresh-token`,{refreshToken:t}).pipe(a(r=>{localStorage.setItem(this.TOKEN_KEY,r.accessToken),r.refreshToken&&localStorage.setItem("refresh_token",r.refreshToken)}))}isTokenExpiringSoon(){let t=this.getToken();if(!t)return!1;try{let o=JSON.parse(atob(t.split(".")[1])).exp*1e3,e=Date.now(),n=300*1e3;return o-e<n&&o>e}catch{return!1}}};s.\u0275fac=function(r){return new(r||s)(c(f),c(p))},s.\u0275prov=m({token:s,factory:s.\u0275fac,providedIn:"root"});let i=s;return i})();export{d as a};
