import{c as k}from"./chunk-IW4UZOVV.js";import{a}from"./chunk-YQKVMPSG.js";import{c as m}from"./chunk-72Z2NTOL.js";import{_ as h,ba as g,fa as s,n as u,wb as f}from"./chunk-BDAG5FYU.js";var v=(()=>{let i=class i{constructor(e,r,n){this.http=e,this.router=r,this.ngZone=n,this.TOKEN_KEY="callcenter_token",this.USER_KEY="callcenter_user",this.isLoggingOut=!1;let t=null;try{let o=localStorage.getItem(this.USER_KEY);o&&o!=="undefined"&&(t=JSON.parse(o))}catch(o){console.error("Error parsing stored user",o),localStorage.removeItem(this.USER_KEY)}this.currentUserSubject=new u(t),this.currentUser$=this.currentUserSubject.asObservable(),window.addEventListener("storage",o=>{o.key===this.TOKEN_KEY&&!o.newValue&&this.ngZone.run(()=>{this.handleTokenRemoved()})}),this.startTokenCheck()}startTokenCheck(){this.ngZone.runOutsideAngular(()=>{this.tokenCheckInterval=setInterval(()=>{let e=localStorage.getItem(this.TOKEN_KEY);this.currentUserSubject.value&&!e&&this.ngZone.run(()=>{this.handleTokenRemoved()}),e&&!this.isAuthenticated()&&this.ngZone.run(()=>{this.handleTokenExpired()})},5e3)})}handleTokenRemoved(){this.isLoggingOut||(this.isLoggingOut=!0,console.log("[AUTH] Token eliminado del localStorage"),this.currentUserSubject.next(null),localStorage.removeItem(this.USER_KEY),localStorage.removeItem("refresh_token"),this.router.url!=="/login"?(alert("Tu sesi\xF3n ha finalizado"),this.router.navigate(["/login"]).then(()=>{this.isLoggingOut=!1})):this.isLoggingOut=!1)}handleTokenExpired(){this.isLoggingOut||(this.isLoggingOut=!0,console.log("[AUTH] Token expirado"),alert("Tu sesi\xF3n ha expirado"),this.logout(),this.isLoggingOut=!1)}login(e,r){let n={nombreUsuario:e,contrasena:r};return this.http.post(`${a.apiUrl}/auth/login`,n).pipe(h(t=>{localStorage.setItem(this.TOKEN_KEY,t.accessToken),localStorage.setItem("refresh_token",t.refreshToken);let o=t.nombreCompleto?.split(" ")||["",""],d=o[0]||"",p=o.slice(1).join(" ")||"",c={id:t.idUsuario,username:t.nombreUsuario,email:t.email,firstName:d,lastName:p,role:t.roles?.[0]||"AGENT",sipExtension:t.extensionSip,active:!0,tenantId:t.tenantId,portfolioId:t.portfolioId,subPortfolioId:t.subPortfolioId};localStorage.setItem(this.USER_KEY,JSON.stringify(c)),this.currentUserSubject.next(c)}))}logout(){this.tokenCheckInterval&&(clearInterval(this.tokenCheckInterval),this.tokenCheckInterval=null),localStorage.removeItem(this.TOKEN_KEY),localStorage.removeItem("refresh_token"),localStorage.removeItem(this.USER_KEY),this.currentUserSubject.next(null),this.router.navigate(["/login"]),this.startTokenCheck()}isAuthenticated(){let e=this.getToken();if(!e)return!1;try{let n=JSON.parse(atob(e.split(".")[1])).exp*1e3;return Date.now()<n}catch{return!1}}getToken(){return localStorage.getItem(this.TOKEN_KEY)}getCurrentUser(){return this.currentUserSubject.value}getCurrentUserId(){let e=this.getCurrentUser();return e?e.id:null}getRefreshToken(){return localStorage.getItem("refresh_token")}refreshToken(){let e=this.getRefreshToken();if(!e)throw new Error("No refresh token available");return this.http.post(`${a.apiUrl}/auth/refresh-token`,{refreshToken:e}).pipe(h(r=>{localStorage.setItem(this.TOKEN_KEY,r.accessToken),r.refreshToken&&localStorage.setItem("refresh_token",r.refreshToken)}))}isTokenExpiringSoon(){let e=this.getToken();if(!e)return!1;try{let n=JSON.parse(atob(e.split(".")[1])).exp*1e3,t=Date.now(),o=300*1e3;return n-t<o&&n>t}catch{return!1}}getRoles(){return this.http.get(`${a.apiUrl}/roles`)}};i.\u0275fac=function(r){return new(r||i)(s(m),s(k),s(f))},i.\u0275prov=g({token:i,factory:i.\u0275fac,providedIn:"root"});let l=i;return l})();export{v as a};
