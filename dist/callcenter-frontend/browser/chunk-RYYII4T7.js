import{a as I}from"./chunk-ITWNWEHW.js";import{Tb as p}from"./chunk-XLQ3V3R5.js";import{_ as s,ba as u,fa as a,m as l,pd as d,rd as A,wa as r}from"./chunk-S5LLKQFC.js";var R=(()=>{let o=class o{constructor(e,t){this.http=e,this.webSocketService=t,this.baseUrl=`${p.gatewayUrl}/autorizaciones`,this.supervisoresEnLinea=r([]),this.solicitudesPendientes=r([]),this.solicitudActual=r(null),this.cargando=r(!1),this.nuevaSolicitudSubject=new l,this.respuestaSubject=new l,this.nuevaSolicitud$=this.nuevaSolicitudSubject.asObservable(),this.respuesta$=this.respuestaSubject.asObservable(),this.wsSubscribed=!1,this.subscribeToWebSocket()}getHeaders(){let e=localStorage.getItem("callcenter_token");return new d({"Content-Type":"application/json",Authorization:e?`Bearer ${e}`:""})}getCurrentUserId(){try{let e=localStorage.getItem("callcenter_user");if(e)return JSON.parse(e).id||null}catch(e){console.error("[AUTORIZACION] Error obteniendo usuario actual:",e)}return null}obtenerSupervisoresEnLinea(){return console.log("[AUTORIZACION] Obteniendo supervisores en l\xEDnea..."),this.cargando.set(!0),this.http.get(`${this.baseUrl}/supervisores-en-linea`,{headers:this.getHeaders()}).pipe(s(e=>{this.supervisoresEnLinea.set(e),this.cargando.set(!1),console.log("[AUTORIZACION] Supervisores encontrados:",e.length)}))}crearSolicitud(e){return console.log("[AUTORIZACION] Creando solicitud:",e),this.cargando.set(!0),this.http.post(this.baseUrl,e,{headers:this.getHeaders()}).pipe(s(t=>{this.solicitudActual.set(t),this.cargando.set(!1),console.log("[AUTORIZACION] Solicitud creada:",t.uuid)}))}responderSolicitud(e){return console.log("[AUTORIZACION] Respondiendo solicitud:",e),this.http.post(`${this.baseUrl}/responder`,e,{headers:this.getHeaders()}).pipe(s(t=>{console.log("[AUTORIZACION] Solicitud respondida:",t.estado),this.solicitudesPendientes.update(i=>i.filter(n=>n.uuid!==t.uuid))}))}obtenerSolicitudesPendientes(e){return console.log("[AUTORIZACION] Obteniendo pendientes para supervisor:",e),this.http.get(`${this.baseUrl}/pendientes/${e}`,{headers:this.getHeaders()}).pipe(s(t=>{this.solicitudesPendientes.set(t),console.log("[AUTORIZACION] Solicitudes pendientes:",t.length)}))}obtenerPorUuid(e){return this.http.get(`${this.baseUrl}/${e}`,{headers:this.getHeaders()})}cancelarSolicitud(e,t){return console.log("[AUTORIZACION] Cancelando solicitud:",e),this.http.post(`${this.baseUrl}/${e}/cancelar`,{idAgente:t},{headers:this.getHeaders()}).pipe(s(i=>{this.solicitudActual.set(null),console.log("[AUTORIZACION] Solicitud cancelada")}))}subscribeToWebSocket(){this.wsSubscribed||(console.log("[AUTORIZACION] Iniciando suscripci\xF3n a WebSocket..."),this.webSocketService.isConnected()||(console.log("[AUTORIZACION] WebSocket no conectado, iniciando conexi\xF3n..."),this.webSocketService.connect()),console.log("[AUTORIZACION] Suscribiendo a /user/queue/messages..."),this.webSocketService.subscribe("/user/queue/messages").subscribe(e=>{console.log("[AUTORIZACION] \u{1F4EC} Mensaje recibido en /user/queue/messages:",e),this.handleWebSocketMessage(e)}),console.log("[AUTORIZACION] Suscribiendo a /topic/autorizaciones/supervisores..."),this.webSocketService.subscribe("/topic/autorizaciones/supervisores").subscribe(e=>{console.log("[AUTORIZACION] \u{1F4EC} Mensaje recibido en /topic/autorizaciones/supervisores:",e),this.handleWebSocketMessage(e)}),this.wsSubscribed=!0,console.log("[AUTORIZACION] \u2705 Subscrito a WebSocket para autorizaciones"))}ensureWebSocketSubscription(){console.log("[AUTORIZACION] Verificando suscripci\xF3n WebSocket..."),this.wsSubscribed?console.log("[AUTORIZACION] Ya est\xE1 suscrito a WebSocket"):this.subscribeToWebSocket()}handleWebSocketMessage(e){if(console.log("[AUTORIZACION] \u{1F4E8} Mensaje WebSocket recibido (raw):",JSON.stringify(e,null,2)),!e)return;let t;if(e.tipo&&e.solicitud)t=e,console.log("[AUTORIZACION] \u2705 Mensaje en formato directo:",t.tipo);else if(e.payload&&e.payload.tipo)t=e.payload,console.log("[AUTORIZACION] \u2705 Mensaje normalizado desde payload:",t.tipo);else if(e.type&&e.payload&&e.payload.solicitud)t=e.payload,console.log("[AUTORIZACION] \u2705 Mensaje normalizado desde type/payload:",t.tipo);else{console.log("[AUTORIZACION] \u26A0\uFE0F Formato de mensaje no reconocido:",e);return}if(!t.tipo||!t.solicitud){console.log("[AUTORIZACION] \u26A0\uFE0F Evento incompleto, ignorando:",t);return}let i=this.getCurrentUserId();switch(console.log("[AUTORIZACION] Procesando evento:",t.tipo,"| Usuario actual:",i),t.tipo){case"NUEVA_SOLICITUD_AUTORIZACION":if(t.solicitud.idSupervisor!==i){console.log("[AUTORIZACION] Ignorando solicitud - no es para este supervisor. Destinatario:",t.solicitud.idSupervisor,"Yo:",i);return}console.log("[AUTORIZACION] Nueva solicitud recibida para M\xCD!"),this.solicitudesPendientes.update(n=>[t.solicitud,...n]),this.nuevaSolicitudSubject.next(t.solicitud);break;case"SOLICITUD_APROBADA":if(t.solicitud.idAgenteSolicitante!==i){console.log("[AUTORIZACION] \u23ED\uFE0F Ignorando APROBADA - no es mi solicitud. Agente:",t.solicitud.idAgenteSolicitante,"Yo:",i);return}console.log("[AUTORIZACION] \u2705 \xA1MI Solicitud fue APROBADA!"),this.solicitudActual.set(t.solicitud),this.respuestaSubject.next(t.solicitud);break;case"SOLICITUD_RECHAZADA":if(t.solicitud.idAgenteSolicitante!==i){console.log("[AUTORIZACION] \u23ED\uFE0F Ignorando RECHAZADA - no es mi solicitud. Agente:",t.solicitud.idAgenteSolicitante,"Yo:",i);return}console.log("[AUTORIZACION] \u274C \xA1MI Solicitud fue RECHAZADA!"),this.solicitudActual.set(t.solicitud),this.respuestaSubject.next(t.solicitud);break;case"SOLICITUD_CANCELADA":console.log("[AUTORIZACION] Solicitud cancelada por agente"),this.solicitudesPendientes.update(n=>n.filter(h=>h.uuid!==t.solicitud.uuid));break;case"SOLICITUD_EXPIRADA":console.log("[AUTORIZACION] Solicitud expirada!"),this.solicitudActual.set(t.solicitud),this.respuestaSubject.next(t.solicitud);break}}limpiarEstado(){this.solicitudActual.set(null),this.supervisoresEnLinea.set([])}};o.\u0275fac=function(t){return new(t||o)(a(A),a(I))},o.\u0275prov=u({token:o,factory:o.\u0275fac,providedIn:"root"});let c=o;return c})();export{R as a};
