import{a as It}from"./chunk-DAV5OGMA.js";import{a as qe,b as We}from"./chunk-53QRFOI5.js";import{a as Tt}from"./chunk-RJ3LZGQL.js";import{a as Dt,b as Ye,c as Ot}from"./chunk-KQKTT3H5.js";import{a as Et}from"./chunk-VAWVBMXP.js";import{h as wt,i as Ke,j as At}from"./chunk-PTH757MW.js";import{a as Mt}from"./chunk-X7TXYONE.js";import{a as Ee,b as ke}from"./chunk-AJBORTLB.js";import{c as Me,d as De,e as kt,g as je,h as Ge,i as we}from"./chunk-2EGRPCBM.js";import{a as St}from"./chunk-F4GA36JM.js";import{a as Pe}from"./chunk-F4ESQKJH.js";import"./chunk-YGBOLD45.js";import"./chunk-3LIO6ZWK.js";import{a as oe,b as yt}from"./chunk-HLYMKODC.js";import"./chunk-AU2CGYC7.js";import{A as ye,m as vt,x as He,z as Se}from"./chunk-RR4IVBHX.js";import"./chunk-L3MXZBR5.js";import{a as gt}from"./chunk-OH2DSCAS.js";import{a as Pt}from"./chunk-C66AAOCQ.js";import{a as ct,c as mt}from"./chunk-JKE5BK6V.js";import"./chunk-WPZY277X.js";import{E as $e,c as ft,f as ze,k as Be,m as bt,s as ht,t as xt,u as _t,x as Ct}from"./chunk-2YC26MZ7.js";import{pc as ut,qc as pt}from"./chunk-YLTLMO6P.js";import{a as X}from"./chunk-YQKVMPSG.js";import{a as dt,c as ie}from"./chunk-LYMJIISJ.js";import{Ba as ot,Bc as H,Fb as g,Gb as f,Gc as z,Hb as rt,Hc as lt,I as he,Jb as W,Kb as Y,Lb as v,Mb as r,Nb as o,Ob as N,Vb as B,Xb as C,Ya as Oe,Zb as u,a as K,b as ge,bb as s,bc as Re,ca as te,cc as Ve,cd as st,da as it,dc as Le,ga as ue,ha as Fe,hb as R,hc as Ue,ic as Ae,jc as xe,kc as P,lc as l,ld as le,mc as E,md as ne,na as S,nc as b,oa as y,ob as Z,oc as re,pb as at,qc as _e,r as be,rc as Ce,sc as ve,xa as x,zc as $}from"./chunk-BMTIWWAP.js";var Ie=(()=>{let c=class c{constructor(e){this.http=e,this.baseUrl=`${X.tipificacionUrl}/payment-schedules`}createPaymentSchedule(e){return this.http.post(`${X.tipificacionUrl}/payments/schedules`,e)}getPaymentScheduleByManagementId(e){return this.http.get(`${this.baseUrl}/management/${e}`)}updateInstallmentStatus(e,t){return this.http.post(`${this.baseUrl}/installments/${e}/status`,t)}getInstallmentHistory(e){return this.http.get(`${this.baseUrl}/installments/${e}/history`)}getLatestStatusByManagement(e){return this.http.get(`${this.baseUrl}/management/${e}/latest-status`)}getActiveSchedulesByCustomer(e){return this.http.get(`${X.gatewayUrl}/v2/management-records/payment-schedule/client/${e}`)}};c.\u0275fac=function(t){return new(t||c)(ue(ie))},c.\u0275prov=te({token:c,factory:c.\u0275fac,providedIn:"root"});let a=c;return a})();function Yt(a,c){if(a&1){let n=B();r(0,"div",17)(1,"div")(2,"label",13),l(3," Fecha de Pago * "),o(),r(4,"input",23),ve("ngModelChange",function(t){S(n);let i=u(2);return Ce(i.paymentDate,t)||(i.paymentDate=t),y(t)}),o()(),r(5,"div")(6,"label",13),l(7," Monto Pagado * "),o(),r(8,"div",24)(9,"span",25),l(10,"S/"),o(),r(11,"input",26),ve("ngModelChange",function(t){S(n);let i=u(2);return Ce(i.amountPaid,t)||(i.amountPaid=t),y(t)}),o()()()()}if(a&2){let n=u(2);s(4),_e("ngModel",n.paymentDate),s(7),_e("ngModel",n.amountPaid)}}function Xt(a,c){if(a&1&&(r(0,"div",19)(1,"span",27),l(2),o()()),a&2){let n=u(2);s(2),E(n.errorMessage())}}function Qt(a,c){a&1&&(r(0,"span"),l(1,"Guardando..."),o())}function Kt(a,c){a&1&&(r(0,"span"),l(1,"Guardar"),o())}function Jt(a,c){if(a&1){let n=B();r(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"div")(5,"h2",4),l(6,"Actualizar Estado de Cuota"),o(),r(7,"p",5),l(8),o()()(),r(9,"button",6),C("click",function(){S(n);let t=u();return y(t.close())}),o()(),r(10,"div",7)(11,"div",8)(12,"div",9)(13,"div")(14,"span",10),l(15,"Monto:"),o(),r(16,"span",11),l(17),$(18,"number"),o()(),r(19,"div")(20,"span",10),l(21,"Fecha Vencimiento:"),o(),r(22,"span",11),l(23),o()(),r(24,"div")(25,"span",10),l(26,"Estado Actual:"),o(),r(27,"span",12),l(28),o()()()(),r(29,"div")(30,"label",13),l(31," Nuevo Estado "),o(),r(32,"div",14)(33,"button",15),C("click",function(){S(n);let t=u();return y(t.selectedStatus.set("COMPLETADO"))}),r(34,"span",16),l(35,"Completado"),o()(),r(36,"button",15),C("click",function(){S(n);let t=u();return y(t.selectedStatus.set("VENCIDO"))}),r(37,"span",16),l(38,"Vencido"),o()(),r(39,"button",15),C("click",function(){S(n);let t=u();return y(t.selectedStatus.set("CANCELADO"))}),r(40,"span",16),l(41,"Cancelado"),o()()()(),g(42,Yt,12,2,"div",17),r(43,"div")(44,"label",13),l(45," Observaciones "),o(),r(46,"textarea",18),ve("ngModelChange",function(t){S(n);let i=u();return Ce(i.observations,t)||(i.observations=t),y(t)}),o()(),g(47,Xt,3,1,"div",19),o(),r(48,"div",20)(49,"button",21),C("click",function(){S(n);let t=u();return y(t.close())}),l(50," Cancelar "),o(),r(51,"button",22),C("click",function(){S(n);let t=u();return y(t.save())}),g(52,Qt,2,0,"span")(53,Kt,2,0,"span"),o()()()()}if(a&2){let n,e,t,i,d,m=u();s(8),b("Cuota #",(n=m.installment())==null?null:n.installmentNumber),s(9),b(" S/ ",H(18,17,(e=m.installment())==null?null:e.amount,"1.2-2")," "),s(6),b(" ",m.formatDate((t=m.installment())==null?null:t.dueDate)," "),s(4),P(m.getStatusBadgeClass(((i=m.installment())==null?null:i.status)||"PENDIENTE")),s(),b(" ",((d=m.installment())==null?null:d.statusDescription)||"Pendiente"," "),s(5),P(m.selectedStatus()==="COMPLETADO"?"bg-green-100 dark:bg-green-900/30 border-green-500 dark:border-green-600 text-green-900 dark:text-green-300":"bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 hover:border-green-400"),s(3),P(m.selectedStatus()==="VENCIDO"?"bg-red-100 dark:bg-red-900/30 border-red-500 dark:border-red-600 text-red-900 dark:text-red-300":"bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 hover:border-red-400"),s(3),P(m.selectedStatus()==="CANCELADO"?"bg-gray-100 dark:bg-gray-700/30 border-gray-500 dark:border-gray-600 text-gray-900 dark:text-gray-300":"bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 hover:border-gray-400"),s(3),f(m.selectedStatus()==="COMPLETADO"?42:-1),s(4),_e("ngModel",m.observations),s(),f(m.errorMessage()?47:-1),s(4),v("disabled",!m.canSave()||m.isSaving()),s(),f(m.isSaving()?52:53)}}var Nt=(()=>{let c=class c{constructor(e){this.paymentScheduleService=e,this.isOpen=x(!1),this.installment=x(null),this.managementId=x(0),this.selectedStatus=x(null),this.paymentDate="",this.amountPaid=null,this.observations="",this.isSaving=x(!1),this.errorMessage=x(null),this.canSave=z(()=>this.selectedStatus()?this.selectedStatus()==="COMPLETADO"?!!this.paymentDate&&this.amountPaid!==null&&this.amountPaid>0:!0:!1),lt(()=>{this.isOpen()||this.resetForm()})}open(e,t){this.installment.set(e),this.managementId.set(t),this.isOpen.set(!0),this.amountPaid=e.amount;let i=new Date,d=i.getFullYear(),m=String(i.getMonth()+1).padStart(2,"0"),p=String(i.getDate()).padStart(2,"0"),h=String(i.getHours()).padStart(2,"0"),_=String(i.getMinutes()).padStart(2,"0");this.paymentDate=`${d}-${m}-${p}T${h}:${_}`}close(){this.isOpen.set(!1)}resetForm(){this.selectedStatus.set(null),this.paymentDate="",this.amountPaid=null,this.observations="",this.errorMessage.set(null),this.installment.set(null),this.managementId.set(0)}save(){let e=this.installment();if(!e||!this.canSave())return;this.isSaving.set(!0),this.errorMessage.set(null);let t={status:this.selectedStatus(),observations:this.observations||void 0,registeredBy:"USUARIO"};this.selectedStatus()==="COMPLETADO"&&(t.paymentDate=this.paymentDate,t.amountPaid=this.amountPaid),this.paymentScheduleService.updateInstallmentStatus(e.id,t).subscribe({next:()=>{console.log("\u2705 Estado de cuota actualizado exitosamente"),this.isSaving.set(!1),this.close(),this.onSave&&this.onSave(!0)},error:i=>{console.error("\u274C Error actualizando estado de cuota:",i),this.errorMessage.set("Error al actualizar el estado. Intente nuevamente."),this.isSaving.set(!1),this.onSave&&this.onSave(!1)}})}formatDate(e){return e?new Date(e).toLocaleDateString("es-PE",{day:"2-digit",month:"2-digit",year:"numeric"}):"-"}getStatusBadgeClass(e){switch(e.toUpperCase()){case"COMPLETED":case"COMPLETADO":return"bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300 border border-green-300 dark:border-green-700";case"PENDING":case"PENDIENTE":return"bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300 border border-yellow-300 dark:border-yellow-700";case"OVERDUE":case"VENCIDO":return"bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300 border border-red-300 dark:border-red-700";case"CANCELLED":case"CANCELADO":return"bg-gray-100 dark:bg-gray-700/30 text-gray-800 dark:text-gray-300 border border-gray-300 dark:border-gray-600";default:return"bg-slate-100 dark:bg-slate-700 text-slate-800 dark:text-slate-300"}}};c.\u0275fac=function(t){return new(t||c)(R(Ie))},c.\u0275cmp=Z({type:c,selectors:[["app-installment-status-dialog"]],decls:1,vars:1,consts:[[1,"fixed","inset-0","z-50","flex","items-center","justify-center","p-4","bg-black/50","backdrop-blur-sm","animate-fadeIn"],[1,"bg-white","dark:bg-slate-900","rounded-xl","shadow-2xl","max-w-2xl","w-full","max-h-[90vh]","overflow-hidden","flex","flex-col","animate-slideInUp","border","border-slate-200","dark:border-slate-700"],[1,"bg-gradient-to-r","from-purple-600","to-purple-700","dark:from-purple-700","dark:to-purple-800","text-white","px-6","py-4","flex","items-center","justify-between"],[1,"flex","items-center","gap-3"],[1,"text-lg","font-bold"],[1,"text-sm","opacity-90"],["type","button",1,"p-2","hover:bg-white/20","rounded-lg","transition-colors",3,"click"],[1,"flex-1","overflow-y-auto","p-6","space-y-6"],[1,"bg-purple-50","dark:bg-purple-950/30","border","border-purple-200","dark:border-purple-800","rounded-lg","p-4"],[1,"grid","grid-cols-2","gap-4","text-sm"],[1,"text-slate-600","dark:text-slate-400"],[1,"font-bold","text-purple-900","dark:text-purple-200","ml-2"],[1,"ml-2","px-2","py-0.5","rounded","text-xs","font-bold"],[1,"block","text-sm","font-semibold","text-slate-700","dark:text-slate-300","mb-2"],[1,"grid","grid-cols-3","gap-3"],["type","button",1,"border-2","rounded-lg","p-4","flex","flex-col","items-center","gap-2","transition-all",3,"click"],[1,"text-sm","font-bold"],[1,"space-y-4","p-4","bg-green-50","dark:bg-green-950/20","border","border-green-200","dark:border-green-800","rounded-lg"],["rows","3","placeholder","Ingrese notas o comentarios adicionales...",1,"w-full","px-3","py-2","text-sm","border","border-slate-300","dark:border-slate-600","rounded-lg","bg-white","dark:bg-slate-800","text-slate-900","dark:text-slate-100","focus:ring-2","focus:ring-purple-500","dark:focus:ring-purple-600","focus:border-transparent","placeholder:text-slate-400","dark:placeholder:text-slate-500",3,"ngModelChange","ngModel"],[1,"bg-red-50","dark:bg-red-950/30","border","border-red-200","dark:border-red-800","text-red-900","dark:text-red-300","px-4","py-3","rounded-lg","flex","items-start","gap-2"],[1,"px-6","py-4","bg-slate-50","dark:bg-slate-800/50","border-t","border-slate-200","dark:border-slate-700","flex","justify-end","gap-3"],["type","button",1,"px-4","py-2","text-sm","font-semibold","text-slate-700","dark:text-slate-300","hover:bg-slate-200","dark:hover:bg-slate-700","rounded-lg","transition-colors",3,"click"],["type","button",1,"px-4","py-2","text-sm","font-semibold","text-white","bg-gradient-to-r","from-purple-600","to-purple-700","hover:from-purple-700","hover:to-purple-800","rounded-lg","transition-all","disabled:opacity-50","disabled:cursor-not-allowed","disabled:hover:from-purple-600","flex","items-center","gap-2",3,"click","disabled"],["type","datetime-local","required","",1,"w-full","px-3","py-2","text-sm","border","border-slate-300","dark:border-slate-600","rounded-lg","bg-white","dark:bg-slate-800","text-slate-900","dark:text-slate-100","focus:ring-2","focus:ring-green-500","dark:focus:ring-green-600","focus:border-transparent",3,"ngModelChange","ngModel"],[1,"relative"],[1,"absolute","left-3","top-2","text-slate-500","dark:text-slate-400"],["type","number","step","0.01","required","",1,"w-full","pl-10","pr-3","py-2","text-sm","border","border-slate-300","dark:border-slate-600","rounded-lg","bg-white","dark:bg-slate-800","text-slate-900","dark:text-slate-100","focus:ring-2","focus:ring-green-500","dark:focus:ring-green-600","focus:border-transparent",3,"ngModelChange","ngModel"],[1,"text-sm"]],template:function(t,i){t&1&&g(0,Jt,54,20,"div",0),t&2&&f(i.isOpen()?0:-1)},dependencies:[ne,$e,ft,bt,ze,Ct,Be,le],styles:["@keyframes _ngcontent-%COMP%_fadeIn{0%{opacity:0}to{opacity:1}}@keyframes _ngcontent-%COMP%_slideInUp{0%{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.animate-fadeIn[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_fadeIn .2s ease-out}.animate-slideInUp[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_slideInUp .3s ease-out}"]});let a=c;return a})();var Zt=["statusDialog"],Ft=(a,c)=>c.id;function en(a,c){a&1&&(r(0,"div",9)(1,"div",10)(2,"span"),l(3,"Cargando estados..."),o()()())}function tn(a,c){if(a&1&&(r(0,"div",31),l(1),o()),a&2){let n=u().$implicit,e=u(2);s(),b(" ",e.formatDateTime(n.latestStatus.actualPaymentDate)," ")}}function nn(a,c){a&1&&(r(0,"div",36),l(1,"-"),o())}function on(a,c){a&1&&(r(0,"div",43)(1,"span"),l(2,"Cargando historial..."),o()())}function an(a,c){if(a&1&&(r(0,"span",48),l(1),$(2,"number"),o()),a&2){let n=u().$implicit;s(),b(" S/ ",H(2,1,n.amountPaid,"1.2-2")," ")}}function rn(a,c){if(a&1&&(r(0,"div",49),l(1),o()),a&2){let n=u().$implicit;s(),b(" ",n.observations," ")}}function ln(a,c){if(a&1&&(r(0,"div",44)(1,"div",45),l(2),o(),r(3,"div",46)(4,"span",47),l(5),o(),g(6,an,3,4,"span",48),g(7,rn,2,1,"div",49),o(),r(8,"div",50),l(9),o()()),a&2){let n=c.$implicit,e=u(5);s(2),b(" ",e.formatDateTime(n.changeDate)," "),s(2),P(e.getStatusBadgeClass(n.status)),s(),b(" ",n.statusDescription," "),s(),f(n.amountPaid?6:-1),s(),f(n.observations?7:-1),s(2),b(" ",n.registeredBy," ")}}function sn(a,c){if(a&1&&(r(0,"div",41),W(1,ln,10,7,"div",44,Ft),o()),a&2){let n=u(4);s(),Y(n.installmentHistory())}}function dn(a,c){if(a&1&&(r(0,"tr")(1,"td",40)(2,"div",41)(3,"div",42)(4,"span"),l(5,"Historial de Estados"),o()(),g(6,on,3,0,"div",43)(7,sn,3,0,"div",41),o()()()),a&2){let n=u(3);s(6),f(n.isLoadingHistory()?6:n.installmentHistory()&&n.installmentHistory().length>0?7:-1)}}function cn(a,c){if(a&1){let n=B();r(0,"tr",26)(1,"td",27)(2,"div",28)(3,"div",29)(4,"span",30),l(5),o()()()(),r(6,"td",27)(7,"div",31),l(8),o()(),r(9,"td",32)(10,"div",33),l(11),$(12,"number"),o()(),r(13,"td",27)(14,"div",34)(15,"span",35),l(16),o()()(),r(17,"td",27),g(18,tn,2,1,"div",31)(19,nn,2,0,"div",36),o(),r(20,"td",27)(21,"div",37)(22,"button",38),C("click",function(){let t=S(n).$implicit,i=u(2);return y(i.openStatusDialog(t))}),o(),r(23,"button",39),C("click",function(){let t=S(n).$implicit,i=u(2);return y(i.toggleHistory(t.id))}),o()()()(),g(24,dn,8,1,"tr")}if(a&2){let n=c.$implicit,e=u(2);s(5),b(" ",n.installmentNumber," "),s(3),b(" ",e.formatDate(n.dueDate)," "),s(3),b(" S/ ",H(12,10,n.amount,"1.2-2")," "),s(4),P(e.getStatusBadgeClass((n.latestStatus==null?null:n.latestStatus.status)||"PENDIENTE")),s(),b(" ",(n.latestStatus==null?null:n.latestStatus.statusDescription)||"Pendiente"," "),s(2),f(n.latestStatus!=null&&n.latestStatus.actualPaymentDate?18:19),s(5),P(e.expandedHistory()===n.id?"bg-slate-200 dark:bg-slate-700":"hover:bg-slate-100 dark:hover:bg-slate-800"),s(),f(e.expandedHistory()===n.id&&e.installmentHistory()?24:-1)}}function mn(a,c){if(a&1&&(r(0,"div",11)(1,"table",12)(2,"thead",13)(3,"tr")(4,"th",14),l(5,"#"),o(),r(6,"th",14),l(7,"Fecha Vencimiento"),o(),r(8,"th",15),l(9,"Monto"),o(),r(10,"th",16),l(11,"Estado"),o(),r(12,"th",14),l(13,"Fecha Pago"),o(),r(14,"th",16),l(15,"Acciones"),o()()(),r(16,"tbody",17),W(17,cn,25,13,null,null,Ft),o()()(),r(19,"div",18)(20,"div",19)(21,"div",20)(22,"div",21),l(23,"Completadas"),o(),r(24,"div",22),l(25),o()(),r(26,"div",20)(27,"div",21),l(28,"Pendientes"),o(),r(29,"div",23),l(30),o()(),r(31,"div",20)(32,"div",21),l(33,"Vencidas"),o(),r(34,"div",24),l(35),o()(),r(36,"div",20)(37,"div",21),l(38,"Canceladas"),o(),r(39,"div",25),l(40),o()()()()),a&2){let n=u();s(17),Y(n.installmentsWithStatus()),s(8),b(" ",n.summaryStats().completed," "),s(5),b(" ",n.summaryStats().pending," "),s(5),b(" ",n.summaryStats().overdue," "),s(5),b(" ",n.summaryStats().cancelled," ")}}var Rt=(()=>{let c=class c{constructor(e){this.paymentScheduleService=e,this.managementId=0,this.schedule=x(null),this.latestStatuses=x([]),this.isLoading=x(!1),this.expandedHistory=x(null),this.installmentHistory=x(null),this.isLoadingHistory=x(!1),this.installmentsWithStatus=z(()=>{let t=this.schedule(),i=this.latestStatuses();return t?t.installments.map(d=>{let m=i.find(p=>p.installmentId===d.id);return ge(K({},d),{latestStatus:m})}):[]}),this.summaryStats=z(()=>{let t=this.installmentsWithStatus();return{completed:t.filter(i=>["COMPLETED","COMPLETADO"].includes(i.latestStatus?.status||"")).length,pending:t.filter(i=>["PENDING","PENDIENTE"].includes(i.latestStatus?.status||"")).length,overdue:t.filter(i=>["OVERDUE","VENCIDO"].includes(i.latestStatus?.status||"")).length,cancelled:t.filter(i=>["CANCELLED","CANCELADO"].includes(i.latestStatus?.status||"")).length}})}ngOnChanges(e){e.managementId&&this.managementId&&this.loadSchedule()}loadSchedule(){this.isLoading.set(!0),this.paymentScheduleService.getPaymentScheduleByManagementId(this.managementId).subscribe({next:e=>{console.log("\u{1F4CA} Cronograma cargado:",e),this.schedule.set(e),this.loadLatestStatuses()},error:e=>{console.error("\u274C Error cargando cronograma:",e),this.isLoading.set(!1)}})}loadLatestStatuses(){this.paymentScheduleService.getLatestStatusByManagement(this.managementId).subscribe({next:e=>{console.log("\u{1F4CB} Estados m\xE1s recientes cargados:",e),this.latestStatuses.set(e),this.isLoading.set(!1)},error:e=>{console.error("\u274C Error cargando estados:",e),this.isLoading.set(!1)}})}openStatusDialog(e){this.statusDialog.open(e,this.managementId),this.statusDialog.onSave=t=>{t&&(this.loadLatestStatuses(),this.expandedHistory()===e.id&&this.loadInstallmentHistory(e.id))}}toggleHistory(e){this.expandedHistory()===e?(this.expandedHistory.set(null),this.installmentHistory.set(null)):(this.expandedHistory.set(e),this.loadInstallmentHistory(e))}loadInstallmentHistory(e){this.isLoadingHistory.set(!0),this.paymentScheduleService.getInstallmentHistory(e).subscribe({next:t=>{console.log("\u{1F4DC} Historial de cuota cargado:",t),this.installmentHistory.set(t),this.isLoadingHistory.set(!1)},error:t=>{console.error("\u274C Error cargando historial:",t),this.isLoadingHistory.set(!1)}})}formatDate(e){return new Date(e).toLocaleDateString("es-PE",{day:"2-digit",month:"2-digit",year:"numeric"})}formatDateTime(e){return new Date(e).toLocaleString("es-PE",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}getStatusBadgeClass(e){switch(e.toUpperCase()){case"COMPLETED":case"COMPLETADO":return"bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300 border border-green-300 dark:border-green-700";case"PENDING":case"PENDIENTE":return"bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300 border border-yellow-300 dark:border-yellow-700";case"OVERDUE":case"VENCIDO":return"bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300 border border-red-300 dark:border-red-700";case"CANCELLED":case"CANCELADO":return"bg-gray-100 dark:bg-gray-700/30 text-gray-800 dark:text-gray-300 border border-gray-300 dark:border-gray-600";default:return"bg-slate-100 dark:bg-slate-700 text-slate-800 dark:text-slate-300"}}};c.\u0275fac=function(t){return new(t||c)(R(Ie))},c.\u0275cmp=Z({type:c,selectors:[["app-payment-schedule-view"]],viewQuery:function(t,i){if(t&1&&Re(Zt,5),t&2){let d;Ve(d=Le())&&(i.statusDialog=d.first)}},inputs:{managementId:"managementId"},features:[ot],decls:19,vars:7,consts:[["statusDialog",""],[1,"bg-white","dark:bg-slate-900","rounded-xl","shadow-lg","border","border-slate-200","dark:border-slate-700","overflow-hidden"],[1,"bg-gradient-to-r","from-purple-600","to-purple-700","dark:from-purple-700","dark:to-purple-800","text-white","px-6","py-4"],[1,"flex","items-center","justify-between"],[1,"flex","items-center","gap-3"],[1,"text-lg","font-bold"],[1,"text-sm","opacity-90"],[1,"text-right"],[1,"text-2xl","font-bold"],[1,"p-8","flex","items-center","justify-center"],[1,"flex","items-center","gap-3","text-slate-600","dark:text-slate-400"],[1,"overflow-x-auto"],[1,"w-full"],[1,"bg-slate-50","dark:bg-slate-800/50","border-b","border-slate-200","dark:border-slate-700"],[1,"px-4","py-3","text-left","text-xs","font-bold","text-slate-700","dark:text-slate-300","uppercase","tracking-wider"],[1,"px-4","py-3","text-right","text-xs","font-bold","text-slate-700","dark:text-slate-300","uppercase","tracking-wider"],[1,"px-4","py-3","text-center","text-xs","font-bold","text-slate-700","dark:text-slate-300","uppercase","tracking-wider"],[1,"divide-y","divide-slate-200","dark:divide-slate-700"],[1,"px-6","py-4","bg-slate-50","dark:bg-slate-800/50","border-t","border-slate-200","dark:border-slate-700"],[1,"grid","grid-cols-4","gap-4","text-sm"],[1,"text-center"],[1,"text-slate-600","dark:text-slate-400","mb-1"],[1,"text-2xl","font-bold","text-green-600","dark:text-green-400"],[1,"text-2xl","font-bold","text-yellow-600","dark:text-yellow-400"],[1,"text-2xl","font-bold","text-red-600","dark:text-red-400"],[1,"text-2xl","font-bold","text-gray-600","dark:text-gray-400"],[1,"hover:bg-slate-50","dark:hover:bg-slate-800/50","transition-colors"],[1,"px-4","py-3"],[1,"flex","items-center","gap-2"],[1,"w-8","h-8","rounded-full","bg-purple-100","dark:bg-purple-900/30","flex","items-center","justify-center"],[1,"text-xs","font-bold","text-purple-700","dark:text-purple-300"],[1,"text-sm","text-slate-900","dark:text-slate-100"],[1,"px-4","py-3","text-right"],[1,"text-sm","font-bold","text-slate-900","dark:text-slate-100"],[1,"flex","justify-center"],[1,"px-2","py-1","rounded","text-xs","font-bold"],[1,"text-sm","text-slate-400","dark:text-slate-500"],[1,"flex","items-center","justify-center","gap-2"],["type","button","title","Actualizar estado",1,"p-1.5","hover:bg-purple-100","dark:hover:bg-purple-900/30","rounded","transition-colors",3,"click"],["type","button","title","Ver historial",1,"p-1.5","rounded","transition-colors",3,"click"],["colspan","6",1,"px-4","py-3","bg-slate-50","dark:bg-slate-800/50"],[1,"space-y-2"],[1,"flex","items-center","gap-2","text-sm","font-bold","text-slate-700","dark:text-slate-300","mb-2"],[1,"flex","items-center","gap-2","text-sm","text-slate-600","dark:text-slate-400","py-2"],[1,"flex","items-start","gap-3","text-xs","p-2","bg-white","dark:bg-slate-900","rounded","border","border-slate-200","dark:border-slate-700"],[1,"flex-shrink-0","w-24","text-slate-600","dark:text-slate-400"],[1,"flex-1"],[1,"px-2","py-0.5","rounded","font-bold"],[1,"ml-2","text-slate-700","dark:text-slate-300"],[1,"mt-1","text-slate-600","dark:text-slate-400"],[1,"flex-shrink-0","text-slate-500","dark:text-slate-500"]],template:function(t,i){if(t&1&&(r(0,"div",1)(1,"div",2)(2,"div",3)(3,"div",4)(4,"div")(5,"h3",5),l(6,"Cronograma de Pagos"),o(),r(7,"p",6),l(8),o()()(),r(9,"div",7)(10,"div",6),l(11,"Monto Total"),o(),r(12,"div",8),l(13),$(14,"number"),o()()()(),g(15,en,4,0,"div",9),g(16,mn,41,4),o(),N(17,"app-installment-status-dialog",null,0)),t&2){let d;s(8),b("",i.installmentsWithStatus().length," cuotas programadas"),s(5),b("S/ ",H(14,4,(d=i.schedule())==null?null:d.totalAmount,"1.2-2")),s(2),f(i.isLoading()?15:-1),s(),f(!i.isLoading()&&i.installmentsWithStatus().length>0?16:-1)}},dependencies:[ne,Nt,le],encapsulation:2});let a=c;return a})();var Vt=(()=>{class a{static \u0275fac=function(e){return new(e||a)};static \u0275mod=at({type:a});static \u0275inj=it({imports:[vt]})}return a})();var Te=(()=>{let c=class c{constructor(){this.http=Fe(ie),this.baseUrl=`${X.apiUrl}/v2/comprobantes`}uploadComprobante(e,t){let i=new FormData;return i.append("file",e),i.append("idCuota",t.idCuota.toString()),i.append("idAgente",t.idAgente.toString()),t.montoEsperado!==void 0&&i.append("montoEsperado",t.montoEsperado.toString()),t.documentoEsperado&&i.append("documentoEsperado",t.documentoEsperado),t.nombreEsperado&&i.append("nombreEsperado",t.nombreEsperado),t.idGestion!==void 0&&i.append("idGestion",t.idGestion.toString()),t.descripcion&&i.append("descripcion",t.descripcion),t.validarConOcr!==void 0&&i.append("validarConOcr",t.validarConOcr.toString()),this.http.post(`${this.baseUrl}/upload`,i)}getComprobantesByCuota(e){return this.http.get(`${this.baseUrl}/cuota/${e}`)}asociarAGestion(e,t){return this.http.post(`${this.baseUrl}/${e}/asociar-gestion/${t}`,{})}};c.\u0275fac=function(t){return new(t||c)},c.\u0275prov=te({token:c,factory:c.\u0275fac,providedIn:"root"});let a=c;return a})();function pn(a,c){if(a&1){let n=B();r(0,"div",23),C("click",function(){S(n);let t=Ue(13);return y(t.click())})("dragover",function(t){S(n);let i=u();return y(i.onDragOver(t))})("drop",function(t){S(n);let i=u();return y(i.onDrop(t))}),r(1,"div",24)(2,"mat-icon",25),l(3,"cloud_upload"),o()(),r(4,"p",26),l(5,"Arrastra una imagen aqu\xED"),o(),r(6,"p",27),l(7," o "),r(8,"span",28),l(9,"haz clic para seleccionar"),o()(),r(10,"p",29),l(11,"JPG, PNG, WebP - M\xE1ximo 5MB"),o()(),r(12,"input",30,0),C("change",function(t){S(n);let i=u();return y(i.onFileSelected(t))}),o()}}function gn(a,c){if(a&1){let n=B();r(0,"div",15),N(1,"img",31),r(2,"button",32),C("click",function(){S(n);let t=u();return y(t.removeFile())}),r(3,"mat-icon",33),l(4,"close"),o()(),r(5,"div",34)(6,"p",35)(7,"mat-icon",36),l(8,"insert_drive_file"),o(),r(9,"span",37),l(10),o(),r(11,"span",38),l(12,"-"),o(),r(13,"span",39),l(14),o()()()()}if(a&2){let n,e,t=u();s(),v("src",t.previewUrl(),Oe),s(9),E((n=t.selectedFile())==null?null:n.name),s(4),E(t.formatFileSize(((e=t.selectedFile())==null?null:e.size)||0))}}function fn(a,c){a&1&&(r(0,"div",16)(1,"div",40),N(2,"div",41)(3,"mat-spinner",42),r(4,"div",43)(5,"mat-icon",44),l(6,"document_scanner"),o()()(),r(7,"p",45),l(8,"Analizando con IA..."),o(),r(9,"div",46),N(10,"span",47)(11,"span",48)(12,"span",49),o()())}function bn(a,c){if(a&1&&(r(0,"mat-icon",79),l(1),o()),a&2){let n,e,t=u(3);P(!((n=t.uploadResponse())==null||n.validacionMonto==null)&&n.validacionMonto.coincide?"text-green-500":"text-amber-500"),s(),b(" ",!((e=t.uploadResponse())==null||e.validacionMonto==null)&&e.validacionMonto.coincide?"check_circle":"warning"," ")}}function hn(a,c){if(a&1&&(r(0,"p",80)(1,"mat-icon",81),l(2),o(),l(3),o()),a&2){let n,e,t,i=u(3);P(!((n=i.uploadResponse())==null||n.validacionMonto==null)&&n.validacionMonto.coincide?"text-green-600 dark:text-green-400":"text-amber-600 dark:text-amber-400"),s(2),E(!((e=i.uploadResponse())==null||e.validacionMonto==null)&&e.validacionMonto.coincide?"check":"priority_high"),s(),b(" ",!((t=i.uploadResponse())==null||t.validacionMonto==null)&&t.validacionMonto.coincide?"OK":"No coincide"," ")}}function xn(a,c){if(a&1&&(r(0,"mat-icon",79),l(1),o()),a&2){let n,e,t=u(3);P(!((n=t.uploadResponse())==null||n.validacionDocumento==null)&&n.validacionDocumento.coincide?"text-green-500":"text-amber-500"),s(),b(" ",!((e=t.uploadResponse())==null||e.validacionDocumento==null)&&e.validacionDocumento.coincide?"check_circle":"warning"," ")}}function _n(a,c){if(a&1&&(r(0,"p",80)(1,"mat-icon",81),l(2),o(),l(3),o()),a&2){let n,e,t,i=u(3);P(!((n=i.uploadResponse())==null||n.validacionDocumento==null)&&n.validacionDocumento.coincide?"text-green-600 dark:text-green-400":"text-amber-600 dark:text-amber-400"),s(2),E(!((e=i.uploadResponse())==null||e.validacionDocumento==null)&&e.validacionDocumento.coincide?"check":"priority_high"),s(),b(" ",!((t=i.uploadResponse())==null||t.validacionDocumento==null)&&t.validacionDocumento.coincide?"OK":"No coincide"," ")}}function Cn(a,c){if(a&1&&(r(0,"mat-icon",79),l(1),o()),a&2){let n,e,t=u(3);P(!((n=t.uploadResponse())==null||n.validacionNombre==null)&&n.validacionNombre.coincide?"text-green-500":"text-amber-500"),s(),b(" ",!((e=t.uploadResponse())==null||e.validacionNombre==null)&&e.validacionNombre.coincide?"check_circle":"warning"," ")}}function vn(a,c){if(a&1&&(r(0,"p",80)(1,"mat-icon",81),l(2),o(),l(3),o()),a&2){let n,e,t,i=u(3);P(!((n=i.uploadResponse())==null||n.validacionNombre==null)&&n.validacionNombre.coincide?"text-green-600 dark:text-green-400":"text-amber-600 dark:text-amber-400"),s(2),E(!((e=i.uploadResponse())==null||e.validacionNombre==null)&&e.validacionNombre.coincide?"check":"priority_high"),s(),b(" ",!((t=i.uploadResponse())==null||t.validacionNombre==null)&&t.validacionNombre.coincide?"OK":"No coincide"," ")}}function Sn(a,c){if(a&1&&(r(0,"div",83)(1,"mat-icon",84),l(2,"account_balance"),o(),r(3,"span",85),l(4),o()()),a&2){let n,e=u(4);s(4),E((n=e.uploadResponse())==null||n.ocrResult==null?null:n.ocrResult.banco)}}function yn(a,c){if(a&1&&(r(0,"div",83)(1,"mat-icon",84),l(2,"tag"),o(),r(3,"span",85),l(4),o()()),a&2){let n,e=u(4);s(4),E((n=e.uploadResponse())==null||n.ocrResult==null?null:n.ocrResult.numeroOperacion)}}function Pn(a,c){if(a&1&&(r(0,"div",83)(1,"mat-icon",84),l(2,"event"),o(),r(3,"span",85),l(4),o()()),a&2){let n,e=u(4);s(4),E((n=e.uploadResponse())==null||n.ocrResult==null?null:n.ocrResult.fecha)}}function En(a,c){if(a&1&&(r(0,"div",78)(1,"div",82),g(2,Sn,5,1,"div",83),g(3,yn,5,1,"div",83),g(4,Pn,5,1,"div",83),o()()),a&2){let n,e,t,i=u(3);s(2),f(!((n=i.uploadResponse())==null||n.ocrResult==null)&&n.ocrResult.banco?2:-1),s(),f(!((e=i.uploadResponse())==null||e.ocrResult==null)&&e.ocrResult.numeroOperacion?3:-1),s(),f(!((t=i.uploadResponse())==null||t.ocrResult==null)&&t.ocrResult.fecha?4:-1)}}function kn(a,c){if(a&1&&(r(0,"div",70)(1,"div",71)(2,"div",72)(3,"span",73),l(4,"Monto"),o(),g(5,bn,2,3,"mat-icon",74),o(),r(6,"p",75),l(7),$(8,"number"),o(),g(9,hn,4,4,"p",76),o(),r(10,"div",71)(11,"div",72)(12,"span",73),l(13,"Documento"),o(),g(14,xn,2,3,"mat-icon",74),o(),r(15,"p",77),l(16),o(),g(17,_n,4,4,"p",76),o(),r(18,"div",71)(19,"div",72)(20,"span",73),l(21,"Nombre"),o(),g(22,Cn,2,3,"mat-icon",74),o(),r(23,"p",77),l(24),o(),g(25,vn,4,4,"p",76),o()(),g(26,En,5,3,"div",78)),a&2){let n,e,t,i,d,m,p,h,_,F,O,G,A,V=u(2);s(),P(V.getValidationCardClass((n=V.uploadResponse())==null?null:n.validacionMonto)),s(4),f((e=V.uploadResponse())!=null&&e.validacionMonto?5:-1),s(2),b("S/ ",H(8,16,(t=V.uploadResponse())==null||t.ocrResult==null?null:t.ocrResult.monto,"1.2-2")),s(2),f((i=V.uploadResponse())!=null&&i.validacionMonto?9:-1),s(),P(V.getValidationCardClass((d=V.uploadResponse())==null?null:d.validacionDocumento)),s(4),f((m=V.uploadResponse())!=null&&m.validacionDocumento?14:-1),s(2),E(((p=V.uploadResponse())==null||p.ocrResult==null?null:p.ocrResult.documento)||"-"),s(),f((h=V.uploadResponse())!=null&&h.validacionDocumento?17:-1),s(),P(V.getValidationCardClass((_=V.uploadResponse())==null?null:_.validacionNombre)),s(4),f((F=V.uploadResponse())!=null&&F.validacionNombre?22:-1),s(2),E(((O=V.uploadResponse())==null||O.ocrResult==null?null:O.ocrResult.nombre)||"-"),s(),f((G=V.uploadResponse())!=null&&G.validacionNombre?25:-1),s(),f(!((A=V.uploadResponse())==null||A.ocrResult==null)&&A.ocrResult.banco||!((A=V.uploadResponse())==null||A.ocrResult==null)&&A.ocrResult.numeroOperacion||!((A=V.uploadResponse())==null||A.ocrResult==null)&&A.ocrResult.fecha?26:-1)}}function Mn(a,c){a&1&&(r(0,"div",57)(1,"mat-icon",86),l(2,"info"),o(),r(3,"p",87),l(4,"Comprobante guardado sin validaci\xF3n OCR"),o()())}function Dn(a,c){a&1&&(r(0,"div",58)(1,"mat-icon",88),l(2,"warning"),o(),r(3,"div")(4,"p",89),l(5,"Hay diferencias en la validaci\xF3n"),o(),r(6,"p",90),l(7,"Verifica visualmente el comprobante."),o()()())}function wn(a,c){if(a&1){let n=B();r(0,"div",17)(1,"div",50)(2,"div",51)(3,"div",52)(4,"mat-icon",53),l(5),o()(),r(6,"div",54)(7,"p",55),l(8),o(),r(9,"p",56),l(10),o()()(),g(11,kn,27,19)(12,Mn,5,0,"div",57),g(13,Dn,8,0,"div",58),o(),r(14,"div",59)(15,"div",60)(16,"div",61)(17,"span",62),l(18,"Comprobante"),o(),r(19,"div",63)(20,"button",64),C("click",function(){S(n);let t=u();return y(t.zoomOut())}),r(21,"mat-icon",65),l(22,"remove"),o()(),r(23,"span",66),l(24),$(25,"number"),o(),r(26,"button",64),C("click",function(){S(n);let t=u();return y(t.zoomIn())}),r(27,"mat-icon",65),l(28,"add"),o()(),r(29,"button",67),C("click",function(){S(n);let t=u();return y(t.resetZoom())}),r(30,"mat-icon",65),l(31,"fit_screen"),o()()()(),r(32,"div",68),C("wheel",function(t){S(n);let i=u();return y(i.onWheel(t))}),N(33,"img",69),o()()()()}if(a&2){let n,e,t=u();s(2),P(t.getResultBgClass()),s(),P(t.getResultIconBgClass()),s(2),E(t.getResultIcon()),s(3),E(t.getResultTitle()),s(2),E((n=t.uploadResponse())==null?null:n.mensaje),s(),f(!((e=t.uploadResponse())==null||e.ocrResult==null)&&e.ocrResult.success?11:(e=t.uploadResponse())!=null&&e.ocrResult&&!(!((e=t.uploadResponse())==null||e.ocrResult==null)&&e.ocrResult.success)?12:-1),s(2),f(t.showWarning()?13:-1),s(7),v("disabled",t.zoomLevel()<=.5),s(4),b("",H(25,17,t.zoomLevel()*100,"1.0-0"),"%"),s(2),v("disabled",t.zoomLevel()>=3),s(7),Ae("transform","scale("+t.zoomLevel()+")")("transform-origin","top left"),v("src",t.previewUrl(),Oe)}}function In(a,c){if(a&1&&(r(0,"div",18)(1,"mat-icon",91),l(2,"error"),o(),r(3,"p",92),l(4),o()()),a&2){let n=u();s(4),E(n.errorMessage())}}function Tn(a,c){a&1&&N(0,"mat-spinner",94)}function On(a,c){a&1&&(r(0,"mat-icon",95),l(1,"upload"),o())}function An(a,c){if(a&1){let n=B();r(0,"button",93),C("click",function(){S(n);let t=u();return y(t.upload())}),g(1,Tn,1,0,"mat-spinner",94)(2,On,2,0,"mat-icon",95),l(3," Subir y Validar "),o()}if(a&2){let n=u();v("disabled",!n.selectedFile()||n.isUploading()),s(),f(n.isUploading()?1:2)}}function Nn(a,c){if(a&1){let n=B();r(0,"button",96),C("click",function(){S(n);let t=u();return y(t.confirm())}),r(1,"mat-icon",95),l(2),o(),l(3),o()}if(a&2){let n=u();P(n.showWarning()?"!bg-amber-500 hover:!bg-amber-600":"!bg-green-600 hover:!bg-green-700"),v("color",n.showWarning()?"warn":"primary"),s(2),E(n.showWarning()?"check":"done_all"),s(),b(" ",n.showWarning()?"Continuar":"Confirmar"," ")}}var zt=(()=>{let c=class c{constructor(e,t,i){this.dialogRef=e,this.data=t,this.comprobanteService=i,this.selectedFile=x(null),this.previewUrl=x(""),this.isUploading=x(!1),this.uploadResponse=x(null),this.errorMessage=x(""),this.zoomLevel=x(1),this.showWarning=z(()=>{let d=this.uploadResponse();return d?d.validacionMonto&&!d.validacionMonto.coincide||d.validacionDocumento&&!d.validacionDocumento.coincide||d.validacionNombre&&!d.validacionNombre.coincide:!1})}onDragOver(e){e.preventDefault(),e.stopPropagation()}onDrop(e){e.preventDefault(),e.stopPropagation();let t=e.dataTransfer?.files;t&&t.length>0&&this.handleFile(t[0])}onFileSelected(e){let t=e.target;t.files&&t.files.length>0&&this.handleFile(t.files[0])}handleFile(e){if(!["image/jpeg","image/png","image/webp"].includes(e.type)){this.errorMessage.set("Tipo de archivo no permitido. Solo JPG, PNG o WebP.");return}if(e.size>5*1024*1024){this.errorMessage.set("El archivo es muy grande. M\xE1ximo 5MB.");return}this.errorMessage.set(""),this.selectedFile.set(e);let t=new FileReader;t.onload=()=>{this.previewUrl.set(t.result)},t.readAsDataURL(e)}removeFile(){this.selectedFile.set(null),this.previewUrl.set(""),this.uploadResponse.set(null),this.errorMessage.set("")}upload(){let e=this.selectedFile();e&&(this.isUploading.set(!0),this.errorMessage.set(""),this.comprobanteService.uploadComprobante(e,{idCuota:this.data.idCuota,montoEsperado:this.data.montoEsperado,documentoEsperado:this.data.documentoEsperado,nombreEsperado:this.data.nombreCliente,idAgente:this.data.idAgente}).subscribe({next:t=>{this.isUploading.set(!1),this.uploadResponse.set(t),t.success||this.errorMessage.set(t.error||"Error al procesar el comprobante")},error:t=>{this.isUploading.set(!1),this.errorMessage.set(t.error?.error||"Error de conexi\xF3n")}}))}confirm(){let t={uploaded:!0,response:this.uploadResponse()||void 0,validacionesOk:!this.showWarning()};this.dialogRef.close(t)}cancel(){this.dialogRef.close({uploaded:!1,validacionesOk:!1})}formatFileSize(e){return e<1024?e+" B":e<1024*1024?(e/1024).toFixed(1)+" KB":(e/(1024*1024)).toFixed(1)+" MB"}getResultBgClass(){return this.uploadResponse()?.success?this.showWarning()?"bg-amber-50 dark:bg-amber-950/30 text-amber-700 dark:text-amber-300":"bg-green-50 dark:bg-green-950/30 text-green-700 dark:text-green-300":"bg-red-50 dark:bg-red-950/30 text-red-700 dark:text-red-300"}getResultIconBgClass(){return this.uploadResponse()?.success?this.showWarning()?"bg-amber-100 dark:bg-amber-900/50 text-amber-600 dark:text-amber-400":"bg-green-100 dark:bg-green-900/50 text-green-600 dark:text-green-400":"bg-red-100 dark:bg-red-900/50 text-red-600 dark:text-red-400"}getResultIcon(){return this.uploadResponse()?.success?this.showWarning()?"warning":"check_circle":"error"}getResultTitle(){return this.uploadResponse()?.success?this.showWarning()?"Comprobante con advertencias":"Comprobante validado":"Error al procesar"}getValidationClass(e){return e?e.coincide?"border-green-300 bg-green-50 dark:bg-green-950/20":"border-amber-300 bg-amber-50 dark:bg-amber-950/20":"border-slate-200 dark:border-slate-700"}getValidationCardClass(e){return e?e.coincide?"border-green-400 dark:border-green-600 bg-green-50 dark:bg-green-950/30":"border-amber-400 dark:border-amber-600 bg-amber-50 dark:bg-amber-950/30":"border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800/50"}zoomIn(){this.zoomLevel()<3&&this.zoomLevel.update(e=>Math.min(3,e+.25))}zoomOut(){this.zoomLevel()>.5&&this.zoomLevel.update(e=>Math.max(.5,e-.25))}resetZoom(){this.zoomLevel.set(1)}onWheel(e){e.preventDefault(),e.deltaY<0?this.zoomIn():this.zoomOut()}};c.\u0275fac=function(t){return new(t||c)(R(Me),R(De),R(Te))},c.\u0275cmp=Z({type:c,selectors:[["app-comprobante-upload-dialog"]],decls:39,vars:12,consts:[["fileInput",""],[1,"dialog-header","bg-gradient-to-r","from-indigo-600","to-blue-600","dark:from-indigo-700","dark:to-blue-700","text-white","px-5","py-3","-mx-6","-mt-6","mb-4","rounded-t-2xl"],[1,"flex","items-center","gap-3"],[1,"p-2","bg-white/20","rounded-lg"],[1,"!text-2xl"],[1,"text-lg","font-bold","m-0"],[1,"text-xs","text-white/80","m-0"],[1,"!overflow-x-hidden","!overflow-y-auto","!w-full"],[1,"mb-4","p-3","bg-white","dark:bg-slate-800","rounded-xl","border","border-slate-200","dark:border-slate-700","shadow-sm"],[1,"grid","grid-cols-3","gap-3"],[1,"min-w-0"],[1,"text-[10px]","text-slate-500","dark:text-slate-400","uppercase","tracking-wide","font-semibold","mb-0.5"],[1,"font-semibold","text-sm","text-slate-800","dark:text-slate-100","truncate"],[1,"font-semibold","text-sm","text-slate-800","dark:text-slate-100"],[1,"font-bold","text-lg","text-indigo-600","dark:text-indigo-400"],[1,"relative","rounded-xl","overflow-hidden","border","border-slate-200","dark:border-slate-700","bg-white","dark:bg-slate-800/50","shadow-sm"],[1,"py-8","text-center","bg-slate-50","dark:bg-slate-800/30","rounded-xl"],[1,"flex","gap-4"],[1,"p-3","bg-red-50","dark:bg-red-950/30","rounded-xl","border","border-red-200","dark:border-red-800","flex","items-center","gap-3"],["align","end",1,"!px-5","!py-3","border-t","border-slate-200","dark:border-slate-700","gap-2","bg-slate-50","dark:bg-slate-800/50","-mx-6","-mb-6","rounded-b-2xl"],["mat-button","",1,"!text-slate-600","dark:!text-slate-300","!rounded-lg","!px-4","hover:!bg-slate-200","dark:hover:!bg-slate-700",3,"click"],["mat-raised-button","","color","primary",1,"!px-5","!rounded-lg","!bg-indigo-600","hover:!bg-indigo-700","!shadow-md",3,"disabled"],["mat-raised-button","",1,"!px-5","!rounded-lg","!shadow-md",3,"color","class"],[1,"border-2","border-dashed","border-slate-300","dark:border-slate-600","rounded-xl","p-6","text-center","cursor-pointer","hover:border-indigo-500","hover:bg-indigo-50","dark:hover:bg-indigo-950/20","transition-all","duration-300","group","bg-white","dark:bg-slate-800/30",3,"click","dragover","drop"],[1,"w-14","h-14","mx-auto","mb-3","bg-slate-100","dark:bg-slate-700","rounded-xl","flex","items-center","justify-center","group-hover:bg-indigo-100","dark:group-hover:bg-indigo-900/30","transition-colors"],[1,"!text-4xl","text-slate-400","dark:text-slate-500","group-hover:text-indigo-500","transition-colors"],[1,"text-slate-700","dark:text-slate-200","font-semibold","mb-1"],[1,"text-slate-500","dark:text-slate-400","text-sm"],[1,"text-indigo-600","dark:text-indigo-400","font-semibold","hover:underline"],[1,"text-xs","text-slate-400","dark:text-slate-500","mt-2"],["type","file","accept","image/jpeg,image/png,image/webp",1,"hidden",3,"change"],["alt","Preview",1,"w-full","max-h-48","object-contain","p-2",3,"src"],["mat-icon-button","",1,"!absolute","top-2","right-2","!bg-red-500","!text-white","hover:!bg-red-600","shadow-lg","!rounded-lg","!w-8","!h-8",3,"click"],[1,"!text-lg"],[1,"px-3","py-2","bg-slate-100","dark:bg-slate-800","border-t","border-slate-200","dark:border-slate-700"],[1,"text-xs","text-slate-700","dark:text-slate-300","flex","items-center","gap-1.5"],[1,"!text-sm","text-slate-500","dark:text-slate-400"],[1,"truncate"],[1,"text-slate-400","dark:text-slate-500","flex-shrink-0"],[1,"text-slate-500","dark:text-slate-400","flex-shrink-0"],[1,"relative","inline-block"],[1,"w-16","h-16","border-4","border-indigo-200","dark:border-indigo-900/50","rounded-full","animate-pulse"],["diameter","56","strokeWidth","3",1,"!absolute","top-1","left-1"],[1,"absolute","inset-0","flex","items-center","justify-center"],[1,"text-indigo-500","dark:text-indigo-400","animate-pulse","!text-xl"],[1,"text-slate-800","dark:text-slate-100","font-semibold","mt-4"],[1,"flex","justify-center","gap-1","mt-3"],[1,"w-2","h-2","bg-indigo-500","rounded-full","animate-bounce",2,"animation-delay","0ms"],[1,"w-2","h-2","bg-indigo-500","rounded-full","animate-bounce",2,"animation-delay","150ms"],[1,"w-2","h-2","bg-indigo-500","rounded-full","animate-bounce",2,"animation-delay","300ms"],[1,"flex-1","min-w-0","space-y-3"],[1,"p-3","rounded-xl","flex","items-center","gap-3"],[1,"p-2","rounded-lg","flex-shrink-0"],[1,"!text-xl"],[1,"flex-1","min-w-0"],[1,"font-bold","text-sm"],[1,"text-xs","opacity-80","truncate"],[1,"p-3","bg-amber-50","dark:bg-amber-950/30","rounded-xl","border","border-amber-200","dark:border-amber-800","flex","items-center","gap-3"],[1,"p-3","bg-amber-50","dark:bg-amber-950/30","border-2","border-amber-300","dark:border-amber-700","rounded-xl","flex","items-center","gap-3"],[1,"w-96","flex-shrink-0"],[1,"sticky","top-0","rounded-xl","border","border-slate-200","dark:border-slate-700","bg-slate-50","dark:bg-slate-800/50","overflow-hidden"],[1,"p-2","border-b","border-slate-200","dark:border-slate-700","flex","items-center","justify-between"],[1,"text-xs","font-semibold","text-slate-500","dark:text-slate-400","uppercase"],[1,"flex","items-center","gap-1"],["mat-icon-button","",1,"!w-7","!h-7",3,"click","disabled"],[1,"!text-base","text-slate-500","dark:text-slate-400"],[1,"text-xs","text-slate-500","dark:text-slate-400","w-10","text-center"],["mat-icon-button","",1,"!w-7","!h-7",3,"click"],[1,"overflow-auto","max-h-80","bg-white","dark:bg-slate-900",2,"cursor","grab",3,"wheel"],["alt","Comprobante",1,"transition-transform","duration-150",3,"src"],[1,"grid","grid-cols-3","gap-2"],[1,"p-3","rounded-xl","border-2","transition-all"],[1,"flex","items-center","justify-between","mb-1"],[1,"text-[10px]","font-semibold","uppercase","tracking-wide","text-slate-500","dark:text-slate-400"],[1,"!text-base",3,"class"],[1,"text-lg","font-bold","text-slate-800","dark:text-slate-100"],[1,"text-[10px]","mt-1","font-medium","flex","items-center","gap-0.5",3,"class"],[1,"text-sm","font-bold","text-slate-800","dark:text-slate-100","truncate"],[1,"p-3","bg-slate-50","dark:bg-slate-800/50","rounded-xl","border","border-slate-200","dark:border-slate-700"],[1,"!text-base"],[1,"text-[10px]","mt-1","font-medium","flex","items-center","gap-0.5"],[1,"!text-xs"],[1,"flex","items-center","gap-4","text-sm"],[1,"flex","items-center","gap-1.5"],[1,"!text-base","text-slate-400"],[1,"font-semibold","text-slate-800","dark:text-slate-100"],[1,"text-amber-500"],[1,"text-sm","text-amber-800","dark:text-amber-200"],[1,"text-amber-600","dark:text-amber-400"],[1,"text-amber-800","dark:text-amber-200","font-semibold","text-sm"],[1,"text-amber-700","dark:text-amber-300","text-xs"],[1,"text-red-500"],[1,"text-sm","text-red-700","dark:text-red-300"],["mat-raised-button","","color","primary",1,"!px-5","!rounded-lg","!bg-indigo-600","hover:!bg-indigo-700","!shadow-md",3,"click","disabled"],["diameter","16",1,"mr-2"],[1,"mr-1","!text-lg"],["mat-raised-button","",1,"!px-5","!rounded-lg","!shadow-md",3,"click","color"]],template:function(t,i){t&1&&(r(0,"div",1)(1,"div",2)(2,"div",3)(3,"mat-icon",4),l(4,"receipt_long"),o()(),r(5,"div")(6,"h2",5),l(7,"Subir Comprobante de Pago"),o(),r(8,"p",6),l(9,"Validaci\xF3n autom\xE1tica con IA"),o()()()(),r(10,"mat-dialog-content",7)(11,"div",8)(12,"div",9)(13,"div",10)(14,"p",11),l(15,"Cliente"),o(),r(16,"p",12),l(17),o()(),r(18,"div")(19,"p",11),l(20,"Documento"),o(),r(21,"p",13),l(22),o()(),r(23,"div")(24,"p",11),l(25,"Monto esperado"),o(),r(26,"p",14),l(27),$(28,"number"),o()()()(),g(29,pn,14,0),g(30,gn,15,3,"div",15),g(31,fn,13,0,"div",16),g(32,wn,34,20,"div",17),g(33,In,5,1,"div",18),o(),r(34,"mat-dialog-actions",19)(35,"button",20),C("click",function(){return i.cancel()}),l(36," Cancelar "),o(),g(37,An,4,2,"button",21)(38,Nn,4,5,"button",22),o()),t&2&&(s(17),E(i.data.nombreCliente),s(5),E(i.data.documentoEsperado),s(5),b("S/ ",H(28,9,i.data.montoEsperado,"1.2-2")),s(2),f(i.selectedFile()?-1:29),s(),f(i.selectedFile()&&!i.isUploading()&&!i.uploadResponse()?30:-1),s(),f(i.isUploading()?31:-1),s(),f(i.uploadResponse()?32:-1),s(),f(i.errorMessage()?33:-1),s(4),f(i.uploadResponse()?38:37))},dependencies:[ne,we,Ge,je,ye,Se,He,ke,Ee,We,qe,Vt,le],styles:["[_nghost-%COMP%]{display:block}"]});let a=c;return a})();var Fn=(a,c)=>c.numeroCuota;function Rn(a,c){if(a&1&&(r(0,"span",40),l(1),$(2,"number"),o(),r(3,"span",39),l(4),$(5,"number"),o()),a&2){let n=u().$implicit,e=u();s(),b("S/",H(2,2,n.monto,"1.2-2")),s(3),b("S/",H(5,5,e.getSaldoPendiente(n),"1.2-2"))}}function Vn(a,c){if(a&1&&(r(0,"span",39),l(1),$(2,"number"),o()),a&2){let n=u().$implicit;s(),b("S/",H(2,1,n.monto,"1.2-2"))}}function Ln(a,c){if(a&1&&(r(0,"div",37)(1,"span",38),l(2),o(),g(3,Rn,6,8)(4,Vn,3,4,"span",39),o()),a&2){let n,e=c.$implicit,t=u();xe("active",e.numeroCuota===((n=t.cuotaMasProxima())==null?null:n.numeroCuota)),s(2),b("C",e.numeroCuota),s(),f(e.montoPagadoReal&&e.montoPagadoReal>0?3:4)}}function Un(a,c){if(a&1&&(r(0,"strong"),l(1),$(2,"number"),o(),r(3,"span",41),l(4,"Parcial"),o()),a&2){let n,e=u();s(),re("C",(n=e.cuotaMasProxima())==null?null:n.numeroCuota," - S/",H(2,2,e.getSaldoPendiente(e.cuotaMasProxima()),"1.2-2"))}}function zn(a,c){if(a&1&&(r(0,"strong"),l(1),$(2,"number"),o()),a&2){let n,e=u();s(),re("C",(n=e.cuotaMasProxima())==null?null:n.numeroCuota," - S/",H(2,2,(n=e.cuotaMasProxima())==null?null:n.monto,"1.2-2"))}}function Bn(a,c){if(a&1&&(r(0,"div",58)(1,"mat-icon"),l(2,"account_balance"),o(),r(3,"span"),l(4),o()()),a&2){let n,e=u(4);s(4),E((n=e.uploadResponse())==null||n.ocrResult==null?null:n.ocrResult.banco)}}function $n(a,c){if(a&1&&(r(0,"div",58)(1,"mat-icon"),l(2,"tag"),o(),r(3,"span"),l(4),o()()),a&2){let n,e=u(4);s(4),b("Op. ",(n=e.uploadResponse())==null||n.ocrResult==null?null:n.ocrResult.numeroOperacion)}}function Hn(a,c){if(a&1&&(r(0,"div",58)(1,"mat-icon"),l(2,"event"),o(),r(3,"span"),l(4),o()()),a&2){let n,e=u(4);s(4),E((n=e.uploadResponse())==null||n.ocrResult==null?null:n.ocrResult.fecha)}}function jn(a,c){if(a&1&&(r(0,"div",54),g(1,Bn,5,1,"div",58),g(2,$n,5,1,"div",58),g(3,Hn,5,1,"div",58),o()),a&2){let n,e,t,i=u(3);s(),f(!((n=i.uploadResponse())==null||n.ocrResult==null)&&n.ocrResult.banco?1:-1),s(),f(!((e=i.uploadResponse())==null||e.ocrResult==null)&&e.ocrResult.numeroOperacion?2:-1),s(),f(!((t=i.uploadResponse())==null||t.ocrResult==null)&&t.ocrResult.fecha?3:-1)}}function Gn(a,c){if(a&1&&(r(0,"div",47)(1,"div",48)(2,"div",49)(3,"mat-icon"),l(4),o()(),r(5,"div",50)(6,"span",51),l(7,"Monto"),o(),r(8,"span",52),l(9),$(10,"number"),o()()(),r(11,"div",48)(12,"div",49)(13,"mat-icon"),l(14),o()(),r(15,"div",50)(16,"span",51),l(17,"Documento"),o(),r(18,"span",52),l(19),o()()(),r(20,"div",48)(21,"div",49)(22,"mat-icon"),l(23),o()(),r(24,"div",50)(25,"span",51),l(26,"Nombre"),o(),r(27,"span",53),l(28),o()()()(),g(29,jn,4,3,"div",54),r(30,"div",55)(31,"mat-icon"),l(32),o(),r(33,"span"),l(34,"Se registrar\xE1:"),o(),r(35,"strong"),l(36),o(),r(37,"span",56),l(38),$(39,"number"),o()(),r(40,"div",57)(41,"mat-icon"),l(42,"auto_awesome"),o(),r(43,"span"),l(44,"Al confirmar se seleccionar\xE1 autom\xE1ticamente: "),r(45,"strong"),l(46,"Contacto Directo \u2192 Cancelaci\xF3n"),o()()()),a&2){let n,e,t,i,d,m,p,h,_,F,O,G,A=u(2);s(),P(A.getValidationClass((n=A.uploadResponse())==null?null:n.validacionMonto)),s(3),E(!((e=A.uploadResponse())==null||e.validacionMonto==null)&&e.validacionMonto.coincide?"check_circle":"warning"),s(5),b("S/",H(10,18,(t=A.uploadResponse())==null||t.ocrResult==null?null:t.ocrResult.monto,"1.2-2")),s(2),P(A.getValidationClass((i=A.uploadResponse())==null?null:i.validacionDocumento)),s(3),E(!((d=A.uploadResponse())==null||d.validacionDocumento==null)&&d.validacionDocumento.coincide?"check_circle":"warning"),s(5),E(((m=A.uploadResponse())==null||m.ocrResult==null?null:m.ocrResult.documento)||"-"),s(),P(A.getValidationClass((p=A.uploadResponse())==null?null:p.validacionNombre)),s(3),E(!((h=A.uploadResponse())==null||h.validacionNombre==null)&&h.validacionNombre.coincide?"check_circle":"warning"),s(5),E(((_=A.uploadResponse())==null||_.ocrResult==null?null:_.ocrResult.nombre)||"-"),s(),f(!((F=A.uploadResponse())==null||F.ocrResult==null)&&F.ocrResult.banco||!((F=A.uploadResponse())==null||F.ocrResult==null)&&F.ocrResult.numeroOperacion?29:-1),s(),P(A.cuotaCoincidente()?"success":"warning"),s(2),E(A.cuotaCoincidente()?"check_circle":"info"),s(4),b("Cuota ",(O=A.cuotaCoincidente()||A.cuotaMasProxima())==null?null:O.numeroCuota),s(2),b("(S/",H(39,21,(G=A.cuotaCoincidente()||A.cuotaMasProxima())==null?null:G.monto,"1.2-2"),")")}}function qn(a,c){if(a&1&&(r(0,"div",42)(1,"div",43)(2,"mat-icon"),l(3),o()(),r(4,"div",44)(5,"span",45),l(6),o(),r(7,"span",46),l(8),o()()(),g(9,Gn,47,24)),a&2){let n,e=u();P(e.getResultClass()),s(3),E(e.getResultIcon()),s(3),E(e.getResultTitle()),s(2),E(e.getResultSubtitle()),s(),f(!((n=e.uploadResponse())==null||n.ocrResult==null)&&n.ocrResult.success?9:-1)}}function Wn(a,c){if(a&1&&(r(0,"div",25)(1,"mat-icon"),l(2,"error_outline"),o(),r(3,"span"),l(4),o()()),a&2){let n=u();s(4),E(n.errorMessage())}}function Yn(a,c){if(a&1){let n=B();r(0,"div",30)(1,"button",59),C("click",function(){S(n);let t=u();return y(t.zoomOut())}),r(2,"mat-icon"),l(3,"remove"),o()(),r(4,"span",60),l(5),$(6,"number"),o(),r(7,"button",59),C("click",function(){S(n);let t=u();return y(t.zoomIn())}),r(8,"mat-icon"),l(9,"add"),o()(),N(10,"div",61),r(11,"button",62),C("click",function(){S(n);let t=u();return y(t.removeFile())}),r(12,"mat-icon"),l(13,"delete_outline"),o()()()}if(a&2){let n=u();s(),v("disabled",n.zoomLevel()<=.5),s(4),b("",H(6,3,n.zoomLevel()*100,"1.0-0"),"%"),s(2),v("disabled",n.zoomLevel()>=3)}}function Xn(a,c){if(a&1){let n=B();r(0,"div",63),C("click",function(){S(n);let t=Ue(19);return y(t.click())})("dragover",function(t){S(n);let i=u();return y(i.onDragOver(t))})("drop",function(t){S(n);let i=u();return y(i.onDrop(t))}),r(1,"div",64)(2,"div",65)(3,"mat-icon"),l(4,"cloud_upload"),o()(),r(5,"p",66),l(6,"Arrastra tu voucher aqu\xED"),o(),r(7,"p",67),l(8,"o haz clic para seleccionar"),o(),r(9,"div",68)(10,"span",69),l(11,"JPG"),o(),r(12,"span",69),l(13,"PNG"),o(),r(14,"span",69),l(15,"WebP"),o(),r(16,"span",70),l(17,"Max 5MB"),o()()()(),r(18,"input",71,0),C("change",function(t){S(n);let i=u();return y(i.onFileSelected(t))}),o()}}function Qn(a,c){a&1&&(r(0,"div",74)(1,"div",75),N(2,"mat-spinner",76),r(3,"p"),l(4,"Analizando voucher..."),o(),r(5,"span"),l(6,"Procesando con IA"),o()()())}function Kn(a,c){if(a&1){let n=B();r(0,"div",72),C("wheel",function(t){S(n);let i=u();return y(i.onWheel(t))}),N(1,"img",73),o(),g(2,Qn,7,0,"div",74)}if(a&2){let n=u();s(),Ae("transform","scale("+n.zoomLevel()+")"),v("src",n.previewUrl(),Oe),s(),f(n.isUploading()?2:-1)}}function Jn(a,c){if(a&1){let n=B();r(0,"button",77),C("click",function(){S(n);let t=u();return y(t.upload())}),r(1,"mat-icon"),l(2,"psychology"),o(),l(3," Analizar con IA "),o()}if(a&2){let n=u();v("disabled",!n.selectedFile()||n.isUploading())}}function Zn(a,c){if(a&1){let n=B();r(0,"button",78),C("click",function(){S(n);let t=u();return y(t.confirm())}),r(1,"mat-icon"),l(2,"done_all"),o(),l(3," Confirmar Pago "),o()}if(a&2){let n=u();P(n.showWarning()?"warning":"success")}}var Bt=(()=>{let c=class c{constructor(e,t,i){this.dialogRef=e,this.data=t,this.comprobanteService=i,this.selectedFile=x(null),this.previewUrl=x(""),this.isUploading=x(!1),this.uploadResponse=x(null),this.errorMessage=x(""),this.zoomLevel=x(1),this.isDarkMode=x(!1),this.cuotasPendientes=z(()=>this.data.cuotas.filter(d=>d.status!=="PAGADA"&&d.status!=="PAGADO"&&d.status!=="CUMPLIDO"&&d.status!=="CANCELADA").sort((d,m)=>new Date(d.dueDate).getTime()-new Date(m.dueDate).getTime())),this.cuotaMasProxima=z(()=>{let d=this.cuotasPendientes();return d.length>0?d[0]:null}),this.cuotaCoincidente=z(()=>{let d=this.uploadResponse();if(!d?.ocrResult?.monto)return null;let m=d.ocrResult.monto;return this.cuotasPendientes().find(h=>Math.abs(h.monto-m)<.01)||null}),this.showWarning=z(()=>{let d=this.uploadResponse();if(!d)return!1;let m=d.validacionMonto&&!d.validacionMonto.coincide||d.validacionDocumento&&!d.validacionDocumento.coincide||d.validacionNombre&&!d.validacionNombre.coincide,p=d.ocrResult,h=!p?.monto&&!p?.documento&&!p?.nombre;return m||h}),this.noDataDetected=z(()=>{let d=this.uploadResponse();if(!d?.ocrResult)return!0;let m=d.ocrResult;return!m.monto&&!m.documento&&!m.nombre})}ngOnInit(){this.isDarkMode.set(document.documentElement.classList.contains("dark")),this.darkModeObserver=new MutationObserver(e=>{e.forEach(t=>{t.attributeName==="class"&&this.isDarkMode.set(document.documentElement.classList.contains("dark"))})}),this.darkModeObserver.observe(document.documentElement,{attributes:!0})}ngOnDestroy(){this.darkModeObserver?.disconnect()}onDragOver(e){e.preventDefault(),e.stopPropagation()}onDrop(e){e.preventDefault(),e.stopPropagation();let t=e.dataTransfer?.files;t&&t.length>0&&this.handleFile(t[0])}onFileSelected(e){let t=e.target;t.files&&t.files.length>0&&this.handleFile(t.files[0])}handleFile(e){if(!["image/jpeg","image/png","image/webp"].includes(e.type)){this.errorMessage.set("Solo JPG, PNG o WebP.");return}if(e.size>5*1024*1024){this.errorMessage.set("M\xE1ximo 5MB.");return}this.errorMessage.set(""),this.selectedFile.set(e),this.uploadResponse.set(null);let t=new FileReader;t.onload=()=>this.previewUrl.set(t.result),t.readAsDataURL(e)}removeFile(){this.selectedFile.set(null),this.previewUrl.set(""),this.uploadResponse.set(null),this.errorMessage.set(""),this.zoomLevel.set(1)}upload(){let e=this.selectedFile(),t=this.cuotaMasProxima();!e||!t||(this.isUploading.set(!0),this.errorMessage.set(""),this.comprobanteService.uploadComprobante(e,{idCuota:t.id,montoEsperado:this.getSaldoPendiente(t),documentoEsperado:this.data.documentoCliente,nombreEsperado:this.data.nombreCliente,idAgente:this.data.idAgente}).subscribe({next:i=>{this.isUploading.set(!1),this.uploadResponse.set(i),i.success||this.errorMessage.set(i.error||"Error al procesar")},error:i=>{this.isUploading.set(!1),this.errorMessage.set(i.error?.error||"Error de conexi\xF3n")}}))}confirm(){let e=this.uploadResponse(),t=this.cuotaCoincidente()||this.cuotaMasProxima();if(!t)return;let i=e?.ocrResult,d="Pago validado por OCR";i?.banco&&(d+=` - ${i.banco}`),i?.numeroOperacion&&(d+=` - Op. #${i.numeroOperacion}`),i?.fecha&&(d+=` - Fecha: ${i.fecha}`),i?.monto&&(d+=` - Monto: S/ ${i.monto.toFixed(2)}`),this.dialogRef.close({confirmed:!0,autoSelect:{categoriaId:"CD",detalleId:"CA",cuotaSeleccionada:t,observaciones:d},ocrResponse:e||void 0})}cancel(){this.dialogRef.close({confirmed:!1})}formatDate(e){if(!e)return"-";if(/^\d{4}-\d{2}-\d{2}$/.test(e)){let[t,i,d]=e.split("-").map(Number);return new Date(t,i-1,d).toLocaleDateString("es-PE",{day:"2-digit",month:"2-digit",year:"numeric"})}return e}getResultClass(){return this.uploadResponse()?.success?this.showWarning()?"warning":"success":"error"}getResultIcon(){return this.uploadResponse()?.success?this.showWarning()?"warning":"check_circle":"error"}getResultTitle(){return this.uploadResponse()?.success?this.noDataDetected()?"No se detectaron datos":this.showWarning()?"Voucher con advertencias":"Voucher validado correctamente":"Error al procesar"}getResultSubtitle(){return this.uploadResponse()?.success?this.noDataDetected()?"La imagen no parece ser un comprobante de pago v\xE1lido":this.showWarning()?"Algunos datos no coinciden exactamente":"Todos los datos coinciden con el cliente":"No se pudo analizar el voucher"}getValidationClass(e){return e?e.coincide?"success":"warning":"neutral"}getSaldoPendiente(e){let t=e.montoPagadoReal||0;return Math.max(0,e.monto-t)}zoomIn(){this.zoomLevel()<3&&this.zoomLevel.update(e=>e+.25)}zoomOut(){this.zoomLevel()>.5&&this.zoomLevel.update(e=>e-.25)}onWheel(e){e.preventDefault(),e.deltaY<0?this.zoomIn():this.zoomOut()}};c.\u0275fac=function(t){return new(t||c)(R(Me),R(De),R(Te))},c.\u0275cmp=Z({type:c,selectors:[["app-voucher-payment-dialog"]],decls:77,vars:11,consts:[["fileInput",""],[1,"voucher-dialog"],[1,"dialog-header"],[1,"header-content"],[1,"header-icon"],[1,"header-text"],[1,"header-subtitle"],[1,"inline-icon"],["mat-icon-button","",1,"close-btn",3,"click"],[1,"dialog-body"],[1,"two-column-layout"],[1,"left-column"],[1,"info-card","client-card"],[1,"card-header"],[1,"card-body"],[1,"info-row"],[1,"info-item"],[1,"info-label"],[1,"info-value"],[1,"info-value","highlight"],[1,"info-card","installments-card"],[1,"installments-grid"],[1,"installment-chip",3,"active"],[1,"next-installment"],[1,"date-badge"],[1,"error-message"],[1,"right-column"],[1,"image-viewer"],[1,"viewer-header"],[1,"viewer-title"],[1,"zoom-controls"],[1,"viewer-body"],[1,"dialog-actions"],["mat-button","",1,"btn-cancel",3,"click"],[1,"action-buttons"],["mat-flat-button","",1,"btn-analyze",3,"disabled"],["mat-flat-button","",1,"btn-confirm",3,"class"],[1,"installment-chip"],[1,"chip-number"],[1,"chip-amount"],[1,"chip-amount-original"],[1,"partial-badge"],[1,"result-banner"],[1,"result-icon"],[1,"result-text"],[1,"result-title"],[1,"result-subtitle"],[1,"validations-grid"],[1,"validation-card"],[1,"validation-icon"],[1,"validation-content"],[1,"validation-label"],[1,"validation-value"],[1,"validation-value","truncate"],[1,"bank-details"],[1,"selected-installment"],[1,"amount"],[1,"auto-select-info"],[1,"detail-item"],["mat-icon-button","",1,"zoom-btn",3,"click","disabled"],[1,"zoom-level"],[1,"zoom-divider"],["mat-icon-button","",1,"delete-btn",3,"click"],[1,"upload-area",3,"click","dragover","drop"],[1,"upload-content"],[1,"upload-icon"],[1,"upload-title"],[1,"upload-subtitle"],[1,"upload-formats"],[1,"format-badge"],[1,"size-info"],["type","file","accept","image/jpeg,image/png,image/webp",1,"hidden",3,"change"],[1,"image-container",3,"wheel"],["alt","Voucher",3,"src"],[1,"loading-overlay"],[1,"loading-content"],["diameter","48"],["mat-flat-button","",1,"btn-analyze",3,"click","disabled"],["mat-flat-button","",1,"btn-confirm",3,"click"]],template:function(t,i){if(t&1&&(r(0,"div",1)(1,"div",2)(2,"div",3)(3,"div",4)(4,"mat-icon"),l(5,"receipt_long"),o()(),r(6,"div",5)(7,"h2"),l(8,"Registrar Pago"),o(),r(9,"span",6)(10,"mat-icon",7),l(11,"smart_toy"),o(),l(12," Validaci\xF3n autom\xE1tica con IA "),o()()(),r(13,"button",8),C("click",function(){return i.cancel()}),r(14,"mat-icon"),l(15,"close"),o()()(),r(16,"mat-dialog-content",9)(17,"div",10)(18,"div",11)(19,"div",12)(20,"div",13)(21,"mat-icon"),l(22,"person"),o(),r(23,"span"),l(24,"Informaci\xF3n del Cliente"),o()(),r(25,"div",14)(26,"div",15)(27,"div",16)(28,"span",17),l(29,"Cliente"),o(),r(30,"span",18),l(31),o()(),r(32,"div",16)(33,"span",17),l(34,"Documento"),o(),r(35,"span",19),l(36),o()()()()(),r(37,"div",20)(38,"div",13)(39,"mat-icon"),l(40,"payments"),o(),r(41,"span"),l(42,"Cuotas Pendientes"),o()(),r(43,"div",14)(44,"div",21),W(45,Ln,5,4,"div",22,Fn),o(),r(47,"div",23)(48,"mat-icon"),l(49,"arrow_forward"),o(),r(50,"span"),l(51,"Pr\xF3xima cuota:"),o(),g(52,Un,5,5)(53,zn,3,5,"strong"),r(54,"span",24),l(55),o()()()(),g(56,qn,10,6),g(57,Wn,5,1,"div",25),o(),r(58,"div",26)(59,"div",27)(60,"div",28)(61,"span",29)(62,"mat-icon"),l(63,"image"),o(),l(64," Voucher de Pago "),o(),g(65,Yn,14,6,"div",30),o(),r(66,"div",31),g(67,Xn,20,0)(68,Kn,3,4),o()()()()(),r(69,"mat-dialog-actions",32)(70,"button",33),C("click",function(){return i.cancel()}),r(71,"mat-icon"),l(72,"close"),o(),l(73," Cancelar "),o(),r(74,"div",34),g(75,Jn,4,1,"button",35)(76,Zn,4,2,"button",36),o()()()),t&2){let d,m;xe("dark-mode",i.isDarkMode()),s(31),E(i.data.nombreCliente),s(5),E(i.data.documentoCliente),s(9),Y(i.cuotasPendientes()),s(7),f((d=i.cuotaMasProxima())!=null&&d.montoPagadoReal&&i.cuotaMasProxima().montoPagadoReal>0?52:53),s(3),E(i.formatDate((m=i.cuotaMasProxima())==null?null:m.dueDate)),s(),f(i.uploadResponse()?56:-1),s(),f(i.errorMessage()?57:-1),s(8),f(i.previewUrl()?65:-1),s(2),f(i.previewUrl()?68:67),s(8),f(i.uploadResponse()?76:75)}},dependencies:[ne,we,Ge,je,ye,Se,He,ke,Ee,We,qe,le],styles:["[_nghost-%COMP%]{display:block}.voucher-dialog[_ngcontent-%COMP%]{display:flex;flex-direction:column;max-height:85vh;min-width:900px;background:#fff;overflow:hidden}.voucher-dialog.dark-mode[_ngcontent-%COMP%]{background:#0f172a}.dialog-header[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;padding:18px 24px;background:linear-gradient(135deg,#059669,#10b981);color:#fff}.header-content[_ngcontent-%COMP%]{display:flex;align-items:center;gap:16px}.header-icon[_ngcontent-%COMP%]{width:48px;height:48px;background:#fff3;border-radius:12px;display:flex;align-items:center;justify-content:center}.header-icon[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:26px;width:26px;height:26px}.header-text[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0;font-size:20px;font-weight:600}.header-subtitle[_ngcontent-%COMP%]{font-size:13px;opacity:.9;display:flex;align-items:center;gap:6px}.inline-icon[_ngcontent-%COMP%]{font-size:14px!important;width:14px!important;height:14px!important}.close-btn[_ngcontent-%COMP%]{color:#fff!important;opacity:.8;transition:opacity .2s}.close-btn[_ngcontent-%COMP%]:hover{opacity:1}.dialog-body[_ngcontent-%COMP%]{flex:1;padding:24px!important;overflow-y:auto!important;overflow-x:hidden!important;background:#f8fafc;max-height:calc(85vh - 160px)}.dark-mode[_ngcontent-%COMP%]   .dialog-body[_ngcontent-%COMP%]{background:#0f172a}.two-column-layout[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr 380px;gap:24px}.left-column[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:16px;min-width:0}.info-card[_ngcontent-%COMP%]{background:#fff;border-radius:14px;border:1px solid #e2e8f0;overflow:hidden;box-shadow:0 2px 8px #0000000a}.dark-mode[_ngcontent-%COMP%]   .info-card[_ngcontent-%COMP%]{background:#1e293b;border-color:#334155}.card-header[_ngcontent-%COMP%]{display:flex;align-items:center;gap:10px;padding:12px 16px;background:#f1f5f9;border-bottom:1px solid #e2e8f0;font-size:13px;font-weight:600;color:#475569}.dark-mode[_ngcontent-%COMP%]   .card-header[_ngcontent-%COMP%]{background:#334155;border-color:#475569;color:#cbd5e1}.card-header[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:18px;width:18px;height:18px;color:#64748b}.dark-mode[_ngcontent-%COMP%]   .card-header[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{color:#94a3b8}.card-body[_ngcontent-%COMP%]{padding:16px}.info-row[_ngcontent-%COMP%]{display:grid;grid-template-columns:1.5fr 1fr;gap:20px}.info-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:6px}.info-label[_ngcontent-%COMP%]{font-size:11px;color:#64748b;text-transform:uppercase;letter-spacing:.5px;font-weight:500}.dark-mode[_ngcontent-%COMP%]   .info-label[_ngcontent-%COMP%]{color:#94a3b8}.info-value[_ngcontent-%COMP%]{font-size:14px;font-weight:600;color:#1e293b;word-break:break-word}.dark-mode[_ngcontent-%COMP%]   .info-value[_ngcontent-%COMP%]{color:#f1f5f9}.info-value.highlight[_ngcontent-%COMP%]{color:#059669;font-family:SF Mono,Monaco,monospace;font-size:15px}.installments-grid[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:14px}.installment-chip[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;padding:8px 14px;background:#f1f5f9;border-radius:10px;border:1.5px solid #e2e8f0;transition:all .2s}.dark-mode[_ngcontent-%COMP%]   .installment-chip[_ngcontent-%COMP%]{background:#334155;border-color:#475569}.installment-chip.active[_ngcontent-%COMP%]{background:#dcfce7;border-color:#22c55e}.dark-mode[_ngcontent-%COMP%]   .installment-chip.active[_ngcontent-%COMP%]{background:#22c55e33;border-color:#22c55e}.chip-number[_ngcontent-%COMP%]{font-size:12px;font-weight:700;color:#64748b}.installment-chip.active[_ngcontent-%COMP%]   .chip-number[_ngcontent-%COMP%]{color:#16a34a}.dark-mode[_ngcontent-%COMP%]   .installment-chip.active[_ngcontent-%COMP%]   .chip-number[_ngcontent-%COMP%]{color:#4ade80}.chip-amount[_ngcontent-%COMP%]{font-size:13px;font-weight:600;color:#1e293b}.dark-mode[_ngcontent-%COMP%]   .chip-amount[_ngcontent-%COMP%]{color:#e2e8f0}.installment-chip.active[_ngcontent-%COMP%]   .chip-amount[_ngcontent-%COMP%]{color:#15803d}.dark-mode[_ngcontent-%COMP%]   .installment-chip.active[_ngcontent-%COMP%]   .chip-amount[_ngcontent-%COMP%]{color:#86efac}.chip-amount-original[_ngcontent-%COMP%]{font-size:12px;color:#64748b;margin-right:4px;opacity:.8}.dark-mode[_ngcontent-%COMP%]   .chip-amount-original[_ngcontent-%COMP%]{color:#94a3b8}.installment-chip.active[_ngcontent-%COMP%]   .chip-amount-original[_ngcontent-%COMP%]{color:#22c55e;opacity:.7}.partial-badge[_ngcontent-%COMP%]{font-size:10px;font-weight:600;padding:2px 6px;background:#f59e0b;color:#fff;border-radius:4px;margin-left:4px}.next-installment[_ngcontent-%COMP%]{display:flex;align-items:center;gap:10px;flex-wrap:wrap;padding:12px 14px;background:#f0fdf4;border-radius:10px;font-size:13px;color:#166534}.dark-mode[_ngcontent-%COMP%]   .next-installment[_ngcontent-%COMP%]{background:#22c55e26;color:#86efac}.next-installment[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:18px;width:18px;height:18px;color:#22c55e}.next-installment[_ngcontent-%COMP%]   strong[_ngcontent-%COMP%]{font-weight:700}.date-badge[_ngcontent-%COMP%]{margin-left:auto;padding:5px 10px;background:#fff;border-radius:8px;font-size:12px;font-weight:600;color:#059669;border:1px solid #bbf7d0}.dark-mode[_ngcontent-%COMP%]   .date-badge[_ngcontent-%COMP%]{background:#1e293b;border-color:#22c55e;color:#4ade80}.result-banner[_ngcontent-%COMP%]{display:flex;align-items:center;gap:14px;padding:14px 16px;border-radius:12px;border:1.5px solid}.result-banner.success[_ngcontent-%COMP%]{background:#dcfce7;border-color:#86efac}.dark-mode[_ngcontent-%COMP%]   .result-banner.success[_ngcontent-%COMP%]{background:#22c55e26;border-color:#22c55e}.result-banner.warning[_ngcontent-%COMP%]{background:#fef3c7;border-color:#fcd34d}.dark-mode[_ngcontent-%COMP%]   .result-banner.warning[_ngcontent-%COMP%]{background:#f59e0b26;border-color:#f59e0b}.result-banner.error[_ngcontent-%COMP%]{background:#fee2e2;border-color:#fca5a5}.dark-mode[_ngcontent-%COMP%]   .result-banner.error[_ngcontent-%COMP%]{background:#ef444426;border-color:#ef4444}.result-icon[_ngcontent-%COMP%]{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0}.result-banner.success[_ngcontent-%COMP%]   .result-icon[_ngcontent-%COMP%]{background:#22c55e;color:#fff}.result-banner.warning[_ngcontent-%COMP%]   .result-icon[_ngcontent-%COMP%]{background:#f59e0b;color:#fff}.result-banner.error[_ngcontent-%COMP%]   .result-icon[_ngcontent-%COMP%]{background:#ef4444;color:#fff}.result-text[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:3px}.result-title[_ngcontent-%COMP%]{font-size:14px;font-weight:700;color:#1e293b}.dark-mode[_ngcontent-%COMP%]   .result-title[_ngcontent-%COMP%]{color:#f1f5f9}.result-subtitle[_ngcontent-%COMP%]{font-size:12px;color:#64748b}.dark-mode[_ngcontent-%COMP%]   .result-subtitle[_ngcontent-%COMP%]{color:#94a3b8}.validations-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}.validation-card[_ngcontent-%COMP%]{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:12px;border:1.5px solid;background:#fff}.dark-mode[_ngcontent-%COMP%]   .validation-card[_ngcontent-%COMP%]{background:#1e293b}.validation-card.success[_ngcontent-%COMP%]{border-color:#86efac;background:#f0fdf4}.dark-mode[_ngcontent-%COMP%]   .validation-card.success[_ngcontent-%COMP%]{border-color:#22c55e;background:#22c55e1a}.validation-card.warning[_ngcontent-%COMP%]{border-color:#fcd34d;background:#fffbeb}.dark-mode[_ngcontent-%COMP%]   .validation-card.warning[_ngcontent-%COMP%]{border-color:#f59e0b;background:#f59e0b1a}.validation-card.neutral[_ngcontent-%COMP%]{border-color:#e2e8f0}.dark-mode[_ngcontent-%COMP%]   .validation-card.neutral[_ngcontent-%COMP%]{border-color:#475569}.validation-icon[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:22px;width:22px;height:22px}.validation-card.success[_ngcontent-%COMP%]   .validation-icon[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{color:#22c55e}.validation-card.warning[_ngcontent-%COMP%]   .validation-icon[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{color:#f59e0b}.validation-content[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:3px;min-width:0;flex:1}.validation-label[_ngcontent-%COMP%]{font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:#94a3b8;font-weight:500}.validation-value[_ngcontent-%COMP%]{font-size:13px;font-weight:600;color:#1e293b;overflow:hidden;text-overflow:ellipsis}.dark-mode[_ngcontent-%COMP%]   .validation-value[_ngcontent-%COMP%]{color:#f1f5f9}.truncate[_ngcontent-%COMP%]{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.bank-details[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:16px;padding:12px 16px;background:#f8fafc;border-radius:10px;border:1px solid #e2e8f0}.dark-mode[_ngcontent-%COMP%]   .bank-details[_ngcontent-%COMP%]{background:#1e293b;border-color:#334155}.detail-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;font-size:13px;color:#475569}.dark-mode[_ngcontent-%COMP%]   .detail-item[_ngcontent-%COMP%]{color:#94a3b8}.detail-item[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:16px;width:16px;height:16px;color:#94a3b8}.selected-installment[_ngcontent-%COMP%]{display:flex;align-items:center;gap:10px;padding:14px 16px;border-radius:12px;font-size:14px;border:2px solid}.selected-installment.success[_ngcontent-%COMP%]{background:#dcfce7;border-color:#22c55e;color:#166534}.dark-mode[_ngcontent-%COMP%]   .selected-installment.success[_ngcontent-%COMP%]{background:#22c55e26;color:#86efac}.selected-installment.warning[_ngcontent-%COMP%]{background:#fef3c7;border-color:#f59e0b;color:#92400e}.dark-mode[_ngcontent-%COMP%]   .selected-installment.warning[_ngcontent-%COMP%]{background:#f59e0b26;color:#fcd34d}.selected-installment[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:20px;width:20px;height:20px}.selected-installment[_ngcontent-%COMP%]   .amount[_ngcontent-%COMP%]{opacity:.8}.auto-select-info[_ngcontent-%COMP%]{display:flex;align-items:center;gap:10px;padding:12px 16px;background:#eff6ff;border-radius:10px;border:1px solid #bfdbfe;font-size:12px;color:#1d4ed8}.dark-mode[_ngcontent-%COMP%]   .auto-select-info[_ngcontent-%COMP%]{background:#3b82f61a;border-color:#3b82f6;color:#93c5fd}.auto-select-info[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:18px;width:18px;height:18px;color:#3b82f6}.error-message[_ngcontent-%COMP%]{display:flex;align-items:center;gap:12px;padding:14px 16px;background:#fef2f2;border-radius:10px;border:1px solid #fecaca;font-size:13px;color:#dc2626}.dark-mode[_ngcontent-%COMP%]   .error-message[_ngcontent-%COMP%]{background:#ef44441a;border-color:#ef4444;color:#fca5a5}.right-column[_ngcontent-%COMP%]{display:flex}.image-viewer[_ngcontent-%COMP%]{flex:1;display:flex;flex-direction:column;background:#fff;border-radius:14px;border:1px solid #e2e8f0;overflow:hidden;box-shadow:0 2px 8px #0000000a}.dark-mode[_ngcontent-%COMP%]   .image-viewer[_ngcontent-%COMP%]{background:#1e293b;border-color:#334155}.viewer-header[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#f8fafc;border-bottom:1px solid #e2e8f0}.dark-mode[_ngcontent-%COMP%]   .viewer-header[_ngcontent-%COMP%]{background:#0f172a;border-color:#334155}.viewer-title[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;font-size:13px;font-weight:600;color:#475569}.dark-mode[_ngcontent-%COMP%]   .viewer-title[_ngcontent-%COMP%]{color:#94a3b8}.viewer-title[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:18px;width:18px;height:18px}.zoom-controls[_ngcontent-%COMP%]{display:flex;align-items:center;gap:6px}.zoom-btn[_ngcontent-%COMP%]{width:30px!important;height:30px!important;background:#fff!important;border:1px solid #e2e8f0!important;border-radius:8px!important;display:inline-flex!important;align-items:center!important;justify-content:center!important;padding:0!important}.dark-mode[_ngcontent-%COMP%]   .zoom-btn[_ngcontent-%COMP%]{background:#334155!important;border-color:#475569!important}.zoom-btn[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:18px!important;width:18px!important;height:18px!important;color:#64748b}.dark-mode[_ngcontent-%COMP%]   .zoom-btn[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{color:#94a3b8}.zoom-level[_ngcontent-%COMP%]{font-size:12px;font-weight:600;color:#64748b;min-width:40px;text-align:center}.dark-mode[_ngcontent-%COMP%]   .zoom-level[_ngcontent-%COMP%]{color:#94a3b8}.zoom-divider[_ngcontent-%COMP%]{width:1px;height:24px;background:#e2e8f0;margin:0 6px}.dark-mode[_ngcontent-%COMP%]   .zoom-divider[_ngcontent-%COMP%]{background:#475569}.delete-btn[_ngcontent-%COMP%]{width:30px!important;height:30px!important;background:#fef2f2!important;border:1px solid #fecaca!important;border-radius:8px!important;display:inline-flex!important;align-items:center!important;justify-content:center!important;padding:0!important}.dark-mode[_ngcontent-%COMP%]   .delete-btn[_ngcontent-%COMP%]{background:#ef444426!important;border-color:#ef4444!important}.delete-btn[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:18px!important;width:18px!important;height:18px!important;color:#ef4444;line-height:1!important;display:block!important}.viewer-body[_ngcontent-%COMP%]{flex:1;min-height:380px;position:relative;background:#f1f5f9}.dark-mode[_ngcontent-%COMP%]   .viewer-body[_ngcontent-%COMP%]{background:#0f172a}.upload-area[_ngcontent-%COMP%]{position:absolute;inset:16px;border:2px dashed #cbd5e1;border-radius:14px;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;background:#fff}.dark-mode[_ngcontent-%COMP%]   .upload-area[_ngcontent-%COMP%]{border-color:#475569;background:#1e293b}.upload-area[_ngcontent-%COMP%]:hover{border-color:#22c55e;background:#f0fdf4}.dark-mode[_ngcontent-%COMP%]   .upload-area[_ngcontent-%COMP%]:hover{border-color:#22c55e;background:#22c55e1a}.upload-content[_ngcontent-%COMP%]{text-align:center;padding:24px}.upload-icon[_ngcontent-%COMP%]{width:72px;height:72px;margin:0 auto 20px;background:linear-gradient(135deg,#dcfce7,#bbf7d0);border-radius:18px;display:flex;align-items:center;justify-content:center}.dark-mode[_ngcontent-%COMP%]   .upload-icon[_ngcontent-%COMP%]{background:linear-gradient(135deg,#22c55e33,#22c55e4d)}.upload-icon[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:36px;width:36px;height:36px;color:#22c55e}.upload-title[_ngcontent-%COMP%]{font-size:16px;font-weight:600;color:#1e293b;margin:0 0 6px}.dark-mode[_ngcontent-%COMP%]   .upload-title[_ngcontent-%COMP%]{color:#f1f5f9}.upload-subtitle[_ngcontent-%COMP%]{font-size:13px;color:#64748b;margin:0 0 20px}.dark-mode[_ngcontent-%COMP%]   .upload-subtitle[_ngcontent-%COMP%]{color:#94a3b8}.upload-formats[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;gap:8px}.format-badge[_ngcontent-%COMP%]{padding:5px 10px;background:#f1f5f9;border-radius:6px;font-size:11px;font-weight:600;color:#64748b}.dark-mode[_ngcontent-%COMP%]   .format-badge[_ngcontent-%COMP%]{background:#334155;color:#94a3b8}.size-info[_ngcontent-%COMP%]{font-size:11px;color:#94a3b8}.image-container[_ngcontent-%COMP%]{position:absolute;inset:0;overflow:auto;cursor:grab;display:flex}.image-container[_ngcontent-%COMP%]:active{cursor:grabbing}.image-container[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{max-width:none;transition:transform .15s ease;transform-origin:top left}.loading-overlay[_ngcontent-%COMP%]{position:absolute;inset:0;background:#000000bf;display:flex;align-items:center;justify-content:center;-webkit-backdrop-filter:blur(6px);backdrop-filter:blur(6px)}.loading-content[_ngcontent-%COMP%]{text-align:center;color:#fff}.loading-content[_ngcontent-%COMP%]   mat-spinner[_ngcontent-%COMP%]{margin:0 auto 16px}.loading-content[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:16px;font-weight:600;margin:0 0 6px}.loading-content[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{font-size:13px;opacity:.8}.dialog-actions[_ngcontent-%COMP%]{display:flex!important;align-items:center;justify-content:space-between;padding:18px 24px!important;background:#f8fafc;border-top:1px solid #e2e8f0}.dark-mode[_ngcontent-%COMP%]   .dialog-actions[_ngcontent-%COMP%]{background:#1e293b;border-color:#334155}.btn-cancel[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;padding:10px 20px!important;border-radius:10px!important;font-size:14px!important;font-weight:500!important;color:#64748b!important;border:1px solid #e2e8f0!important;background:#fff!important;transition:all .2s}.dark-mode[_ngcontent-%COMP%]   .btn-cancel[_ngcontent-%COMP%]{color:#94a3b8!important;border-color:#475569!important;background:#0f172a!important}.btn-cancel[_ngcontent-%COMP%]:hover{background:#f1f5f9!important;border-color:#cbd5e1!important}.dark-mode[_ngcontent-%COMP%]   .btn-cancel[_ngcontent-%COMP%]:hover{background:#334155!important}.btn-cancel[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:18px;width:18px;height:18px}.action-buttons[_ngcontent-%COMP%]{display:flex;gap:12px}.btn-analyze[_ngcontent-%COMP%], .btn-confirm[_ngcontent-%COMP%]{display:flex!important;align-items:center;gap:10px;padding:12px 24px!important;border-radius:12px!important;font-size:14px!important;font-weight:600!important;transition:all .2s}.btn-analyze[_ngcontent-%COMP%]{background:linear-gradient(135deg,#059669,#10b981)!important;color:#fff!important;box-shadow:0 4px 12px #0596694d}.btn-analyze[_ngcontent-%COMP%]:hover:not(:disabled){box-shadow:0 6px 16px #05966966;transform:translateY(-2px)}.btn-analyze[_ngcontent-%COMP%]:disabled{background:#cbd5e1!important;box-shadow:none}.dark-mode[_ngcontent-%COMP%]   .btn-analyze[_ngcontent-%COMP%]:disabled{background:#475569!important}.btn-confirm.success[_ngcontent-%COMP%]{background:linear-gradient(135deg,#059669,#10b981)!important;color:#fff!important;box-shadow:0 4px 12px #0596694d}.btn-confirm.warning[_ngcontent-%COMP%]{background:linear-gradient(135deg,#d97706,#f59e0b)!important;color:#fff!important;box-shadow:0 4px 12px #d977064d}.btn-confirm[_ngcontent-%COMP%]:hover{transform:translateY(-2px)}.btn-analyze[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%], .btn-confirm[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:20px;width:20px;height:20px}.hidden[_ngcontent-%COMP%]{display:none}"]});let a=c;return a})();var $t=(()=>{let c=class c{constructor(e,t){this.dialogRef=e,this.data=t,this.isDarkMode=x(!1)}ngOnInit(){this.isDarkMode.set(document.documentElement.classList.contains("dark")),this.darkModeObserver=new MutationObserver(e=>{e.forEach(t=>{t.attributeName==="class"&&this.isDarkMode.set(document.documentElement.classList.contains("dark"))})}),this.darkModeObserver.observe(document.documentElement,{attributes:!0})}ngOnDestroy(){this.darkModeObserver?.disconnect()}onNoClick(){this.dialogRef.close("cancel")}onGenerateClick(){this.dialogRef.close("generate")}};c.\u0275fac=function(t){return new(t||c)(R(Me),R(De))},c.\u0275cmp=Z({type:c,selectors:[["app-confirm-carta-dialog"]],decls:29,vars:2,consts:[[1,"carta-dialog"],[1,"carta-header"],[1,"carta-success-badge"],[1,"carta-title"],[1,"carta-subtitle"],[1,"carta-body"],[1,"carta-preview"],[1,"carta-icon-wrapper"],[1,"carta-icon"],[1,"carta-info"],[1,"carta-info-title"],[1,"carta-info-desc"],[1,"carta-question"],[1,"carta-actions"],["mat-button","",1,"carta-btn-secondary",3,"click"],["mat-flat-button","",1,"carta-btn-primary",3,"click"]],template:function(t,i){t&1&&(r(0,"div",0)(1,"div",1)(2,"div",2)(3,"mat-icon"),l(4,"check_circle"),o()(),r(5,"h2",3),l(6,"Promesa Registrada"),o(),r(7,"p",4),l(8,"La promesa de pago se ha guardado correctamente"),o()(),r(9,"div",5)(10,"div",6)(11,"div",7)(12,"mat-icon",8),l(13,"description"),o()(),r(14,"div",9)(15,"span",10),l(16,"Carta de Acuerdo"),o(),r(17,"span",11),l(18,"Documento PDF con los t\xE9rminos del acuerdo"),o()()(),r(19,"p",12),l(20,"\xBFDesea generar la Carta de Acuerdo ahora?"),o()(),r(21,"div",13)(22,"button",14),C("click",function(){return i.onNoClick()}),l(23," M\xE1s tarde "),o(),r(24,"button",15),C("click",function(){return i.onGenerateClick()}),r(25,"mat-icon"),l(26,"download"),o(),r(27,"span"),l(28,"Generar y Descargar"),o()()()()),t&2&&xe("dark-mode",i.isDarkMode())},dependencies:[ne,we,ye,Se,ke,Ee],styles:[`.carta-dialog-panel{background:transparent!important}.carta-dialog-panel .mat-mdc-dialog-container{background:transparent!important;box-shadow:none!important}.carta-dialog-panel .mat-mdc-dialog-surface{background:transparent!important;box-shadow:none!important;overflow:visible!important}.carta-dialog{padding:28px;min-width:400px;max-width:460px;background:#fff!important;border-radius:16px;box-shadow:0 20px 40px #00000026}.carta-dialog.dark-mode{background:#1e293b!important;box-shadow:0 20px 40px #00000080}.carta-header{text-align:center;margin-bottom:24px;background:transparent!important;border:none!important;padding:0!important}.carta-success-badge{width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,#059669,#10b981);display:flex;align-items:center;justify-content:center;margin:0 auto 16px;box-shadow:0 8px 20px #0596694d}.carta-success-badge mat-icon{color:#fff!important;font-size:36px;width:36px;height:36px}.carta-title{margin:0 0 8px!important;font-size:1.35rem!important;font-weight:600!important;color:#1e293b!important}.dark-mode .carta-title{color:#f1f5f9!important}.carta-subtitle{margin:0!important;font-size:.875rem!important;color:#64748b!important}.dark-mode .carta-subtitle{color:#94a3b8!important}.carta-body{margin-bottom:24px}.carta-preview{display:flex;align-items:center;gap:16px;padding:16px;border-radius:12px;background:#f8fafc!important;border:1px solid #e2e8f0!important;margin-bottom:20px}.dark-mode .carta-preview{background:#0f172a!important;border-color:#334155!important}.carta-icon-wrapper{width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,#dbeafe,#bfdbfe);display:flex;align-items:center;justify-content:center;flex-shrink:0}.dark-mode .carta-icon-wrapper{background:linear-gradient(135deg,#3b82f633,#3b82f64d)}.carta-icon{font-size:26px;width:26px;height:26px;color:#2563eb!important}.dark-mode .carta-icon{color:#60a5fa!important}.carta-info{display:flex;flex-direction:column;gap:4px;min-width:0}.carta-info-title{font-weight:600;font-size:.95rem;color:#1e293b!important}.dark-mode .carta-info-title{color:#f1f5f9!important}.carta-info-desc{font-size:.8rem;color:#64748b!important}.dark-mode .carta-info-desc{color:#94a3b8!important}.carta-question{text-align:center;font-weight:500;margin:0!important;font-size:.95rem;color:#475569!important}.dark-mode .carta-question{color:#cbd5e1!important}.carta-actions{display:flex;gap:12px;justify-content:stretch}.carta-btn-secondary{flex:1;padding:14px 24px!important;border-radius:10px!important;font-size:14px!important;font-weight:500!important;color:#64748b!important;background:#f1f5f9!important;border:1px solid #e2e8f0!important;transition:all .2s;line-height:1.2!important;min-height:48px}.dark-mode .carta-btn-secondary{color:#94a3b8!important;background:#0f172a!important;border-color:#334155!important}.carta-btn-secondary:hover{background:#e2e8f0!important;border-color:#cbd5e1!important}.dark-mode .carta-btn-secondary:hover{background:#334155!important;border-color:#475569!important}.carta-btn-primary{flex:1;display:inline-flex!important;align-items:center;justify-content:center;gap:10px;padding:14px 28px!important;border-radius:10px!important;font-size:14px!important;font-weight:600!important;background:linear-gradient(135deg,#059669,#10b981)!important;color:#fff!important;box-shadow:0 4px 12px #0596694d;transition:all .2s;white-space:nowrap;line-height:1.2!important;min-height:48px}.carta-btn-primary:hover{box-shadow:0 6px 16px #05966966;transform:translateY(-1px)}.carta-btn-primary mat-icon{font-size:20px;width:20px;height:20px;flex-shrink:0;margin-right:2px}.carta-btn-primary span{flex-shrink:0}
`],encapsulation:2});let a=c;return a})();var Ht=(()=>{let c=class c{constructor(e){this.apiService=e,this.systemConfig={campana:{id:"CAMP-001",nombre:"Cartera Vencida Q3 2025",tipo:"Cobranza Temprana"},tipificaciones:{contacto:[{id:"CPC",codigo:"CPC",label:"Contacto con Cliente"},{id:"CTT",codigo:"CTT",label:"Contacto con Tercero"},{id:"NCL",codigo:"NCL",label:"No Contesta"},{id:"BZN",codigo:"BZN",label:"Buz\xF3n de Voz"},{id:"OCP",codigo:"OCP",label:"Ocupado"},{id:"FTN",codigo:"FTN",label:"Fuera de Tono"},{id:"NEQ",codigo:"NEQ",label:"N\xFAmero Equivocado"},{id:"TEL",codigo:"TEL",label:"Tel\xE9fono Inv\xE1lido"},{id:"CLG",codigo:"CLG",label:"Cliente Colg\xF3"},{id:"RCH",codigo:"RCH",label:"Rechaz\xF3 Llamada"}],gestion:[{id:"ACP",codigo:"ACP",label:"Acepta Compromiso de Pago",requiere_pago:!0,requiere_fecha:!0},{id:"PGR",codigo:"PGR",label:"Pago Realizado - Completo",requiere_pago:!0},{id:"PGP",codigo:"PGP",label:"Pago Parcial Realizado",requiere_pago:!0},{id:"PGT",codigo:"PGT",label:"Pago Total de Deuda",requiere_pago:!0},{id:"PPR",codigo:"PPR",label:"Pago Programado",requiere_pago:!0,requiere_fecha:!0},{id:"SRP",codigo:"SRP",label:"Solicita Refinanciamiento",requiere_seguimiento:!0},{id:"SQA",codigo:"SQA",label:"Solicita Quita o Descuento",requiere_seguimiento:!0},{id:"SCN",codigo:"SCN",label:"Solicita Congelamiento",requiere_seguimiento:!0},{id:"SPL",codigo:"SPL",label:"Solicita Ampliaci\xF3n de Plazo",requiere_seguimiento:!0},{id:"DPD",codigo:"DPD",label:"Disputa de Deuda",requiere_seguimiento:!0},{id:"NRD",codigo:"NRD",label:"No Reconoce Deuda",requiere_seguimiento:!0},{id:"DIF",codigo:"DIF",label:"Dificultad Financiera Temporal",requiere_seguimiento:!0},{id:"DSE",codigo:"DSE",label:"Desempleo",requiere_seguimiento:!0},{id:"ENF",codigo:"ENF",label:"Enfermedad/Incapacidad",requiere_seguimiento:!0},{id:"FLC",codigo:"FLC",label:"Fallecimiento del Titular",requiere_seguimiento:!0},{id:"RCL",codigo:"RCL",label:"Reclamo Registrado",requiere_seguimiento:!0},{id:"FRD",codigo:"FRD",label:"Reporte de Fraude",requiere_seguimiento:!0},{id:"NCB",codigo:"NCB",label:"Sin Capacidad de Pago",requiere_seguimiento:!0},{id:"VJE",codigo:"VJE",label:"Viaje/Fuera del Pa\xEDs",requiere_fecha:!0},{id:"SLL",codigo:"SLL",label:"Solicita Llamar Despu\xE9s",requiere_fecha:!0},{id:"NIN",codigo:"NIN",label:"No est\xE1 Interesado"},{id:"AGR",codigo:"AGR",label:"Cliente Agresivo/Hostil"},{id:"NBL",codigo:"NBL",label:"No Desea Ser Contactado"},{id:"LGL",codigo:"LGL",label:"Amenaza Legal"},{id:"CNV",codigo:"CNV",label:"Acepta Convenio de Pago",requiere_cronograma:!0,requiere_fecha:!0},{id:"CRO",codigo:"CRO",label:"Solicita Cronograma de Pagos",requiere_cronograma:!0,requiere_cuotas:!0},{id:"CPP",codigo:"CPP",label:"Convenio con Pago Parcial Inicial",requiere_cronograma:!0,requiere_monto_inicial:!0},{id:"CTT",codigo:"CTT",label:"Convenio a Plazo Total",requiere_cronograma:!0,requiere_periodicidad:!0},{id:"CCG",codigo:"CCG",label:"Convenio con Congelamiento",requiere_cronograma:!0,requiere_fecha:!0},{id:"CRF",codigo:"CRF",label:"Convenio con Refinanciamiento",requiere_cronograma:!0,requiere_seguimiento:!0},{id:"CQT",codigo:"CQT",label:"Convenio con Quita/Descuento",requiere_cronograma:!0,requiere_pago:!0},{id:"CAP",codigo:"CAP",label:"Convenio Aprobado por Supervisor",requiere_cronograma:!0,requiere_autorizacion:!0},{id:"CRC",codigo:"CRC",label:"Cliente Rechaza Convenio Propuesto",requiere_seguimiento:!0},{id:"CEV",codigo:"CEV",label:"Convenio en Evaluaci\xF3n",requiere_seguimiento:!0,requiere_fecha:!0}],motivo_no_pago:[{id:"FRE",label:"Falta de Recursos Econ\xF3micos"},{id:"DSP",label:"Desempleo Reciente"},{id:"RDS",label:"Reducci\xF3n de Salario"},{id:"EMR",label:"Emergencia M\xE9dica"},{id:"GSF",label:"Gastos Familiares Imprevistos"},{id:"OGS",label:"Otros Gastos Prioritarios"},{id:"NGC",label:"Negocio/Comercio en Crisis"},{id:"DCP",label:"Desconoce el Cargo/Producto"},{id:"IFC",label:"Inconformidad con Servicio"},{id:"FCC",label:"Fraude o Cargo no Reconocido"},{id:"OLV",label:"Olvido de Fecha de Pago"},{id:"PRG",label:"Problemas con M\xE9todo de Pago"},{id:"BNK",label:"Problemas Bancarios"},{id:"OTR",label:"Otro Motivo"}]},metodos_pago:[{id:"TDC",codigo:"TDC",label:"Tarjeta de Cr\xE9dito",icono:"\u{1F4B3}",requiere_ultimos4:!0},{id:"TDD",codigo:"TDD",label:"Tarjeta de D\xE9bito",icono:"\u{1F4B3}",requiere_ultimos4:!0},{id:"TRF",codigo:"TRF",label:"Transferencia Bancaria",icono:"\u{1F3E6}",requiere_banco:!0},{id:"DEP",codigo:"DEP",label:"Dep\xF3sito en Cuenta",icono:"\u{1F3E6}",requiere_banco:!0},{id:"EFE",codigo:"EFE",label:"Efectivo en Agencia",icono:"\u{1F4B5}",requiere_agencia:!0},{id:"CAU",codigo:"CAU",label:"Cargo Autom\xE1tico",icono:"\u{1F504}",requiere_autorizacion:!0},{id:"YPE",codigo:"YPE",label:"Yape",icono:"\u{1F4F1}",requiere_telefono:!0},{id:"PLN",codigo:"PLN",label:"Plin",icono:"\u{1F4F1}",requiere_telefono:!0},{id:"TNK",codigo:"TNK",label:"Tunki",icono:"\u{1F4F1}",requiere_telefono:!0},{id:"PGW",codigo:"PGW",label:"Pasarela Web/Link de Pago",icono:"\u{1F310}",requiere_email:!0}],bancos:["BCP - Banco de Cr\xE9dito del Per\xFA","BBVA","Interbank","Scotiabank","BanBif","Banco Pichincha","Banco Falabella","Banco Ripley","Banco Azteca","Otros"],cronograma_config:{periodicidades:[{id:"SEM",label:"Semanal",dias:7},{id:"QUI",label:"Quincenal",dias:15},{id:"MEN",label:"Mensual",dias:30},{id:"BIM",label:"Bimestral",dias:60},{id:"TRI",label:"Trimestral",dias:90}],tipos_cronograma:[{id:"FIJ",label:"Cuotas Fijas",descripcion:"Mismo monto cada cuota"},{id:"DEC",label:"Decreciente",descripcion:"Cuotas van disminuyendo"},{id:"ESC",label:"Escalonado",descripcion:"Cuotas aumentan gradualmente"},{id:"PER",label:"Personalizado",descripcion:"Montos espec\xEDficos por cuota"}],campos_requeridos:{requiere_cronograma:["numero_cuotas","periodicidad","fecha_primera_cuota"],requiere_cuotas:["numero_cuotas","monto_cuota"],requiere_monto_inicial:["monto_inicial","fecha_pago_inicial"],requiere_periodicidad:["periodicidad","dia_pago"],requiere_autorizacion:["supervisor_id","codigo_autorizacion"]},validaciones:{numero_cuotas_max:48,numero_cuotas_min:2,monto_minimo_cuota:50,porcentaje_quita_max:30,dias_gracia_max:90}}}}getSystemConfig(){return this.systemConfig}getCampaign(){return this.apiService.getActiveCampaign()||this.systemConfig.campana}getContactClassifications(){let e=this.apiService.tenantClassifications();if(e.length>0){let i=e.filter(d=>d.typification.tipoClasificacion==="CONTACT_RESULT"&&d.isEnabled).map(d=>({id:d.typification.id,codigo:d.typification.codigo,label:d.customName||d.typification.nombre}));if(i.length>0)return i}let t=this.apiService.getContactClassificationsForUI();return t.length>0?t:this.systemConfig.tipificaciones.contacto}getManagementClassifications(){let e=this.apiService.tenantClassifications();if(e.length>0){let i=e.filter(d=>d.isEnabled).map(d=>{let m=d.typification.metadataSchema?JSON.parse(d.typification.metadataSchema):{};return{id:String(d.typification.id),codigo:d.typification.codigo,label:d.customName||d.typification.nombre,requiere_pago:m.requiresPayment||!1,requiere_cronograma:m.requiresSchedule||!1,requiere_seguimiento:m.requiresFollowUp||!1,parentId:d.typification.parentTypificationId,hierarchyLevel:d.typification.nivelJerarquia,suggestsFullAmount:d.typification.suggestsFullAmount,allowsInstallmentSelection:d.typification.allowsInstallmentSelection,requiresManualAmount:d.typification.requiresManualAmount}});if(i.length>0)return i}let t=this.apiService.getManagementClassificationsForUI();return t.length>0?t:this.systemConfig.tipificaciones.gestion}getPaymentNoReasons(){return this.systemConfig.tipificaciones.motivo_no_pago}getPaymentMethods(){return this.systemConfig.metodos_pago}getBanks(){return this.systemConfig.bancos}getScheduleConfig(){return this.systemConfig.cronograma_config}getManagementClassificationById(e){return this.getManagementClassifications().find(d=>d.id==e)}};c.\u0275fac=function(t){return new(t||c)(ue(Ye))},c.\u0275prov=te({token:c,factory:c.\u0275fac,providedIn:"root"});let a=c;return a})();var jt=(()=>{let c=class c{constructor(){this.http=Fe(ie),this.apiUrl=`${X.tipificacionUrl}/customer-outputs`}saveConfiguration(e){return this.http.post(`${this.apiUrl}/config`,e)}getConfiguration(e,t){let i={tenantId:e};return t!=null&&(i.portfolioId=t),this.http.get(`${this.apiUrl}/config`,{params:i})}};c.\u0275fac=function(t){return new(t||c)},c.\u0275prov=te({token:c,factory:c.\u0275fac,providedIn:"root"});let a=c;return a})();var Gt=(()=>{let c=class c{constructor(e){this.http=e,this.apiUrl=`${X.apiUrl}/customers`}getAllCustomers(){return this.http.get(this.apiUrl)}getCustomerById(e){return this.http.get(`${this.apiUrl}/${e}`)}getCustomerByDocument(e){return this.http.get(`${this.apiUrl}/document/${e}`)}searchCustomers(e){return this.http.get(`${this.apiUrl}/search`,{params:{q:e}})}filterCustomers(e){return this.http.get(`${this.apiUrl}/filter`,{params:K({},e)})}createCustomer(e){return this.http.post(this.apiUrl,e)}updateCustomer(e,t){return this.http.put(`${this.apiUrl}/${e}`,t)}deleteCustomer(e){return this.http.delete(`${this.apiUrl}/${e}`)}getCustomerDetail(e,t){return this.http.get(`${this.apiUrl}/detail/${e}`,{params:{subPortfolioId:t.toString()}})}searchCustomerByCriteria(e,t,i){return this.http.get(`${this.apiUrl}/search-by`,{params:{tenantId:e.toString(),searchBy:t,value:i}})}searchCustomersByCriteria(e,t,i){return this.http.get(`${this.apiUrl}/search-by-multi`,{params:{tenantId:e.toString(),searchBy:t,value:i}})}searchCustomersAcrossAllTenants(e,t){return this.http.get(`${this.apiUrl}/search-all-tenants`,{params:{searchBy:e,value:t}})}getRecentCustomers(){return this.http.get(`${this.apiUrl}/recent`)}registerCustomerAccess(e){return this.http.post(`${this.apiUrl}/${e}/access`,{})}findClientByDocumento(e,t,i,d){return this.http.get(`${X.apiUrl}/client-search/find`,{params:{tenantId:e.toString(),portfolioId:t.toString(),subPortfolioId:i.toString(),documento:d}})}};c.\u0275fac=function(t){return new(t||c)(ue(ie))},c.\u0275prov=te({token:c,factory:c.\u0275fac,providedIn:"root"});let a=c;return a})();var qt=(()=>{let c=class c{constructor(e){this.http=e,this.apiUrl=`${X.apiUrl}/cartas`}verificarPromesaPendiente(e){return this.http.get(`${this.apiUrl}/verificar-promesa/${e}`)}generarCarta(e,t){return this.http.post(`${this.apiUrl}/generar/${e}?idAgente=${t}`,null,{responseType:"blob",headers:new dt({Accept:"application/pdf"})})}obtenerHistorial(e){return this.http.get(`${this.apiUrl}/historial/${e}`)}descargarPdf(e,t){let i=window.URL.createObjectURL(e),d=document.createElement("a");d.href=i,d.download=t,d.click(),window.URL.revokeObjectURL(i)}};c.\u0275fac=function(t){return new(t||c)(ue(ie))},c.\u0275prov=te({token:c,factory:c.\u0275fac,providedIn:"root"});let a=c;return a})();var ai=["dynamicFieldRendererComponent"],ce=(a,c)=>c.id,nt=(a,c)=>c.numeroCuota,ri=(a,c)=>c.field;function li(a,c){a&1&&(r(0,"div",2)(1,"div",59)(2,"div")(3,"div",60),l(4,"\xA1Gesti\xF3n Guardada!"),o(),r(5,"div",61),l(6,"Los datos se registraron correctamente"),o()()()())}function si(a,c){a&1&&N(0,"div",62)}function di(a,c){if(a&1){let n=B();r(0,"button",52),C("click",function(){let t=S(n).$implicit,i=u();return y(i.activeTab.set(t.id))}),l(1),g(2,si,1,0,"div",62),o()}if(a&2){let n=c.$implicit,e=u();P("flex-1 px-2 py-1.5 text-xs font-semibold transition-all relative "+(e.activeTab()===n.id?"text-blue-700 dark:text-blue-200 bg-blue-50 dark:bg-blue-950/50":"text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800")),s(),b(" ",n.label," "),s(),f(e.activeTab()===n.id?2:-1)}}function ci(a,c){if(a&1&&(r(0,"div",73)(1,"div",74),l(2),o(),r(3,"div",75),l(4),o()()),a&2){let n=u().$implicit,e=u(2);s(2),E(n.label),s(2),b(" ",e.formatFieldValue(e.getFieldValue(n.field),n.format)," ")}}function mi(a,c){if(a&1&&g(0,ci,5,2,"div",73),a&2){let n=c.$implicit,e=u(2);f(e.isContactField(n.field)?-1:0)}}function ui(a,c){a&1&&(r(0,"div",63),l(1," Sin campos configurados "),o())}function pi(a,c){if(a&1&&(r(0,"div",70),N(1,"lucide-angular",76),r(2,"div",67)(3,"div",53),l(4,"Alternativo"),o(),r(5,"div",77),l(6),o()()()),a&2){let n=u(2);s(),v("size",14),s(5),E(n.customerData().contacto.telefono_alternativo)}}function gi(a,c){if(a&1&&(r(0,"div",70),N(1,"lucide-angular",78),r(2,"div",67)(3,"div",53),l(4,"Trabajo"),o(),r(5,"div",77),l(6),o()()()),a&2){let n=u(2);s(),v("size",14),s(5),E(n.customerData().contacto.telefono_trabajo)}}function fi(a,c){if(a&1&&(r(0,"div",71),N(1,"lucide-angular",79),r(2,"div",67)(3,"div",80),l(4,"Email"),o(),r(5,"div",81),l(6),o()()()),a&2){let n=u(2);s(),v("size",14),s(5),E(n.customerData().contacto.email)}}function bi(a,c){if(a&1&&(r(0,"div",72),N(1,"lucide-angular",82),r(2,"div",67)(3,"div",83),l(4,"Direcci\xF3n"),o(),r(5,"div",84),l(6),o()()()),a&2){let n=u(2);s(),v("size",14),s(5),E(n.customerData().contacto.direccion)}}function hi(a,c){if(a&1&&(r(0,"div",20),W(1,mi,1,1,null,null,ce),g(3,ui,2,0,"div",63),r(4,"div",64)(5,"div",65),N(6,"lucide-angular",66),r(7,"div",67)(8,"div",68),l(9,"Principal"),o(),r(10,"div",69),l(11),o()()(),g(12,pi,7,2,"div",70),g(13,gi,7,2,"div",70),g(14,fi,7,2,"div",71),g(15,bi,7,2,"div",72),o()()),a&2){let n=u();s(),Y(n.customerOutputFields()),s(2),f(n.customerOutputFields().length===0?3:-1),s(3),v("size",14),s(5),E(n.customerData().contacto.telefono_principal),s(),f(n.customerData().contacto.telefono_alternativo?12:-1),s(),f(n.customerData().contacto.telefono_trabajo?13:-1),s(),f(n.customerData().contacto.email?14:-1),s(),f(n.customerData().contacto.direccion?15:-1)}}function xi(a,c){a&1&&(r(0,"div",21)(1,"div",85),N(2,"lucide-angular",86),o(),r(3,"p",87),l(4,"Funcionalidad en Desarrollo"),o(),r(5,"p",88),l(6," Las pautas de gesti\xF3n estar\xE1n disponibles pr\xF3ximamente "),o()()),a&2&&(s(2),v("size",24))}function _i(a,c){if(a&1&&(r(0,"option",94),l(1),o()),a&2){let n=c.$implicit;v("value",n.id),s(),re("[",n.codigo,"] ",n.label)}}function Ci(a,c){a&1&&(r(0,"div",95),l(1," Requerido "),o())}function vi(a,c){if(a&1){let n=B();r(0,"div",28)(1,"label",89),N(2,"div",90),l(3," Resultado de Contacto * "),o(),r(4,"div",91)(5,"select",92),ve("ngModelChange",function(t){S(n);let i=u();return Ce(i.managementForm.resultadoContacto,t)||(i.managementForm.resultadoContacto=t),y(t)}),C("ngModelChange",function(){S(n);let t=u();return y(t.onContactResultChange())}),r(6,"option",93),l(7,"-- Seleccionar resultado --"),o(),W(8,_i,2,3,"option",94,ce),o()(),g(10,Ci,2,0,"div",95),o()}if(a&2){let n=u();s(5),P("w-full p-2 pr-8 border rounded-lg font-semibold text-gray-700 dark:text-white appearance-none cursor-pointer transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-200 dark:focus:ring-blue-800 hover:border-blue-400 dark:hover:border-blue-600 text-xs "+(n.errors().resultadoContacto?"border-red-500 bg-red-50 dark:bg-red-950/30 dark:border-red-600":"border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-900")+" "+(n.managementForm.resultadoContacto?"bg-blue-50 dark:bg-blue-950/30 border-blue-400 dark:border-blue-600":"")),_e("ngModel",n.managementForm.resultadoContacto),s(3),Y(n.contactClassifications()),s(2),f(n.errors().resultadoContacto?10:-1)}}function Si(a,c){if(a&1&&(r(0,"span",117),l(1),o(),r(2,"span",100),l(3),o()),a&2){let n=u().$implicit,e=u(3);s(),b("S/ ",n.monto==null?null:n.monto.toFixed(2)),s(2),b("S/ ",e.getSaldoPendienteCuota(n).toFixed(2))}}function yi(a,c){if(a&1&&(r(0,"span",100),l(1),o()),a&2){let n=u().$implicit;s(),b("S/ ",(n.monto==null?null:n.monto.toFixed(2))||"0.00")}}function Pi(a,c){a&1&&(r(0,"span",112),N(1,"lucide-angular",118),o()),a&2&&(s(),v("size",10))}function Ei(a,c){a&1&&(r(0,"span",113),l(1,"Parcial"),o())}function ki(a,c){a&1&&(r(0,"span",114),N(1,"lucide-angular",119),o()),a&2&&(s(),v("size",10))}function Mi(a,c){a&1&&(r(0,"span",115),N(1,"lucide-angular",120),o()),a&2&&(s(),v("size",10))}function Di(a,c){a&1&&(r(0,"span",116),N(1,"lucide-angular",121),o()),a&2&&(s(),v("size",10))}function wi(a,c){if(a&1&&(r(0,"div",107)(1,"span",60),l(2),o(),r(3,"span",109),l(4,"|"),o(),g(5,Si,4,2)(6,yi,2,1,"span",100),r(7,"span",109),l(8,"|"),o(),r(9,"span",110),N(10,"lucide-angular",111),l(11),o(),g(12,Pi,2,1,"span",112)(13,Ei,2,0,"span",113)(14,ki,2,1,"span",114)(15,Mi,2,1,"span",115)(16,Di,2,1,"span",116),o()),a&2){let n=c.$implicit,e=u(3);s(2),b("C",n.numeroCuota),s(3),f(e.tienePagoParcial(n)?5:6),s(5),v("size",11),s(),b(" ",e.formatDate(n.dueDate)," "),s(),f(n.status==="PAGADA"||n.status==="PAGADO"||n.status==="CUMPLIDO"?12:n.status==="PARCIAL"?13:n.status==="VENCIDA"||n.status==="VENCIDO"?14:n.status==="CANCELADA"||n.status==="CANCELADO"?15:16)}}function Ii(a,c){if(a&1&&(r(0,"div",108)(1,"span",122),l(2),o(),l(3," pendiente(s) \xB7 Pr\xF3x: "),r(4,"span",122),l(5),o()()),a&2){let n=u().$implicit,e=u(2);s(2),E(n.cuotasPendientes),s(3),E(e.formatDate(n.nextDueDate))}}function Ti(a,c){if(a&1){let n=B();r(0,"div",96)(1,"div",97)(2,"div",6)(3,"div",98),N(4,"lucide-angular",99),o(),r(5,"div")(6,"div",100),l(7,"PROMESA DE PAGO ACTIVA"),o(),r(8,"div",101),l(9,"No puede registrar otra promesa"),o()()(),r(10,"div",6)(11,"button",102),C("click",function(){let t=S(n).$implicit,i=u(2);return y(i.openVoucherPaymentDialog(t))}),N(12,"lucide-angular",103),l(13," Voucher "),o(),r(14,"div",11)(15,"div",9),l(16),o(),r(17,"div",101),l(18,"Total"),o()()()(),r(19,"div",104)(20,"div",105),l(21,"DETALLE DE CUOTAS:"),o(),r(22,"div",106),W(23,wi,17,5,"div",107,nt),o(),g(25,Ii,6,2,"div",108),o()()}if(a&2){let n=c.$implicit;s(4),v("size",14),s(8),v("size",12),s(4),b("S/ ",(n.totalAmount==null?null:n.totalAmount.toFixed(2))||"0.00"),s(7),Y(n.installments),s(2),f(n.cuotasPendientes>0&&n.nextDueDate?25:-1)}}function Oi(a,c){if(a&1&&(r(0,"div",29),W(1,Ti,26,4,"div",96,ce),o()),a&2){let n=u();s(),Y(n.activePaymentSchedules())}}function Ai(a,c){if(a&1&&(r(0,"option",94),l(1),o()),a&2){let n=c.$implicit;v("value",n.id),s(),re("[",n.codigo,"] ",n.label)}}function Ni(a,c){if(a&1){let n=B();r(0,"div",126)(1,"label",127),l(2),o(),r(3,"select",92),C("ngModelChange",function(t){S(n);let i=u().$index,d=u(2);return y(d.onClassificationLevelChange(i,t))}),r(4,"option",93),l(5,"Seleccionar..."),o(),W(6,Ai,2,3,"option",94,ce),o()()}if(a&2){let n=u(),e=n.$implicit,t=n.$index,i=u(2);s(2),re(" ",i.getDynamicLevelLabel(t),"",t===0?" *":""," "),s(),P("w-full p-1.5 border rounded text-xs font-medium transition-all focus:outline-none focus:ring-1 focus:ring-blue-400 "+(i.errors().tipoGestion&&t===0?"border-red-400 bg-red-50 dark:bg-red-950/30":"border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-700 dark:text-white")+" "+(i.selectedClassifications()[t]?"border-green-400 bg-green-50 dark:bg-green-950/30":"")),v("ngModel",i.selectedClassifications()[t]),s(3),Y(e)}}function Fi(a,c){if(a&1&&g(0,Ni,8,5,"div",126),a&2){let n=c.$index,e=u(2);f(e.shouldShowLevel(n)?0:-1)}}function Ri(a,c){a&1&&(r(0,"div",125),l(1,"Seleccione una clasificaci\xF3n"),o())}function Vi(a,c){if(a&1&&(r(0,"div",30)(1,"div",123),l(2,"Clasificaci\xF3n"),o(),r(3,"div",124),W(4,Fi,1,1,null,null,rt),o(),g(6,Ri,2,0,"div",125),o()),a&2){let n=u();s(4),Y(n.hierarchyLevels()),s(2),f(n.errors().tipoGestion?6:-1)}}function Li(a,c){a&1&&(r(0,"div",31)(1,"div",128)(2,"span",129),l(3,"Cargando campos adicionales..."),o()()())}function Ui(a,c){a&1&&(r(0,"div",32)(1,"div",130)(2,"span",129),l(3,"Esta clasificaci\xF3n no tiene campos adicionales configurados"),o()()())}function zi(a,c){if(a&1){let n=B();r(0,"app-dynamic-field-renderer",131,0),C("dataChange",function(t){S(n);let i=u();return y(i.onDynamicFieldsChange(t))})("customAmountDetected",function(t){S(n);let i=u();return y(i.onCustomAmountDetected(t))}),o()}if(a&2){let n=u();v("schema",n.dynamicFieldsSchema())("externalUpdates",n.externalFieldUpdates())("selectedClassification",n.selectedClassification())("customerAmounts",n.finalPaymentAmounts())}}function Bi(a,c){a&1&&(r(0,"div",132)(1,"div",135),N(2,"lucide-angular",136),r(3,"span",137),l(4,"Verificando continuidad de promesa..."),o()()()),a&2&&(s(2),v("size",16))}function $i(a,c){if(a&1&&(r(0,"div",133)(1,"div",138)(2,"div",139),N(3,"lucide-angular",140),o(),r(4,"div")(5,"h4",141),l(6,"No Aplica Continuidad"),o(),r(7,"p",142),l(8),o()()()()),a&2){let n=u(2);s(3),v("size",20),s(5),E(n.continuidadError())}}function Hi(a,c){if(a&1&&(r(0,"div",159),l(1," Promesa venci\xF3 el: "),r(2,"span",122),l(3),o()()),a&2){let n=u(3);s(3),E(n.continuidadData().fechaVencimiento)}}function ji(a,c){if(a&1&&(r(0,"div",134)(1,"div",5)(2,"div",138)(3,"div",143),N(4,"lucide-angular",144),o(),r(5,"div")(6,"h4",145),l(7,"Continuidad de Promesa"),o(),r(8,"p",146),l(9,"El cliente tiene una promesa ca\xEDda con pagos parciales"),o()()(),r(10,"div",147),l(11," APLICA "),o()(),r(12,"div",148)(13,"div",149)(14,"div",150)(15,"div",151),l(16,"Monto Original"),o(),r(17,"div",152),l(18),$(19,"number"),o()(),r(20,"div",153)(21,"div",154),l(22,"Ya Pagado"),o(),r(23,"div",155),l(24),$(25,"number"),o()(),r(26,"div",156)(27,"div",157),l(28,"Saldo Restante"),o(),r(29,"div",158),l(30),$(31,"number"),o()()(),g(32,Hi,4,1,"div",159),o(),r(33,"div",160),N(34,"lucide-angular",161),r(35,"span"),l(36,"La nueva promesa debe ser por el saldo restante de "),r(37,"strong"),l(38),$(39,"number"),o()()()()),a&2){let n=u(2);s(4),v("size",20),s(14),b(" S/ ",H(19,7,n.continuidadData().montoOriginal,"1.2-2")," "),s(6),b(" S/ ",H(25,10,n.continuidadData().montoPagado,"1.2-2")," "),s(6),b(" S/ ",H(31,13,n.continuidadData().saldoRestante,"1.2-2")," "),s(2),f(n.continuidadData().fechaVencimiento?32:-1),s(2),v("size",14),s(4),b("S/ ",H(39,16,n.continuidadData().saldoRestante,"1.2-2"))}}function Gi(a,c){if(a&1&&(g(0,Bi,5,1,"div",132),g(1,$i,9,2,"div",133),g(2,ji,40,19,"div",134)),a&2){let n=u();f(n.isLoadingContinuidad()?0:-1),s(),f(!n.isLoadingContinuidad()&&n.continuidadError()?1:-1),s(),f(!n.isLoadingContinuidad()&&n.continuidadData()?2:-1)}}function qi(a,c){a&1&&(r(0,"div",34)(1,"div",162)(2,"span",137),l(3,"Cargando cronogramas pendientes..."),o()()())}function Wi(a,c){if(a&1&&(r(0,"div",175)(1,"div",6)(2,"span",176),l(3),o(),r(4,"span",177),l(5),o()(),r(6,"span",178),l(7),$(8,"number"),o()()),a&2){let n=u().$implicit,e=u(3);s(3),b("Cuota #",n.installmentNumber),s(2),b("Vence: ",e.formatDate(n.dueDate)),s(2),b("S/ ",H(8,3,n.amount,"1.2-2"))}}function Yi(a,c){if(a&1&&g(0,Wi,9,6,"div",175),a&2){let n=c.$index;f(n<3?0:-1)}}function Xi(a,c){if(a&1&&(r(0,"div",170),l(1),o()),a&2){let n=u().$implicit,e=u(2);s(),b(" + ",e.getPendingInstallments(n).length-3," cuotas m\xE1s ")}}function Qi(a,c){if(a&1){let n=B();r(0,"button",179),C("click",function(){S(n);let t=u(3);return y(t.applyNextInstallmentPayment())}),l(1," Usar Pr\xF3xima Cuota "),o()}}function Ki(a,c){if(a&1){let n=B();r(0,"button",180),C("click",function(){S(n);let t=u(3);return y(t.applyFullSchedulePayment())}),l(1),$(2,"number"),o()}if(a&2){let n=u().$implicit,e=u(2);s(),b(" Pagar Todo (S/ ",H(2,1,e.calculatePendingAmount(n),"1.2-2"),") ")}}function Ji(a,c){if(a&1&&(r(0,"div",166)(1,"div",5)(2,"div",6)(3,"div",164),l(4),o(),r(5,"div",167),l(6," ACTIVO "),o()(),r(7,"div",164),l(8),$(9,"number"),o()(),r(10,"div",168)(11,"div",169),l(12,"Cuotas Pendientes"),o(),W(13,Yi,1,1,null,null,ce),g(15,Xi,2,1,"div",170),o(),r(16,"div",171),g(17,Qi,2,0,"button",172),g(18,Ki,3,4,"button",173),o(),r(19,"div",174)(20,"span"),l(21,"El pago se aplicar\xE1 autom\xE1ticamente a las cuotas pendientes en orden de vencimiento"),o()()()),a&2){let n,e,t=c.$implicit,i=u(2);s(4),b(" ",t.scheduleType||"CRONOGRAMA"," "),s(4),b(" S/ ",H(9,5,t.totalAmount,"1.2-2")," "),s(5),Y(i.getPendingInstallments(t)),s(2),f(i.getPendingInstallments(t).length>3?15:-1),s(2),f(((n=i.selectedClassification())==null?null:n.allowsInstallmentSelection)===!0?17:-1),s(),f(((e=i.selectedClassification())==null?null:e.suggestsFullAmount)===!0?18:-1)}}function Zi(a,c){if(a&1&&(r(0,"div",35)(1,"div",5)(2,"div",6),N(3,"div",163),r(4,"div")(5,"h4",164),l(6,"Cronograma Activo Detectado"),o(),r(7,"p",165),l(8),o()()()(),W(9,Ji,22,8,"div",166,ce),o()),a&2){let n=u();s(8),b("Cliente tiene ",n.activeSchedules().length," cronograma(s) pendiente(s)"),s(),Y(n.activeSchedules())}}function eo(a,c){if(a&1&&(r(0,"span",194),l(1,"Parcial"),o()),a&2){let n,e=u().$implicit,t=u(3);P(((n=t.selectedInstallmentForCancellation())==null?null:n.numeroCuota)===e.numeroCuota?"bg-green-400 text-white":"bg-amber-100 text-amber-700 dark:bg-amber-900/50 dark:text-amber-300")}}function to(a,c){if(a&1&&(r(0,"span",195),l(1),o(),r(2,"span",193),l(3),o()),a&2){let n=u().$implicit,e=u(3);s(),b("S/ ",n.monto==null?null:n.monto.toFixed(2)),s(2),b("S/ ",e.getSaldoPendienteCuota(n).toFixed(2))}}function no(a,c){if(a&1&&(r(0,"span",193),l(1),o()),a&2){let n=u().$implicit;s(),b("S/ ",(n.monto==null?null:n.monto.toFixed(2))||"0.00")}}function io(a,c){if(a&1){let n=B();r(0,"label",189)(1,"div",138)(2,"input",190),C("change",function(){let t=S(n).$implicit,i=u(3);return y(i.onSelectCuotaForCancellation(t))}),o(),r(3,"div")(4,"span",100),l(5),o(),r(6,"span",191),l(7),o(),g(8,eo,2,2,"span",192),o()(),r(9,"div",11),g(10,to,4,2)(11,no,2,1,"span",193),o()()}if(a&2){let n,e,t,i=c.$implicit,d=u(3);P(((n=d.selectedInstallmentForCancellation())==null?null:n.numeroCuota)===i.numeroCuota?"bg-green-700 text-white shadow-md dark:bg-green-500":"bg-white dark:bg-gray-800 hover:bg-green-100 dark:hover:bg-green-900/30 border border-green-200 dark:border-green-700"),s(2),v("value",i)("checked",((e=d.selectedInstallmentForCancellation())==null?null:e.numeroCuota)===i.numeroCuota),s(3),b("Cuota ",i.numeroCuota),s(),P(((t=d.selectedInstallmentForCancellation())==null?null:t.numeroCuota)===i.numeroCuota?"text-green-100":"text-gray-500 dark:text-gray-400"),s(),b(" Vence: ",d.formatDate(i.dueDate)," "),s(),f(d.tienePagoParcial(i)?8:-1),s(2),f(d.tienePagoParcial(i)?10:11)}}function oo(a,c){if(a&1&&(r(0,"div",48),W(1,io,12,10,"label",188,nt),o()),a&2){let n=u(2);s(),Y(n.pendingInstallmentsForCancellation())}}function ao(a,c){if(a&1&&(r(0,"div",199)(1,"div",138)(2,"span",201),l(3,"\u2717"),o(),r(4,"div")(5,"span",202),l(6),o(),r(7,"span",203),l(8),o()()(),r(9,"span",204),l(10),o()()),a&2){let n=c.$implicit,e=u(3);s(6),b("Cuota ",n.numeroCuota),s(2),b(" Venci\xF3: ",e.formatDate(n.dueDate)," "),s(2),b("S/ ",(n.monto==null?null:n.monto.toFixed(2))||"0.00")}}function ro(a,c){if(a&1&&(r(0,"div",184)(1,"div",196)(2,"span",197),l(3,"\u26D4"),o(),r(4,"span",198),l(5,"CUOTAS VENCIDAS (No se pueden cancelar)"),o()(),r(6,"div",168),W(7,ao,11,3,"div",199,nt),o(),r(9,"div",200),l(10," La fecha de pago ya pas\xF3. Estas cuotas ser\xE1n marcadas como promesa rota. "),o()()),a&2){let n=u(2);s(7),Y(n.overdueInstallments())}}function lo(a,c){a&1&&(r(0,"div",185)(1,"span"),l(2,"\u{1F6AB}"),o(),r(3,"span"),l(4,"No hay cuotas disponibles para cancelar. Todas las cuotas est\xE1n vencidas."),o()())}function so(a,c){a&1&&(r(0,"div",186),N(1,"lucide-angular",119),r(2,"span"),l(3,"Debe seleccionar una cuota para registrar la cancelaci\xF3n"),o()()),a&2&&(s(),v("size",14))}function co(a,c){if(a&1&&(r(0,"span",56),N(1,"lucide-angular",119),r(2,"span")(3,"strong"),l(4,"Pago parcial:"),o(),l(5),o()()),a&2){let n,e=u(4);s(),v("size",14),s(4),b(" La cuota quedar\xE1 con saldo pendiente de S/ ",(((n=e.selectedInstallmentForCancellation())==null?null:n.monto)-e.montoPagoEditable()).toFixed(2))}}function mo(a,c){if(a&1&&(r(0,"span",56)(1,"span"),l(2,"\u2139\uFE0F"),o(),r(3,"span")(4,"strong"),l(5,"Pago mayor:"),o(),l(6),o()()),a&2){let n,e=u(4);s(6),b(" El excedente de S/ ",(e.montoPagoEditable()-((n=e.selectedInstallmentForCancellation())==null?null:n.monto)).toFixed(2)," se aplicar\xE1 a las siguientes cuotas")}}function uo(a,c){if(a&1&&(r(0,"div",215),g(1,co,6,2,"span",56)(2,mo,7,1,"span",56),o()),a&2){let n,e,t=u(3);P(t.montoPagoEditable()<((n=t.selectedInstallmentForCancellation())==null?null:n.monto)?"bg-amber-50 dark:bg-amber-900/20 text-amber-700 dark:text-amber-300 border border-amber-200 dark:border-amber-700":"bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 border border-blue-200 dark:border-blue-700"),s(),f(t.montoPagoEditable()<((e=t.selectedInstallmentForCancellation())==null?null:e.monto)?1:2)}}function po(a,c){if(a&1){let n=B();r(0,"div",187)(1,"div",196),N(2,"lucide-angular",205),r(3,"span",206),l(4,"Datos del Pago (editables)"),o()(),r(5,"div",207)(6,"div")(7,"label",208),l(8,"Monto Pagado"),o(),r(9,"div",91)(10,"span",209),l(11,"S/"),o(),r(12,"input",210),C("input",function(t){S(n);let i=u(2);return y(i.onMontoPagoChange(t))}),o()(),r(13,"p",211),l(14),o()(),r(15,"div")(16,"label",208),l(17,"Fecha del Pago"),o(),r(18,"input",212),C("input",function(t){S(n);let i=u(2);return y(i.onFechaPagoChange(t))}),o(),r(19,"p",213),l(20," Por defecto: hoy "),o()()(),g(21,uo,3,3,"div",214),o()}if(a&2){let n,e,t=u(2);s(2),v("size",14),s(10),v("value",t.montoPagoEditable()),s(2),b(" Pendiente: S/ ",t.tienePagoParcial(t.selectedInstallmentForCancellation())?t.getSaldoPendienteCuota(t.selectedInstallmentForCancellation()).toFixed(2):(n=t.selectedInstallmentForCancellation())==null||n.monto==null?null:n.monto.toFixed(2)," "),s(4),v("value",t.fechaPagoEditable()),s(3),f(t.montoPagoEditable()!==((e=t.selectedInstallmentForCancellation())==null?null:e.monto)?21:-1)}}function go(a,c){if(a&1&&(r(0,"div",36)(1,"div",6)(2,"span",181),l(3,"\u{1F4B0}"),o(),r(4,"div")(5,"h4",182),l(6,"Seleccionar Cuota a Cancelar"),o(),r(7,"p",183),l(8,"Elija qu\xE9 cuota de la promesa de pago est\xE1 cancelando"),o()()(),g(9,oo,3,0,"div",48),g(10,ro,11,0,"div",184),g(11,lo,5,0,"div",185)(12,so,4,1,"div",186),g(13,po,22,5,"div",187),o()),a&2){let n=u();s(9),f(n.pendingInstallmentsForCancellation().length>0?9:-1),s(),f(n.overdueInstallments().length>0?10:-1),s(),f(n.pendingInstallmentsForCancellation().length===0&&n.overdueInstallments().length>0?11:!n.selectedInstallmentForCancellation()&&n.pendingInstallmentsForCancellation().length>0?12:-1),s(2),f(n.selectedInstallmentForCancellation()?13:-1)}}function fo(a,c){a&1&&l(0," Comprobante Subido ")}function bo(a,c){a&1&&l(0," \u{1F4E4} Subir Comprobante ")}function ho(a,c){if(a&1&&(r(0,"p")(1,"strong"),l(2,"Monto detectado:"),o(),l(3),$(4,"number"),o()),a&2){let n,e=u(3);s(3),b(" S/ ",H(4,1,(n=e.uploadedComprobante())==null||n.ocrResult==null?null:n.ocrResult.monto,"1.2-2"))}}function xo(a,c){if(a&1&&(r(0,"p")(1,"strong"),l(2,"Banco:"),o(),l(3),o()),a&2){let n,e=u(3);s(3),b(" ",(n=e.uploadedComprobante())==null||n.ocrResult==null?null:n.ocrResult.banco)}}function _o(a,c){if(a&1){let n=B();r(0,"div",217)(1,"p",218),l(2),o(),g(3,ho,5,4,"p"),g(4,xo,4,1,"p"),r(5,"button",219),C("click",function(){S(n);let t=u(2);return y(t.uploadedComprobante.set(null))}),l(6," Quitar comprobante "),o()()}if(a&2){let n,e,t,i=u(2);s(2),E((n=i.uploadedComprobante())==null?null:n.mensaje),s(),f(!((e=i.uploadedComprobante())==null||e.ocrResult==null)&&e.ocrResult.monto?3:-1),s(),f(!((t=i.uploadedComprobante())==null||t.ocrResult==null)&&t.ocrResult.banco?4:-1)}}function Co(a,c){if(a&1){let n=B();r(0,"div",37)(1,"div",5)(2,"div",6)(3,"span",181),l(4,"\u{1F4CE}"),o(),r(5,"div")(6,"h4",164),l(7,"Comprobante de Pago"),o(),r(8,"p",165),l(9,"Opcional: Sube una imagen del voucher para validaci\xF3n OCR"),o()()(),r(10,"button",216),C("click",function(){S(n);let t=u();return y(t.openComprobanteUploadDialog())}),g(11,fo,1,0)(12,bo,1,0),o()(),g(13,_o,7,3,"div",217),o()}if(a&2){let n=u();s(10),P(n.uploadedComprobante()?"bg-green-700 hover:bg-green-800 text-white dark:bg-green-500 dark:hover:bg-green-600":"bg-purple-700 hover:bg-purple-800 text-white dark:bg-purple-600 dark:hover:bg-purple-700"),s(),f(n.uploadedComprobante()?11:12),s(2),f(n.uploadedComprobante()?13:-1)}}function vo(a,c){a&1&&l(0," Guardando... ")}function So(a,c){a&1&&l(0," Guardar Gesti\xF3n ")}function yo(a,c){if(a&1&&(r(0,"div",221)(1,"span",222),l(2),o(),r(3,"span",223),l(4),o()()),a&2){let n=c.$implicit,e=c.$index,t=u(2);P(t.getAmountRowClass(e)),s(),v("ngClass",t.themeService.isDarkMode()?"text-red-300":"text-red-800"),s(),E(n.label),s(),v("ngClass",t.themeService.isDarkMode()?"text-red-300":"text-red-800"),s(),b(" ",t.formatCurrency(n.value)," ")}}function Po(a,c){if(a&1&&(r(0,"div",48),W(1,yo,5,6,"div",220,ri),o()),a&2){let n=u();s(),Y(n.clientAmountFields())}}function Eo(a,c){if(a&1&&(r(0,"span",53),l(1),o()),a&2){let n=u();s(),re("(",n.historialGestionesFiltrado().length,"/",n.historialGestiones().length,")")}}function ko(a,c){if(a&1&&(r(0,"span",53),l(1),o()),a&2){let n=u();s(),re("(",n.historialHistorico().length,"/",n.historialHistoricoTotalElements(),")")}}function Mo(a,c){if(a&1){let n=B();r(0,"div",56)(1,"button",52),C("click",function(){S(n);let t=u();return y(t.historialFilter.set("TODOS"))}),l(2," Todos "),o(),r(3,"button",52),C("click",function(){S(n);let t=u();return y(t.historialFilter.set("CD"))}),l(4," [CD] "),o(),r(5,"button",52),C("click",function(){S(n);let t=u();return y(t.historialFilter.set("CI"))}),l(6," [CI] "),o(),r(7,"button",224),C("click",function(){S(n);let t=u();return y(t.loadManagementHistory())}),r(8,"span"),l(9,"\u21BB"),o()()()}if(a&2){let n=u();s(),P("px-2 py-0.5 text-xs rounded transition-colors "+(n.historialFilter()==="TODOS"?"bg-blue-600 text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600")),s(2),P("px-2 py-0.5 text-xs rounded transition-colors "+(n.historialFilter()==="CD"?"bg-green-600 text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600")),s(2),P("px-2 py-0.5 text-xs rounded transition-colors "+(n.historialFilter()==="CI"?"bg-amber-600 text-white":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600"))}}function Do(a,c){if(a&1){let n=B();r(0,"div",6)(1,"button",26),C("click",function(){S(n);let t=u();return y(t.cambiarPaginaHistorico("anterior"))}),l(2," \u2190 Ant "),o(),r(3,"span",53),l(4),o(),r(5,"button",26),C("click",function(){S(n);let t=u();return y(t.cambiarPaginaHistorico("siguiente"))}),l(6," Sig \u2192 "),o(),r(7,"button",225),C("click",function(){S(n);let t=u();return y(t.loadHistorialHistorico(t.historialHistoricoPage()))}),r(8,"span"),l(9,"\u21BB"),o()()()}if(a&2){let n=u();s(),P("px-2 py-0.5 text-xs rounded transition-colors "+(n.historialHistoricoPage()===0||n.historialHistoricoLoading()?"bg-slate-100 dark:bg-slate-800 text-slate-400 dark:text-slate-600 cursor-not-allowed":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600")),v("disabled",n.historialHistoricoPage()===0||n.historialHistoricoLoading()),s(3),re(" P\xE1g ",n.historialHistoricoPage()+1," de ",n.historialHistoricoTotalPages()," "),s(),P("px-2 py-0.5 text-xs rounded transition-colors "+(n.historialHistoricoPage()>=n.historialHistoricoTotalPages()-1||n.historialHistoricoLoading()?"bg-slate-100 dark:bg-slate-800 text-slate-400 dark:text-slate-600 cursor-not-allowed":"bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600")),v("disabled",n.historialHistoricoPage()>=n.historialHistoricoTotalPages()-1||n.historialHistoricoLoading())}}function wo(a,c){a&1&&(r(0,"div",226),l(1," Sin gestiones registradas para este cliente "),o())}function Io(a,c){a&1&&(r(0,"div",226),l(1," No hay gestiones con el filtro seleccionado "),o())}function To(a,c){if(a&1&&(r(0,"span",242),l(1),$(2,"number"),o()),a&2){let n=u().$implicit;s(),b("S/ ",H(2,1,n.montoPromesa,"1.2-2"))}}function Oo(a,c){a&1&&(r(0,"span",243),l(1,"-"),o())}function Ao(a,c){if(a&1&&(r(0,"span"),l(1),o()),a&2){let n=u().$implicit;P("px-1.5 py-0.5 rounded text-xs font-semibold "+(n.estadoPago==="PAGADA"?"bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300":n.estadoPago==="PENDIENTE"?"bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300":n.estadoPago==="VENCIDA"?"bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300":n.estadoPago==="PARCIAL"?"bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300":"bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300")),s(),b(" ",n.estadoPagoDisplay," ")}}function No(a,c){a&1&&(r(0,"span",243),l(1,"-"),o())}function Fo(a,c){if(a&1&&(r(0,"tr",233)(1,"td",234),l(2),o(),r(3,"td",235),l(4),o(),r(5,"td",236)(6,"span",237),l(7),o()(),r(8,"td",238),l(9),o(),r(10,"td",239),l(11),o(),r(12,"td",240)(13,"span"),l(14),o()(),r(15,"td",240)(16,"span"),l(17),o()(),r(18,"td",241),g(19,To,3,4,"span",242)(20,Oo,2,0,"span",243),o(),r(21,"td",244),g(22,Ao,2,3,"span",18)(23,No,2,0,"span",243),o()()),a&2){let n=c.$implicit;s(2),E(n.fecha),s(),v("title",n.nombreAgente),s(),E(n.nombreAgente),s(2),v("title",n.tipificacionCompleta),s(),b(" ",n.tipificacionCompleta," "),s(2),E(n.telefono||"-"),s(),v("title",n.observacion),s(),b(" ",n.observacion||"-"," "),s(2),P("px-1.5 py-0.5 rounded text-xs font-semibold "+(n.canal!=null&&n.canal.includes("SALIENTE")?"bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300":n.canal!=null&&n.canal.includes("ENTRANTE")?"bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300":n.canal==="WHATSAPP"?"bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300":n.canal==="SMS"?"bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300":"bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300")),s(),b(" ",n.canalDisplay," "),s(2),P("px-1.5 py-0.5 rounded text-xs font-semibold "+(n.metodo==="GESTION_MANUAL"?"bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300":n.metodo==="GESTION_PROGRESIVO"?"bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300":n.metodo==="GESTION_PREDICTIVO"?"bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300":"bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300")),s(),b(" ",n.metodoDisplay," "),s(2),f(n.montoPromesa&&n.montoPromesa>0?19:20),s(3),f(n.estadoPago?22:23)}}function Ro(a,c){if(a&1&&(r(0,"table",227)(1,"thead",228)(2,"tr",229)(3,"th",230),l(4,"Fecha"),o(),r(5,"th",230),l(6,"Agente"),o(),r(7,"th",230),l(8,"Tipificaci\xF3n"),o(),r(9,"th",230),l(10,"Tel\xE9fono"),o(),r(11,"th",230),l(12,"Observaci\xF3n"),o(),r(13,"th",230),l(14,"Canal"),o(),r(15,"th",230),l(16,"M\xE9todo"),o(),r(17,"th",231),l(18,"Monto Promesa"),o(),r(19,"th",232),l(20,"Estado Pago"),o()()(),r(21,"tbody"),W(22,Fo,24,16,"tr",233,ce),o()()),a&2){let n=u(2);s(22),Y(n.historialGestionesFiltrado())}}function Vo(a,c){if(a&1&&g(0,wo,2,0,"div",226)(1,Io,2,0,"div",226)(2,Ro,24,0,"table",227),a&2){let n=u();f(n.historialGestiones().length===0?0:n.historialGestionesFiltrado().length===0?1:2)}}function Lo(a,c){a&1&&(r(0,"div",226)(1,"span",245),l(2,"Cargando historial hist\xF3rico..."),o()())}function Uo(a,c){a&1&&(r(0,"div",226),l(1," Sin gestiones hist\xF3ricas para este cliente "),o())}function zo(a,c){if(a&1&&(r(0,"span",242),l(1),$(2,"number"),o()),a&2){let n=u().$implicit;s(),b("S/ ",H(2,1,n.montoPromesa,"1.2-2"))}}function Bo(a,c){a&1&&(r(0,"span",243),l(1,"-"),o())}function $o(a,c){if(a&1&&(r(0,"span"),l(1),o()),a&2){let n=u().$implicit;P("px-1.5 py-0.5 rounded text-xs font-semibold "+(n.estadoPago==="PAGADA"?"bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300":n.estadoPago==="PENDIENTE"?"bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300":n.estadoPago==="VENCIDA"?"bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300":n.estadoPago==="PARCIAL"?"bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300":"bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300")),s(),b(" ",n.estadoPagoDisplay," ")}}function Ho(a,c){a&1&&(r(0,"span",243),l(1,"-"),o())}function jo(a,c){if(a&1&&(r(0,"tr",247)(1,"td",234),l(2),o(),r(3,"td",235),l(4),o(),r(5,"td",236)(6,"span",248),l(7),o()(),r(8,"td",238),l(9),o(),r(10,"td",239),l(11),o(),r(12,"td",240)(13,"span"),l(14),o()(),r(15,"td",240)(16,"span"),l(17),o()(),r(18,"td",241),g(19,zo,3,4,"span",242)(20,Bo,2,0,"span",243),o(),r(21,"td",244),g(22,$o,2,3,"span",18)(23,Ho,2,0,"span",243),o()()),a&2){let n=c.$implicit;s(2),E(n.fecha),s(),v("title",n.nombreAgente),s(),E(n.nombreAgente),s(2),v("title",n.tipificacionCompleta),s(),b(" ",n.tipificacionCompleta," "),s(2),E(n.telefono||"-"),s(),v("title",n.observacion),s(),b(" ",n.observacion||"-"," "),s(2),P("px-1.5 py-0.5 rounded text-xs font-semibold "+(n.canal!=null&&n.canal.includes("SALIENTE")?"bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300":n.canal!=null&&n.canal.includes("ENTRANTE")?"bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300":n.canal==="WHATSAPP"?"bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300":n.canal==="SMS"?"bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300":"bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300")),s(),b(" ",n.canalDisplay," "),s(2),P("px-1.5 py-0.5 rounded text-xs font-semibold "+(n.metodo==="GESTION_MANUAL"?"bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300":n.metodo==="GESTION_PROGRESIVO"?"bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300":n.metodo==="GESTION_PREDICTIVO"?"bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300":"bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300")),s(),b(" ",n.metodoDisplay," "),s(2),f(n.montoPromesa&&n.montoPromesa>0?19:20),s(3),f(n.estadoPago?22:23)}}function Go(a,c){if(a&1&&(r(0,"table",227)(1,"thead",246)(2,"tr",229)(3,"th",230),l(4,"Fecha"),o(),r(5,"th",230),l(6,"Agente"),o(),r(7,"th",230),l(8,"Tipificaci\xF3n"),o(),r(9,"th",230),l(10,"Tel\xE9fono"),o(),r(11,"th",230),l(12,"Observaci\xF3n"),o(),r(13,"th",230),l(14,"Canal"),o(),r(15,"th",230),l(16,"M\xE9todo"),o(),r(17,"th",231),l(18,"Monto Promesa"),o(),r(19,"th",232),l(20,"Estado Pago"),o()()(),r(21,"tbody"),W(22,jo,24,16,"tr",247,ce),o()()),a&2){let n=u(2);s(22),Y(n.historialHistorico())}}function qo(a,c){if(a&1&&g(0,Lo,3,0,"div",226)(1,Uo,2,0,"div",226)(2,Go,24,0,"table",227),a&2){let n=u();f(n.historialHistoricoLoading()?0:n.historialHistorico().length===0?1:2)}}function Wo(a,c){if(a&1){let n=B();r(0,"div",58)(1,"div",249)(2,"div",250)(3,"div",138)(4,"div")(5,"h2",251),l(6,"Cronograma de Pagos"),o(),r(7,"p",61),l(8),o()()(),r(9,"button",252),C("click",function(){S(n);let t=u();return y(t.closeScheduleDetail())}),o()(),r(10,"div",253),N(11,"app-payment-schedule-view",254),o(),r(12,"div",255)(13,"button",256),C("click",function(){S(n);let t=u();return y(t.closeScheduleDetail())}),l(14," Cerrar "),o()()()()}if(a&2){let n=u();s(8),b("Gesti\xF3n ",n.scheduleManagementId()),s(3),v("managementId",n.scheduleManagementId())}}var wr=(()=>{let c=class c{constructor(e,t,i,d,m,p,h,_,F,O,G,A,V,j,Q,se,ee,q,me,pe,Ne){this.systemConfigService=e,this.managementService=t,this.paymentScheduleService=i,this.themeService=d,this.classificationService=m,this.typificationV2Service=p,this.apiSystemConfigService=h,this.customerOutputConfigService=_,this.customerService=F,this.router=O,this.route=G,this.http=A,this.sipService=V,this.agentService=j,this.agentStatusService=Q,this.authService=se,this.autorizacionService=ee,this.recordatoriosService=q,this.dialog=me,this.comprobanteService=pe,this.cartaAcuerdoService=Ne,this.callActive=x(!1),this.callDuration=x(0),this.saving=x(!1),this.showScheduleDetail=x(!1),this.scheduleManagementId=x(null),this.showOutputSelector=!1,this.errors=x({}),this.showSuccess=x(!1),this.animateEntry=x(!0),this.activeTab=x("cliente"),this.isTipifying=x(!1),this.colorIndicador=x("verde"),this.excedeTiempoMaximo=x(!1),this.historialGestiones=x([]),this.historialFilter=x("TODOS"),this.historialExpanded=x(!1),this.historialTabActivo=x("actual"),this.historialHistorico=x([]),this.historialHistoricoPage=x(0),this.historialHistoricoTotalPages=x(0),this.historialHistoricoTotalElements=x(0),this.historialHistoricoLoading=x(!1),this.historialGestionesFiltrado=z(()=>{let M=this.historialFilter(),L=this.historialGestiones();return M==="TODOS"?L:L.filter(w=>{let k=w.tipificacionCompleta?.toUpperCase()||"";return M==="CI"?k.includes("[CI]")||k.includes("CONTACTO INDIRECTO"):M==="CD"?k.includes("[CD]")||k.includes("CONTACTO DIRECTO"):!0})}),this.tenants=[],this.portfolios=[],this.testDocument="",this.testPhone="",this.customerOutputFields=x([]),this.campaign=z(()=>this.systemConfigService.getCampaign()),this.contactClassifications=z(()=>this.systemConfigService.getContactClassifications()),this.managementClassifications=z(()=>this.apiSystemConfigService.getManagementClassificationsForUI()),this.managementClassificationsHierarchical=z(()=>{let M=this.managementClassifications(),L=new Map,w=new Map;M.forEach(T=>{let D=String(T.id);L.set(D,T),w.set(D,[])}),M.forEach(T=>{if(T.parentId){let D=String(T.parentId),U=w.get(D);U&&U.push(T)}});let k=(T,D=0)=>{let U=[];return T.forEach(J=>{U.push(ge(K({},J),{indentLevel:D,displayLabel:"  ".repeat(D)+(D>0?"\u2514\u2500 ":"")+`[${J.codigo}] ${J.label}`}));let de=String(J.id),fe=w.get(de)||[];fe.length>0&&U.push(...k(fe,D+1))}),U},I=M.filter(T=>!T.parentId);return k(I,0)}),this.paymentMethods=z(()=>this.systemConfigService.getPaymentMethods()),this.scheduleTypes=z(()=>this.systemConfigService.getScheduleConfig().tipos_cronograma),this.periodicities=z(()=>this.systemConfigService.getScheduleConfig().periodicidades),this.customerPaymentAmounts=z(()=>{let M=this.rawClientData(),L=this.enabledPaymentOptions(),w=this.hasPaymentOptionsConfig(),k=this.montoCabeceras();if(!M||Object.keys(M).length===0)return console.log("[PAYMENT] No raw client data available"),[];let I=new Map;for(let D of k)I.set(D.codigo.toLowerCase(),D.nombre);let T=[];if(w){for(let D of L){if(D.codigoOpcion==="personalizado"){T.push({label:"Otro monto",value:-1,field:"personalizado",generaCartaAcuerdo:D.generaCartaAcuerdo||!1});continue}let U=D.campoTablaDinamica;if(!U)continue;let J=Object.keys(M).find(Qe=>Qe.toLowerCase()===U.toLowerCase());if(!J)continue;let de=M[J],fe=typeof de=="number"?de:parseFloat(String(de));if(!isNaN(fe)&&fe>=0){let Qe=I.get(U.toLowerCase())||D.labelOpcion||this.formatFieldLabel(U);T.push({label:Qe,value:fe,field:U,restriccionFecha:D.restriccionFecha||"SIN_RESTRICCION",generaCartaAcuerdo:D.generaCartaAcuerdo||!1})}}console.log("[PAYMENT] Amounts from CONFIG (enabled only):",T.length)}else if(k.length>0){for(let D of k){let U=D.codigo.toLowerCase(),J=M[U]??M[D.codigo];if(J!=null){let de=typeof J=="number"?J:parseFloat(J);!isNaN(de)&&de>=0&&T.push({label:D.nombre,value:de,field:U,generaCartaAcuerdo:!1})}}console.log("[PAYMENT] Amounts FALLBACK (from cabeceras):",T.length)}else console.log("[PAYMENT] No config and no cabeceras - showing empty");return T.sort((D,U)=>D.field==="personalizado"?1:U.field==="personalizado"?-1:U.value-D.value),T}),this.tabs=[{id:"cliente",label:"Cliente",icon:"user"},{id:"pautas",label:"Pautas",icon:"book-open"}],this.managementForm={resultadoContacto:"",tipoGestion:"",clasificacionNivel1:"",clasificacionNivel2:"",clasificacionNivel3:"",motivoNoPago:"",metodoPago:"",montoPago:"",fechaCompromiso:"",horaCompromiso:"",ultimos4Tarjeta:"",bancoSeleccionado:"",observaciones:"",notasPrivadas:""},this.selectedClassifications=x([]),this.dynamicFields=x([]),this.dynamicFieldValues=x({}),this.isLoadingDynamicFields=x(!1),this.isLeafClassification=x(!1),this.dynamicFieldsSchema=x(null),this.externalFieldUpdates=x({}),this.activeSchedules=x([]),this.isLoadingSchedules=x(!1),this.showScheduleHelper=x(!1),this.selectedClassification=z(()=>{let M=this.selectedClassifications();if(M.length===0)return null;let L=M[M.length-1];if(!L)return null;let k=this.managementClassifications().find(I=>String(I.id)===String(L));return k&&(console.log("[DEBUG] Selected typification:",k),console.log("[DEBUG] suggestsFullAmount:",k.suggestsFullAmount),console.log("[DEBUG] allowsInstallmentSelection:",k.allowsInstallmentSelection),console.log("[DEBUG] requiresManualAmount:",k.requiresManualAmount)),k||null}),this.isFormValid=z(()=>{if(this.usesHierarchicalClassifications()){let w=this.selectedClassifications();if(w.length===0||!w[w.length-1])return console.log("[isFormValid] \u274C No hay clasificaci\xF3n seleccionada"),!1;let k=w[w.length-1];if(this.managementClassifications().some(D=>D.parentId&&Number(D.parentId)===Number(k)))return console.log("[isFormValid] \u274C A\xFAn hay niveles por seleccionar, lastSelectedId:",k),!1;console.log("[isFormValid] \u2705 Clasificaci\xF3n completa:",w)}else if(!this.managementForm.resultadoContacto)return!1;let M=this.dynamicFieldsSchema(),L=this.dynamicFieldValues();if(console.log("[isFormValid] Schema:",M),console.log("[isFormValid] Dynamic Values:",L),M&&M.fields&&M.fields.length>0){for(let w of M.fields)if(w.required){let k=L[w.id];if(console.log(`[isFormValid] Campo '${w.id}' (required=${w.required}): valor='${k}'`),k==null||k==="")return console.log(`[isFormValid] \u274C Campo requerido '${w.id}' est\xE1 vac\xEDo`),!1;if(w.type==="table"&&(!Array.isArray(k)||k.length===0))return console.log(`[isFormValid] \u274C Tabla '${w.id}' sin filas`),!1}}return console.log("[isFormValid] \u2705 Formulario v\xE1lido!"),!0}),this.hierarchyLevels=z(()=>{let M=this.managementClassifications(),L=this.selectedClassifications(),w=[];console.log("[hierarchyLevels] Total classifications:",M.length),console.log("[hierarchyLevels] Selected:",L);let k=M.filter(I=>I.hierarchyLevel===1||!I.parentId);console.log("[hierarchyLevels] Nivel 1 (roots):",k.length,k.map(I=>`${I.codigo} (ID:${I.id})`)),k.length>0&&w.push(k);for(let I=0;I<L.length;I++){let T=L[I];if(console.log(`[hierarchyLevels] Buscando hijos del nivel ${I+1}, parentId:`,T),T){let D=M.filter(U=>U.parentId&&Number(U.parentId)===Number(T));if(console.log(`[hierarchyLevels] Encontrados ${D.length} hijos:`,D.map(U=>`${U.codigo} (ID:${U.id}, parent:${U.parentId})`)),D.length>0)w.push(D);else{console.log("[hierarchyLevels] No se encontraron hijos, deteniendo b\xFAsqueda");break}}}return console.log("[hierarchyLevels] Total niveles construidos:",w.length),w}),this.scheduleForm={numeroCuotas:"",montoCuota:"",periodicidad:"",fechaPrimeraCuota:"",tipoCronograma:"",montoInicial:"",montoNegociado:"",cuotas:[]},this.customerData=x({id_cliente:"CLI-2025-0087453",nombre_completo:"GARC\xCDA RODRIGUEZ, CARMEN ROSA",tipo_documento:"DNI",numero_documento:"45621378",fecha_nacimiento:"15/03/1985",edad:40,contacto:{telefono_principal:"+51 987 654 321",telefono_alternativo:"+51 945 123 456",telefono_trabajo:"+51 01 4567890",email:"carmen.garcia@email.com",direccion:"Av. Los \xC1lamos 458, Dpto 302, San Borja, Lima"},cuenta:{numero_cuenta:"****5678",tipo_producto:"Pr\xE9stamo Personal",fecha_desembolso:"15/01/2024",monto_original:15e3,plazo_meses:24,tasa_interes:18.5},deuda:{saldo_capital:8750.5,intereses_vencidos:456.78,mora_acumulada:234.5,gastos_cobranza:120,saldo_total:9561.78,dias_mora:45,fecha_ultimo_pago:"15/10/2024",monto_ultimo_pago:458.33}}),this.activePaymentSchedules=x([]),this.selectedInstallmentForCancellation=x(null),this.montoPagoEditable=x(0),this.fechaPagoEditable=x(""),this.uploadedComprobante=x(null),this.isCancellationTypification=z(()=>{let M=this.selectedClassification();return M?M.codigo==="CA"||M.label?.toUpperCase().includes("CANCELACION")||M.label?.toUpperCase().includes("CANCELACI\xD3N"):!1}),this.pendingInstallmentsForCancellation=z(()=>{let M=this.activePaymentSchedules(),L=[],w=new Date;w.setHours(0,0,0,0);for(let k of M)if(k.installments)for(let I of k.installments){let T=I.status?.toUpperCase();if(T!=="PAGADA"&&T!=="PAGADO"&&T!=="CUMPLIDO"&&T!=="CANCELADA"&&T!=="CANCELADO"&&T!=="VENCIDA"&&T!=="VENCIDO"){let D=I.dueDate||I.fechaPago;D&&this.parseDateLocal(D)>=w&&L.push(ge(K({},I),{scheduleId:k.id,grupoPromesaUuid:k.grupoPromesaUuid}))}}return L}),this.overdueInstallments=z(()=>{let M=this.activePaymentSchedules(),L=[],w=new Date;w.setHours(0,0,0,0);for(let k of M)if(k.installments)for(let I of k.installments){let T=I.status?.toUpperCase();if(T==="VENCIDA"||T==="VENCIDO")L.push(ge(K({},I),{scheduleId:k.id,grupoPromesaUuid:k.grupoPromesaUuid}));else if(T==="PENDIENTE"){let D=I.dueDate||I.fechaPago;D&&this.parseDateLocal(D)<w&&L.push(ge(K({},I),{scheduleId:k.id,grupoPromesaUuid:k.grupoPromesaUuid}))}}return L}),this.rawClientData=x({}),this.clientAmountFields=z(()=>{let M=this.rawClientData(),L=this.montoCabeceras(),w=[];if(L.length>0){let k=L.filter(I=>I.esVisibleMonto===1||I.esVisibleMonto===void 0||I.esVisibleMonto===null).sort((I,T)=>(I.ordenMonto||0)-(T.ordenMonto||0));for(let I of k){let T=I.codigo.toLowerCase(),D=M[T]??M[I.codigo];if(D!=null){let U=typeof D=="number"?D:parseFloat(D);isNaN(U)||w.push({label:I.nombre,value:U,field:T})}}}else{let k=["id","id_campana","id_cartera","id_subcartera","prioridad","estado","documento","num_cuenta","num_cuenta_pmcp","numero_cuenta","periodo","edad","dias_mora","dias_mora_asig","telefono_celular","telefono_domicilio","telefono_laboral","telf_referencia_1","telf_referencia_2"];for(let[I,T]of Object.entries(M)){let D=I.toLowerCase();if(D.startsWith("fec_")||D.startsWith("fecha_")||D.startsWith("telefono_")||D.startsWith("telf_")||k.includes(D))continue;let U=typeof T=="number"?T:parseFloat(T);!isNaN(U)&&U>=0&&w.push({label:this.formatFieldLabel(I),value:U,field:I})}}return w.sort((k,I)=>I.value-k.value)}),this.clientDiasMora=z(()=>{let M=this.rawClientData(),L=M.dias_mora||M.dias_mora_asig||0;return typeof L=="number"?L:parseInt(L)||0}),this.montoCabeceras=x([]),this.enabledPaymentOptions=x([]),this.paymentScheduleFieldId=x(null),this.hasPaymentOptionsConfig=x(!1),this.esContinuidad=x(!1),this.continuidadData=x(null),this.isLoadingContinuidad=x(!1),this.continuidadError=x(null),this.continuityPaymentAmounts=z(()=>{let M=this.continuidadData();return!M||!M.aplica||!M.saldoRestante?[]:[{label:"Saldo Restante (Continuidad)",value:M.saldoRestante,field:"saldo_continuidad",restriccionFecha:"SIN_RESTRICCION",generaCartaAcuerdo:!1}]}),this.shouldShowDynamicForm=z(()=>{let M=this.esContinuidad(),L=this.isLoadingContinuidad(),w=this.continuidadData();return M?L?!1:w?.aplica===!0:!0}),this.finalPaymentAmounts=z(()=>this.esContinuidad()&&this.continuidadData()?.aplica?this.continuityPaymentAmounts():this.customerPaymentAmounts()),this.callState=oe.IDLE,this.isMuted=x(!1),this.incomingPhoneNumber=null,this.outgoingPhoneNumber=null}ngOnInit(){this.loadTenants(),this.loadManagementHistory();let e=this.sipService.getCallState();console.log("\u{1F4DE} [CollectionManagement] Estado inicial de llamada:",e),e===oe.ACTIVE&&!this.callActive()&&(console.log("\u23F1\uFE0F Llamada ya est\xE1 activa, iniciando timer autom\xE1ticamente..."),this.callActive.set(!0),this.startCall()),this.callStateSubscription=this.sipService.onCallStatus.subscribe(d=>{if(console.log("\u{1F4DE} [CollectionManagement] Estado de llamada:",d),this.callState=d,d===oe.ACTIVE&&!this.callActive()){this.callActive.set(!0),this.startCall();let m=this.authService.getCurrentUser();m?.id&&this.agentService.changeAgentStatus(m.id,{estado:Pe.EN_LLAMADA}).subscribe({next:()=>console.log("\u2705 Estado cambiado a EN_LLAMADA"),error:p=>console.error("\u274C Error cambiando estado:",p)})}if((d===oe.ENDED||d===oe.IDLE)&&this.callActive()){this.callActive.set(!1),this.isTipifying.set(!0),this.sipService.blockIncomingCallsMode(!0),console.log("\u{1F6AB} Bloqueando llamadas entrantes - agente en tipificaci\xF3n");let m=this.callDuration();this.callTimer&&(clearInterval(this.callTimer),this.callTimer=void 0),console.log(`\u{1F4DD} Llamada terminada (${m}s), cambiando a TIPIFICANDO`);let p=this.authService.getCurrentUser();p?.id&&this.agentService.changeAgentStatus(p.id,{estado:Pe.TIPIFICANDO}).subscribe({next:()=>console.log("\u2705 Estado cambiado a TIPIFICANDO - agente debe completar formulario"),error:h=>console.error("\u274C Error cambiando estado:",h)})}}),this.incomingCallSubscription=this.sipService.onIncomingCall.subscribe(d=>{console.log("\u{1F4F2} [CollectionManagement] Llamada entrante de:",d.from),this.incomingPhoneNumber=d.from,d.from&&this.autoLoadCustomerByPhone(d.from)}),this.outgoingCallSubscription=this.sipService.onOutgoingCall.subscribe(d=>{console.log("\u{1F4E4} [CollectionManagement] Llamada saliente a:",d.to),this.outgoingPhoneNumber=d.to,d.to&&this.autoLoadCustomerByPhone(d.to)});let t=this.sipService.getCurrentOutgoingNumber();t&&!this.customerData()?.id&&(console.log("\u{1F4E4} [CollectionManagement] Llamada saliente pendiente detectada:",t),this.outgoingPhoneNumber=t,this.autoLoadCustomerByPhone(t),this.sipService.clearCurrentOutgoingNumber()),this.route.queryParams.subscribe(d=>{d.source==="manual"&&d.documento&&(console.log("\u{1F4CB} [MANUAL] Cargando cliente desde gesti\xF3n manual:",d),this.loadCustomerByDocumentoFromManual(d.documento,Number(d.tenantId),Number(d.portfolioId),Number(d.subPortfolioId)))});let i=this.authService.getCurrentUser();i?.id&&(this.agentStatusSubscription=this.agentStatusService.startStatusPolling(i.id).subscribe({next:d=>{d.colorIndicador&&this.colorIndicador.set(d.colorIndicador),this.excedeTiempoMaximo.set(d.excedeTiempoMaximo||!1)},error:d=>console.error("\u274C Error polling estado del agente:",d)}))}autoLoadCustomerByPhone(e){console.log("\u{1F50D} [AUTO-LOAD] Buscando cliente por tel\xE9fono:",e),this.customerService.searchCustomersAcrossAllTenants("telefono",e).subscribe({next:t=>{t&&t.length>0?(console.log("\u2705 [AUTO-LOAD] Cliente encontrado:",t[0]),this.loadCustomerFromResource(t[0])):console.warn("\u26A0\uFE0F [AUTO-LOAD] No se encontr\xF3 cliente con tel\xE9fono:",e)},error:t=>{console.error("\u274C [AUTO-LOAD] Error buscando cliente:",t)}})}loadCustomerByDocumentoFromManual(e,t,i,d){console.log("\u{1F50D} [MANUAL] Buscando cliente por documento:",e),this.selectedTenantId=t,this.selectedPortfolioId=i,this.selectedSubPortfolioId=d,this.reloadTypifications(),this.loadCustomerOutputConfig(),this.http.get(`${X.apiUrl}/client-search/find`,{params:{tenantId:t.toString(),portfolioId:i.toString(),subPortfolioId:d.toString(),documento:e}}).pipe(he(m=>(console.error("\u274C [MANUAL] Error buscando cliente:",m),be(null)))).subscribe({next:m=>{m?(console.log("\u2705 [MANUAL] Cliente encontrado:",m),this.loadCustomerFromDynamicTable(m)):console.warn("\u26A0\uFE0F [MANUAL] Cliente no encontrado")}})}loadCustomerFromDynamicTable(e){this.rawClientData.set(e),console.log("[CUSTOMER] Raw client data from ini_* table:",e),this.loadMontoCabeceras();let t=e.id||0;console.log("[CUSTOMER] Using ini_*.id as customerId:",t),this.customerData.set({id:t,id_cliente:e.documento,nombre_completo:e.nombre||e.nombres+" "+(e.apellidos||""),tipo_documento:"DNI",numero_documento:e.documento,fecha_nacimiento:"",edad:0,contacto:{telefono_principal:e.telefono_celular||e.telefono_principal||e.telefono||e.telefono_1||"",telefono_alternativo:e.telefono_domicilio||e.telefono_secundario||e.telefono_2||"",telefono_trabajo:e.telefono_laboral||e.telefono_trabajo||e.telefono_3||"",email:e.email||"",direccion:e.direccion||""},cuenta:{numero_cuenta:e.cuenta||"",tipo_producto:e.producto||"PR\xC9STAMO",fecha_desembolso:"",monto_original:e.monto_original||0,plazo_meses:0,tasa_interes:0},deuda:{saldo_capital:e.deuda_capital||0,intereses_vencidos:0,mora_acumulada:e.deuda_mora||0,gastos_cobranza:0,saldo_total:(e.deuda_capital||0)+(e.deuda_mora||0),dias_mora:e.dias_mora||0,fecha_ultimo_pago:"",monto_ultimo_pago:0}}),this.loadManagementHistory(),t&&this.loadActivePaymentSchedules(t),console.log("\u2705 Cliente cargado exitosamente, customerId:",t)}loadMontoCabeceras(){if(!this.selectedSubPortfolioId){console.warn("[CABECERAS] No hay subcartera seleccionada");return}console.log("[CABECERAS] Cargando cabeceras de montos para subcartera:",this.selectedSubPortfolioId),this.managementService.getMontoCabeceras(this.selectedSubPortfolioId).pipe(he(e=>(console.error("[CABECERAS] Error cargando cabeceras:",e),be([])))).subscribe(e=>{console.log("[CABECERAS] Cabeceras cargadas:",e),this.montoCabeceras.set(e.map(t=>({codigo:t.codigo,nombre:t.nombre,tipoDato:t.tipoDato,tipoSql:t.tipoSql,esVisibleMonto:t.esVisibleMonto,ordenMonto:t.ordenMonto})))})}loadTenants(){let e=this.authService.getCurrentUser();console.log("[V2] Usuario actual:",e),e?.tenantId&&e?.portfolioId&&e?.subPortfolioId?(this.selectedTenantId=e.tenantId,this.selectedPortfolioId=e.portfolioId,this.selectedSubPortfolioId=e.subPortfolioId,console.log(`[V2] Usando asignaci\xF3n del usuario: tenant=${this.selectedTenantId}, portfolio=${this.selectedPortfolioId}, subPortfolio=${this.selectedSubPortfolioId}`),this.reloadTypifications(),this.loadCustomerOutputConfig(),this.loadFirstCustomer()):(console.error("[V2] Usuario no tiene asignaci\xF3n completa de tenant/portfolio/subportfolio"),console.error("[V2] Valores recibidos:",{tenantId:e?.tenantId,portfolioId:e?.portfolioId,subPortfolioId:e?.subPortfolioId}))}onTenantChange(){this.selectedPortfolioId=void 0,this.portfolios=[],this.selectedTenantId&&(this.loadPortfolios(),this.reloadTypifications(),this.loadCustomerOutputConfig(),this.loadFirstCustomer())}loadPortfolios(){this.selectedTenantId&&this.classificationService.getPortfoliosByTenant(this.selectedTenantId).subscribe({next:e=>{this.portfolios=e},error:e=>{console.error("Error loading portfolios:",e)}})}onPortfolioChange(){this.reloadTypifications(),this.loadCustomerOutputConfig()}reloadTypifications(){this.selectedTenantId&&this.apiSystemConfigService.setTenantAndPortfolio(this.selectedTenantId,this.selectedPortfolioId,this.selectedSubPortfolioId)}loadCustomerOutputConfig(){this.selectedTenantId&&(console.log("[TEMPORAL] loadCustomerOutputConfig - endpoint no existe, usando campos por defecto"),this.setDefaultOutputFields())}loadFirstCustomer(){let e=this.authService.getCurrentUser();if(!e||!e.sipExtension){console.error("\u274C No se pudo obtener la extensi\xF3n SIP del agente logueado"),this.loadClienteDetalle(475);return}console.log(`\u{1F4CB} Buscando llamada activa del agente con extensi\xF3n SIP ${e.sipExtension}...`),this.http.get(`${X.gatewayUrl}/autodialer/active-call/extension/${e.sipExtension}`).pipe(he(t=>(console.warn("\u26A0\uFE0F No hay llamada activa o error consultando:",t),console.log("\u{1F4CB} Usando contacto de prueba 475"),be({contactId:475})))).subscribe({next:t=>{let i=t?.contactId;if(!i){console.warn("\u26A0\uFE0F No se obtuvo contactId de la llamada activa");return}console.log(`\u2705 Llamada activa encontrada, contactId: ${i}`),this.loadClienteDetalle(i)}})}loadClienteDetalle(e){console.log(`\u{1F4CB} Cargando datos del cliente para contacto ${e}...`),this.http.get(`${X.gatewayUrl}/contacts/${e}/cliente-detalle`).pipe(he(t=>(console.error("\u274C Error cargando datos del cliente:",t),be(null)))).subscribe({next:t=>{if(t&&t.documento){console.log("\u2705 Cliente b\xE1sico cargado, documento:",t.documento);let i=this.authService.getCurrentUser(),d=i?.tenantId,m=i?.portfolioId,p=i?.subPortfolioId;if(!d||!m||!p){console.error("\u274C No se pudo obtener asignaci\xF3n completa del usuario:",{tenantId:d,portfolioId:m,subPortfolioId:p}),this.loadClienteDetalleFallback(t);return}console.log(`\u{1F50D} Buscando datos completos del cliente con documento ${t.documento} en tenant ${d}, portfolio ${m}, subportfolio ${p}...`),this.customerService.findClientByDocumento(d,m,p,t.documento).subscribe({next:h=>{h?(console.log("\u2705 Datos completos del cliente obtenidos:",h),this.loadCustomerFromDynamicTable(h)):(console.warn("\u26A0\uFE0F No se encontr\xF3 cliente con documento:",t.documento),this.loadClienteDetalleFallback(t))},error:h=>{console.error("\u274C Error buscando datos completos del cliente:",h),this.loadClienteDetalleFallback(t)}})}else console.log("\u26A0\uFE0F No se pudieron cargar los datos del cliente")}})}loadClienteDetalleFallback(e){console.warn("\u26A0\uFE0F FALLBACK: No se pudo obtener datos de tabla din\xE1mica"),console.warn("\u26A0\uFE0F Las gestiones guardadas pueden no tener el ID correcto del cliente"),this.rawClientData.set(e),console.log("[FALLBACK] Raw client data from detalle:",e),this.loadMontoCabeceras();let t=e.idCliente||0;console.warn("[FALLBACK] Using clienteDetalle.idCliente as customerId:",t,"(NOT ini_*.id)"),this.customerData.set({id:t,id_cliente:`CLI-${e.idCliente}`,nombre_completo:e.nombreCompleto||"",tipo_documento:e.tipoDocumento||"DNI",numero_documento:e.documento||"",fecha_nacimiento:e.fechaNacimiento||"",edad:e.edad||0,contacto:{telefono_principal:e.telefonoPrincipal||"",telefono_alternativo:e.telefonoSecundario||"",telefono_trabajo:e.telefonoTrabajo||"",email:e.email||"",direccion:e.direccion||""},cuenta:{numero_cuenta:e.cuenta||"",tipo_producto:e.producto||"",fecha_desembolso:"",monto_original:0,plazo_meses:0,tasa_interes:0},deuda:{saldo_capital:e.deudaCapital||0,intereses_vencidos:0,mora_acumulada:0,gastos_cobranza:0,saldo_total:e.deudaTotal||0,dias_mora:e.diasMora||0,fecha_ultimo_pago:"",monto_ultimo_pago:0}}),console.warn("\u26A0\uFE0F Datos del cliente cargados en modo FALLBACK, customerId:",t),this.loadActivePaymentSchedules(t)}loadActivePaymentSchedules(e){let t=this.customerData()?.numero_documento;if(!t){console.warn("\u26A0\uFE0F No hay documento del cliente, no se pueden cargar cronogramas"),this.activePaymentSchedules.set([]);return}console.log(`\u{1F4C5} Cargando cronogramas activos para documento ${t}...`),this.managementService.getActiveSchedulesByDocumento(t).pipe(he(i=>(console.warn("\u26A0\uFE0F Error cargando cronogramas activos:",i),be([])))).subscribe({next:i=>{if(console.log("\u2705 Registros de promesas cargados:",i),!i||i.length===0){this.activePaymentSchedules.set([]);return}let d=i.map(p=>{let h=p.installments||[],_=h.filter(O=>O.status!=="PAGADA"&&O.status!=="PAGADO"&&O.status!=="CUMPLIDO"&&O.status!=="CANCELADA"&&O.status!=="VENCIDA"),F=_[0]||h[0];return{id:p.scheduleId?.scheduleId||p.id,grupoPromesaUuid:p.scheduleId?.scheduleId,totalAmount:p.totalAmount,numberOfInstallments:p.numberOfInstallments||h.length,fechaGestion:p.startDate,installments:h.map(O=>({id:O.id,numeroCuota:O.numeroCuota||O.installmentNumber,monto:O.montoPromesa||O.monto||O.amount,montoPromesa:O.montoPromesa||O.monto||O.amount,dueDate:O.fechaPromesa||O.dueDate||O.fechaPago||null,fechaPromesa:O.fechaPromesa||O.dueDate||O.fechaPago,status:O.status||"PENDIENTE",montoPagadoReal:O.montoPagadoReal||0})),nextDueDate:F?.fechaPromesa||F?.dueDate||F?.fechaPago,cuotasPendientes:_.length}}),m=d.filter(p=>p.cuotasPendientes>0);console.log("\u{1F4C5} Cronogramas transformados:",d),console.log("\u{1F4C5} Cronogramas activos (con cuotas pendientes):",m),this.activePaymentSchedules.set(m),m.length>0&&console.log(`\u{1F4C5} \xA1Cliente tiene ${m.length} promesa(s) de pago activa(s)!`)}})}setDefaultOutputFields(){this.customerOutputFields.set([{id:"numero_documento",label:"DNI/Documento",field:"numero_documento",category:"personal",format:"text",highlight:!0,size:"medium"},{id:"nombre_completo",label:"Nombre Completo",field:"nombre_completo",category:"personal",format:"text",highlight:!1,size:"full"},{id:"telefono_principal",label:"Celular",field:"contacto.telefono_principal",category:"contact",format:"text",highlight:!1,size:"medium"},{id:"email",label:"Email",field:"contacto.email",category:"contact",format:"text",highlight:!1,size:"medium"},{id:"direccion",label:"Direcci\xF3n",field:"contacto.direccion",category:"contact",format:"text",highlight:!1,size:"full"}])}loadManagementHistory(){let e=this.customerData()?.numero_documento;if(!e){console.log("[HISTORIAL] No hay documento del cliente, omitiendo carga de historial");return}console.log("[HISTORIAL] Cargando historial para documento:",e),this.managementService.getManagementsByDocumento(e).subscribe({next:t=>{console.log("[HISTORIAL] Gestiones recibidas del backend:",t),console.log("[HISTORIAL] Total de gestiones:",t.length);let i=t.map(d=>{let m=d.managementDate?this.formatDateOnly(d.managementDate):"-",h=[d.level1Name,d.level2Name,d.level3Name,d.level4Name].filter(Boolean).join(" > ")||"-",_=this.formatCanalDisplay(d.canalContacto),F=this.formatMetodoDisplay(d.metodoContacto),O=this.formatEstadoPagoDisplay(d.estadoPago),G={id:d.id,fecha:m,nombreAgente:d.nombreAgente||`Agente ${d.advisorId}`,tipificacionCompleta:h,telefono:d.telefonoContacto||"",observacion:d.observations||"",canal:d.canalContacto||"",canalDisplay:_,metodo:d.metodoContacto||"",metodoDisplay:F,montoPromesa:d.montoPromesa||void 0,estadoPago:d.estadoPago||void 0,estadoPagoDisplay:O,hasSchedule:d.typificationRequiresSchedule||!1,schedule:null};return G.hasSchedule&&this.paymentScheduleService.getPaymentScheduleByManagementId(d.id).subscribe({next:A=>{A&&(G.schedule=A)},error:()=>{}}),G});this.historialGestiones.set(i),console.log("[HISTORIAL] Historial establecido en signal:",this.historialGestiones())},error:t=>{console.error("[HISTORIAL] Error al cargar historial de gestiones:",t),console.error("[HISTORIAL] Detalles del error:",{status:t.status,statusText:t.statusText,message:t.message,url:t.url})}})}loadHistorialHistorico(e=0){let t=this.customerData()?.numero_documento;if(!t){console.log("[HISTORICO] No hay documento del cliente, omitiendo carga de historial hist\xF3rico");return}console.log("[HISTORICO] Cargando historial hist\xF3rico para documento:",t,"p\xE1gina:",e),this.historialHistoricoLoading.set(!0),this.managementService.getGestionesHistoricas(t,e,10).subscribe({next:i=>{console.log("[HISTORICO] Respuesta del backend:",i);let d=i.content.map((m,p)=>{let h=m.fechaGestion?this.formatDateOnly(m.fechaGestion):"-",_=[m.resultado,m.solucion].filter(Boolean).join(" > ")||"-",F=this.formatCanalDisplay(m.canal),O=this.formatMetodoDisplay(m.metodo),G=this.formatEstadoPagoDisplay(m.estadoPromesa);return{id:p+e*10,fecha:h,nombreAgente:m.agente||"-",tipificacionCompleta:_,telefono:m.telefono||"",observacion:m.observacion||"",canal:m.canal||"",canalDisplay:F,metodo:m.metodo||"",metodoDisplay:O,montoPromesa:m.montoPromesa||void 0,estadoPago:m.estadoPromesa||void 0,estadoPagoDisplay:G}});this.historialHistorico.set(d),this.historialHistoricoPage.set(i.page),this.historialHistoricoTotalPages.set(i.totalPages),this.historialHistoricoTotalElements.set(i.totalElements),this.historialHistoricoLoading.set(!1),console.log("[HISTORICO] Historial hist\xF3rico cargado:",d.length,"registros")},error:i=>{console.error("[HISTORICO] Error al cargar historial hist\xF3rico:",i),this.historialHistoricoLoading.set(!1),this.historialHistorico.set([])}})}cambiarPaginaHistorico(e){let t=this.historialHistoricoPage(),i=this.historialHistoricoTotalPages();e==="anterior"&&t>0?this.loadHistorialHistorico(t-1):e==="siguiente"&&t<i-1&&this.loadHistorialHistorico(t+1)}cambiarTabHistorial(e){this.historialTabActivo.set(e),e==="historico"&&this.historialHistorico().length===0&&this.loadHistorialHistorico()}formatDateTime(e){let t=new Date(e),i=t.getDate().toString().padStart(2,"0"),d=(t.getMonth()+1).toString().padStart(2,"0"),m=t.getFullYear(),p=t.getHours().toString().padStart(2,"0"),h=t.getMinutes().toString().padStart(2,"0");return`${i}/${d}/${m} ${p}:${h}`}calculateCallDuration(e){return e.durationSeconds?this.formatTime(e.durationSeconds):"00:00:00"}calculateCallDurationSeconds(){if(!this.callStartTime)return 0;let e=new Date(this.callStartTime).getTime(),t=new Date().getTime();return Math.floor((t-e)/1e3)}ngOnDestroy(){this.callTimer&&clearInterval(this.callTimer),this.isTipifying()&&(this.isTipifying.set(!1),this.sipService.blockIncomingCallsMode(!1),console.log("\u{1F513} [ngOnDestroy] Desbloqueando llamadas entrantes al salir del componente")),this.callStateSubscription&&this.callStateSubscription.unsubscribe(),this.incomingCallSubscription&&this.incomingCallSubscription.unsubscribe(),this.outgoingCallSubscription&&this.outgoingCallSubscription.unsubscribe(),this.agentStatusSubscription&&this.agentStatusSubscription.unsubscribe()}cancelarTipificacion(){console.log("\u274C Cancelando tipificaci\xF3n..."),this.isTipifying.set(!1),this.sipService.blockIncomingCallsMode(!1),console.log("\u{1F513} Desbloqueando llamadas entrantes - tipificaci\xF3n cancelada");let t=this.authService.getCurrentUser()?.id||1;this.agentService.changeAgentStatus(t,{estado:Pe.DISPONIBLE}).subscribe({next:()=>{console.log("\u2705 Estado cambiado a DISPONIBLE, navegando al agent-dashboard..."),this.router.navigate(["/agent-dashboard"])},error:i=>{console.error("\u274C Error al cambiar estado:",i),this.router.navigate(["/agent-dashboard"])}})}openScheduleDetail(e){this.scheduleManagementId.set(e),this.showScheduleDetail.set(!0)}closeScheduleDetail(){this.showScheduleDetail.set(!1),this.scheduleManagementId.set(null)}onCustomAmountDetected(e){console.log("\u2139\uFE0F [Exception] Custom amount detected (no blocking):",e)}toggleCall(){this.callActive()?this.endCall():this.startCall()}startCall(){this.callActive.set(!0),this.callDuration.set(0),this.callStartTime=new Date().toISOString(),this.callTimer=window.setInterval(()=>{this.callDuration.update(e=>e+1)},1e3)}endCall(e=!1){console.log("\u{1F4F5} Finalizando llamada..."),this.sipService.hangup(),this.callActive.set(!1),this.callTimer&&(clearInterval(this.callTimer),this.callTimer=void 0),e&&this.router.navigate(["/agent-dashboard"])}formatTime(e){let t=Math.floor(e/3600),i=Math.floor(e%3600/60),d=e%60;return`${t.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}:${d.toString().padStart(2,"0")}`}formatDateOnly(e){if(!e)return"-";let t=e.split("-");return t.length===3?`${t[2]}/${t[1]}/${t[0]}`:e}formatCanalDisplay(e){return e?{LLAMADA_SALIENTE:"Llamada Saliente",LLAMADA_ENTRANTE:"Llamada Entrante",SMS:"SMS",WHATSAPP:"WhatsApp",EMAIL:"Email"}[e]||this.formatSnakeCase(e):"-"}formatMetodoDisplay(e){return e?{GESTION_MANUAL:"Manual",GESTION_PROGRESIVO:"Progresivo",GESTION_PREDICTIVO:"Predictivo",GESTION_AUTOMATICA:"Autom\xE1tica"}[e]||this.formatSnakeCase(e):"-"}formatEstadoPagoDisplay(e){return e?{PENDIENTE:"Pendiente",PAGADA:"Pagada",VENCIDA:"Vencida",PARCIAL:"Parcial",CANCELADA:"Cancelada"}[e]||this.formatSnakeCase(e):"-"}formatSnakeCase(e){return e?e.toLowerCase().split("_").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" "):"-"}onContactResultChange(){this.managementForm.tipoGestion="",this.managementForm.motivoNoPago=""}onManagementTypeChange(){}showManagementType(){return this.managementForm.resultadoContacto==="CPC"||this.managementForm.resultadoContacto==="CTT"}usesHierarchicalClassifications(){let e=this.hierarchyLevels();return e.length>0&&e[0].length>0}getTypificationsForLevel(e){return this.hierarchyLevels()[e]||[]}onClassificationLevelChange(e,t){let i=[...this.selectedClassifications()];if(i[e]=t,this.selectedClassifications.set(i.slice(0,e+1)),this.resetContinuidadState(),e===0?(this.managementForm.clasificacionNivel1=t,this.managementForm.clasificacionNivel2="",this.managementForm.clasificacionNivel3=""):e===1?(this.managementForm.clasificacionNivel2=t,this.managementForm.clasificacionNivel3=""):e===2&&(this.managementForm.clasificacionNivel3=t),t){this.managementForm.tipoGestion=t;let d=Number(t);!isNaN(d)&&d>0?(this.loadDynamicFields(d),this.checkIfContinuidad(d)):(this.dynamicFields.set([]),this.dynamicFieldValues.set({}),this.isLeafClassification.set(!1))}else{let d=this.selectedClassifications().filter(m=>m).pop();this.managementForm.tipoGestion=d||"",this.dynamicFields.set([]),this.dynamicFieldValues.set({}),this.isLeafClassification.set(!1)}}resetContinuidadState(){this.esContinuidad.set(!1),this.continuidadData.set(null),this.continuidadError.set(null),this.isLoadingContinuidad.set(!1)}checkIfContinuidad(e){let i=this.managementClassifications().find(m=>String(m.id)===String(e));if(!i){console.log("[CONTINUIDAD] No se encontr\xF3 tipificaci\xF3n con ID:",e);return}let d=i.codigo?.toUpperCase()==="CON"||i.label?.toUpperCase()?.includes("CONTINUIDAD");console.log("[CONTINUIDAD] Verificando tipificaci\xF3n:",i.codigo,i.label,"- Es continuidad:",d),d&&(console.log("[CONTINUIDAD] Tipificaci\xF3n CONTINUIDAD detectada:",i.codigo,i.label),this.esContinuidad.set(!0),this.verificarContinuidadCliente())}verificarContinuidadCliente(){let e=this.customerData()?.numero_documento;if(!e){console.warn("[CONTINUIDAD] No hay documento del cliente"),this.continuidadError.set("No se encontr\xF3 el documento del cliente");return}console.log("[CONTINUIDAD] Verificando continuidad para documento:",e),this.isLoadingContinuidad.set(!0),this.continuidadError.set(null),this.managementService.verificarContinuidad(e).subscribe({next:t=>{console.log("[CONTINUIDAD] Respuesta:",t),this.isLoadingContinuidad.set(!1),t.aplica?(this.continuidadData.set(t),this.continuidadError.set(null),console.log("[CONTINUIDAD] Aplica! Saldo restante:",t.saldoRestante)):(this.continuidadData.set(null),this.continuidadError.set(t.mensaje||"No aplica continuidad para este cliente"),console.log("[CONTINUIDAD] No aplica:",t.mensaje))},error:t=>{console.error("[CONTINUIDAD] Error al verificar:",t),this.isLoadingContinuidad.set(!1),this.continuidadData.set(null),this.continuidadError.set("Error al verificar continuidad")}})}loadDynamicFields(e){this.isLoadingDynamicFields.set(!0),this.apiSystemConfigService.getClassificationFields(e).subscribe({next:t=>{this.isLeafClassification.set(t.isLeaf),this.dynamicFields.set(t.fields||[]);let d={fields:(t.fields||[]).map((p,h)=>K({id:p.fieldCode,label:p.fieldName,type:p.fieldType.toLowerCase(),required:p.isRequired||!1,placeholder:p.description||"",helpText:p.description,displayOrder:p.displayOrder||0,options:p.options?p.options.map(_=>typeof _=="string"?{value:_,label:_}:{value:_.value||_,label:_.label||_}):void 0,min:p.validationRules?.min,max:p.validationRules?.max,minLength:p.validationRules?.minLength,maxLength:p.validationRules?.maxLength,columns:p.fieldType.toLowerCase()==="table"&&p.columns?p.columns.map(_=>({id:_.id||_.fieldCode,label:_.label||_.fieldName,type:(_.type||_.fieldType).toLowerCase(),required:_.required||_.isRequired||!1,options:_.options?_.options.map(F=>typeof F=="string"?{value:F,label:F}:{value:F.value||F,label:F.label||F}):void 0})):void 0,allowAddRow:p.fieldType.toLowerCase()==="table",allowDeleteRow:p.fieldType.toLowerCase()==="table",minRows:p.minRows||0,maxRows:p.maxRows},p.linkedToField&&{linkedToField:p.linkedToField}))};this.dynamicFieldsSchema.set(d),this.isLoadingDynamicFields.set(!1);let m=(t.fields||[]).find(p=>p.fieldType.toLowerCase()==="payment_schedule");m&&m.id?(this.paymentScheduleFieldId.set(m.id),this.loadEnabledPaymentOptions(m.id)):(this.paymentScheduleFieldId.set(null),this.enabledPaymentOptions.set([]),this.hasPaymentOptionsConfig.set(!1)),this.checkAndLoadPaymentSchedules()},error:t=>{console.error("Error cargando campos din\xE1micos:",t),this.isLoadingDynamicFields.set(!1),this.isLeafClassification.set(!1),this.dynamicFields.set([]),this.dynamicFieldsSchema.set(null)}})}loadEnabledPaymentOptions(e){console.log("[PAYMENT] Loading options for field ID:",e),this.typificationV2Service.getOpcionesCampo(e).subscribe({next:t=>{let i=t&&t.length>0;this.hasPaymentOptionsConfig.set(i);let d=i?t.filter(m=>m.estaHabilitada):[];console.log("[PAYMENT] Options config exists:",i,"| Total:",t?.length||0,"| Enabled:",d.length),this.enabledPaymentOptions.set(d)},error:t=>{console.warn("[PAYMENT] Error loading options, showing all amounts:",t),this.hasPaymentOptionsConfig.set(!1),this.enabledPaymentOptions.set([])}})}checkAndLoadPaymentSchedules(){let e=this.selectedClassifications();if(e.length===0){this.showScheduleHelper.set(!1);return}let t=e[e.length-1],d=this.managementClassifications().find(m=>m.id.toString()===t);d&&d.requiere_pago?(console.log("[SCHEDULE] Payment typification detected:",d.codigo),console.log("[DEBUG-SCHEDULE] Full typification object:",d),console.log("[DEBUG-SCHEDULE] suggestsFullAmount:",d.suggestsFullAmount),console.log("[DEBUG-SCHEDULE] allowsInstallmentSelection:",d.allowsInstallmentSelection),console.log("[DEBUG-SCHEDULE] requiresManualAmount:",d.requiresManualAmount),this.loadActiveSchedules()):(this.showScheduleHelper.set(!1),this.activeSchedules.set([]))}loadActiveSchedules(){let e=this.customerData()?.numero_documento;if(!e){console.log("[SCHEDULE] No hay documento del cliente, omitiendo carga de cronogramas");return}console.log("[SCHEDULE] Loading active schedules for documento:",e),this.isLoadingSchedules.set(!0),this.managementService.getActiveSchedulesByDocumento(e).subscribe({next:t=>{console.log("[SCHEDULE] Active schedules loaded:",t),this.activeSchedules.set(t),this.showScheduleHelper.set(t.length>0),this.isLoadingSchedules.set(!1),t.length>0&&this.suggestPaymentAmount(t[0])},error:t=>{console.error("[SCHEDULE] Error loading schedules:",t),this.isLoadingSchedules.set(!1),this.showScheduleHelper.set(!1)}})}suggestPaymentAmount(e){if(!e.installments||e.installments.length===0)return;let t=e.installments.filter(i=>i.status.status==="PENDING").sort((i,d)=>new Date(i.dueDate).getTime()-new Date(d.dueDate).getTime())[0];if(t){console.log("[SCHEDULE] Suggested payment amount:",t.amount),this.managementForm.montoPago||(this.managementForm.montoPago=t.amount.toFixed(2));let i=K({},this.dynamicFieldValues());i.monto_pagado||(i.monto_pagado=t.amount,this.dynamicFieldValues.set(i))}}applyFullSchedulePayment(){let e=this.activeSchedules();if(e.length===0)return;let t=e[0],i=this.calculatePendingAmount(t);console.log("[BUTTON] Pagar Todo clicked. Amount:",i);let d=this.dynamicFieldsSchema(),m=d?.fields.find(p=>p.type==="currency"||p.id.toLowerCase().includes("monto"));if(m){console.log("[BUTTON] Found monto field:",m.id);let p={};if(p[m.id]=i,d?.fields.some(_=>_.id==="saldo_pendiente")){p.saldo_pendiente=0,console.log("[BUTTON] Saldo pendiente ser\xE1 0 (pago total)");let _=K({},this.dynamicFieldValues());_[m.id]=i,_.saldo_pendiente=0,this.dynamicFieldValues.set(_)}this.externalFieldUpdates.set(p),console.log("[BUTTON] Updated externalFieldUpdates:",p),setTimeout(()=>this.externalFieldUpdates.set({}),100)}else console.warn("[BUTTON] No se encontr\xF3 campo de monto en el schema")}applyNextInstallmentPayment(){console.log("[BUTTON-PP] Usar Pr\xF3xima Cuota clicked!");let e=this.activeSchedules();if(console.log("[BUTTON-PP] Active schedules:",e),e.length===0){console.warn("[BUTTON-PP] No schedules found");return}let t=e[0];console.log("[BUTTON-PP] Using schedule:",t),console.log("[BUTTON-PP] Schedule installments:",t.installments);let i=t.installments.filter(m=>(console.log("[BUTTON-PP] Checking installment:",m,"Status:",m.status?.status),m.status.status==="PENDING"));console.log("[BUTTON-PP] Pending installments:",i);let d=i.sort((m,p)=>new Date(m.dueDate).getTime()-new Date(p.dueDate).getTime())[0];if(console.log("[BUTTON-PP] Next pending installment:",d),d){console.log("[BUTTON-PP] Usar Pr\xF3xima Cuota - Amount:",d.amount);let m=this.dynamicFieldsSchema(),p=m?.fields.find(h=>h.type==="currency"||h.id.toLowerCase().includes("monto"));if(p){console.log("[BUTTON-PP] Found monto field:",p.id);let h={};if(h[p.id]=d.amount,m?.fields.some(F=>F.id==="saldo_pendiente")){let F=this.calculatePendingAmount(t),O=Math.max(0,F-d.amount);h.saldo_pendiente=O,console.log("[BUTTON-PP] Saldo pendiente calculado:",O,"= Total",F,"- Monto",d.amount);let G=K({},this.dynamicFieldValues());G[p.id]=d.amount,G.saldo_pendiente=O,this.dynamicFieldValues.set(G)}this.externalFieldUpdates.set(h),console.log("[BUTTON-PP] Updated externalFieldUpdates:",h),setTimeout(()=>this.externalFieldUpdates.set({}),100)}else console.warn("[BUTTON-PP] No se encontr\xF3 campo de monto en el schema")}else console.warn("[BUTTON-PP] No pending installment found")}calculatePendingAmount(e){console.log("[CALC] Schedule:",e),console.log("[CALC] Installments:",e.installments);let t=e.installments.filter(d=>(console.log("[CALC] Installment status:",d.status,"Status value:",d.status?.status),d.status.status==="PENDING"));console.log("[CALC] Pending installments:",t);let i=t.reduce((d,m)=>d+m.amount,0);return console.log("[CALC] Total pending amount:",i),i}getPendingInstallments(e){return e.installments?e.installments.filter(t=>t.status.status==="PENDING").sort((t,i)=>new Date(t.dueDate).getTime()-new Date(i.dueDate).getTime()):[]}onDynamicFieldsChange(e){this.dynamicFieldValues.set(e),e.monto_pagado!==void 0&&e.monto_pagado!==null&&this.calculateAndUpdatePendingBalance(e.monto_pagado)}calculateAndUpdatePendingBalance(e){let t=this.activeSchedules();if(t.length===0){console.log("[SALDO] No hay cronogramas activos");return}let i=t[0],d=this.calculatePendingAmount(i),m=Math.max(0,d-(e||0));if(console.log("[SALDO] Total pendiente:",d),console.log("[SALDO] Monto pagado:",e),console.log("[SALDO] Saldo pendiente calculado:",m),this.dynamicFieldsSchema()?.fields.some(_=>_.id==="saldo_pendiente")){console.log("[SALDO] Actualizando campo saldo_pendiente con:",m);let _={saldo_pendiente:m};this.externalFieldUpdates.set(_);let F=K({},this.dynamicFieldValues());F.saldo_pendiente=m,this.dynamicFieldValues.set(F),setTimeout(()=>this.externalFieldUpdates.set({}),100)}}getDynamicLevelLabel(e){if(e===0){let m=this.hierarchyLevels()[0]||[];if(m.length===0)return"Nivel 1";let p=m.map(h=>h.codigo);return p.includes("RP")||p.includes("CSA")?"Tipo de Resultado":"Categor\xEDa Principal"}let t=e-1,i=this.selectedClassifications()[t];if(!i)return`Nivel ${e+1}`;let d=this.managementClassifications().find(m=>m.id==i);return d?e===1?{RP:"Intenci\xF3n de Pago",CSA:"Motivo de No Atenci\xF3n",SC:"Raz\xF3n de No Contacto",GA:"Tipo de Gesti\xF3n"}[d.codigo]||`Detalle de ${d.label}`:`Detalle de ${d.label}`:`Nivel ${e+1}`}shouldShowLevel(e){if(e===0)return this.usesHierarchicalClassifications();let t=e-1;return this.selectedClassifications()[t]?this.getTypificationsForLevel(e).length>0:!1}formatFieldLabel(e){let t={deuda_total:"Deuda Total",saldo_total:"Saldo Total",saldo_capital:"Saldo Capital",capital:"Capital",deuda_capital:"Deuda Capital",intereses:"Intereses",intereses_vencidos:"Intereses Vencidos",mora:"Mora",mora_acumulada:"Mora Acumulada",deuda_mora:"Deuda Mora",gastos:"Gastos",gastos_cobranza:"Gastos Cobranza",monto_original:"Monto Original",monto_desembolso:"Monto Desembolso",saldo_vencido:"Saldo Vencido",cuota_vencida:"Cuota Vencida",cuotas_vencidas:"Cuotas Vencidas",monto_cuota:"Monto Cuota",dias_mora:"D\xEDas Mora",monto_minimo:"Monto M\xEDnimo",monto_total:"Monto Total",deuda:"Deuda",saldo:"Saldo"},i=e.toLowerCase();return t[i]?t[i]:e.split("_").map(d=>d.charAt(0).toUpperCase()+d.slice(1).toLowerCase()).join(" ")}formatCurrency(e){return new Intl.NumberFormat("es-PE",{style:"currency",currency:"PEN"}).format(e)}parseDateLocal(e){if(!e)return new Date;let[t,i,d]=e.split("-").map(Number);return new Date(t,i-1,d)}getPrimaryAmountLabel(){let e=this.clientAmountFields();return e.length>0?e.find(i=>i.label.toLowerCase().includes("total")||i.field.toLowerCase().includes("total"))?.label||e[0].label:"Deuda Total"}getPrimaryAmountValue(){let e=this.clientAmountFields();return e.length>0?e.find(i=>i.label.toLowerCase().includes("total")||i.field.toLowerCase().includes("total"))?.value||e[0].value:this.customerData().deuda?.saldo_total||0}getAmountRowClass(e){let t=["bg-red-50 !text-black dark:bg-red-950/30 dark:!text-red-300","bg-white !text-black dark:bg-gray-800 dark:!text-red-400"];return t[e%t.length]}showPaymentSection(){return this.managementClassifications().find(t=>t.id===this.managementForm.tipoGestion)?.requiere_pago||!1}showScheduleSection(){return this.managementClassifications().find(t=>t.id===this.managementForm.tipoGestion)?.requiere_cronograma||!1}onInstallmentCountChange(){let e=parseInt(this.scheduleForm.numeroCuotas);if(isNaN(e)||e<1){this.scheduleForm.cuotas=[];return}let t=this.scheduleForm.cuotas.length;if(e>t)for(let i=t+1;i<=e;i++)this.scheduleForm.cuotas.push({numero:i,monto:"",fechaVencimiento:""});else e<t&&(this.scheduleForm.cuotas=this.scheduleForm.cuotas.slice(0,e),this.scheduleForm.cuotas.forEach((i,d)=>{i.numero=d+1}))}generateSchedule(){let e=parseInt(this.scheduleForm.numeroCuotas);if(isNaN(e)||e<1){alert("Por favor ingrese un n\xFAmero v\xE1lido de cuotas");return}this.scheduleForm.cuotas=[];for(let t=1;t<=e;t++)this.scheduleForm.cuotas.push({numero:t,monto:"",fechaVencimiento:""})}addInstallmentRow(){let e=this.scheduleForm.cuotas.length+1;this.scheduleForm.cuotas.push({numero:e,monto:"",fechaVencimiento:""}),this.scheduleForm.numeroCuotas=e.toString()}removeInstallmentRow(e){this.scheduleForm.cuotas.length>1&&(this.scheduleForm.cuotas.splice(e,1),this.scheduleForm.cuotas.forEach((t,i)=>{t.numero=i+1}),this.scheduleForm.numeroCuotas=this.scheduleForm.cuotas.length.toString())}getTodayDate(){let e=new Date,t=e.getFullYear(),i=String(e.getMonth()+1).padStart(2,"0"),d=String(e.getDate()).padStart(2,"0");return`${t}-${i}-${d}`}loadMontoNegociadoFromOutput(e){let t=this.customerOutputFields().find(m=>m.id===e);if(!t)return;let i=t.field.split("."),d=this.customerData();for(let m of i)if(d&&typeof d=="object")d=d[m];else{d=null;break}d&&(this.scheduleForm.montoNegociado=d.toString())}toggleScheduleDetail(){this.showScheduleDetail.update(e=>!e)}saveManagement(){if(!this.validateForm())return;this.saving.set(!0);let e,t;if(this.usesHierarchicalClassifications()){let j=this.selectedClassifications(),Q=this.managementClassifications(),se=j[j.length-1];if(t=Q.find(ee=>ee.id.toString()===se),t?.parentId){let ee=t.parentId;e=Q.find(q=>q.id.toString()===ee.toString())}else e=t}else e=this.contactClassifications().find(j=>j.id===this.managementForm.resultadoContacto),t=this.managementClassifications().find(j=>j.id===this.managementForm.tipoGestion);let i=this.selectedClassifications(),d=Number(i[0]),m=i[1]?Number(i[1]):null,p=i[2]?Number(i[2]):null,h=this.managementClassifications(),_=h.find(j=>j.id.toString()===i[0]),F=i[1]?h.find(j=>j.id.toString()===i[1]):null,O=i[2]?h.find(j=>j.id.toString()===i[2]):null,G=this.dynamicFieldValues(),A=this.dynamicFieldsSchema(),V=null;if(console.log("[SAVE] === DEBUG PAYMENT SCHEDULE ==="),console.log("[SAVE] dynamicValues:",G),console.log("[SAVE] schema:",A),console.log("[SAVE] schema.fields:",A?.fields),A&&A.fields){let j=A.fields.find(Q=>Q.type==="payment_schedule");console.log("[SAVE] paymentScheduleField found:",j),j&&(console.log("[SAVE] Looking for field id:",j.id),console.log("[SAVE] Value in dynamicValues:",G[j.id])),j&&G[j.id]&&(V=G[j.id],console.log("[SAVE] Payment schedule detected:",V))}if(console.log("[SAVE] Final paymentScheduleData:",V),V&&V.cuotas&&V.cuotas.length>0&&this.activePaymentSchedules().some(se=>se.cuotasPendientes>0)){this.saving.set(!1),alert(`\u26A0\uFE0F No puede registrar una nueva Promesa de Pago.

El cliente ya tiene una promesa de pago activa con cuotas pendientes.

Debe esperar a que se completen o cancelen las cuotas pendientes antes de registrar una nueva promesa.`);return}if(V&&V.cuotas&&V.cuotas.length>0){let j=p||m||d,Q=this.callActive()||!!this.callStartTime,se=this.authService.getCurrentUser(),ee={idCliente:this.customerData().id||0,nombreCliente:this.customerData().nombre_completo,documentoCliente:this.customerData().numero_documento,idAgente:se?.id||1,idTenant:this.selectedTenantId,idCartera:this.selectedPortfolioId||1,idSubcartera:this.selectedSubPortfolioId,idTipificacion:j,observaciones:this.managementForm.observaciones,metodoContacto:Q?"GESTION_PROGRESIVO":"GESTION_MANUAL",canalContacto:Q?"LLAMADA_SALIENTE":void 0,campoMontoOrigen:V.campoMontoOrigen,montoBase:V.montoBase,esContinuidad:this.esContinuidad()&&this.continuidadData()?.aplica,promesaOrigenUuid:this.continuidadData()?.promesaOrigenUuid,montoOriginalPromesa:this.continuidadData()?.montoOriginal,montoPagadoPrevio:this.continuidadData()?.montoPagado,schedule:{montoTotal:V.montoTotal,numeroCuotas:V.numeroCuotas,cuotas:V.cuotas.map(q=>({numeroCuota:q.numeroCuota,monto:q.monto,fechaPago:q.fechaPago}))}};console.log("[SAVE] Creating payment schedule with request:",ee),this.managementService.createPaymentSchedule(ee).subscribe({next:q=>{console.log("[SAVE] Payment schedule created successfully:",q);let me=Array.isArray(q)&&q.length>0?q[0].id:q?.id,pe=V.generaCartaAcuerdo===!0;me&&pe?(console.log("[CARTA] Monto seleccionado requiere carta de acuerdo, mostrando modal..."),this.mostrarModalGenerarCarta(me,e?.label||"",t?.label||"-")):(me&&!pe&&console.log("[CARTA] Monto seleccionado NO requiere carta de acuerdo, omitiendo modal."),this.onSaveSuccess(e?.label||"",t?.label||"-"))},error:q=>{console.error("Error al guardar cronograma de pago:",q),this.saving.set(!1),alert("\u26A0\uFE0F Error al guardar el cronograma de pago. Por favor intente nuevamente.")}})}else{let j=this.callActive()||!!this.callStartTime,Q=this.authService.getCurrentUser(),se={customerId:String(this.customerData().id),customerName:this.customerData().nombre_completo||"",customerDocument:this.customerData().numero_documento||"",advisorId:String(Q?.id||1),idAgente:Q?.id||1,tenantId:this.selectedTenantId,portfolioId:this.selectedPortfolioId||1,subPortfolioId:this.selectedSubPortfolioId||1,phone:this.customerData().telefono_celular||this.customerData().telefono_domicilio||this.customerData().telefono_laboral||this.customerData().telf_referencia_1||this.customerData().telf_referencia_2||this.customerData().contacto?.telefono_principal||"",level1Id:d,level1Name:_?.label||"",level2Id:m,level2Name:F?.label||null,level3Id:p,level3Name:O?.label||null,observations:this.managementForm.observaciones,metodoContacto:j?"GESTION_PROGRESIVO":"GESTION_MANUAL",canalContacto:j?"LLAMADA_SALIENTE":void 0,idCampana:null,idLlamada:null,duracionSegundos:j&&this.callStartTime?this.calculateCallDurationSeconds():null,nombreAgente:Q?`${Q.firstName||""} ${Q.lastName||""}`.trim()||Q.username:"Sistema",userAgent:navigator.userAgent};this.managementService.createManagement(se).subscribe({next:ee=>{this.callStartTime&&this.callActive()&&this.registerCallToBackend(ee.id);let q=this.selectedInstallmentForCancellation();if(this.isCancellationTypification()&&q&&q.id){let me=this.montoPagoEditable()||q.monto,pe=this.fechaPagoEditable()||new Date().toISOString().split("T")[0];console.log("\u{1F4B0} Registrando pago:",{cuota:q.numeroCuota,montoOriginal:q.monto,montoPagado:me,fecha:pe});let Ne=this.activePaymentSchedules().find(w=>w.installments?.some(k=>k.id===q.id)),M=Ne?.grupoPromesaUuid||Ne?.id;if(!M){console.error("No se encontr\xF3 el grupoPromesaUuid"),this.selectedInstallmentForCancellation.set(null),this.onSaveSuccess(e?.label||"",t?.label||"-");return}let L=this.authService.getCurrentUser();this.http.post(`${X.apiUrl}/pagos/registrar`,{grupoPromesaUuid:M,monto:me,fechaPago:pe,banco:null,numeroOperacion:null,agenteId:L?.id||1,metodoRegistro:"MANUAL",observaciones:this.managementForm.observaciones||"Pago registrado desde gesti\xF3n",comprobanteUrl:null}).subscribe({next:w=>{console.log("\u2705 Pago registrado exitosamente:",w),this.selectedInstallmentForCancellation.set(null),this.montoPagoEditable.set(0),this.fechaPagoEditable.set("");let k=this.customerData().id;k&&this.loadActivePaymentSchedules(k),this.onSaveSuccess(e?.label||"",t?.label||"-")},error:w=>{console.error("\u26A0\uFE0F Error registrando pago:",w),(w.error?.error||w.error?.mensaje)&&alert(`\u26A0\uFE0F ${w.error.error||w.error.mensaje||"Error al registrar el pago."}`),this.selectedInstallmentForCancellation.set(null),this.onSaveSuccess(e?.label||"",t?.label||"-")}})}else this.onSaveSuccess(e?.label||"",t?.label||"-")},error:ee=>{console.error("Error al guardar gesti\xF3n:",ee),this.saving.set(!1),alert("\u26A0\uFE0F Error al guardar la gesti\xF3n. Por favor intente nuevamente.")}})}}registerCallToBackend(e){if(!this.callStartTime)return;let t={phoneNumber:this.customerData().contacto.telefono_principal,startTime:this.callStartTime};this.managementService.startCall(e,t).subscribe({next:i=>{if(!this.callActive()){let d={endTime:new Date().toISOString()};this.managementService.endCall(e,d).subscribe({next:()=>{},error:m=>console.error("Error al finalizar llamada:",m)})}},error:i=>{console.error("Error al registrar llamada:",i)}})}registerPaymentToBackend(e){if(!this.managementForm.montoPago||!this.managementForm.metodoPago)return;let t={amount:parseFloat(this.managementForm.montoPago),scheduledDate:new Date().toISOString().split("T")[0],paymentMethodType:this.managementForm.metodoPago,paymentMethodDetails:this.managementForm.ultimos4Tarjeta||void 0,voucherNumber:void 0,bankName:this.managementForm.bancoSeleccionado||void 0};this.managementService.registerPayment(e,t).subscribe({next:i=>{},error:i=>{console.error("Error al registrar pago:",i)}})}createScheduleToBackend(e){if(this.scheduleForm.cuotas.length===0)return;if(this.scheduleForm.cuotas.some(d=>!d.monto||!d.fechaVencimiento)){alert("\u26A0\uFE0F Por favor complete todos los montos y fechas de las cuotas");return}let i={customerId:String(this.customerData().id),managementId:e,scheduleType:this.scheduleForm.tipoCronograma,negotiatedAmount:this.scheduleForm.montoNegociado?parseFloat(this.scheduleForm.montoNegociado):null,installments:this.scheduleForm.cuotas.map(d=>({installmentNumber:d.numero,amount:parseFloat(d.monto),dueDate:d.fechaVencimiento}))};this.paymentScheduleService.createPaymentSchedule(i).subscribe({next:d=>{},error:d=>{console.error("Error al crear cronograma:",d),alert("\u26A0\uFE0F Error al crear el cronograma de pagos")}})}onSaveSuccess(e,t){this.saving.set(!1),this.showSuccess.set(!0),this.endCall(!1),this.loadManagementHistory(),this.managementForm={resultadoContacto:"",tipoGestion:"",clasificacionNivel1:"",clasificacionNivel2:"",clasificacionNivel3:"",motivoNoPago:"",metodoPago:"",montoPago:"",fechaCompromiso:"",horaCompromiso:"",ultimos4Tarjeta:"",bancoSeleccionado:"",observaciones:"",notasPrivadas:""},this.callDuration.set(0),this.callStartTime=void 0,this.activeTab.set("cliente"),this.isTipifying.set(!1),this.sipService.blockIncomingCallsMode(!1),console.log("\u2705 Desbloqueando llamadas entrantes - tipificaci\xF3n completada");let i=sessionStorage.getItem("recordatorioEnCurso");if(i){console.log("\u{1F514} Modo recordatorio dialer activo, procesando siguiente..."),this.procesarSiguienteRecordatorio(JSON.parse(i));return}console.log("\u2705 Gesti\xF3n guardada, cambiando estado a DISPONIBLE...");let m=this.authService.getCurrentUser()?.id||1;this.agentService.changeAgentStatus(m,{estado:Pe.DISPONIBLE}).subscribe({next:()=>{console.log("\u2705 Estado cambiado a DISPONIBLE"),setTimeout(()=>{this.showSuccess.set(!1),console.log("\u{1F504} Navegando a /agent-dashboard..."),this.router.navigate(["/agent-dashboard"])},2e3)},error:p=>{console.error("\u274C Error cambiando estado:",p),setTimeout(()=>{this.showSuccess.set(!1),this.router.navigate(["/agent-dashboard"])},2e3)}})}procesarSiguienteRecordatorio(e){let i=this.authService.getCurrentUser()?.id||e.idAgente;this.recordatoriosService.completarActual(i,"CONTESTADO").subscribe({next:d=>{console.log("\u{1F514} Recordatorio completado:",d),d.terminado?(console.log("\u{1F514} Todos los recordatorios completados"),sessionStorage.removeItem("recordatorioEnCurso"),setTimeout(()=>{this.showSuccess.set(!1),this.mostrarModalRecordatoriosFinalizado(i)},1e3)):this.recordatoriosService.obtenerSiguiente(i).subscribe({next:m=>{m.hayMas&&m.recordatorio?(console.log("\u{1F514} Siguiente recordatorio:",m.recordatorio),sessionStorage.setItem("recordatorioEnCurso",JSON.stringify({idCuota:m.recordatorio.idCuota,idAgente:i,idCliente:m.recordatorio.idCliente,nombreCliente:m.recordatorio.nombreCliente,telefono:m.recordatorio.telefono,monto:m.recordatorio.monto,numeroCuota:m.recordatorio.numeroCuota,totalCuotas:m.recordatorio.totalCuotas})),this.showSuccess.set(!1),this.mostrarCountdownYLlamar(m.recordatorio)):(sessionStorage.removeItem("recordatorioEnCurso"),this.showSuccess.set(!1),this.mostrarModalRecordatoriosFinalizado(i))},error:m=>{console.error("Error obteniendo siguiente recordatorio:",m),sessionStorage.removeItem("recordatorioEnCurso"),this.showSuccess.set(!1),this.router.navigate(["/agent-dashboard"])}})},error:d=>{console.error("Error completando recordatorio:",d),sessionStorage.removeItem("recordatorioEnCurso"),this.showSuccess.set(!1),this.router.navigate(["/agent-dashboard"])}})}mostrarCountdownYLlamar(e){this.dialog.open(Ke,{width:"450px",disableClose:!0,data:{cantidad:0,pendientes:1,idAgente:this.authService.getCurrentUser()?.id||0,modoSiguiente:!0,recordatorio:e}}).afterClosed().subscribe(i=>{i?.action==="call"&&i.recordatorio?this.sipService.call(i.recordatorio.telefono):i?.action==="cancelled"&&(sessionStorage.removeItem("recordatorioEnCurso"),this.router.navigate(["/agent-dashboard"]))})}mostrarModalRecordatoriosFinalizado(e){this.dialog.open(Ke,{width:"450px",disableClose:!0,data:{cantidad:0,pendientes:0,idAgente:e,modoFinalizado:!0}}).afterClosed().subscribe(()=>{this.agentService.changeAgentStatus(e,{estado:Pe.DISPONIBLE}).subscribe({next:()=>this.router.navigate(["/agent-dashboard"]),error:()=>this.router.navigate(["/agent-dashboard"])})})}validateForm(){let e={};if(this.usesHierarchicalClassifications()){let i=this.selectedClassifications();if(i.length===0||!i[i.length-1])e.typification="Debe seleccionar una clasificaci\xF3n";else{let d=i[i.length-1];this.managementClassifications().some(h=>h.parentId&&Number(h.parentId)===Number(d))&&(e.typification="Debe completar todos los niveles de clasificaci\xF3n")}}else this.managementForm.resultadoContacto||(e.resultadoContacto="Requerido"),this.showManagementType()&&!this.managementForm.tipoGestion&&(e.tipoGestion="Requerido");let t=this.dynamicFieldsSchema();if(t&&t.fields&&t.fields.length>0){let i=this.dynamicFieldValues();for(let d of t.fields)if(d.required){let m=i[d.id];(m==null||m==="")&&(e[`dynamic_${d.id}`]=`${d.label} es requerido`),d.type==="table"&&(!Array.isArray(m)||m.length===0)&&(e[`dynamic_${d.id}`]=`${d.label} debe tener al menos una fila`)}}return this.errors.set(e),Object.keys(e).length>0?(alert("Por favor complete todos los campos requeridos"),!1):!0}calculateRemaining(){if(!this.managementForm.montoPago)return"0.00";let e=parseFloat(this.managementForm.montoPago);return(this.customerData().deuda.saldo_total-e).toFixed(2)}toggleDarkMode(){this.themeService.toggleTheme()}getFieldValue(e){let t=this.customerData();return t?e.split(".").reduce((i,d)=>i?.[d],t):null}formatFieldValue(e,t){if(e==null||e==="")return"-";switch(t){case"currency":return"S/ "+Number(e).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",");case"number":return String(e);case"date":return typeof e=="string"?new Date(e).toLocaleDateString("es-PE"):String(e);default:return String(e)}}isContactField(e){let t=["celular","telefono","telefono_principal","telefono_alternativo","telefono_trabajo","email","correo","direccion","address"],i=e.toLowerCase();return t.some(d=>i.includes(d))}formatDate(e){if(!e)return"-";try{let t;return typeof e=="string"?/^\d{4}-\d{2}-\d{2}$/.test(e)?t=this.parseDateLocal(e):t=new Date(e):t=e,t.toLocaleDateString("es-PE",{day:"2-digit",month:"2-digit",year:"numeric"})}catch{return String(e)}}getSaldoPendienteCuota(e){let t=e?.montoPagadoReal||0;return Math.max(0,(e?.monto||0)-t)}tienePagoParcial(e){return(e?.montoPagadoReal||0)>0}showPaymentScheduleDetail(e){console.log("\u{1F4C5} Detalle de promesa de pago:",e);let t=`PROMESA DE PAGO

`;if(t+=`Monto Total: S/ ${e.totalAmount?.toFixed(2)||"0.00"}
`,t+=`N\xFAmero de Cuotas: ${e.numberOfInstallments}

`,t+=`DETALLE DE CUOTAS:
`,e.installments&&e.installments.length>0)for(let i of e.installments){let d=i.dueDate?this.formatDate(i.dueDate):"-",m="\u23F3 Pendiente";i.status==="PAGADA"||i.status==="PAGADO"||i.status==="CUMPLIDO"?m="\u2705 PAGADA":i.status==="VENCIDA"||i.status==="VENCIDO"?m="\u26A0\uFE0F VENCIDA":(i.status==="CANCELADA"||i.status==="CANCELADO")&&(m="\u2717 CANCELADA"),t+=`  Cuota ${i.numeroCuota}: S/ ${i.monto?.toFixed(2)||"0.00"} - ${d} - ${m}
`}alert(t)}getContactClassificationLabel(e){let t=this.contactClassifications().find(d=>d.id===e);if(!t)return e;let i=t.label||t.codigo;return`[${t.codigo}] ${i}`}getManagementClassificationLabel(e){let t=this.managementClassifications().find(d=>d.id===e);if(!t)return e;let i=t.label||t.codigo;return`[${t.codigo}] ${i}`}getTableRows(e){let t=this.dynamicFieldValues()[e];return Array.isArray(t)?t:[]}addTableRow(e,t){if(!Array.isArray(t)){console.error("addTableRow: columns no es un array v\xE1lido",t);return}let i=K({},this.dynamicFieldValues());Array.isArray(i[e])||(i[e]=[]);let d=this.createEmptyTableRow(t);i[e].push(d),this.dynamicFieldValues.set(i)}removeTableRow(e,t){let i=K({},this.dynamicFieldValues());Array.isArray(i[e])&&(i[e].splice(t,1),this.dynamicFieldValues.set(i))}createEmptyTableRow(e){let t={};return e.forEach(i=>{i.type==="auto-number"?t[i.id]=null:i.type==="number"||i.type==="currency"?t[i.id]=i.defaultValue||0:(i.type,t[i.id]=i.defaultValue||"")}),t}searchByTestDocument(){if(!this.testDocument.trim()||!this.selectedTenantId){console.warn("[TEST] Documento vac\xEDo o tenant no seleccionado");return}console.log("[TEST] Buscando cliente por documento:",this.testDocument),this.customerService.searchCustomersByCriteria(this.selectedTenantId,"documento",this.testDocument).subscribe({next:e=>{e&&e.length>0?(console.log("[TEST] Cliente encontrado:",e[0]),this.loadCustomerFromResource(e[0])):(console.warn("[TEST] No se encontr\xF3 cliente con documento:",this.testDocument),alert("No se encontr\xF3 cliente con el documento: "+this.testDocument))},error:e=>{console.error("[TEST] Error buscando cliente:",e),alert("Error buscando cliente")}})}searchByTestPhone(){if(!this.testPhone.trim()||!this.selectedTenantId){console.warn("[TEST] Tel\xE9fono vac\xEDo o tenant no seleccionado");return}console.log("[TEST] Buscando cliente por tel\xE9fono:",this.testPhone),this.customerService.searchCustomersByCriteria(this.selectedTenantId,"telefono",this.testPhone).subscribe({next:e=>{e&&e.length>0?(console.log("[TEST] Cliente encontrado:",e[0]),this.loadCustomerFromResource(e[0])):(console.warn("[TEST] No se encontr\xF3 cliente con tel\xE9fono:",this.testPhone),alert("No se encontr\xF3 cliente con el tel\xE9fono: "+this.testPhone))},error:e=>{console.error("[TEST] Error buscando cliente:",e),alert("Error buscando cliente")}})}loadCustomerFromResource(e){console.log("[TEST] Cargando cliente:",e),this.rawClientData.set(e),console.log("[PAYMENT] Raw client data from resource:",e),this.loadMontoCabeceras(),this.customerData.set({id:e.id,id_cliente:e.documentNumber||e.identificationCode,nombre_completo:e.fullName||"",tipo_documento:e.documentType||"DNI",numero_documento:e.documentNumber||"",fecha_nacimiento:e.birthDate||"",edad:e.age||null,contacto:{telefono_principal:e.contactMethods?.find(t=>t.subtype==="telefono_principal")?.value||"",telefono_alternativo:e.contactMethods?.find(t=>t.subtype==="telefono_secundario")?.value||"",telefono_trabajo:e.contactMethods?.find(t=>t.subtype==="telefono_trabajo")?.value||"",email:e.contactMethods?.find(t=>t.contactType==="email")?.value||"",direccion:e.address||""},cuenta:{numero_cuenta:e.accountNumber||"",tipo_producto:"PR\xC9STAMO",fecha_desembolso:"2024-01-15",monto_original:e.principalAmount||0,plazo_meses:12,tasa_interes:2.5},deuda:{saldo_capital:e.principalAmount||0,intereses_vencidos:0,mora_acumulada:e.overdueAmount||0,gastos_cobranza:0,saldo_total:(e.principalAmount||0)+(e.overdueAmount||0),dias_mora:e.overdueDays||0,fecha_ultimo_pago:"",monto_ultimo_pago:0}}),this.loadManagementHistory(),e.id&&this.loadActivePaymentSchedules(e.id),console.log("[TEST] Cliente cargado exitosamente")}hangupCall(){console.log("\u{1F4F5} Colgando llamada..."),this.sipService.hangup()}toggleMute(){this.isMuted()?(console.log("\u{1F50A} Desmuteando..."),this.sipService.unmute(),this.isMuted.set(!1)):(console.log("\u{1F507} Muteando..."),this.sipService.mute(),this.isMuted.set(!0))}isInActiveCall(){return this.callState===oe.ACTIVE}getCallStateText(){switch(this.callState){case oe.IDLE:return"LISTO";case oe.CONNECTING:return"CONECTANDO...";case oe.RINGING:return"TIMBRANDO...";case oe.ACTIVE:return"EN LLAMADA";case oe.ENDED:return"FINALIZADA";default:return"DESCONOCIDO"}}openComprobanteUploadDialog(){let e=this.selectedInstallmentForCancellation(),t=this.customerData(),i=this.authService.getCurrentUser();if(!e||!t){console.warn("[COMPROBANTE] No hay cuota o cliente seleccionado");return}let d={idCuota:e.id,montoEsperado:e.monto||0,documentoEsperado:t.numero_documento||"",nombreCliente:t.nombre_completo||"",idAgente:i?.id||1};this.dialog.open(zt,{width:"1100px",maxWidth:"95vw",data:d,disableClose:!1,backdropClass:"comprobante-modal-backdrop",panelClass:"comprobante-modal-panel"}).afterClosed().subscribe(p=>{if(p?.uploaded&&p.response){console.log("[COMPROBANTE] Comprobante subido:",p.response),this.uploadedComprobante.set(p.response);let h=p.response.ocrResult;if(h&&(h.monto&&h.monto>0&&(console.log("[COMPROBANTE] Actualizando monto con OCR:",h.monto),this.montoPagoEditable.set(h.monto)),h.fecha)){console.log("[COMPROBANTE] Actualizando fecha con OCR:",h.fecha);let _=this.parseFechaOcr(h.fecha);_&&this.fechaPagoEditable.set(_)}p.validacionesOk||console.warn("[COMPROBANTE] El comprobante tiene diferencias con los datos esperados")}})}openVoucherPaymentDialog(e){let t=this.customerData(),i=this.authService.getCurrentUser();if(!t){console.warn("[VOUCHER] No hay cliente seleccionado");return}if(!e.installments||e.installments.length===0){console.warn("[VOUCHER] No hay cuotas en el cronograma");return}let d=e.installments.map(h=>({id:h.id,numeroCuota:h.numeroCuota,monto:h.monto,dueDate:h.dueDate,status:h.status,montoPagadoReal:h.montoPagadoReal||0})),m={nombreCliente:t.nombre_completo||"",documentoCliente:t.numero_documento||"",idCliente:t.id||0,idAgente:i?.id||1,cuotas:d,grupoPromesaUuid:e.grupoPromesaUuid||e.id};this.dialog.open(Bt,{width:"1100px",maxWidth:"95vw",data:m,disableClose:!1,backdropClass:"voucher-modal-backdrop",panelClass:"voucher-modal-panel"}).afterClosed().subscribe(h=>{if(h?.confirmed&&h.autoSelect){if(console.log("[VOUCHER] Pago confirmado, auto-seleccionando:",h.autoSelect),this.autoSelectClassification(h.autoSelect.categoriaId,h.autoSelect.detalleId),this.selectedInstallmentForCancellation.set(h.autoSelect.cuotaSeleccionada),this.managementForm.observaciones=h.autoSelect.observaciones,h.ocrResponse){this.uploadedComprobante.set(h.ocrResponse);let _=h.ocrResponse.ocrResult;if(_)if(_.monto&&_.monto>0?(console.log("[VOUCHER] Actualizando monto con OCR:",_.monto),this.montoPagoEditable.set(_.monto)):this.montoPagoEditable.set(h.autoSelect.cuotaSeleccionada.monto||0),_.fecha){console.log("[VOUCHER] Actualizando fecha con OCR:",_.fecha);let F=this.parseFechaOcr(_.fecha);F?this.fechaPagoEditable.set(F):this.fechaPagoEditable.set(new Date().toISOString().split("T")[0])}else this.fechaPagoEditable.set(new Date().toISOString().split("T")[0])}console.log("[VOUCHER] Formulario auto-completado. Listo para guardar.")}})}autoSelectClassification(e,t){let i=this.managementClassifications();if(!i||i.length===0){console.warn("[VOUCHER] No hay clasificaciones disponibles");return}let d=i.filter(p=>p.hierarchyLevel===1||!p.parentId);console.log("[VOUCHER] Total clasificaciones:",i.length),console.log("[VOUCHER] Roots disponibles:",d.map(p=>`${p.codigo}: ${p.label}`)),console.log("[VOUCHER] Buscando categor\xEDa:",e,"y detalle:",t);let m=d.find(p=>p.codigo===e||p.codigo?.toUpperCase()===e||p.label?.toUpperCase().includes("CONTACTO DIRECTO")||p.label?.toUpperCase().includes("CONTACTO_DIRECTO"));m?(this.onClassificationLevelChange(0,m.id),console.log("[VOUCHER] Categor\xEDa seleccionada:",m.label,"(id:",m.id,")"),setTimeout(()=>{let p=i.filter(h=>h.parentId&&Number(h.parentId)===Number(m.id));if(console.log("[VOUCHER] Hijos disponibles:",p.map(h=>`${h.codigo}: ${h.label}`)),p.length>0){let h=p.find(_=>_.codigo===t||_.codigo?.toUpperCase()===t||_.label?.toUpperCase().includes("CANCELACION")||_.label?.toUpperCase().includes("CANCELACI\xD3N"));h?(this.onClassificationLevelChange(1,h.id),console.log("[VOUCHER] Detalle seleccionado:",h.label,"(id:",h.id,")")):console.warn('[VOUCHER] No se encontr\xF3 detalle "CANCELACION". Opciones:',p.map(_=>_.label))}else console.warn("[VOUCHER] No se encontraron hijos para categor\xEDa:",m.id)},150)):console.warn('[VOUCHER] No se encontr\xF3 categor\xEDa "CONTACTO DIRECTO". Opciones:',d.map(p=>p.label))}onSelectCuotaForCancellation(e){this.selectedInstallmentForCancellation.set(e),this.montoPagoEditable.set(e.monto||0),this.fechaPagoEditable.set(new Date().toISOString().split("T")[0])}onMontoPagoChange(e){let t=e.target,i=parseFloat(t.value)||0;this.montoPagoEditable.set(i)}onFechaPagoChange(e){let t=e.target;this.fechaPagoEditable.set(t.value)}parseFechaOcr(e){if(!e)return null;if(e=e.trim(),/^\d{4}-\d{2}-\d{2}$/.test(e))return e;let t=e.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);if(t){let i=t[1].padStart(2,"0"),d=t[2].padStart(2,"0");return`${t[3]}-${d}-${i}`}if(t=e.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2})$/),t){let i=t[1].padStart(2,"0"),d=t[2].padStart(2,"0");return`${parseInt(t[3])>50?`19${t[3]}`:`20${t[3]}`}-${d}-${i}`}return console.warn("[COMPROBANTE] No se pudo parsear la fecha OCR:",e),null}mostrarModalGenerarCarta(e,t,i){this.dialog.open($t,{width:"auto",disableClose:!0,panelClass:"carta-dialog-panel",data:{idGestion:e}}).afterClosed().subscribe(m=>{m==="generate"?this.generarCartaYFinalizar(e,t,i):this.onSaveSuccess(t,i)})}generarCartaYFinalizar(e,t,i){let d=this.authService.getCurrentUser();if(!d){alert("\u26A0\uFE0F No se puede generar la carta: usuario no encontrado"),this.onSaveSuccess(t,i);return}console.log("\u{1F4C4} Generando Carta de Acuerdo para gesti\xF3n:",e),this.cartaAcuerdoService.generarCarta(e,d.id).subscribe({next:m=>{this.cartaAcuerdoService.descargarPdf(m,`carta_acuerdo_${e}.pdf`),console.log("\u2705 Carta de Acuerdo generada exitosamente"),alert("\u2705 Carta de Acuerdo generada exitosamente"),this.onSaveSuccess(t,i)},error:m=>{console.error("\u274C Error generando carta:",m),alert("\u26A0\uFE0F Error al generar la Carta de Acuerdo. La gesti\xF3n se guard\xF3 correctamente."),this.onSaveSuccess(t,i)}})}};c.\u0275fac=function(t){return new(t||c)(R(Ht),R(It),R(Ie),R(Pt),R(Tt),R(Ot),R(Ye),R(jt),R(Gt),R(mt),R(ct),R(ie),R(yt),R(St),R(Mt),R(gt),R(At),R(wt),R(kt),R(Te),R(qt))},c.\u0275cmp=Z({type:c,selectors:[["app-collection-management"]],viewQuery:function(t,i){if(t&1&&Re(ai,5),t&2){let d;Ve(d=Le())&&(i.dynamicFieldRenderer=d.first)}},decls:89,vars:56,consts:[["dynamicFieldRendererComponent",""],[1,"collection-management-container","h-[100dvh]","flex","flex-col","overflow-hidden"],[1,"fixed","top-4","right-4","z-50","animate-[slideInRight_0.5s_ease-out]"],[1,"bg-gradient-to-r","from-gray-700","via-gray-800","to-gray-700","dark:from-slate-950","dark:via-blue-950","dark:to-slate-950","text-white","shadow-md","relative","overflow-hidden"],[1,"relative","px-4","py-2"],[1,"flex","items-center","justify-between"],[1,"flex","items-center","gap-2"],[1,"w-8","h-8","bg-blue-600/30","dark:bg-blue-600/30","rounded-lg","flex","items-center","justify-center"],["name","clipboard-list",1,"text-white",3,"size"],[1,"text-base","font-bold"],[1,"flex","items-center","gap-4"],[1,"text-right"],[1,"text-blue-200","dark:text-blue-300","text-xs"],[3,"color","excedido","size"],[1,"flex-1","flex","flex-col","overflow-hidden"],[1,"flex-1","flex","overflow-hidden","min-h-0"],[1,"w-72","bg-white","dark:bg-slate-900","border-r","border-slate-200","dark:border-slate-800","shadow-lg","overflow-hidden","flex","flex-col","transition-colors","duration-300"],[1,"flex","border-b","border-slate-200","dark:border-slate-800","bg-slate-50","dark:bg-slate-950"],[3,"class"],[1,"flex-1","overflow-y-auto","p-2"],[1,"space-y-2"],[1,"flex","flex-col","items-center","justify-center","h-full","py-8"],[1,"flex-1","overflow-y-auto","bg-gradient-to-br","from-gray-50","via-slate-50","to-blue-50","dark:from-slate-900","dark:via-gray-900","dark:to-slate-900","transition-colors","duration-300"],[1,"p-3","space-y-2"],[1,"font-bold","text-gray-800","dark:text-white","flex","items-center","gap-2","text-xs"],[1,"flex","gap-2"],[3,"click","disabled"],[1,"px-4","py-1.5","bg-gradient-to-r","from-red-600","to-red-700","hover:from-red-700","hover:to-red-800","disabled:from-gray-400","disabled:to-gray-500","text-white","dark:text-white","disabled:text-gray-200","rounded-lg","font-bold","flex","items-center","gap-2","transition-all","duration-300","text-xs","shadow-md","hover:shadow-lg",3,"click","disabled"],[1,"bg-white","dark:bg-gray-800","rounded-lg","shadow-md","border","border-gray-200","dark:border-gray-700","p-2","hover:border-blue-300","dark:hover:border-blue-600","transition-colors","duration-300"],[1,"animate-[slideInDown_0.3s_ease-out]"],[1,"bg-white","dark:bg-gray-800","rounded-lg","shadow-md","border","border-gray-200","dark:border-gray-700","p-3"],[1,"bg-indigo-50","dark:bg-indigo-950/20","border","border-indigo-200","dark:border-indigo-900/50","rounded-lg","shadow-md","p-3"],[1,"bg-gray-50","dark:bg-gray-900/20","border","border-gray-200","dark:border-gray-700","rounded-lg","shadow-md","p-3"],[3,"schema","externalUpdates","selectedClassification","customerAmounts"],[1,"bg-purple-50","dark:bg-purple-950/20","border","border-purple-200","dark:border-purple-900/50","rounded-lg","shadow-md","p-3","animate-pulse"],[1,"bg-gradient-to-r","from-purple-50","to-indigo-50","dark:from-purple-950/30","dark:to-indigo-950/30","border-2","border-purple-300","dark:border-purple-700","rounded-lg","shadow-lg","p-3","space-y-2"],[1,"bg-gradient-to-br","from-green-50","to-emerald-50","dark:from-green-950/30","dark:to-emerald-950/30","border","border-green-200","dark:border-green-800","rounded-lg","p-3","space-y-2"],[1,"bg-gradient-to-br","from-purple-50","to-indigo-50","dark:from-purple-950/30","dark:to-indigo-950/30","border","border-purple-200","dark:border-purple-800","rounded-lg","p-3"],[1,"flex","gap-2","pt-2"],[1,"flex-1","bg-gradient-to-r","from-emerald-600","to-emerald-700","hover:from-emerald-700","hover:to-emerald-800","disabled:from-gray-400","disabled:to-gray-500","text-white","disabled:text-gray-200","py-2","px-4","rounded-lg","font-bold","text-xs","flex","items-center","justify-center","gap-2","transition-all","duration-300","shadow-lg","hover:shadow-xl","disabled:cursor-not-allowed",3,"click","disabled","title"],[1,"px-6","bg-gradient-to-r","from-gray-400","to-gray-500","hover:from-gray-500","hover:to-gray-600","text-white","dark:text-white","py-2","rounded-lg","font-bold","text-xs","flex","items-center","justify-center","gap-2","transition-all","duration-300","shadow-md","hover:shadow-lg",3,"click"],[1,"w-72","bg-white","dark:bg-slate-900","border-l","border-slate-200","dark:border-slate-800","shadow-lg","overflow-hidden","flex","flex-col","transition-colors","duration-300"],[1,"p-2","bg-red-100","dark:bg-red-950/20"],[1,"text-center"],[1,"text-xs","uppercase","font-bold",3,"ngClass"],[1,"text-xl","font-black",3,"ngClass"],[1,"text-xs","font-semibold",3,"ngClass"],[1,"p-2","flex-1","overflow-y-auto"],[1,"space-y-1.5"],[1,"px-3","py-1.5","bg-slate-50","dark:bg-slate-800/50","border-b","border-slate-200","dark:border-slate-700","flex","items-center","justify-between"],[1,"text-xs","font-bold","text-slate-700","dark:text-slate-200"],[1,"flex","items-center","border","border-slate-300","dark:border-slate-600","rounded","overflow-hidden"],[3,"click"],[1,"text-xs","text-slate-500","dark:text-slate-400"],[1,"w-6","h-6","flex","items-center","justify-center","rounded","hover:bg-slate-200","dark:hover:bg-slate-700","transition-colors","text-slate-500","dark:text-slate-400","hover:text-slate-700","dark:hover:text-slate-200",3,"click","title"],[3,"name","size"],[1,"flex","items-center","gap-1"],[1,"flex-1","overflow-auto"],[1,"fixed","inset-0","z-50","flex","items-center","justify-center","p-4","bg-black/50","backdrop-blur-sm","animate-fadeIn"],[1,"bg-gradient-to-r","from-green-500","to-emerald-600","text-white","px-6","py-4","rounded-lg","shadow-2xl","flex","items-center","gap-3"],[1,"font-bold"],[1,"text-sm","opacity-90"],[1,"absolute","bottom-0","left-0","right-0","h-0.5","bg-blue-700","dark:bg-blue-500"],[1,"text-center","py-2","text-slate-400","text-xs"],[1,"space-y-1.5","mt-1"],[1,"flex","items-center","gap-2","p-1.5","bg-green-50","dark:bg-green-950/30","rounded","border","border-green-200","dark:border-green-800"],["name","smartphone",1,"text-green-600","dark:text-green-400",3,"size"],[1,"flex-1","min-w-0"],[1,"text-xs","text-green-600","dark:text-green-400"],[1,"text-xs","font-bold","text-green-700","dark:text-green-300","truncate"],[1,"flex","items-center","gap-2","p-1.5","bg-slate-50","dark:bg-slate-800","rounded","border","border-slate-200","dark:border-slate-700"],[1,"flex","items-center","gap-2","p-1.5","bg-blue-50","dark:bg-blue-950/30","rounded","border","border-blue-200","dark:border-blue-800"],[1,"flex","items-center","gap-2","p-1.5","bg-orange-50","dark:bg-orange-950/30","rounded","border","border-orange-200","dark:border-orange-800"],[1,"pb-1.5","border-b","border-slate-100","dark:border-slate-800"],[1,"text-xs","text-slate-500","dark:text-slate-400","uppercase","font-medium"],[1,"text-xs","font-semibold","text-slate-800","dark:text-white","break-words"],["name","phone",1,"text-slate-500","dark:text-slate-400",3,"size"],[1,"text-xs","font-semibold","text-slate-700","dark:text-slate-300","truncate"],["name","building-2",1,"text-slate-500","dark:text-slate-400",3,"size"],["name","mail",1,"text-blue-500","dark:text-blue-400",3,"size"],[1,"text-xs","text-blue-500","dark:text-blue-400"],[1,"text-xs","font-semibold","text-blue-700","dark:text-blue-300","truncate"],["name","map-pin",1,"text-orange-500","dark:text-orange-400","flex-shrink-0",3,"size"],[1,"text-xs","text-orange-500","dark:text-orange-400"],[1,"text-xs","font-semibold","text-orange-700","dark:text-orange-300","line-clamp-2"],[1,"w-12","h-12","rounded-full","bg-amber-100","dark:bg-amber-900/30","flex","items-center","justify-center","mb-3"],["name","construction",1,"text-amber-600","dark:text-amber-400",3,"size"],[1,"text-sm","font-semibold","text-gray-700","dark:text-gray-200"],[1,"text-xs","text-gray-500","dark:text-gray-400","mt-1","text-center","px-4"],[1,"block","font-bold","text-gray-800","dark:text-white","mb-1","text-xs","flex","items-center","gap-1"],[1,"w-1.5","h-1.5","bg-red-500","rounded-full"],[1,"relative"],[3,"ngModelChange","ngModel"],["value",""],[3,"value"],[1,"text-red-600","text-xs","mt-1","flex","items-center","gap-1"],[1,"bg-gradient-to-r","from-amber-500","via-yellow-500","to-orange-500","dark:from-amber-600","dark:via-yellow-600","dark:to-orange-600","text-white","rounded-md","shadow-md","mb-1.5","overflow-hidden","border","border-amber-400","dark:border-amber-500"],[1,"px-3","py-2","bg-black/10","flex","items-center","justify-between"],[1,"w-6","h-6","bg-white/20","rounded","flex","items-center","justify-center"],["name","alert-triangle",1,"text-white",3,"size"],[1,"font-bold","text-xs"],[1,"text-xs","opacity-80"],["title","Validar voucher con IA",1,"px-2.5","py-1","bg-white/20","hover:bg-white/30","rounded","text-xs","font-semibold","transition-all","flex","items-center","gap-1","border","border-white/30",3,"click"],["name","scan-line",3,"size"],[1,"px-3","py-2","bg-black/5"],[1,"text-xs","font-semibold","mb-1.5","opacity-90"],[1,"flex","flex-wrap","gap-1.5"],[1,"flex","items-center","gap-1.5","text-xs","bg-white/20","rounded","px-2","py-1"],[1,"mt-1.5","text-xs","opacity-80"],[1,"opacity-70"],[1,"font-medium","flex","items-center","gap-0.5"],["name","calendar",3,"size"],[1,"bg-green-700","text-xs","dark:bg-green-600","px-1","py-0.5","rounded","font-semibold","flex","items-center"],[1,"bg-amber-600","text-xs","dark:bg-amber-500","px-1","py-0.5","rounded","font-semibold"],[1,"bg-red-700","text-xs","dark:bg-red-600","px-1","py-0.5","rounded","font-semibold","flex","items-center"],[1,"bg-gray-600","text-xs","px-1","py-0.5","rounded","font-semibold","flex","items-center"],[1,"bg-blue-700","text-xs","dark:bg-blue-600","px-1","py-0.5","rounded","font-semibold","flex","items-center"],[1,"text-xs","opacity-70"],["name","check",3,"size"],["name","alert-triangle",3,"size"],["name","x",3,"size"],["name","clock",3,"size"],[1,"font-semibold"],[1,"text-xs","font-bold","text-gray-600","dark:text-gray-300","uppercase","mb-2"],[1,"flex","flex-wrap","gap-2"],[1,"text-red-500","text-xs","mt-1"],[1,"flex-1","min-w-[140px]"],[1,"block","text-xs","text-gray-500","dark:text-gray-400","mb-0.5"],[1,"flex","items-center","justify-center","gap-2","text-indigo-600","dark:text-indigo-400"],[1,"text-xs"],[1,"flex","items-center","justify-center","gap-2","text-gray-500","dark:text-gray-400"],[3,"dataChange","customAmountDetected","schema","externalUpdates","selectedClassification","customerAmounts"],[1,"bg-amber-50","dark:bg-amber-950/20","border","border-amber-200","dark:border-amber-900/50","rounded-lg","shadow-md","p-3","animate-pulse"],[1,"bg-red-50","dark:bg-red-950/20","border-2","border-red-300","dark:border-red-700","rounded-lg","shadow-lg","p-4"],[1,"bg-gradient-to-r","from-amber-50","to-orange-50","dark:from-amber-950/30","dark:to-orange-950/30","border-2","border-amber-400","dark:border-amber-600","rounded-lg","shadow-lg","p-4","space-y-3"],[1,"flex","items-center","justify-center","gap-2","text-amber-600","dark:text-amber-400"],["name","loader-2",1,"animate-spin",3,"size"],[1,"text-xs","font-semibold"],[1,"flex","items-center","gap-3"],[1,"p-2","bg-red-100","dark:bg-red-900/30","rounded-lg"],["name","alert-circle",1,"text-red-600","dark:text-red-400",3,"size"],[1,"text-sm","font-bold","text-red-900","dark:text-red-100"],[1,"text-xs","text-red-600","dark:text-red-300"],[1,"p-2","bg-amber-500","dark:bg-amber-600","rounded-lg"],["name","refresh-cw",1,"text-white",3,"size"],[1,"text-sm","font-bold","text-amber-900","dark:text-amber-100"],[1,"text-xs","text-amber-600","dark:text-amber-300"],[1,"px-3","py-1","bg-green-100","dark:bg-green-900/30","text-green-700","dark:text-green-300","rounded-full","text-xs","font-bold"],[1,"bg-white","dark:bg-gray-800","rounded-lg","border","border-amber-200","dark:border-amber-700","p-3","space-y-2"],[1,"grid","grid-cols-3","gap-3","text-center"],[1,"bg-gray-50","dark:bg-gray-900/50","rounded-lg","p-2"],[1,"text-xs","text-gray-500","dark:text-gray-400","uppercase","font-medium"],[1,"text-sm","font-bold","text-gray-800","dark:text-gray-100"],[1,"bg-green-50","dark:bg-green-900/30","rounded-lg","p-2"],[1,"text-xs","text-green-600","dark:text-green-400","uppercase","font-medium"],[1,"text-sm","font-bold","text-green-700","dark:text-green-300"],[1,"bg-amber-100","dark:bg-amber-900/50","rounded-lg","p-2","ring-2","ring-amber-400","dark:ring-amber-500"],[1,"text-xs","text-amber-700","dark:text-amber-300","uppercase","font-medium"],[1,"text-lg","font-bold","text-amber-800","dark:text-amber-200"],[1,"text-xs","text-gray-500","dark:text-gray-400","text-center"],[1,"flex","items-center","gap-2","text-xs","text-amber-700","dark:text-amber-300","bg-amber-100/50","dark:bg-amber-900/20","rounded-lg","p-2"],["name","info",3,"size"],[1,"flex","items-center","justify-center","gap-2","text-purple-600","dark:text-purple-400"],[1,"p-1.5","bg-purple-700","dark:bg-purple-500","rounded"],[1,"text-xs","font-bold","text-purple-900","dark:text-purple-100"],[1,"text-xs","text-purple-600","dark:text-purple-300"],[1,"bg-white","dark:bg-gray-800","rounded-lg","border","border-purple-200","dark:border-purple-700","p-2","space-y-2"],[1,"text-xs","px-1.5","py-0.5","bg-green-100","dark:bg-green-900/30","text-green-700","dark:text-green-300","rounded","font-semibold"],[1,"space-y-1"],[1,"text-xs","font-bold","text-gray-600","dark:text-gray-300","uppercase"],[1,"text-xs","text-center","text-gray-500","dark:text-gray-400","italic"],[1,"flex","gap-2","pt-1"],["type","button",1,"flex-1","px-3","py-1.5","bg-purple-600","hover:bg-purple-700","dark:bg-purple-700","dark:hover:bg-purple-600","text-white","text-xs","font-bold","rounded","transition-colors","flex","items-center","justify-center","gap-1"],["type","button",1,"flex-1","px-3","py-1.5","bg-indigo-600","hover:bg-indigo-700","dark:bg-indigo-700","dark:hover:bg-indigo-600","text-white","text-xs","font-bold","rounded","transition-colors","flex","items-center","justify-center","gap-1"],[1,"text-xs","text-purple-600","dark:text-purple-400","bg-purple-100","dark:bg-purple-900/20","p-1.5","rounded","flex","items-start","gap-1"],[1,"flex","items-center","justify-between","text-xs","bg-gray-50","dark:bg-gray-900","p-1.5","rounded"],[1,"font-semibold","text-gray-700","dark:text-gray-300"],[1,"text-gray-500","dark:text-gray-400"],[1,"font-bold","text-purple-700","dark:text-purple-300"],["type","button",1,"flex-1","px-3","py-1.5","bg-purple-600","hover:bg-purple-700","dark:bg-purple-700","dark:hover:bg-purple-600","text-white","text-xs","font-bold","rounded","transition-colors","flex","items-center","justify-center","gap-1",3,"click"],["type","button",1,"flex-1","px-3","py-1.5","bg-indigo-600","hover:bg-indigo-700","dark:bg-indigo-700","dark:hover:bg-indigo-600","text-white","text-xs","font-bold","rounded","transition-colors","flex","items-center","justify-center","gap-1",3,"click"],[1,"text-lg"],[1,"text-xs","font-bold","text-green-900","dark:text-green-100"],[1,"text-xs","text-green-600","dark:text-green-300"],[1,"mt-3","pt-3","border-t","border-red-200","dark:border-red-800"],[1,"text-xs","text-red-600","dark:text-red-400","bg-red-50","dark:bg-red-900/20","p-2","rounded","flex","items-center","gap-1"],[1,"text-xs","text-amber-600","dark:text-amber-400","bg-amber-50","dark:bg-amber-900/20","p-2","rounded","flex","items-center","gap-1"],[1,"mt-3","pt-3","border-t","border-green-200","dark:border-green-700"],[1,"flex","items-center","justify-between","p-2","rounded-lg","cursor-pointer","transition-all",3,"class"],[1,"flex","items-center","justify-between","p-2","rounded-lg","cursor-pointer","transition-all"],["type","radio","name","cuotaCancelacion",1,"w-4","h-4","text-green-600",3,"change","value","checked"],[1,"text-xs","ml-2"],[1,"text-xs","ml-1","px-1","py-0.5","rounded",3,"class"],[1,"font-bold","text-sm"],[1,"text-xs","ml-1","px-1","py-0.5","rounded"],[1,"text-xs","opacity-70","mr-1"],[1,"flex","items-center","gap-2","mb-2"],[1,"text-sm"],[1,"text-xs","font-bold","text-red-700","dark:text-red-400"],[1,"flex","items-center","justify-between","p-2","rounded-lg","bg-red-100","dark:bg-red-900/30","border","border-red-300","dark:border-red-700","opacity-75"],[1,"text-xs","text-red-600","dark:text-red-400","mt-2"],[1,"text-red-500","dark:text-red-400","text-xs"],[1,"font-bold","text-xs","text-red-800","dark:text-red-300"],[1,"text-xs","ml-2","text-red-600","dark:text-red-400"],[1,"font-bold","text-sm","text-red-700","dark:text-red-400"],["name","edit",3,"size"],[1,"text-xs","font-bold","text-green-800","dark:text-green-300"],[1,"grid","grid-cols-2","gap-3"],[1,"block","text-xs","font-semibold","text-green-700","dark:text-green-300","mb-1"],[1,"absolute","left-2","top-1/2","-translate-y-1/2","text-xs","text-gray-500","dark:text-gray-400"],["type","number","step","0.01","min","0",1,"w-full","pl-7","pr-2","py-1.5","text-sm","font-semibold","rounded-lg","border","border-green-300","dark:border-green-600","bg-white","dark:bg-gray-800","text-gray-900","dark:text-white","focus:ring-2","focus:ring-green-500","focus:border-green-500",3,"input","value"],[1,"text-xs","text-green-700","dark:text-green-300","mt-0.5","font-medium"],["type","date",1,"w-full","px-2","py-1.5","text-sm","rounded-lg","border","border-green-300","dark:border-green-600","bg-white","dark:bg-gray-800","text-gray-900","dark:text-white","focus:ring-2","focus:ring-green-500","focus:border-green-500",3,"input","value"],[1,"text-xs","text-green-600","dark:text-green-400","mt-0.5"],[1,"mt-2","p-2","rounded-lg","text-xs",3,"class"],[1,"mt-2","p-2","rounded-lg","text-xs"],["type","button",1,"px-3","py-1.5","text-xs","font-medium","rounded-lg","transition-all",3,"click"],[1,"mt-2","p-2","bg-white","dark:bg-gray-800","rounded","text-xs","space-y-1"],[1,"text-gray-600","dark:text-gray-400"],["type","button",1,"text-red-500","hover:text-red-700","text-xs","underline",3,"click"],[1,"flex","justify-between","items-center","py-1","px-2","rounded","text-xs",3,"class"],[1,"flex","justify-between","items-center","py-1","px-2","rounded","text-xs"],[1,"truncate","mr-2","font-medium",3,"ngClass"],[1,"font-bold","whitespace-nowrap","text-sm",3,"ngClass"],[1,"ml-2","text-xs","text-blue-600","dark:text-blue-400","hover:underline","flex","items-center","gap-1",3,"click"],[1,"ml-1","text-xs","text-purple-600","dark:text-purple-400","hover:underline","flex","items-center","gap-1",3,"click"],[1,"flex","items-center","justify-center","h-full","text-slate-400","dark:text-slate-500","text-xs"],[1,"w-full","text-xs"],[1,"bg-slate-100","dark:bg-slate-800","sticky","top-0"],[1,"text-left","text-slate-600","dark:text-slate-300"],[1,"px-2","py-1","font-semibold"],[1,"px-2","py-1","font-semibold","text-right"],[1,"px-2","py-1","font-semibold","text-center"],[1,"border-b","border-slate-100","dark:border-slate-700/50","hover:bg-blue-50","dark:hover:bg-blue-900/20","transition-colors"],[1,"px-2","py-1.5","text-slate-600","dark:text-slate-300","whitespace-nowrap"],[1,"px-2","py-1.5","text-slate-700","dark:text-slate-200","font-medium","whitespace-nowrap",3,"title"],[1,"px-2","py-1.5","max-w-[180px]"],[1,"text-blue-600","dark:text-blue-400","font-medium","truncate","block",3,"title"],[1,"px-2","py-1.5","text-slate-600","dark:text-slate-300","font-mono","whitespace-nowrap"],[1,"px-2","py-1.5","text-slate-500","dark:text-slate-400","max-w-[120px]","truncate",3,"title"],[1,"px-2","py-1.5"],[1,"px-2","py-1.5","text-right","font-mono","whitespace-nowrap"],[1,"text-green-600","dark:text-green-400","font-semibold"],[1,"text-slate-400","dark:text-slate-600"],[1,"px-2","py-1.5","text-center"],[1,"animate-pulse"],[1,"bg-purple-50","dark:bg-purple-900/20","sticky","top-0"],[1,"border-b","border-slate-100","dark:border-slate-700/50","hover:bg-purple-50","dark:hover:bg-purple-900/20","transition-colors"],[1,"text-purple-600","dark:text-purple-400","font-medium","truncate","block",3,"title"],[1,"bg-white","dark:bg-slate-900","rounded-xl","shadow-2xl","max-w-6xl","w-full","max-h-[90vh]","overflow-hidden","flex","flex-col","animate-slideInUp"],[1,"bg-gradient-to-r","from-purple-600","to-purple-700","dark:from-purple-700","dark:to-purple-800","text-white","px-6","py-4","flex","items-center","justify-between"],[1,"text-lg","font-bold"],["type","button",1,"p-2","hover:bg-white/20","rounded-lg","transition-colors",3,"click"],[1,"flex-1","overflow-y-auto","p-6"],[3,"managementId"],[1,"px-6","py-4","bg-slate-50","dark:bg-slate-800/50","border-t","border-slate-200","dark:border-slate-700","flex","justify-end"],["type","button",1,"px-4","py-2","text-sm","font-semibold","text-slate-700","dark:text-slate-300","hover:bg-slate-200","dark:hover:bg-slate-700","rounded-lg","transition-colors",3,"click"]],template:function(t,i){t&1&&(r(0,"div",1),g(1,li,7,0,"div",2),r(2,"div",3)(3,"div",4)(4,"div",5)(5,"div",6)(6,"div",7),N(7,"lucide-angular",8),o(),r(8,"h1",9),l(9,"Gesti\xF3n de Cobranza"),o()(),r(10,"div",10)(11,"div",11)(12,"div",12),l(13,"Estado"),o(),r(14,"div"),l(15),o()(),N(16,"app-status-alarm-clock",13),r(17,"div"),l(18),o()()()()(),r(19,"div",14)(20,"div",15)(21,"div",16)(22,"div",17),W(23,di,3,4,"button",18,ce),o(),r(25,"div",19)(26,"div"),g(27,hi,16,7,"div",20),g(28,xi,7,1,"div",21),o()()(),r(29,"div",22)(30,"div",23)(31,"div")(32,"div",5)(33,"h3",24),N(34,"div"),l(35," Control de Llamada "),o(),r(36,"div",25)(37,"button",26),C("click",function(){return i.toggleMute()}),l(38),o(),r(39,"button",27),C("click",function(){return i.endCall()}),l(40," Finalizar "),o()()()(),g(41,vi,11,4,"div",28),g(42,Oi,3,0,"div",29),g(43,Vi,7,1,"div",30),g(44,Li,4,0,"div",31),g(45,Ui,4,0,"div",32),g(46,zi,2,4,"app-dynamic-field-renderer",33),g(47,Gi,3,3),g(48,qi,4,0,"div",34),g(49,Zi,11,1,"div",35),g(50,go,14,4,"div",36),g(51,Co,14,4,"div",37),r(52,"div",38)(53,"button",39),C("click",function(){return i.saveManagement()}),g(54,vo,1,0)(55,So,1,0),o(),r(56,"button",40),C("click",function(){return i.cancelarTipificacion()}),l(57," Cancelar "),o()()()(),r(58,"div",41)(59,"div",42)(60,"div",43)(61,"div",44),l(62),o(),r(63,"div",45),l(64),o(),r(65,"div",46),l(66),o()()(),r(67,"div",47),g(68,Po,3,0,"div",48),o()()(),r(69,"div")(70,"div",49)(71,"div",6)(72,"h3",50),l(73,"Historial de Gestiones"),o(),r(74,"div",51)(75,"button",52),C("click",function(){return i.cambiarTabHistorial("actual")}),l(76," Actual "),o(),r(77,"button",52),C("click",function(){return i.cambiarTabHistorial("historico")}),l(78," Hist\xF3rico "),o()(),g(79,Eo,2,2,"span",53)(80,ko,2,2,"span",53),o(),r(81,"button",54),C("click",function(){return i.historialExpanded.set(!i.historialExpanded())}),N(82,"lucide-angular",55),o(),g(83,Mo,10,6,"div",56)(84,Do,10,8,"div",6),o(),r(85,"div",57),g(86,Vo,3,1)(87,qo,3,1),o()()(),g(88,Wo,15,2,"div",58),o()),t&2&&(s(),f(i.showSuccess()?1:-1),s(6),v("size",18),s(7),P("font-semibold text-sm transition-all duration-300 "+(i.callActive()?"text-green-400 animate-pulse":i.isTipifying()?"text-yellow-400":"text-white/80")),s(),b(" ",i.callActive()?"\u25CF EN LLAMADA":i.isTipifying()?"\u270E TIPIFICANDO":"\u25CB DISPONIBLE"," "),s(),v("color",i.colorIndicador())("excedido",i.excedeTiempoMaximo())("size",22),s(),P("px-4 py-1.5 rounded-lg font-mono text-lg font-bold transition-all duration-300 "+(i.callActive()?"bg-gradient-to-r from-red-600 to-red-700 animate-pulse shadow-lg shadow-red-500/30":"bg-blue-800/50 dark:bg-gray-900/80")),s(),b(" ",i.formatTime(i.callDuration())," "),s(5),Y(i.tabs),s(4),f(i.activeTab()==="cliente"?27:-1),s(),f(i.activeTab()==="pautas"?28:-1),s(3),P("bg-white dark:bg-gray-800 rounded-lg shadow-md border p-2 transition-colors duration-300 "+(i.callActive()?"border-green-400 dark:border-green-500":"border-gray-200 dark:border-gray-700")),s(3),P("p-1 rounded transition-all duration-300 "+(i.callActive()?"bg-green-100 dark:bg-green-900/30 animate-pulse":"bg-blue-100 dark:bg-blue-900/30")),s(3),P("px-4 py-1.5 rounded-lg font-bold flex items-center gap-2 transition-all duration-300 text-xs shadow-md hover:shadow-lg "+(i.callActive()?i.isMuted()?"bg-gradient-to-r from-yellow-600 to-yellow-700 hover:from-yellow-700 hover:to-yellow-800 text-white":"bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white":"bg-gray-400 text-gray-200 cursor-not-allowed")),v("disabled",!i.callActive()),s(),b(" ",i.isMuted()?"\u{1F507} Activar":"\u{1F50A} Silenciar"," "),s(),v("disabled",!i.callActive()),s(2),f(i.usesHierarchicalClassifications()?-1:41),s(),f(i.activePaymentSchedules()&&i.activePaymentSchedules().length>0?42:-1),s(),f(i.usesHierarchicalClassifications()?43:-1),s(),f(i.isLoadingDynamicFields()&&i.shouldShowDynamicForm()?44:-1),s(),f(!i.isLoadingDynamicFields()&&i.isLeafClassification()&&i.dynamicFields().length===0&&i.shouldShowDynamicForm()?45:-1),s(),f(!i.isLoadingDynamicFields()&&i.isLeafClassification()&&i.dynamicFieldsSchema()&&i.shouldShowDynamicForm()?46:-1),s(),f(i.esContinuidad()?47:-1),s(),f(i.isLoadingSchedules()?48:-1),s(),f(!i.isLoadingSchedules()&&i.showScheduleHelper()&&i.activeSchedules().length>0?49:-1),s(),f(i.isCancellationTypification()&&(i.pendingInstallmentsForCancellation().length>0||i.overdueInstallments().length>0)?50:-1),s(),f(i.isCancellationTypification()&&i.selectedInstallmentForCancellation()?51:-1),s(2),v("disabled",i.saving()||!i.isFormValid()||i.isCancellationTypification()&&(i.pendingInstallmentsForCancellation().length>0||i.overdueInstallments().length>0)&&!i.selectedInstallmentForCancellation()||i.isCancellationTypification()&&i.pendingInstallmentsForCancellation().length===0&&i.overdueInstallments().length>0)("title","Guardando: "+i.saving()+" | V\xE1lido: "+i.isFormValid()),s(),f(i.saving()?54:55),s(7),v("ngClass",i.themeService.isDarkMode()?"text-red-400":"text-red-800"),s(),E(i.getPrimaryAmountLabel()),s(),v("ngClass",i.themeService.isDarkMode()?"text-red-400":"text-red-800"),s(),E(i.formatCurrency(i.getPrimaryAmountValue())),s(),v("ngClass",i.themeService.isDarkMode()?"text-orange-400":"text-orange-700"),s(),b("",i.clientDiasMora()," d\xEDas mora"),s(2),f(i.clientAmountFields().length>0?68:-1),s(),P((i.historialExpanded()?"h-[50vh]":"h-44")+" bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-700 flex flex-col transition-all duration-300"),s(6),P("px-2 py-0.5 text-xs font-medium transition-colors "+(i.historialTabActivo()==="actual"?"bg-blue-600 text-white":"bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700")),s(2),P("px-2 py-0.5 text-xs font-medium transition-colors border-l border-slate-300 dark:border-slate-600 "+(i.historialTabActivo()==="historico"?"bg-purple-600 text-white":"bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700")),s(2),f(i.historialTabActivo()==="actual"?79:80),s(2),v("title",i.historialExpanded()?"Contraer historial":"Expandir historial"),s(),v("name",i.historialExpanded()?"chevron-down":"chevron-up")("size",16),s(),f(i.historialTabActivo()==="actual"?83:84),s(3),f(i.historialTabActivo()==="actual"?86:87),s(2),f(i.showScheduleDetail()&&i.scheduleManagementId()?88:-1))},dependencies:[ne,st,$e,xt,_t,ht,ze,Be,pt,ut,Dt,Rt,Et,le],styles:["@keyframes _ngcontent-%COMP%_slideInRight{0%{transform:translate(100%);opacity:0}to{transform:translate(0);opacity:1}}@keyframes _ngcontent-%COMP%_fadeIn{0%{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}@keyframes _ngcontent-%COMP%_slideInUp{0%{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}"]});let a=c;return a})();export{wr as CollectionManagementPage};
