import{a as xe}from"./chunk-D723JBXX.js";import{a as _e}from"./chunk-NZPSSX3S.js";import{a as ge}from"./chunk-GCBOYKRX.js";import{E as fe,b as le,c as de,f as se,k as ce,s as me,t as pe,u as ue}from"./chunk-R365LOCT.js";import{Rb as oe,Sb as ae}from"./chunk-PSICT5GB.js";import{a as re}from"./chunk-YQKVMPSG.js";import{$a as r,Ca as Z,Eb as b,Fb as v,Fc as j,Gb as Y,Ib as V,Jb as O,Kb as c,Lb as i,Mb as n,Nb as f,Ub as P,Wb as C,Yb as m,ac as J,ba as $,bc as K,cc as ee,fa as Q,fb as W,g as U,hc as te,jc as B,kc as l,lc as I,ld as ie,ma as x,mb as G,mc as F,na as _,nc as X,pc as w,qc as S,rc as E,sc as q,td as ne,wa as D}from"./chunk-FWGUXTKY.js";var Ce=(()=>{let s=class s{constructor(e){this.http=e,this.baseUrl=`${re.tipificacionUrl}/system-config/field-definitions`}getAllActive(){return this.http.get(this.baseUrl)}getByCategory(e){return this.http.get(`${this.baseUrl}/category/${e}`)}getByDataType(e){return this.http.get(`${this.baseUrl}/data-type/${e}`)}getById(e){return this.http.get(`${this.baseUrl}/${e}`)}getByFieldCode(e){return this.http.get(`${this.baseUrl}/code/${e}`)}countActiveFields(){return this.http.get(`${this.baseUrl}/count`)}};s.\u0275fac=function(t){return new(t||s)(Q(ne))},s.\u0275prov=$({token:s,factory:s.\u0275fac,providedIn:"root"});let d=s;return d})();var ye=["downloadButton"],R=(d,s)=>s.id,we=(d,s)=>s.headerName;function Se(d,s){if(d&1&&(i(0,"option",15),l(1),n()),d&2){let a=s.$implicit;c("value",a.id),r(),I(a.tenantName)}}function Ee(d,s){if(d&1&&(i(0,"option",15),l(1),n()),d&2){let a=s.$implicit;c("value",a.id),r(),I(a.portfolioName)}}function Te(d,s){if(d&1&&(i(0,"option",15),l(1),n()),d&2){let a=s.$implicit;c("value",a.id),r(),I(a.subPortfolioName)}}function De(d,s){if(d&1&&(i(0,"div",40),f(1,"lucide-angular",44),i(2,"span",45),l(3),n(),i(4,"span",46),l(5,"cabecera(s)"),n()()),d&2){let a=m(2);r(),c("size",14),r(2),I(a.previewHeaders().length)}}function Me(d,s){if(d&1){let a=P();i(0,"div",47),C("click",function(){x(a);let t=m(2);return _(t.downloadMenuOpen.set(!1))}),n(),i(1,"div",48)(2,"button",49),C("click",function(){x(a);let t=m(2);return _(t.downloadCSVTemplate())}),f(3,"lucide-angular",50),i(4,"span",51),l(5,"Descargar CSV"),n()(),i(6,"button",49),C("click",function(){x(a);let t=m(2);return _(t.downloadExcelTemplate())}),f(7,"lucide-angular",52),i(8,"span",51),l(9,"Descargar Excel (.xlsx)"),n()()()}if(d&2){let a=m(2);r(),te("top",a.dropdownPosition().top,"px")("left",a.dropdownPosition().left,"px"),r(2),c("size",16),r(4),c("size",16)}}function Ie(d,s){if(d&1){let a=P();i(0,"div",41)(1,"button",53),C("click",function(){x(a);let t=m(2);return _(t.clearAll())}),f(2,"lucide-angular",54),i(3,"span"),l(4,"Limpiar"),n()(),i(5,"button",55),C("click",function(){x(a);let t=m(2);return _(t.confirmConfiguration())}),f(6,"lucide-angular",56),i(7,"span"),l(8,"Guardar"),n()()()}d&2&&(r(2),c("size",14),r(4),c("size",16))}function He(d,s){d&1&&(i(0,"div",42)(1,"div",57),f(2,"lucide-angular",58),n(),i(3,"p",59),l(4,"No hay cabeceras configuradas"),n()()),d&2&&(r(2),c("size",24))}function Pe(d,s){if(d&1&&f(0,"lucide-angular",69),d&2){let a=m().$implicit;c("title",q("Campo transformado mediante expresi\xF3n regular desde: ",a.sourceField))("size",12)}}function Fe(d,s){d&1&&(i(0,"span",72),l(1,"Sin asociar"),n())}function Ne(d,s){if(d&1&&(i(0,"span",73),l(1),n()),d&2){let a=m().$implicit,e=m(3);r(),I(e.getFieldCodeById(a.fieldDefinitionId))}}function Ve(d,s){d&1&&f(0,"lucide-angular",75),d&2&&c("size",14)}function Oe(d,s){d&1&&f(0,"lucide-angular",76),d&2&&c("size",14)}function Le(d,s){if(d&1){let a=P();i(0,"tr",65)(1,"td",66)(2,"div",67)(3,"span",68),l(4),n(),b(5,Pe,1,3,"lucide-angular",69),n()(),i(6,"td",66)(7,"span",70),l(8),n()(),i(9,"td",66)(10,"span",71),l(11),n()(),i(12,"td",66),b(13,Fe,2,0,"span",72)(14,Ne,2,1,"span",73),n(),i(15,"td",66)(16,"span",9),l(17),n()(),i(18,"td",74),b(19,Ve,1,1,"lucide-angular",75)(20,Oe,1,1,"lucide-angular",76),n(),i(21,"td",66)(22,"div",67)(23,"button",77),C("click",function(){let t=x(a).$index,o=m(3);return _(o.editPreviewHeader(t))}),f(24,"lucide-angular",78),n(),i(25,"button",79),C("click",function(){let t=x(a).$index,o=m(3);return _(o.removePreviewHeader(t))}),f(26,"lucide-angular",54),n()()()()}if(d&2){let a=s.$implicit,e=m(3);r(4),I(a.headerName),r(),v(a.sourceField&&a.regexPattern?5:-1),r(2),B(e.getDataTypeBadgeClass(a.dataType)),r(),F(" ",a.dataType," "),r(3),I(a.displayLabel),r(2),v(a.fieldDefinitionId===0?13:14),r(4),I(a.format||"-"),r(2),v(a.required?19:20),r(5),c("size",14),r(2),c("size",14)}}function Ae(d,s){if(d&1&&(i(0,"div",43)(1,"table",60)(2,"thead",61)(3,"tr")(4,"th",62),l(5,"Nombre"),n(),i(6,"th",62),l(7,"Tipo"),n(),i(8,"th",62),l(9,"Etiqueta"),n(),i(10,"th",62),l(11,"Campo Cat\xE1logo"),n(),i(12,"th",62),l(13,"Formato"),n(),i(14,"th",63),l(15,"Req."),n(),i(16,"th",62),l(17,"Acciones"),n()()(),i(18,"tbody",64),V(19,Le,27,11,"tr",65,Y),n()()()),d&2){let a=m(2);r(19),O(a.previewHeaders())}}function ze(d,s){if(d&1){let a=P();i(0,"div",4)(1,"div",23)(2,"div",24)(3,"div",25)(4,"div",26)(5,"button",27,0),C("click",function(){x(a);let t=m();return _(t.toggleDownloadMenu())}),f(7,"lucide-angular",28),i(8,"span",29),l(9,"Descargar Plantilla"),n(),i(10,"span",30),l(11,"Plantilla"),n(),f(12,"lucide-angular",31),n()(),i(13,"select",32),E("ngModelChange",function(t){x(a);let o=m();return S(o.csvSeparator,t)||(o.csvSeparator=t),_(t)}),i(14,"option",33),l(15,"Separador: Punto y coma (;)"),n(),i(16,"option",34),l(17,"Separador: Coma (,)"),n(),i(18,"option",35),l(19,"Separador: Pipe (|)"),n(),i(20,"option",36),l(21,"Separador: Tabulaci\xF3n (Tab)"),n()(),i(22,"label",37),f(23,"lucide-angular",38),i(24,"span",29),l(25,"Importar CSV/Excel"),n(),i(26,"span",30),l(27,"Importar"),n(),i(28,"input",39),C("change",function(t){x(a);let o=m();return _(o.onFileSelected(t))}),n()(),b(29,De,6,2,"div",40),n(),b(30,Me,10,6),b(31,Ie,9,2,"div",41),n()()(),i(32,"div")(33,"div",23),b(34,He,5,1,"div",42)(35,Ae,21,0,"div",43),n()()}if(d&2){let a=m();r(7),c("size",16),r(5),c("name",a.downloadMenuOpen()?"chevron-up":"chevron-down")("size",14),r(),w("ngModel",a.csvSeparator),r(10),c("size",16),r(6),v(a.previewHeaders().length>0?29:-1),r(),v(a.downloadMenuOpen()?30:-1),r(),v(a.previewHeaders().length>0?31:-1),r(3),v(a.previewHeaders().length===0?34:35)}}function ke(d,s){if(d&1&&(i(0,"option",15),l(1),n()),d&2){let a=s.$implicit;c("value",a.id),r(),X(" ",a.fieldName," (",a.fieldCode,") ")}}function We(d,s){if(d&1&&(i(0,"div",9)(1,"span",113),l(2,"Descripci\xF3n:"),n(),l(3),n()),d&2){let a=m();r(3),F(" ",a.description," ")}}function Re(d,s){if(d&1&&(i(0,"div",9)(1,"span",113),l(2,"Formato del Sistema:"),n(),i(3,"code",114),l(4),n()()),d&2){let a=m();r(4),I(a.format)}}function Be(d,s){if(d&1&&(i(0,"div",96)(1,"p",111),l(2,"\u{1F4CB} Informaci\xF3n del Cat\xE1logo"),n(),i(3,"div",5)(4,"span",9),l(5,"Tipo de Dato:"),n(),i(6,"span",112),l(7),n()(),b(8,We,4,1,"div",9),b(9,Re,5,1,"div",9),n()),d&2){let a=s,e=m(2);r(6),B(e.getDataTypeBadgeClass(a.dataType)),r(),F(" ",a.dataType," "),r(),v(a.description?8:-1),r(),v(a.format?9:-1)}}function Xe(d,s){if(d&1){let a=P();i(0,"div")(1,"label",92),f(2,"lucide-angular",115),l(3," Tipo de Dato * "),n(),i(4,"select",94),E("ngModelChange",function(t){x(a);let o=m(2);return S(o.formData.dataType,t)||(o.formData.dataType=t),_(t)}),i(5,"option",116),l(6,"TEXTO"),n(),i(7,"option",117),l(8,"NUMERICO"),n(),i(9,"option",118),l(10,"FECHA"),n()(),i(11,"p",95),l(12," Seleccione el tipo de dato para este campo personalizado. "),n()()}if(d&2){let a=m(2);r(2),c("size",16),r(2),w("ngModel",a.formData.dataType)}}function qe(d,s){if(d&1&&(i(0,"option",15),l(1),n()),d&2){let a=s.$implicit;c("value",a.headerName),r(),X(" ",a.headerName," - ",a.displayLabel," ")}}function je(d,s){d&1&&(i(0,"span",125),l(1,"*"),n())}function Ue(d,s){if(d&1){let a=P();i(0,"p",119),l(1," Si este campo se deriva de otro campo mediante regex, config\xFAralo aqu\xED."),f(2,"br"),l(3," Ejemplo: extraer documento desde IDENTITY_CODE. "),n(),i(4,"div",120)(5,"div")(6,"label",92),f(7,"lucide-angular",121),l(8," Campo Origen "),n(),i(9,"select",122),E("ngModelChange",function(t){x(a);let o=m(2);return S(o.formData.sourceField,t)||(o.formData.sourceField=t),_(t)}),i(10,"option",123),l(11,"Seleccione un campo origen..."),n(),V(12,qe,2,3,"option",15,we),n(),i(14,"p",95),l(15," Campo desde donde se extraer\xE1 el valor mediante regex. "),n()(),i(16,"div")(17,"label",92),f(18,"lucide-angular",124),l(19," Patr\xF3n Regex "),b(20,je,2,0,"span",125),n(),i(21,"input",126),E("ngModelChange",function(t){x(a);let o=m(2);return S(o.formData.regexPattern,t)||(o.formData.regexPattern=t),_(t)}),n(),i(22,"p",95),l(23," Ejemplos: "),i(24,"code",127),l(25),n(),l(26," \xFAltimos 8 \u2022 "),i(27,"code",127),l(28),n(),l(29," 8 d\xEDgitos "),n()()()}if(d&2){let a=m(2);r(7),c("size",16),r(2),w("ngModel",a.formData.sourceField),r(3),O(a.availableSourceHeaders()),r(6),c("size",16),r(2),v(a.formData.sourceField&&a.formData.sourceField.trim()!==""?20:-1),r(),c("placeholder",q("Ej: .",8,"$ (\xFAltimos 8 caracteres)")),w("ngModel",a.formData.regexPattern),r(4),F(".",8,"$"),r(3),F("\\d",8)}}function $e(d,s){if(d&1){let a=P();i(0,"div",22)(1,"div",80)(2,"div",81)(3,"div",82)(4,"div",83)(5,"div",84),f(6,"lucide-angular",85),n(),i(7,"div")(8,"h2",86),l(9),n(),i(10,"p",87),l(11,"Complete la informaci\xF3n de la cabecera"),n()()(),i(12,"button",88),C("click",function(){x(a);let t=m();return _(t.closeManualDialog())}),f(13,"lucide-angular",89),n()()(),i(14,"div",90)(15,"div",91)(16,"div")(17,"label",92),f(18,"lucide-angular",93),l(19," Campo Base de Datos (Opcional) "),n(),i(20,"select",94),E("ngModelChange",function(t){x(a);let o=m();return S(o.formData.fieldDefinitionId,t)||(o.formData.fieldDefinitionId=t),_(t)}),C("ngModelChange",function(){x(a);let t=m();return _(t.onFieldDefinitionSelect())}),i(21,"option",15),l(22,"Sin asociar - Campo personalizado"),n(),V(23,ke,2,3,"option",15,R),n(),i(25,"p",95),l(26,' Seleccione un campo del cat\xE1logo o deje "Sin asociar" para crear un campo personalizado. '),n()(),b(27,Be,10,5,"div",96),b(28,Xe,13,2,"div"),i(29,"div")(30,"label",92),f(31,"lucide-angular",97),l(32," Campo Sistema * "),n(),i(33,"input",98),E("ngModelChange",function(t){x(a);let o=m();return S(o.formData.headerName,t)||(o.formData.headerName=t),_(t)}),n(),i(34,"p",95),l(35," Nombre de la cabecera tal como viene del proveedor. "),n()(),i(36,"div")(37,"label",92),f(38,"lucide-angular",99),l(39," Etiqueta Visual * "),n(),i(40,"input",100),E("ngModelChange",function(t){x(a);let o=m();return S(o.formData.displayLabel,t)||(o.formData.displayLabel=t),_(t)}),n(),i(41,"p",95),l(42," Texto que se mostrar\xE1 en la interfaz de usuario. "),n()(),i(43,"div")(44,"label",92),f(45,"lucide-angular",101),l(46," Formato "),n(),i(47,"input",102),E("ngModelChange",function(t){x(a);let o=m();return S(o.formData.format,t)||(o.formData.format=t),_(t)}),n(),i(48,"p",95),l(49," Formato espec\xEDfico para esta subcartera (opcional, puede diferir del formato del sistema). "),n()(),i(50,"div",83)(51,"input",103),E("ngModelChange",function(t){x(a);let o=m();return S(o.formData.required,t)||(o.formData.required=t),_(t)}),n(),i(52,"label",104),l(53," Campo obligatorio "),n()(),i(54,"div",105)(55,"button",106),C("click",function(){x(a);let t=m();return _(t.showTransformSection.set(!t.showTransformSection()))}),i(56,"div",5),f(57,"lucide-angular",107),l(58," Transformaci\xF3n de Campo (Opcional) "),n(),f(59,"lucide-angular",31),n(),b(60,Ue,30,9),n()()(),i(61,"div",108)(62,"button",109),C("click",function(){x(a);let t=m();return _(t.closeManualDialog())}),l(63," Cancelar "),n(),i(64,"button",110),C("click",function(){x(a);let t=m();return _(t.saveManualHeader())}),l(65),n()()()()}if(d&2){let a,e=m();r(6),c("size",20),r(3),F("",e.editingIndex()!==null?"Editar":"Agregar"," Cabecera"),r(4),c("size",20),r(5),c("size",16),r(2),w("ngModel",e.formData.fieldDefinitionId),r(),c("value",0),r(2),O(e.availableFieldDefinitions()),r(4),v((a=e.getSelectedFieldDefinition())?27:-1,a),r(),v(e.formData.fieldDefinitionId===0?28:-1),r(3),c("size",16),r(2),w("ngModel",e.formData.headerName),r(5),c("size",16),r(2),w("ngModel",e.formData.displayLabel),r(5),c("size",16),r(2),w("ngModel",e.formData.format),r(4),w("ngModel",e.formData.required),r(6),c("size",16),r(2),c("name",e.showTransformSection()?"chevron-up":"chevron-down")("size",16),r(),v(e.showTransformSection()?60:-1),r(4),c("disabled",!e.canSaveManualHeader()),r(),F(" ",e.editingIndex()!==null?"Actualizar":"Agregar"," ")}}var lt=(()=>{let s=class s{constructor(e,t,o,p){this.headerConfigService=e,this.fieldDefinitionService=t,this.typificationService=o,this.portfolioService=p,this.tenants=D([]),this.portfolios=D([]),this.subPortfolios=D([]),this.fieldDefinitions=D([]),this.previewHeaders=D([]),this.showManualDialog=D(!1),this.editingIndex=D(null),this.downloadMenuOpen=D(!1),this.showTransformSection=D(!1),this.dropdownPosition=D({top:120,left:100}),this.headersAreSaved=D(!1),this.availableFieldDefinitions=j(()=>{let u=this.previewHeaders().map(T=>T.fieldDefinitionId),g=this.formData.fieldDefinitionId,y=this.editingIndex();return this.fieldDefinitions().filter(T=>y!==null&&T.id===g?!0:!u.includes(T.id))}),this.availableSourceHeaders=j(()=>{let u=this.formData.headerName;return this.previewHeaders().filter(g=>!(g.sourceField&&g.regexPattern||g.headerName===u))}),this.selectedTenantId=0,this.selectedPortfolioId=0,this.selectedSubPortfolioId=0,this.selectedLoadType="ACTUALIZACION",this.csvSeparator=";",this.formData={fieldDefinitionId:0,headerName:"",dataType:"TEXTO",displayLabel:"",format:"",required:!1,sourceField:"",regexPattern:""}}ngOnInit(){this.loadTenants(),this.loadFieldDefinitions()}loadFieldDefinitions(){this.fieldDefinitionService.getAllActive().subscribe({next:e=>{this.fieldDefinitions.set(e)},error:e=>{console.error("Error al cargar definiciones de campos:",e)}})}loadTenants(){this.typificationService.getAllTenants().subscribe({next:e=>{this.tenants.set(e)},error:e=>{console.error("Error loading tenants:",e)}})}onTenantChange(){this.selectedPortfolioId=0,this.selectedSubPortfolioId=0,this.portfolios.set([]),this.subPortfolios.set([]),this.previewHeaders.set([]),this.selectedTenantId>0&&this.loadPortfolios()}onPortfolioChange(){this.selectedSubPortfolioId=0,this.subPortfolios.set([]),this.previewHeaders.set([]),this.selectedPortfolioId>0&&this.loadSubPortfolios()}onSubPortfolioChange(){this.previewHeaders.set([]),this.headersAreSaved.set(!1),this.selectedSubPortfolioId>0&&this.loadExistingHeaders()}onLoadTypeChange(){this.previewHeaders.set([]),this.headersAreSaved.set(!1),this.selectedSubPortfolioId>0&&this.loadExistingHeaders()}loadPortfolios(){this.portfolioService.getPortfoliosByTenant(this.selectedTenantId).subscribe({next:e=>{this.portfolios.set(e)},error:e=>{console.error("Error loading portfolios:",e)}})}loadSubPortfolios(){this.portfolioService.getSubPortfoliosByPortfolio(this.selectedPortfolioId).subscribe({next:e=>{this.subPortfolios.set(e)},error:e=>{console.error("Error loading subportfolios:",e)}})}loadExistingHeaders(){this.headerConfigService.getBySubPortfolioAndLoadType(this.selectedSubPortfolioId,this.selectedLoadType).subscribe({next:e=>{let t=e.map(o=>({fieldDefinitionId:o.fieldDefinitionId,headerName:o.headerName,dataType:o.dataType,displayLabel:o.displayLabel,format:o.format,required:o.required,sourceField:o.sourceField,regexPattern:o.regexPattern}));this.previewHeaders.set(t),this.headersAreSaved.set(e.length>0)},error:e=>{console.error("Error loading headers:",e),this.headersAreSaved.set(!1)}})}openManualDialog(){this.editingIndex.set(null),this.formData={fieldDefinitionId:0,headerName:"",dataType:"TEXTO",displayLabel:"",format:"",required:!1,sourceField:"",regexPattern:""},this.showTransformSection.set(!1),this.showManualDialog.set(!0)}onFieldDefinitionSelect(){let e=this.formData.fieldDefinitionId;if(e===0){this.formData.dataType="TEXTO";return}let t=this.fieldDefinitions().find(o=>o.id===e);t&&(this.formData.dataType=t.dataType)}getSelectedFieldDefinition(){let e=this.formData.fieldDefinitionId;return e===0?null:this.fieldDefinitions().find(t=>t.id===e)}closeManualDialog(){this.showManualDialog.set(!1),this.editingIndex.set(null)}canSaveManualHeader(){return!this.formData.headerName.trim()||!this.formData.displayLabel.trim()||this.formData.sourceField&&this.formData.sourceField.trim()!==""&&(!this.formData.regexPattern||this.formData.regexPattern.trim()==="")?!1:this.formData.fieldDefinitionId===0?!!this.formData.dataType&&["TEXTO","NUMERICO","FECHA"].includes(this.formData.dataType):!0}saveManualHeader(){if(!this.canSaveManualHeader())return;let e={fieldDefinitionId:this.formData.fieldDefinitionId,headerName:this.formData.headerName.trim(),dataType:this.formData.dataType,displayLabel:this.formData.displayLabel.trim(),format:this.formData.format?.trim()||void 0,required:this.formData.required,sourceField:this.formData.sourceField?.trim()||void 0,regexPattern:this.formData.regexPattern?.trim()||void 0},t=[...this.previewHeaders()],o=this.editingIndex();o!==null?t[o]=e:t.push(e),this.previewHeaders.set(t),this.closeManualDialog()}editPreviewHeader(e){let t=this.previewHeaders()[e];this.editingIndex.set(e),this.formData={fieldDefinitionId:t.fieldDefinitionId,headerName:t.headerName,dataType:t.dataType,displayLabel:t.displayLabel,format:t.format||"",required:t.required||!1,sourceField:t.sourceField||"",regexPattern:t.regexPattern||""},this.showTransformSection.set(!!(t.sourceField||t.regexPattern)),this.showManualDialog.set(!0)}removePreviewHeader(e){let t=[...this.previewHeaders()];t.splice(e,1),this.previewHeaders.set(t)}clearAll(){confirm("\xBFEst\xE1 seguro de limpiar todas las cabeceras? Esta acci\xF3n no se puede deshacer.")&&this.previewHeaders.set([])}confirmConfiguration(){if(this.previewHeaders().length===0){alert("No hay cabeceras para confirmar");return}if(!confirm(`\xBFConfirmar la configuraci\xF3n de ${this.previewHeaders().length} cabeceras?`))return;let e={subPortfolioId:this.selectedSubPortfolioId,loadType:this.selectedLoadType,headers:this.previewHeaders()};this.headerConfigService.deleteAllBySubPortfolioAndLoadType(this.selectedSubPortfolioId,this.selectedLoadType).subscribe({next:()=>{this.headerConfigService.createBulk(e).subscribe({next:()=>{alert("Configuraci\xF3n guardada exitosamente"),this.loadExistingHeaders()},error:t=>{console.error("Error saving configuration:",t),alert("Error al guardar la configuraci\xF3n: "+(t.error?.message||t.message))}})},error:t=>{console.error("Error deleting old configuration:",t),alert("Error al eliminar configuraci\xF3n anterior")}})}onFileSelected(e){let t=e.target.files[0];if(!t)return;let o=t.name.toLowerCase();if(o.endsWith(".xlsx")||o.endsWith(".xls"))this.parseExcel(t);else{let u=new FileReader;u.onload=g=>{let y=g.target.result;this.parseCSV(y)},u.readAsText(t)}e.target.value=""}parseExcel(e){let t=new FileReader;t.onload=o=>{try{if(!window.XLSX){alert("Cargando soporte para Excel... intente nuevamente en unos segundos."),this.loadXLSXLibrary().then(()=>{this.parseExcel(e)});return}let p=window.XLSX,u=new Uint8Array(o.target.result),g=p.read(u,{type:"array"}),y=g.SheetNames[0],T=g.Sheets[y],L=p.utils.sheet_to_csv(T,{FS:this.csvSeparator});this.parseCSV(L)}catch(p){console.error("Error al procesar Excel:",p),alert("Error al procesar el archivo Excel. Verifique que el formato sea correcto.")}},t.readAsArrayBuffer(e)}loadXLSXLibrary(){return new Promise((e,t)=>{if(window.XLSX){e();return}let o=document.createElement("script");o.src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js",o.onload=()=>e(),o.onerror=()=>t(new Error("No se pudo cargar la librer\xEDa XLSX")),document.head.appendChild(o)})}parseCsvLine(e,t){let o=[],p="",u=!1;for(let g=0;g<e.length;g++){let y=e[g];y==='"'?u=!u:y===t&&!u?(o.push(p.trim()),p=""):p+=y}return o.push(p.trim()),o.map(g=>g.startsWith('"')&&g.endsWith('"')?g.slice(1,-1):g)}parseCSV(e){let t=e.split(`
`).filter(p=>p.trim());if(t.length<2){alert("El archivo CSV est\xE1 vac\xEDo o no tiene datos");return}let o=[];for(let p=1;p<t.length;p++){let u=this.parseCsvLine(t[p],this.csvSeparator);if(u.length<3)continue;let[g,y,T,L,A,h,N,z]=u;if(!y||!T)continue;let H=h?h==="1"||h.toLowerCase()==="true":void 0,M=z?.trim();if(M&&M.startsWith('"')&&M.endsWith('"')&&(M=M.slice(1,-1)),!g||g.trim()===""){if(!A||!["TEXTO","NUMERICO","FECHA"].includes(A.toUpperCase())){alert(`Campo personalizado en l\xEDnea ${p+1} requiere un tipo de dato v\xE1lido (TEXTO, NUMERICO, FECHA)`);return}o.push({fieldDefinitionId:0,headerName:y.trim(),dataType:A.toUpperCase(),displayLabel:T.trim(),format:L?.trim()||void 0,required:H,sourceField:N?.trim()||void 0,regexPattern:M||void 0})}else{let k=this.fieldDefinitions().find(he=>he.fieldCode===g.trim());if(!k){alert(`C\xF3digo de campo no encontrado en l\xEDnea ${p+1}: ${g}. Revise el cat\xE1logo de campos.`);return}o.push({fieldDefinitionId:k.id,headerName:y.trim(),dataType:k.dataType,displayLabel:T.trim(),format:L?.trim()||void 0,required:H!==void 0?H:!0,sourceField:N?.trim()||void 0,regexPattern:M||void 0})}}if(o.length===0){alert("No se encontraron cabeceras v\xE1lidas en el archivo CSV");return}this.previewHeaders.set(o),alert(`Se importaron ${o.length} cabeceras exitosamente`)}toggleDownloadMenu(){if(this.downloadMenuOpen.update(e=>!e),this.downloadMenuOpen()&&this.downloadButton){let e=this.downloadButton.nativeElement.getBoundingClientRect();this.dropdownPosition.set({top:e.bottom+8,left:e.left})}}escapeCsvValue(e,t){return e?e.includes(t)||e.includes('"')||e.includes(`
`)||e.includes("\r")?`"${e.replace(/"/g,'""')}"`:e:""}createCsvRow(e,t){return e.map(o=>this.escapeCsvValue(o,t)).join(t)}downloadCSVTemplate(){this.downloadMenuOpen.set(!1);let e=this.csvSeparator,t;this.previewHeaders().length>0?(t=[["codigoCampo","nombreCabecera","etiquetaVisual","formato","tipoDato","obligatorio","campoAsociado","regEx"]],this.previewHeaders().forEach(h=>{let N=this.fieldDefinitions().find(H=>H.id===h.fieldDefinitionId),z=N?N.fieldCode:"";t.push([z,h.headerName,h.displayLabel,h.format||"",h.dataType||"",h.required?"1":"0",h.sourceField||"",h.regexPattern||""])})):t=[["codigoCampo","nombreCabecera","etiquetaVisual","formato","tipoDato","obligatorio","campoAsociado","regEx"],["documento","DNI","N\xFAmero de Documento","","TEXTO","1","",""],["nombre_completo","NOMBRE","Nombre del Cliente","","TEXTO","1","",""],["telefono_principal","TELEFONO","Tel\xE9fono Principal","","TEXTO","0","",""],["email","CORREO","Correo Electr\xF3nico","","TEXTO","0","",""],["monto_capital","MONTO_CAPITAL","Monto Capital (S/.)","decimal(18,2)","NUMERICO","1","",""],["fecha_vencimiento","FEC_VENC","Fecha de Vencimiento","dd/MM/yyyy","FECHA","1","",""],["","DOCUMENTO_EXTRAIDO","Documento Extra\xEDdo","","TEXTO","0","DNI",'"^D.*?(\\d{7})$|^C.*?(\\d{8})$"']];let p=t.map((h,N)=>{if(N===0)return this.createCsvRow(h,e);let z=h.slice(0,7),H=h[7]||"",M=this.createCsvRow(z,e);if(H&&H.trim()!==""){let k=H.replace(/"/g,'""');M+=e+`"${k}"`}else M+=e;return M}).join(`
`),u=new Blob([p],{type:"text/csv;charset=utf-8;"}),g=document.createElement("a"),y=URL.createObjectURL(u),T=this.csvSeparator===","?"coma":this.csvSeparator===";"?"punto-coma":this.csvSeparator==="|"?"pipe":"tab",L=this.previewHeaders().length>0?`header-configuration-actual-${T}.csv`:`header-configuration-template-${T}.csv`;g.setAttribute("href",y),g.setAttribute("download",L),g.style.visibility="hidden",document.body.appendChild(g),g.click(),document.body.removeChild(g);let A=this.previewHeaders().length>0?"Configuraci\xF3n actual descargada exitosamente":"Plantilla CSV descargada exitosamente";alert(A)}downloadExcelTemplate(){return U(this,null,function*(){if(this.downloadMenuOpen.set(!1),!window.XLSX)try{yield this.loadXLSXLibrary()}catch{alert("No se pudo cargar el soporte para Excel. Intente de nuevo.");return}let e=window.XLSX,t=[["codigoCampo","nombreCabecera","etiquetaVisual","formato","tipoDato"],["documento","DNI","N\xFAmero de Documento","",""],["nombre_completo","NOMBRE","Nombre del Cliente","",""],["telefono_principal","TELEFONO","Tel\xE9fono Principal","",""],["email","CORREO","Correo Electr\xF3nico","",""],["direccion","DIRECCION","Direcci\xF3n Completa","",""],["distrito","DISTRITO","Distrito","",""],["provincia","PROVINCIA","Provincia","",""],["numero_contrato","NRO_CONTRATO","N\xFAmero de Contrato","",""],["tipo_producto","PRODUCTO","Tipo de Producto","",""],["estado_cuenta","ESTADO","Estado de Cuenta","",""],["monto_capital","MONTO_CAPITAL","Monto Capital (S/.)","decimal(18,2)",""],["monto_interes","INTERES","Inter\xE9s (S/.)","decimal(18,2)",""],["saldo_pendiente","SALDO","Saldo Pendiente (S/.)","decimal(18,2)",""],["monto_mora","MORA","Monto Mora (S/.)","decimal(18,2)",""],["dias_mora","DIAS_MORA","D\xEDas de Mora","",""],["monto_minimo_pagar","PAGO_MINIMO","Monto M\xEDnimo a Pagar (S/.)","decimal(18,2)",""],["fecha_vencimiento","FEC_VENC","Fecha de Vencimiento","dd/MM/yyyy",""],["fecha_desembolso","FEC_DESEMB","Fecha de Desembolso","dd/MM/yyyy",""],["fecha_proximo_vencimiento","FEC_PROX_VENC","Fecha Pr\xF3ximo Vencimiento","dd/MM/yyyy",""],["fecha_corte","FEC_CORTE","Fecha de Corte","dd/MM/yyyy",""],["","CAMPO_PERSONALIZADO","Ejemplo Campo Extra","","TEXTO"]],o=e.utils.book_new(),p=e.utils.aoa_to_sheet(t);p["!cols"]=[{wch:25},{wch:20},{wch:30},{wch:20},{wch:15}],e.utils.book_append_sheet(o,p,"Configuraci\xF3n Cabeceras"),e.writeFile(o,"header-configuration-template.xlsx"),alert("Modelo Excel descargado exitosamente")})}getDataTypeBadgeClass(e){switch(e){case"TEXTO":return"bg-blue-900/30 text-blue-400";case"NUMERICO":return"bg-emerald-900/30 text-emerald-400";case"FECHA":return"bg-amber-900/30 text-amber-400";default:return"bg-gray-900/30 text-gray-400"}}getFieldCodeById(e){let t=this.fieldDefinitions().find(o=>o.id===e);return t?t.fieldCode:"-"}};s.\u0275fac=function(t){return new(t||s)(W(_e),W(Ce),W(xe),W(ge))},s.\u0275cmp=G({type:s,selectors:[["app-header-configuration"]],viewQuery:function(t,o){if(t&1&&J(ye,5,Z),t&2){let p;K(p=ee())&&(o.downloadButton=p.first)}},decls:53,vars:17,consts:[["downloadButton",""],[1,"h-[calc(100dvh-56px)]","bg-slate-950","overflow-hidden","flex","flex-col"],[1,"flex-1","overflow-y-auto"],[1,"p-3","max-w-7xl","mx-auto"],[1,"mb-2"],[1,"flex","items-center","gap-2"],[1,"w-8","h-8","bg-gradient-to-br","from-indigo-600","to-indigo-700","rounded-lg","flex","items-center","justify-center"],["name","table-2",1,"text-white",3,"size"],[1,"text-lg","font-bold","text-white"],[1,"text-xs","text-gray-400"],[1,"bg-slate-900","rounded-lg","p-2","shadow-sm","border","border-slate-800"],[1,"grid","grid-cols-1","md:grid-cols-4","gap-2"],[1,"block","text-xs","font-semibold","text-gray-300","mb-1"],["name","building-2",1,"inline","mr-1",3,"size"],[1,"w-full","px-3","py-1.5","bg-slate-800","border","border-slate-700","rounded-lg","text-white","text-sm","focus:outline-none","focus:ring-2","focus:ring-indigo-500",3,"ngModelChange","ngModel"],[3,"value"],["name","folder",1,"inline","mr-1",3,"size"],[1,"w-full","px-3","py-1.5","bg-slate-800","border","border-slate-700","rounded-lg","text-white","text-sm","focus:outline-none","focus:ring-2","focus:ring-indigo-500","disabled:opacity-50","disabled:cursor-not-allowed",3,"ngModelChange","ngModel","disabled"],["name","folder-tree",1,"inline","mr-1",3,"size"],["name","database",1,"inline","mr-1",3,"size"],["value","ACTUALIZACION"],["value","INICIAL"],[1,"fixed","inset-0","bg-black/80","backdrop-blur-sm","flex","items-center","justify-center","z-50","p-4"],[1,"bg-slate-900","rounded-lg","shadow-sm","border","border-slate-800","overflow-hidden"],[1,"p-3"],[1,"flex","flex-wrap","items-center","gap-2","mb-2"],[1,"relative"],[1,"flex","items-center","gap-1.5","px-3","py-1.5","bg-blue-600","text-white","rounded-lg","text-sm","font-medium","hover:bg-blue-700","transition-all","cursor-pointer",3,"click"],["name","file-text",3,"size"],[1,"hidden","sm:inline"],[1,"sm:hidden"],[3,"name","size"],[1,"px-3","py-1.5","bg-slate-800","border","border-slate-700","rounded-lg","text-white","text-sm","focus:outline-none","focus:ring-2","focus:ring-emerald-500","cursor-pointer",3,"ngModelChange","ngModel"],["value",";"],["value",","],["value","|"],["value","	"],[1,"flex","items-center","gap-1.5","px-3","py-1.5","bg-emerald-600","text-white","rounded-lg","text-sm","font-medium","hover:bg-emerald-700","transition-all","cursor-pointer"],["name","folder-open",3,"size"],["type","file","accept",".csv,.xlsx,.xls",1,"hidden",3,"change"],[1,"ml-auto","flex","items-center","gap-2","px-3","py-1.5"],[1,"flex","flex-wrap","items-center","justify-end","gap-2","pt-2","border-t","border-slate-700"],[1,"p-6","text-center"],[1,"overflow-x-auto","max-h-[calc(100dvh-340px)]","overflow-y-auto"],["name","table-2",1,"text-indigo-400",3,"size"],[1,"text-sm","font-semibold","text-indigo-400"],[1,"text-xs","text-indigo-400"],[1,"fixed","inset-0","z-[9998]",3,"click"],[1,"fixed","w-56","bg-slate-800","rounded-lg","shadow-xl","border","border-slate-700","py-1","z-[9999]"],[1,"w-full","flex","items-center","gap-2","px-3","py-2","hover:bg-slate-700","transition-colors","text-left","text-gray-300","cursor-pointer",3,"click"],["name","file-text",1,"text-gray-400",3,"size"],[1,"text-sm","font-medium"],["name","table-2",1,"text-green-400",3,"size"],[1,"flex","items-center","gap-1","px-3","py-1.5","bg-slate-800","text-gray-300","rounded-lg","text-sm","hover:bg-slate-700","hover:text-white","transition-all","cursor-pointer",3,"click"],["name","trash-2",3,"size"],[1,"flex","items-center","gap-1.5","px-3","py-1.5","bg-green-600","text-white","rounded-lg","text-sm","font-medium","hover:bg-green-700","transition-all","cursor-pointer",3,"click"],["name","save",3,"size"],[1,"w-12","h-12","bg-slate-800","rounded-full","flex","items-center","justify-center","mx-auto","mb-2"],["name","table-2",1,"text-gray-600",3,"size"],[1,"text-sm","text-gray-400"],[1,"w-full"],[1,"bg-slate-800","border-b","border-slate-700","sticky","top-0"],[1,"px-2","py-1.5","text-left","text-xs","font-semibold","text-gray-400"],[1,"px-2","py-1.5","text-center","text-xs","font-semibold","text-gray-400"],[1,"divide-y","divide-slate-800"],[1,"hover:bg-slate-800","transition-colors"],[1,"px-2","py-1.5"],[1,"flex","items-center","gap-1"],[1,"font-mono","text-xs","font-semibold","text-indigo-400"],["name","sparkles",1,"text-amber-400","flex-shrink-0",3,"size","title"],[1,"inline-flex","px-1.5","py-0.5","rounded","text-xs","font-medium"],[1,"text-xs","text-white"],[1,"text-xs","text-amber-400","italic"],[1,"font-mono","text-xs","text-gray-400"],[1,"px-2","py-1.5","text-center"],["name","check-circle",1,"text-green-400","inline",3,"size"],["name","circle",1,"text-gray-600","inline",3,"size"],["title","Editar",1,"p-1","text-blue-400","hover:bg-slate-800","rounded","transition-colors",3,"click"],["name","edit",3,"size"],["title","Eliminar",1,"p-1","text-red-400","hover:bg-slate-800","rounded","transition-colors",3,"click"],[1,"bg-slate-900","rounded-xl","shadow-2xl","max-w-2xl","w-full","max-h-[90vh]","overflow-hidden","border","border-slate-800"],[1,"bg-gradient-to-r","from-indigo-600","to-indigo-700","p-5","text-white"],[1,"flex","items-center","justify-between"],[1,"flex","items-center","gap-3"],[1,"w-10","h-10","bg-white/20","rounded-lg","flex","items-center","justify-center"],["name","plus-circle",3,"size"],[1,"text-xl","font-bold"],[1,"text-indigo-100","text-sm"],[1,"text-white/80","hover:text-white",3,"click"],["name","x",3,"size"],[1,"p-6","overflow-y-auto","max-h-[calc(90vh-200px)]"],[1,"space-y-4"],[1,"block","text-sm","font-semibold","text-gray-300","mb-2"],["name","book-open",1,"inline","mr-1",3,"size"],[1,"w-full","px-4","py-2.5","bg-slate-800","border","border-slate-700","rounded-lg","text-white","focus:outline-none","focus:ring-2","focus:ring-indigo-500",3,"ngModelChange","ngModel"],[1,"text-xs","text-gray-400","mt-1"],[1,"bg-slate-800/50","rounded-lg","p-4","space-y-2","border","border-slate-700/50"],["name","settings",1,"inline","mr-1",3,"size"],["type","text","placeholder","Ej: DNI, Saldo Vencido, Tel\xE9fono Principal",1,"w-full","px-4","py-2.5","bg-slate-800","border","border-slate-700","rounded-lg","text-white","placeholder-gray-500","focus:outline-none","focus:ring-2","focus:ring-indigo-500",3,"ngModelChange","ngModel"],["name","eye",1,"inline","mr-1",3,"size"],["type","text","placeholder","Ej: N\xFAmero de Documento, Saldo Pendiente",1,"w-full","px-4","py-2.5","bg-slate-800","border","border-slate-700","rounded-lg","text-white","placeholder-gray-500","focus:outline-none","focus:ring-2","focus:ring-indigo-500",3,"ngModelChange","ngModel"],["name","file-text",1,"inline","mr-1",3,"size"],["type","text","placeholder","Ej: dd/MM/yyyy, decimal(18,2)",1,"w-full","px-4","py-2.5","bg-slate-800","border","border-slate-700","rounded-lg","text-white","placeholder-gray-500","focus:outline-none","focus:ring-2","focus:ring-indigo-500",3,"ngModelChange","ngModel"],["type","checkbox","id","required",1,"w-4","h-4","text-indigo-600","bg-slate-800","border-slate-700","rounded","focus:ring-indigo-500",3,"ngModelChange","ngModel"],["for","required",1,"text-sm","text-gray-300"],[1,"col-span-2","border-t","border-slate-700","pt-4","mt-2"],["type","button",1,"w-full","flex","items-center","justify-between","text-sm","font-bold","text-emerald-400","mb-3","hover:text-emerald-300","transition-colors",3,"click"],["name","git-branch",3,"size"],[1,"border-t","border-slate-800","p-4","flex","justify-end","gap-3","bg-slate-950"],[1,"px-5","py-2","text-gray-400","hover:bg-slate-800","hover:text-white","rounded-lg","font-medium","transition-colors",3,"click"],[1,"px-5","py-2","bg-gradient-to-r","from-indigo-600","to-indigo-700","text-white","rounded-lg","font-semibold","hover:shadow-lg","transition-all","disabled:opacity-50","disabled:cursor-not-allowed",3,"click","disabled"],[1,"text-xs","font-semibold","text-gray-400","mb-2"],[1,"inline-flex","px-2","py-0.5","rounded","text-xs","font-medium"],[1,"font-semibold"],[1,"text-cyan-400"],["name","type",1,"inline","mr-1",3,"size"],["value","TEXTO"],["value","NUMERICO"],["value","FECHA"],[1,"text-xs","text-gray-400","mb-4"],[1,"grid","grid-cols-1","gap-4"],["name","arrow-right",1,"inline","mr-1",3,"size"],[1,"w-full","px-4","py-2.5","bg-slate-800","border","border-slate-700","rounded-lg","text-white","focus:outline-none","focus:ring-2","focus:ring-emerald-500",3,"ngModelChange","ngModel"],["value",""],["name","code",1,"inline","mr-1",3,"size"],[1,"text-red-400","ml-1"],["type","text",1,"w-full","px-4","py-2.5","bg-slate-800","border","border-slate-700","rounded-lg","text-white","placeholder-gray-500","focus:outline-none","focus:ring-2","focus:ring-emerald-500","font-mono","text-sm",3,"ngModelChange","ngModel","placeholder"],[1,"text-emerald-400"]],template:function(t,o){t&1&&(i(0,"div",1)(1,"div",2)(2,"div",3)(3,"div",4)(4,"div",5)(5,"div",6),f(6,"lucide-angular",7),n(),i(7,"div")(8,"h1",8),l(9,"Configuraci\xF3n de Cabeceras"),n(),i(10,"p",9),l(11,"Define las cabeceras personalizadas por subcartera"),n()()()(),i(12,"div",4)(13,"div",10)(14,"div",11)(15,"div")(16,"label",12),f(17,"lucide-angular",13),l(18," Proveedor "),n(),i(19,"select",14),E("ngModelChange",function(u){return S(o.selectedTenantId,u)||(o.selectedTenantId=u),u}),C("ngModelChange",function(){return o.onTenantChange()}),i(20,"option",15),l(21,"Seleccione un proveedor..."),n(),V(22,Se,2,2,"option",15,R),n()(),i(24,"div")(25,"label",12),f(26,"lucide-angular",16),l(27," Cartera "),n(),i(28,"select",17),E("ngModelChange",function(u){return S(o.selectedPortfolioId,u)||(o.selectedPortfolioId=u),u}),C("ngModelChange",function(){return o.onPortfolioChange()}),i(29,"option",15),l(30,"Seleccione una cartera..."),n(),V(31,Ee,2,2,"option",15,R),n()(),i(33,"div")(34,"label",12),f(35,"lucide-angular",18),l(36," Subcartera "),n(),i(37,"select",17),E("ngModelChange",function(u){return S(o.selectedSubPortfolioId,u)||(o.selectedSubPortfolioId=u),u}),C("ngModelChange",function(){return o.onSubPortfolioChange()}),i(38,"option",15),l(39,"Seleccione una subcartera..."),n(),V(40,Te,2,2,"option",15,R),n()(),i(42,"div")(43,"label",12),f(44,"lucide-angular",19),l(45," Tipo de Carga "),n(),i(46,"select",17),E("ngModelChange",function(u){return S(o.selectedLoadType,u)||(o.selectedLoadType=u),u}),C("ngModelChange",function(){return o.onLoadTypeChange()}),i(47,"option",20),l(48,"Carga Diaria"),n(),i(49,"option",21),l(50,"Carga Inicial del Mes"),n()()()()()(),b(51,ze,36,9),b(52,$e,66,21,"div",22),n()()()),t&2&&(r(6),c("size",16),r(11),c("size",16),r(2),w("ngModel",o.selectedTenantId),r(),c("value",0),r(2),O(o.tenants()),r(4),c("size",16),r(2),w("ngModel",o.selectedPortfolioId),c("disabled",o.selectedTenantId===0),r(),c("value",0),r(2),O(o.portfolios()),r(4),c("size",16),r(2),w("ngModel",o.selectedSubPortfolioId),c("disabled",o.selectedPortfolioId===0),r(),c("value",0),r(2),O(o.subPortfolios()),r(4),c("size",16),r(2),w("ngModel",o.selectedLoadType),c("disabled",o.selectedSubPortfolioId===0),r(5),v(o.selectedSubPortfolioId>0?51:-1),r(),v(o.showManualDialog()?52:-1))},dependencies:[ie,fe,pe,ue,de,le,me,se,ce,ae,oe],styles:["[_nghost-%COMP%]{display:block}"]});let d=s;return d})();export{lt as HeaderConfigurationComponent};
