{
  "version": 3,
  "sources": ["src/app/core/services/autodialer.service.ts"],
  "sourcesContent": ["import { Injectable } from '@angular/core';\nimport { HttpClient, HttpHeaders } from '@angular/common/http';\nimport { Observable, interval, switchMap, startWith } from 'rxjs';\nimport { environment } from '../../../environments/environment';\n\nexport interface AutoDialerStatus {\n  activo: boolean;\n  fechaActivacion?: string;\n  fechaDesactivacion?: string;\n  usuarioActivacion?: string;\n  notas?: string;\n}\n\nexport interface AutoDialerEstadisticas {\n  activo: boolean;\n  agentesDisponibles: number;\n  contactosPendientes: number;\n  llamadasActivas: number;\n  llamadasCompletadasHoy: number;\n  contactosCompletados: number;\n  contactosFallidos: number;\n  // Nuevas métricas detalladas\n  totalLlamadas: number;\n  llamadasEnCola: number;\n  llamadasConectadas: number;\n  llamadasMarcando: number;\n  llamadasNoContestadas: number;\n  llamadasAbandonadas: number;\n  duracionPromedioSegundos: number;\n  duracionPromedioFormato: string;\n  duracionMaximaSegundos: number;\n  duracionMaximaFormato: string;\n}\n\nexport interface AgenteMonitoreo {\n  idUsuario: number;\n  sipExtension: string;\n  nombreCompleto: string;\n  estadoActual: string;\n  telefonoDestino: string | null;\n  segundosEnEstado: number;\n  uuidLlamadaActual: string | null;\n  // Campos de umbral de tiempo\n  colorIndicador: 'verde' | 'amarillo' | 'rojo';\n  porcentajeTiempo: number;\n  excedeTiempoMaximo: boolean;\n  tiempoMaximoSegundos: number | null;\n  mensajeAlerta: string | null;\n  sonidoAlerta: boolean;\n}\n\nexport interface LlamadaTiempoReal {\n  id: number;\n  anexoDestino: string;        // Teléfono del cliente\n  anexoAgente: string;          // Extensión del agente\n  nombreAgente: string;         // Nombre completo del agente\n  fechaInicio: string;\n  estadoLlamada: string;        // MARCANDO, CONECTADA, EN_CURSO\n  duracionSegundos: number;     // Duración hasta ahora\n  uuidLlamada: string;\n  idContacto: number;\n  idAgente: number;\n}\n\nexport interface AutoDialerConfiguracion {\n  intensidadMarcacion: number;\n  intervaloMarcacionSegundos: number;\n}\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class AutoDialerService {\n  private apiUrl = `${environment.gatewayUrl}/admin/autodialer`;\n\n  constructor(private http: HttpClient) {}\n\n  private getHeaders(): HttpHeaders {\n    const token = localStorage.getItem('token');\n    return new HttpHeaders({\n      'Content-Type': 'application/json',\n      'Authorization': token ? `Bearer ${token}` : ''\n    });\n  }\n\n  /**\n   * Activa el auto-dialer\n   */\n  activar(usuario: string = 'admin', notas: string = 'Activación desde panel'): Observable<any> {\n    return this.http.post(\n      `${this.apiUrl}/activar`,\n      { usuario, notas },\n      { headers: this.getHeaders() }\n    );\n  }\n\n  /**\n   * Desactiva el auto-dialer\n   */\n  desactivar(notas: string = 'Desactivación desde panel'): Observable<any> {\n    return this.http.post(\n      `${this.apiUrl}/desactivar`,\n      { notas },\n      { headers: this.getHeaders() }\n    );\n  }\n\n  /**\n   * Toggle (activar/desactivar) el auto-dialer\n   */\n  toggle(usuario: string = 'admin'): Observable<any> {\n    return this.http.post(\n      `${this.apiUrl}/toggle`,\n      { usuario },\n      { headers: this.getHeaders() }\n    );\n  }\n\n  /**\n   * Obtiene el estado actual del auto-dialer\n   */\n  getEstado(): Observable<AutoDialerStatus> {\n    return this.http.get<AutoDialerStatus>(\n      `${this.apiUrl}/estado`,\n      { headers: this.getHeaders() }\n    );\n  }\n\n  /**\n   * Obtiene estadísticas en tiempo real\n   * @param campaignId ID de campaña para filtrar (opcional)\n   */\n  getEstadisticas(campaignId?: number): Observable<AutoDialerEstadisticas> {\n    const url = campaignId\n      ? `${this.apiUrl}/estadisticas?campaignId=${campaignId}`\n      : `${this.apiUrl}/estadisticas`;\n    return this.http.get<AutoDialerEstadisticas>(\n      url,\n      { headers: this.getHeaders() }\n    );\n  }\n\n  /**\n   * Health check del servicio\n   */\n  healthCheck(): Observable<any> {\n    return this.http.get(\n      `${this.apiUrl}/health`,\n      { headers: this.getHeaders() }\n    );\n  }\n\n  /**\n   * Inicia polling de estadísticas cada 5 segundos\n   * @param campaignId ID de campaña para filtrar (opcional)\n   */\n  startStatsPolling(campaignId?: number): Observable<AutoDialerEstadisticas> {\n    return interval(5000).pipe(\n      startWith(0),\n      switchMap(() => this.getEstadisticas(campaignId))\n    );\n  }\n\n  /**\n   * Obtiene lista de agentes para monitoreo en tiempo real\n   */\n  getAgentesMonitoreo(): Observable<AgenteMonitoreo[]> {\n    return this.http.get<AgenteMonitoreo[]>(\n      `${this.apiUrl}/agentes-monitoreo`,\n      { headers: this.getHeaders() }\n    );\n  }\n\n  /**\n   * Inicia polling de agentes cada 3 segundos\n   */\n  startAgentesPolling(): Observable<AgenteMonitoreo[]> {\n    return interval(3000).pipe(\n      startWith(0),\n      switchMap(() => this.getAgentesMonitoreo())\n    );\n  }\n\n  /**\n   * Obtiene todas las llamadas en tiempo real (MARCANDO, CONECTADA, EN_CURSO)\n   */\n  getLlamadasEnTiempoReal(): Observable<LlamadaTiempoReal[]> {\n    return this.http.get<LlamadaTiempoReal[]>(\n      `${this.apiUrl}/llamadas-tiempo-real`,\n      { headers: this.getHeaders() }\n    );\n  }\n\n  /**\n   * Obtiene llamadas en tiempo real filtradas por campaña\n   */\n  getLlamadasEnTiempoRealByCampaign(campaignId: number): Observable<LlamadaTiempoReal[]> {\n    return this.http.get<LlamadaTiempoReal[]>(\n      `${this.apiUrl}/llamadas-tiempo-real/${campaignId}`,\n      { headers: this.getHeaders() }\n    );\n  }\n\n  /**\n   * Inicia polling de llamadas en tiempo real cada 2 segundos\n   * Si se proporciona campaignId, filtra por esa campaña\n   */\n  startLlamadasPolling(campaignId?: number): Observable<LlamadaTiempoReal[]> {\n    return interval(2000).pipe(\n      startWith(0),\n      switchMap(() =>\n        campaignId\n          ? this.getLlamadasEnTiempoRealByCampaign(campaignId)\n          : this.getLlamadasEnTiempoReal()\n      )\n    );\n  }\n\n  /**\n   * Obtiene la configuración actual del autodialer\n   */\n  getConfiguracion(): Observable<AutoDialerConfiguracion> {\n    return this.http.get<AutoDialerConfiguracion>(\n      `${this.apiUrl}/configuracion`,\n      { headers: this.getHeaders() }\n    );\n  }\n\n  /**\n   * Actualiza la configuración del autodialer\n   */\n  updateConfiguracion(config: AutoDialerConfiguracion): Observable<void> {\n    return this.http.put<void>(\n      `${this.apiUrl}/configuracion`,\n      config,\n      { headers: this.getHeaders() }\n    );\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;AAwEM,IAAO,qBAAP,MAAO,mBAAiB;EAG5B,YAAoB,MAAgB;AAAhB,SAAA,OAAA;AAFZ,SAAA,SAAS,GAAG,YAAY,UAAU;EAEH;EAE/B,aAAU;AAChB,UAAM,QAAQ,aAAa,QAAQ,OAAO;AAC1C,WAAO,IAAI,YAAY;MACrB,gBAAgB;MAChB,iBAAiB,QAAQ,UAAU,KAAK,KAAK;KAC9C;EACH;;;;EAKA,QAAQ,UAAkB,SAAS,QAAgB,6BAAwB;AACzE,WAAO,KAAK,KAAK,KACf,GAAG,KAAK,MAAM,YACd,EAAE,SAAS,MAAK,GAChB,EAAE,SAAS,KAAK,WAAU,EAAE,CAAE;EAElC;;;;EAKA,WAAW,QAAgB,gCAA2B;AACpD,WAAO,KAAK,KAAK,KACf,GAAG,KAAK,MAAM,eACd,EAAE,MAAK,GACP,EAAE,SAAS,KAAK,WAAU,EAAE,CAAE;EAElC;;;;EAKA,OAAO,UAAkB,SAAO;AAC9B,WAAO,KAAK,KAAK,KACf,GAAG,KAAK,MAAM,WACd,EAAE,QAAO,GACT,EAAE,SAAS,KAAK,WAAU,EAAE,CAAE;EAElC;;;;EAKA,YAAS;AACP,WAAO,KAAK,KAAK,IACf,GAAG,KAAK,MAAM,WACd,EAAE,SAAS,KAAK,WAAU,EAAE,CAAE;EAElC;;;;;EAMA,gBAAgB,YAAmB;AACjC,UAAM,MAAM,aACR,GAAG,KAAK,MAAM,4BAA4B,UAAU,KACpD,GAAG,KAAK,MAAM;AAClB,WAAO,KAAK,KAAK,IACf,KACA,EAAE,SAAS,KAAK,WAAU,EAAE,CAAE;EAElC;;;;EAKA,cAAW;AACT,WAAO,KAAK,KAAK,IACf,GAAG,KAAK,MAAM,WACd,EAAE,SAAS,KAAK,WAAU,EAAE,CAAE;EAElC;;;;;EAMA,kBAAkB,YAAmB;AACnC,WAAO,SAAS,GAAI,EAAE,KACpB,UAAU,CAAC,GACX,UAAU,MAAM,KAAK,gBAAgB,UAAU,CAAC,CAAC;EAErD;;;;EAKA,sBAAmB;AACjB,WAAO,KAAK,KAAK,IACf,GAAG,KAAK,MAAM,sBACd,EAAE,SAAS,KAAK,WAAU,EAAE,CAAE;EAElC;;;;EAKA,sBAAmB;AACjB,WAAO,SAAS,GAAI,EAAE,KACpB,UAAU,CAAC,GACX,UAAU,MAAM,KAAK,oBAAmB,CAAE,CAAC;EAE/C;;;;EAKA,0BAAuB;AACrB,WAAO,KAAK,KAAK,IACf,GAAG,KAAK,MAAM,yBACd,EAAE,SAAS,KAAK,WAAU,EAAE,CAAE;EAElC;;;;EAKA,kCAAkC,YAAkB;AAClD,WAAO,KAAK,KAAK,IACf,GAAG,KAAK,MAAM,yBAAyB,UAAU,IACjD,EAAE,SAAS,KAAK,WAAU,EAAE,CAAE;EAElC;;;;;EAMA,qBAAqB,YAAmB;AACtC,WAAO,SAAS,GAAI,EAAE,KACpB,UAAU,CAAC,GACX,UAAU,MACR,aACI,KAAK,kCAAkC,UAAU,IACjD,KAAK,wBAAuB,CAAE,CACnC;EAEL;;;;EAKA,mBAAgB;AACd,WAAO,KAAK,KAAK,IACf,GAAG,KAAK,MAAM,kBACd,EAAE,SAAS,KAAK,WAAU,EAAE,CAAE;EAElC;;;;EAKA,oBAAoB,QAA+B;AACjD,WAAO,KAAK,KAAK,IACf,GAAG,KAAK,MAAM,kBACd,QACA,EAAE,SAAS,KAAK,WAAU,EAAE,CAAE;EAElC;;;mCArKW,oBAAiB,mBAAA,UAAA,CAAA;AAAA;sFAAjB,oBAAiB,SAAjB,mBAAiB,WAAA,YAFhB,OAAM,CAAA;AAEd,IAAO,oBAAP;;sEAAO,mBAAiB,CAAA;UAH7B;WAAW;MACV,YAAY;KACb;;;",
  "names": []
}
