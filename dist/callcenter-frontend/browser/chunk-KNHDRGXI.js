import{c as g}from"./chunk-T2ZQ5EGI.js";import{a as c}from"./chunk-YQKVMPSG.js";import{$ as a,ca as f,ga as l,n as h,ud as m}from"./chunk-SN4XSKG7.js";var U=(()=>{let n=class n{constructor(e,r){this.http=e,this.router=r,this.TOKEN_KEY="callcenter_token",this.USER_KEY="callcenter_user";let o=null;try{let t=localStorage.getItem(this.USER_KEY);t&&t!=="undefined"&&(o=JSON.parse(t))}catch(t){console.error("Error parsing stored user",t),localStorage.removeItem(this.USER_KEY)}this.currentUserSubject=new h(o),this.currentUser$=this.currentUserSubject.asObservable()}login(e,r){let o={nombreUsuario:e,contrasena:r};return this.http.post(`${c.apiUrl}/auth/login`,o).pipe(a(t=>{localStorage.setItem(this.TOKEN_KEY,t.accessToken),localStorage.setItem("refresh_token",t.refreshToken);let s=t.nombreCompleto?.split(" ")||["",""],p=s[0]||"",S=s.slice(1).join(" ")||"",u={id:t.idUsuario,username:t.nombreUsuario,email:t.email,firstName:p,lastName:S,role:t.roles?.[0]||"AGENT",sipExtension:t.extensionSip,active:!0,tenantId:t.tenantId,portfolioId:t.portfolioId,subPortfolioId:t.subPortfolioId};localStorage.setItem(this.USER_KEY,JSON.stringify(u)),this.currentUserSubject.next(u)}))}logout(){localStorage.removeItem(this.TOKEN_KEY),localStorage.removeItem("refresh_token"),localStorage.removeItem(this.USER_KEY),this.currentUserSubject.next(null),this.router.navigate(["/login"])}isAuthenticated(){let e=this.getToken();if(!e)return!1;try{let o=JSON.parse(atob(e.split(".")[1])).exp*1e3;return Date.now()<o}catch{return!1}}getToken(){return localStorage.getItem(this.TOKEN_KEY)}getCurrentUser(){return this.currentUserSubject.value}getCurrentUserId(){let e=this.getCurrentUser();return e?e.id:null}getRefreshToken(){return localStorage.getItem("refresh_token")}refreshToken(){let e=this.getRefreshToken();if(!e)throw new Error("No refresh token available");return this.http.post(`${c.apiUrl}/auth/refresh-token`,{refreshToken:e}).pipe(a(r=>{localStorage.setItem(this.TOKEN_KEY,r.accessToken),r.refreshToken&&localStorage.setItem("refresh_token",r.refreshToken)}))}isTokenExpiringSoon(){let e=this.getToken();if(!e)return!1;try{let o=JSON.parse(atob(e.split(".")[1])).exp*1e3,t=Date.now(),s=300*1e3;return o-t<s&&o>t}catch{return!1}}};n.\u0275fac=function(r){return new(r||n)(l(m),l(g))},n.\u0275prov=f({token:n,factory:n.\u0275fac,providedIn:"root"});let i=n;return i})();export{U as a};
