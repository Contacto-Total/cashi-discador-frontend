import{a as rt,b as Fe,c as st}from"./chunk-A5LXVA57.js";import{a as lt}from"./chunk-G5QRPVRX.js";import{a as ke}from"./chunk-RYYII4T7.js";import{a as ot}from"./chunk-YMOPZ4SA.js";import{a as at}from"./chunk-QGEQRLXT.js";import{a as tt}from"./chunk-PBWJIDDU.js";import{a as ye}from"./chunk-F4ESQKJH.js";import{a as Z,b as it}from"./chunk-DBFNNDND.js";import"./chunk-ITWNWEHW.js";import{a as Ye}from"./chunk-622ZVLQG.js";import{a as Ge,c as qe}from"./chunk-4QMVQERR.js";import"./chunk-3XLV6A3K.js";import{a as nt}from"./chunk-G3AILOPS.js";import{D as ve,c as Qe,e as we,j as Ae,l as Je,r as Ze,s as Ke,t as Xe,w as et}from"./chunk-4T7YNYFA.js";import{Rb as He,Sb as We,Tb as Y}from"./chunk-XLQ3V3R5.js";import{$a as c,Ac as ie,Eb as p,Fb as h,Fc as V,Gb as Le,Gc as je,I as xe,Ib as B,Jb as z,Kb as $,Lb as r,Mb as o,Nb as W,Ob as U,Pb as R,Qb as ze,Ub as O,Vb as Oe,Wb as F,Xb as de,Yb as u,a as q,ac as De,b as re,ba as ee,bc as Ie,cc as Te,fa as le,fb as N,ga as Be,ic as Ve,id as _e,jc as L,jd as ce,kc as s,lc as j,ma as T,mb as se,mc as f,na as M,nc as Me,pc as ge,qc as pe,r as be,rc as he,rd as ne,ub as Pe,v as Ce,wa as b,yc as te,za as Ee}from"./chunk-S5LLKQFC.js";var Se=(()=>{let d=class d{constructor(e){this.http=e,this.baseUrl=`${Y.tipificacionUrl}/payment-schedules`}createPaymentSchedule(e){return this.http.post(`${Y.tipificacionUrl}/payments/schedules`,e)}getPaymentScheduleByManagementId(e){return this.http.get(`${this.baseUrl}/management/${e}`)}updateInstallmentStatus(e,t){return this.http.post(`${this.baseUrl}/installments/${e}/status`,t)}getInstallmentHistory(e){return this.http.get(`${this.baseUrl}/installments/${e}/history`)}getLatestStatusByManagement(e){return this.http.get(`${this.baseUrl}/management/${e}/latest-status`)}getActiveSchedulesByCustomer(e){return this.http.get(`${Y.gatewayUrl}/v2/management-records/payment-schedule/client/${e}`)}};d.\u0275fac=function(t){return new(t||d)(le(ne))},d.\u0275prov=ee({token:d,factory:d.\u0275fac,providedIn:"root"});let n=d;return n})();function xt(n,d){if(n&1){let a=O();r(0,"div",17)(1,"div")(2,"label",13),s(3," Fecha de Pago * "),o(),r(4,"input",23),he("ngModelChange",function(t){T(a);let i=u(2);return pe(i.paymentDate,t)||(i.paymentDate=t),M(t)}),o()(),r(5,"div")(6,"label",13),s(7," Monto Pagado * "),o(),r(8,"div",24)(9,"span",25),s(10,"S/"),o(),r(11,"input",26),he("ngModelChange",function(t){T(a);let i=u(2);return pe(i.amountPaid,t)||(i.amountPaid=t),M(t)}),o()()()()}if(n&2){let a=u(2);c(4),ge("ngModel",a.paymentDate),c(7),ge("ngModel",a.amountPaid)}}function _t(n,d){if(n&1&&(r(0,"div",19)(1,"span",27),s(2),o()()),n&2){let a=u(2);c(2),j(a.errorMessage())}}function vt(n,d){n&1&&(r(0,"span"),s(1,"Guardando..."),o())}function St(n,d){n&1&&(r(0,"span"),s(1,"Guardar"),o())}function yt(n,d){if(n&1){let a=O();r(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"div")(5,"h2",4),s(6,"Actualizar Estado de Cuota"),o(),r(7,"p",5),s(8),o()()(),r(9,"button",6),F("click",function(){T(a);let t=u();return M(t.close())}),o()(),r(10,"div",7)(11,"div",8)(12,"div",9)(13,"div")(14,"span",10),s(15,"Monto:"),o(),r(16,"span",11),s(17),te(18,"number"),o()(),r(19,"div")(20,"span",10),s(21,"Fecha Vencimiento:"),o(),r(22,"span",11),s(23),o()(),r(24,"div")(25,"span",10),s(26,"Estado Actual:"),o(),r(27,"span",12),s(28),o()()()(),r(29,"div")(30,"label",13),s(31," Nuevo Estado "),o(),r(32,"div",14)(33,"button",15),F("click",function(){T(a);let t=u();return M(t.selectedStatus.set("COMPLETADO"))}),r(34,"span",16),s(35,"Completado"),o()(),r(36,"button",15),F("click",function(){T(a);let t=u();return M(t.selectedStatus.set("VENCIDO"))}),r(37,"span",16),s(38,"Vencido"),o()(),r(39,"button",15),F("click",function(){T(a);let t=u();return M(t.selectedStatus.set("CANCELADO"))}),r(40,"span",16),s(41,"Cancelado"),o()()()(),p(42,xt,12,2,"div",17),r(43,"div")(44,"label",13),s(45," Observaciones "),o(),r(46,"textarea",18),he("ngModelChange",function(t){T(a);let i=u();return pe(i.observations,t)||(i.observations=t),M(t)}),o()(),p(47,_t,3,1,"div",19),o(),r(48,"div",20)(49,"button",21),F("click",function(){T(a);let t=u();return M(t.close())}),s(50," Cancelar "),o(),r(51,"button",22),F("click",function(){T(a);let t=u();return M(t.save())}),p(52,vt,2,0,"span")(53,St,2,0,"span"),o()()()()}if(n&2){let a,e,t,i,l,m=u();c(8),f("Cuota #",(a=m.installment())==null?null:a.installmentNumber),c(9),f(" S/ ",ie(18,17,(e=m.installment())==null?null:e.amount,"1.2-2")," "),c(6),f(" ",m.formatDate((t=m.installment())==null?null:t.dueDate)," "),c(4),L(m.getStatusBadgeClass(((i=m.installment())==null?null:i.status)||"PENDIENTE")),c(),f(" ",((l=m.installment())==null?null:l.statusDescription)||"Pendiente"," "),c(5),L(m.selectedStatus()==="COMPLETADO"?"bg-green-100 dark:bg-green-900/30 border-green-500 dark:border-green-600 text-green-900 dark:text-green-300":"bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 hover:border-green-400"),c(3),L(m.selectedStatus()==="VENCIDO"?"bg-red-100 dark:bg-red-900/30 border-red-500 dark:border-red-600 text-red-900 dark:text-red-300":"bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 hover:border-red-400"),c(3),L(m.selectedStatus()==="CANCELADO"?"bg-gray-100 dark:bg-gray-700/30 border-gray-500 dark:border-gray-600 text-gray-900 dark:text-gray-300":"bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 hover:border-gray-400"),c(3),h(m.selectedStatus()==="COMPLETADO"?42:-1),c(4),ge("ngModel",m.observations),c(),h(m.errorMessage()?47:-1),c(4),$("disabled",!m.canSave()||m.isSaving()),c(),h(m.isSaving()?52:53)}}var ct=(()=>{let d=class d{constructor(e){this.paymentScheduleService=e,this.isOpen=b(!1),this.installment=b(null),this.managementId=b(0),this.selectedStatus=b(null),this.paymentDate="",this.amountPaid=null,this.observations="",this.isSaving=b(!1),this.errorMessage=b(null),this.canSave=V(()=>this.selectedStatus()?this.selectedStatus()==="COMPLETADO"?!!this.paymentDate&&this.amountPaid!==null&&this.amountPaid>0:!0:!1),je(()=>{this.isOpen()||this.resetForm()})}open(e,t){this.installment.set(e),this.managementId.set(t),this.isOpen.set(!0),this.amountPaid=e.amount;let i=new Date,l=i.getFullYear(),m=String(i.getMonth()+1).padStart(2,"0"),g=String(i.getDate()).padStart(2,"0"),w=String(i.getHours()).padStart(2,"0"),C=String(i.getMinutes()).padStart(2,"0");this.paymentDate=`${l}-${m}-${g}T${w}:${C}`}close(){this.isOpen.set(!1)}resetForm(){this.selectedStatus.set(null),this.paymentDate="",this.amountPaid=null,this.observations="",this.errorMessage.set(null),this.installment.set(null),this.managementId.set(0)}save(){let e=this.installment();if(!e||!this.canSave())return;this.isSaving.set(!0),this.errorMessage.set(null);let t={status:this.selectedStatus(),observations:this.observations||void 0,registeredBy:"USUARIO"};this.selectedStatus()==="COMPLETADO"&&(t.paymentDate=this.paymentDate,t.amountPaid=this.amountPaid),this.paymentScheduleService.updateInstallmentStatus(e.id,t).subscribe({next:()=>{console.log("\u2705 Estado de cuota actualizado exitosamente"),this.isSaving.set(!1),this.close(),this.onSave&&this.onSave(!0)},error:i=>{console.error("\u274C Error actualizando estado de cuota:",i),this.errorMessage.set("Error al actualizar el estado. Intente nuevamente."),this.isSaving.set(!1),this.onSave&&this.onSave(!1)}})}formatDate(e){return e?new Date(e).toLocaleDateString("es-PE",{day:"2-digit",month:"2-digit",year:"numeric"}):"-"}getStatusBadgeClass(e){switch(e.toUpperCase()){case"COMPLETED":case"COMPLETADO":return"bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300 border border-green-300 dark:border-green-700";case"PENDING":case"PENDIENTE":return"bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300 border border-yellow-300 dark:border-yellow-700";case"OVERDUE":case"VENCIDO":return"bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300 border border-red-300 dark:border-red-700";case"CANCELLED":case"CANCELADO":return"bg-gray-100 dark:bg-gray-700/30 text-gray-800 dark:text-gray-300 border border-gray-300 dark:border-gray-600";default:return"bg-slate-100 dark:bg-slate-700 text-slate-800 dark:text-slate-300"}}};d.\u0275fac=function(t){return new(t||d)(N(Se))},d.\u0275cmp=se({type:d,selectors:[["app-installment-status-dialog"]],decls:1,vars:1,consts:[[1,"fixed","inset-0","z-50","flex","items-center","justify-center","p-4","bg-black/50","backdrop-blur-sm","animate-fadeIn"],[1,"bg-white","dark:bg-slate-900","rounded-xl","shadow-2xl","max-w-2xl","w-full","max-h-[90vh]","overflow-hidden","flex","flex-col","animate-slideInUp","border","border-slate-200","dark:border-slate-700"],[1,"bg-gradient-to-r","from-purple-600","to-purple-700","dark:from-purple-700","dark:to-purple-800","text-white","px-6","py-4","flex","items-center","justify-between"],[1,"flex","items-center","gap-3"],[1,"text-lg","font-bold"],[1,"text-sm","opacity-90"],["type","button",1,"p-2","hover:bg-white/20","rounded-lg","transition-colors",3,"click"],[1,"flex-1","overflow-y-auto","p-6","space-y-6"],[1,"bg-purple-50","dark:bg-purple-950/30","border","border-purple-200","dark:border-purple-800","rounded-lg","p-4"],[1,"grid","grid-cols-2","gap-4","text-sm"],[1,"text-slate-600","dark:text-slate-400"],[1,"font-bold","text-purple-900","dark:text-purple-200","ml-2"],[1,"ml-2","px-2","py-0.5","rounded","text-xs","font-bold"],[1,"block","text-sm","font-semibold","text-slate-700","dark:text-slate-300","mb-2"],[1,"grid","grid-cols-3","gap-3"],["type","button",1,"border-2","rounded-lg","p-4","flex","flex-col","items-center","gap-2","transition-all",3,"click"],[1,"text-sm","font-bold"],[1,"space-y-4","p-4","bg-green-50","dark:bg-green-950/20","border","border-green-200","dark:border-green-800","rounded-lg"],["rows","3","placeholder","Ingrese notas o comentarios adicionales...",1,"w-full","px-3","py-2","text-sm","border","border-slate-300","dark:border-slate-600","rounded-lg","bg-white","dark:bg-slate-800","text-slate-900","dark:text-slate-100","focus:ring-2","focus:ring-purple-500","dark:focus:ring-purple-600","focus:border-transparent","placeholder:text-slate-400","dark:placeholder:text-slate-500",3,"ngModelChange","ngModel"],[1,"bg-red-50","dark:bg-red-950/30","border","border-red-200","dark:border-red-800","text-red-900","dark:text-red-300","px-4","py-3","rounded-lg","flex","items-start","gap-2"],[1,"px-6","py-4","bg-slate-50","dark:bg-slate-800/50","border-t","border-slate-200","dark:border-slate-700","flex","justify-end","gap-3"],["type","button",1,"px-4","py-2","text-sm","font-semibold","text-slate-700","dark:text-slate-300","hover:bg-slate-200","dark:hover:bg-slate-700","rounded-lg","transition-colors",3,"click"],["type","button",1,"px-4","py-2","text-sm","font-semibold","text-white","bg-gradient-to-r","from-purple-600","to-purple-700","hover:from-purple-700","hover:to-purple-800","rounded-lg","transition-all","disabled:opacity-50","disabled:cursor-not-allowed","disabled:hover:from-purple-600","flex","items-center","gap-2",3,"click","disabled"],["type","datetime-local","required","",1,"w-full","px-3","py-2","text-sm","border","border-slate-300","dark:border-slate-600","rounded-lg","bg-white","dark:bg-slate-800","text-slate-900","dark:text-slate-100","focus:ring-2","focus:ring-green-500","dark:focus:ring-green-600","focus:border-transparent",3,"ngModelChange","ngModel"],[1,"relative"],[1,"absolute","left-3","top-2","text-slate-500","dark:text-slate-400"],["type","number","step","0.01","required","",1,"w-full","pl-10","pr-3","py-2","text-sm","border","border-slate-300","dark:border-slate-600","rounded-lg","bg-white","dark:bg-slate-800","text-slate-900","dark:text-slate-100","focus:ring-2","focus:ring-green-500","dark:focus:ring-green-600","focus:border-transparent",3,"ngModelChange","ngModel"],[1,"text-sm"]],template:function(t,i){t&1&&p(0,yt,54,20,"div",0),t&2&&h(i.isOpen()?0:-1)},dependencies:[ce,ve,Qe,Je,we,et,Ae,_e],styles:["@keyframes _ngcontent-%COMP%_fadeIn{0%{opacity:0}to{opacity:1}}@keyframes _ngcontent-%COMP%_slideInUp{0%{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.animate-fadeIn[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_fadeIn .2s ease-out}.animate-slideInUp[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_slideInUp .3s ease-out}"]});let n=d;return n})();var Et=["statusDialog"],mt=(n,d)=>d.id;function Pt(n,d){n&1&&(r(0,"div",9)(1,"div",10)(2,"span"),s(3,"Cargando estados..."),o()()())}function Dt(n,d){if(n&1&&(r(0,"div",31),s(1),o()),n&2){let a=u().$implicit,e=u(2);c(),f(" ",e.formatDateTime(a.latestStatus.actualPaymentDate)," ")}}function It(n,d){n&1&&(r(0,"div",36),s(1,"-"),o())}function Tt(n,d){n&1&&(r(0,"div",43)(1,"span"),s(2,"Cargando historial..."),o()())}function Mt(n,d){if(n&1&&(r(0,"span",48),s(1),te(2,"number"),o()),n&2){let a=u().$implicit;c(),f(" S/ ",ie(2,1,a.amountPaid,"1.2-2")," ")}}function wt(n,d){if(n&1&&(r(0,"div",49),s(1),o()),n&2){let a=u().$implicit;c(),f(" ",a.observations," ")}}function At(n,d){if(n&1&&(r(0,"div",44)(1,"div",45),s(2),o(),r(3,"div",46)(4,"span",47),s(5),o(),p(6,Mt,3,4,"span",48),p(7,wt,2,1,"div",49),o(),r(8,"div",50),s(9),o()()),n&2){let a=d.$implicit,e=u(5);c(2),f(" ",e.formatDateTime(a.changeDate)," "),c(2),L(e.getStatusBadgeClass(a.status)),c(),f(" ",a.statusDescription," "),c(),h(a.amountPaid?6:-1),c(),h(a.observations?7:-1),c(2),f(" ",a.registeredBy," ")}}function kt(n,d){if(n&1&&(r(0,"div",41),B(1,At,10,7,"div",44,mt),o()),n&2){let a=u(4);c(),z(a.installmentHistory())}}function Ft(n,d){if(n&1&&(r(0,"tr")(1,"td",40)(2,"div",41)(3,"div",42)(4,"span"),s(5,"Historial de Estados"),o()(),p(6,Tt,3,0,"div",43)(7,kt,3,0,"div",41),o()()()),n&2){let a=u(3);c(6),h(a.isLoadingHistory()?6:a.installmentHistory()&&a.installmentHistory().length>0?7:-1)}}function Nt(n,d){if(n&1){let a=O();r(0,"tr",26)(1,"td",27)(2,"div",28)(3,"div",29)(4,"span",30),s(5),o()()()(),r(6,"td",27)(7,"div",31),s(8),o()(),r(9,"td",32)(10,"div",33),s(11),te(12,"number"),o()(),r(13,"td",27)(14,"div",34)(15,"span",35),s(16),o()()(),r(17,"td",27),p(18,Dt,2,1,"div",31)(19,It,2,0,"div",36),o(),r(20,"td",27)(21,"div",37)(22,"button",38),F("click",function(){let t=T(a).$implicit,i=u(2);return M(i.openStatusDialog(t))}),o(),r(23,"button",39),F("click",function(){let t=T(a).$implicit,i=u(2);return M(i.toggleHistory(t.id))}),o()()()(),p(24,Ft,8,1,"tr")}if(n&2){let a=d.$implicit,e=u(2);c(5),f(" ",a.installmentNumber," "),c(3),f(" ",e.formatDate(a.dueDate)," "),c(3),f(" S/ ",ie(12,10,a.amount,"1.2-2")," "),c(4),L(e.getStatusBadgeClass((a.latestStatus==null?null:a.latestStatus.status)||"PENDIENTE")),c(),f(" ",(a.latestStatus==null?null:a.latestStatus.statusDescription)||"Pendiente"," "),c(2),h(a.latestStatus!=null&&a.latestStatus.actualPaymentDate?18:19),c(5),L(e.expandedHistory()===a.id?"bg-slate-200 dark:bg-slate-700":"hover:bg-slate-100 dark:hover:bg-slate-800"),c(),h(e.expandedHistory()===a.id&&e.installmentHistory()?24:-1)}}function Lt(n,d){if(n&1&&(r(0,"div",11)(1,"table",12)(2,"thead",13)(3,"tr")(4,"th",14),s(5,"#"),o(),r(6,"th",14),s(7,"Fecha Vencimiento"),o(),r(8,"th",15),s(9,"Monto"),o(),r(10,"th",16),s(11,"Estado"),o(),r(12,"th",14),s(13,"Fecha Pago"),o(),r(14,"th",16),s(15,"Acciones"),o()()(),r(16,"tbody",17),B(17,Nt,25,13,null,null,mt),o()()(),r(19,"div",18)(20,"div",19)(21,"div",20)(22,"div",21),s(23,"Completadas"),o(),r(24,"div",22),s(25),o()(),r(26,"div",20)(27,"div",21),s(28,"Pendientes"),o(),r(29,"div",23),s(30),o()(),r(31,"div",20)(32,"div",21),s(33,"Vencidas"),o(),r(34,"div",24),s(35),o()(),r(36,"div",20)(37,"div",21),s(38,"Canceladas"),o(),r(39,"div",25),s(40),o()()()()),n&2){let a=u();c(17),z(a.installmentsWithStatus()),c(8),f(" ",a.summaryStats().completed," "),c(5),f(" ",a.summaryStats().pending," "),c(5),f(" ",a.summaryStats().overdue," "),c(5),f(" ",a.summaryStats().cancelled," ")}}var ut=(()=>{let d=class d{constructor(e){this.paymentScheduleService=e,this.managementId=0,this.schedule=b(null),this.latestStatuses=b([]),this.isLoading=b(!1),this.expandedHistory=b(null),this.installmentHistory=b(null),this.isLoadingHistory=b(!1),this.installmentsWithStatus=V(()=>{let t=this.schedule(),i=this.latestStatuses();return t?t.installments.map(l=>{let m=i.find(g=>g.installmentId===l.id);return re(q({},l),{latestStatus:m})}):[]}),this.summaryStats=V(()=>{let t=this.installmentsWithStatus();return{completed:t.filter(i=>["COMPLETED","COMPLETADO"].includes(i.latestStatus?.status||"")).length,pending:t.filter(i=>["PENDING","PENDIENTE"].includes(i.latestStatus?.status||"")).length,overdue:t.filter(i=>["OVERDUE","VENCIDO"].includes(i.latestStatus?.status||"")).length,cancelled:t.filter(i=>["CANCELLED","CANCELADO"].includes(i.latestStatus?.status||"")).length}})}ngOnChanges(e){e.managementId&&this.managementId&&this.loadSchedule()}loadSchedule(){this.isLoading.set(!0),this.paymentScheduleService.getPaymentScheduleByManagementId(this.managementId).subscribe({next:e=>{console.log("\u{1F4CA} Cronograma cargado:",e),this.schedule.set(e),this.loadLatestStatuses()},error:e=>{console.error("\u274C Error cargando cronograma:",e),this.isLoading.set(!1)}})}loadLatestStatuses(){this.paymentScheduleService.getLatestStatusByManagement(this.managementId).subscribe({next:e=>{console.log("\u{1F4CB} Estados m\xE1s recientes cargados:",e),this.latestStatuses.set(e),this.isLoading.set(!1)},error:e=>{console.error("\u274C Error cargando estados:",e),this.isLoading.set(!1)}})}openStatusDialog(e){this.statusDialog.open(e,this.managementId),this.statusDialog.onSave=t=>{t&&(this.loadLatestStatuses(),this.expandedHistory()===e.id&&this.loadInstallmentHistory(e.id))}}toggleHistory(e){this.expandedHistory()===e?(this.expandedHistory.set(null),this.installmentHistory.set(null)):(this.expandedHistory.set(e),this.loadInstallmentHistory(e))}loadInstallmentHistory(e){this.isLoadingHistory.set(!0),this.paymentScheduleService.getInstallmentHistory(e).subscribe({next:t=>{console.log("\u{1F4DC} Historial de cuota cargado:",t),this.installmentHistory.set(t),this.isLoadingHistory.set(!1)},error:t=>{console.error("\u274C Error cargando historial:",t),this.isLoadingHistory.set(!1)}})}formatDate(e){return new Date(e).toLocaleDateString("es-PE",{day:"2-digit",month:"2-digit",year:"numeric"})}formatDateTime(e){return new Date(e).toLocaleString("es-PE",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}getStatusBadgeClass(e){switch(e.toUpperCase()){case"COMPLETED":case"COMPLETADO":return"bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300 border border-green-300 dark:border-green-700";case"PENDING":case"PENDIENTE":return"bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300 border border-yellow-300 dark:border-yellow-700";case"OVERDUE":case"VENCIDO":return"bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300 border border-red-300 dark:border-red-700";case"CANCELLED":case"CANCELADO":return"bg-gray-100 dark:bg-gray-700/30 text-gray-800 dark:text-gray-300 border border-gray-300 dark:border-gray-600";default:return"bg-slate-100 dark:bg-slate-700 text-slate-800 dark:text-slate-300"}}};d.\u0275fac=function(t){return new(t||d)(N(Se))},d.\u0275cmp=se({type:d,selectors:[["app-payment-schedule-view"]],viewQuery:function(t,i){if(t&1&&De(Et,5),t&2){let l;Ie(l=Te())&&(i.statusDialog=l.first)}},inputs:{managementId:"managementId"},features:[Ee],decls:19,vars:7,consts:[["statusDialog",""],[1,"bg-white","dark:bg-slate-900","rounded-xl","shadow-lg","border","border-slate-200","dark:border-slate-700","overflow-hidden"],[1,"bg-gradient-to-r","from-purple-600","to-purple-700","dark:from-purple-700","dark:to-purple-800","text-white","px-6","py-4"],[1,"flex","items-center","justify-between"],[1,"flex","items-center","gap-3"],[1,"text-lg","font-bold"],[1,"text-sm","opacity-90"],[1,"text-right"],[1,"text-2xl","font-bold"],[1,"p-8","flex","items-center","justify-center"],[1,"flex","items-center","gap-3","text-slate-600","dark:text-slate-400"],[1,"overflow-x-auto"],[1,"w-full"],[1,"bg-slate-50","dark:bg-slate-800/50","border-b","border-slate-200","dark:border-slate-700"],[1,"px-4","py-3","text-left","text-xs","font-bold","text-slate-700","dark:text-slate-300","uppercase","tracking-wider"],[1,"px-4","py-3","text-right","text-xs","font-bold","text-slate-700","dark:text-slate-300","uppercase","tracking-wider"],[1,"px-4","py-3","text-center","text-xs","font-bold","text-slate-700","dark:text-slate-300","uppercase","tracking-wider"],[1,"divide-y","divide-slate-200","dark:divide-slate-700"],[1,"px-6","py-4","bg-slate-50","dark:bg-slate-800/50","border-t","border-slate-200","dark:border-slate-700"],[1,"grid","grid-cols-4","gap-4","text-sm"],[1,"text-center"],[1,"text-slate-600","dark:text-slate-400","mb-1"],[1,"text-2xl","font-bold","text-green-600","dark:text-green-400"],[1,"text-2xl","font-bold","text-yellow-600","dark:text-yellow-400"],[1,"text-2xl","font-bold","text-red-600","dark:text-red-400"],[1,"text-2xl","font-bold","text-gray-600","dark:text-gray-400"],[1,"hover:bg-slate-50","dark:hover:bg-slate-800/50","transition-colors"],[1,"px-4","py-3"],[1,"flex","items-center","gap-2"],[1,"w-8","h-8","rounded-full","bg-purple-100","dark:bg-purple-900/30","flex","items-center","justify-center"],[1,"text-xs","font-bold","text-purple-700","dark:text-purple-300"],[1,"text-sm","text-slate-900","dark:text-slate-100"],[1,"px-4","py-3","text-right"],[1,"text-sm","font-bold","text-slate-900","dark:text-slate-100"],[1,"flex","justify-center"],[1,"px-2","py-1","rounded","text-xs","font-bold"],[1,"text-sm","text-slate-400","dark:text-slate-500"],[1,"flex","items-center","justify-center","gap-2"],["type","button","title","Actualizar estado",1,"p-1.5","hover:bg-purple-100","dark:hover:bg-purple-900/30","rounded","transition-colors",3,"click"],["type","button","title","Ver historial",1,"p-1.5","rounded","transition-colors",3,"click"],["colspan","6",1,"px-4","py-3","bg-slate-50","dark:bg-slate-800/50"],[1,"space-y-2"],[1,"flex","items-center","gap-2","text-sm","font-bold","text-slate-700","dark:text-slate-300","mb-2"],[1,"flex","items-center","gap-2","text-sm","text-slate-600","dark:text-slate-400","py-2"],[1,"flex","items-start","gap-3","text-xs","p-2","bg-white","dark:bg-slate-900","rounded","border","border-slate-200","dark:border-slate-700"],[1,"flex-shrink-0","w-24","text-slate-600","dark:text-slate-400"],[1,"flex-1"],[1,"px-2","py-0.5","rounded","font-bold"],[1,"ml-2","text-slate-700","dark:text-slate-300"],[1,"mt-1","text-slate-600","dark:text-slate-400"],[1,"flex-shrink-0","text-slate-500","dark:text-slate-500"]],template:function(t,i){if(t&1&&(r(0,"div",1)(1,"div",2)(2,"div",3)(3,"div",4)(4,"div")(5,"h3",5),s(6,"Cronograma de Pagos"),o(),r(7,"p",6),s(8),o()()(),r(9,"div",7)(10,"div",6),s(11,"Monto Total"),o(),r(12,"div",8),s(13),te(14,"number"),o()()()(),p(15,Pt,4,0,"div",9),p(16,Lt,41,4),o(),W(17,"app-installment-status-dialog",null,0)),t&2){let l;c(8),f("",i.installmentsWithStatus().length," cuotas programadas"),c(5),f("S/ ",ie(14,4,(l=i.schedule())==null?null:l.totalAmount,"1.2-2")),c(2),h(i.isLoading()?15:-1),c(),h(!i.isLoading()&&i.installmentsWithStatus().length>0?16:-1)}},dependencies:[ce,ct,_e],encapsulation:2});let n=d;return n})();var Vt=(n,d)=>d.idUsuario;function Ut(n,d){n&1&&(U(0,"div",6),ze(1,"div",11),U(2,"p"),s(3,"Buscando supervisores en l\xEDnea..."),R()())}function $t(n,d){if(n&1){let a=O();U(0,"div",7)(1,"span",12),s(2,"\u26A0\uFE0F"),R(),U(3,"p",13),s(4,"No hay supervisores en l\xEDnea"),R(),U(5,"p",14),s(6,"Intenta de nuevo m\xE1s tarde o contacta a un administrador"),R(),U(7,"button",15),de("click",function(){T(a);let t=u(2);return M(t.cargarSupervisores())}),s(8," \u{1F504} Reintentar "),R()()}}function Rt(n,d){if(n&1&&(U(0,"span",28),s(1),R()),n&2){let a=u().$implicit;c(),f(" ",a.solicitudesPendientes," pendiente(s) ")}}function Bt(n,d){if(n&1){let a=O();U(0,"div",19),de("click",function(){let t=T(a).$implicit,i=u(3);return M(i.selectSupervisor(t))}),U(1,"div",20)(2,"input",21),de("change",function(){let t=T(a).$implicit,i=u(3);return M(i.selectSupervisor(t))}),R()(),U(3,"div",22)(4,"div",23)(5,"span",24),s(6,"\u{1F464}"),R(),s(7),R(),U(8,"div",25)(9,"span",26),s(10),R(),U(11,"span",27),s(12),R(),p(13,Rt,2,1,"span",28),R()()()}if(n&2){let a=d.$implicit,e=u(3);Ve("selected",(e.supervisorSeleccionado==null?null:e.supervisorSeleccionado.idUsuario)===a.idUsuario),c(2),Oe("name","supervisor")("value",a.idUsuario)("checked",(e.supervisorSeleccionado==null?null:e.supervisorSeleccionado.idUsuario)===a.idUsuario),c(5),f(" ",a.nombreCompleto," "),c(2),Ve("admin",a.rol==="ADMIN"),c(),f(" ",a.rol," "),c(),L(e.getEstadoClass(a.estado)),c(),f(" ",a.estado," "),c(),h(a.solicitudesPendientes&&a.solicitudesPendientes>0?13:-1)}}function zt(n,d){if(n&1&&(U(0,"p",16),s(1,"Selecciona a qui\xE9n enviar la solicitud de autorizaci\xF3n:"),R(),U(2,"div",17),B(3,Bt,14,13,"div",18,Vt),R()),n&2){let a=u(2);c(3),z(a.supervisores())}}function jt(n,d){if(n&1){let a=O();U(0,"div",1),de("click",function(t){T(a);let i=u();return M(i.onOverlayClick(t))}),U(1,"div",2)(2,"div",3)(3,"h2"),s(4,"\u{1F510} Seleccionar Supervisor para Autorizaci\xF3n"),R(),U(5,"button",4),de("click",function(){T(a);let t=u();return M(t.onCancel())}),s(6,"\xD7"),R()(),U(7,"div",5),p(8,Ut,4,0,"div",6)(9,$t,9,0,"div",7)(10,zt,5,0),R(),U(11,"div",8)(12,"button",9),de("click",function(){T(a);let t=u();return M(t.onCancel())}),s(13," Cancelar "),R(),U(14,"button",10),de("click",function(){T(a);let t=u();return M(t.onConfirm())}),s(15," \u{1F4E4} Enviar Solicitud "),R()()()()}if(n&2){let a=u();c(8),h(a.cargando()?8:a.supervisores().length===0?9:10),c(6),Oe("disabled",!a.supervisorSeleccionado||a.cargando())}}var gt=(()=>{let d=class d{constructor(e){this.autorizacionService=e,this.visible=!1,this.visibleChange=new Pe,this.supervisorSelected=new Pe,this.cancelled=new Pe,this.supervisores=b([]),this.cargando=b(!1),this.supervisorSeleccionado=null}ngOnInit(){}ngOnChanges(e){e.visible&&e.visible.currentValue===!0&&this.cargarSupervisores()}cargarSupervisores(){this.cargando.set(!0),this.autorizacionService.obtenerSupervisoresEnLinea().subscribe({next:e=>{this.supervisores.set(e),this.cargando.set(!1)},error:e=>{console.error("[SELECT-SUPERVISOR] Error al cargar supervisores:",e),this.cargando.set(!1)}})}selectSupervisor(e){this.supervisorSeleccionado=e}getEstadoClass(e){switch(e){case"DISPONIBLE":case"CONECTADO":return"disponible";case"EN_LLAMADA":return"en-llamada";case"DESCONECTADO":return"desconectado";default:return""}}onOverlayClick(e){e.target.classList.contains("modal-overlay")&&this.onCancel()}onConfirm(){this.supervisorSeleccionado&&(this.supervisorSelected.emit(this.supervisorSeleccionado),this.closeModal())}onCancel(){this.cancelled.emit(),this.closeModal()}closeModal(){this.visible=!1,this.visibleChange.emit(!1),this.supervisorSeleccionado=null}};d.\u0275fac=function(t){return new(t||d)(N(ke))},d.\u0275cmp=se({type:d,selectors:[["app-select-supervisor-modal"]],inputs:{visible:"visible"},outputs:{visibleChange:"visibleChange",supervisorSelected:"supervisorSelected",cancelled:"cancelled"},features:[Ee],decls:1,vars:1,consts:[[1,"modal-overlay"],[1,"modal-overlay",3,"click"],[1,"modal-container"],[1,"modal-header"],[1,"close-btn",3,"click"],[1,"modal-content"],[1,"loading-container"],[1,"no-supervisors"],[1,"modal-footer"],[1,"btn","btn-cancel",3,"click"],[1,"btn","btn-primary",3,"click","disabled"],[1,"spinner"],[1,"warning-icon"],[1,"title"],[1,"subtitle"],[1,"retry-btn",3,"click"],[1,"instruction"],[1,"supervisors-list"],[1,"supervisor-card",3,"selected"],[1,"supervisor-card",3,"click"],[1,"radio-container"],["type","radio",3,"change","name","value","checked"],[1,"supervisor-info"],[1,"name"],[1,"user-icon"],[1,"details"],[1,"rol-badge"],[1,"estado-badge"],[1,"pendientes-badge"]],template:function(t,i){t&1&&p(0,jt,16,2,"div",0),t&2&&h(i.visible?0:-1)},dependencies:[ce,ve],styles:[".modal-overlay[_ngcontent-%COMP%]{position:fixed;inset:0;background:#00000080;display:flex;align-items:center;justify-content:center;z-index:10000;animation:_ngcontent-%COMP%_fadeIn .2s ease-out}@keyframes _ngcontent-%COMP%_fadeIn{0%{opacity:0}to{opacity:1}}.modal-container[_ngcontent-%COMP%]{background:#fff;border-radius:12px;box-shadow:0 20px 60px #0000004d;width:90%;max-width:550px;max-height:90vh;display:flex;flex-direction:column;animation:_ngcontent-%COMP%_slideUp .3s ease-out}@keyframes _ngcontent-%COMP%_slideUp{0%{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.modal-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.5rem;border-bottom:1px solid #e5e7eb;background:linear-gradient(135deg,#3b82f6,#1d4ed8);border-radius:12px 12px 0 0;color:#fff}.modal-header[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0;font-size:1.1rem;font-weight:600}.close-btn[_ngcontent-%COMP%]{background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;padding:0;line-height:1;opacity:.8;transition:opacity .2s}.close-btn[_ngcontent-%COMP%]:hover{opacity:1}.modal-content[_ngcontent-%COMP%]{padding:1.5rem;overflow-y:auto;flex:1;min-height:200px}.loading-container[_ngcontent-%COMP%], .no-supervisors[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:200px;text-align:center}.spinner[_ngcontent-%COMP%]{width:40px;height:40px;border:3px solid #e5e7eb;border-top-color:#3b82f6;border-radius:50%;animation:_ngcontent-%COMP%_spin 1s linear infinite;margin-bottom:1rem}@keyframes _ngcontent-%COMP%_spin{to{transform:rotate(360deg)}}.warning-icon[_ngcontent-%COMP%]{font-size:3rem;margin-bottom:1rem}.no-supervisors[_ngcontent-%COMP%]   .title[_ngcontent-%COMP%]{font-size:1.1rem;font-weight:600;color:#374151;margin:0 0 .5rem}.no-supervisors[_ngcontent-%COMP%]   .subtitle[_ngcontent-%COMP%]{color:#6b7280;margin:0 0 1rem}.retry-btn[_ngcontent-%COMP%]{padding:.5rem 1rem;border:1px solid #3b82f6;background:#fff;color:#3b82f6;border-radius:6px;cursor:pointer;transition:all .2s}.retry-btn[_ngcontent-%COMP%]:hover{background:#eff6ff}.instruction[_ngcontent-%COMP%]{color:#6b7280;margin:0 0 1rem;font-size:.875rem}.supervisors-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.75rem}.supervisor-card[_ngcontent-%COMP%]{display:flex;align-items:center;gap:1rem;padding:1rem;border:2px solid #e5e7eb;border-radius:10px;cursor:pointer;transition:all .2s}.supervisor-card[_ngcontent-%COMP%]:hover{border-color:#93c5fd;background:#f0f9ff}.supervisor-card.selected[_ngcontent-%COMP%]{border-color:#3b82f6;background:#eff6ff}.radio-container[_ngcontent-%COMP%]{flex-shrink:0}.radio-container[_ngcontent-%COMP%]   input[type=radio][_ngcontent-%COMP%]{width:18px;height:18px;accent-color:#3b82f6;cursor:pointer}.supervisor-info[_ngcontent-%COMP%]{flex:1}.name[_ngcontent-%COMP%]{font-weight:600;color:#1f2937;display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem}.user-icon[_ngcontent-%COMP%]{font-size:1rem}.details[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:.5rem}.rol-badge[_ngcontent-%COMP%]{padding:.2rem .5rem;border-radius:4px;font-size:.7rem;font-weight:600;text-transform:uppercase;background:#dbeafe;color:#1d4ed8}.rol-badge.admin[_ngcontent-%COMP%]{background:#fee2e2;color:#dc2626}.estado-badge[_ngcontent-%COMP%]{padding:.2rem .5rem;border-radius:4px;font-size:.7rem;font-weight:600}.estado-badge.disponible[_ngcontent-%COMP%]{background:#dcfce7;color:#166534}.estado-badge.en-llamada[_ngcontent-%COMP%]{background:#fef3c7;color:#92400e}.estado-badge.desconectado[_ngcontent-%COMP%]{background:#fee2e2;color:#dc2626}.pendientes-badge[_ngcontent-%COMP%]{padding:.2rem .5rem;border-radius:4px;font-size:.7rem;font-weight:600;background:#fef3c7;color:#92400e}.modal-footer[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:.75rem;padding:1rem 1.5rem;border-top:1px solid #e5e7eb;background:#f9fafb;border-radius:0 0 12px 12px}.btn[_ngcontent-%COMP%]{padding:.625rem 1.25rem;border-radius:8px;font-weight:500;cursor:pointer;transition:all .2s}.btn-cancel[_ngcontent-%COMP%]{background:#fff;border:1px solid #d1d5db;color:#374151}.btn-cancel[_ngcontent-%COMP%]:hover{background:#f3f4f6}.btn-primary[_ngcontent-%COMP%]{background:#3b82f6;border:none;color:#fff}.btn-primary[_ngcontent-%COMP%]:hover:not(:disabled){background:#2563eb}.btn-primary[_ngcontent-%COMP%]:disabled{background:#93c5fd;cursor:not-allowed}"]});let n=d;return n})();var pt=(()=>{let d=class d{constructor(e){this.apiService=e,this.systemConfig={campana:{id:"CAMP-001",nombre:"Cartera Vencida Q3 2025",tipo:"Cobranza Temprana"},tipificaciones:{contacto:[{id:"CPC",codigo:"CPC",label:"Contacto con Cliente"},{id:"CTT",codigo:"CTT",label:"Contacto con Tercero"},{id:"NCL",codigo:"NCL",label:"No Contesta"},{id:"BZN",codigo:"BZN",label:"Buz\xF3n de Voz"},{id:"OCP",codigo:"OCP",label:"Ocupado"},{id:"FTN",codigo:"FTN",label:"Fuera de Tono"},{id:"NEQ",codigo:"NEQ",label:"N\xFAmero Equivocado"},{id:"TEL",codigo:"TEL",label:"Tel\xE9fono Inv\xE1lido"},{id:"CLG",codigo:"CLG",label:"Cliente Colg\xF3"},{id:"RCH",codigo:"RCH",label:"Rechaz\xF3 Llamada"}],gestion:[{id:"ACP",codigo:"ACP",label:"Acepta Compromiso de Pago",requiere_pago:!0,requiere_fecha:!0},{id:"PGR",codigo:"PGR",label:"Pago Realizado - Completo",requiere_pago:!0},{id:"PGP",codigo:"PGP",label:"Pago Parcial Realizado",requiere_pago:!0},{id:"PGT",codigo:"PGT",label:"Pago Total de Deuda",requiere_pago:!0},{id:"PPR",codigo:"PPR",label:"Pago Programado",requiere_pago:!0,requiere_fecha:!0},{id:"SRP",codigo:"SRP",label:"Solicita Refinanciamiento",requiere_seguimiento:!0},{id:"SQA",codigo:"SQA",label:"Solicita Quita o Descuento",requiere_seguimiento:!0},{id:"SCN",codigo:"SCN",label:"Solicita Congelamiento",requiere_seguimiento:!0},{id:"SPL",codigo:"SPL",label:"Solicita Ampliaci\xF3n de Plazo",requiere_seguimiento:!0},{id:"DPD",codigo:"DPD",label:"Disputa de Deuda",requiere_seguimiento:!0},{id:"NRD",codigo:"NRD",label:"No Reconoce Deuda",requiere_seguimiento:!0},{id:"DIF",codigo:"DIF",label:"Dificultad Financiera Temporal",requiere_seguimiento:!0},{id:"DSE",codigo:"DSE",label:"Desempleo",requiere_seguimiento:!0},{id:"ENF",codigo:"ENF",label:"Enfermedad/Incapacidad",requiere_seguimiento:!0},{id:"FLC",codigo:"FLC",label:"Fallecimiento del Titular",requiere_seguimiento:!0},{id:"RCL",codigo:"RCL",label:"Reclamo Registrado",requiere_seguimiento:!0},{id:"FRD",codigo:"FRD",label:"Reporte de Fraude",requiere_seguimiento:!0},{id:"NCB",codigo:"NCB",label:"Sin Capacidad de Pago",requiere_seguimiento:!0},{id:"VJE",codigo:"VJE",label:"Viaje/Fuera del Pa\xEDs",requiere_fecha:!0},{id:"SLL",codigo:"SLL",label:"Solicita Llamar Despu\xE9s",requiere_fecha:!0},{id:"NIN",codigo:"NIN",label:"No est\xE1 Interesado"},{id:"AGR",codigo:"AGR",label:"Cliente Agresivo/Hostil"},{id:"NBL",codigo:"NBL",label:"No Desea Ser Contactado"},{id:"LGL",codigo:"LGL",label:"Amenaza Legal"},{id:"CNV",codigo:"CNV",label:"Acepta Convenio de Pago",requiere_cronograma:!0,requiere_fecha:!0},{id:"CRO",codigo:"CRO",label:"Solicita Cronograma de Pagos",requiere_cronograma:!0,requiere_cuotas:!0},{id:"CPP",codigo:"CPP",label:"Convenio con Pago Parcial Inicial",requiere_cronograma:!0,requiere_monto_inicial:!0},{id:"CTT",codigo:"CTT",label:"Convenio a Plazo Total",requiere_cronograma:!0,requiere_periodicidad:!0},{id:"CCG",codigo:"CCG",label:"Convenio con Congelamiento",requiere_cronograma:!0,requiere_fecha:!0},{id:"CRF",codigo:"CRF",label:"Convenio con Refinanciamiento",requiere_cronograma:!0,requiere_seguimiento:!0},{id:"CQT",codigo:"CQT",label:"Convenio con Quita/Descuento",requiere_cronograma:!0,requiere_pago:!0},{id:"CAP",codigo:"CAP",label:"Convenio Aprobado por Supervisor",requiere_cronograma:!0,requiere_autorizacion:!0},{id:"CRC",codigo:"CRC",label:"Cliente Rechaza Convenio Propuesto",requiere_seguimiento:!0},{id:"CEV",codigo:"CEV",label:"Convenio en Evaluaci\xF3n",requiere_seguimiento:!0,requiere_fecha:!0}],motivo_no_pago:[{id:"FRE",label:"Falta de Recursos Econ\xF3micos"},{id:"DSP",label:"Desempleo Reciente"},{id:"RDS",label:"Reducci\xF3n de Salario"},{id:"EMR",label:"Emergencia M\xE9dica"},{id:"GSF",label:"Gastos Familiares Imprevistos"},{id:"OGS",label:"Otros Gastos Prioritarios"},{id:"NGC",label:"Negocio/Comercio en Crisis"},{id:"DCP",label:"Desconoce el Cargo/Producto"},{id:"IFC",label:"Inconformidad con Servicio"},{id:"FCC",label:"Fraude o Cargo no Reconocido"},{id:"OLV",label:"Olvido de Fecha de Pago"},{id:"PRG",label:"Problemas con M\xE9todo de Pago"},{id:"BNK",label:"Problemas Bancarios"},{id:"OTR",label:"Otro Motivo"}]},metodos_pago:[{id:"TDC",codigo:"TDC",label:"Tarjeta de Cr\xE9dito",icono:"\u{1F4B3}",requiere_ultimos4:!0},{id:"TDD",codigo:"TDD",label:"Tarjeta de D\xE9bito",icono:"\u{1F4B3}",requiere_ultimos4:!0},{id:"TRF",codigo:"TRF",label:"Transferencia Bancaria",icono:"\u{1F3E6}",requiere_banco:!0},{id:"DEP",codigo:"DEP",label:"Dep\xF3sito en Cuenta",icono:"\u{1F3E6}",requiere_banco:!0},{id:"EFE",codigo:"EFE",label:"Efectivo en Agencia",icono:"\u{1F4B5}",requiere_agencia:!0},{id:"CAU",codigo:"CAU",label:"Cargo Autom\xE1tico",icono:"\u{1F504}",requiere_autorizacion:!0},{id:"YPE",codigo:"YPE",label:"Yape",icono:"\u{1F4F1}",requiere_telefono:!0},{id:"PLN",codigo:"PLN",label:"Plin",icono:"\u{1F4F1}",requiere_telefono:!0},{id:"TNK",codigo:"TNK",label:"Tunki",icono:"\u{1F4F1}",requiere_telefono:!0},{id:"PGW",codigo:"PGW",label:"Pasarela Web/Link de Pago",icono:"\u{1F310}",requiere_email:!0}],bancos:["BCP - Banco de Cr\xE9dito del Per\xFA","BBVA","Interbank","Scotiabank","BanBif","Banco Pichincha","Banco Falabella","Banco Ripley","Banco Azteca","Otros"],cronograma_config:{periodicidades:[{id:"SEM",label:"Semanal",dias:7},{id:"QUI",label:"Quincenal",dias:15},{id:"MEN",label:"Mensual",dias:30},{id:"BIM",label:"Bimestral",dias:60},{id:"TRI",label:"Trimestral",dias:90}],tipos_cronograma:[{id:"FIJ",label:"Cuotas Fijas",descripcion:"Mismo monto cada cuota"},{id:"DEC",label:"Decreciente",descripcion:"Cuotas van disminuyendo"},{id:"ESC",label:"Escalonado",descripcion:"Cuotas aumentan gradualmente"},{id:"PER",label:"Personalizado",descripcion:"Montos espec\xEDficos por cuota"}],campos_requeridos:{requiere_cronograma:["numero_cuotas","periodicidad","fecha_primera_cuota"],requiere_cuotas:["numero_cuotas","monto_cuota"],requiere_monto_inicial:["monto_inicial","fecha_pago_inicial"],requiere_periodicidad:["periodicidad","dia_pago"],requiere_autorizacion:["supervisor_id","codigo_autorizacion"]},validaciones:{numero_cuotas_max:48,numero_cuotas_min:2,monto_minimo_cuota:50,porcentaje_quita_max:30,dias_gracia_max:90}}}}getSystemConfig(){return this.systemConfig}getCampaign(){return this.apiService.getActiveCampaign()||this.systemConfig.campana}getContactClassifications(){let e=this.apiService.tenantClassifications();if(e.length>0){let i=e.filter(l=>l.typification.tipoClasificacion==="CONTACT_RESULT"&&l.isEnabled).map(l=>({id:l.typification.id,codigo:l.typification.codigo,label:l.customName||l.typification.nombre}));if(i.length>0)return i}let t=this.apiService.getContactClassificationsForUI();return t.length>0?t:this.systemConfig.tipificaciones.contacto}getManagementClassifications(){let e=this.apiService.tenantClassifications();if(e.length>0){let i=e.filter(l=>l.isEnabled).map(l=>{let m=l.typification.metadataSchema?JSON.parse(l.typification.metadataSchema):{};return{id:String(l.typification.id),codigo:l.typification.codigo,label:l.customName||l.typification.nombre,requiere_pago:m.requiresPayment||!1,requiere_cronograma:m.requiresSchedule||!1,requiere_seguimiento:m.requiresFollowUp||!1,parentId:l.typification.parentTypificationId,hierarchyLevel:l.typification.nivelJerarquia,suggestsFullAmount:l.typification.suggestsFullAmount,allowsInstallmentSelection:l.typification.allowsInstallmentSelection,requiresManualAmount:l.typification.requiresManualAmount}});if(i.length>0)return i}let t=this.apiService.getManagementClassificationsForUI();return t.length>0?t:this.systemConfig.tipificaciones.gestion}getPaymentNoReasons(){return this.systemConfig.tipificaciones.motivo_no_pago}getPaymentMethods(){return this.systemConfig.metodos_pago}getBanks(){return this.systemConfig.bancos}getScheduleConfig(){return this.systemConfig.cronograma_config}getManagementClassificationById(e){return this.getManagementClassifications().find(l=>l.id==e)}};d.\u0275fac=function(t){return new(t||d)(le(Fe))},d.\u0275prov=ee({token:d,factory:d.\u0275fac,providedIn:"root"});let n=d;return n})();var ht=(()=>{let d=class d{constructor(e){this.http=e,this.baseUrl=`${Y.gatewayUrl}/v2/management-records`,this.scheduleUrl=`${Y.tipificacionUrl}/payment-schedules`,this.cabecerasUrl=`${Y.gatewayUrl}/configuracion-cabeceras`}createManagement(e){let t=this.transformToBackendFormat(e);return console.log("[MANAGEMENT] Creating management record:",t),this.http.post(this.baseUrl,t).pipe(Ce(i=>this.transformToFrontendFormat(i,e)))}getManagementById(e){return this.http.get(`${this.baseUrl}/${e}`).pipe(Ce(t=>this.transformToFrontendFormat(t)))}getManagementsByCustomer(e){return this.http.get(`${this.baseUrl}/client/${e}`).pipe(Ce(t=>t.map(i=>this.transformToFrontendFormat(i))))}getManagementsByAdvisor(e){return this.http.get(`${this.baseUrl}/agent/${e}`).pipe(Ce(t=>t.map(i=>this.transformToFrontendFormat(i))))}getActiveSchedulesByCustomer(e){return console.log("[SCHEDULE] Fetching active schedules for customer:",e),this.http.get(`${this.baseUrl}/payment-schedule/client/${e}/active`).pipe(Ce(t=>this.transformToPaymentSchedules(t)))}transformToPaymentSchedules(e){return e.map(t=>{let i=t.cuotasPromesa||[],l=i.reduce((S,D)=>S+(D.monto||0),0),m=i.filter(S=>S.estado==="PAGADA"||S.estado==="CUMPLIDO").reduce((S,D)=>S+(D.montoPagadoReal||D.monto||0),0),g=l-m,w=i.filter(S=>S.estado==="PAGADA"||S.estado==="CUMPLIDO").length,C=i.filter(S=>S.estado==="PENDIENTE").length;return{id:t.id,scheduleId:{scheduleId:t.grupoPromesaUuid||t.uuid},customerId:String(t.idCliente),managementId:String(t.id),totalAmount:l,numberOfInstallments:i.length,startDate:t.fechaGestion?.split("T")[0]||new Date().toISOString().split("T")[0],isActive:C>0,scheduleType:t.tipoCronograma||"CONFIANZA",negotiatedAmount:t.montoPromesaPago||l,installments:i.map(S=>({id:S.id,installmentNumber:S.numeroCuota,numeroCuota:S.numeroCuota,amount:S.monto,monto:S.monto,dueDate:S.fechaPago,fechaPago:S.fechaPago,paidDate:S.fechaPagoReal||null,status:S.estado||"PENDIENTE"})),paidAmount:m,pendingAmount:g,paidInstallments:w,pendingInstallments:C,fullyPaid:C===0}})}startCall(e,t){return console.log("[CALL] Start call for management:",e,t),this.getManagementById(e.toString())}endCall(e,t){return console.log("[CALL] End call for management:",e,t),this.getManagementById(e.toString())}registerPayment(e,t){return console.log("[PAYMENT] Register payment for management:",e,t),this.getManagementById(e)}createPaymentSchedule(e){return console.log("[SCHEDULE] Creating payment schedule:",e),this.http.post(`${this.baseUrl}/payment-schedule`,e)}updatePaymentStatus(e,t,i,l){console.log("[PAYMENT-STATUS] Updating payment status:",{recordId:e,estadoPago:t,montoPagadoReal:i,fechaPagoReal:l});let m=`estadoPago=${t}`;return i!==void 0&&(m+=`&montoPagadoReal=${i}`),l&&(m+=`&fechaPagoReal=${l}`),this.http.put(`${this.baseUrl}/${e}/payment-status?${m}`,{})}puedeCancelarCuota(e){return console.log("[CUOTA] Checking if cuota can be canceled:",e),this.http.get(`${this.baseUrl}/cuota/${e}/puede-cancelar`)}cancelarCuota(e,t,i,l){console.log("[CUOTA] Canceling cuota:",{cuotaId:e,montoPagadoReal:t,fechaPagoReal:i,observaciones:l});let m="",g=[];return t!==void 0&&g.push(`montoPagadoReal=${t}`),i&&g.push(`fechaPagoReal=${i}`),l&&g.push(`observaciones=${encodeURIComponent(l)}`),g.length>0&&(m="?"+g.join("&")),this.http.put(`${this.baseUrl}/cuota/${e}/cancelar${m}`,{})}getMontoCabeceras(e){return console.log("[CABECERAS] Fetching monto cabeceras for subcartera:",e),this.http.get(`${this.cabecerasUrl}/subcartera/${e}/montos`)}transformToBackendFormat(e){let t=e.level3Id||e.level2Id||e.level1Id,i=[];e.level1Name&&i.push(e.level1Name),e.level2Name&&i.push(e.level2Name),e.level3Name&&i.push(e.level3Name);let l=i.join(" > "),m={idTenant:e.tenantId,idCartera:e.portfolioId,idSubcartera:e.subPortfolioId||void 0,idCliente:Number(e.customerId),nombreCliente:e.customerName||void 0,documentoCliente:e.customerDocument||void 0,idAgente:this.extractAgentId(e.advisorId),tipificacion:{id:t},observaciones:e.observations||"",canalContacto:e.canalContacto||"SISTEMA",metodoContacto:e.metodoContacto||"GESTION_MANUAL",estadoGestion:"COMPLETADA",rutaJerarquia:l||void 0,idCampana:e.idCampana||void 0,idLlamada:e.idLlamada||void 0,duracionSegundos:e.duracionSegundos||void 0,nombreAgente:e.nombreAgente||void 0,userAgent:e.userAgent||void 0};return e.level1Id&&(m.tipificacionNivel1={id:e.level1Id}),e.level2Id&&(m.tipificacionNivel2={id:e.level2Id}),e.level3Id&&(m.tipificacionNivel3={id:e.level3Id}),m}transformToFrontendFormat(e,t){return{id:e.id||0,customerId:String(e.idCliente),advisorId:String(e.idAgente),tenantId:e.idTenant,tenantName:"",portfolioId:e.idCartera||0,portfolioName:"",subPortfolioId:e.idSubcartera,subPortfolioName:"",phone:e.canalContacto||"",level1Id:e.tipificacionNivel1?.id||e.tipificacion?.id||0,level1Name:t?.level1Name||e.tipificacionNivel1?.nombre||"",level2Id:e.tipificacionNivel2?.id,level2Name:t?.level2Name||e.tipificacionNivel2?.nombre||"",level3Id:e.tipificacionNivel3?.id,level3Name:t?.level3Name||e.tipificacionNivel3?.nombre||"",observations:e.observaciones,managementDate:e.fechaGestion?.split("T")[0],managementTime:e.fechaGestion?.split("T")[1]?.substring(0,8)}}extractAgentId(e){return e.startsWith("ADV-")?1:Number(e)||1}};d.\u0275fac=function(t){return new(t||d)(le(ne))},d.\u0275prov=ee({token:d,factory:d.\u0275fac,providedIn:"root"});let n=d;return n})();var ft=(()=>{let d=class d{constructor(){this.http=Be(ne),this.apiUrl=`${Y.tipificacionUrl}/customer-outputs`}saveConfiguration(e){return this.http.post(`${this.apiUrl}/config`,e)}getConfiguration(e,t){let i={tenantId:e};return t!=null&&(i.portfolioId=t),this.http.get(`${this.apiUrl}/config`,{params:i})}};d.\u0275fac=function(t){return new(t||d)},d.\u0275prov=ee({token:d,factory:d.\u0275fac,providedIn:"root"});let n=d;return n})();var bt=(()=>{let d=class d{constructor(e){this.http=e,this.apiUrl=`${Y.apiUrl}/customers`}getAllCustomers(){return this.http.get(this.apiUrl)}getCustomerById(e){return this.http.get(`${this.apiUrl}/${e}`)}getCustomerByDocument(e){return this.http.get(`${this.apiUrl}/document/${e}`)}searchCustomers(e){return this.http.get(`${this.apiUrl}/search`,{params:{q:e}})}filterCustomers(e){return this.http.get(`${this.apiUrl}/filter`,{params:q({},e)})}createCustomer(e){return this.http.post(this.apiUrl,e)}updateCustomer(e,t){return this.http.put(`${this.apiUrl}/${e}`,t)}deleteCustomer(e){return this.http.delete(`${this.apiUrl}/${e}`)}getCustomerDetail(e,t){return this.http.get(`${this.apiUrl}/detail/${e}`,{params:{subPortfolioId:t.toString()}})}searchCustomerByCriteria(e,t,i){return this.http.get(`${this.apiUrl}/search-by`,{params:{tenantId:e.toString(),searchBy:t,value:i}})}searchCustomersByCriteria(e,t,i){return this.http.get(`${this.apiUrl}/search-by-multi`,{params:{tenantId:e.toString(),searchBy:t,value:i}})}searchCustomersAcrossAllTenants(e,t){return this.http.get(`${this.apiUrl}/search-all-tenants`,{params:{searchBy:e,value:t}})}getRecentCustomers(){return this.http.get(`${this.apiUrl}/recent`)}registerCustomerAccess(e){return this.http.post(`${this.apiUrl}/${e}/access`,{})}};d.\u0275fac=function(t){return new(t||d)(le(ne))},d.\u0275prov=ee({token:d,factory:d.\u0275fac,providedIn:"root"});let n=d;return n})();var Qt=["dynamicFieldRendererComponent"],fe=(n,d)=>d.id,Re=(n,d)=>d.numeroCuota,Jt=(n,d)=>d.field;function Zt(n,d){n&1&&(r(0,"div",2)(1,"div",61)(2,"div")(3,"div",62),s(4,"\xA1Gesti\xF3n Guardada!"),o(),r(5,"div",63),s(6,"Los datos se registraron correctamente"),o()()()())}function Kt(n,d){n&1&&W(0,"div",65)}function Xt(n,d){if(n&1){let a=O();r(0,"button",64),F("click",function(){let t=T(a).$implicit,i=u();return M(i.activeTab.set(t.id))}),s(1),p(2,Kt,1,0,"div",65),o()}if(n&2){let a=d.$implicit,e=u();L("flex-1 px-2 py-1.5 text-[11px] font-semibold transition-all relative "+(e.activeTab()===a.id?"text-blue-700 dark:text-blue-200 bg-blue-50 dark:bg-blue-950/50":"text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800")),c(),f(" ",a.label," "),c(),h(e.activeTab()===a.id?2:-1)}}function ei(n,d){if(n&1&&(r(0,"div",66)(1,"div",68),s(2),o(),r(3,"div",69),s(4),o()()),n&2){let a=d.$implicit,e=u(2);c(2),j(a.label),c(2),f(" ",e.formatFieldValue(e.getFieldValue(a.field),a.format)," ")}}function ti(n,d){n&1&&(r(0,"div",67),s(1," Sin campos configurados "),o())}function ii(n,d){if(n&1&&(r(0,"div",21),B(1,ei,5,2,"div",66,fe),p(3,ti,2,0,"div",67),o()),n&2){let a=u();c(),z(a.customerOutputFields()),c(2),h(a.customerOutputFields().length===0?3:-1)}}function ni(n,d){if(n&1){let a=O();r(0,"div",70)(1,"p",71),s(2,"Sin gestiones previas"),o(),r(3,"button",72),F("click",function(){T(a);let t=u(2);return M(t.loadManagementHistory())}),s(4,"Recargar"),o()()}}function ai(n,d){if(n&1){let a=O();r(0,"button",80),F("click",function(){T(a);let t=u().$implicit,i=u(3);return M(i.openScheduleDetail(t.id))}),s(1," Ver cronograma \u2192 "),o()}}function oi(n,d){if(n&1&&(r(0,"div",73)(1,"div",74)(2,"span",75),s(3),o(),r(4,"span",76),s(5),o()(),r(6,"div",77),s(7),o(),r(8,"div",78),s(9),o(),p(10,ai,2,0,"button",79),o()),n&2){let a=d.$implicit;c(3),j(a.fecha),c(2),j(a.asesor),c(2),j(a.gestion),c(2),j(a.observacion),c(),h(a.schedule?10:-1)}}function ri(n,d){if(n&1&&B(0,oi,11,5,"div",73,Le),n&2){let a=u(2);z(a.historialGestiones())}}function li(n,d){if(n&1&&(r(0,"div",22),p(1,ni,5,0,"div",70)(2,ri,2,0),o()),n&2){let a=u();c(),h(a.historialGestiones().length===0?1:2)}}function si(n,d){if(n&1&&(r(0,"option",86),s(1),o()),n&2){let a=d.$implicit;$("value",a.id),c(),Me("[",a.codigo,"] ",a.label)}}function di(n,d){n&1&&(r(0,"div",87),s(1," Requerido "),o())}function ci(n,d){if(n&1){let a=O();r(0,"div",29)(1,"label",81),W(2,"div",82),s(3," Resultado de Contacto * "),o(),r(4,"div",83)(5,"select",84),he("ngModelChange",function(t){T(a);let i=u();return pe(i.managementForm.resultadoContacto,t)||(i.managementForm.resultadoContacto=t),M(t)}),F("ngModelChange",function(){T(a);let t=u();return M(t.onContactResultChange())}),r(6,"option",85),s(7,"-- Seleccionar resultado --"),o(),B(8,si,2,3,"option",86,fe),o()(),p(10,di,2,0,"div",87),o()}if(n&2){let a=u();c(5),L("w-full p-2 pr-8 border rounded-lg font-semibold text-gray-700 dark:text-white appearance-none cursor-pointer transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-200 dark:focus:ring-blue-800 hover:border-blue-400 dark:hover:border-blue-600 text-xs "+(a.errors().resultadoContacto?"border-red-500 bg-red-50 dark:bg-red-950/30 dark:border-red-600":"border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-900")+" "+(a.managementForm.resultadoContacto?"bg-blue-50 dark:bg-blue-950/30 border-blue-400 dark:border-blue-600":"")),ge("ngModel",a.managementForm.resultadoContacto),c(3),z(a.contactClassifications()),c(2),h(a.errors().resultadoContacto?10:-1)}}function mi(n,d){n&1&&(r(0,"span",105),W(1,"lucide-angular",109),o()),n&2&&(c(),$("size",10))}function ui(n,d){n&1&&(r(0,"span",106),W(1,"lucide-angular",110),o()),n&2&&(c(),$("size",10))}function gi(n,d){n&1&&(r(0,"span",107),W(1,"lucide-angular",111),o()),n&2&&(c(),$("size",10))}function pi(n,d){n&1&&(r(0,"span",108),W(1,"lucide-angular",112),o()),n&2&&(c(),$("size",10))}function hi(n,d){if(n&1&&(r(0,"div",99)(1,"span",62),s(2),o(),r(3,"span",101),s(4,"|"),o(),r(5,"span",102),s(6),o(),r(7,"span",101),s(8,"|"),o(),r(9,"span",103),W(10,"lucide-angular",104),s(11),o(),p(12,mi,2,1,"span",105)(13,ui,2,1,"span",106)(14,gi,2,1,"span",107)(15,pi,2,1,"span",108),o()),n&2){let a=d.$implicit,e=u(3);c(2),f("C",a.numeroCuota),c(4),f("S/ ",(a.monto==null?null:a.monto.toFixed(2))||"0.00"),c(4),$("size",12),c(),f(" ",e.formatDate(a.dueDate)," "),c(),h(a.status==="PAGADA"||a.status==="PAGADO"||a.status==="CUMPLIDO"?12:a.status==="VENCIDA"||a.status==="VENCIDO"?13:a.status==="CANCELADA"||a.status==="CANCELADO"?14:15)}}function fi(n,d){if(n&1&&(r(0,"div",100)(1,"span",102),s(2),o(),s(3," pendiente(s) \xB7 Pr\xF3x: "),r(4,"span",102),s(5),o()()),n&2){let a=u().$implicit,e=u(2);c(2),j(a.cuotasPendientes),c(3),j(e.formatDate(a.nextDueDate))}}function bi(n,d){if(n&1&&(r(0,"div",88)(1,"div",89)(2,"div",90)(3,"div",91)(4,"span",92),s(5,"\u26A0"),o()(),r(6,"div")(7,"div",93),s(8,"PROMESA DE PAGO ACTIVA"),o(),r(9,"div",94),s(10,"No puede registrar otra promesa"),o()()(),r(11,"div",14)(12,"div",95),s(13),o(),r(14,"div",94),s(15,"Total"),o()()(),r(16,"div",96)(17,"div",97),s(18,"DETALLE DE CUOTAS:"),o(),r(19,"div",98),B(20,hi,16,5,"div",99,Re),o(),p(22,fi,6,2,"div",100),o()()),n&2){let a=d.$implicit;c(13),f("S/ ",(a.totalAmount==null?null:a.totalAmount.toFixed(2))||"0.00"),c(7),z(a.installments),c(2),h(a.cuotasPendientes>0&&a.nextDueDate?22:-1)}}function Ci(n,d){if(n&1&&(r(0,"div",30),B(1,bi,23,2,"div",88,fe),o()),n&2){let a=u();c(),z(a.activePaymentSchedules())}}function xi(n,d){if(n&1&&(r(0,"option",86),s(1),o()),n&2){let a=d.$implicit;$("value",a.id),c(),Me("[",a.codigo,"] ",a.label)}}function _i(n,d){if(n&1){let a=O();r(0,"div",115)(1,"label",116),s(2),o(),r(3,"select",84),F("ngModelChange",function(t){T(a);let i=u().$index,l=u(2);return M(l.onClassificationLevelChange(i,t))}),r(4,"option",85),s(5,"Seleccionar..."),o(),B(6,xi,2,3,"option",86,fe),o()()}if(n&2){let a=u(),e=a.$implicit,t=a.$index,i=u(2);c(2),Me(" ",i.getDynamicLevelLabel(t),"",t===0?" *":""," "),c(),L("w-full p-1.5 border rounded text-[11px] font-medium transition-all focus:outline-none focus:ring-1 focus:ring-blue-400 "+(i.errors().tipoGestion&&t===0?"border-red-400 bg-red-50 dark:bg-red-950/30":"border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-700 dark:text-white")+" "+(i.selectedClassifications()[t]?"border-green-400 bg-green-50 dark:bg-green-950/30":"")),$("ngModel",i.selectedClassifications()[t]),c(3),z(e)}}function vi(n,d){if(n&1&&p(0,_i,8,5,"div",115),n&2){let a=d.$index,e=u(2);h(e.shouldShowLevel(a)?0:-1)}}function Si(n,d){n&1&&(r(0,"div",114),s(1,"Seleccione una clasificaci\xF3n"),o())}function yi(n,d){if(n&1&&(r(0,"div",31)(1,"div",113),s(2,"Clasificaci\xF3n"),o(),r(3,"div",98),B(4,vi,1,1,null,null,Le),o(),p(6,Si,2,0,"div",114),o()),n&2){let a=u();c(4),z(a.hierarchyLevels()),c(2),h(a.errors().tipoGestion?6:-1)}}function Ei(n,d){n&1&&(r(0,"div",32)(1,"div",117)(2,"span",118),s(3,"Cargando campos adicionales..."),o()()())}function Pi(n,d){n&1&&(r(0,"div",33)(1,"div",119)(2,"span",118),s(3,"Esta clasificaci\xF3n no tiene campos adicionales configurados"),o()()())}function Di(n,d){if(n&1){let a=O();r(0,"app-dynamic-field-renderer",120,0),F("dataChange",function(t){T(a);let i=u();return M(i.onDynamicFieldsChange(t))})("customAmountDetected",function(t){T(a);let i=u();return M(i.onCustomAmountDetected(t))}),o()}if(n&2){let a=u();$("schema",a.dynamicFieldsSchema())("externalUpdates",a.externalFieldUpdates())("selectedClassification",a.selectedClassification())("customerAmounts",a.customerPaymentAmounts())}}function Ii(n,d){n&1&&(r(0,"div",35)(1,"div",121)(2,"span",122),s(3,"Cargando cronogramas pendientes..."),o()()())}function Ti(n,d){if(n&1&&(r(0,"div",134)(1,"div",7)(2,"span",135),s(3),o(),r(4,"span",136),s(5),o()(),r(6,"span",137),s(7),te(8,"number"),o()()),n&2){let a=u().$implicit;c(3),f("Cuota #",a.installmentNumber),c(2),f("Vence: ",a.dueDate),c(2),f("S/ ",ie(8,3,a.amount,"1.2-2"))}}function Mi(n,d){if(n&1&&p(0,Ti,9,6,"div",134),n&2){let a=d.$index;h(a<3?0:-1)}}function wi(n,d){if(n&1&&(r(0,"div",129),s(1),o()),n&2){let a=u().$implicit,e=u(2);c(),f(" + ",e.getPendingInstallments(a).length-3," cuotas m\xE1s ")}}function Ai(n,d){if(n&1){let a=O();r(0,"button",138),F("click",function(){T(a);let t=u(3);return M(t.applyNextInstallmentPayment())}),s(1," Usar Pr\xF3xima Cuota "),o()}}function ki(n,d){if(n&1){let a=O();r(0,"button",139),F("click",function(){T(a);let t=u(3);return M(t.applyFullSchedulePayment())}),s(1),te(2,"number"),o()}if(n&2){let a=u().$implicit,e=u(2);c(),f(" Pagar Todo (S/ ",ie(2,1,e.calculatePendingAmount(a),"1.2-2"),") ")}}function Fi(n,d){if(n&1&&(r(0,"div",126)(1,"div",5)(2,"div",7)(3,"div",124),s(4),o(),r(5,"div",127),s(6," ACTIVO "),o()(),r(7,"div",124),s(8),te(9,"number"),o()(),r(10,"div",22)(11,"div",128),s(12,"Cuotas Pendientes"),o(),B(13,Mi,1,1,null,null,fe),p(15,wi,2,1,"div",129),o(),r(16,"div",130),p(17,Ai,2,0,"button",131),p(18,ki,3,4,"button",132),o(),r(19,"div",133)(20,"span"),s(21,"El pago se aplicar\xE1 autom\xE1ticamente a las cuotas pendientes en orden de vencimiento"),o()()()),n&2){let a,e,t=d.$implicit,i=u(2);c(4),f(" ",t.scheduleType||"CRONOGRAMA"," "),c(4),f(" S/ ",ie(9,5,t.totalAmount,"1.2-2")," "),c(5),z(i.getPendingInstallments(t)),c(2),h(i.getPendingInstallments(t).length>3?15:-1),c(2),h(((a=i.selectedClassification())==null?null:a.allowsInstallmentSelection)===!0?17:-1),c(),h(((e=i.selectedClassification())==null?null:e.suggestsFullAmount)===!0?18:-1)}}function Ni(n,d){if(n&1&&(r(0,"div",36)(1,"div",5)(2,"div",7),W(3,"div",123),r(4,"div")(5,"h4",124),s(6,"Cronograma Activo Detectado"),o(),r(7,"p",125),s(8),o()()()(),B(9,Fi,22,8,"div",126,fe),o()),n&2){let a=u();c(8),f("Cliente tiene ",a.activeSchedules().length," cronograma(s) pendiente(s)"),c(),z(a.activeSchedules())}}function Li(n,d){if(n&1){let a=O();r(0,"label",146)(1,"div",90)(2,"input",147),F("change",function(){let t=T(a).$implicit,i=u(3);return M(i.selectedInstallmentForCancellation.set(t))}),o(),r(3,"div")(4,"span",148),s(5),o(),r(6,"span",149),s(7),o()()(),r(8,"span",93),s(9),o()()}if(n&2){let a,e,t,i=d.$implicit,l=u(3);L(((a=l.selectedInstallmentForCancellation())==null?null:a.numeroCuota)===i.numeroCuota?"bg-green-500 text-white shadow-md":"bg-white dark:bg-gray-800 hover:bg-green-100 dark:hover:bg-green-900/30 border border-green-200 dark:border-green-700"),c(2),$("value",i)("checked",((e=l.selectedInstallmentForCancellation())==null?null:e.numeroCuota)===i.numeroCuota),c(3),f("Cuota ",i.numeroCuota),c(),L(((t=l.selectedInstallmentForCancellation())==null?null:t.numeroCuota)===i.numeroCuota?"text-green-100":"text-gray-500 dark:text-gray-400"),c(),f(" Vence: ",l.formatDate(i.dueDate)," "),c(2),f("S/ ",(i.monto==null?null:i.monto.toFixed(2))||"0.00")}}function Oi(n,d){if(n&1&&(r(0,"div",58),B(1,Li,10,9,"label",145,Re),o()),n&2){let a=u(2);c(),z(a.pendingInstallmentsForCancellation())}}function Vi(n,d){if(n&1&&(r(0,"div",153)(1,"div",90)(2,"span",155),s(3,"\u2717"),o(),r(4,"div")(5,"span",156),s(6),o(),r(7,"span",157),s(8),o()()(),r(9,"span",158),s(10),o()()),n&2){let a=d.$implicit,e=u(3);c(6),f("Cuota ",a.numeroCuota),c(2),f(" Venci\xF3: ",e.formatDate(a.dueDate)," "),c(2),f("S/ ",(a.monto==null?null:a.monto.toFixed(2))||"0.00")}}function Ui(n,d){if(n&1&&(r(0,"div",142)(1,"div",150)(2,"span",151),s(3,"\u26D4"),o(),r(4,"span",152),s(5,"CUOTAS VENCIDAS (No se pueden cancelar)"),o()(),r(6,"div",22),B(7,Vi,11,3,"div",153,Re),o(),r(9,"div",154),s(10," La fecha de pago ya pas\xF3. Estas cuotas ser\xE1n marcadas como promesa rota. "),o()()),n&2){let a=u(2);c(7),z(a.overdueInstallments())}}function $i(n,d){n&1&&(r(0,"div",143)(1,"span"),s(2,"\u{1F6AB}"),o(),r(3,"span"),s(4,"No hay cuotas disponibles para cancelar. Todas las cuotas est\xE1n vencidas."),o()())}function Ri(n,d){n&1&&(r(0,"div",144)(1,"span"),s(2,"\u26A0\uFE0F"),o(),r(3,"span"),s(4,"Debe seleccionar una cuota para registrar la cancelaci\xF3n"),o()())}function Bi(n,d){if(n&1&&(r(0,"div",37)(1,"div",7)(2,"span",92),s(3,"\u{1F4B0}"),o(),r(4,"div")(5,"h4",140),s(6,"Seleccionar Cuota a Cancelar"),o(),r(7,"p",141),s(8,"Elija qu\xE9 cuota de la promesa de pago est\xE1 cancelando"),o()()(),p(9,Oi,3,0,"div",58),p(10,Ui,11,0,"div",142),p(11,$i,5,0,"div",143)(12,Ri,5,0,"div",144),o()),n&2){let a=u();c(9),h(a.pendingInstallmentsForCancellation().length>0?9:-1),c(),h(a.overdueInstallments().length>0?10:-1),c(),h(a.pendingInstallmentsForCancellation().length===0&&a.overdueInstallments().length>0?11:!a.selectedInstallmentForCancellation()&&a.pendingInstallmentsForCancellation().length>0?12:-1)}}function zi(n,d){n&1&&(r(0,"span",160),s(1,"\u23F3 Esperando Autorizaci\xF3n..."),o())}function ji(n,d){n&1&&s(0," \u{1F510} Solicitar Autorizaci\xF3n ")}function Gi(n,d){if(n&1){let a=O();r(0,"button",159),F("click",function(){T(a);let t=u();return M(t.openSupervisorSelectionModal())}),p(1,zi,2,0,"span",160)(2,ji,1,0),o()}if(n&2){let a=u();$("disabled",a.saving()||!a.isFormValid()||a.waitingForAuthorization()),c(),h(a.waitingForAuthorization()?1:2)}}function qi(n,d){n&1&&s(0," Guardando... ")}function Hi(n,d){n&1&&s(0," Guardar Gesti\xF3n ")}function Wi(n,d){if(n&1){let a=O();r(0,"button",161),F("click",function(){T(a);let t=u();return M(t.saveManagement())}),p(1,qi,1,0)(2,Hi,1,0),o()}if(n&2){let a=u();$("disabled",a.saving()||!a.isFormValid()||a.isCancellationTypification()&&(a.pendingInstallmentsForCancellation().length>0||a.overdueInstallments().length>0)&&!a.selectedInstallmentForCancellation()||a.isCancellationTypification()&&a.pendingInstallmentsForCancellation().length===0&&a.overdueInstallments().length>0)("title","Guardando: "+a.saving()+" | V\xE1lido: "+a.isFormValid()),c(),h(a.saving()?1:2)}}function Yi(n,d){if(n&1&&(r(0,"div",50)(1,"span",162),s(2,"\u{1F4DE}"),o(),r(3,"div",47)(4,"div",163),s(5,"Alternativo"),o(),r(6,"div",164),s(7),o()()()),n&2){let a=u();c(7),j(a.customerData().contacto.telefono_alternativo)}}function Qi(n,d){if(n&1&&(r(0,"div",50)(1,"span",162),s(2,"\u{1F3E2}"),o(),r(3,"div",47)(4,"div",163),s(5,"Trabajo"),o(),r(6,"div",164),s(7),o()()()),n&2){let a=u();c(7),j(a.customerData().contacto.telefono_trabajo)}}function Ji(n,d){if(n&1&&(r(0,"div",51)(1,"span",165),s(2,"\u2709\uFE0F"),o(),r(3,"div",166),s(4),o()()),n&2){let a=u();c(4),j(a.customerData().contacto.email)}}function Zi(n,d){if(n&1&&(r(0,"div",51)(1,"span",167),s(2,"\u{1F4CD}"),o(),r(3,"div",168),s(4),o()()),n&2){let a=u();c(4),j(a.customerData().contacto.direccion)}}function Ki(n,d){if(n&1&&(r(0,"div",170)(1,"span",171),s(2),o(),r(3,"span",172),s(4),o()()),n&2){let a=d.$implicit,e=d.$index,t=u(2);L(t.getAmountRowClass(e)),c(2),j(a.label),c(2),f(" ",t.formatCurrency(a.value)," ")}}function Xi(n,d){if(n&1&&(r(0,"div",58),B(1,Ki,5,4,"div",169,Jt),o()),n&2){let a=u();c(),z(a.clientAmountFields())}}function en(n,d){if(n&1){let a=O();r(0,"div",59)(1,"div",173)(2,"div",174)(3,"div",90)(4,"div")(5,"h2",175),s(6,"Cronograma de Pagos"),o(),r(7,"p",63),s(8),o()()(),r(9,"button",176),F("click",function(){T(a);let t=u();return M(t.closeScheduleDetail())}),o()(),r(10,"div",177),W(11,"app-payment-schedule-view",178),o(),r(12,"div",179)(13,"button",180),F("click",function(){T(a);let t=u();return M(t.closeScheduleDetail())}),s(14," Cerrar "),o()()()()}if(n&2){let a=u();c(8),f("Gesti\xF3n ",a.scheduleManagementId()),c(3),$("managementId",a.scheduleManagementId())}}var ea=(()=>{let d=class d{constructor(e,t,i,l,m,g,w,C,S,D,H,ue,Q,A,J,X,G){this.systemConfigService=e,this.managementService=t,this.paymentScheduleService=i,this.themeService=l,this.classificationService=m,this.typificationV2Service=g,this.apiSystemConfigService=w,this.customerOutputConfigService=C,this.customerService=S,this.router=D,this.route=H,this.http=ue,this.sipService=Q,this.agentService=A,this.agentStatusService=J,this.authService=X,this.autorizacionService=G,this.callActive=b(!1),this.callDuration=b(0),this.saving=b(!1),this.showScheduleDetail=b(!1),this.scheduleManagementId=b(null),this.showOutputSelector=!1,this.errors=b({}),this.showSuccess=b(!1),this.animateEntry=b(!0),this.activeTab=b("cliente"),this.isTipifying=b(!1),this.colorIndicador=b("verde"),this.excedeTiempoMaximo=b(!1),this.requiresAuthorization=b(!1),this.waitingForAuthorization=b(!1),this.showSupervisorModal=!1,this.currentAuthorizationData=null,this.historialGestiones=b([]),this.tenants=[],this.portfolios=[],this.testDocument="",this.testPhone="",this.customerOutputFields=b([]),this.campaign=V(()=>this.systemConfigService.getCampaign()),this.contactClassifications=V(()=>this.systemConfigService.getContactClassifications()),this.managementClassifications=V(()=>this.apiSystemConfigService.getManagementClassificationsForUI()),this.managementClassificationsHierarchical=V(()=>{let _=this.managementClassifications(),k=new Map,E=new Map;_.forEach(v=>{let y=String(v.id);k.set(y,v),E.set(y,[])}),_.forEach(v=>{if(v.parentId){let y=String(v.parentId),I=E.get(y);I&&I.push(v)}});let x=(v,y=0)=>{let I=[];return v.forEach(K=>{I.push(re(q({},K),{indentLevel:y,displayLabel:"  ".repeat(y)+(y>0?"\u2514\u2500 ":"")+`[${K.codigo}] ${K.label}`}));let ae=String(K.id),oe=E.get(ae)||[];oe.length>0&&I.push(...x(oe,y+1))}),I},P=_.filter(v=>!v.parentId);return x(P,0)}),this.paymentMethods=V(()=>this.systemConfigService.getPaymentMethods()),this.scheduleTypes=V(()=>this.systemConfigService.getScheduleConfig().tipos_cronograma),this.periodicities=V(()=>this.systemConfigService.getScheduleConfig().periodicidades),this.customerPaymentAmounts=V(()=>{let _=this.rawClientData(),k=this.enabledPaymentOptions(),E=this.hasPaymentOptionsConfig(),x=this.montoCabeceras();if(!_||Object.keys(_).length===0)return console.log("[PAYMENT] No raw client data available"),[];let P=new Map;for(let y of x)P.set(y.codigo.toLowerCase(),y.nombre);let v=[];if(E){for(let y of k){if(y.codigoOpcion==="personalizado"){v.push({label:"Otro monto",value:-1,field:"personalizado"});continue}let I=y.campoTablaDinamica;if(!I)continue;let K=Object.keys(_).find(Ne=>Ne.toLowerCase()===I.toLowerCase());if(!K)continue;let ae=_[K],oe=typeof ae=="number"?ae:parseFloat(String(ae));if(!isNaN(oe)&&oe>=0){let Ne=P.get(I.toLowerCase())||y.labelOpcion||this.formatFieldLabel(I);v.push({label:Ne,value:oe,field:I,restriccionFecha:y.restriccionFecha||"SIN_RESTRICCION"})}}console.log("[PAYMENT] Amounts from CONFIG (enabled only):",v.length)}else{let y=["id","tenant_id","portfolio_id","sub_portfolio_id","created_at","updated_at"];for(let[I,K]of Object.entries(_)){if(y.includes(I.toLowerCase()))continue;let ae=typeof K=="number"?K:parseFloat(String(K));if(!isNaN(ae)&&ae>0){let oe=P.get(I.toLowerCase())||this.formatFieldLabel(I);v.push({label:oe,value:ae,field:I})}}console.log("[PAYMENT] Amounts FALLBACK (no config, all numeric):",v.length),v.push({label:"Otro monto",value:-1,field:"personalizado"})}return v.sort((y,I)=>y.field==="personalizado"?1:I.field==="personalizado"?-1:I.value-y.value),v}),this.tabs=[{id:"cliente",label:"Cliente",icon:"user"},{id:"historial",label:"Historial",icon:"history"}],this.managementForm={resultadoContacto:"",tipoGestion:"",clasificacionNivel1:"",clasificacionNivel2:"",clasificacionNivel3:"",motivoNoPago:"",metodoPago:"",montoPago:"",fechaCompromiso:"",horaCompromiso:"",ultimos4Tarjeta:"",bancoSeleccionado:"",observaciones:"",notasPrivadas:""},this.selectedClassifications=b([]),this.dynamicFields=b([]),this.dynamicFieldValues=b({}),this.isLoadingDynamicFields=b(!1),this.isLeafClassification=b(!1),this.dynamicFieldsSchema=b(null),this.externalFieldUpdates=b({}),this.activeSchedules=b([]),this.isLoadingSchedules=b(!1),this.showScheduleHelper=b(!1),this.selectedClassification=V(()=>{let _=this.selectedClassifications();if(_.length===0)return null;let k=_[_.length-1];if(!k)return null;let x=this.managementClassifications().find(P=>String(P.id)===String(k));return x&&(console.log("[DEBUG] Selected typification:",x),console.log("[DEBUG] suggestsFullAmount:",x.suggestsFullAmount),console.log("[DEBUG] allowsInstallmentSelection:",x.allowsInstallmentSelection),console.log("[DEBUG] requiresManualAmount:",x.requiresManualAmount)),x||null}),this.isFormValid=V(()=>{if(this.usesHierarchicalClassifications()){let E=this.selectedClassifications();if(E.length===0||!E[E.length-1])return console.log("[isFormValid] \u274C No hay clasificaci\xF3n seleccionada"),!1;let x=E[E.length-1];if(this.managementClassifications().some(y=>y.parentId&&Number(y.parentId)===Number(x)))return console.log("[isFormValid] \u274C A\xFAn hay niveles por seleccionar, lastSelectedId:",x),!1;console.log("[isFormValid] \u2705 Clasificaci\xF3n completa:",E)}else if(!this.managementForm.resultadoContacto)return!1;let _=this.dynamicFieldsSchema(),k=this.dynamicFieldValues();if(console.log("[isFormValid] Schema:",_),console.log("[isFormValid] Dynamic Values:",k),_&&_.fields&&_.fields.length>0){for(let E of _.fields)if(E.required){let x=k[E.id];if(console.log(`[isFormValid] Campo '${E.id}' (required=${E.required}): valor='${x}'`),x==null||x==="")return console.log(`[isFormValid] \u274C Campo requerido '${E.id}' est\xE1 vac\xEDo`),!1;if(E.type==="table"&&(!Array.isArray(x)||x.length===0))return console.log(`[isFormValid] \u274C Tabla '${E.id}' sin filas`),!1}}return console.log("[isFormValid] \u2705 Formulario v\xE1lido!"),!0}),this.hierarchyLevels=V(()=>{let _=this.managementClassifications(),k=this.selectedClassifications(),E=[];console.log("[hierarchyLevels] Total classifications:",_.length),console.log("[hierarchyLevels] Selected:",k);let x=_.filter(P=>P.hierarchyLevel===1||!P.parentId);console.log("[hierarchyLevels] Nivel 1 (roots):",x.length,x.map(P=>`${P.codigo} (ID:${P.id})`)),x.length>0&&E.push(x);for(let P=0;P<k.length;P++){let v=k[P];if(console.log(`[hierarchyLevels] Buscando hijos del nivel ${P+1}, parentId:`,v),v){let y=_.filter(I=>I.parentId&&Number(I.parentId)===Number(v));if(console.log(`[hierarchyLevels] Encontrados ${y.length} hijos:`,y.map(I=>`${I.codigo} (ID:${I.id}, parent:${I.parentId})`)),y.length>0)E.push(y);else{console.log("[hierarchyLevels] No se encontraron hijos, deteniendo b\xFAsqueda");break}}}return console.log("[hierarchyLevels] Total niveles construidos:",E.length),E}),this.scheduleForm={numeroCuotas:"",montoCuota:"",periodicidad:"",fechaPrimeraCuota:"",tipoCronograma:"",montoInicial:"",montoNegociado:"",cuotas:[]},this.customerData=b({id_cliente:"CLI-2025-0087453",nombre_completo:"GARC\xCDA RODRIGUEZ, CARMEN ROSA",tipo_documento:"DNI",numero_documento:"45621378",fecha_nacimiento:"15/03/1985",edad:40,contacto:{telefono_principal:"+51 987 654 321",telefono_alternativo:"+51 945 123 456",telefono_trabajo:"+51 01 4567890",email:"carmen.garcia@email.com",direccion:"Av. Los \xC1lamos 458, Dpto 302, San Borja, Lima"},cuenta:{numero_cuenta:"****5678",tipo_producto:"Pr\xE9stamo Personal",fecha_desembolso:"15/01/2024",monto_original:15e3,plazo_meses:24,tasa_interes:18.5},deuda:{saldo_capital:8750.5,intereses_vencidos:456.78,mora_acumulada:234.5,gastos_cobranza:120,saldo_total:9561.78,dias_mora:45,fecha_ultimo_pago:"15/10/2024",monto_ultimo_pago:458.33}}),this.activePaymentSchedules=b([]),this.selectedInstallmentForCancellation=b(null),this.isCancellationTypification=V(()=>{let _=this.selectedClassification();return _?_.codigo==="CA"||_.label?.toUpperCase().includes("CANCELACION")||_.label?.toUpperCase().includes("CANCELACI\xD3N"):!1}),this.pendingInstallmentsForCancellation=V(()=>{let _=this.activePaymentSchedules(),k=[],E=new Date;E.setHours(0,0,0,0);for(let x of _)if(x.installments)for(let P of x.installments){let v=P.status?.toUpperCase();if(v!=="PAGADA"&&v!=="PAGADO"&&v!=="CUMPLIDO"&&v!=="CANCELADA"&&v!=="CANCELADO"&&v!=="VENCIDA"&&v!=="VENCIDO"){let y=P.dueDate||P.fechaPago;if(y){let I=new Date(y);I.setHours(0,0,0,0),I>=E&&k.push(re(q({},P),{scheduleId:x.id,grupoPromesaUuid:x.grupoPromesaUuid}))}}}return k}),this.overdueInstallments=V(()=>{let _=this.activePaymentSchedules(),k=[],E=new Date;E.setHours(0,0,0,0);for(let x of _)if(x.installments)for(let P of x.installments){let v=P.status?.toUpperCase();if(v==="VENCIDA"||v==="VENCIDO")k.push(re(q({},P),{scheduleId:x.id,grupoPromesaUuid:x.grupoPromesaUuid}));else if(v==="PENDIENTE"){let y=P.dueDate||P.fechaPago;if(y){let I=new Date(y);I.setHours(0,0,0,0),I<E&&k.push(re(q({},P),{scheduleId:x.id,grupoPromesaUuid:x.grupoPromesaUuid}))}}}return k}),this.rawClientData=b({}),this.clientAmountFields=V(()=>{let _=this.rawClientData(),k=this.montoCabeceras(),E=[];if(k.length>0)for(let x of k){let P=x.codigo.toLowerCase(),v=_[P]??_[x.codigo];if(v!=null){let y=typeof v=="number"?v:parseFloat(v);isNaN(y)||E.push({label:x.nombre,value:y,field:P})}}else{let x=["id","id_campana","id_cartera","id_subcartera","prioridad","estado","documento","num_cuenta","num_cuenta_pmcp","numero_cuenta","periodo","edad","dias_mora","dias_mora_asig","telefono_celular","telefono_domicilio","telefono_laboral","telf_referencia_1","telf_referencia_2"];for(let[P,v]of Object.entries(_)){let y=P.toLowerCase();if(y.startsWith("fec_")||y.startsWith("fecha_")||y.startsWith("telefono_")||y.startsWith("telf_")||x.includes(y))continue;let I=typeof v=="number"?v:parseFloat(v);!isNaN(I)&&I>=0&&E.push({label:this.formatFieldLabel(P),value:I,field:P})}}return E.sort((x,P)=>P.value-x.value)}),this.clientDiasMora=V(()=>{let _=this.rawClientData(),k=_.dias_mora||_.dias_mora_asig||0;return typeof k=="number"?k:parseInt(k)||0}),this.montoCabeceras=b([]),this.enabledPaymentOptions=b([]),this.paymentScheduleFieldId=b(null),this.hasPaymentOptionsConfig=b(!1),this.callState=Z.IDLE,this.isMuted=b(!1),this.incomingPhoneNumber=null}ngOnInit(){this.loadTenants(),this.loadManagementHistory();let e=this.sipService.getCallState();console.log("\u{1F4DE} [CollectionManagement] Estado inicial de llamada:",e),e===Z.ACTIVE&&!this.callActive()&&(console.log("\u23F1\uFE0F Llamada ya est\xE1 activa, iniciando timer autom\xE1ticamente..."),this.callActive.set(!0),this.startCall()),this.callStateSubscription=this.sipService.onCallStatus.subscribe(i=>{if(console.log("\u{1F4DE} [CollectionManagement] Estado de llamada:",i),this.callState=i,i===Z.ACTIVE&&!this.callActive()){this.callActive.set(!0),this.startCall();let l=this.authService.getCurrentUser();l?.id&&this.agentService.changeAgentStatus(l.id,{estado:ye.EN_LLAMADA}).subscribe({next:()=>console.log("\u2705 Estado cambiado a EN_LLAMADA"),error:m=>console.error("\u274C Error cambiando estado:",m)})}if((i===Z.ENDED||i===Z.IDLE)&&this.callActive()){this.callActive.set(!1),this.isTipifying.set(!0),this.sipService.blockIncomingCallsMode(!0),console.log("\u{1F6AB} Bloqueando llamadas entrantes - agente en tipificaci\xF3n");let l=this.callDuration();this.callTimer&&(clearInterval(this.callTimer),this.callTimer=void 0),console.log(`\u{1F4DD} Llamada terminada (${l}s), cambiando a TIPIFICANDO`);let m=this.authService.getCurrentUser();m?.id&&this.agentService.changeAgentStatus(m.id,{estado:ye.TIPIFICANDO}).subscribe({next:()=>console.log("\u2705 Estado cambiado a TIPIFICANDO - agente debe completar formulario"),error:g=>console.error("\u274C Error cambiando estado:",g)})}}),this.incomingCallSubscription=this.sipService.onIncomingCall.subscribe(i=>{console.log("\u{1F4F2} [CollectionManagement] Llamada entrante de:",i.from),this.incomingPhoneNumber=i.from,i.from&&this.autoLoadCustomerByPhone(i.from)}),this.route.queryParams.subscribe(i=>{i.source==="manual"&&i.documento&&(console.log("\u{1F4CB} [MANUAL] Cargando cliente desde gesti\xF3n manual:",i),this.loadCustomerByDocumentoFromManual(i.documento,Number(i.tenantId),Number(i.portfolioId),Number(i.subPortfolioId)))}),this.autorizacionService.respuesta$.subscribe(i=>{i&&this.waitingForAuthorization()&&this.handleAuthorizationResponse(i)});let t=this.authService.getCurrentUser();t?.id&&(this.agentStatusSubscription=this.agentStatusService.startStatusPolling(t.id).subscribe({next:i=>{i.colorIndicador&&this.colorIndicador.set(i.colorIndicador),this.excedeTiempoMaximo.set(i.excedeTiempoMaximo||!1)},error:i=>console.error("\u274C Error polling estado del agente:",i)}))}autoLoadCustomerByPhone(e){console.log("\u{1F50D} [AUTO-LOAD] Buscando cliente por tel\xE9fono:",e),this.customerService.searchCustomersAcrossAllTenants("telefono",e).subscribe({next:t=>{t&&t.length>0?(console.log("\u2705 [AUTO-LOAD] Cliente encontrado:",t[0]),this.loadCustomerFromResource(t[0])):console.warn("\u26A0\uFE0F [AUTO-LOAD] No se encontr\xF3 cliente con tel\xE9fono:",e)},error:t=>{console.error("\u274C [AUTO-LOAD] Error buscando cliente:",t)}})}loadCustomerByDocumentoFromManual(e,t,i,l){console.log("\u{1F50D} [MANUAL] Buscando cliente por documento:",e),this.selectedTenantId=t,this.selectedPortfolioId=i,this.selectedSubPortfolioId=l,this.reloadTypifications(),this.loadCustomerOutputConfig(),this.http.get(`${Y.apiUrl}/client-search/find`,{params:{tenantId:t.toString(),portfolioId:i.toString(),subPortfolioId:l.toString(),documento:e}}).pipe(xe(m=>(console.error("\u274C [MANUAL] Error buscando cliente:",m),be(null)))).subscribe({next:m=>{m?(console.log("\u2705 [MANUAL] Cliente encontrado:",m),this.loadCustomerFromDynamicTable(m)):console.warn("\u26A0\uFE0F [MANUAL] Cliente no encontrado")}})}loadCustomerFromDynamicTable(e){this.rawClientData.set(e),console.log("[PAYMENT] Raw client data from ini_* table:",e),this.loadMontoCabeceras(),this.customerData.set({id:e.id||0,id_cliente:e.documento,nombre_completo:e.nombre||e.nombres+" "+(e.apellidos||""),tipo_documento:"DNI",numero_documento:e.documento,fecha_nacimiento:"",edad:0,contacto:{telefono_principal:e.telefono||e.telefono_1||"",telefono_alternativo:e.telefono_2||"",telefono_trabajo:e.telefono_3||"",email:e.email||"",direccion:e.direccion||""},cuenta:{numero_cuenta:e.cuenta||"",tipo_producto:e.producto||"PR\xC9STAMO",fecha_desembolso:"",monto_original:e.monto_original||0,plazo_meses:0,tasa_interes:0},deuda:{saldo_capital:e.deuda_capital||0,intereses_vencidos:0,mora_acumulada:e.deuda_mora||0,gastos_cobranza:0,saldo_total:(e.deuda_capital||0)+(e.deuda_mora||0),dias_mora:e.dias_mora||0,fecha_ultimo_pago:"",monto_ultimo_pago:0}}),this.loadManagementHistory(),e.id&&this.loadActivePaymentSchedules(e.id),console.log("\u2705 [MANUAL] Cliente cargado exitosamente")}loadMontoCabeceras(){if(!this.selectedSubPortfolioId){console.warn("[CABECERAS] No hay subcartera seleccionada");return}console.log("[CABECERAS] Cargando cabeceras de montos para subcartera:",this.selectedSubPortfolioId),this.managementService.getMontoCabeceras(this.selectedSubPortfolioId).pipe(xe(e=>(console.error("[CABECERAS] Error cargando cabeceras:",e),be([])))).subscribe(e=>{console.log("[CABECERAS] Cabeceras cargadas:",e),this.montoCabeceras.set(e.map(t=>({codigo:t.codigo,nombre:t.nombre,tipoDato:t.tipoDato,tipoSql:t.tipoSql})))})}loadTenants(){let e=this.authService.getCurrentUser();console.log("[V2] Usuario actual:",e),e?.tenantId&&e?.portfolioId&&e?.subPortfolioId?(this.selectedTenantId=e.tenantId,this.selectedPortfolioId=e.portfolioId,this.selectedSubPortfolioId=e.subPortfolioId,console.log(`[V2] Usando asignaci\xF3n del usuario: tenant=${this.selectedTenantId}, portfolio=${this.selectedPortfolioId}, subPortfolio=${this.selectedSubPortfolioId}`),this.reloadTypifications(),this.loadCustomerOutputConfig(),this.loadFirstCustomer()):(console.error("[V2] Usuario no tiene asignaci\xF3n completa de tenant/portfolio/subportfolio"),console.error("[V2] Valores recibidos:",{tenantId:e?.tenantId,portfolioId:e?.portfolioId,subPortfolioId:e?.subPortfolioId}))}onTenantChange(){this.selectedPortfolioId=void 0,this.portfolios=[],this.selectedTenantId&&(this.loadPortfolios(),this.reloadTypifications(),this.loadCustomerOutputConfig(),this.loadFirstCustomer())}loadPortfolios(){this.selectedTenantId&&this.classificationService.getPortfoliosByTenant(this.selectedTenantId).subscribe({next:e=>{this.portfolios=e},error:e=>{console.error("Error loading portfolios:",e)}})}onPortfolioChange(){this.reloadTypifications(),this.loadCustomerOutputConfig()}reloadTypifications(){this.selectedTenantId&&this.apiSystemConfigService.setTenantAndPortfolio(this.selectedTenantId,this.selectedPortfolioId,this.selectedSubPortfolioId)}loadCustomerOutputConfig(){this.selectedTenantId&&(console.log("[TEMPORAL] loadCustomerOutputConfig - endpoint no existe, usando campos por defecto"),this.setDefaultOutputFields())}loadFirstCustomer(){let e=this.authService.getCurrentUser();if(!e||!e.sipExtension){console.error("\u274C No se pudo obtener la extensi\xF3n SIP del agente logueado"),this.loadClienteDetalle(475);return}console.log(`\u{1F4CB} Buscando llamada activa del agente con extensi\xF3n SIP ${e.sipExtension}...`),this.http.get(`${Y.gatewayUrl}/autodialer/active-call/extension/${e.sipExtension}`).pipe(xe(t=>(console.warn("\u26A0\uFE0F No hay llamada activa o error consultando:",t),console.log("\u{1F4CB} Usando contacto de prueba 475"),be({contactId:475})))).subscribe({next:t=>{let i=t?.contactId;if(!i){console.warn("\u26A0\uFE0F No se obtuvo contactId de la llamada activa");return}console.log(`\u2705 Llamada activa encontrada, contactId: ${i}`),this.loadClienteDetalle(i)}})}loadClienteDetalle(e){console.log(`\u{1F4CB} Cargando datos del cliente para contacto ${e}...`),this.http.get(`${Y.gatewayUrl}/contacts/${e}/cliente-detalle`).pipe(xe(t=>(console.error("\u274C Error cargando datos del cliente:",t),be(null)))).subscribe({next:t=>{t?(console.log("\u2705 Cliente cargado:",t),this.rawClientData.set(t),console.log("[PAYMENT] Raw client data from detalle:",t),this.loadMontoCabeceras(),this.customerData.set({id:t.idCliente,id_cliente:`CLI-${t.idCliente}`,nombre_completo:t.nombreCompleto||"",tipo_documento:t.tipoDocumento||"DNI",numero_documento:t.documento||"",fecha_nacimiento:t.fechaNacimiento||"",edad:t.edad||0,contacto:{telefono_principal:t.telefonoPrincipal||"",telefono_alternativo:t.telefonoSecundario||"",telefono_trabajo:t.telefonoTrabajo||"",email:t.email||"",direccion:t.direccion||""},cuenta:{numero_cuenta:t.cuenta||"",tipo_producto:t.producto||"",fecha_desembolso:"",monto_original:0,plazo_meses:0,tasa_interes:0},deuda:{saldo_capital:t.deudaCapital||0,intereses_vencidos:0,mora_acumulada:0,gastos_cobranza:0,saldo_total:t.deudaTotal||0,dias_mora:t.diasMora||0,fecha_ultimo_pago:"",monto_ultimo_pago:0}}),console.log("\u2705 Datos del cliente actualizados en la UI"),this.loadActivePaymentSchedules(t.idCliente)):console.log("\u26A0\uFE0F No se pudieron cargar los datos del cliente")}})}loadActivePaymentSchedules(e){console.log(`\u{1F4C5} Cargando cronogramas activos para cliente ${e}...`),this.paymentScheduleService.getActiveSchedulesByCustomer(e).pipe(xe(t=>(console.warn("\u26A0\uFE0F Error cargando cronogramas activos:",t),be([])))).subscribe({next:t=>{if(console.log("\u2705 Registros de promesas cargados:",t),!t||t.length===0){this.activePaymentSchedules.set([]);return}let i=t.map(m=>{let g=m.cuotasPromesa||[];g.sort((D,H)=>(D.numeroCuota||1)-(H.numeroCuota||1));let w=g.reduce((D,H)=>D+(H.monto||0),0),C=g.filter(D=>D.estado!=="PAGADA"&&D.estado!=="PAGADO"&&D.estado!=="CUMPLIDO"&&D.estado!=="CANCELADA"),S=C[0]||g[0];return{id:m.grupoPromesaUuid||m.id,grupoPromesaUuid:m.grupoPromesaUuid,totalAmount:w||m.montoPromesa,numberOfInstallments:m.totalCuotas||g.length,fechaGestion:m.fechaGestion,installments:g.map(D=>({id:D.id,numeroCuota:D.numeroCuota,monto:D.monto,dueDate:D.fechaPago||null,status:D.estado||"PENDIENTE"})),nextDueDate:S?.fechaPago,cuotasPendientes:C.length}}),l=i.filter(m=>m.cuotasPendientes>0);console.log("\u{1F4C5} Cronogramas transformados:",i),console.log("\u{1F4C5} Cronogramas activos (con cuotas pendientes):",l),this.activePaymentSchedules.set(l),l.length>0&&console.log(`\u{1F4C5} \xA1Cliente tiene ${l.length} promesa(s) de pago activa(s)!`)}})}setDefaultOutputFields(){this.customerOutputFields.set([{id:"numero_documento",label:"DNI/Documento",field:"numero_documento",category:"personal",format:"text",highlight:!0,size:"medium"},{id:"nombre_completo",label:"Nombre Completo",field:"nombre_completo",category:"personal",format:"text",highlight:!1,size:"full"},{id:"telefono_principal",label:"Celular",field:"contacto.telefono_principal",category:"contact",format:"text",highlight:!1,size:"medium"},{id:"email",label:"Email",field:"contacto.email",category:"contact",format:"text",highlight:!1,size:"medium"},{id:"direccion",label:"Direcci\xF3n",field:"contacto.direccion",category:"contact",format:"text",highlight:!1,size:"full"}])}loadManagementHistory(){let e=this.customerData()?.id;if(!e){console.log("[HISTORIAL] No hay cliente cargado, omitiendo carga de historial");return}let t=String(e);console.log("[HISTORIAL] Cargando historial para cliente ID:",t),this.managementService.getManagementsByCustomer(t).subscribe({next:i=>{console.log("[HISTORIAL] Gestiones recibidas del backend:",i),console.log("[HISTORIAL] Total de gestiones:",i.length);let l=i.map(m=>{let g=m.managementDate&&m.managementTime?`${m.managementDate} ${m.managementTime}`:new Date().toLocaleString("es-PE"),w={id:m.id,fecha:g,asesor:m.advisorId,resultado:"Gesti\xF3n realizada",gestion:m.level3Name||m.level2Name||m.level1Name||"-",observacion:m.observations||"Sin observaciones",duracion:"00:00:00",hasSchedule:m.typificationRequiresSchedule||!1,schedule:null};return w.hasSchedule&&this.paymentScheduleService.getPaymentScheduleByManagementId(m.id).subscribe({next:C=>{C&&(w.schedule=C)},error:()=>{}}),w});this.historialGestiones.set(l),console.log("[HISTORIAL] Historial establecido en signal:",this.historialGestiones())},error:i=>{console.error("[HISTORIAL] Error al cargar historial de gestiones:",i),console.error("[HISTORIAL] Detalles del error:",{status:i.status,statusText:i.statusText,message:i.message,url:i.url})}})}formatDateTime(e){let t=new Date(e),i=t.getDate().toString().padStart(2,"0"),l=(t.getMonth()+1).toString().padStart(2,"0"),m=t.getFullYear(),g=t.getHours().toString().padStart(2,"0"),w=t.getMinutes().toString().padStart(2,"0");return`${i}/${l}/${m} ${g}:${w}`}calculateCallDuration(e){return e.durationSeconds?this.formatTime(e.durationSeconds):"00:00:00"}calculateCallDurationSeconds(){if(!this.callStartTime)return 0;let e=new Date(this.callStartTime).getTime(),t=new Date().getTime();return Math.floor((t-e)/1e3)}ngOnDestroy(){this.callTimer&&clearInterval(this.callTimer),this.isTipifying()&&(this.isTipifying.set(!1),this.sipService.blockIncomingCallsMode(!1),console.log("\u{1F513} [ngOnDestroy] Desbloqueando llamadas entrantes al salir del componente")),this.callStateSubscription&&this.callStateSubscription.unsubscribe(),this.incomingCallSubscription&&this.incomingCallSubscription.unsubscribe(),this.agentStatusSubscription&&this.agentStatusSubscription.unsubscribe()}cancelarTipificacion(){console.log("\u274C Cancelando tipificaci\xF3n..."),this.isTipifying.set(!1),this.sipService.blockIncomingCallsMode(!1),console.log("\u{1F513} Desbloqueando llamadas entrantes - tipificaci\xF3n cancelada");let t=this.authService.getCurrentUser()?.id||1;this.agentService.changeAgentStatus(t,{estado:ye.DISPONIBLE}).subscribe({next:()=>{console.log("\u2705 Estado cambiado a DISPONIBLE, navegando al dashboard..."),this.router.navigate(["/dashboard"])},error:i=>{console.error("\u274C Error al cambiar estado:",i),this.router.navigate(["/dashboard"])}})}openScheduleDetail(e){this.scheduleManagementId.set(e),this.showScheduleDetail.set(!0)}closeScheduleDetail(){this.showScheduleDetail.set(!1),this.scheduleManagementId.set(null)}onCustomAmountDetected(e){console.log("\u{1F510} [Authorization] Custom amount detected:",e),this.requiresAuthorization.set(e),e||(this.waitingForAuthorization.set(!1),this.currentAuthorizationData=null)}openSupervisorSelectionModal(){console.log("\u{1F4CB} [Authorization] Opening supervisor selection modal");let e=this.dynamicFieldValues(),t=this.dynamicFieldsSchema(),i=null;if(t&&t.fields){let D=t.fields.find(H=>H.type==="payment_schedule");D&&e[D.id]&&(i=e[D.id])}if(!i){alert("\u26A0\uFE0F No hay datos de cronograma de pago para autorizar");return}let l=this.authService.getCurrentUser(),m=this.selectedClassifications(),g=this.managementClassifications(),w=m[m.length-1],C=g.find(D=>D.id.toString()===w),S=l?`${l.firstName||""} ${l.lastName||""}`.trim()||l.username:"Agente";this.currentAuthorizationData={idTenant:this.selectedTenantId,idCartera:this.selectedPortfolioId,idSubcartera:this.selectedSubPortfolioId,idAgenteSolicitante:l?.id||0,nombreAgente:S,idSupervisor:0,idCliente:this.customerData().id||0,nombreCliente:this.customerData().nombre_completo||"",documentoCliente:this.customerData().numero_documento||"",idTipificacion:C?.id?Number(C.id):0,nombreTipificacion:C?.label||"",montoTotal:i.montoTotal,numeroCuotas:i.numeroCuotas,campoMontoOrigen:i.campoMontoOrigen,cuotas:i.cuotas.map(D=>({numeroCuota:D.numeroCuota,monto:D.monto,fechaPago:D.fechaPago})),observacionesAgente:this.managementForm.observaciones||"Solicitud de monto personalizado"},this.showSupervisorModal=!0}onSupervisorSelected(e){if(console.log("\u{1F464} [Authorization] Supervisor selected:",e),this.showSupervisorModal=!1,!this.currentAuthorizationData){console.error("\u274C No authorization data prepared");return}let t=re(q({},this.currentAuthorizationData),{idSupervisor:e.idUsuario});this.autorizacionService.crearSolicitud(t).subscribe({next:i=>{console.log("\u2705 [Authorization] Request created:",i),this.waitingForAuthorization.set(!0),alert(`\u{1F4E4} Solicitud enviada a ${e.nombreCompleto}

Esperando autorizaci\xF3n...`)},error:i=>{console.error("\u274C [Authorization] Error creating request:",i),alert("\u274C Error al enviar la solicitud de autorizaci\xF3n")}})}onSupervisorSelectionCancelled(){console.log("\u274C [Authorization] Supervisor selection cancelled"),this.showSupervisorModal=!1}handleAuthorizationResponse(e){if(console.log("\u{1F4EC} [Authorization] Response received:",e),this.waitingForAuthorization.set(!1),e.estado==="APROBADA")alert(`\u2705 \xA1Autorizaci\xF3n APROBADA!

Guardando gesti\xF3n autom\xE1ticamente...`),this.requiresAuthorization.set(!1),this.saveManagement();else if(e.estado==="RECHAZADA"){let t=e.comentariosSupervisor||"Sin motivo especificado";alert(`\u274C Autorizaci\xF3n RECHAZADA

Motivo: ${t}

Puede modificar los datos y volver a solicitar autorizaci\xF3n.`)}else e.estado==="EXPIRADA"&&alert(`\u23F0 La solicitud de autorizaci\xF3n ha expirado.

Puede volver a solicitarla seleccionando otro supervisor.`)}toggleCall(){this.callActive()?this.endCall():this.startCall()}startCall(){this.callActive.set(!0),this.callDuration.set(0),this.callStartTime=new Date().toISOString(),this.callTimer=window.setInterval(()=>{this.callDuration.update(e=>e+1)},1e3)}endCall(e=!1){console.log("\u{1F4F5} Finalizando llamada..."),this.sipService.hangup(),this.callActive.set(!1),this.callTimer&&(clearInterval(this.callTimer),this.callTimer=void 0),e&&this.router.navigate(["/agent-dashboard"])}formatTime(e){let t=Math.floor(e/3600),i=Math.floor(e%3600/60),l=e%60;return`${t.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}:${l.toString().padStart(2,"0")}`}onContactResultChange(){this.managementForm.tipoGestion="",this.managementForm.motivoNoPago=""}onManagementTypeChange(){}showManagementType(){return this.managementForm.resultadoContacto==="CPC"||this.managementForm.resultadoContacto==="CTT"}usesHierarchicalClassifications(){let e=this.hierarchyLevels();return e.length>0&&e[0].length>0}getTypificationsForLevel(e){return this.hierarchyLevels()[e]||[]}onClassificationLevelChange(e,t){let i=[...this.selectedClassifications()];if(i[e]=t,this.selectedClassifications.set(i.slice(0,e+1)),e===0?(this.managementForm.clasificacionNivel1=t,this.managementForm.clasificacionNivel2="",this.managementForm.clasificacionNivel3=""):e===1?(this.managementForm.clasificacionNivel2=t,this.managementForm.clasificacionNivel3=""):e===2&&(this.managementForm.clasificacionNivel3=t),t){this.managementForm.tipoGestion=t;let l=Number(t);!isNaN(l)&&l>0?this.loadDynamicFields(l):(this.dynamicFields.set([]),this.dynamicFieldValues.set({}),this.isLeafClassification.set(!1))}else{let l=this.selectedClassifications().filter(m=>m).pop();this.managementForm.tipoGestion=l||"",this.dynamicFields.set([]),this.dynamicFieldValues.set({}),this.isLeafClassification.set(!1)}}loadDynamicFields(e){this.isLoadingDynamicFields.set(!0),this.apiSystemConfigService.getClassificationFields(e).subscribe({next:t=>{this.isLeafClassification.set(t.isLeaf),this.dynamicFields.set(t.fields||[]);let l={fields:(t.fields||[]).map((g,w)=>q({id:g.fieldCode,label:g.fieldName,type:g.fieldType.toLowerCase(),required:g.isRequired||!1,placeholder:g.description||"",helpText:g.description,displayOrder:g.displayOrder||0,options:g.options?g.options.map(C=>typeof C=="string"?{value:C,label:C}:{value:C.value||C,label:C.label||C}):void 0,min:g.validationRules?.min,max:g.validationRules?.max,minLength:g.validationRules?.minLength,maxLength:g.validationRules?.maxLength,columns:g.fieldType.toLowerCase()==="table"&&g.columns?g.columns.map(C=>({id:C.id||C.fieldCode,label:C.label||C.fieldName,type:(C.type||C.fieldType).toLowerCase(),required:C.required||C.isRequired||!1,options:C.options?C.options.map(S=>typeof S=="string"?{value:S,label:S}:{value:S.value||S,label:S.label||S}):void 0})):void 0,allowAddRow:g.fieldType.toLowerCase()==="table",allowDeleteRow:g.fieldType.toLowerCase()==="table",minRows:g.minRows||0,maxRows:g.maxRows},g.linkedToField&&{linkedToField:g.linkedToField}))};this.dynamicFieldsSchema.set(l),this.isLoadingDynamicFields.set(!1);let m=(t.fields||[]).find(g=>g.fieldType.toLowerCase()==="payment_schedule");m&&m.id?(this.paymentScheduleFieldId.set(m.id),this.loadEnabledPaymentOptions(m.id)):(this.paymentScheduleFieldId.set(null),this.enabledPaymentOptions.set([]),this.hasPaymentOptionsConfig.set(!1)),this.checkAndLoadPaymentSchedules()},error:t=>{console.error("Error cargando campos din\xE1micos:",t),this.isLoadingDynamicFields.set(!1),this.isLeafClassification.set(!1),this.dynamicFields.set([]),this.dynamicFieldsSchema.set(null)}})}loadEnabledPaymentOptions(e){console.log("[PAYMENT] Loading options for field ID:",e),this.typificationV2Service.getOpcionesCampo(e).subscribe({next:t=>{let i=t&&t.length>0;this.hasPaymentOptionsConfig.set(i);let l=i?t.filter(m=>m.estaHabilitada):[];console.log("[PAYMENT] Options config exists:",i,"| Total:",t?.length||0,"| Enabled:",l.length),this.enabledPaymentOptions.set(l)},error:t=>{console.warn("[PAYMENT] Error loading options, showing all amounts:",t),this.hasPaymentOptionsConfig.set(!1),this.enabledPaymentOptions.set([])}})}checkAndLoadPaymentSchedules(){let e=this.selectedClassifications();if(e.length===0){this.showScheduleHelper.set(!1);return}let t=e[e.length-1],l=this.managementClassifications().find(m=>m.id.toString()===t);l&&l.requiere_pago?(console.log("[SCHEDULE] Payment typification detected:",l.codigo),console.log("[DEBUG-SCHEDULE] Full typification object:",l),console.log("[DEBUG-SCHEDULE] suggestsFullAmount:",l.suggestsFullAmount),console.log("[DEBUG-SCHEDULE] allowsInstallmentSelection:",l.allowsInstallmentSelection),console.log("[DEBUG-SCHEDULE] requiresManualAmount:",l.requiresManualAmount),this.loadActiveSchedules()):(this.showScheduleHelper.set(!1),this.activeSchedules.set([]))}loadActiveSchedules(){let e=String(this.customerData().id);console.log("[SCHEDULE] Loading active schedules for customer ID:",e),this.isLoadingSchedules.set(!0),this.managementService.getActiveSchedulesByCustomer(e).subscribe({next:t=>{console.log("[SCHEDULE] Active schedules loaded:",t),this.activeSchedules.set(t),this.showScheduleHelper.set(t.length>0),this.isLoadingSchedules.set(!1),t.length>0&&this.suggestPaymentAmount(t[0])},error:t=>{console.error("[SCHEDULE] Error loading schedules:",t),this.isLoadingSchedules.set(!1),this.showScheduleHelper.set(!1)}})}suggestPaymentAmount(e){if(!e.installments||e.installments.length===0)return;let t=e.installments.filter(i=>i.status.status==="PENDING").sort((i,l)=>new Date(i.dueDate).getTime()-new Date(l.dueDate).getTime())[0];if(t){console.log("[SCHEDULE] Suggested payment amount:",t.amount),this.managementForm.montoPago||(this.managementForm.montoPago=t.amount.toFixed(2));let i=q({},this.dynamicFieldValues());i.monto_pagado||(i.monto_pagado=t.amount,this.dynamicFieldValues.set(i))}}applyFullSchedulePayment(){let e=this.activeSchedules();if(e.length===0)return;let t=e[0],i=this.calculatePendingAmount(t);console.log("[BUTTON] Pagar Todo clicked. Amount:",i);let l=this.dynamicFieldsSchema(),m=l?.fields.find(g=>g.type==="currency"||g.id.toLowerCase().includes("monto"));if(m){console.log("[BUTTON] Found monto field:",m.id);let g={};if(g[m.id]=i,l?.fields.some(C=>C.id==="saldo_pendiente")){g.saldo_pendiente=0,console.log("[BUTTON] Saldo pendiente ser\xE1 0 (pago total)");let C=q({},this.dynamicFieldValues());C[m.id]=i,C.saldo_pendiente=0,this.dynamicFieldValues.set(C)}this.externalFieldUpdates.set(g),console.log("[BUTTON] Updated externalFieldUpdates:",g),setTimeout(()=>this.externalFieldUpdates.set({}),100)}else console.warn("[BUTTON] No se encontr\xF3 campo de monto en el schema")}applyNextInstallmentPayment(){console.log("[BUTTON-PP] Usar Pr\xF3xima Cuota clicked!");let e=this.activeSchedules();if(console.log("[BUTTON-PP] Active schedules:",e),e.length===0){console.warn("[BUTTON-PP] No schedules found");return}let t=e[0];console.log("[BUTTON-PP] Using schedule:",t),console.log("[BUTTON-PP] Schedule installments:",t.installments);let i=t.installments.filter(m=>(console.log("[BUTTON-PP] Checking installment:",m,"Status:",m.status?.status),m.status.status==="PENDING"));console.log("[BUTTON-PP] Pending installments:",i);let l=i.sort((m,g)=>new Date(m.dueDate).getTime()-new Date(g.dueDate).getTime())[0];if(console.log("[BUTTON-PP] Next pending installment:",l),l){console.log("[BUTTON-PP] Usar Pr\xF3xima Cuota - Amount:",l.amount);let m=this.dynamicFieldsSchema(),g=m?.fields.find(w=>w.type==="currency"||w.id.toLowerCase().includes("monto"));if(g){console.log("[BUTTON-PP] Found monto field:",g.id);let w={};if(w[g.id]=l.amount,m?.fields.some(S=>S.id==="saldo_pendiente")){let S=this.calculatePendingAmount(t),D=Math.max(0,S-l.amount);w.saldo_pendiente=D,console.log("[BUTTON-PP] Saldo pendiente calculado:",D,"= Total",S,"- Monto",l.amount);let H=q({},this.dynamicFieldValues());H[g.id]=l.amount,H.saldo_pendiente=D,this.dynamicFieldValues.set(H)}this.externalFieldUpdates.set(w),console.log("[BUTTON-PP] Updated externalFieldUpdates:",w),setTimeout(()=>this.externalFieldUpdates.set({}),100)}else console.warn("[BUTTON-PP] No se encontr\xF3 campo de monto en el schema")}else console.warn("[BUTTON-PP] No pending installment found")}calculatePendingAmount(e){console.log("[CALC] Schedule:",e),console.log("[CALC] Installments:",e.installments);let t=e.installments.filter(l=>(console.log("[CALC] Installment status:",l.status,"Status value:",l.status?.status),l.status.status==="PENDING"));console.log("[CALC] Pending installments:",t);let i=t.reduce((l,m)=>l+m.amount,0);return console.log("[CALC] Total pending amount:",i),i}getPendingInstallments(e){return e.installments?e.installments.filter(t=>t.status.status==="PENDING").sort((t,i)=>new Date(t.dueDate).getTime()-new Date(i.dueDate).getTime()):[]}onDynamicFieldsChange(e){this.dynamicFieldValues.set(e),e.monto_pagado!==void 0&&e.monto_pagado!==null&&this.calculateAndUpdatePendingBalance(e.monto_pagado)}calculateAndUpdatePendingBalance(e){let t=this.activeSchedules();if(t.length===0){console.log("[SALDO] No hay cronogramas activos");return}let i=t[0],l=this.calculatePendingAmount(i),m=Math.max(0,l-(e||0));if(console.log("[SALDO] Total pendiente:",l),console.log("[SALDO] Monto pagado:",e),console.log("[SALDO] Saldo pendiente calculado:",m),this.dynamicFieldsSchema()?.fields.some(C=>C.id==="saldo_pendiente")){console.log("[SALDO] Actualizando campo saldo_pendiente con:",m);let C={saldo_pendiente:m};this.externalFieldUpdates.set(C);let S=q({},this.dynamicFieldValues());S.saldo_pendiente=m,this.dynamicFieldValues.set(S),setTimeout(()=>this.externalFieldUpdates.set({}),100)}}getDynamicLevelLabel(e){if(e===0){let m=this.hierarchyLevels()[0]||[];if(m.length===0)return"Nivel 1";let g=m.map(w=>w.codigo);return g.includes("RP")||g.includes("CSA")?"Tipo de Resultado":"Categor\xEDa Principal"}let t=e-1,i=this.selectedClassifications()[t];if(!i)return`Nivel ${e+1}`;let l=this.managementClassifications().find(m=>m.id==i);return l?e===1?{RP:"Intenci\xF3n de Pago",CSA:"Motivo de No Atenci\xF3n",SC:"Raz\xF3n de No Contacto",GA:"Tipo de Gesti\xF3n"}[l.codigo]||`Detalle de ${l.label}`:`Detalle de ${l.label}`:`Nivel ${e+1}`}shouldShowLevel(e){if(e===0)return this.usesHierarchicalClassifications();let t=e-1;return this.selectedClassifications()[t]?this.getTypificationsForLevel(e).length>0:!1}formatFieldLabel(e){let t={deuda_total:"Deuda Total",saldo_total:"Saldo Total",saldo_capital:"Saldo Capital",capital:"Capital",deuda_capital:"Deuda Capital",intereses:"Intereses",intereses_vencidos:"Intereses Vencidos",mora:"Mora",mora_acumulada:"Mora Acumulada",deuda_mora:"Deuda Mora",gastos:"Gastos",gastos_cobranza:"Gastos Cobranza",monto_original:"Monto Original",monto_desembolso:"Monto Desembolso",saldo_vencido:"Saldo Vencido",cuota_vencida:"Cuota Vencida",cuotas_vencidas:"Cuotas Vencidas",monto_cuota:"Monto Cuota",dias_mora:"D\xEDas Mora",monto_minimo:"Monto M\xEDnimo",monto_total:"Monto Total",deuda:"Deuda",saldo:"Saldo"},i=e.toLowerCase();return t[i]?t[i]:e.split("_").map(l=>l.charAt(0).toUpperCase()+l.slice(1).toLowerCase()).join(" ")}formatCurrency(e){return new Intl.NumberFormat("es-PE",{style:"currency",currency:"PEN"}).format(e)}getPrimaryAmountLabel(){let e=this.clientAmountFields();return e.length>0?e.find(i=>i.label.toLowerCase().includes("total")||i.field.toLowerCase().includes("total"))?.label||e[0].label:"Deuda Total"}getPrimaryAmountValue(){let e=this.clientAmountFields();return e.length>0?e.find(i=>i.label.toLowerCase().includes("total")||i.field.toLowerCase().includes("total"))?.value||e[0].value:this.customerData().deuda?.saldo_total||0}getAmountRowClass(e){let t=["bg-red-50 dark:bg-red-950/30 text-red-700 dark:text-red-300","bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200"];return t[e%t.length]}showPaymentSection(){return this.managementClassifications().find(t=>t.id===this.managementForm.tipoGestion)?.requiere_pago||!1}showScheduleSection(){return this.managementClassifications().find(t=>t.id===this.managementForm.tipoGestion)?.requiere_cronograma||!1}onInstallmentCountChange(){let e=parseInt(this.scheduleForm.numeroCuotas);if(isNaN(e)||e<1){this.scheduleForm.cuotas=[];return}let t=this.scheduleForm.cuotas.length;if(e>t)for(let i=t+1;i<=e;i++)this.scheduleForm.cuotas.push({numero:i,monto:"",fechaVencimiento:""});else e<t&&(this.scheduleForm.cuotas=this.scheduleForm.cuotas.slice(0,e),this.scheduleForm.cuotas.forEach((i,l)=>{i.numero=l+1}))}generateSchedule(){let e=parseInt(this.scheduleForm.numeroCuotas);if(isNaN(e)||e<1){alert("Por favor ingrese un n\xFAmero v\xE1lido de cuotas");return}this.scheduleForm.cuotas=[];for(let t=1;t<=e;t++)this.scheduleForm.cuotas.push({numero:t,monto:"",fechaVencimiento:""})}addInstallmentRow(){let e=this.scheduleForm.cuotas.length+1;this.scheduleForm.cuotas.push({numero:e,monto:"",fechaVencimiento:""}),this.scheduleForm.numeroCuotas=e.toString()}removeInstallmentRow(e){this.scheduleForm.cuotas.length>1&&(this.scheduleForm.cuotas.splice(e,1),this.scheduleForm.cuotas.forEach((t,i)=>{t.numero=i+1}),this.scheduleForm.numeroCuotas=this.scheduleForm.cuotas.length.toString())}getTodayDate(){let e=new Date,t=e.getFullYear(),i=String(e.getMonth()+1).padStart(2,"0"),l=String(e.getDate()).padStart(2,"0");return`${t}-${i}-${l}`}loadMontoNegociadoFromOutput(e){let t=this.customerOutputFields().find(m=>m.id===e);if(!t)return;let i=t.field.split("."),l=this.customerData();for(let m of i)if(l&&typeof l=="object")l=l[m];else{l=null;break}l&&(this.scheduleForm.montoNegociado=l.toString())}toggleScheduleDetail(){this.showScheduleDetail.update(e=>!e)}saveManagement(){if(!this.validateForm())return;this.saving.set(!0);let e,t;if(this.usesHierarchicalClassifications()){let A=this.selectedClassifications(),J=this.managementClassifications(),X=A[A.length-1];if(t=J.find(G=>G.id.toString()===X),t?.parentId){let G=t.parentId;e=J.find(_=>_.id.toString()===G.toString())}else e=t}else e=this.contactClassifications().find(A=>A.id===this.managementForm.resultadoContacto),t=this.managementClassifications().find(A=>A.id===this.managementForm.tipoGestion);let i=this.selectedClassifications(),l=Number(i[0]),m=i[1]?Number(i[1]):null,g=i[2]?Number(i[2]):null,w=this.managementClassifications(),C=w.find(A=>A.id.toString()===i[0]),S=i[1]?w.find(A=>A.id.toString()===i[1]):null,D=i[2]?w.find(A=>A.id.toString()===i[2]):null,H=this.dynamicFieldValues(),ue=this.dynamicFieldsSchema(),Q=null;if(console.log("[SAVE] === DEBUG PAYMENT SCHEDULE ==="),console.log("[SAVE] dynamicValues:",H),console.log("[SAVE] schema:",ue),console.log("[SAVE] schema.fields:",ue?.fields),ue&&ue.fields){let A=ue.fields.find(J=>J.type==="payment_schedule");console.log("[SAVE] paymentScheduleField found:",A),A&&(console.log("[SAVE] Looking for field id:",A.id),console.log("[SAVE] Value in dynamicValues:",H[A.id])),A&&H[A.id]&&(Q=H[A.id],console.log("[SAVE] Payment schedule detected:",Q))}if(console.log("[SAVE] Final paymentScheduleData:",Q),Q&&Q.cuotas&&Q.cuotas.length>0&&this.activePaymentSchedules().some(X=>X.cuotasPendientes>0)){this.saving.set(!1),alert(`\u26A0\uFE0F No puede registrar una nueva Promesa de Pago.

El cliente ya tiene una promesa de pago activa con cuotas pendientes.

Debe esperar a que se completen o cancelen las cuotas pendientes antes de registrar una nueva promesa.`);return}if(Q&&Q.cuotas&&Q.cuotas.length>0){let A=g||m||l,J=this.callActive()||!!this.callStartTime,X={idCliente:this.customerData().id||0,idAgente:1,idTenant:this.selectedTenantId,idCartera:this.selectedPortfolioId||1,idSubcartera:1,idTipificacion:A,observaciones:this.managementForm.observaciones,metodoContacto:J?"LLAMADA_SALIENTE":"GESTION_MANUAL",campoMontoOrigen:Q.campoMontoOrigen,schedule:{montoTotal:Q.montoTotal,numeroCuotas:Q.numeroCuotas,cuotas:Q.cuotas.map(G=>({numeroCuota:G.numeroCuota,monto:G.monto,fechaPago:G.fechaPago}))}};console.log("[SAVE] Creating payment schedule with request:",X),this.managementService.createPaymentSchedule(X).subscribe({next:G=>{console.log("[SAVE] Payment schedule created successfully:",G),this.onSaveSuccess(e?.label||"",t?.label||"-")},error:G=>{console.error("Error al guardar cronograma de pago:",G),this.saving.set(!1),alert("\u26A0\uFE0F Error al guardar el cronograma de pago. Por favor intente nuevamente.")}})}else{let A=this.callActive()||!!this.callStartTime,J=this.authService.getCurrentUser(),X={customerId:String(this.customerData().id),customerName:this.customerData().nombre_completo||"",customerDocument:this.customerData().numero_documento||"",advisorId:"ADV-001",tenantId:this.selectedTenantId,portfolioId:this.selectedPortfolioId||1,subPortfolioId:1,phone:this.customerData().contacto?.telefono_principal||"",level1Id:l,level1Name:C?.label||"",level2Id:m,level2Name:S?.label||null,level3Id:g,level3Name:D?.label||null,observations:this.managementForm.observaciones,metodoContacto:A?"LLAMADA_SALIENTE":"GESTION_MANUAL",canalContacto:A?"TELEFONO":"SISTEMA",idCampana:null,idLlamada:null,duracionSegundos:A&&this.callStartTime?this.calculateCallDurationSeconds():null,nombreAgente:J?.username||J?.firstName||"Sistema",userAgent:navigator.userAgent};this.managementService.createManagement(X).subscribe({next:G=>{this.callStartTime&&this.callActive()&&this.registerCallToBackend(G.id);let _=this.selectedInstallmentForCancellation();if(this.isCancellationTypification()&&_&&_.id){console.log("\u{1F4B0} Cancelando cuota (marcando como PAGADA):",_);let k=new Date().toISOString().split("T")[0];this.managementService.cancelarCuota(_.id,_.monto,k,this.managementForm.observaciones||void 0).subscribe({next:E=>{console.log("\u2705 Cuota cancelada exitosamente:",E),this.selectedInstallmentForCancellation.set(null);let x=this.customerData().id;x&&this.loadActivePaymentSchedules(x),this.onSaveSuccess(e?.label||"",t?.label||"-")},error:E=>{console.error("\u26A0\uFE0F Error cancelando cuota:",E),(E.error?.error||E.error?.mensaje)&&alert(`\u26A0\uFE0F ${E.error.mensaje||"No se puede cancelar esta cuota. La fecha de pago ya pas\xF3."}`),this.selectedInstallmentForCancellation.set(null),this.onSaveSuccess(e?.label||"",t?.label||"-")}})}else this.onSaveSuccess(e?.label||"",t?.label||"-")},error:G=>{console.error("Error al guardar gesti\xF3n:",G),this.saving.set(!1),alert("\u26A0\uFE0F Error al guardar la gesti\xF3n. Por favor intente nuevamente.")}})}}registerCallToBackend(e){if(!this.callStartTime)return;let t={phoneNumber:this.customerData().contacto.telefono_principal,startTime:this.callStartTime};this.managementService.startCall(e,t).subscribe({next:i=>{if(!this.callActive()){let l={endTime:new Date().toISOString()};this.managementService.endCall(e,l).subscribe({next:()=>{},error:m=>console.error("Error al finalizar llamada:",m)})}},error:i=>{console.error("Error al registrar llamada:",i)}})}registerPaymentToBackend(e){if(!this.managementForm.montoPago||!this.managementForm.metodoPago)return;let t={amount:parseFloat(this.managementForm.montoPago),scheduledDate:new Date().toISOString().split("T")[0],paymentMethodType:this.managementForm.metodoPago,paymentMethodDetails:this.managementForm.ultimos4Tarjeta||void 0,voucherNumber:void 0,bankName:this.managementForm.bancoSeleccionado||void 0};this.managementService.registerPayment(e,t).subscribe({next:i=>{},error:i=>{console.error("Error al registrar pago:",i)}})}createScheduleToBackend(e){if(this.scheduleForm.cuotas.length===0)return;if(this.scheduleForm.cuotas.some(l=>!l.monto||!l.fechaVencimiento)){alert("\u26A0\uFE0F Por favor complete todos los montos y fechas de las cuotas");return}let i={customerId:String(this.customerData().id),managementId:e,scheduleType:this.scheduleForm.tipoCronograma,negotiatedAmount:this.scheduleForm.montoNegociado?parseFloat(this.scheduleForm.montoNegociado):null,installments:this.scheduleForm.cuotas.map(l=>({installmentNumber:l.numero,amount:parseFloat(l.monto),dueDate:l.fechaVencimiento}))};this.paymentScheduleService.createPaymentSchedule(i).subscribe({next:l=>{},error:l=>{console.error("Error al crear cronograma:",l),alert("\u26A0\uFE0F Error al crear el cronograma de pagos")}})}onSaveSuccess(e,t){this.saving.set(!1),this.showSuccess.set(!0),this.endCall(!1),this.loadManagementHistory(),this.managementForm={resultadoContacto:"",tipoGestion:"",clasificacionNivel1:"",clasificacionNivel2:"",clasificacionNivel3:"",motivoNoPago:"",metodoPago:"",montoPago:"",fechaCompromiso:"",horaCompromiso:"",ultimos4Tarjeta:"",bancoSeleccionado:"",observaciones:"",notasPrivadas:""},this.callDuration.set(0),this.callStartTime=void 0,this.activeTab.set("historial"),console.log("\u2705 Gesti\xF3n guardada, cambiando estado a DISPONIBLE..."),this.isTipifying.set(!1),this.sipService.blockIncomingCallsMode(!1),console.log("\u2705 Desbloqueando llamadas entrantes - tipificaci\xF3n completada");let l=this.authService.getCurrentUser()?.id||1;this.agentService.changeAgentStatus(l,{estado:ye.DISPONIBLE}).subscribe({next:()=>{console.log("\u2705 Estado cambiado a DISPONIBLE"),setTimeout(()=>{this.showSuccess.set(!1),console.log("\u{1F504} Navegando a /agent-dashboard..."),this.router.navigate(["/agent-dashboard"])},2e3)},error:m=>{console.error("\u274C Error cambiando estado:",m),setTimeout(()=>{this.showSuccess.set(!1),this.router.navigate(["/agent-dashboard"])},2e3)}})}validateForm(){let e={};if(this.usesHierarchicalClassifications()){let i=this.selectedClassifications();if(i.length===0||!i[i.length-1])e.typification="Debe seleccionar una clasificaci\xF3n";else{let l=i[i.length-1];this.managementClassifications().some(w=>w.parentId&&Number(w.parentId)===Number(l))&&(e.typification="Debe completar todos los niveles de clasificaci\xF3n")}}else this.managementForm.resultadoContacto||(e.resultadoContacto="Requerido"),this.showManagementType()&&!this.managementForm.tipoGestion&&(e.tipoGestion="Requerido");let t=this.dynamicFieldsSchema();if(t&&t.fields&&t.fields.length>0){let i=this.dynamicFieldValues();for(let l of t.fields)if(l.required){let m=i[l.id];(m==null||m==="")&&(e[`dynamic_${l.id}`]=`${l.label} es requerido`),l.type==="table"&&(!Array.isArray(m)||m.length===0)&&(e[`dynamic_${l.id}`]=`${l.label} debe tener al menos una fila`)}}return this.errors.set(e),Object.keys(e).length>0?(alert("Por favor complete todos los campos requeridos"),!1):!0}calculateRemaining(){if(!this.managementForm.montoPago)return"0.00";let e=parseFloat(this.managementForm.montoPago);return(this.customerData().deuda.saldo_total-e).toFixed(2)}toggleDarkMode(){this.themeService.toggleTheme()}getFieldValue(e){let t=this.customerData();return t?e.split(".").reduce((i,l)=>i?.[l],t):null}formatFieldValue(e,t){if(e==null||e==="")return"-";switch(t){case"currency":return"S/ "+Number(e).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",");case"number":return String(e);case"date":return typeof e=="string"?new Date(e).toLocaleDateString("es-PE"):String(e);default:return String(e)}}formatDate(e){if(!e)return"-";try{return(typeof e=="string"?new Date(e):e).toLocaleDateString("es-PE",{day:"2-digit",month:"2-digit",year:"numeric"})}catch{return String(e)}}showPaymentScheduleDetail(e){console.log("\u{1F4C5} Detalle de promesa de pago:",e);let t=`PROMESA DE PAGO

`;if(t+=`Monto Total: S/ ${e.totalAmount?.toFixed(2)||"0.00"}
`,t+=`N\xFAmero de Cuotas: ${e.numberOfInstallments}

`,t+=`DETALLE DE CUOTAS:
`,e.installments&&e.installments.length>0)for(let i of e.installments){let l=i.dueDate?this.formatDate(i.dueDate):"-",m="\u23F3 Pendiente";i.status==="PAGADA"||i.status==="PAGADO"||i.status==="CUMPLIDO"?m="\u2705 PAGADA":i.status==="VENCIDA"||i.status==="VENCIDO"?m="\u26A0\uFE0F VENCIDA":(i.status==="CANCELADA"||i.status==="CANCELADO")&&(m="\u2717 CANCELADA"),t+=`  Cuota ${i.numeroCuota}: S/ ${i.monto?.toFixed(2)||"0.00"} - ${l} - ${m}
`}alert(t)}getContactClassificationLabel(e){let t=this.contactClassifications().find(l=>l.id===e);if(!t)return e;let i=t.label||t.codigo;return`[${t.codigo}] ${i}`}getManagementClassificationLabel(e){let t=this.managementClassifications().find(l=>l.id===e);if(!t)return e;let i=t.label||t.codigo;return`[${t.codigo}] ${i}`}getTableRows(e){let t=this.dynamicFieldValues()[e];return Array.isArray(t)?t:[]}addTableRow(e,t){if(!Array.isArray(t)){console.error("addTableRow: columns no es un array v\xE1lido",t);return}let i=q({},this.dynamicFieldValues());Array.isArray(i[e])||(i[e]=[]);let l=this.createEmptyTableRow(t);i[e].push(l),this.dynamicFieldValues.set(i)}removeTableRow(e,t){let i=q({},this.dynamicFieldValues());Array.isArray(i[e])&&(i[e].splice(t,1),this.dynamicFieldValues.set(i))}createEmptyTableRow(e){let t={};return e.forEach(i=>{i.type==="auto-number"?t[i.id]=null:i.type==="number"||i.type==="currency"?t[i.id]=i.defaultValue||0:(i.type,t[i.id]=i.defaultValue||"")}),t}searchByTestDocument(){if(!this.testDocument.trim()||!this.selectedTenantId){console.warn("[TEST] Documento vac\xEDo o tenant no seleccionado");return}console.log("[TEST] Buscando cliente por documento:",this.testDocument),this.customerService.searchCustomersByCriteria(this.selectedTenantId,"documento",this.testDocument).subscribe({next:e=>{e&&e.length>0?(console.log("[TEST] Cliente encontrado:",e[0]),this.loadCustomerFromResource(e[0])):(console.warn("[TEST] No se encontr\xF3 cliente con documento:",this.testDocument),alert("No se encontr\xF3 cliente con el documento: "+this.testDocument))},error:e=>{console.error("[TEST] Error buscando cliente:",e),alert("Error buscando cliente")}})}searchByTestPhone(){if(!this.testPhone.trim()||!this.selectedTenantId){console.warn("[TEST] Tel\xE9fono vac\xEDo o tenant no seleccionado");return}console.log("[TEST] Buscando cliente por tel\xE9fono:",this.testPhone),this.customerService.searchCustomersByCriteria(this.selectedTenantId,"telefono",this.testPhone).subscribe({next:e=>{e&&e.length>0?(console.log("[TEST] Cliente encontrado:",e[0]),this.loadCustomerFromResource(e[0])):(console.warn("[TEST] No se encontr\xF3 cliente con tel\xE9fono:",this.testPhone),alert("No se encontr\xF3 cliente con el tel\xE9fono: "+this.testPhone))},error:e=>{console.error("[TEST] Error buscando cliente:",e),alert("Error buscando cliente")}})}loadCustomerFromResource(e){console.log("[TEST] Cargando cliente:",e),this.rawClientData.set(e),console.log("[PAYMENT] Raw client data from resource:",e),this.loadMontoCabeceras(),this.customerData.set({id:e.id,id_cliente:e.documentNumber||e.identificationCode,nombre_completo:e.fullName||"",tipo_documento:e.documentType||"DNI",numero_documento:e.documentNumber||"",fecha_nacimiento:e.birthDate||"",edad:e.age||null,contacto:{telefono_principal:e.contactMethods?.find(t=>t.subtype==="telefono_principal")?.value||"",telefono_alternativo:e.contactMethods?.find(t=>t.subtype==="telefono_secundario")?.value||"",telefono_trabajo:e.contactMethods?.find(t=>t.subtype==="telefono_trabajo")?.value||"",email:e.contactMethods?.find(t=>t.contactType==="email")?.value||"",direccion:e.address||""},cuenta:{numero_cuenta:e.accountNumber||"",tipo_producto:"PR\xC9STAMO",fecha_desembolso:"2024-01-15",monto_original:e.principalAmount||0,plazo_meses:12,tasa_interes:2.5},deuda:{saldo_capital:e.principalAmount||0,intereses_vencidos:0,mora_acumulada:e.overdueAmount||0,gastos_cobranza:0,saldo_total:(e.principalAmount||0)+(e.overdueAmount||0),dias_mora:e.overdueDays||0,fecha_ultimo_pago:"",monto_ultimo_pago:0}}),this.loadManagementHistory(),e.id&&this.loadActivePaymentSchedules(e.id),console.log("[TEST] Cliente cargado exitosamente")}hangupCall(){console.log("\u{1F4F5} Colgando llamada..."),this.sipService.hangup()}toggleMute(){this.isMuted()?(console.log("\u{1F50A} Desmuteando..."),this.sipService.unmute(),this.isMuted.set(!1)):(console.log("\u{1F507} Muteando..."),this.sipService.mute(),this.isMuted.set(!0))}isInActiveCall(){return this.callState===Z.ACTIVE}getCallStateText(){switch(this.callState){case Z.IDLE:return"LISTO";case Z.CONNECTING:return"CONECTANDO...";case Z.RINGING:return"TIMBRANDO...";case Z.ACTIVE:return"EN LLAMADA";case Z.ENDED:return"FINALIZADA";default:return"DESCONOCIDO"}}};d.\u0275fac=function(t){return new(t||d)(N(pt),N(ht),N(Se),N(nt),N(lt),N(st),N(Fe),N(ft),N(bt),N(qe),N(Ge),N(ne),N(it),N(tt),N(ot),N(Ye),N(ke))},d.\u0275cmp=se({type:d,selectors:[["app-collection-management"]],viewQuery:function(t,i){if(t&1&&De(Qt,5),t&2){let l;Ie(l=Te())&&(i.dynamicFieldRenderer=l.first)}},decls:92,vars:43,consts:[["dynamicFieldRendererComponent",""],[1,"collection-management-container","h-[100dvh]","flex","flex-col","overflow-hidden"],[1,"fixed","top-4","right-4","z-50","animate-[slideInRight_0.5s_ease-out]"],[1,"bg-gradient-to-r","from-blue-600","via-blue-700","to-blue-600","dark:from-slate-950","dark:via-blue-950","dark:to-slate-950","text-white","shadow-md","relative","overflow-hidden"],[1,"relative","px-4","py-2"],[1,"flex","items-center","justify-between"],[1,"flex","items-center","gap-4"],[1,"flex","items-center","gap-2"],[1,"w-8","h-8","bg-blue-500/30","dark:bg-blue-600/30","rounded-lg","flex","items-center","justify-center"],["name","clipboard-list",1,"text-white",3,"size"],[1,"text-base","font-bold"],[1,"h-6","w-px","bg-white/20"],[1,"text-blue-200","dark:text-blue-300","text-[10px]"],[1,"font-semibold","text-white","text-sm"],[1,"text-right"],[3,"color","excedido","size"],[1,"flex-1","flex","overflow-hidden"],[1,"w-72","bg-white","dark:bg-slate-900","border-r","border-slate-200","dark:border-slate-800","shadow-lg","overflow-hidden","flex","flex-col","transition-colors","duration-300"],[1,"flex","border-b","border-slate-200","dark:border-slate-800","bg-slate-50","dark:bg-slate-950"],[3,"class"],[1,"flex-1","overflow-y-auto","p-2"],[1,"space-y-2"],[1,"space-y-1"],[1,"flex-1","overflow-y-auto","bg-gradient-to-br","from-gray-50","via-slate-50","to-blue-50","dark:from-slate-900","dark:via-gray-900","dark:to-slate-900","transition-colors","duration-300"],[1,"p-3","space-y-2"],[1,"font-bold","text-gray-800","dark:text-white","flex","items-center","gap-2","text-xs"],[1,"flex","gap-2"],[3,"click","disabled"],[1,"px-4","py-1.5","bg-gradient-to-r","from-red-600","to-red-700","hover:from-red-700","hover:to-red-800","disabled:from-gray-400","disabled:to-gray-500","text-white","dark:text-white","disabled:text-gray-200","rounded-lg","font-bold","flex","items-center","gap-2","transition-all","duration-300","text-xs","shadow-md","hover:shadow-lg",3,"click","disabled"],[1,"bg-white","dark:bg-gray-800","rounded-lg","shadow-md","border","border-gray-200","dark:border-gray-700","p-2","hover:border-blue-300","dark:hover:border-blue-600","transition-colors","duration-300"],[1,"animate-[slideInDown_0.3s_ease-out]"],[1,"bg-white","dark:bg-gray-800","rounded-lg","shadow-md","border","border-gray-200","dark:border-gray-700","p-3"],[1,"bg-indigo-50","dark:bg-indigo-950/20","border","border-indigo-200","dark:border-indigo-900/50","rounded-lg","shadow-md","p-3"],[1,"bg-gray-50","dark:bg-gray-900/20","border","border-gray-200","dark:border-gray-700","rounded-lg","shadow-md","p-3"],[3,"schema","externalUpdates","selectedClassification","customerAmounts"],[1,"bg-purple-50","dark:bg-purple-950/20","border","border-purple-200","dark:border-purple-900/50","rounded-lg","shadow-md","p-3","animate-pulse"],[1,"bg-gradient-to-r","from-purple-50","to-indigo-50","dark:from-purple-950/30","dark:to-indigo-950/30","border-2","border-purple-300","dark:border-purple-700","rounded-lg","shadow-lg","p-3","space-y-2"],[1,"bg-gradient-to-br","from-green-50","to-emerald-50","dark:from-green-950/30","dark:to-emerald-950/30","border","border-green-200","dark:border-green-800","rounded-lg","p-3","space-y-2"],[1,"flex","gap-2","pt-2"],[1,"flex-1","bg-gradient-to-r","from-amber-500","to-orange-600","hover:from-amber-600","hover:to-orange-700","disabled:from-gray-400","disabled:to-gray-500","text-white","dark:text-white","disabled:text-gray-200","py-2","px-4","rounded-lg","font-bold","text-xs","flex","items-center","justify-center","gap-2","transition-all","duration-300","shadow-lg","hover:shadow-xl","disabled:cursor-not-allowed",3,"disabled"],[1,"flex-1","bg-gradient-to-r","from-blue-600","to-blue-700","hover:from-blue-700","hover:to-blue-800","disabled:from-gray-400","disabled:to-gray-500","text-white","dark:text-white","disabled:text-gray-200","py-2","px-4","rounded-lg","font-bold","text-xs","flex","items-center","justify-center","gap-2","transition-all","duration-300","shadow-lg","hover:shadow-xl","disabled:cursor-not-allowed",3,"disabled","title"],[1,"px-6","bg-gradient-to-r","from-gray-400","to-gray-500","hover:from-gray-500","hover:to-gray-600","text-white","dark:text-white","py-2","rounded-lg","font-bold","text-xs","flex","items-center","justify-center","gap-2","transition-all","duration-300","shadow-md","hover:shadow-lg",3,"click"],[1,"w-72","bg-white","dark:bg-slate-900","border-l","border-slate-200","dark:border-slate-800","shadow-lg","overflow-hidden","flex","flex-col","transition-colors","duration-300"],[1,"p-2","border-b","border-slate-200","dark:border-slate-800"],[1,"text-[9px]","font-bold","text-gray-500","dark:text-gray-400","uppercase","mb-1.5"],[1,"flex","items-center","gap-2","p-1.5","bg-green-50","dark:bg-green-950/30","rounded","border","border-green-200","dark:border-green-800","cursor-pointer","hover:bg-green-100","dark:hover:bg-green-900/40","transition-colors"],[1,"text-green-600","dark:text-green-400","text-sm"],[1,"flex-1","min-w-0"],[1,"text-[9px]","text-green-600","dark:text-green-400"],[1,"text-[11px]","font-bold","text-green-700","dark:text-green-300","truncate"],[1,"flex","items-center","gap-2","p-1.5","bg-slate-50","dark:bg-slate-800","rounded","border","border-slate-200","dark:border-slate-700","cursor-pointer","hover:bg-slate-100","dark:hover:bg-slate-700","transition-colors"],[1,"flex","items-start","gap-2"],[1,"p-2","bg-red-50","dark:bg-red-950/20"],[1,"text-center"],[1,"text-[9px]","text-red-500","uppercase","font-bold"],[1,"text-xl","font-black","text-red-600","dark:text-red-400"],[1,"text-[11px]","text-orange-600","dark:text-orange-400","font-semibold"],[1,"p-2","flex-1","overflow-y-auto"],[1,"space-y-1.5"],[1,"fixed","inset-0","z-50","flex","items-center","justify-center","p-4","bg-black/50","backdrop-blur-sm","animate-fadeIn"],[3,"visibleChange","supervisorSelected","cancelled","visible"],[1,"bg-gradient-to-r","from-green-500","to-emerald-600","text-white","px-6","py-4","rounded-lg","shadow-2xl","flex","items-center","gap-3"],[1,"font-bold"],[1,"text-sm","opacity-90"],[3,"click"],[1,"absolute","bottom-0","left-0","right-0","h-0.5","bg-blue-500"],[1,"pb-1.5","border-b","border-slate-100","dark:border-slate-800"],[1,"text-center","py-2","text-slate-400","text-[10px]"],[1,"text-[10px]","text-slate-500","dark:text-slate-400","uppercase","font-medium"],[1,"text-[12px]","font-semibold","text-slate-800","dark:text-white","break-words"],[1,"text-center","py-4"],[1,"text-[10px]","text-gray-400"],[1,"mt-2","px-2","py-1","bg-blue-500","text-white","text-[9px]","rounded",3,"click"],[1,"bg-gray-50","dark:bg-gray-800","border","border-gray-200","dark:border-gray-700","rounded","p-1.5"],[1,"flex","justify-between","items-center","text-[9px]"],[1,"font-bold","text-gray-600","dark:text-gray-300"],[1,"text-gray-400"],[1,"text-[10px]","font-semibold","text-blue-600","dark:text-blue-300","mt-0.5"],[1,"text-[9px]","text-gray-500","dark:text-gray-400","truncate"],[1,"text-[8px]","text-purple-600","dark:text-purple-400","mt-0.5","hover:underline"],[1,"text-[8px]","text-purple-600","dark:text-purple-400","mt-0.5","hover:underline",3,"click"],[1,"block","font-bold","text-gray-800","dark:text-white","mb-1","text-[11px]","flex","items-center","gap-1"],[1,"w-1.5","h-1.5","bg-red-500","rounded-full"],[1,"relative"],[3,"ngModelChange","ngModel"],["value",""],[3,"value"],[1,"text-red-600","text-[10px]","mt-1","flex","items-center","gap-1"],[1,"bg-gradient-to-r","from-amber-500","via-yellow-500","to-orange-500","dark:from-amber-600","dark:via-yellow-600","dark:to-orange-600","text-white","rounded-lg","shadow-lg","mb-2","overflow-hidden","border-2","border-amber-400","dark:border-amber-500"],[1,"px-4","py-3","bg-black/10","flex","items-center","justify-between"],[1,"flex","items-center","gap-3"],[1,"w-8","h-8","bg-white/20","rounded-lg","flex","items-center","justify-center"],[1,"text-lg"],[1,"font-bold","text-sm"],[1,"text-xs","opacity-80"],[1,"text-xl","font-bold"],[1,"px-4","py-3","bg-black/5"],[1,"text-xs","font-semibold","mb-2","opacity-90"],[1,"flex","flex-wrap","gap-2"],[1,"flex","items-center","gap-2","text-xs","bg-white/20","rounded-lg","px-3","py-2"],[1,"mt-2","text-xs","opacity-80"],[1,"opacity-70"],[1,"font-semibold"],[1,"font-medium","flex","items-center","gap-1"],["name","calendar",3,"size"],[1,"bg-green-600","text-[10px]","px-1.5","py-0.5","rounded","font-semibold","flex","items-center"],[1,"bg-red-600","text-[10px]","px-1.5","py-0.5","rounded","font-semibold","flex","items-center"],[1,"bg-gray-600","text-[10px]","px-1.5","py-0.5","rounded","font-semibold","flex","items-center"],[1,"bg-blue-600","text-[10px]","px-1.5","py-0.5","rounded","font-semibold","flex","items-center"],["name","check",3,"size"],["name","alert-triangle",3,"size"],["name","x",3,"size"],["name","clock",3,"size"],[1,"text-[10px]","font-bold","text-gray-600","dark:text-gray-300","uppercase","mb-2"],[1,"text-red-500","text-[9px]","mt-1"],[1,"flex-1","min-w-[140px]"],[1,"block","text-[9px]","text-gray-500","dark:text-gray-400","mb-0.5"],[1,"flex","items-center","justify-center","gap-2","text-indigo-600","dark:text-indigo-400"],[1,"text-xs"],[1,"flex","items-center","justify-center","gap-2","text-gray-500","dark:text-gray-400"],[3,"dataChange","customAmountDetected","schema","externalUpdates","selectedClassification","customerAmounts"],[1,"flex","items-center","justify-center","gap-2","text-purple-600","dark:text-purple-400"],[1,"text-xs","font-semibold"],[1,"p-1.5","bg-purple-500","dark:bg-purple-600","rounded"],[1,"text-xs","font-bold","text-purple-900","dark:text-purple-100"],[1,"text-[9px]","text-purple-600","dark:text-purple-300"],[1,"bg-white","dark:bg-gray-800","rounded-lg","border","border-purple-200","dark:border-purple-700","p-2","space-y-2"],[1,"text-[9px]","px-1.5","py-0.5","bg-green-100","dark:bg-green-900/30","text-green-700","dark:text-green-300","rounded","font-semibold"],[1,"text-[9px]","font-bold","text-gray-600","dark:text-gray-300","uppercase"],[1,"text-[9px]","text-center","text-gray-500","dark:text-gray-400","italic"],[1,"flex","gap-2","pt-1"],["type","button",1,"flex-1","px-3","py-1.5","bg-purple-600","hover:bg-purple-700","dark:bg-purple-700","dark:hover:bg-purple-600","text-white","text-[10px]","font-bold","rounded","transition-colors","flex","items-center","justify-center","gap-1"],["type","button",1,"flex-1","px-3","py-1.5","bg-indigo-600","hover:bg-indigo-700","dark:bg-indigo-700","dark:hover:bg-indigo-600","text-white","text-[10px]","font-bold","rounded","transition-colors","flex","items-center","justify-center","gap-1"],[1,"text-[9px]","text-purple-600","dark:text-purple-400","bg-purple-100","dark:bg-purple-900/20","p-1.5","rounded","flex","items-start","gap-1"],[1,"flex","items-center","justify-between","text-[10px]","bg-gray-50","dark:bg-gray-900","p-1.5","rounded"],[1,"font-semibold","text-gray-700","dark:text-gray-300"],[1,"text-gray-500","dark:text-gray-400"],[1,"font-bold","text-purple-700","dark:text-purple-300"],["type","button",1,"flex-1","px-3","py-1.5","bg-purple-600","hover:bg-purple-700","dark:bg-purple-700","dark:hover:bg-purple-600","text-white","text-[10px]","font-bold","rounded","transition-colors","flex","items-center","justify-center","gap-1",3,"click"],["type","button",1,"flex-1","px-3","py-1.5","bg-indigo-600","hover:bg-indigo-700","dark:bg-indigo-700","dark:hover:bg-indigo-600","text-white","text-[10px]","font-bold","rounded","transition-colors","flex","items-center","justify-center","gap-1",3,"click"],[1,"text-xs","font-bold","text-green-900","dark:text-green-100"],[1,"text-[9px]","text-green-600","dark:text-green-300"],[1,"mt-3","pt-3","border-t","border-red-200","dark:border-red-800"],[1,"text-[10px]","text-red-600","dark:text-red-400","bg-red-50","dark:bg-red-900/20","p-2","rounded","flex","items-center","gap-1"],[1,"text-[10px]","text-amber-600","dark:text-amber-400","bg-amber-50","dark:bg-amber-900/20","p-2","rounded","flex","items-center","gap-1"],[1,"flex","items-center","justify-between","p-2","rounded-lg","cursor-pointer","transition-all",3,"class"],[1,"flex","items-center","justify-between","p-2","rounded-lg","cursor-pointer","transition-all"],["type","radio","name","cuotaCancelacion",1,"w-4","h-4","text-green-600",3,"change","value","checked"],[1,"font-bold","text-xs"],[1,"text-[10px]","ml-2"],[1,"flex","items-center","gap-2","mb-2"],[1,"text-sm"],[1,"text-[10px]","font-bold","text-red-700","dark:text-red-400"],[1,"flex","items-center","justify-between","p-2","rounded-lg","bg-red-100","dark:bg-red-900/30","border","border-red-300","dark:border-red-700","opacity-75"],[1,"text-[9px]","text-red-600","dark:text-red-400","mt-2"],[1,"text-red-500","dark:text-red-400","text-xs"],[1,"font-bold","text-xs","text-red-800","dark:text-red-300"],[1,"text-[10px]","ml-2","text-red-600","dark:text-red-400"],[1,"font-bold","text-sm","text-red-700","dark:text-red-400"],[1,"flex-1","bg-gradient-to-r","from-amber-500","to-orange-600","hover:from-amber-600","hover:to-orange-700","disabled:from-gray-400","disabled:to-gray-500","text-white","dark:text-white","disabled:text-gray-200","py-2","px-4","rounded-lg","font-bold","text-xs","flex","items-center","justify-center","gap-2","transition-all","duration-300","shadow-lg","hover:shadow-xl","disabled:cursor-not-allowed",3,"click","disabled"],[1,"animate-pulse"],[1,"flex-1","bg-gradient-to-r","from-blue-600","to-blue-700","hover:from-blue-700","hover:to-blue-800","disabled:from-gray-400","disabled:to-gray-500","text-white","dark:text-white","disabled:text-gray-200","py-2","px-4","rounded-lg","font-bold","text-xs","flex","items-center","justify-center","gap-2","transition-all","duration-300","shadow-lg","hover:shadow-xl","disabled:cursor-not-allowed",3,"click","disabled","title"],[1,"text-slate-500","text-sm"],[1,"text-[9px]","text-slate-500","dark:text-slate-400"],[1,"text-[11px]","font-semibold","text-slate-700","dark:text-slate-300","truncate"],[1,"text-blue-500","text-sm"],[1,"text-[10px]","text-gray-600","dark:text-gray-300","break-all"],[1,"text-orange-500","text-sm"],[1,"text-[10px]","text-gray-600","dark:text-gray-300","line-clamp-2"],[1,"flex","justify-between","items-center","py-1","px-2","rounded","text-xs",3,"class"],[1,"flex","justify-between","items-center","py-1","px-2","rounded","text-xs"],[1,"truncate","mr-2","font-medium"],[1,"font-bold","whitespace-nowrap","text-sm"],[1,"bg-white","dark:bg-slate-900","rounded-xl","shadow-2xl","max-w-6xl","w-full","max-h-[90vh]","overflow-hidden","flex","flex-col","animate-slideInUp"],[1,"bg-gradient-to-r","from-purple-600","to-purple-700","dark:from-purple-700","dark:to-purple-800","text-white","px-6","py-4","flex","items-center","justify-between"],[1,"text-lg","font-bold"],["type","button",1,"p-2","hover:bg-white/20","rounded-lg","transition-colors",3,"click"],[1,"flex-1","overflow-y-auto","p-6"],[3,"managementId"],[1,"px-6","py-4","bg-slate-50","dark:bg-slate-800/50","border-t","border-slate-200","dark:border-slate-700","flex","justify-end"],["type","button",1,"px-4","py-2","text-sm","font-semibold","text-slate-700","dark:text-slate-300","hover:bg-slate-200","dark:hover:bg-slate-700","rounded-lg","transition-colors",3,"click"]],template:function(t,i){t&1&&(r(0,"div",1),p(1,Zt,7,0,"div",2),r(2,"div",3)(3,"div",4)(4,"div",5)(5,"div",6)(6,"div",7)(7,"div",8),W(8,"lucide-angular",9),o(),r(9,"h1",10),s(10,"Gesti\xF3n de Cobranza"),o()(),W(11,"div",11),r(12,"div")(13,"div",12),s(14,"Asesor"),o(),r(15,"div",13),s(16,"Mar\xEDa Gonz\xE1lez Castro"),o()()(),r(17,"div",6)(18,"div",14)(19,"div",12),s(20,"Estado"),o(),r(21,"div"),s(22),o()(),W(23,"app-status-alarm-clock",15),r(24,"div"),s(25),o()()()()(),r(26,"div",16)(27,"div",17)(28,"div",18),B(29,Xt,3,4,"button",19,fe),o(),r(31,"div",20)(32,"div"),p(33,ii,4,1,"div",21),p(34,li,3,1,"div",22),o()()(),r(35,"div",23)(36,"div",24)(37,"div")(38,"div",5)(39,"h3",25),W(40,"div"),s(41," Control de Llamada "),o(),r(42,"div",26)(43,"button",27),F("click",function(){return i.toggleMute()}),s(44),o(),r(45,"button",28),F("click",function(){return i.endCall()}),s(46," Finalizar "),o()()()(),p(47,ci,11,4,"div",29),p(48,Ci,3,0,"div",30),p(49,yi,7,1,"div",31),p(50,Ei,4,0,"div",32),p(51,Pi,4,0,"div",33),p(52,Di,2,4,"app-dynamic-field-renderer",34),p(53,Ii,4,0,"div",35),p(54,Ni,11,1,"div",36),p(55,Bi,13,3,"div",37),r(56,"div",38),p(57,Gi,3,2,"button",39)(58,Wi,3,3,"button",40),r(59,"button",41),F("click",function(){return i.cancelarTipificacion()}),s(60," Cancelar "),o()()()(),r(61,"div",42)(62,"div",43)(63,"div",44),s(64,"Contacto"),o(),r(65,"div",22)(66,"div",45)(67,"span",46),s(68,"\u{1F4F1}"),o(),r(69,"div",47)(70,"div",48),s(71,"Principal"),o(),r(72,"div",49),s(73),o()()(),p(74,Yi,8,1,"div",50),p(75,Qi,8,1,"div",50),o()(),r(76,"div",43)(77,"div",22),p(78,Ji,5,1,"div",51),p(79,Zi,5,1,"div",51),o()(),r(80,"div",52)(81,"div",53)(82,"div",54),s(83),o(),r(84,"div",55),s(85),o(),r(86,"div",56),s(87),o()()(),r(88,"div",57),p(89,Xi,3,0,"div",58),o()()(),p(90,en,15,2,"div",59),r(91,"app-select-supervisor-modal",60),he("visibleChange",function(m){return pe(i.showSupervisorModal,m)||(i.showSupervisorModal=m),m}),F("supervisorSelected",function(m){return i.onSupervisorSelected(m)})("cancelled",function(){return i.onSupervisorSelectionCancelled()}),o()()),t&2&&(c(),h(i.showSuccess()?1:-1),c(7),$("size",18),c(13),L("font-semibold text-sm transition-all duration-300 "+(i.callActive()?"text-green-400 animate-pulse":i.isTipifying()?"text-yellow-400":"text-white/80")),c(),f(" ",i.callActive()?"\u25CF EN LLAMADA":i.isTipifying()?"\u270E TIPIFICANDO":"\u25CB DISPONIBLE"," "),c(),$("color",i.colorIndicador())("excedido",i.excedeTiempoMaximo())("size",22),c(),L("px-4 py-1.5 rounded-lg font-mono text-lg font-bold transition-all duration-300 "+(i.callActive()?"bg-gradient-to-r from-red-600 to-red-700 animate-pulse shadow-lg shadow-red-500/30":"bg-blue-800/50 dark:bg-gray-900/80")),c(),f(" ",i.formatTime(i.callDuration())," "),c(4),z(i.tabs),c(4),h(i.activeTab()==="cliente"?33:-1),c(),h(i.activeTab()==="historial"?34:-1),c(3),L("bg-white dark:bg-gray-800 rounded-lg shadow-md border p-2 transition-colors duration-300 "+(i.callActive()?"border-green-400 dark:border-green-500":"border-gray-200 dark:border-gray-700")),c(3),L("p-1 rounded transition-all duration-300 "+(i.callActive()?"bg-green-100 dark:bg-green-900/30 animate-pulse":"bg-blue-100 dark:bg-blue-900/30")),c(3),L("px-4 py-1.5 rounded-lg font-bold flex items-center gap-2 transition-all duration-300 text-xs shadow-md hover:shadow-lg "+(i.callActive()?i.isMuted()?"bg-gradient-to-r from-yellow-600 to-yellow-700 hover:from-yellow-700 hover:to-yellow-800 text-white":"bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white":"bg-gray-400 text-gray-200 cursor-not-allowed")),$("disabled",!i.callActive()),c(),f(" ",i.isMuted()?"\u{1F507} Activar":"\u{1F50A} Silenciar"," "),c(),$("disabled",!i.callActive()),c(2),h(i.usesHierarchicalClassifications()?-1:47),c(),h(i.activePaymentSchedules()&&i.activePaymentSchedules().length>0?48:-1),c(),h(i.usesHierarchicalClassifications()?49:-1),c(),h(i.isLoadingDynamicFields()?50:-1),c(),h(!i.isLoadingDynamicFields()&&i.isLeafClassification()&&i.dynamicFields().length===0?51:-1),c(),h(!i.isLoadingDynamicFields()&&i.isLeafClassification()&&i.dynamicFieldsSchema()?52:-1),c(),h(i.isLoadingSchedules()?53:-1),c(),h(!i.isLoadingSchedules()&&i.showScheduleHelper()&&i.activeSchedules().length>0?54:-1),c(),h(i.isCancellationTypification()&&(i.pendingInstallmentsForCancellation().length>0||i.overdueInstallments().length>0)?55:-1),c(2),h(i.requiresAuthorization()?57:58),c(16),j(i.customerData().contacto.telefono_principal),c(),h(i.customerData().contacto.telefono_alternativo?74:-1),c(),h(i.customerData().contacto.telefono_trabajo?75:-1),c(3),h(i.customerData().contacto.email?78:-1),c(),h(i.customerData().contacto.direccion?79:-1),c(4),j(i.getPrimaryAmountLabel()),c(2),j(i.formatCurrency(i.getPrimaryAmountValue())),c(2),f("",i.clientDiasMora()," d\xEDas mora"),c(2),h(i.clientAmountFields().length>0?89:-1),c(),h(i.showScheduleDetail()&&i.scheduleManagementId()?90:-1),c(),ge("visible",i.showSupervisorModal))},dependencies:[ce,ve,Ke,Xe,Ze,we,Ae,We,He,rt,ut,gt,at,_e],styles:["@keyframes _ngcontent-%COMP%_slideInRight{0%{transform:translate(100%);opacity:0}to{transform:translate(0);opacity:1}}@keyframes _ngcontent-%COMP%_fadeIn{0%{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}@keyframes _ngcontent-%COMP%_slideInUp{0%{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}"]});let n=d;return n})();export{ea as CollectionManagementPage};
