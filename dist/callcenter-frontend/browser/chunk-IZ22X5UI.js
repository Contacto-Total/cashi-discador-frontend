import{a as fe}from"./chunk-R7PSNTR3.js";import{a as ue}from"./chunk-YBTTFGZA.js";import{a as ge}from"./chunk-BY2DM2ZC.js";import{a as ae,b as re,e as le,h as de,m as se,n as ce,o as me,u as pe}from"./chunk-TFAMJCIP.js";import{$ as z,$a as W,Ab as G,Cb as N,Db as V,Eb as v,Fb as i,Gb as n,Hb as R,Ob as P,Qb as x,Sb as c,Va as d,Wb as Y,Xb as J,Yb as K,_c as ie,bc as ee,da as $,dc as X,ec as r,f as U,fc as M,gb as Z,gc as H,gd as ne,hc as q,ja as f,jc as y,jd as oe,ka as g,kc as w,lc as S,mc as te,ta as T,wc as j,ya as Q,yb as C,zb as h}from"./chunk-UY3AUK24.js";var xe=(()=>{let s=class s{constructor(t){this.http=t,this.baseUrl=`${oe.tipificacionUrl}/system-config/field-definitions`}getAllActive(){return this.http.get(this.baseUrl)}getByCategory(t){return this.http.get(`${this.baseUrl}/category/${t}`)}getByDataType(t){return this.http.get(`${this.baseUrl}/data-type/${t}`)}getById(t){return this.http.get(`${this.baseUrl}/${t}`)}getByFieldCode(t){return this.http.get(`${this.baseUrl}/code/${t}`)}countActiveFields(){return this.http.get(`${this.baseUrl}/count`)}};s.\u0275fac=function(e){return new(e||s)($(ne))},s.\u0275prov=z({token:s,factory:s.\u0275fac,providedIn:"root"});let l=s;return l})();var be=["downloadButton"],B=(l,s)=>s.id,ve=(l,s)=>s.headerName;function ye(l,s){if(l&1&&(i(0,"option",13),r(1),n()),l&2){let a=s.$implicit;v("value",a.id),d(),M(a.tenantName)}}function we(l,s){if(l&1&&(i(0,"option",13),r(1),n()),l&2){let a=s.$implicit;v("value",a.id),d(),M(a.portfolioName)}}function Se(l,s){if(l&1&&(i(0,"option",13),r(1),n()),l&2){let a=s.$implicit;v("value",a.id),d(),M(a.subPortfolioName)}}function Ee(l,s){if(l&1&&(i(0,"div",32)(1,"span",36),r(2),n(),i(3,"span",37),r(4,"cabecera(s)"),n()()),l&2){let a=c(2);d(2),M(a.previewHeaders().length)}}function Te(l,s){if(l&1){let a=P();i(0,"div",38),x("click",function(){f(a);let e=c(2);return g(e.downloadMenuOpen.set(!1))}),n(),i(1,"div",39)(2,"button",40),x("click",function(){f(a);let e=c(2);return g(e.downloadCSVTemplate())}),i(3,"span",41),r(4,"Descargar CSV"),n()(),i(5,"button",40),x("click",function(){f(a);let e=c(2);return g(e.downloadExcelTemplate())}),i(6,"span",41),r(7,"Descargar Excel (.xlsx)"),n()()()}if(l&2){let a=c(2);d(),ee("top",a.dropdownPosition().top,"px")("left",a.dropdownPosition().left,"px")}}function De(l,s){if(l&1){let a=P();i(0,"div",33)(1,"button",42),x("click",function(){f(a);let e=c(2);return g(e.clearAll())}),i(2,"span"),r(3,"Limpiar"),n()(),i(4,"button",43),x("click",function(){f(a);let e=c(2);return g(e.confirmConfiguration())}),i(5,"span"),r(6,"Guardar"),n()()()}}function Me(l,s){l&1&&(i(0,"div",34),R(1,"div",44),i(2,"p",45),r(3,"No hay cabeceras configuradas"),n()())}function Ie(l,s){if(l&1&&r(0),l&2){let a=c().$implicit;H(' name="sparkles" [size]="12" class="text-amber-400 flex-shrink-0" title="Campo transformado mediante expresi\xF3n regular desde: ',a.sourceField,'"> ')}}function He(l,s){l&1&&(i(0,"span",57),r(1,"Sin asociar"),n())}function Pe(l,s){if(l&1&&(i(0,"span",58),r(1),n()),l&2){let a=c().$implicit,t=c(3);d(),M(t.getFieldCodeById(a.fieldDefinitionId))}}function Fe(l,s){}function Ne(l,s){}function Ve(l,s){if(l&1){let a=P();i(0,"tr",51)(1,"td",52)(2,"div",53)(3,"span",54),r(4),n(),C(5,Ie,1,1),n()(),i(6,"td",52)(7,"span",55),r(8),n()(),i(9,"td",52)(10,"span",56),r(11),n()(),i(12,"td",52),C(13,He,2,0,"span",57)(14,Pe,2,1,"span",58),n(),i(15,"td",52)(16,"span",8),r(17),n()(),i(18,"td",59),C(19,Fe,0,0)(20,Ne,0,0),n(),i(21,"td",52)(22,"div",53)(23,"button",60),x("click",function(){let e=f(a).$index,o=c(3);return g(o.editPreviewHeader(e))}),n(),i(24,"button",61),x("click",function(){let e=f(a).$index,o=c(3);return g(o.removePreviewHeader(e))}),n()()()()}if(l&2){let a=s.$implicit,t=c(3);d(4),M(a.headerName),d(),h(a.sourceField&&a.regexPattern?5:-1),d(2),X(t.getDataTypeBadgeClass(a.dataType)),d(),H(" ",a.dataType," "),d(3),M(a.displayLabel),d(2),h(a.fieldDefinitionId===0?13:14),d(4),M(a.format||"-"),d(2),h(a.required?19:20)}}function Oe(l,s){if(l&1&&(i(0,"div",35)(1,"table",46)(2,"thead",47)(3,"tr")(4,"th",48),r(5,"Nombre"),n(),i(6,"th",48),r(7,"Tipo"),n(),i(8,"th",48),r(9,"Etiqueta"),n(),i(10,"th",48),r(11,"Campo Cat\xE1logo"),n(),i(12,"th",48),r(13,"Formato"),n(),i(14,"th",49),r(15,"Req."),n(),i(16,"th",48),r(17,"Acciones"),n()()(),i(18,"tbody",50),N(19,Ve,25,9,"tr",51,G),n()()()),l&2){let a=c(2);d(19),V(a.previewHeaders())}}function Le(l,s){if(l&1){let a=P();i(0,"div",4)(1,"div",18)(2,"div",19)(3,"div",20)(4,"div",21)(5,"button",22,0),x("click",function(){f(a);let e=c();return g(e.toggleDownloadMenu())}),i(7,"span",23),r(8,"Descargar Plantilla"),n(),i(9,"span",24),r(10,"Plantilla"),n()()(),i(11,"select",25),S("ngModelChange",function(e){f(a);let o=c();return w(o.csvSeparator,e)||(o.csvSeparator=e),g(e)}),i(12,"option",26),r(13,"Separador: Punto y coma (;)"),n(),i(14,"option",27),r(15,"Separador: Coma (,)"),n(),i(16,"option",28),r(17,"Separador: Pipe (|)"),n(),i(18,"option",29),r(19,"Separador: Tabulaci\xF3n (Tab)"),n()(),i(20,"label",30)(21,"span",23),r(22,"Importar CSV/Excel"),n(),i(23,"span",24),r(24,"Importar"),n(),i(25,"input",31),x("change",function(e){f(a);let o=c();return g(o.onFileSelected(e))}),n()(),C(26,Ee,5,1,"div",32),n(),C(27,Te,8,4),C(28,De,7,0,"div",33),n()()(),i(29,"div")(30,"div",18),C(31,Me,4,0,"div",34)(32,Oe,21,0,"div",35),n()()}if(l&2){let a=c();d(11),y("ngModel",a.csvSeparator),d(15),h(a.previewHeaders().length>0?26:-1),d(),h(a.downloadMenuOpen()?27:-1),d(),h(a.previewHeaders().length>0?28:-1),d(3),h(a.previewHeaders().length===0?31:32)}}function Ae(l,s){if(l&1&&(i(0,"option",13),r(1),n()),l&2){let a=s.$implicit;v("value",a.id),d(),q(" ",a.fieldName," (",a.fieldCode,") ")}}function ke(l,s){if(l&1&&(i(0,"div",8)(1,"span",88),r(2,"Descripci\xF3n:"),n(),r(3),n()),l&2){let a=c();d(3),H(" ",a.description," ")}}function We(l,s){if(l&1&&(i(0,"div",8)(1,"span",88),r(2,"Formato del Sistema:"),n(),i(3,"code",89),r(4),n()()),l&2){let a=c();d(4),M(a.format)}}function Re(l,s){if(l&1&&(i(0,"div",75)(1,"p",86),r(2,"\u{1F4CB} Informaci\xF3n del Cat\xE1logo"),n(),i(3,"div",5)(4,"span",8),r(5,"Tipo de Dato:"),n(),i(6,"span",87),r(7),n()(),C(8,ke,4,1,"div",8),C(9,We,5,1,"div",8),n()),l&2){let a=s,t=c(2);d(6),X(t.getDataTypeBadgeClass(a.dataType)),d(),H(" ",a.dataType," "),d(),h(a.description?8:-1),d(),h(a.format?9:-1)}}function Be(l,s){if(l&1){let a=P();i(0,"div")(1,"label",72),r(2," Tipo de Dato * "),n(),i(3,"select",73),S("ngModelChange",function(e){f(a);let o=c(2);return w(o.formData.dataType,e)||(o.formData.dataType=e),g(e)}),i(4,"option",90),r(5,"TEXTO"),n(),i(6,"option",91),r(7,"NUMERICO"),n(),i(8,"option",92),r(9,"FECHA"),n()(),i(10,"p",74),r(11," Seleccione el tipo de dato para este campo personalizado. "),n()()}if(l&2){let a=c(2);d(3),y("ngModel",a.formData.dataType)}}function Xe(l,s){if(l&1&&(i(0,"option",13),r(1),n()),l&2){let a=s.$implicit;v("value",a.headerName),d(),q(" ",a.headerName," - ",a.displayLabel," ")}}function qe(l,s){l&1&&(i(0,"span",97),r(1,"*"),n())}function je(l,s){if(l&1){let a=P();i(0,"p",93),r(1," Si este campo se deriva de otro campo mediante regex, config\xFAralo aqu\xED."),R(2,"br"),r(3," Ejemplo: extraer documento desde IDENTITY_CODE. "),n(),i(4,"div",94)(5,"div")(6,"label",72),r(7," Campo Origen "),n(),i(8,"select",95),S("ngModelChange",function(e){f(a);let o=c(2);return w(o.formData.sourceField,e)||(o.formData.sourceField=e),g(e)}),i(9,"option",96),r(10,"Seleccione un campo origen..."),n(),N(11,Xe,2,3,"option",13,ve),n(),i(13,"p",74),r(14," Campo desde donde se extraer\xE1 el valor mediante regex. "),n()(),i(15,"div")(16,"label",72),r(17," Patr\xF3n Regex "),C(18,qe,2,0,"span",97),n(),i(19,"input",98),S("ngModelChange",function(e){f(a);let o=c(2);return w(o.formData.regexPattern,e)||(o.formData.regexPattern=e),g(e)}),n(),i(20,"p",74),r(21," Ejemplos: "),i(22,"code",99),r(23),n(),r(24," \xFAltimos 8 \u2022 "),i(25,"code",99),r(26),n(),r(27," 8 d\xEDgitos "),n()()()}if(l&2){let a=c(2);d(8),y("ngModel",a.formData.sourceField),d(3),V(a.availableSourceHeaders()),d(7),h(a.formData.sourceField&&a.formData.sourceField.trim()!==""?18:-1),d(),v("placeholder",te("Ej: .",8,"$ (\xFAltimos 8 caracteres)")),y("ngModel",a.formData.regexPattern),d(4),H(".",8,"$"),d(3),H("\\d",8)}}function Ue(l,s){if(l&1){let a=P();i(0,"div",17)(1,"div",62)(2,"div",63)(3,"div",64)(4,"div",65),R(5,"div",66),i(6,"div")(7,"h2",67),r(8),n(),i(9,"p",68),r(10,"Complete la informaci\xF3n de la cabecera"),n()()(),i(11,"button",69),x("click",function(){f(a);let e=c();return g(e.closeManualDialog())}),n()()(),i(12,"div",70)(13,"div",71)(14,"div")(15,"label",72),r(16," Campo Base de Datos (Opcional) "),n(),i(17,"select",73),S("ngModelChange",function(e){f(a);let o=c();return w(o.formData.fieldDefinitionId,e)||(o.formData.fieldDefinitionId=e),g(e)}),x("ngModelChange",function(){f(a);let e=c();return g(e.onFieldDefinitionSelect())}),i(18,"option",13),r(19,"Sin asociar - Campo personalizado"),n(),N(20,Ae,2,3,"option",13,B),n(),i(22,"p",74),r(23,' Seleccione un campo del cat\xE1logo o deje "Sin asociar" para crear un campo personalizado. '),n()(),C(24,Re,10,5,"div",75),C(25,Be,12,1,"div"),i(26,"div")(27,"label",72),r(28," Campo Sistema * "),n(),i(29,"input",76),S("ngModelChange",function(e){f(a);let o=c();return w(o.formData.headerName,e)||(o.formData.headerName=e),g(e)}),n(),i(30,"p",74),r(31," Nombre de la cabecera tal como viene del proveedor. "),n()(),i(32,"div")(33,"label",72),r(34," Etiqueta Visual * "),n(),i(35,"input",77),S("ngModelChange",function(e){f(a);let o=c();return w(o.formData.displayLabel,e)||(o.formData.displayLabel=e),g(e)}),n(),i(36,"p",74),r(37," Texto que se mostrar\xE1 en la interfaz de usuario. "),n()(),i(38,"div")(39,"label",72),r(40," Formato "),n(),i(41,"input",78),S("ngModelChange",function(e){f(a);let o=c();return w(o.formData.format,e)||(o.formData.format=e),g(e)}),n(),i(42,"p",74),r(43," Formato espec\xEDfico para esta subcartera (opcional, puede diferir del formato del sistema). "),n()(),i(44,"div",65)(45,"input",79),S("ngModelChange",function(e){f(a);let o=c();return w(o.formData.required,e)||(o.formData.required=e),g(e)}),n(),i(46,"label",80),r(47," Campo obligatorio "),n()(),i(48,"div",81)(49,"button",82),x("click",function(){f(a);let e=c();return g(e.showTransformSection.set(!e.showTransformSection()))}),i(50,"div",5),r(51," Transformaci\xF3n de Campo (Opcional) "),n(),r(52,` [name]="showTransformSection() ? 'chevron-up' : 'chevron-down'" [size]="16"> `),n(),C(53,je,28,7),n()()(),i(54,"div",83)(55,"button",84),x("click",function(){f(a);let e=c();return g(e.closeManualDialog())}),r(56," Cancelar "),n(),i(57,"button",85),x("click",function(){f(a);let e=c();return g(e.saveManualHeader())}),r(58),n()()()()}if(l&2){let a,t=c();d(8),H("",t.editingIndex()!==null?"Editar":"Agregar"," Cabecera"),d(9),y("ngModel",t.formData.fieldDefinitionId),d(),v("value",0),d(2),V(t.availableFieldDefinitions()),d(4),h((a=t.getSelectedFieldDefinition())?24:-1,a),d(),h(t.formData.fieldDefinitionId===0?25:-1),d(4),y("ngModel",t.formData.headerName),d(6),y("ngModel",t.formData.displayLabel),d(6),y("ngModel",t.formData.format),d(4),y("ngModel",t.formData.required),d(8),h(t.showTransformSection()?53:-1),d(4),v("disabled",!t.canSaveManualHeader()),d(),H(" ",t.editingIndex()!==null?"Actualizar":"Agregar"," ")}}var nt=(()=>{let s=class s{constructor(t,e,o,m){this.headerConfigService=t,this.fieldDefinitionService=e,this.typificationService=o,this.portfolioService=m,this.tenants=T([]),this.portfolios=T([]),this.subPortfolios=T([]),this.fieldDefinitions=T([]),this.previewHeaders=T([]),this.showManualDialog=T(!1),this.editingIndex=T(null),this.downloadMenuOpen=T(!1),this.showTransformSection=T(!1),this.dropdownPosition=T({top:120,left:100}),this.headersAreSaved=T(!1),this.availableFieldDefinitions=j(()=>{let p=this.previewHeaders().map(E=>E.fieldDefinitionId),u=this.formData.fieldDefinitionId,b=this.editingIndex();return this.fieldDefinitions().filter(E=>b!==null&&E.id===u?!0:!p.includes(E.id))}),this.availableSourceHeaders=j(()=>{let p=this.formData.headerName;return this.previewHeaders().filter(u=>!(u.sourceField&&u.regexPattern||u.headerName===p))}),this.selectedTenantId=0,this.selectedPortfolioId=0,this.selectedSubPortfolioId=0,this.selectedLoadType="ACTUALIZACION",this.csvSeparator=";",this.formData={fieldDefinitionId:0,headerName:"",dataType:"TEXTO",displayLabel:"",format:"",required:!1,sourceField:"",regexPattern:""}}ngOnInit(){this.loadTenants(),this.loadFieldDefinitions()}loadFieldDefinitions(){this.fieldDefinitionService.getAllActive().subscribe({next:t=>{this.fieldDefinitions.set(t)},error:t=>{console.error("Error al cargar definiciones de campos:",t)}})}loadTenants(){this.typificationService.getAllTenants().subscribe({next:t=>{this.tenants.set(t)},error:t=>{console.error("Error loading tenants:",t)}})}onTenantChange(){this.selectedPortfolioId=0,this.selectedSubPortfolioId=0,this.portfolios.set([]),this.subPortfolios.set([]),this.previewHeaders.set([]),this.selectedTenantId>0&&this.loadPortfolios()}onPortfolioChange(){this.selectedSubPortfolioId=0,this.subPortfolios.set([]),this.previewHeaders.set([]),this.selectedPortfolioId>0&&this.loadSubPortfolios()}onSubPortfolioChange(){this.previewHeaders.set([]),this.headersAreSaved.set(!1),this.selectedSubPortfolioId>0&&this.loadExistingHeaders()}onLoadTypeChange(){this.previewHeaders.set([]),this.headersAreSaved.set(!1),this.selectedSubPortfolioId>0&&this.loadExistingHeaders()}loadPortfolios(){this.portfolioService.getPortfoliosByTenant(this.selectedTenantId).subscribe({next:t=>{this.portfolios.set(t)},error:t=>{console.error("Error loading portfolios:",t)}})}loadSubPortfolios(){this.portfolioService.getSubPortfoliosByPortfolio(this.selectedPortfolioId).subscribe({next:t=>{this.subPortfolios.set(t)},error:t=>{console.error("Error loading subportfolios:",t)}})}loadExistingHeaders(){this.headerConfigService.getBySubPortfolioAndLoadType(this.selectedSubPortfolioId,this.selectedLoadType).subscribe({next:t=>{let e=t.map(o=>({fieldDefinitionId:o.fieldDefinitionId,headerName:o.headerName,dataType:o.dataType,displayLabel:o.displayLabel,format:o.format,required:o.required,sourceField:o.sourceField,regexPattern:o.regexPattern}));this.previewHeaders.set(e),this.headersAreSaved.set(t.length>0)},error:t=>{console.error("Error loading headers:",t),this.headersAreSaved.set(!1)}})}openManualDialog(){this.editingIndex.set(null),this.formData={fieldDefinitionId:0,headerName:"",dataType:"TEXTO",displayLabel:"",format:"",required:!1,sourceField:"",regexPattern:""},this.showTransformSection.set(!1),this.showManualDialog.set(!0)}onFieldDefinitionSelect(){let t=this.formData.fieldDefinitionId;if(t===0){this.formData.dataType="TEXTO";return}let e=this.fieldDefinitions().find(o=>o.id===t);e&&(this.formData.dataType=e.dataType)}getSelectedFieldDefinition(){let t=this.formData.fieldDefinitionId;return t===0?null:this.fieldDefinitions().find(e=>e.id===t)}closeManualDialog(){this.showManualDialog.set(!1),this.editingIndex.set(null)}canSaveManualHeader(){return!this.formData.headerName.trim()||!this.formData.displayLabel.trim()||this.formData.sourceField&&this.formData.sourceField.trim()!==""&&(!this.formData.regexPattern||this.formData.regexPattern.trim()==="")?!1:this.formData.fieldDefinitionId===0?!!this.formData.dataType&&["TEXTO","NUMERICO","FECHA"].includes(this.formData.dataType):!0}saveManualHeader(){if(!this.canSaveManualHeader())return;let t={fieldDefinitionId:this.formData.fieldDefinitionId,headerName:this.formData.headerName.trim(),dataType:this.formData.dataType,displayLabel:this.formData.displayLabel.trim(),format:this.formData.format?.trim()||void 0,required:this.formData.required,sourceField:this.formData.sourceField?.trim()||void 0,regexPattern:this.formData.regexPattern?.trim()||void 0},e=[...this.previewHeaders()],o=this.editingIndex();o!==null?e[o]=t:e.push(t),this.previewHeaders.set(e),this.closeManualDialog()}editPreviewHeader(t){let e=this.previewHeaders()[t];this.editingIndex.set(t),this.formData={fieldDefinitionId:e.fieldDefinitionId,headerName:e.headerName,dataType:e.dataType,displayLabel:e.displayLabel,format:e.format||"",required:e.required||!1,sourceField:e.sourceField||"",regexPattern:e.regexPattern||""},this.showTransformSection.set(!!(e.sourceField||e.regexPattern)),this.showManualDialog.set(!0)}removePreviewHeader(t){let e=[...this.previewHeaders()];e.splice(t,1),this.previewHeaders.set(e)}clearAll(){confirm("\xBFEst\xE1 seguro de limpiar todas las cabeceras? Esta acci\xF3n no se puede deshacer.")&&this.previewHeaders.set([])}confirmConfiguration(){if(this.previewHeaders().length===0){alert("No hay cabeceras para confirmar");return}if(!confirm(`\xBFConfirmar la configuraci\xF3n de ${this.previewHeaders().length} cabeceras?`))return;let t={subPortfolioId:this.selectedSubPortfolioId,loadType:this.selectedLoadType,headers:this.previewHeaders()};this.headerConfigService.deleteAllBySubPortfolioAndLoadType(this.selectedSubPortfolioId,this.selectedLoadType).subscribe({next:()=>{this.headerConfigService.createBulk(t).subscribe({next:()=>{alert("Configuraci\xF3n guardada exitosamente"),this.loadExistingHeaders()},error:e=>{console.error("Error saving configuration:",e),alert("Error al guardar la configuraci\xF3n: "+(e.error?.message||e.message))}})},error:e=>{console.error("Error deleting old configuration:",e),alert("Error al eliminar configuraci\xF3n anterior")}})}onFileSelected(t){let e=t.target.files[0];if(!e)return;let o=e.name.toLowerCase();if(o.endsWith(".xlsx")||o.endsWith(".xls"))this.parseExcel(e);else{let p=new FileReader;p.onload=u=>{let b=u.target.result;this.parseCSV(b)},p.readAsText(e)}t.target.value=""}parseExcel(t){let e=new FileReader;e.onload=o=>{try{if(!window.XLSX){alert("Cargando soporte para Excel... intente nuevamente en unos segundos."),this.loadXLSXLibrary().then(()=>{this.parseExcel(t)});return}let m=window.XLSX,p=new Uint8Array(o.target.result),u=m.read(p,{type:"array"}),b=u.SheetNames[0],E=u.Sheets[b],O=m.utils.sheet_to_csv(E,{FS:this.csvSeparator});this.parseCSV(O)}catch(m){console.error("Error al procesar Excel:",m),alert("Error al procesar el archivo Excel. Verifique que el formato sea correcto.")}},e.readAsArrayBuffer(t)}loadXLSXLibrary(){return new Promise((t,e)=>{if(window.XLSX){t();return}let o=document.createElement("script");o.src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js",o.onload=()=>t(),o.onerror=()=>e(new Error("No se pudo cargar la librer\xEDa XLSX")),document.head.appendChild(o)})}parseCsvLine(t,e){let o=[],m="",p=!1;for(let u=0;u<t.length;u++){let b=t[u];b==='"'?p=!p:b===e&&!p?(o.push(m.trim()),m=""):m+=b}return o.push(m.trim()),o.map(u=>u.startsWith('"')&&u.endsWith('"')?u.slice(1,-1):u)}parseCSV(t){let e=t.split(`
`).filter(m=>m.trim());if(e.length<2){alert("El archivo CSV est\xE1 vac\xEDo o no tiene datos");return}let o=[];for(let m=1;m<e.length;m++){let p=this.parseCsvLine(e[m],this.csvSeparator);if(p.length<3)continue;let[u,b,E,O,L,_,F,A]=p;if(!b||!E)continue;let I=_?_==="1"||_.toLowerCase()==="true":void 0,D=A?.trim();if(D&&D.startsWith('"')&&D.endsWith('"')&&(D=D.slice(1,-1)),!u||u.trim()===""){if(!L||!["TEXTO","NUMERICO","FECHA"].includes(L.toUpperCase())){alert(`Campo personalizado en l\xEDnea ${m+1} requiere un tipo de dato v\xE1lido (TEXTO, NUMERICO, FECHA)`);return}o.push({fieldDefinitionId:0,headerName:b.trim(),dataType:L.toUpperCase(),displayLabel:E.trim(),format:O?.trim()||void 0,required:I,sourceField:F?.trim()||void 0,regexPattern:D||void 0})}else{let k=this.fieldDefinitions().find(_e=>_e.fieldCode===u.trim());if(!k){alert(`C\xF3digo de campo no encontrado en l\xEDnea ${m+1}: ${u}. Revise el cat\xE1logo de campos.`);return}o.push({fieldDefinitionId:k.id,headerName:b.trim(),dataType:k.dataType,displayLabel:E.trim(),format:O?.trim()||void 0,required:I!==void 0?I:!0,sourceField:F?.trim()||void 0,regexPattern:D||void 0})}}if(o.length===0){alert("No se encontraron cabeceras v\xE1lidas en el archivo CSV");return}this.previewHeaders.set(o),alert(`Se importaron ${o.length} cabeceras exitosamente`)}toggleDownloadMenu(){if(this.downloadMenuOpen.update(t=>!t),this.downloadMenuOpen()&&this.downloadButton){let t=this.downloadButton.nativeElement.getBoundingClientRect();this.dropdownPosition.set({top:t.bottom+8,left:t.left})}}escapeCsvValue(t,e){return t?t.includes(e)||t.includes('"')||t.includes(`
`)||t.includes("\r")?`"${t.replace(/"/g,'""')}"`:t:""}createCsvRow(t,e){return t.map(o=>this.escapeCsvValue(o,e)).join(e)}downloadCSVTemplate(){this.downloadMenuOpen.set(!1);let t=this.csvSeparator,e;this.previewHeaders().length>0?(e=[["codigoCampo","nombreCabecera","etiquetaVisual","formato","tipoDato","obligatorio","campoAsociado","regEx"]],this.previewHeaders().forEach(_=>{let F=this.fieldDefinitions().find(I=>I.id===_.fieldDefinitionId),A=F?F.fieldCode:"";e.push([A,_.headerName,_.displayLabel,_.format||"",_.dataType||"",_.required?"1":"0",_.sourceField||"",_.regexPattern||""])})):e=[["codigoCampo","nombreCabecera","etiquetaVisual","formato","tipoDato","obligatorio","campoAsociado","regEx"],["documento","DNI","N\xFAmero de Documento","","TEXTO","1","",""],["nombre_completo","NOMBRE","Nombre del Cliente","","TEXTO","1","",""],["telefono_principal","TELEFONO","Tel\xE9fono Principal","","TEXTO","0","",""],["email","CORREO","Correo Electr\xF3nico","","TEXTO","0","",""],["monto_capital","MONTO_CAPITAL","Monto Capital (S/.)","decimal(18,2)","NUMERICO","1","",""],["fecha_vencimiento","FEC_VENC","Fecha de Vencimiento","dd/MM/yyyy","FECHA","1","",""],["","DOCUMENTO_EXTRAIDO","Documento Extra\xEDdo","","TEXTO","0","DNI",'"^D.*?(\\d{7})$|^C.*?(\\d{8})$"']];let m=e.map((_,F)=>{if(F===0)return this.createCsvRow(_,t);let A=_.slice(0,7),I=_[7]||"",D=this.createCsvRow(A,t);if(I&&I.trim()!==""){let k=I.replace(/"/g,'""');D+=t+`"${k}"`}else D+=t;return D}).join(`
`),p=new Blob([m],{type:"text/csv;charset=utf-8;"}),u=document.createElement("a"),b=URL.createObjectURL(p),E=this.csvSeparator===","?"coma":this.csvSeparator===";"?"punto-coma":this.csvSeparator==="|"?"pipe":"tab",O=this.previewHeaders().length>0?`header-configuration-actual-${E}.csv`:`header-configuration-template-${E}.csv`;u.setAttribute("href",b),u.setAttribute("download",O),u.style.visibility="hidden",document.body.appendChild(u),u.click(),document.body.removeChild(u);let L=this.previewHeaders().length>0?"Configuraci\xF3n actual descargada exitosamente":"Plantilla CSV descargada exitosamente";alert(L)}downloadExcelTemplate(){return U(this,null,function*(){if(this.downloadMenuOpen.set(!1),!window.XLSX)try{yield this.loadXLSXLibrary()}catch{alert("No se pudo cargar el soporte para Excel. Intente de nuevo.");return}let t=window.XLSX,e=[["codigoCampo","nombreCabecera","etiquetaVisual","formato","tipoDato"],["documento","DNI","N\xFAmero de Documento","",""],["nombre_completo","NOMBRE","Nombre del Cliente","",""],["telefono_principal","TELEFONO","Tel\xE9fono Principal","",""],["email","CORREO","Correo Electr\xF3nico","",""],["direccion","DIRECCION","Direcci\xF3n Completa","",""],["distrito","DISTRITO","Distrito","",""],["provincia","PROVINCIA","Provincia","",""],["numero_contrato","NRO_CONTRATO","N\xFAmero de Contrato","",""],["tipo_producto","PRODUCTO","Tipo de Producto","",""],["estado_cuenta","ESTADO","Estado de Cuenta","",""],["monto_capital","MONTO_CAPITAL","Monto Capital (S/.)","decimal(18,2)",""],["monto_interes","INTERES","Inter\xE9s (S/.)","decimal(18,2)",""],["saldo_pendiente","SALDO","Saldo Pendiente (S/.)","decimal(18,2)",""],["monto_mora","MORA","Monto Mora (S/.)","decimal(18,2)",""],["dias_mora","DIAS_MORA","D\xEDas de Mora","",""],["monto_minimo_pagar","PAGO_MINIMO","Monto M\xEDnimo a Pagar (S/.)","decimal(18,2)",""],["fecha_vencimiento","FEC_VENC","Fecha de Vencimiento","dd/MM/yyyy",""],["fecha_desembolso","FEC_DESEMB","Fecha de Desembolso","dd/MM/yyyy",""],["fecha_proximo_vencimiento","FEC_PROX_VENC","Fecha Pr\xF3ximo Vencimiento","dd/MM/yyyy",""],["fecha_corte","FEC_CORTE","Fecha de Corte","dd/MM/yyyy",""],["","CAMPO_PERSONALIZADO","Ejemplo Campo Extra","","TEXTO"]],o=t.utils.book_new(),m=t.utils.aoa_to_sheet(e);m["!cols"]=[{wch:25},{wch:20},{wch:30},{wch:20},{wch:15}],t.utils.book_append_sheet(o,m,"Configuraci\xF3n Cabeceras"),t.writeFile(o,"header-configuration-template.xlsx"),alert("Modelo Excel descargado exitosamente")})}getDataTypeBadgeClass(t){switch(t){case"TEXTO":return"bg-blue-900/30 text-blue-400";case"NUMERICO":return"bg-emerald-900/30 text-emerald-400";case"FECHA":return"bg-amber-900/30 text-amber-400";default:return"bg-gray-900/30 text-gray-400"}}getFieldCodeById(t){let e=this.fieldDefinitions().find(o=>o.id===t);return e?e.fieldCode:"-"}};s.\u0275fac=function(e){return new(e||s)(W(fe),W(xe),W(ge),W(ue))},s.\u0275cmp=Z({type:s,selectors:[["app-header-configuration"]],viewQuery:function(e,o){if(e&1&&Y(be,5,Q),e&2){let m;J(m=K())&&(o.downloadButton=m.first)}},decls:48,vars:12,consts:[["downloadButton",""],[1,"h-[calc(100dvh-56px)]","bg-slate-950","overflow-hidden","flex","flex-col"],[1,"flex-1","overflow-y-auto"],[1,"p-3","max-w-7xl","mx-auto"],[1,"mb-2"],[1,"flex","items-center","gap-2"],[1,"w-8","h-8","bg-gradient-to-br","from-indigo-600","to-indigo-700","rounded-lg","flex","items-center","justify-center"],[1,"text-lg","font-bold","text-white"],[1,"text-xs","text-gray-400"],[1,"bg-slate-900","rounded-lg","p-2","shadow-sm","border","border-slate-800"],[1,"grid","grid-cols-1","md:grid-cols-4","gap-2"],[1,"block","text-xs","font-semibold","text-gray-300","mb-1"],[1,"w-full","px-3","py-1.5","bg-slate-800","border","border-slate-700","rounded-lg","text-white","text-sm","focus:outline-none","focus:ring-2","focus:ring-indigo-500",3,"ngModelChange","ngModel"],[3,"value"],[1,"w-full","px-3","py-1.5","bg-slate-800","border","border-slate-700","rounded-lg","text-white","text-sm","focus:outline-none","focus:ring-2","focus:ring-indigo-500","disabled:opacity-50","disabled:cursor-not-allowed",3,"ngModelChange","ngModel","disabled"],["value","ACTUALIZACION"],["value","INICIAL"],[1,"fixed","inset-0","bg-black/80","backdrop-blur-sm","flex","items-center","justify-center","z-50","p-4"],[1,"bg-slate-900","rounded-lg","shadow-sm","border","border-slate-800","overflow-hidden"],[1,"p-3"],[1,"flex","flex-wrap","items-center","gap-2","mb-2"],[1,"relative"],[1,"flex","items-center","gap-1.5","px-3","py-1.5","bg-blue-600","text-white","rounded-lg","text-sm","font-medium","hover:bg-blue-700","transition-all","cursor-pointer",3,"click"],[1,"hidden","sm:inline"],[1,"sm:hidden"],[1,"px-3","py-1.5","bg-slate-800","border","border-slate-700","rounded-lg","text-white","text-sm","focus:outline-none","focus:ring-2","focus:ring-emerald-500","cursor-pointer",3,"ngModelChange","ngModel"],["value",";"],["value",","],["value","|"],["value","	"],[1,"flex","items-center","gap-1.5","px-3","py-1.5","bg-emerald-600","text-white","rounded-lg","text-sm","font-medium","hover:bg-emerald-700","transition-all","cursor-pointer"],["type","file","accept",".csv,.xlsx,.xls",1,"hidden",3,"change"],[1,"ml-auto","flex","items-center","gap-2","px-3","py-1.5"],[1,"flex","flex-wrap","items-center","justify-end","gap-2","pt-2","border-t","border-slate-700"],[1,"p-6","text-center"],[1,"overflow-x-auto","max-h-[calc(100dvh-340px)]","overflow-y-auto"],[1,"text-sm","font-semibold","text-indigo-400"],[1,"text-xs","text-indigo-400"],[1,"fixed","inset-0","z-[9998]",3,"click"],[1,"fixed","w-56","bg-slate-800","rounded-lg","shadow-xl","border","border-slate-700","py-1","z-[9999]"],[1,"w-full","flex","items-center","gap-2","px-3","py-2","hover:bg-slate-700","transition-colors","text-left","text-gray-300","cursor-pointer",3,"click"],[1,"text-sm","font-medium"],[1,"flex","items-center","gap-1","px-3","py-1.5","bg-slate-800","text-gray-300","rounded-lg","text-sm","hover:bg-slate-700","hover:text-white","transition-all","cursor-pointer",3,"click"],[1,"flex","items-center","gap-1.5","px-3","py-1.5","bg-green-600","text-white","rounded-lg","text-sm","font-medium","hover:bg-green-700","transition-all","cursor-pointer",3,"click"],[1,"w-12","h-12","bg-slate-800","rounded-full","flex","items-center","justify-center","mx-auto","mb-2"],[1,"text-sm","text-gray-400"],[1,"w-full"],[1,"bg-slate-800","border-b","border-slate-700","sticky","top-0"],[1,"px-2","py-1.5","text-left","text-xs","font-semibold","text-gray-400"],[1,"px-2","py-1.5","text-center","text-xs","font-semibold","text-gray-400"],[1,"divide-y","divide-slate-800"],[1,"hover:bg-slate-800","transition-colors"],[1,"px-2","py-1.5"],[1,"flex","items-center","gap-1"],[1,"font-mono","text-xs","font-semibold","text-indigo-400"],[1,"inline-flex","px-1.5","py-0.5","rounded","text-xs","font-medium"],[1,"text-xs","text-white"],[1,"text-xs","text-amber-400","italic"],[1,"font-mono","text-xs","text-gray-400"],[1,"px-2","py-1.5","text-center"],["title","Editar",1,"p-1","text-blue-400","hover:bg-slate-800","rounded","transition-colors",3,"click"],["title","Eliminar",1,"p-1","text-red-400","hover:bg-slate-800","rounded","transition-colors",3,"click"],[1,"bg-slate-900","rounded-xl","shadow-2xl","max-w-2xl","w-full","max-h-[90vh]","overflow-hidden","border","border-slate-800"],[1,"bg-gradient-to-r","from-indigo-600","to-indigo-700","p-5","text-white"],[1,"flex","items-center","justify-between"],[1,"flex","items-center","gap-3"],[1,"w-10","h-10","bg-white/20","rounded-lg","flex","items-center","justify-center"],[1,"text-xl","font-bold"],[1,"text-indigo-100","text-sm"],[1,"text-white/80","hover:text-white",3,"click"],[1,"p-6","overflow-y-auto","max-h-[calc(90vh-200px)]"],[1,"space-y-4"],[1,"block","text-sm","font-semibold","text-gray-300","mb-2"],[1,"w-full","px-4","py-2.5","bg-slate-800","border","border-slate-700","rounded-lg","text-white","focus:outline-none","focus:ring-2","focus:ring-indigo-500",3,"ngModelChange","ngModel"],[1,"text-xs","text-gray-400","mt-1"],[1,"bg-slate-800/50","rounded-lg","p-4","space-y-2","border","border-slate-700/50"],["type","text","placeholder","Ej: DNI, Saldo Vencido, Tel\xE9fono Principal",1,"w-full","px-4","py-2.5","bg-slate-800","border","border-slate-700","rounded-lg","text-white","placeholder-gray-500","focus:outline-none","focus:ring-2","focus:ring-indigo-500",3,"ngModelChange","ngModel"],["type","text","placeholder","Ej: N\xFAmero de Documento, Saldo Pendiente",1,"w-full","px-4","py-2.5","bg-slate-800","border","border-slate-700","rounded-lg","text-white","placeholder-gray-500","focus:outline-none","focus:ring-2","focus:ring-indigo-500",3,"ngModelChange","ngModel"],["type","text","placeholder","Ej: dd/MM/yyyy, decimal(18,2)",1,"w-full","px-4","py-2.5","bg-slate-800","border","border-slate-700","rounded-lg","text-white","placeholder-gray-500","focus:outline-none","focus:ring-2","focus:ring-indigo-500",3,"ngModelChange","ngModel"],["type","checkbox","id","required",1,"w-4","h-4","text-indigo-600","bg-slate-800","border-slate-700","rounded","focus:ring-indigo-500",3,"ngModelChange","ngModel"],["for","required",1,"text-sm","text-gray-300"],[1,"col-span-2","border-t","border-slate-700","pt-4","mt-2"],["type","button",1,"w-full","flex","items-center","justify-between","text-sm","font-bold","text-emerald-400","mb-3","hover:text-emerald-300","transition-colors",3,"click"],[1,"border-t","border-slate-800","p-4","flex","justify-end","gap-3","bg-slate-950"],[1,"px-5","py-2","text-gray-400","hover:bg-slate-800","hover:text-white","rounded-lg","font-medium","transition-colors",3,"click"],[1,"px-5","py-2","bg-gradient-to-r","from-indigo-600","to-indigo-700","text-white","rounded-lg","font-semibold","hover:shadow-lg","transition-all","disabled:opacity-50","disabled:cursor-not-allowed",3,"click","disabled"],[1,"text-xs","font-semibold","text-gray-400","mb-2"],[1,"inline-flex","px-2","py-0.5","rounded","text-xs","font-medium"],[1,"font-semibold"],[1,"text-cyan-400"],["value","TEXTO"],["value","NUMERICO"],["value","FECHA"],[1,"text-xs","text-gray-400","mb-4"],[1,"grid","grid-cols-1","gap-4"],[1,"w-full","px-4","py-2.5","bg-slate-800","border","border-slate-700","rounded-lg","text-white","focus:outline-none","focus:ring-2","focus:ring-emerald-500",3,"ngModelChange","ngModel"],["value",""],[1,"text-red-400","ml-1"],["type","text",1,"w-full","px-4","py-2.5","bg-slate-800","border","border-slate-700","rounded-lg","text-white","placeholder-gray-500","focus:outline-none","focus:ring-2","focus:ring-emerald-500","font-mono","text-sm",3,"ngModelChange","ngModel","placeholder"],[1,"text-emerald-400"]],template:function(e,o){e&1&&(i(0,"div",1)(1,"div",2)(2,"div",3)(3,"div",4)(4,"div",5),R(5,"div",6),i(6,"div")(7,"h1",7),r(8,"Configuraci\xF3n de Cabeceras"),n(),i(9,"p",8),r(10,"Define las cabeceras personalizadas por subcartera"),n()()()(),i(11,"div",4)(12,"div",9)(13,"div",10)(14,"div")(15,"label",11),r(16," Proveedor "),n(),i(17,"select",12),S("ngModelChange",function(p){return w(o.selectedTenantId,p)||(o.selectedTenantId=p),p}),x("ngModelChange",function(){return o.onTenantChange()}),i(18,"option",13),r(19,"Seleccione un proveedor..."),n(),N(20,ye,2,2,"option",13,B),n()(),i(22,"div")(23,"label",11),r(24," Cartera "),n(),i(25,"select",14),S("ngModelChange",function(p){return w(o.selectedPortfolioId,p)||(o.selectedPortfolioId=p),p}),x("ngModelChange",function(){return o.onPortfolioChange()}),i(26,"option",13),r(27,"Seleccione una cartera..."),n(),N(28,we,2,2,"option",13,B),n()(),i(30,"div")(31,"label",11),r(32," Subcartera "),n(),i(33,"select",14),S("ngModelChange",function(p){return w(o.selectedSubPortfolioId,p)||(o.selectedSubPortfolioId=p),p}),x("ngModelChange",function(){return o.onSubPortfolioChange()}),i(34,"option",13),r(35,"Seleccione una subcartera..."),n(),N(36,Se,2,2,"option",13,B),n()(),i(38,"div")(39,"label",11),r(40," Tipo de Carga "),n(),i(41,"select",14),S("ngModelChange",function(p){return w(o.selectedLoadType,p)||(o.selectedLoadType=p),p}),x("ngModelChange",function(){return o.onLoadTypeChange()}),i(42,"option",15),r(43,"Carga Diaria"),n(),i(44,"option",16),r(45,"Carga Inicial del Mes"),n()()()()()(),C(46,Le,33,5),C(47,Ue,59,12,"div",17),n()()()),e&2&&(d(17),y("ngModel",o.selectedTenantId),d(),v("value",0),d(2),V(o.tenants()),d(5),y("ngModel",o.selectedPortfolioId),v("disabled",o.selectedTenantId===0),d(),v("value",0),d(2),V(o.portfolios()),d(5),y("ngModel",o.selectedSubPortfolioId),v("disabled",o.selectedPortfolioId===0),d(),v("value",0),d(2),V(o.subPortfolios()),d(5),y("ngModel",o.selectedLoadType),v("disabled",o.selectedSubPortfolioId===0),d(5),h(o.selectedSubPortfolioId>0?46:-1),d(),h(o.showManualDialog()?47:-1))},dependencies:[ie,pe,ce,me,re,ae,se,le,de],styles:["[_nghost-%COMP%]{display:block}"]});let l=s;return l})();export{nt as HeaderConfigurationComponent};
